import{h as uuid,e as handleJsonResponse,i as createBenchmarkMaterial,j as createBenchmarkTexture,k as setDescriptor,l as setWriteable}from"./chunk-8ebdc893.js";import{D as IMAGE_FORMATS,b as AppContext}from"./chunk-57b2c2a6.js";import{g as PREVIEW_MATERIAL_COLOR,E as PREVIEW_MATERIAL_ROUGHNESS,F as PREVIEW_MATERIAL_METALNESS,C as createMaterial,D as addTexture}from"./chunk-36924942.js";import{a as __decorate,b as inject}from"./chunk-c1472d96.js";const isIdItemId=function(e){return!(!e||"string"!=typeof e||e.split(":").length>2)},getCatalogIdFromItemOrConfigurationId=e=>{if(!e||"string"!=typeof e)return null;const t=e.split(":");return t.length<2?null:t[0]},kernelPartToPriceId=({articleNr:e,componentId:t})=>e&&""!==e?t.split(":")[0]+":"+e:null;var defaultSettings={isProduction:!0,isUnitTesting:!1,environment:"production",detailEnvironment:"development",features:{},APP:{RAPI:{server:"/api/v2",localReverseProxy:"https://www.roomle.com/api/v2",liveServer:"https://www.roomle.com/api/v2",testServer:"https://www.test.roomle.com/api/v2",headers:{apiKey:"roomle_portal_v2",currentTenant:9,locale:"en",language:"en",device:1,token:"anonymous",platform:"web"},itemHeaders:{assetRevision:"glb",assetFileFormat:"glb"}},WASM:{CONFIGURATOR:{URL:"static/kernel-artifacts/wasm/ConfiguratorKernel.wasm",CACHE_COMPILATION:!0,HASH:"2312deae087f7fc3595ca121ae9f0119",LOADER:"static/kernel-artifacts/wasm/ConfiguratorKernel.js"},PLANNER:{URL:"static/kernel-artifacts/wasm/RoomleCore.wasm",CACHE_COMPILATION:!0,HASH:"619d294632af5b70bcd0aadedfba9cf1",LOADER:"static/kernel-artifacts/wasm/RoomleCore.js"}},ASM:{CONFIGURATOR:{MEM_URL:"static/kernel-artifacts/ConfiguratorKernelJs.mem",LOADER:"static/kernel-artifacts/ConfiguratorKernelJs.js"},PLANNER:{MEM_URL:"static/kernel-artifacts/RoomleCoreJs.mem",LOADER:"static/kernel-artifacts/RoomleCoreJs.js"}},SHORTENER_URL:"http://rml.co/"},environments:{PRODUCTION:"production",DEVELOPMENT:"development",TEST:"test",TEST_SERVER:"test_server",ALPHA:"alpha"}};"undefined"!=typeof module&&module.exports||(window.IS_DEBUG=!0),function(e=!1){if(e){let e=JSON.parse(JSON.stringify(defaultSettings));const t=Object.assign({},e.APP,{SHORTENER_URL:"http://localhost:4747/?isItem=false&id="}),r=Object.assign({},e.features);Object.assign({},e,{isProduction:!1,APP:t,features:r})}}();const ENV=defaultSettings,{APP:APP$1}=ENV,{RAPI}=APP$1,headers=RAPI.headers,itemHeaders=RAPI.itemHeaders,TOKEN_IDENTIFIER=headers.token,LIVE_RAPI="live",MAX_URL_LENGTH=1500,MESH_DEFAULT_FORMAT="crt",MESH_DEFAULT_QUALITY=50,TENANT_ME_CACHE_KEY="0",HTTP_VERBS={GET:"GET",POST:"POST"},LEGACY_GROUP_INDICATOR=uuid(),RETRY_AFTER=6e4;let RAPI_MATERIAL_GROUP_CACHE=new Map,ITEM_ADDITIONAL_CONTENT_CACHE=new Map,RAPI_RELATIONS_CACHE=new Map,RAPI_CACHE=new Map,MESHES_TO_CATALOG_CACHE=new Map,RAPI_PACKAGE_CACHE=new Map,RAPI_PRELOAD_CACHE=new Map,WAITERS_FOR_URL=new Map;const LOCAL_STORAGE_QUEUE_KEY="hsc_configurations_offline_queue_v1";let RAPI_ERROR_CACHE=new Map;const getCachedMaterialGroup=e=>RAPI_MATERIAL_GROUP_CACHE.get(e)||RAPI_MATERIAL_GROUP_CACHE.get(LEGACY_GROUP_INDICATOR+e),hasMaterialTags=e=>e&&e.tags&&e.tags.length,materialHasNoTagsButGroup=e=>!hasMaterialTags(e)&&e.group,RAPI_PATH_KEY="__rapi_path__";class RapiAccess{constructor(e){this._creator_=e,window.addEventListener("online",this._flushOfflineQueue.bind(this))}overrideTenant(e){e&&(this._overrideTenant=e)}setConfiguratorId(e){e&&(this._configuratorId=e)}overrideCountry(e){e&&(this._overrideCountry=e)}overrideRapi(e){e&&(this._overrideRapi=e)}setCustomApiUrl(e){this._customApiUrl=e}getPreloadForItem(e){return this._getPreload(e,!0)}getPreloadForConfiguration(e){return this._getPreload(e,!1)}_getPreload(e,t){return new Promise((r,a)=>{if(!navigator.onLine)return r();if(this._dataSyncer.getIsCatalogSynced(getCatalogIdFromItemOrConfigurationId(e)))return r();if(RAPI_PRELOAD_CACHE.get(e))return r();const s=t?"?itemId=":"?configurationId=";this._get("/preloads/components/"+s+e,"preloads/components").then(t=>{if(RAPI_PRELOAD_CACHE.get(e))return r();t.forEach(e=>{this._prepareData(e,"components")}),RAPI_PRELOAD_CACHE.set(e,!0),r()},a)})}changeUseOfHDGeometry(){const e=RAPI_CACHE.get("components");RAPI_PRELOAD_CACHE.clear(),RAPI_PACKAGE_CACHE.clear(),e&&RAPI_CACHE.delete("components")}getHSCPackage(e){return new Promise((t,r)=>{if(RAPI_PACKAGE_CACHE.get(e))return t();this._get("/catalogs/"+e+"/package","package").then(r=>{if(RAPI_PACKAGE_CACHE.get(e))return t(r);r.components.forEach(e=>{this._prepareData(e,"components")}),r.materials.forEach(e=>{this._prepareData(e,"materials"),this._prepareGroups(e)}),r.textures.forEach(e=>{this._prepareData(e,"textures")}),RAPI_PACKAGE_CACHE.set(e,!0),t(r)},r)})}getComponent(e){return this._getById(e,"components")}getConfiguration(e){return this._getById(e,"configurations")}getConfigurations(e){return this._getByIds(e,"configurations")}getItem(e){return this._getById(e,"items",{additionalHeaders:itemHeaders})}getComponents(e){return this._getByIds(e,"components")}getItems(e){return this._getByIds(e,"items",{additionalHeaders:itemHeaders})}getTag(e){return this._getById(e,"tags")}getTags(e){return this._getByIds(e,"tags")}getTexture(e){return this._getById(e,"textures")}getCatalog(e){return this._getById(e,"catalogs")}getMesh(e,t=MESH_DEFAULT_FORMAT,r=MESH_DEFAULT_QUALITY){return this._getById(e,"meshes",{pathSuffix:"/data?format="+t+"&targetQuality="+r.toString()})}getMeshesOfCatalog(e){return new Promise((t,r)=>{const a=MESHES_TO_CATALOG_CACHE.get(e);a?t(a):this._get("/meshes?catalog="+e,"catalogMeshes").then(r=>{MESHES_TO_CATALOG_CACHE.set(e,r),t(r)},r)})}getTexturesOf(e){return this._getRelationData(e,{rapiPath:"textures"})}getItemsOf(e){return this._getRelationData(e,{rapiPath:"items"})}async getMaterialsOf(e){return(await this._getRelationData(e,{rapiPath:"materials"},{embed:["textures"]})).filter(e=>e.active)}getComponentsOf(e){return this._getRelationData(e,{rapiPath:"components"})}getAdditionalContentsOfItems(e){const t=[],r=[];return e.forEach(e=>{const a=ITEM_ADDITIONAL_CONTENT_CACHE.get(e.id.toString());a?r.push(...a):t.push(e.id.toString())}),new Promise((e,a)=>{0!==t.length?this._getByIdsPackets(t,"itemAdditionalContents",{filterKey:"itemIds"}).then(t=>{t.forEach(e=>{let t=ITEM_ADDITIONAL_CONTENT_CACHE.get(e.itemId);t||(t=[]);for(let r=0,a=t.length;r<a;r++)if(t[r].id===e.id)return;t.push(e),ITEM_ADDITIONAL_CONTENT_CACHE.set(e.itemId,t)}),e([...t,...r])},a):e(r)})}getMaterial(e){return this._getById(e,"materials",{embed:["textures"]})}peekMaterial(e){return this._peekData(e,"materials")}peekComponent(e){return this._peekData(e,"components")}async getMaterials(e){return(await this._getByIds(e,"materials",{embed:["textures"]})).filter(e=>e.active)}getPlan(e){return this._getById(e,"plans")}static clearCaches(){RAPI_MATERIAL_GROUP_CACHE=new Map,RAPI_RELATIONS_CACHE=new Map,RAPI_CACHE=new Map,RAPI_PACKAGE_CACHE=new Map,RAPI_PRELOAD_CACHE=new Map,WAITERS_FOR_URL=new Map,ITEM_ADDITIONAL_CONTENT_CACHE=new Map}cleanUp(){RapiAccess.clearCaches()}getMaterialsByGroup(e){const t=e.slice(),r=[];let a=t.length;for(let e=0;e<a;e++){const s=getCachedMaterialGroup(t[e]);if(s){const i=s.length;for(let e=0;e<i;e++){const t=this._getCache("materials").get(s[e]);r.push(t)}t.splice(e,1),a--,e--}}return new Promise((e,a)=>{0!==t.length&&navigator.onLine?this._getByIdsPackets(t,"materials",{filterKey:"groups",embed:["textures"]}).then(t=>{e(this.combineMaterialsToGroups([...t,...r]))},a):e(this.combineMaterialsToGroups(r))})}_flushOfflineQueue(){return new Promise((e,t)=>{const r=this._localStorage.getItem(LOCAL_STORAGE_QUEUE_KEY),a=[];for(let e in r)if(r.hasOwnProperty(e)){const t=r[e];a.push(new Promise((e,r)=>{this.saveConfiguration(t.data).then(a=>{const s=[];t.perspectiveImage&&!a.perspectiveImage&&s.push(this.savePerspectiveImage(a,t.perspectiveImage)),t.topImage&&!a.topImage&&s.push(this.savePerspectiveImage(a,t.topImage)),Promise.all(s).then(e,r)},r)}))}Promise.all(a).then(()=>{this._localStorage.setItem(LOCAL_STORAGE_QUEUE_KEY,{}),e()},t)})}_setQueuedConfiguration(e,t={}){const r=e.configurationHash,{perspectiveImage:a,topImage:s}=t;let i=this._localStorage.getItem(LOCAL_STORAGE_QUEUE_KEY)||{},n=i[r]||{};n.data=e,n.perspectiveImage=a,n.topImage=s,i[r]=n,this._localStorage.setItem(LOCAL_STORAGE_QUEUE_KEY,i)}async saveConfiguration(e){if(!navigator.onLine)return e.perspectiveImage=null,e.topImage=null,this._setQueuedConfiguration(e),this._markConfigurationAsLocally(e),Promise.resolve(e);const t=await this._save("/configurations",{configuration:e},"configurations",{accept:"application/json",contentType:"application/json; charset=UTF-8"});return this._configuratorUiCallbacks.onConfigurationSaved(t.configurationHash),t}saveTopImage(e,t){return this._saveConfigurationImage(e,t,"topImage")}savePerspectiveImage(e,t){return this._saveConfigurationImage(e,t,"perspectiveImage")}getShortUrl(e,t){return new Promise((r,a)=>this._fetchJson("/shortIds","shortIds",{method:HTTP_VERBS.POST,resolve:r,reject:a,data:JSON.stringify({shortId:{type:t,referencedId:e}}),accept:"application/json",contentType:"application/json; charset=UTF-8"}))}_peekData(e,t){const r=RAPI_CACHE.get(t);return r&&r.get(e)||null}_saveConfigurationImage(e,t,r){if(!navigator.onLine){const a={};return a[r]=t,this._setQueuedConfiguration(e,a),this._markConfigurationAsLocally(e),e[r]=t.image,Promise.resolve(e)}const a=this._formDataUtil.create(t.image,e.configurationHash,IMAGE_FORMATS.PNG,r);return this._save("/configurations/"+e.id+"/"+r,a,"configurations",{accept:"application/json"})}_markConfigurationAsLocally(e){e.isLocally=!0,e.id=e.configurationHash}_save(e,t,r,a={}){const s=t instanceof FormData?t:JSON.stringify(t);return new Promise((t,i)=>{const n={method:HTTP_VERBS.POST,data:s,resolve:t,reject:i};a.contentType&&(n.contentType=a.contentType),a.accept&&(n.accept=a.accept),this._fetchJson(e,r,n)})}combineMaterialsToGroups(e){return new Promise((t,r)=>{const a=new Map,s={id:null,label:null,materials:[]},i=[];for(let t=0,r=e.length;t<r;t++){const r=e[t],n=r.tags&&r.tags.length?r.tags.map(e=>({isTag:!0,id:e})):[];r.group&&n.push({isTag:!1,id:LEGACY_GROUP_INDICATOR+r.group}),n.length||n.push({isTag:!1,id:null}),r.tags&&r.tags.length&&r.tags.forEach(e=>-1===i.indexOf(e)?i.push(e):null),n.forEach(({isTag:e,id:t})=>{const i=r.id;let n=t?getCachedMaterialGroup(t):[];n||(RAPI_MATERIAL_GROUP_CACHE.set(t,[]),n=getCachedMaterialGroup(t)),-1===n.indexOf(i.toString())&&n.push(i.toString());const o=hasMaterialTags(r),c=o&&e,h=materialHasNoTagsButGroup(r);if(c||h&&!e||!o&&!h&&!t){let e=t?a.get(t):s;e||(a.set(t,{id:t,label:r.groupLabel,materials:[]}),e=a.get(t)),e.materials.push(r)}})}const n=s.materials.length?[s]:[];this.getTags(i).then(e=>{const r=e.reduce((e,t)=>(e[t.id]=t,e),{});return a.forEach((e,t)=>{n.push({id:t,label:r[t]?r[t].label:e.label,materials:e.materials})}),t(n)},r)})}_getByIds(e,t,r={}){const a=this._getCache(t),s=this._getErrorCache(t),i=[],n=[...new Set(e)];let o=n.length;if(a&&a.size){const e=(new Date).getTime();for(let t=0;t<o;t++){const r=n[t],c=a.get(r),h=s.get(r);let l=!1;null!=c?(i.push(c),l=!0):l=void 0!==h&&(e-h.timestamp<RETRY_AFTER||!1===navigator.onLine),l&&(n.splice(t,1),o--,t--)}}return new Promise((e,a)=>{0!==n.length&&navigator.onLine?this._getByIdsPackets(n,t,r).then(t=>{e([...t,...i])},a):e(i)})}_getByIdsPackets(e,t,r={}){const a=r.filterKey||"ids";let s,i="/"+t+"/",n="?",o=[];const c=e.length;if(!c)return new Promise(e=>e([]));let h=!0,l=[];for(s=0;s<c;s++){h=!1;const r=e[s],c=n+a+"[]="+r,_=c.length+i.length;l.push(r),n="&",_<=MAX_URL_LENGTH?i+=c:(_>MAX_URL_LENGTH&&(l.pop(),s--),o.push({url:i,ids:l}),h=!0,i="/"+t+"/",n="?",l=[])}h||o.push({url:i,ids:l});const _=[];return o.forEach(e=>_.push(this._getByIdsSingle(e.ids,e.url,t,r))),new Promise((e,t)=>{Promise.all(_).then(t=>{const r=[];t.length&&t.forEach(e=>r.push(...e)),e(r)},t)})}_getByIdsSingle(e,t,r,a={}){return new Promise((s,i)=>{this._get(t,r,a).then(t=>{for(let r=0,s=t.length;r<s;r++){const s=a&&a.cacheKey?t[r][a.cacheKey]:t[r].id,i=e.indexOf(s.toString());-1!==i&&e.splice(i,1)}const i=e.length;if(i){const t=this._getCache(r),a=this._getErrorCache(r),s=(new Date).getTime();for(let r=0;r<i;r++)a.set(e[r],{code:0,timestamp:s}),t.delete(e[r]);this._errorHandler.dispatch(2,[r,e.map(e=>'"'+e+'"').join(",")])}s(t)},i)})}_getById(e,t,r={}){if(!e||""===e||"string"!=typeof e)return console.error("no id passed to _getById"),Promise.reject(new Error("no id passed to _getById"));const a=this._getCache(t).get(e);if(a)return new Promise(e=>e(a));if(!navigator.onLine)return Promise.reject("Nothing cached but tried to fetch in offline mode");const s=Object.assign({},r,{id:e}),i=r.pathSuffix||"";return this._get("/"+t+"/"+e+i,t,s)}_get(e,t,r={}){const a=AppContext.useHDGeometry?"includeGeometryHD=true":"";let s=-1===e.indexOf("?")?"?":"&";return""!==a&&(e+=s+a),r.embed&&Array.isArray(r.embed)&&r.embed.forEach(t=>{e+=s+"embed"+(t[0].toUpperCase()+t.substr(1))+"=true",s="&"}),new Promise((a,s)=>{const i=WAITERS_FOR_URL.get(e);Array.isArray(i)&&i.length>0?i.push({resolve:a,reject:s}):(WAITERS_FOR_URL.set(e,[{resolve:a,reject:s}]),this._fetchJson(e,t,r))})}_fetchJson(e,t,r={}){const a={method:r.method?r.method:HTTP_VERBS.GET,headers:this._createHeaders(r),mode:"cors",cache:"default"};r.data&&(a.body=r.data);let s=RAPI.server;const i=this._overrideRapi;i&&(s=i===LIVE_RAPI?RAPI.liveServer:RAPI.testServer),(this._customApiUrl||""===this._customApiUrl)&&(s=this._customApiUrl);const n=new Request(s+e,a);this._networkLayer.fetch(n).then(handleJsonResponse.bind(this)).then(this._handleJson(e,t,r).bind(this)).catch(this._handleError(e,r).bind(this))}_createHeaders(e={}){const t=Object.assign({},headers);this._overrideTenant&&(t.currentTenant=this._overrideTenant),this._overrideCountry&&(t.country=this._overrideCountry);const{locale:r}=window.__RML__ENV__.initData;t.language=r,t.locale=r;const{contentType:a,accept:s,additionalHeaders:i,data:n}=e;if(a&&(t["content-type"]=e.contentType),s&&(t.accept=e.accept),i)for(let e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);this._configuratorId&&(t.configurator=this._configuratorId),t.token="03-"+window.btoa((new Date).toISOString()+";"+TOKEN_IDENTIFIER+";"+headers.apiKey);const o=new Headers(t);return n instanceof FormData&&o.delete("content-type"),o}_handleJson(e,t,r={}){return a=>{let s=null,i=null;"number"==typeof a&&(s=a);for(let e in a)"meta"!==e&&a.hasOwnProperty(e)&&(s=a[e],i=e);if("error"===i)return this._handleError(e,r)(new Error(JSON.stringify(s)));if(!s)throw new TypeError("RAPI returned empty JSON");if(Array.isArray(s))for(let e=0,a=s.length;e<a;e++)this._prepareData(s[e],t,r),this._prepareEmbeddedData(s[e],t,r);else this._prepareData(s,t,r),this._prepareEmbeddedData(s,t,r);r.resolve?r.resolve(s):this._notifyWaiters(e,null,s)}}_prepareEmbeddedData(e,t,r={}){r.embed&&Array.isArray(r.embed)&&r.embed.forEach(a=>{const s=e[a.slice(0,-1)+"Objects"];if(Array.isArray(s)){for(let e=0,t=s.length;e<t;e++)this._prepareData(s[e],a,r);this._prepareRelationalData(t,a,e.id,s)}else s&&(this._prepareData(s,a,r),this._prepareRelationalData(t,a,e.id,[s]))})}_getCache(e){return this._getCacheFrom(e,RAPI_CACHE)}_getErrorCache(e){return this._getCacheFrom(e,RAPI_ERROR_CACHE)}_getCacheFrom(e,t){let r=t.get(e);return r||(t.set(e,new Map),r=t.get(e)),r}_setCache(e,t,r){r.set(e.toString(),t)}_prepareData(e,t,r=null){let a=this._getCache(t);const s=r&&r.cacheKey?e[r.cacheKey]:e.id;if(s||r&&r.id||"tenants/me"===t)if("tenants/me"!==t){{const t=s||r.id;this._setCache(t,e,a)}e[RAPI_PATH_KEY]=t}else this._setCache(TENANT_ME_CACHE_KEY,e,a);else"shortIds"!==t&&console.error("Can not cache because there is no ID!")}_getRelationsCacheFor(e,t,r){let a=RAPI_RELATIONS_CACHE.get(t);if(!a){const s=new Map,i=new Map;i.set(r,void 0),s.set(e,i),RAPI_RELATIONS_CACHE.set(t,s),a=RAPI_RELATIONS_CACHE.get(t)}let s=a.get(e);if(!s){const t=new Map;t.set(r,void 0),a.set(e,t),s=a.get(e)}return s.get(r)}_prepareGroups(e){const t=e.group,r=e.id;let a=getCachedMaterialGroup(t);a||(RAPI_MATERIAL_GROUP_CACHE.set(t,[]),a=getCachedMaterialGroup(t)),-1===a.indexOf(r.toString())&&a.push(r.toString())}_handleError(e,t={}){return r=>{navigator.onLine?(r.rmlErrorCode=1,this._errorHandler.dispatch(1,[r])):(r.rmlErrorCode=0,this._errorHandler.dispatch(0,[r])),t.reject?t.reject(r):this._notifyWaiters(e,r,null)}}_getRelationData(e,t,r={}){const a=e.id,s=e[RAPI_PATH_KEY],i=t.rapiPath;let n=this._getCache(i),o=this._getRelationsCacheFor(a.toString(),s,i),c=[];return o?(o.forEach(e=>c.push(n.get(e))),new Promise(e=>e(c))):navigator.onLine?new Promise((e,t)=>{this._get("/"+s+"/"+a+"/"+i,i,r).then(t=>{this._prepareRelationalData(s,i,a,t),e(t)},t)}):Promise.resolve([])}_prepareRelationalData(e,t,r,a){RAPI_RELATIONS_CACHE.has(e)||RAPI_RELATIONS_CACHE.set(e,new Map);let s=RAPI_RELATIONS_CACHE.get(e);const i=r.toString();s.has(i)||s.set(i,new Map);let n=s.get(i),o=this._getCache(t),c=[];for(let e=0,t=a.length;e<t;e++){const t=a[e],r=t.id.toString();c.push(r),o.set(r,t)}n.set(t,c)}_notifyWaiters(e,t,r){const a=WAITERS_FOR_URL.get(e);if(a&&a.length){for(let e=0,s=a.length;e<s;e++)t?a[e].reject(t):a[e].resolve(r);WAITERS_FOR_URL.delete(e)}}_tenantMe(){return new Promise((e,t)=>{const r=this._getCache("tenants/me"),a=this._overrideTenant?this._overrideTenant:r.get(TENANT_ME_CACHE_KEY);if(a)return e(a);this._fetchJson("/tenants/me","tenants/me",{resolve:t=>e(t),reject:t})})}getCurrentSkin(){return this._tenantMe().then(e=>this._getById(e.toString(),"tenants").then(e=>this._getById(e.skin.toString(),"skins")))}getPrices(e){return this._getByIds(e,"prices",{filterKey:"priceIds",cacheKey:"priceId"})}}__decorate([inject],RapiAccess.prototype,"_formDataUtil",void 0),__decorate([inject],RapiAccess.prototype,"_errorHandler",void 0),__decorate([inject],RapiAccess.prototype,"_dataSyncer",void 0),__decorate([inject],RapiAccess.prototype,"_networkLayer",void 0),__decorate([inject],RapiAccess.prototype,"_localStorage",void 0),__decorate([inject],RapiAccess.prototype,"_configuratorUiCallbacks",void 0);class PromiseQueue{constructor(e){this._waitingPromises=[],e&&this.registerCallback(e)}push(e){this._waitingPromises.push(e),Promise.all(this._waitingPromises).then(e=>{e.length===this._waitingPromises.length&&this._callback&&(this._callback(e),this._waitingPromises=[])})}finished(){return new Promise(e=>{Promise.all(this._waitingPromises).then(t=>e(t))})}registerCallback(e){this._callback=e}unregisterCallback(){this._callback=null}get length(){return this._waitingPromises.length}}class MeshGenerator{constructor(e){this.materialQueue=new PromiseQueue,this._maxAnisotropy=1,this._textureLoader=new THREE.TextureLoader,this._creator_=e,this._previewMaterial=new THREE.MeshStandardMaterial({color:PREVIEW_MATERIAL_COLOR,roughness:PREVIEW_MATERIAL_ROUGHNESS,metalness:PREVIEW_MATERIAL_METALNESS}),this._environmentLoader.setEnvMap(this._previewMaterial)}_generateGeometry(e,t,r,a,s){let i;if(e&&this._cacheHolder.geometryCache.has(e))i=this._cacheHolder.geometryCache.get(e);else{(i=new THREE.Geometry).faceVertexUvs=[],i.faceVertexUvs[0]=[];for(let e=0,r=t.length;e<r;e+=3)i.vertices.push(new THREE.Vector3(t[e]/1e3,t[e+2]/1e3,t[e+1]/-1e3));let n=0,o=0,c=0,h=0,l=0,_=0,g=0,d=0,p=0,u=0,m=[];for(let e=0,t=r.length;e<t;e+=3)c=e+1,h=e+2,l=3*r[o=e],_=3*r[c],g=3*r[h],m=[new THREE.Vector3(s[l],s[l+2],-1*s[l+1]),new THREE.Vector3(s[_],s[_+2],-1*s[_+1]),new THREE.Vector3(s[g],s[g+2],-1*s[g+1])],i.faces.push(new THREE.Face3(r[o],r[c],r[h],m)),d=2*r[o],p=2*r[c],u=2*r[h],i.faceVertexUvs[0][n]=[],i.faceVertexUvs[0][n][0]=new THREE.Vector2(a[d],a[d+1]),i.faceVertexUvs[0][n][1]=new THREE.Vector2(a[p],a[p+1]),i.faceVertexUvs[0][n][2]=new THREE.Vector2(a[u],a[u+1]),n++;e&&this._cacheHolder.geometryCache.set(e,i)}return i}changeMaterialOfMesh(e,t){e&&t?(e.material=t,e.material.transparent&&(e.receiveShadow=!1),e.material.needsUpdate=!0):console.warn("could not assign material to mesh",{mesh:e},{material:t})}_createMaterial(e,t,r,a,s){if(this._cacheHolder.materialCache.has(e))t();else if(e.startsWith("benchmarkMaterial")){let i=createBenchmarkMaterial(e),n=createMaterial(i,this._environmentLoader);this._loadBenchmarkTextures(i,n,a,s).then(t,r)}else this._rapiAccess.getMaterial(e).then(e=>{let i=createMaterial(e,this._environmentLoader);this._loadTextures(e,i,a,s).then(t,r)},r)}_loadBenchmarkTextures(e,t,r=1,a=1){return new Promise((s,i)=>{const n=createBenchmarkTexture(e.id);addTexture(this._dataSyncer.requestAsset(n.image,!0),n,t,this._maxAnisotropy,r/(0===n.mmWidth?1:n.mmWidth),a/(0===n.mmHeight?1:n.mmHeight)).then(()=>{this._cacheHolder.materialCache.set(e.id,t),s()},i)})}_loadTextures(e,t,r=1,a=1){return new Promise((s,i)=>{this._rapiAccess.getTexturesOf(e).then(n=>{let o=[];n.forEach(e=>{o.push(addTexture(this._dataSyncer.requestAsset(e.image,!0),e,t,this._maxAnisotropy,r/(0===e.mmWidth?1:e.mmWidth),a/(0===e.mmHeight?1:e.mmHeight)))}),Promise.all(o).then(()=>{this._cacheHolder.materialCache.set(e.id,t),s()},i)}),(!e.textures||e.textures&&0===e.textures.length)&&(this._cacheHolder.materialCache.set(e.id,t),s())})}_loadMaterial(e,t,r){return new Promise((a,s)=>{this._singlePromiseFactory.create(6,e,(a,s)=>this._createMaterial(e,a,s,t,r)).then(()=>{setTimeout(()=>a(this._cacheHolder.materialCache.get(e)),0)},s)})}_assignMaterial(e,t){return this._cacheHolder.materialCache.has(t)?(this.changeMaterialOfMesh(e,this._cacheHolder.materialCache.get(t)),Promise.resolve()):new Promise((r,a)=>{this._loadMaterial(t).then(t=>{this.changeMaterialOfMesh(e,t),r()},a)})}get maxAnisotropy(){return this._maxAnisotropy}set maxAnisotropy(e){this._maxAnisotropy=e}clear(){this._cacheHolder.clear()}_assignRGB(e,t){return new Promise((r,a)=>{let s,i="rbg"+JSON.stringify(t);this._cacheHolder.materialCache.has(i)?s=this._cacheHolder.materialCache.get(i):(s=new THREE.MeshStandardMaterial({color:t}),this._environmentLoader.setEnvMap(s),this._cacheHolder.materialCache.set(i,s)),this.changeMaterialOfMesh(e,s),setTimeout(()=>r(),0)})}_assignItem(e,t){return new Promise((r,a)=>{if(this._cacheHolder.materialCache.has(t))return this.changeMaterialOfMesh(e,this._cacheHolder.materialCache.get(t)),void r();this._rapiAccess.getItem(t).then(s=>{if(s.topImage)this._textureLoader.load(s.topImage,a=>{a.anisotropy=this._maxAnisotropy,a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping;let i=new THREE.Vector2(1,1);s.width>0&&(i.x=1/s.width),s.depth>0&&(i.y=1/s.depth),a.repeat.set(i.x,i.y);const n=new THREE.MeshPhysicalMaterial({map:a,roughness:.5,metalness:.1});this._environmentLoader.setEnvMap(n),this._cacheHolder.materialCache.set(t,n),this.changeMaterialOfMesh(e,n),setTimeout(()=>r(),0)});else{const e="can not set material, catalog item top image is not set";console.warn(e),a(e)}},a)})}_generateMesh(e=0,t=null,r,a,s,i,n,o=!1){return this._plannerMeshGenerator.generateMesh(t,r,a,s,i,n)}setMaterialLoadedListener(e){this._materialLoaded=e}removeMaterialLoadedListener(){this._materialLoaded=void 0}}__decorate([inject],MeshGenerator.prototype,"_rapiAccess",void 0),__decorate([inject],MeshGenerator.prototype,"_environmentLoader",void 0),__decorate([inject],MeshGenerator.prototype,"_dataSyncer",void 0),__decorate([inject],MeshGenerator.prototype,"_singlePromiseFactory",void 0),__decorate([inject],MeshGenerator.prototype,"_cacheHolder",void 0),__decorate([inject],MeshGenerator.prototype,"_plannerMeshGenerator",void 0);const UI_CALLBACK_PREFIX="on",isMuteProperty="_isMute";class UiCallback{constructor(e){return this._isMute=!1,this._creator_=e,setDescriptor(this,isMuteProperty,{enumerable:!1,writable:!1}),setDescriptor(UiCallback.prototype,"_setMute",{enumerable:!1,writable:!1}),setDescriptor(UiCallback.prototype,"mute",{enumerable:!1,writable:!1}),setDescriptor(UiCallback.prototype,"unmute",{enumerable:!1,writable:!1}),new Proxy(this,this)}_setMute(e){setWriteable(this,isMuteProperty,!0),this._isMute=e,setWriteable(this,isMuteProperty,!1)}mute(){this._setMute(!0)}unmute(){this._setMute(!1)}get(e,t){return this._isMute&&"function"==typeof this[t]&&t.substr(0,2)===UI_CALLBACK_PREFIX?()=>void 0:this[t]}}export{getCatalogIdFromItemOrConfigurationId as a,kernelPartToPriceId as b,ENV as c,MESH_DEFAULT_FORMAT as d,UiCallback as e,RapiAccess as f,isIdItemId as g,MeshGenerator as h};
//# sourceMappingURL=chunk-200be00d.js.map
