import{a as getAssetPath,d as MainThreadToWorker,e as handleJsonResponse,b as setCursor,f as getAllParameters,g as ROOMLE_COLORS}from"./chunk-b0aa9923.js";import{a as __decorate,b as inject}from"./chunk-9f117dd9.js";const BROWSER_LANGUAGE_PROPERTY_KEYS_KNOWN=["language","browserLanguage","userLanguage","systemLanguage"],getLanguage=(e=null)=>{const t=window.navigator;if(e)return e.substr(0,2);if(Array.isArray(t.languages)&&t.languages.length>0)return t.languages[0].substr(0,2);for(let e=0,s=BROWSER_LANGUAGE_PROPERTY_KEYS_KNOWN.length;e<s;e++){const s=t[BROWSER_LANGUAGE_PROPERTY_KEYS_KNOWN[e]];if(s)return s.substr(0,2)}return"en"};class AppContext{static init(e={}){const{locale:t,kernelInstance:s,kernelContainer:i,planObjectId:n}=e;AppContext.kernelInstance=s,AppContext.kernelContainer=i,AppContext.planObjectId=n,AppContext.actualLocale=t?getLanguage(t):getLanguage()}static cleanUp(){AppContext.actualLocale=getLanguage(),AppContext.useHDGeometry=!1,AppContext.kernelInstance=null,AppContext.kernelContainer=null,AppContext.planObjectId=null}}AppContext.actualLocale=getLanguage(),AppContext.useHDGeometry=!1,AppContext.kernelInstance=null,AppContext.kernelContainer=null,AppContext.planObjectId=null;class Container{constructor(){this._context=new Map,this._lookups=new Map,this._singletons=new Map}getContext(e){if(this._context.has(e)){const t=this._context.get(e);return this._context.set(e,t+1),e+t}return this._context.set(e,1),e+0}addDependencyInjectionAssignments(e){e.forEach(e=>{this._lookups.set(e.className,e)})}lookup(e,t){if(!this._lookups.has(e))return null;let s=this._lookups.get(e);if(1===s.type&&void 0===t){const t="Dependency "+e+" has definition context but no context was defined!";return console.trace(t),console.error(t),null}let i=t&&1===s.type?t:"global";if(i+="_"+e,2===s.type)return new s.classDefinition;if(this._singletons.has(i))return this._singletons.get(i);let n=new s.classDefinition(t);return this._singletons.set(i,n),n}cleanUp(e){if(e){let t=[];this._singletons.forEach((s,i)=>{i.startsWith(e)&&t.push(i)}),t.forEach(e=>{this._singletons.delete(e)})}else this._singletons.clear(),this._singletons=new Map}}class DependencyInjectionAssignment{constructor(e,t,s){this.className=e,this.classDefinition=t,this.type=void 0===s?0:s}}const IMAGE_FORMATS={JPG:".jpg",JPEG:".jpeg",PNG:".png",GIF:".gif"};class FormDataUtil{_base64toBlob(e,t){t=t||"";const s=atob(e),i=s.length,n=Math.ceil(i/1024),o=new Array(n);for(let e=0;e<n;++e){let t=1024*e,n=Math.min(t+1024,i);const a=new Array(n-t);for(let e=t,i=0;e<n;++i,++e)a[i]=s[e].charCodeAt(0);o[e]=new Uint8Array(a)}return new Blob(o,{type:t})}_createFormData(e,t,s,i){const n=new FormData;-1!==e.indexOf(",")&&(e=e.substr(e.indexOf(",")+1));const o=-1===Object.keys(IMAGE_FORMATS).map(e=>IMAGE_FORMATS[e]).indexOf(s)?"application":"image",a=this._base64toBlob(e,o+"/"+s.substr(1));return n.append(i,a,t+s),n}create(e,t,s,i){return this._createFormData(e,t,s,i)}}class EnvironmentLoader{async getEnvironmentMap(){return this._environmentMap?Promise.resolve(this._iblEnvironmentMap||this._environmentMap):this._generateEnvironmentMapAsync()}_generateEnvironmentMapAsync(){return this._environmentMap?Promise.resolve(this._environmentMap):new Promise((e,t)=>{let s=new THREE.CubeTextureLoader;s.setPath(getAssetPath()),s.load(["static/textures/env/px.jpg","static/textures/env/nx.jpg","static/textures/env/py.jpg","static/textures/env/ny.jpg","static/textures/env/pz.jpg","static/textures/env/nz.jpg"],t=>{this._environmentMap=t,e(this._environmentMap)},null,t)})}async _generateIblEnvironmentMap(e){if(!this._iblEnvironmentMap){const t=await this._generateEnvironmentMapAsync(),s=new THREE.PMREMGenerator(t);s.update(e);const i=new THREE.PMREMCubeUVPacker(s.cubeLods);i.update(e),this._iblEnvironmentMap=i.CubeUVRenderTarget.texture,this._iblEnvironmentMap.minFilter=THREE.LinearFilter,this._iblEnvironmentMap.magFilter=THREE.LinearFilter,this._iblEnvironmentMap.needsUpdate=!0,s.dispose(),i.dispose()}return Promise.resolve(this._iblEnvironmentMap)}setDefaultEnvironmentMap(e){this._generateEnvironmentMapAsync().then(t=>{this._setEnvironmentMap(e,t)})}setIBLEnvironmentMap(e,t){this._generateIblEnvironmentMap(t).then(t=>{this._setEnvironmentMap(e,t)})}_setEnvironmentMap(e,t){e.traverse(e=>{e instanceof THREE.Mesh&&e.material instanceof THREE.MeshStandardMaterial&&(e.material.envMap=t)})}setEnvMap(e){this.getEnvironmentMap().then(t=>{e.envMap=t,e.envMapIntensity=1,e.needsUpdate=!0})}}const RECT_AREA_LIGHT_DEFAULT_SIZE=.8,PREDEFINED_LIGHTSETTING={SOFA:"sofa",SHELF:"shelf",SHELF_FRONT:"shelf_front",BAKED:"baked",CAMERA:"camera",EQUAL:"equal"};class DynamicLightSettingLoader{static createDynamicLightSettingSource(e,t){let s={};if(e)s.url=e;else if(t)switch(t){case PREDEFINED_LIGHTSETTING.SHELF:s.url=getAssetPath()+"static/predefined_lightsettings/shelf.json";break;case PREDEFINED_LIGHTSETTING.SHELF_FRONT:s.url=getAssetPath()+"static/predefined_lightsettings/shelf_front.json";break;case PREDEFINED_LIGHTSETTING.SOFA:s.url=getAssetPath()+"static/predefined_lightsettings/sofa.json";break;case PREDEFINED_LIGHTSETTING.BAKED:s.url=getAssetPath()+"static/predefined_lightsettings/baked.json";break;case PREDEFINED_LIGHTSETTING.CAMERA:s.url=getAssetPath()+"static/predefined_lightsettings/camera.json";break;case PREDEFINED_LIGHTSETTING.EQUAL:s.url=getAssetPath()+"static/predefined_lightsettings/equal.json";break;default:s=null}else s=null;return s}parse(e){let t=JSON.parse(e);return t.lights?this.load(t):[]}load(e){let t=[];return e.lights?(e.lights.forEach(e=>{let s;switch(e.type){case"ambient":s=this._parseAmbientLight(e);break;case"rectarea":s=this._parseRectAreaLight(e);break;case"spot":s=this._parseSpotLight(e);break;case"directional":s=this._parseDirectionalLight(e)}s&&t.push(s)}),t):[]}_parseAmbientLight(e){let t=new THREE.AmbientLight;return this._parseCommon(t,e),t}_parseRectAreaLight(e){let t=new THREE.RectAreaLight;this._parseCommon(t,e);let{intensity:s,castShadow:i,target:n,width:o,height:a}=e;return t.width=o||RECT_AREA_LIGHT_DEFAULT_SIZE,t.height=a||RECT_AREA_LIGHT_DEFAULT_SIZE,t.castShadow=i||!1,t.matrixAutoUpdate=!0,t.intensity=(s||240)/((o||RECT_AREA_LIGHT_DEFAULT_SIZE)*(a||RECT_AREA_LIGHT_DEFAULT_SIZE)),t.lookAt(n?new THREE.Vector3(n.x,n.y,n.z):new THREE.Vector3(0,0,0)),t}_parseSpotLight(e){let t=new THREE.SpotLight;this._parseCommon(t,e);let{angle:s,penumbra:i,target:n,castShadow:o}=e;return t.angle=(s||100)*Math.PI/180,t.penumbra=i||.5,t.lookAt(n?new THREE.Vector3(n.x,n.y,n.z):new THREE.Vector3(0,0,0)),t.shadow.camera.near=.1,t.shadow.camera.far=10,t.shadow.mapSize=new THREE.Vector2(1024,1024),t.castShadow=o||!1,t}_parseDirectionalLight(e){let t=new THREE.DirectionalLight;this._parseCommon(t,e);let{target:s,castShadow:i}=e;return t.castShadow=i||!1,t.shadow.camera.near=.1,t.shadow.camera.far=100,t.shadow.mapSize=new THREE.Vector2(1024,1024),t.shadow.bias=-5e-5,t.lookAt(s?new THREE.Vector3(s.x,s.y,s.z):new THREE.Vector3(0,0,0)),t}_parseCommon(e,t){let{name:s,intensity:i,color:n,position:o,movesWithCamera:a}=t;e.name=s||"",e.intensity=i||1,e.color=new THREE.Color(n||"#ffffff"),e.position.copy(o?new THREE.Vector3(o.x,o.y,o.z):new THREE.Vector3(0,0,0)),e.visible=!0,e.layers.set(1),e.userData.movesWithCamera=a}}const MAX_NETWORK_CALLS=40;class NetworkLayer{constructor(){this._queue=[],this._pendingRequests=0}_nextSlot(){if(this._pendingRequests-=1,!this._queue.length)return;const{request:e,resolve:t,reject:s}=this._queue.shift();this._fetch(e).then(t,s)}_fetch(e,t={}){return this._pendingRequests+=1,new Promise((s,i)=>{self.fetch(e,t).then(function(){this._nextSlot(),s(...arguments)}.bind(this),e=>{this._nextSlot(),i(e)})})}fetch(e,t={}){return this._pendingRequests>=MAX_NETWORK_CALLS?new Promise((t,s)=>this._queue.push({request:e,resolve:t,reject:s})):this._fetch(e,t)}}class Logger{info(...e){console}log(...e){console}warn(...e){console.warn.apply(console,e)}error(...e){console.warn.apply(console,e)}}const ASSET_CACHE=new Map,SYNCED_CATALOGS=new Map,SYNCED_FLOORS_TAGS=new Map,SYNCED_TYPE_CHANGE_TAGS=new Map;class DataSyncer{constructor(e){this._bootCallbacks=[],this._isStarted=!1,this._isStarting=!1,this._alwaysUseCache=!1,this._creator_=e}start(e){return this._configuratorUiCallbacks.onSyncStarted(),this._startWorker().then(()=>this._handleCatalog(e)).then(()=>{const{typeChangeTag:e,floorMaterialsTag:t}=window.__RML__ENV__.initData;Promise.all([this._syncFloorTag(t),this._syncTypeChangeTag(e)]).then(()=>{SYNCED_TYPE_CHANGE_TAGS.set(e,!0),this._configuratorUiCallbacks.onSyncDone()})})}syncCatalog(e){return this._startWorker().then(()=>this._handleCatalog(e))}syncFloorTag(e){return this._startWorker().then(()=>this._syncFloorTag(e))}syncTypeChangeTag(e){return this._startWorker().then(()=>this._syncTypeChangeTag(e))}_syncFloorTag(e){const t=[];return e&&!SYNCED_FLOORS_TAGS.get(e)?(t.push(this._handleTags([e])),this._rapiAccess.getTag(e).then(e=>{t.push(this._handleMaterialsAndTextures(e))}),this._singlePromiseFactory.create(1,e,s=>{Promise.all(t).then(()=>{SYNCED_FLOORS_TAGS.set(e,!0),s()},e=>this._softReject(s,'_syncFloorTag error: "'+e+'"'))})):Promise.resolve()}_syncTypeChangeTag(e){const t=[];return e&&!SYNCED_TYPE_CHANGE_TAGS.get(e)?(t.push(this._handleTags([e])),this._rapiAccess.getTag(e).then(e=>{this._rapiAccess.getItems(e.items).then(e=>{e.forEach(e=>{this.getIsCatalogSynced(e.catalog)&&t.push(this._handleCatalog(e.catalog))})})}),this._singlePromiseFactory.create(2,e,s=>{Promise.all(t).then(()=>{SYNCED_FLOORS_TAGS.set(e,!0),s()},e=>this._softReject(s,'_syncTypeChangeTag error: "'+e+'"'))})):Promise.resolve()}getIsCatalogSynced(e){return!!SYNCED_CATALOGS.get(e)}_startWorker(){return new Promise((e,t)=>{if(this._isStarted)return e();this._bootCallbacks.push({resolve:e,reject:t}),this._isStarting||(this._worker=new Worker(getAssetPath()+"static/workers/asset-loader.worker.js"),this._mainThreadToWorker=new MainThreadToWorker(this,this._worker),this._isStarting=!0,this._mainThreadToWorker.sendToWorker(1))})}onCommand(e,t,s){switch(e){case 4:this._isStarted=!0,this._bootCallbacks.forEach(({resolve:e})=>e());break;case 3:this._mainThreadToWorker.resolvePromises(t,s)}}_handleCatalog(e){return this._singlePromiseFactory.create(0,e,t=>this.getIsCatalogSynced(e)?t():this._rapiAccess.getCatalog(e).then(e=>Promise.all([this._handleContentWithAssets(this._rapiAccess.getComponentsOf(e),["perspectiveImage"]),this._handleItemsAndAdditionalContents(e),this._handleMaterialsAndTextures(e),this._handleExternalMeshes(e),this._handleTags(e.tags)])).then(()=>{SYNCED_CATALOGS.set(e,!0),t()},e=>this._softReject(t,'Catalog sync error: "'+e+'"')))}_handleTags(e){return this._handleContentWithAssets(this._rapiAccess.getTags(e),["pngIcon","svgIcon"])}_handleExternalMeshes(e){return new Promise(t=>{this._rapiAccess.getMeshesOfCatalog(e.id).then(e=>{const s=[];e.forEach(e=>{s.push(this._handleContentWithAssets(Promise.all([this._rapiAccess.getMesh(e.id)]),["url"]))}),Promise.all(s).then(t,e=>this._softReject(t,'Sync crt files error: "'+e+'"'))},e=>this._softReject(t,'getMeshesOfCatalog error: "'+e+'"'))})}_handleItemsAndAdditionalContents(e){return new Promise((t,s)=>{this._rapiAccess.getItemsOf(e).then(e=>{const s=[];s.push(this._handleContentWithAssets(Promise.resolve(e),["perspectiveImage"])),this._rapiAccess.getAdditionalContentsOfItems(e).then(e=>{const t=e.filter(e=>-1!==[5,6,4].indexOf(e.type));s.push(this._handleContentWithAssets(Promise.resolve(t),["content"]))},e=>this._softReject(t,'getAdditionalContentsOfItems error: "'+e+'"')),Promise.all(s).then(t,e=>this._softReject(t,'AdditionalContent image sync error:"'+e+'"'))})})}_handleMaterialsAndTextures(e){return new Promise((t,s)=>{this._rapiAccess.getMaterialsOf(e).then(e=>{const s=[];s.push(this._handleContentWithAssets(Promise.resolve(e),["thumbnail"])),e.forEach(e=>{s.push(this._handleContentWithAssets(this._rapiAccess.getTexturesOf(e),["image"]))}),Promise.all(s).then(t,e=>this._softReject(t,'getTexturesOf error: "'+e+'"'))},e=>this._softReject(t,'getMaterialsOf error: "'+e+'"'))})}_handleContentWithAssets(e,t){return new Promise(s=>e.then(e=>this._fetchAssets(e,t).then(s,e=>this._softReject(s,'_handleContentWithAssets error: "'+e+'"')),e=>this._softReject(s,'_handleContentWithAssets promise error: "'+e+'"')))}_fetchAssets(e,t){const s=[];e||(e=[]);for(let i=0,n=e.length;i<n;i++){const n=e[i];t.forEach(e=>{const t=n[e];t&&s.push(this._preCacheAsset(t))})}return Promise.all(s)}_preCacheAsset(e){return new Promise(t=>{if(ASSET_CACHE.get(e))return t();this._assetUrlToBase64(e).then(s=>{ASSET_CACHE.set(e,s),t()},e=>this._softReject(t,'_preCacheAsset error: "'+e+'"'))})}_assetUrlToBase64(e){return new Promise(t=>{this._mainThreadToWorker.sendToWorker(5,e,t,e=>this._softReject(t,'_assetUrlToBase64 error: "'+e+'"'))})}_softReject(e,t){this._errorHandler.softReject(e,t,2)}requestAsset(e,t=!1){return navigator.onLine&&!this._alwaysUseCache?e:ASSET_CACHE.get(e)||(t?e:null)}setAlwaysUseCache(e){this._alwaysUseCache=e}preFillAssetCache(e,t){ASSET_CACHE.set(e,t)}}__decorate([inject],DataSyncer.prototype,"_rapiAccess",void 0),__decorate([inject],DataSyncer.prototype,"_singlePromiseFactory",void 0),__decorate([inject],DataSyncer.prototype,"_errorHandler",void 0),__decorate([inject],DataSyncer.prototype,"_configuratorUiCallbacks",void 0);class StaticItemLoader{constructor(e){this._creator_=e,this._gltfLoader=new THREE.GLTFLoader,THREE.DRACOLoader.setDecoderPath(getAssetPath()+"static/three/lib/loaders/draco/"),this._gltfLoader.setDRACOLoader(new THREE.DRACOLoader)}loadGLB(e,t,s,i,n,o,a){return new Promise((r,h)=>{this._gltfLoader.load(e,e=>{r(this._handleGLTFScene("GLB",e,t,s,i,n,o,a))},e=>{},e=>{h(e)})})}loadGLTF(e,t,s,i,n,o,a){return new Promise((r,h)=>{this._gltfLoader.parse(e,null,e=>{r(this._handleGLTFScene("GLTF",e,t,s,i,n,o,a))},e=>{},e=>{h(e)})})}_handleGLTFScene(e,t,s,i,n,o,a,r){if(!t||!t.scene||!t.scene.children||0===t.scene.children.length)return null;if(s&&t.scene.position.copy(s),i&&(t.scene.rotation.y=i),n){const e=new THREE.Box3;e.setFromObject(t.scene);const{x:s,y:i,z:o}=e.getSize(new THREE.Vector3);let a=new THREE.Vector3(n.x/s,n.y/i,n.z/o);t.scene.scale.copy(a)}return o&&t.scene.scale.multiply(o),t.scene.type=e,t.scene.traverse(e=>{if(e instanceof THREE.Mesh){if(e.material instanceof THREE.MeshStandardMaterial){const t=e.material;if(this._environmentLoader.setEnvMap(t),r&&a&&a>0){let e=new THREE.Color(a);t.color=e.copyGammaToLinear(e),t.roughness=.5,t.metalness=.1}t.needsUpdate=!0}e.castShadow=!0,e.receiveShadow=!0}}),t.scene}}__decorate([inject],StaticItemLoader.prototype,"_environmentLoader",void 0);class ThreeLoader{constructor(e){this._jsonLoaded=!1,this._creator_=e}_loadShaders(){return new Promise((e,t)=>{if(this._jsonLoaded)return e();this._networkLayer.fetch(getAssetPath()+"static/three/lib/shaders.json",{credentials:"same-origin"}).then(handleJsonResponse,t).then(t=>{window._rsl=t,this._jsonLoaded=!0,e()},t)})}fetch(){return window._rsl||(window._rsl={}),new Promise((e,t)=>this._loadShaders().then(()=>{this._scriptLoader.fetch("static/three/lib/rthree.js",{id:"three-lib"}).then(e,t)},t))}}__decorate([inject],ThreeLoader.prototype,"_scriptLoader",void 0),__decorate([inject],ThreeLoader.prototype,"_networkLayer",void 0);const DEFAULT_STORE="rml_default",DEFAULT_STORE_SIZE=5;class LocalStorageHelper{constructor(e){this._context_=e}getStore(e=DEFAULT_STORE){return this._localStorage.getItem(e)||{entries:[]}}saveStore(e,t){this._localStorage.setItem(e,t)}addItem(e,t,s=DEFAULT_STORE,i=DEFAULT_STORE_SIZE){const n=this.getStore(s),o=n.entries.find(t=>t.id===e);if(o?(o.payload=t,o.date=Date.now()):n.entries.push({id:e,date:Date.now(),payload:t}),n.entries.length>i)for(n.entries.sort((e,t)=>t.date-e.date);n.entries.length>i;)n.entries.pop();this.saveStore(s,n)}getItem(e,t=DEFAULT_STORE){const s=this.getStore(t).entries.find(t=>t.id===e);return s?s.payload:null}}__decorate([inject],LocalStorageHelper.prototype,"_localStorage",void 0);class DynamicQualitySettingLoader{set(e,t){t&&(void 0!==t.enableAA&&(e.enableAA=t.enableAA),this._setSAOPass(e,t),this._setShadowPass(e,t),this._setGroundShadow(e,t))}_setSAOPass(e,t){if(t.SAOPass){const s=t.SAOPass;void 0!==s.enabled&&(e.getSAOPass().enabled=s.enabled),void 0!==s.smoothTransition&&(e.getSAOPass().smoothTransition=s.smoothTransition),s.occlusionWorldRadius&&(e.getSAOPass().occlusionWorldRadius=s.occlusionWorldRadius),s.intensity&&(e.getSAOPass().intensity=s.intensity),s.bias&&(e.getSAOPass().bias=s.bias),s.numSamples&&(e.getSAOPass().numSamples=s.numSamples)}}_setShadowPass(e,t){if(t.shadowPass){const s=t.shadowPass;void 0!==s.enabled&&(e.getShadowPass().enabled=s.enabled),void 0!==s.smoothTransition&&(e.getShadowPass().smoothTransition=s.smoothTransition),void 0!==s.enableAccumulation&&(e.getShadowPass().enableAccumulation=s.enableAccumulation),s.shadowRadius&&(e.getShadowPass().shadowRadius=s.shadowRadius),s.shadowBiasMultiplier&&(e.getShadowPass().shadowBiasMultiplier=s.shadowBiasMultiplier),s.numSamples&&(e.getShadowPass().numSamples=s.numSamples)}}_setGroundShadow(e,t){if(t.groundShadow){const s=t.groundShadow;void 0!==s.enable&&(e.getShadowPlanePass().enable=s.enable),void 0!==s.smoothTransition&&(e.getShadowPlanePass().smoothTransition=s.smoothTransition),s.numSamples&&(e.getShadowPlanePass().numSamples=s.numSamples),s.numSamplesPerFrame&&(e.getShadowPlanePass().numSamplesPerFrame=s.numSamplesPerFrame)}}}const toRadiant=function(e){return e*(Math.PI/180)},getIdealDistance=function(e,t,s,i,n,o){let a=Math.tan(i*(2*Math.PI/360)/2),r=s/2,h=t/2/a+r,l=e/2/(n/o)/a+r;return Math.max(h,l)},round=function(e){return Math.round(1e3*e)/1e3},getDelta=function(e,t){return Math.abs(e.y-t.y)+Math.abs(e.x-t.x)},getAngle=function(e,t){return Math.atan2(t.y-e.y,t.x-e.x)},to360Degrees=function(e){let t=function(e){return e*(180/Math.PI)}(e);return t<0&&(t=180+(180+t)),t},PREVIEW_LINE_MATERIAL_OPACITY=.4,PREVIEW_MATERIAL_COLOR="#DDDDDD",PREVIEW_MATERIAL_ROUGHNESS=1,PREVIEW_MATERIAL_METALNESS=0,PREVIEW_MATERIAL_OPACITY=1,getScreenXY=(e,t,s,i)=>{if(!e||!t||0===s||0===i)return new THREE.Vector3;let n=e.clone(),o=s/2,a=i/2;return n.project(t),n.x=n.x*o+o,n.y=-n.y*a+a,n.z=0,n},kernelBoxToThreeBox=(e,t)=>{t||(t=new THREE.Vector3(0,0,0));let s=new THREE.Vector3(e.size.x/1e3,e.size.z/1e3,e.size.y/1e3),i=new THREE.Vector3(e.origin.x/1e3,e.origin.z/1e3,e.origin.y/-1e3),n=new THREE.Vector3(0,0,-s.z).add(i).sub(t),o=new THREE.Vector3(s.x,s.y,0).add(i).add(t);return new THREE.Box3(n,o)},kernelDimensioningToThree=e=>(e.from=e.from/1e3,e.to=e.to/1e3,1===e.type.value?(e.type={value:2},e.from*=-1,e.to*=-1):2===e.type.value&&(e.type={value:1}),e),setShadows=(e,t,s)=>{e.castShadow=s,e.receiveShadow=t,e.children.forEach(e=>{setShadows(e,t,s)})},position3VectorsAreEqual=(e,t)=>{let s=round(e.x),i=round(e.y),n=round(e.z),o=round(t.x),a=round(t.y),r=round(t.z);return s===o&&i===a&&n===r},rotationQuaternionsAreEqual=(e,t)=>{let s=round(e.w),i=round(e.x),n=round(e.y),o=round(e.z),a=round(t.w),r=round(t.x),h=round(t.y),l=round(t.z);return s===a&&i===r&&n===h&&o===l},position2VectorsAreEqual=(e,t)=>{let s=round(e.x),i=round(e.y),n=round(t.x),o=round(t.y);return s===n&&i===o};let whiteTexture=null;const createMaterial=(e,t)=>{let s=new THREE.MeshPhysicalMaterial({metalness:1===e.shading.metallic?1:.5,reflectivity:e.shading.metallic||.5,roughness:e.shading.roughness||.5,transparent:e.shading.alpha<1,opacity:e.shading.alpha,depthWrite:e.shading.alpha>=1});if(e.shading.basecolor){const t=new THREE.Color(e.shading.basecolor.r,e.shading.basecolor.g,e.shading.basecolor.b);s.color.copy(t.copyGammaToLinear(t))}return t&&t.getEnvironmentMap().then(e=>{s&&e&&(s.envMap=e,s.needsUpdate=!0)}),e.shading.doubleSided?s.side=THREE.DoubleSide:s.side=THREE.FrontSide,e.shading.alphaCutoff?s.alphaTest=e.shading.alphaCutoff:s.alphaTest=0,whiteTexture||(whiteTexture=(()=>{const e=new Uint8Array(4);for(let t=0;t<1;t++){const s=4*t;e[s]=255,e[s+1]=255,e[s+2]=255,e[s+3]=255}const t=new THREE.DataTexture(e,1,1,THREE.RGBAFormat);return t.needsUpdate=!0,t})()),s.map=whiteTexture,s},getMaterialShading=e=>{let t=e.color.clone().copyLinearToGamma(e.color),s={alpha:e.opacity,metallic:e.reflectivity,basecolor:{r:t.r,g:t.g,b:t.b},roughness:e.roughness,doubleSided:e.side===THREE.DoubleSide,alphaCutoff:e.alphaTest};return 1===e.metalness?s.metallic=1:s.metallic=e.reflectivity,s};let textureLoader=null;const addTexture=(e,t,s,i,n,o)=>(textureLoader||((textureLoader=new THREE.TextureLoader).crossOrigin=""),new Promise((a,r)=>{textureLoader.load(e,e=>{e.anisotropy=i,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat.set(n,o),"XYZ"===t.mapping?s.normalMap=e:s.map=e,"RGBA"===t.mapping&&(s.transparent=!0),s.needsUpdate=!0,a()},r)})),getGUI=(e=!0)=>(window.__RML_GUI__||(window.__RML_GUI__=new dat.GUI({autoPlace:e})),window.__RML_GUI__),setWallTransparencyBasedOnCamera=(e,t,s=!0)=>{let i=e.getWorldDirection(new THREE.Vector3),n=Math.abs(i.y);n<.5&&!t.transparent&&setWallTransparency(t,!0,s),n>.5&&t.transparent&&setWallTransparency(t,!1,s)},setWallTransparency=(e,t,s=!0)=>{if(!e.userData.tween)if(t)if(e.transparent=!0,s){let t={opacity:1};e.userData.tween=!0,new TWEEN.Tween(t).to({opacity:.2},400).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{e.opacity=t.opacity}).onComplete(()=>{e.userData.tween=!1}).start()}else e.opacity=.2;else if(s){let t={opacity:.2};e.userData.tween=!0,new TWEEN.Tween(t).to({opacity:1},400).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{e.opacity=t.opacity}).onComplete(()=>{e.transparent=!1,e.userData.tween=!1}).start()}else e.opacity=1,e.transparent=!1},getColorFromInt=e=>{let t=new THREE.Color;return t.setRGB((e>>16)/255,(e>>8&255)/255,(e>>0&255)/255),t},fadeIn=e=>{e.traverse(e=>{if(e instanceof THREE.Mesh&&TWEEN){let t=e.material;if(0===t.opacity)return;let s={opacity:0,transparent:!0},i={opacity:t.opacity,transparent:t.transparent};t.transparent=s.transparent,t.opacity=s.opacity,new TWEEN.Tween(s).to(i,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{t.opacity=s.opacity}).onComplete(()=>{t.transparent=i.transparent}).start()}})},checkGLB=(e,t)=>{let s=(new THREE.Box3).setFromObject(e),i=s.getSize(new THREE.Vector3),n=Math.min(i.x,i.y,i.z),o=!0;return n>5&&(console.warn("GLB seems to be too big ("+n+")",t),o=!1),s.min.y<-.01&&(console.warn("GLB seems to be under the floor ("+s.min.y+"): ",t),o=!1),o},dispose=e=>{"Mesh"===e.type?disposeMesh(e):disposeObject(e)},disposeObject=e=>{e&&e.children&&0!==e.children.length&&e.children.forEach(e=>{disposeMesh(e)})},disposeMesh=e=>{e&&(e.material&&disposeMaterial(e.material),e.geometry&&disposeGeometry(e.geometry),e.children&&e.children.length>0&&disposeObject(e))},disposeGeometry=e=>{e&&e.dispose()},disposeMaterial=e=>{e&&(e.map&&e.map.dispose(),e.normalMap&&e.normalMap.dispose(),e.dispose())};let boundingBoxMaterial;const getBoundingBoxMaterial=()=>(boundingBoxMaterial||((boundingBoxMaterial=new THREE.MeshBasicMaterial).visible=!1),boundingBoxMaterial),getSelectionGeometry=(e,t)=>{let s=t.x/2,i=t.z/2,n=new THREE.Vector3(-s,.01,i),o=[n,new THREE.Vector3(n.x,n.y,n.z+.2),new THREE.Vector3(n.x-.2,n.y,n.z+.2),new THREE.Vector3(n.x-.2,n.y,n.z)],a=[new THREE.Face3(3,2,0),new THREE.Face3(2,1,0)],r=new THREE.Geometry;return r.vertices.push(...o),r.faces.push(...a),r.computeFaceNormals(),r.computeVertexNormals(),r},vectorIsZero=e=>0===e.x&&0===e.y&&0===e.z,getMaterialId=(e,t)=>{let s="";return e.materialId&&""!==e.materialId?s=e.materialId:e.catalogItemId&&""!==e.catalogItemId?s=e.catalogItemId:e.rgbValue>0?s="rbg"+JSON.stringify(e.rgbValue):e.length>0?s=e:t&&1===t.value?s="default_wall_material_"+e.getSourceType().value:t&&7===t.value&&(s="default_ceiling_material_"+e.getSourceType().value),s},vectorIsEqual=(e,t,s=.01)=>!(!e||!t)&&Math.abs(e.x-t.x)<=s&&Math.abs(e.y-t.y)<=s&&Math.abs(e.z-t.z)<=s,convertToTHREE=e=>new THREE.Vector3(e.x/1e3,e.z/1e3,e.y/-1e3),convertToEuler=e=>new THREE.Euler(e.x,e.z,-e.y),convertToThreeDimensions=e=>new THREE.Vector3(e.x/1e3,e.z/1e3,e.y/1e3),convertToKernel=e=>({x:1e3*e.x,y:-1e3*e.z,z:1e3*e.y}),utilityStringToUTF16=e=>decodeURIComponent(encodeURIComponent(e)),convertCObject=e=>{if(!e){const t=typeof e;return"number"===t||"boolean"===t?e:null}if(!e.hasOwnProperty("size")&&e.size&&"function"==typeof e.size){let t=utilityToArray(e);for(let e=0;e<t.length;e++)t[e]=convertCObject(t[e]);return"string"==typeof t?utilityStringToUTF16(t):t}if("object"==typeof e)for(let t in e)e.hasOwnProperty(t)&&(e[t]=convertCObject(e[t]));return"string"==typeof e?utilityStringToUTF16(e):e},utilityToArray=e=>{let t=[];if(e){let s=e.size();for(let i=0;i<s;i++)t.push(e.get(i))}return t},convertToThreeMatrix=e=>{let t=new THREE.Matrix4,s=convertCObject(e);return t.fromArray(s),t.transpose(),(e=>{let t=new THREE.Matrix4;t.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),t.scale(new THREE.Vector3(.001,.001,.001));let s=new THREE.Matrix4;return s.set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),s.scale(new THREE.Vector3(1e3,1e3,1e3)),t.multiply(e).multiply(s)})(t)};function RoomleComponentFactoryInitializer(){class e extends THREE.Object3D{constructor(e,t,s,i){super(),this._selected=!1,this.meshes=[],this.castShadow=!0,this.receiveShadow=!0,this._setValues(e,t,s,i)}static _generateDashedLine(e,t){let s=new THREE.LineSegments(e,new THREE.LineDashedMaterial({color:"#000000",dashSize:.03,gapSize:.01,linewidth:1}));return s.translateOnAxis(t,1),s}static cloneDockLine(e,t){let s=new THREE.LineSegments(e.geometry,e.material);return s.translateOnAxis(t.getCenter(new THREE.Vector3),1),s.name="dockline",s.layers.set(5),s}static _generateCubeGeometry(e,t,s){let i=new THREE.Geometry;return i.vertices.push(new THREE.Vector3(-e,-t,-s),new THREE.Vector3(-e,t,-s),new THREE.Vector3(-e,t,-s),new THREE.Vector3(e,t,-s),new THREE.Vector3(e,t,-s),new THREE.Vector3(e,-t,-s),new THREE.Vector3(e,-t,-s),new THREE.Vector3(-e,-t,-s),new THREE.Vector3(-e,-t,s),new THREE.Vector3(-e,t,s),new THREE.Vector3(-e,t,s),new THREE.Vector3(e,t,s),new THREE.Vector3(e,t,s),new THREE.Vector3(e,-t,s),new THREE.Vector3(e,-t,s),new THREE.Vector3(-e,-t,s),new THREE.Vector3(-e,-t,-s),new THREE.Vector3(-e,-t,s),new THREE.Vector3(-e,t,-s),new THREE.Vector3(-e,t,s),new THREE.Vector3(e,t,-s),new THREE.Vector3(e,t,s),new THREE.Vector3(e,-t,-s),new THREE.Vector3(e,-t,s)),i}_setValues(e,t,s,i){e&&(this.roomleId=e),t&&(this.roomlePosition=Object.assign({},t)),s&&(this.roomleRotation=Object.assign({},s)),i&&(this.parentObjectId=i)}get loadingMesh(){return this._loadingMesh}get boundingBoxMesh(){return this._boundingBoxMesh}get boundingBox(){return this._boundingBox}set roomlePosition(e){this._roomlePosition=e,e&&this.position.set(e.x/1e3,e.z/1e3,e.y/-1e3)}get roomlePosition(){return this._roomlePosition}set roomleRotation(e){this._roomleRotation=e,e&&this.rotation.set(e.x,e.z,-e.y)}get roomleRotation(){return this._roomleRotation}replaceMeshes(e){this.removeAllMeshes(),e.forEach(e=>{this.addMesh(new THREE.Mesh(e.geometry,e.material))})}addMesh(e,t){e.renderOrder=2,e.userData.meshType=0,e.castShadow=!0,e.receiveShadow=!0,t&&e.applyMatrix(convertToThreeMatrix(t)),this.add(e),this.meshes.push(e)}removeMesh(e){const t=this.meshes.indexOf(e);this.remove(e),disposeMesh(e),t<0||this.meshes.splice(t,1)}removeAllMeshes(e=!0){this.meshes.forEach(t=>{this.remove(t),e&&disposeMesh(t)}),this.meshes=[],this.remove(this._loadingMesh),disposeMesh(this._loadingMesh),this._loadingMesh=null,this.remove(this._boundingBoxMesh),disposeMesh(this._boundingBoxMesh),this._boundingBoxMesh=null}select(){this._selected=!0}loading(){this._kernelBoundingBox||console.warn("Bounding box (box for measurements) for component "+this.roomleId+" not set, can not show external mesh loading box!")}deselect(){this._selected=!1}hoverOn(){setCursor("pointer")}hoverOff(){setCursor("default")}removeFromParent(){this.parent&&(this.parent.remove(this),this.removeAllMeshes())}clear(t){this.hoverOff(),t&&this.children.forEach(s=>{s instanceof e&&s.clear(t)})}computeBoundingBox(t,s=!1){this._boundingBoxMesh&&this.remove(this._boundingBoxMesh);let i=null,n=null;if(!t||s){this._boundingBox=new THREE.Box3;let t=new THREE.Vector3;this.meshes.forEach(e=>{if(e.geometry instanceof THREE.Geometry){let s=e.geometry.vertices;for(let i=0,n=s.length;i<n;i++)t.copy(s[i]),t.applyMatrix4(e.matrix),this._boundingBox.expandByPoint(t)}else if(e.geometry instanceof THREE.BufferGeometry){let s=e.geometry.attributes.position;if(void 0!==s)for(let i=0,n=s.count;i<n;i++)t.fromBufferAttribute(s,i).applyMatrix4(e.matrixWorld),this._boundingBox.expandByPoint(t)}}),this._kernelBoundingBox=this._boundingBox.clone();let s=this._boundingBox.max.x-this._boundingBox.min.x,o=this._boundingBox.max.y-this._boundingBox.min.y,a=this._boundingBox.max.z-this._boundingBox.min.z;i=new THREE.BoxGeometry(s,o,a),n=e._generateCubeGeometry(s/2,o/2,a/2)}else{this._kernelBoundingBox=kernelBoxToThreeBox(t),this._boundingBox=this._kernelBoundingBox.clone();let{x:s,y:o,z:a}=this._boundingBox.getSize(new THREE.Vector3);i=new THREE.BoxGeometry(s,o,a),n=e._generateCubeGeometry(s/2,o/2,a/2)}this._boundingBoxMesh=new THREE.Mesh(i,new THREE.MeshStandardMaterial({color:"#FFFFFF",transparent:!0,opacity:0,polygonOffset:!0,polygonOffsetFactor:-1}));let o=this._boundingBox.getCenter(new THREE.Vector3);this._boundingBoxMesh.position.add(o),this._boundingBoxMesh.layers.set(5),this._boundingBoxMesh.renderOrder=3,this._boundingBoxMesh.castShadow=!1,this._boundingBoxMesh.receiveShadow=!1,this.add(this._boundingBoxMesh),this._dockline=e._generateDashedLine(n,o),this._dockline.name="dockline",this._dockline.layers.set(5),this._selected&&this.add(this._dockline)}recursiveMeshes(){let t=this.meshes.slice();return this.children.forEach(s=>{s instanceof e&&t.push(...s.recursiveMeshes())}),t}isChild(t){let s=!1;return this.children.forEach(i=>{i instanceof e&&!s&&(s=i.roomleId===t||i.isChild(t))}),s}getKernelPosition(e){let t=this.parent.localToWorld(this.position);return convertToKernel(e.worldToLocal(t))}}class t extends e{constructor(e,t){super(e,null,null,null),this.glbUrl=t}}class s extends e{constructor(e,t,s,i){super(e,t,s,i),this._stringId=null,this.receivedPointAssociation=!1,this.castShadow=!1,this.receiveShadow=!1}get stringId(){return this._stringId?this._stringId:this.roomleId.toString()}addMesh(e,t){super.addMesh(e,t),e.material instanceof THREE.MeshStandardMaterial&&(e.material.opacity=.6,e.material.roughness=1,e.material.metalness=0,e.material.color=new THREE.Color("#DDDDDD")),e.renderOrder=1,e.castShadow=!1,e.receiveShadow=!1}hoverOn(){this.remove(this._dockline),this.meshes.forEach(({material:e})=>{e.opacity=.9,e.roughness=1,e.metalness=0,e.color=new THREE.Color("#DDDDDD")}),setCursor("pointer")}hoverOff(){this.add(this._dockline),this.meshes.forEach(({material:e})=>{e.opacity=.6,e.roughness=1,e.metalness=0,e.color=new THREE.Color("#DDDDDD")}),setCursor("default")}clonePreview(t){let i=new s(this.roomleId,this.roomlePosition,this.roomleRotation,this.parentObjectId);return i._stringId=this.roomleId+"_"+t,this.children.forEach(e=>{e instanceof THREE.Mesh&&0===e.userData.meshType&&i.meshes.push(e.clone(!0))}),i.meshes.forEach(e=>{e.material=e.material.clone(),e.geometry=e.geometry.clone(),i.add(e)}),this._dockline&&(i._dockline=e.cloneDockLine(this._dockline,this._boundingBox)),this._boundingBoxMesh&&(i._boundingBoxMesh=this._boundingBoxMesh.clone(!0)),this._boundingBox&&(i._boundingBox=this._boundingBox.clone()),i}preparePreview(){this.add(this._dockline),this.add(this._boundingBoxMesh)}}class i extends s{constructor(e,t,s,i,n){super(e,t,s,i),n&&(this._stringId=this.roomleId+"_has_additional_dock_point_copy")}set roomleLineFrom(e){this._roomleLineFrom=e,this.lineFrom=convertToTHREE(e)}get roomleLineFrom(){return this._roomleLineFrom}set roomleLineTo(e){this._roomleLineTo=e;let t=convertToTHREE(e);t.equals(this.lineFrom)&&(console.warn("lineFrom and lineTo are equal!"),t.add(new THREE.Vector3(0,.01,0))),this.lineTo=t}get roomleLineTo(){return this._roomleLineTo}set roomlePositionFrom(e){this._roomlePositionFrom=e,this.positionFrom=convertToTHREE(e)}get roomlePositionFrom(){return this._roomlePositionFrom}set roomlePositionTo(e){this._roomlePositionTo=e;let t=convertToTHREE(e);t.equals(this.positionFrom)&&(console.warn("positionFrom and positionTo are equal!"),t.add(new THREE.Vector3(0,.01,0))),this.positionTo=t}get roomlePositionTo(){return this._roomlePositionTo}addMesh(e,t){super.addMesh(e,t),e.visible=!1,e.renderOrder=3}hoverOn(){this._dockline.visible=!0,setCursor("pointer")}hoverOff(){this._dockline.visible=!1,setCursor("default")}preparePreview(){super.preparePreview(),this._dockline.visible=!1;let e=this.lineTo.clone(),t=this.lineFrom.clone();const s=(new THREE.Vector3).subVectors(e,t);let i=s.length(),n=s.normalize(),o=new THREE.ArrowHelper(n,t),a=new THREE.CylinderGeometry(.01,.01,i,16,1);this.lineMesh=new THREE.Mesh(a,new THREE.MeshStandardMaterial({color:PREVIEW_MATERIAL_COLOR,transparent:!0,opacity:PREVIEW_LINE_MATERIAL_OPACITY})),this.lineMesh.name="line mesh";const r=(new THREE.Quaternion).setFromEuler(o.rotation);this.lineMesh.quaternion.multiply(r),this.lineMesh.renderOrder=1;let h=(new THREE.Vector3).addVectors(e,t).multiplyScalar(.5);this.lineMesh.position.copy((new THREE.Vector3).subVectors(h,this.position.clone())),this.add(this.lineMesh);let l=this._boundingBox.getCenter(new THREE.Vector3),c=null,d=0,_=Math.abs(n.x),u=Math.abs(n.y),g=Math.abs(n.z);_>=u&&_>=g?(c=new THREE.Vector3(l.x,0,0),d=Math.sqrt(l.y*l.y+l.z*l.z)):u>=_&&u>=g?(c=new THREE.Vector3(0,l.y,0),d=Math.sqrt(l.x*l.x+l.z*l.z)):g>=u&&g>=_&&(c=new THREE.Vector3(0,0,l.z),d=Math.sqrt(l.y*l.y+l.x*l.x)),d=d>0?d:.01;let m=(new THREE.Vector3).subVectors(this.positionTo.clone(),this.positionFrom.clone()).length()+c.length(),p=new THREE.CylinderGeometry(1.1*d,1.1*d,m,32,1);this.boundingLineMesh=new THREE.Mesh(p,new THREE.MeshStandardMaterial({color:"#ffffff",transparent:!0,opacity:0})),this.boundingLineMesh.name="bounding line mesh";let E=this.positionTo.clone(),w=this.positionFrom.clone(),T=(new THREE.Vector3).subVectors(E,w).normalize(),y=new THREE.ArrowHelper(T,w);const S=(new THREE.Quaternion).setFromEuler(y.rotation);this.boundingLineMesh.quaternion.multiply(S),this.boundingLineMesh.renderOrder=3;let R=(new THREE.Vector3).addVectors(this.positionTo.clone(),this.positionFrom.clone()).multiplyScalar(.5).add(l);this.boundingLineMesh.position.copy((new THREE.Vector3).subVectors(R,this.position.clone())),this.add(this.boundingLineMesh)}clonePreviewLine(t){let s=new i(this.roomleId,this.roomlePosition,this.roomleRotation,this.parentObjectId,this.receivedPointAssociation);return s._stringId=this.roomleId+"_"+t,this.children.forEach(e=>{e instanceof THREE.Mesh&&0===e.userData.meshType&&s.meshes.push(e.clone(!0))}),s.meshes.forEach(e=>{e.material=e.material.clone(),e.geometry=e.geometry.clone(),s.add(e)}),this._dockline&&(s._dockline=e.cloneDockLine(this._dockline,this._boundingBox)),this._boundingBoxMesh&&(s._boundingBoxMesh=this._boundingBoxMesh.clone(!0)),this._boundingBox&&(s._boundingBox=this._boundingBox.clone()),s}getPositionForIntersectionPoint(e){let t=this.positionTo.clone().add(this._boundingBox.getCenter(new THREE.Vector3)),s=this.positionFrom.clone().add(this._boundingBox.getCenter(new THREE.Vector3)),i=new THREE.Line3(s,t).closestPointToPoint(e,!0,new THREE.Vector3);return(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))&&i.copy(e),i.sub(this._boundingBox.getCenter(new THREE.Vector3))}updatePreviewPosition(e){let t=this.getPositionForIntersectionPoint(e),s=this.parent.localToWorld(t);this._newPosition=this.worldToLocal(s),this._dockline.position.copy((new THREE.Vector3).addVectors(this._newPosition,this._boundingBox.getCenter(new THREE.Vector3))),this._dockline.rotation.copy(this.docklineRotation)}hideSelectionLine(){this._dockline.visible=!1}getKernelPosition(e){if(this._newPosition){let t=this.localToWorld(this._newPosition);return convertToKernel(e.worldToLocal(t))}return super.getKernelPosition(e)}}class n extends THREE.PerspectiveCamera{constructor(e,t,s,i,n){super(e,t,s,i),this.offset=n}set offset(e){this._offset=e,this.updateProjectionMatrix()}get offset(){return this._offset}_calculateProjectionMatrix(){let e,t,s,i,n=this.fov*(2*Math.PI/360)/2;i=-(s=Math.tan(n));let o=Math.atan(this.aspect*Math.tan(n));e=-(t=Math.tan(o));let a=this._offset.left,r=this._offset.right,h=this._offset.top,l=this._offset.bottom,c=new THREE.Vector2(r-a,h-l),d=new THREE.Vector2(a+c.x/2,l+c.y/2);if(c.x<c.y){let n=(1-d.x)/(c.x/2),o=d.x/(c.x/2);t*=n,e*=o;let a=(n+o)/2;s*=a,i*=a}else{let n=(1-d.y)/(c.y/2),o=d.y/(c.y/2);s*=n,i*=o;let a=(o+n)/2;e*=a,t*=a}e*=this.near,t*=this.near,s*=this.near,i*=this.near;let _=this.near*Math.tan(Math.PI/180*.5*this.fov)/this.zoom*2,u=this.aspect*_;return this.view&&this.view.enabled&&(e+=this.view.offsetX*u/this.view.fullWidth,s-=this.view.offsetY*_/this.view.fullHeight,t+=this.view.offsetX*u/this.view.fullWidth,i-=this.view.offsetY*_/this.view.fullHeight),(new THREE.Matrix4).makePerspective(e,t,s,i,this.near,this.far)}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){this._offset?this.projectionMatrix=this._calculateProjectionMatrix():super.updateProjectionMatrix()}}return{create:function(t,s,i,n){return new e(t,s,i,n)},createPreview:function(e,t){return new s(e,{x:0,y:0,z:0},{x:0,y:0,z:0},t)},createStatic:function(e,s){return new t(e,s)},createPreviewLine:function(e){let t=new i(e.id,e.roomlePosition,e.roomleRotation,e.parentObjectId,e.receivedPointAssociation);return e.meshes.forEach(e=>{let s=e.clone();s.material=e.material.clone(),s.geometry=e.geometry.clone(),t.addMesh(s)}),t.computeBoundingBox(),t},isPreview:function(e){return e instanceof s},isPreviewLine:function(e){return e instanceof i},createCamera:function(e,t,s,i,o){return new n(e,t,s,i,o)}}}const WAITERS=new Map,_endOperation=function(e,t,s){let i=WAITERS.get(e);if(i){const n=s?[s]:void 0;i.forEach(({resolve:e,reject:s})=>t?e.apply(e,n):s.apply(s,n)),WAITERS.delete(e)}};class AsyncHelper{static finishOperation(e,t){_endOperation(e,!0,t)}static failOperation(e,t){_endOperation(e,!1,t)}static waitFor(e,t){return new Promise((s,i)=>{let n=WAITERS.get(e);n||(WAITERS.set(e,[]),n=WAITERS.get(e)),n.push({resolve:s,reject:i}),"function"==typeof t&&t.apply(t)})}}const START_SUFFIX="_start",META_INFO=new Map;class Benchmark{static start(e){if(!window.performance||!window.performance.getEntriesByName)return"";let t=window.performance.getEntriesByName(e).length++,s="";t<100&&(s="0"),t<10&&(s="0"+s);const i=t>0?e+"_"+s+t:e,n=i+START_SUFFIX;return window.performance.mark(n),i}static addMeta(e,t){const s=Benchmark.getMeta(e);META_INFO.set(e,Object.assign(s,t))}static getMeta(e){return META_INFO.get(e)||{}}static end(e){}static getMeasure(e){return[]}static showBenchmarks(e){const t=window.performance.getEntriesByType("measure");t.sort(function(e,t){return e.startTime-t.startTime});const s=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e&&-1===n.name.indexOf(e)||s.push({Start:parseFloat(n.startTime.toFixed(2)),Name:n.name,Duration:parseFloat(n.duration.toFixed(2))})}console.table(s)}}const DOCKING_CONVERSATION_ID=10,DEFAULT_CONVERSATION_ID=9;class ConfiguratorViewModel{constructor(e){this._mergeThreshold=3,this._componentsToMerge=new OccurrenceMap,this._mergeInProgress=!1,this._components=new Map,this._previews=new Map,this._creator_=e,this._getKernelAccess().addConfiguratorListener(this),this._componentFactory=RoomleComponentFactoryInitializer()}get waitingForMaterials(){return this._configuratorMeshGenerator.waitingForMaterials}set waitingForMaterials(e){this._configuratorMeshGenerator.waitingForMaterials=e}_getKernelAccess(){return RoomleDependencyInjection.lookup("kernel-access",this._creator_)}clearReference(){this._getKernelAccess().removeConfiguratorListener(this)}_addMeshToComponent(e,t,s,i,n,o,a,r){let h=this._components.get(e);if(!h&&!(h=this._previews.get(e.toString())))return void console.warn("component not found!",e);const l=this._componentFactory.isPreview(h);let c=this._generateMesh(e,t,l?null:s,n,o,a,r);s&&(c.userData.material=s),i&&(c.userData.transform=convertToThreeMatrix(i),c.applyMatrix(c.userData.transform)),l&&c.layers.set(4),h&&h.addMesh(c),h.meshes.length>this._mergeThreshold&&this._componentsToMerge.set(e,h.meshes.length)}tryToMergeComponents(){this._mergeInProgress||(this._mergeInProgress=!0,this._componentsToMerge.size,this._requestMergeComponents())}_requestMergeComponents(){window.requestIdleCallback(this._mergeNextComponent.bind(this))}_mergeNextComponent(){if(this._componentsToMerge.size>0){const e=this._componentsToMerge.largestValue();this._componentsToMerge.delete(e),this._mergeComponent(e),this._requestMergeComponents()}else this._mergeInProgress=!1,this._geometriesMerged&&this._geometriesMerged(),this._components.forEach(e=>{e.loadingMesh&&console.warn("component still has loading mesh: ",e.hash)})}_mergeComponent(e){const t=this._components.get(e);if(t&&!(t.meshes.length<=this._mergeThreshold))if(this._cacheHolder.componentCache.has(t.hash)){const e=this._cacheHolder.componentCache.get(t.hash).meshes;t.replaceMeshes(e)}else{const e=new Map,s=[],i=[];t.meshes.forEach(t=>{const n=t.userData.material;if(!n)return void console.warn("mesh has no material id set");if(!e.has(n)){const i=new THREE.Mesh(new THREE.Geometry,t.material);i.userData.material=n,i.receiveShadow=!0,i.castShadow=!0,i.layers.set(3),this._setMaterial(i,n),s.push(i),e.set(n,i)}const o=e.get(n).geometry;t.userData.transform?o.merge(t.geometry,t.userData.transform):o.merge(t.geometry),i.push(t)}),s.forEach(e=>t.addMesh(e)),i.forEach(e=>t.removeMesh(e)),this._cacheHolder.componentCache.set(t.hash,t)}}_addRootComponent(e){this._listener&&this._listener.display(e)}removeDockingComponent(){this._getKernelAccess().requestDeleteComponent(this._configuratorContext.dockingRootComponentId),this._configuratorContext.dockingRootComponentId=null}dockComponent(e,t,s,i){let n=this._components.get(t),o=this._components.get(e);o&&(o.roomlePosition=s,o.roomleRotation=i,n&&n.add(o))}dockComponentWithPosition(e,t){let s,i=this._components.get(e.parentId);s=t?t.getKernelPosition(i):e.getKernelPosition(i);const n=Benchmark.start("dock_component_with_position_"+e.childId);this._getKernelAccess().dockComponentWithPosition(e.parentId,e.parentDockId,e.childId,e.childDockId,s),this._configuratorContext.dockingRootComponentId=null,Benchmark.end(n)}removePreviews(){this._previews.size>0&&(this._previews.forEach(e=>{e.removeFromParent(),e.removeAllMeshes()}),this._previews.clear())}_updatePlanObject(e){this._listener&&this._listener.planObjectUpdated(e)}Editor3dAddBakedMesh(e,t,s,i,n,o){this._addMeshToComponent(e,null,t,null,s,i,n,o)}Editor3dAddDockPreview(e,t){let s=this._componentFactory.createPreview(t,e);this._previews.set(t.toString(),s)}Editor3dAddNamedMesh(e,t,s,i,n,o,a,r){this._addMeshToComponent(e,t,s,i,n,o,a,r)}Editor3dBeginConstruction(e){let t=this._components.get(e);t&&t.removeAllMeshes()}Editor3dComponentCreated(e,t,s,i,n){n&&(this._configuratorContext.rootComponentId=e);let o=null;this._components.has(e)?(o=this._components.get(e)).removeAllMeshes():(o=this._componentFactory.create(e,t,s,i)).layers.set(3),this._components.set(e,o),n&&this._addRootComponent(o)}Editor3dComponentDocked(e,t,s,i){this.dockComponent(e,t,s,i)}Editor3dEndConstruction(e){let t=this._getKernelAccess().kernelInstance.getComponent(e),s=this._components.get(e);s&&(s.computeBoundingBox(t.boxForMeasurement),s.boundingBoxMesh&&this._listener&&this._listener.addComponentHandlers(s));let i=this._previews.get(e.toString());i&&i.computeBoundingBox(t.boxForMeasurement,!0)}Editor3dGeometryReady(e){this._getKernelAccess().kernelInstance.requestPlanComponentConstruction(e)}Editor3dGeometryNotReady(e){let t;this._components.has(e)&&(t=this._components.get(e)).loading()}Editor3dPlanObjectConstructionDone(e){const t=this._getKernelAccess().kernelInstance.getPlanObject(e),s=this._getKernelAccess().kernelInstance.getFullPartList(),i=this._getKernelAccess().kernelInstance.getHashOfConfiguration(e),n=this._getKernelAccess().kernelInstance.getComponentId(t.rootPlanComponentId),o=[t,s.fullList,i,n];AsyncHelper.finishOperation(2,o),this._updatePlanObject(t),this._listener&&this._listener.planObjectConstructionDone(t)}Editor3dPreviewConstructionDone(e,t){let s=!1;this._previews.forEach(e=>{null!==e.parent&&(this._listener&&(this._componentFactory.isPreviewLine(e)?this._listener.addPreviewLineHandlers(e):this._listener.addPreviewHandlers(e)),s=!0)}),this._listener&&this._listener.previewConstructionDone(this._components.get(e),s)}Editor3dSetPreviewLineAssociations(e,t){let s=this._previews.get(t.toString());if(s.clear(),!s)return;let i=this._componentFactory.createPreviewLine(s),n=this._components.get(this._configuratorContext.rootComponentId);for(let t=0;t<e.length;t++){let s;(s=0===t?i:i.clonePreviewLine(t)).name="Preview Line",s.parentDockId=e[t].parentDockId,s.parentId=e[t].parentId,s.childDockId=e[t].childDockId,s.childId=e[t].childId,s.docklineRotation=convertToEuler(e[t].rotation),s.roomlePosition=e[t].position,e[t].lineFrom.x>e[t].lineTo.x||e[t].lineFrom.y>e[t].lineTo.y||e[t].lineFrom.z>e[t].lineTo.z?(s.roomleLineFrom=e[t].lineTo,s.roomleLineTo=e[t].lineFrom):(s.roomleLineFrom=e[t].lineFrom,s.roomleLineTo=e[t].lineTo),e[t].positionFrom.x>e[t].positionTo.x||e[t].positionFrom.y>e[t].positionTo.y||e[t].positionFrom.z>e[t].positionTo.z?(s.roomlePositionFrom=e[t].positionTo,s.roomlePositionTo=e[t].positionFrom):(s.roomlePositionFrom=e[t].positionFrom,s.roomlePositionTo=e[t].positionTo),n.add(s),s.preparePreview(),this._previews.set(s.stringId,s)}}Editor3dSetPreviewPointAssociations(e,t){let s=this._previews.get(t.toString());if(!s)return;let i=this._components.get(this._configuratorContext.rootComponentId);for(let t=0;t<e.length;t++){let n;0===t?n=s:(n=s.clonePreview(t),this._previews.set(n.stringId,n)),n.name="Preview Point",n.parentDockId=e[t].parentDockId,n.parentId=e[t].parentId,n.childDockId=e[t].childDockId,n.childId=e[t].childId,n.preparePreview(),n.receivedPointAssociation=!0,i.add(n),n.roomlePosition=e[t].position,n.roomleRotation=e[t].rotation}}componentDeleted(e){const t=this._components.get(e);t&&(this._listener&&this._listener.componentDeleted(t),t.removeFromParent(),t.removeAllMeshes(),this._components.delete(e))}componentMetaUpdated(e){let t=this._components.get(e.id);(t||(t=this._previews.get(e.id.toString())))&&(t.hash=e.hash,t.roomlePosition=e.position,t.roomleRotation=e.rotation,e.boxForMeasurement&&t.computeBoundingBox(e.boxForMeasurement),this._listener&&this._listener.componentUpdated(t,e))}configurationLoaded(e,t,s,i,n){e===DOCKING_CONVERSATION_ID&&(this._configuratorContext.dockingRootComponentId=s);let o=0===t;o?this._getKernelAccess().kernelInstance.requestPlanComponentConstructionRecursive(s):this._getKernelAccess().kernelInstance.requestPlanObjectConstruction(t);let a=this._getKernelAccess().kernelInstance.getComponent(s),r=this._components.get(s);r&&(r.computeBoundingBox(a.boxForMeasurement),r.hash=a.hash),this._listener&&this._listener.configurationLoaded(r,o&&void 0!==r.boundingBoxMesh)}finishParameterChange(e,t){Promise.all(this.waitingForMaterials).then(e,t)}planObjectConfigurationUpdated(e,t,s){let i=this._getKernelAccess().kernelInstance.getPlanObject(e);this._updatePlanObject(i)}planObjectCreated(e,t){this._configuratorContext.planObjectId=t,this._listener&&this._listener.clearScene(),this.waitingForMaterials.push(AsyncHelper.waitFor(2))}planObjectUpdated(e){this._updatePlanObject(e)}sceneCleared(){this._components.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._components.clear(),this._previews.forEach(e=>{e.removeFromParent(),e.removeAllMeshes()}),this._previews.clear()}setListener(e){this._listener=e}getBoundingBox(){const e=this._components.get(this._configuratorContext.rootComponentId);return e?(new THREE.Box3).setFromObject(e):null}hasPreviews(){return this._previews.size>0}clearRootComponent(){this._components.get(this._configuratorContext.rootComponentId).clear(!0)}debugSceneGraph(e){e?this._components.has(e)?this._components.get(e):this._previews.has(e.toString())&&this._previews.get(e.toString()):this._configuratorContext}getComponentsForIds(e){let t=[];return e.forEach(e=>{const s=this._components.get(e);s&&t.push(s)}),t}isPreviewLine(e){return this._componentFactory.isPreviewLine(e)}isPreview(e){return this._componentFactory.isPreview(e)}setGeometriesMergedListener(e){this._geometriesMerged=e}removeGeometriesMergedListener(){this._geometriesMerged=void 0}setMergeThreshold(e){this._mergeThreshold=e}_generateMesh(e=0,t=null,s,i,n,o,a,r,h){return this._configuratorMeshGenerator.generateMesh(e,t,s,i,n,o,a)}_setMaterial(e,t,s){this._configuratorMeshGenerator.setMaterial(e,t)}constructComponents(e){this._getKernelAccess().kernelInstance.requestPlanObjectConstruction(e)}}__decorate([inject],ConfiguratorViewModel.prototype,"_configuratorMeshGenerator",void 0),__decorate([inject],ConfiguratorViewModel.prototype,"_configuratorContext",void 0),__decorate([inject],ConfiguratorViewModel.prototype,"_cacheHolder",void 0);class OccurrenceMap extends Map{largestValue(){let e=this.entries().next().value[0],t=0;return this.forEach((s,i)=>{s>t&&(e=i,t=s)}),e}}const INJECTABLES=[new DependencyInjectionAssignment("error-handler",class{constructor(){this._listeners={}}_subscribe(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}subscribe(e,t){this._subscribe(e,t)}dispatch(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++){const i=s[e];i.apply(i,t)}}unsubscribe(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++)if(s[e]===t)return s.splice(e,1),i--,void e--}softReject(e,t,s){return this.dispatch(s,[t]),e()}}),new DependencyInjectionAssignment("form-data-util",FormDataUtil),new DependencyInjectionAssignment("environment-loader",EnvironmentLoader),new DependencyInjectionAssignment("static-item-loader",StaticItemLoader,0),new DependencyInjectionAssignment("form-data-util",FormDataUtil),new DependencyInjectionAssignment("single-promise-factory",class{constructor(e){this._promises=new Map,this._creator_=e}create(e,t,s){return new Promise((i,n)=>{let o=this._promises.get(e),a=!0;if(!o){const t=new Map;this._promises.set(e,t),o=this._promises.get(e),a=!1}o.get(t)||(o.set(t,[]),a=!1);const r=o.get(t);r.push({resolve:i,reject:n}),o.set(t,r);const h=()=>{o.delete(t),0===o.size&&this._promises.delete(e)};a||new Promise(s).then(e=>{o.get(t).forEach(({resolve:t})=>t(e)),h()},e=>{o.get(t).forEach(({reject:t})=>t(e)),h()})})}},1),new DependencyInjectionAssignment("dynamic-light-setting-loader",DynamicLightSettingLoader),new DependencyInjectionAssignment("dynamic-quality-setting-loader",DynamicQualitySettingLoader),new DependencyInjectionAssignment("network-layer",NetworkLayer),new DependencyInjectionAssignment("local-storage",class{constructor(e){this._context_=e}get _localStorage(){let e=null;try{e=window.localStorage}catch(e){console.error(e)}return e}getItem(e){if(!this._localStorage)return null;const t=this._localStorage.getItem(e);try{return JSON.parse(t)}catch(e){return t}}setItem(e,t){if(this._localStorage)try{const s=JSON.stringify(t);this._localStorage.setItem(e,s)}catch(e){console.error(e)}}}),new DependencyInjectionAssignment("network-layer",NetworkLayer),new DependencyInjectionAssignment("kernel-io",class extends Logger{throw(e){this.error("[Kernel Exception]: "+e)}}),new DependencyInjectionAssignment("data-syncer",DataSyncer),new DependencyInjectionAssignment("memory-manager",class{constructor(){this._configurationStringSet=new Set,this._singleLoadCounter=0}loadingConfigurationString(){this._singleLoadCounter+=1}loadingConfiguration(e){this._configurationStringSet.add(e),this._singleLoadCounter+=1}shouldHardReset(){return this._configurationStringSet.size>=15||this._singleLoadCounter>=30}executedHardReset(){this._configurationStringSet.clear(),this._singleLoadCounter=0}}),new DependencyInjectionAssignment("life-cycle-manager",class{constructor(){this._listeners=[]}addEventListener(e){this._listeners.push(e)}removeEventListener(e){const t=this._listeners;let s=t.length;if(s)for(let i=0;i<s;i++)t[i]===e&&(t.splice(i,1),i--,s--)}pause(){this._listeners.forEach(e=>e.pause())}resume(){this._listeners.forEach(e=>e.resume())}destroy(){this._listeners.forEach(e=>e.destroy())}},1),new DependencyInjectionAssignment("three-loader",ThreeLoader),new DependencyInjectionAssignment("local-storage-helper",LocalStorageHelper),new DependencyInjectionAssignment("cache-holder",class{constructor(){this._componentCache=new Map,this._geometryCache=new Map,this._materialCache=new Map}get componentCache(){return this._componentCache}get geometryCache(){return this._geometryCache}get materialCache(){return this._materialCache}clear(){for(const e of this._componentCache.values())disposeObject(e);for(const e of this._materialCache.values())disposeMaterial(e);for(const e of this._geometryCache.values())disposeGeometry(e);this._componentCache.clear(),this._geometryCache.clear(),this._materialCache.clear()}},0),new DependencyInjectionAssignment("kernel-access-callback",class{constructor(e){this._callbackListener=new Set,this._creator_=e}addListener(e){this._callbackListener.add(e)}removeListener(e){this._callbackListener.delete(e)}isReady(){this._callbackListener.forEach(e=>e.isReady())}loadError(e){this._callbackListener.forEach(t=>t.loadError(e))}},1),new DependencyInjectionAssignment("configurator-kernel-access-callback",class{constructor(e){this._callbackListener=new Set,this._creator_=e}addListener(e){this._callbackListener.add(e)}removeListener(e){this._callbackListener.delete(e)}isReady(){this._callbackListener.forEach(e=>e.isReady())}updatePossibleChildren(e,t,s){this._callbackListener.forEach(i=>i.updatePossibleChildren(e,t,s))}updateParameters(e,t,s,i){this._callbackListener.forEach(n=>n.updateParameters(e,t,s,i))}loadError(e){this._callbackListener.forEach(t=>t.loadError(e))}},1),new DependencyInjectionAssignment("configurator-view-model",ConfiguratorViewModel,1),new DependencyInjectionAssignment("configurator-context",class{constructor(){this.rootComponentParametersAsGlobal=!1,this.lastLoadedRapiId=null,this.selectedRuntimeComponentIds=[],this.selectionMode="standard"}get selectedRuntimeComponentId(){return this.selectedRuntimeComponentIds.length>0?this.selectedRuntimeComponentIds[0]:null}},1)];class RoomleDependencyInjection{static setup(e){RoomleDependencyInjection.addToContainer(e)}static lookup(e,t){return window.__RML__DI__?window.__RML__DI__.lookup(e,t):null}static getContext(e){return window.__RML__DI__?window.__RML__DI__.getContext(e):null}static cleanUp(e){return window.__RML__DI__?window.__RML__DI__.cleanUp(e):null}static addToContainer(e){window.__RML__DI__||(window.__RML__DI__=new Container,window.__RML__DI__.addDependencyInjectionAssignments(INJECTABLES)),window.__RML__DI__.addDependencyInjectionAssignments(e)}}class Main{constructor(e){this._context=e}_setupCommonGlobals(){window.__RML__DEBUG__||(window.__RML__DEBUG__={}),window.__RML__ENV__||(window.__RML__ENV__={},window.__RML__ENV__.assetPath||(window.__RML__ENV__.assetPath=""));const e={retina:!1,overrideCountry:null,locale:AppContext.actualLocale,unit:null,unitStringType:null,dls:null,ls:null,meshSelection:!0,colors:ROOMLE_COLORS,enableHSC:!1,mode:"3D",edit:!1,stats:!1,_measureTraffic:!1,enableHD:!0,debug:!1,gammaOutput:!0};window.__RML__ENV__.initData?window.__RML__ENV__.initData=Object.assign(e,window.__RML__ENV__.initData):window.__RML__ENV__.initData=e;const t=getAllParameters();window.__RML__ENV__.initData=Object.assign(window.__RML__ENV__.initData,t)}_setupCommonDependencies(){}_cleanUpCommonGlobals(){window.__RML__DEBUG__&&(window.__RML__DEBUG__.Kernel&&window.__RML__DEBUG__.Kernel.clearAll&&window.__RML__DEBUG__.Kernel.clearAll(),delete window.__RML__DEBUG__),delete window.__RML__ENV__;for(const e in window.THREE)if(window.THREE.hasOwnProperty(e))try{delete window.THREE[e]}catch(e){console.error(e)}window.THREE=void 0}_cleanUpCommonDependencies(){}boot(e){this._setupCommonGlobals(),this.setupGlobals(e),this._setupCommonDependencies(),this.setupDependencies(),this.bootFinished()}lookup(e,t){return window.__RML__DI__.lookup(e,t)}teardown(){this.cleanUpDependencies(),this._cleanUpCommonDependencies(),this.cleanUpGlobals(),this._cleanUpCommonGlobals(),window.__RML__DI__&&delete window.__RML__DI__}pause(){this.lookup("life-cycle-manager",this._context).pause(),window.TWEEN&&TWEEN.removeAll()}resume(e){e&&this.lookup("dom-helper",this._context).setDomElement(e),this.lookup("life-cycle-manager",this._context).resume()}destroy(){this.pause(),this.lookup("life-cycle-manager",this._context).destroy(),RoomleDependencyInjection.cleanUp(this._context)}getRapiAccess(){return this.lookup("rapi-access",this._context)}}const CANVAS_ID={HSC:"rml-hsc",HSP:"rml-hsp",GLB:"rml-glb",RMV:"rml-mv"},CONTAINER_CSS_CLASS="rml-threejs-canvas-container";class DomHelper{constructor(e){this._creator_=e,this._lifeCycleManager.addEventListener(this)}get element(){return this._container}setDomElement(e){if(!this._container){this._container=document.createElement("div"),this._container.classList.add(CONTAINER_CSS_CLASS),this._container.setAttribute("ondragover","return false"),this._container.style.position="relative",this._container.style.width="100%",this._container.style.height="100%";const t=document.createElement("style");t.innerText="."+CONTAINER_CSS_CLASS+" canvas{position:absolute;top:0;left:0;right:0;bottom:0;}."+CONTAINER_CSS_CLASS+" .foreground{z-index:100; opacity:1;}."+CONTAINER_CSS_CLASS+" .background{z-index:-1; opacity:0;}",this._container.appendChild(t),e.appendChild(this._container)}this._element=e}getClientDimensions(){return new THREE.Vector2(this._element.clientWidth,this._element.clientHeight)}_removeDomElement(e){if(!e)return;const t=e.parentElement;t&&t.removeChild(e)}reset(){this._element=null,this._removeDomElement(this._container),this._container=null}pause(){this.reset()}resume(){}destroy(){}}__decorate([inject],DomHelper.prototype,"_lifeCycleManager",void 0);class EventDispatcher{constructor(){this._listeners={}}_addEventListener(e,t,s){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push({callback:t,scope:s})}addEventListener(e,t,s){this._addEventListener(e,t,s)}dispatchEvent(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++){const i=s[e];i.callback.apply(i.scope,[t])}}removeEventListener(e,t){const s=this._listeners[e];if(s)for(let e=0,i=s.length;e<i;e++)if(s[e].callback===t)return void s.splice(e,1)}}const INITIAL_CAMERA_DISTANCE=-1;class CameraControl extends EventDispatcher{constructor(e,t,s){super(),this._tweenEnd=null,this._pitch=toRadiant(10),this._yaw=toRadiant(-15),this._distance=INITIAL_CAMERA_DISTANCE,this._locked=!1,this._inputListeners=[],this._creator_=e,this._inputManager=t,this._initInputListener(),this._addInputListeners(),this._cameraPosition=new THREE.Vector3,this._targetPosition=new THREE.Vector3,s?this._cameraPosition.copy(s):this._cameraPosition=new THREE.Vector3(0,.5,3);let i=this._domHelper.getClientDimensions();this._width=i.x,this._height=i.y}getCamera(){return this._getCamera()}_addInputListeners(){this._inputListeners.forEach(e=>{this._inputManager.addEventListener(e.key,e.fun,this)})}_removeInputListeners(){this._inputListeners.forEach(e=>{this._inputManager.removeEventListener(e.key,e.fun)}),this._inputListeners=[]}cleanUp(){this._removeInputListeners()}animateCamera(e){let t=this._cameraPosition;if(!t||position3VectorsAreEqual(t,this.getCamera().position))return!1;let s=this.getCamera().position.clone(),i=Math.min(10*e,1);return s.lerp(t,i),this.getCamera().position.copy(s),!0}_areEqual(e,t){return e.yaw.toFixed(5)===t.yaw.toFixed(5)&&e.pitch.toFixed(5)===t.pitch.toFixed(5)&&e.distance.toFixed(5)===t.distance.toFixed(5)&&e.targetX===t.targetX&&e.targetY===t.targetY&&e.targetZ===t.targetZ}_tweenCameraParameter(e,t,s){return new Promise(s=>{if(t.yaw-e.yaw<=-Math.PI?e.yaw-=2*Math.PI:t.yaw-e.yaw>=Math.PI&&(e.yaw+=2*Math.PI),window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=t,new TWEEN.Tween(e).to(t,400).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._update(new THREE.Vector3(e.targetX,e.targetY,e.targetZ))}).onComplete(()=>{this._tweenEnd=null,s()}).start()}})}_getCurrentCameraParameters(){let e=this._targetPosition.clone();return{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:e.x,targetY:e.y,targetZ:e.z}}_rotateHorizontal(e){this._yaw-=e,this._yaw<-Math.PI?this._yaw+=2*Math.PI:this._yaw>Math.PI&&(this._yaw-=2*Math.PI)}_rotateVertical(e){this._pitch+=e,this._pitch<-Math.PI?this._pitch+=2*Math.PI:this._pitch>Math.PI&&(this._pitch-=2*Math.PI)}saveState(e){if(e||!this._stateSaved){let e=this._yaw,t=this._pitch,s=this._distance,i=this._targetPosition.clone();if(this._stateSaved={yaw:e,pitch:t,distance:s,targetX:i.x,targetY:i.y,targetZ:i.z,blockOtherTweens:!0},this._getCamera().fov){let e=this._getCamera();this._stateSaved.fov=e.fov,this._stateSaved.near=e.near,this._stateSaved.far=e.far}return this._stateSaved}return null}resetToState(){if(this._stateSaved){this._stateSaved.blockOtherTweens=!1;let e=this._targetPosition.clone();this._tweenCameraParameter({yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:e.x,targetY:e.y,targetZ:e.z},this._stateSaved,!0)}this._stateSaved=null}setToState(e,t){this._tweenCameraParameter(e,t,!0)}hasSavedState(){return null!=this._stateSaved}lock(){this._locked=!0}unlock(){this._locked=!1}getTargetPosition(){return this._targetPosition}_saveYawAndPitch(){this._getCamera().userData.yaw=this._yaw,this._getCamera().userData.pitch=this._pitch}getInputPosition(e){const{x:t,y:s}=this._domHelper.getClientDimensions();return new THREE.Vector3(e.x/t*2-1,-e.y/s*2+1,.5)}addLightContainer(e){e.name="lights";const t=this._getCamera(),s=t.children.find(e=>"lights"===e.name);s&&t.remove(s),t.add(e)}}__decorate([inject],CameraControl.prototype,"_domHelper",void 0);class ZoomChangeEvent{constructor(e,t){this.minZoom=!1,this.maxZoom=!1,this.minZoom=e,this.maxZoom=t}}const ROTATION_SPEED=1,ZOOM_SPEED=4,MAX_DISTANCE_MINIMAL=4,DISTANCE_FACTOR=2.725,MAX_POLAR_ANGLE=85;class CameraControl3D extends CameraControl{constructor(e,t,s,i){super(e,t,s),this._bounds=new THREE.Vector3,this._scale=1,this._state=0,this._zoomSpeed=Math.pow(.95,ZOOM_SPEED),this.minDistance=0,this.maxDistance=5,this.minPolarAngle=toRadiant(0),this.maxPolarAngle=toRadiant(MAX_POLAR_ANGLE),this.minAzimuthAngle=Number.NEGATIVE_INFINITY,this.maxAzimuthAngle=Number.POSITIVE_INFINITY,this._currentZoomHash="",i?this._camera=i:this._initCamera(),this._targetPosition=new THREE.Vector3(0,0,0);let{cameraRestriction:n,minVerticalCameraAngle:o,maxVerticalCameraAngle:a,minHorizontalCameraAngle:r,maxHorizontalCameraAngle:h}=window.__RML__ENV__.initData;if(void 0!==o&&(this.minPolarAngle=toRadiant(o<0?o:-1*o)),void 0!==a&&(this.maxPolarAngle=toRadiant(a)),void 0!==r&&(this.minAzimuthAngle=toRadiant(r<0?r:-1*r)),void 0!==h&&(this.maxAzimuthAngle=toRadiant(h)),void 0!==n){let e=Math.abs(toRadiant(n));this.minAzimuthAngle=-e,this.maxAzimuthAngle=e,this.maxPolarAngle=Math.min(e,toRadiant(MAX_POLAR_ANGLE))}}_getCamera(){return this._camera?this._camera:(this._initCamera(),this._camera)}_initCamera(){this._camera=new THREE.PerspectiveCamera,this._camera.fov=30,this._camera.aspect=this._width/this._height,this._camera.near=.1,this._camera.far=100,this._camera.updateProjectionMatrix(),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();this._camera.aspect=e/t,this._camera.updateProjectionMatrix()}animateCamera(e){if(!super.animateCamera(e))return!1;let t=this._targetPosition;return!!t&&(this.getCamera().lookAt(t),!0)}_initInputListener(){this._inputListeners.push({key:3,fun:e=>{this._state=1}}),this._inputListeners.push({key:6,fun:e=>{1!==this._state||this._locked||this._move(new THREE.Vector2(e.position.x,e.position.y),e.type)}}),this._inputListeners.push({key:4,fun:e=>{1===this._state&&this.dispatchEvent(2,e.type),this._state=0,this._orbitPosition=null}}),this._inputListeners.push({key:7,fun:e=>this.zoomIn()}),this._inputListeners.push({key:8,fun:e=>this.zoomOut()})}_move(e,t){this._orbitPosition||(this._orbitPosition=new THREE.Vector2(e.x,e.y),this.dispatchEvent(0,t));let s=e.clone().sub(this._orbitPosition),i=this._domHelper.element;this._rotateHorizontal(2*Math.PI*s.x/i.clientWidth*ROTATION_SPEED),this._rotateVertical(2*Math.PI*s.y/i.clientHeight*ROTATION_SPEED),position2VectorsAreEqual(this._orbitPosition,e)||this.dispatchEvent(1,t),this._orbitPosition.copy(e),this._update()}setBounds(e){let t=new THREE.Vector3(-e.x/2,0,-e.z/2),s=new THREE.Vector3(e.x/2,e.y,e.z/2);this._boundingBox=new THREE.Box3(t,s)}updateToBounds(e,t,s,i,n=!0,o){this._boundingBox=e;let a=e.getSize(new THREE.Vector3);const r=e.getCenter(new THREE.Vector3);this._targetPosition=o?o.clone():new THREE.Vector3(r.x,r.y,r.z);const h=this._setDistanceAndRangesBasedOnBounds(a,t,s);this._distance===INITIAL_CAMERA_DISTANCE?(this._distance=Math.max(MAX_DISTANCE_MINIMAL,h),this._update()):n&&this._tweenCameraParameter(this._getCurrentCameraParameters(),{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:this._targetPosition.x,targetY:this._targetPosition.y,targetZ:this._targetPosition.z},i)}_setDistanceAndRangesBasedOnBounds(e,t,s){this._bounds.copy(e),this.minDistance=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);let i=1.1*getIdealDistance(e.x,e.y,e.z,this._camera.fov,t,s);return this._distance<i&&(this._distance=i),this.maxDistance=1.5*i,this.maxDistance=Math.min(this.maxDistance,i+6),this.maxDistance<MAX_DISTANCE_MINIMAL&&(this.maxDistance=MAX_DISTANCE_MINIMAL),this._camera.far=5*this.maxDistance,i}reset(e,t,s,i,n,o,a=!0){if(e){i?this._targetPosition.copy(i):this._targetPosition=new THREE.Vector3(0,e.y/2,0);let r=this._getCurrentCameraParameters();n||(n=-15),o||(o=10),this._pitch=toRadiant(o),this._yaw=toRadiant(n),this._setDistanceAndRangesBasedOnBounds(e,t,s);let h=this._targetPosition.clone();this._areEqual(r,{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:h.x,targetY:h.y,targetZ:h.z})?this._moveCameraForthAndBack():a?this._tweenCameraParameter(r,{yaw:this._yaw,pitch:this._pitch,distance:this.maxDistance,targetX:h.x,targetY:h.y,targetZ:h.z},!0):this._update(this._targetPosition)}else console.warn("you cant reset without bounds!")}updateAndReset(e,t,s,i,n,o,a,r=!0){let h=new THREE.Vector3(-e.x/2,0,-e.z/2),l=new THREE.Vector3(e.x/2,e.y,e.z/2);if(this._boundingBox=new THREE.Box3(h,l),a&&e.addScalar(a),i?this._targetPosition.copy(i):this._targetPosition=new THREE.Vector3(0,e.y/2,0),this._distance===INITIAL_CAMERA_DISTANCE){let i=this._setDistanceAndRangesBasedOnBounds(e,t,s);this._distance=Math.max(MAX_DISTANCE_MINIMAL,i)}let c=this._getCurrentCameraParameters();n||(n=-15),o||(o=10),this._pitch=toRadiant(o),this._yaw=toRadiant(n),this._setDistanceAndRangesBasedOnBounds(e,t,s);let d=this._targetPosition.clone();r?this._tweenCameraParameter(c,{yaw:this._yaw,pitch:this._pitch,distance:this.maxDistance,targetX:d.x,targetY:d.y,targetZ:d.z},!0):this._update(this._targetPosition)}_moveCameraForthAndBack(){if(window.TWEEN){let e={value:.6*this._camera.far},t={value:this._distance};new TWEEN.Tween(e).to(t,300).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{this._distance=e.value,this._update()}).start()}}_restoreFromState(e){this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._targetPosition.copy(new THREE.Vector3(e.targetX,e.targetY,e.targetZ)),this._simulateUpdate()}simulateTo2D(e,t){return new Promise(s=>{let i=Math.max(e.x,e.z),n=getIdealDistance(i,i,i,this._camera.fov,window.innerWidth,window.innerHeight),o=this._getCurrentCameraParameters();this._camera.near=1,this._camera.far=n+50,this._camera.updateProjectionMatrix();let a={yaw:0,pitch:toRadiant(90),distance:n,targetX:t.x,targetY:n,targetZ:t.z};if(window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=a,new TWEEN.Tween(o).to(a,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(()=>{this._yaw=o.yaw,this._pitch=o.pitch,this._distance=o.distance,this._targetPosition.copy(new THREE.Vector3(o.targetX,0,o.targetZ)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,s()}).start()}})}simulateTo3D(e,t){return new Promise(s=>{if(this._restoreFromState(e),window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=t,new TWEEN.Tween(e).to(t,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._targetPosition.copy(new THREE.Vector3(e.targetX,e.targetY,e.targetZ)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,s()}).start()}})}simulateToFirstPerson(e){return new Promise(t=>{if(window.TWEEN){let s=this.getCamera().position,i={x:s.x,y:s.y,z:s.z,yaw:this._yaw,pitch:this._pitch},n={x:e.x,y:e.y,z:e.z,yaw:0,pitch:0};new TWEEN.Tween(i).to(n,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{this._yaw=i.yaw,this._pitch=i.pitch,this._targetPosition.copy(new THREE.Vector3(i.x,i.y,i.z)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,t()}).start()}})}_update(e){this._yaw=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,this._yaw)),this._pitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._pitch)),this._saveYawAndPitch();let t=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX"),s=(new THREE.Quaternion).setFromEuler(t),i=new THREE.Vector3(0,0,-1);i.applyQuaternion(s),this._distance*=this._scale,this._distance=Math.min(this.maxDistance,this._distance),e&&this._targetPosition.copy(e);let n=this._targetPosition.clone().sub(i.multiplyScalar(this._distance)),o=this._getCameraSphere(n);null!=this._boundingBox&&this._boundingBox.intersectsSphere(o)&&this._scale>=1?this._distance+=.1:null==this._boundingBox||this._boundingBox.intersectsSphere(o)?this._zoomChanged(!1,!0):(this._cameraPosition.copy(n),this._distance===this.maxDistance?this._zoomChanged(!0,!1):this._zoomChanged(!1,!1)),this._scale=1}_zoomChanged(e,t){let s=e+""+t;0!==this._currentZoomHash.length&&this._currentZoomHash===s||(this.dispatchEvent(5,new ZoomChangeEvent(e,t)),this._currentZoomHash=s)}_simulateUpdate(){let e=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX"),t=(new THREE.Quaternion).setFromEuler(e),s=new THREE.Vector3(0,0,-1);s.applyQuaternion(t),this._cameraPosition.copy(this._targetPosition.clone().sub(s.multiplyScalar(this._distance)))}zoomTo(e,t,s,i,n,o){return this._tweenCameraParameter(this._getCurrentCameraParameters(),{yaw:i,pitch:n,distance:getIdealDistance(e.x,e.y,e.z,this._camera.fov,t,s)*DISTANCE_FACTOR,targetX:o.x,targetY:o.y,targetZ:o.z,blockOtherTweens:!0},!0)}_getCameraSphere(e){return new THREE.Sphere(e,.1)}zoomIn(e){this._scale*=e?Math.pow(.95,e):this._zoomSpeed,this._update(),this.dispatchEvent(3)}zoomOut(e){this._scale/=e?Math.pow(.95,e):this._zoomSpeed,this._update(),this.dispatchEvent(4)}}let _scriptCache={},_idCache={};class ScriptLoader{constructor(e){this._creator_=e}fetch(e,t){return this._singlePromiseFactory.create(5,e,(s,i)=>{!function(e,t,s,i){if(-1===e.indexOf("http")&&(e=getAssetPath()+e),_scriptCache[e])return s();if(t.id&&_idCache[t.id])return i(new Error('There is already a script with ID "'+t.id+'"'));const n=Benchmark.start("load_"+t.id.replace(/-/g,"_")),o=document.createElement("script");o.async=!1,o.src=e,o.id=t.id,o.onload=(()=>{_scriptCache[e]=!0,_idCache[t.id]=!0,Benchmark.end(n),Object.defineProperty(s,"name",{value:"resolve-"+t.id}),s()}),o.onerror=(e=>{i(e)}),document.body.appendChild(o)}(e,t,s,i)})}cleanUp(){for(let e in _idCache)if(_idCache.hasOwnProperty(e)){const t=document.getElementById(e);t&&t.parentElement.removeChild(t)}_scriptCache={},_idCache={}}}__decorate([inject],ScriptLoader.prototype,"_singlePromiseFactory",void 0);const BROWSER_EVENTS={MOUSE_MOVE:"mousemove",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",MOUSE_LEAVE:"mouseleave",MOUSE_ENTER:"mouseenter",MOUSE_WHEEL:"wheel",TOUCH_MOVE:"touchmove",TOUCH_START:"touchstart",TOUCH_END:"touchend",CONTEXT_MENU:"contextmenu"};class InputEvent{constructor(e,t,s,i){this.position=e,this.positionRelative=t,this.type=s,this.rotation=i}}const MIN_MOVE_DISTANCE=5*window.devicePixelRatio,MIN_DOLLY_DISTANCE=2*window.devicePixelRatio;class InputManager extends EventDispatcher{constructor(e){super(),this._debug=!1,this._elementHit=!1,this._delta=-1,this._state=0,this._pinchDistance=-1,this._rotationAngle=-1,this._lastMouseWheelEvent=null,this._lastTouchEvent=null,this._events=Object.keys(BROWSER_EVENTS).map(e=>BROWSER_EVENTS[e]),this._creator_=e,this._position={x:0,y:0},this._positionRelative={x:0,y:0},this._downPosition={x:0,y:0},this._downPositionRelative={x:0,y:0}}enableDragIn(e){this._state=1,this._dragEnabled=!0,e&&(this._dragMV=this._dragM.bind(this),this._dragEV=this._dragE.bind(this),this._dragTarget=e.currentTarget||e.target,this._delta=-1,this._dragMVName="drag",this._dragEVName="dragend",window.TouchEvent&&e instanceof TouchEvent?(this._dragMVName="touchmove",this._dragEVName="touchend"):e.dataTransfer&&e.dataTransfer.setData&&e.dataTransfer.setData("text/plain"," "),this._firefoxDragPosition={x:0,y:0},document.ondragover=(e=>{e=e||window.event,this._firefoxDragPosition.x=e.pageX,this._firefoxDragPosition.y=e.pageY}),this._dragTarget.addEventListener(this._dragMVName,this._dragMV,!1),this._dragTarget.addEventListener(this._dragEVName,this._dragEV,!1))}_dragM(e){let t=e,s=null,i=null;window.TouchEvent&&e instanceof TouchEvent?(s=this._getTouchPosition(t),i=this._getTouchPositionRelative(t)):(s=this._getMousePosition(t),i=this._getMousePositionRelative(t)),s.x>0&&s.y>0&&this._move(s,i)}_dragE(e){let t=e;document.ondragover=null,this._firefoxDragPosition=null,this._dragTarget.removeEventListener(this._dragMVName,this._dragMV),this._dragTarget.removeEventListener(this._dragEVName,this._dragEV),window.TouchEvent&&e instanceof TouchEvent?this._onUp(this._getTouchPosition(t),this._getTouchPositionRelative(t),2):this._onUp(this._getMousePosition(t),this._getMousePositionRelative(t),1)}addEvents(e){this._events.forEach(t=>e.addEventListener(t,this,!1))}removeEvents(e){this._events.forEach(t=>e.removeEventListener(t,this,!1))}_dolly(e){if(this._lastTouchEvent&&e.timeStamp-this._lastTouchEvent.timeStamp<40)return;let t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY,i=Math.abs(t)+Math.abs(s);this._pinchDistance>-1&&(i>this._pinchDistance+MIN_DOLLY_DISTANCE&&this.dispatchEvent(7,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e))),i<this._pinchDistance-MIN_DOLLY_DISTANCE&&this.dispatchEvent(8,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e)))),this._pinchDistance=i,this._lastTouchEvent=e}_move(e,t,s){void 0===s&&(s=0),void 0===this._dragEnabled&&(this._dragEnabled=!1),1===this._state&&this._canDrag(s)&&(this._delta=this._getDelta(),this._delta>MIN_MOVE_DISTANCE&&(this._state=2,this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(0,new InputEvent(e,t)))),2===this._state&&this.dispatchEvent(1,new InputEvent(e,t)),this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(6,new InputEvent(e,t,s))}_longClick(){this._state=2,this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(0,new InputEvent(this._downPosition,this._downPositionRelative)),this.dispatchEvent(1,new InputEvent(this._downPosition,this._downPositionRelative))}_onUp(e,t,s){this.dispatchEvent(4,new InputEvent(e,t,s)),this._getDelta()<=MIN_MOVE_DISTANCE&&this.dispatchEvent(5,new InputEvent(e,t)),2===this._state&&this.dispatchEvent(2,new InputEvent(e,t)),4===this._state&&(this.dispatchEvent(10,new InputEvent(e,t)),this._rotationAngle=-1),3===this._state&&(this._pinchDistance=-1),this._lastTouchEvent=null,this._state=0,this._dragTarget=null,this._elementHit=!1,this._longClickTimer&&clearTimeout(this._longClickTimer)}_getTouchPosition(e){if(e.changedTouches.length){let{clientX:t,clientY:s}=e.changedTouches[0];if(e.changedTouches.length>1){const i=e.changedTouches[1].clientX,n=e.changedTouches[1].clientY;t=(t+i)/2,s=(s+n)/2}this._position.x=t,this._position.y=s}return this._position}_getTouchPositionRelative(e){if(e.changedTouches.length){let t=this._domHelper.element.getBoundingClientRect(),{clientX:s,clientY:i}=e.changedTouches[0];this._positionRelative.x=(s-t.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(i-t.top)/this._domHelper.element.clientHeight*2+1}return this._positionRelative}_getMousePosition(e){if(0!==e.clientX&&0!==e.clientY)this._position.x=e.clientX,this._position.y=e.clientY;else{let{x:t,y:s}=this._getFireFoxMousePosition(e);this._position.x=t,this._position.y=s}return this._position}_getFireFoxMousePosition(e){let{x:t,y:s}=this._domHelper.getClientDimensions();return{x:t-(t+e.offsetX),y:s-(s+e.offsetY)}}_getMousePositionRelative(e){if(0!==e.clientX&&0!==e.clientY){let t=this._domHelper.element.getBoundingClientRect();this._positionRelative.x=(e.clientX-t.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(e.clientY-t.top)/this._domHelper.element.clientHeight*2+1}else if(this._firefoxDragPosition&&0!==this._firefoxDragPosition.x&&0!==this._firefoxDragPosition.y){let e=this._domHelper.element.getBoundingClientRect();this._positionRelative.x=(this._firefoxDragPosition.x-e.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(this._firefoxDragPosition.y-e.top)/this._domHelper.element.clientHeight*2+1}return this._positionRelative}_getDelta(){return Math.abs(this._downPosition.y-this._position.y)+Math.abs(this._downPosition.x-this._position.x)}setDragEnabled(e){this._dragEnabled=e}handleEvent(e){switch(this._debug&&e.type,e.type){case BROWSER_EVENTS.MOUSE_MOVE:this._onMouseMove(e);break;case BROWSER_EVENTS.MOUSE_DOWN:this._onMouseDown(e);break;case BROWSER_EVENTS.MOUSE_UP:this._onMouseUp(e);break;case BROWSER_EVENTS.MOUSE_LEAVE:this._onMouseLeave(e);break;case BROWSER_EVENTS.MOUSE_ENTER:this._onMouseEnter(e);break;case BROWSER_EVENTS.MOUSE_WHEEL:this._onMouseWheel(e);break;case BROWSER_EVENTS.TOUCH_MOVE:this._onTouchMove(e);break;case BROWSER_EVENTS.TOUCH_START:this._onTouchStart(e);break;case BROWSER_EVENTS.TOUCH_END:this._onTouchEnd(e);break;case BROWSER_EVENTS.CONTEXT_MENU:this._onContextMenu(e)}}_onMouseDown(e){e.preventDefault();let{x:t,y:s}=this._getMousePosition(e);this._downPosition={x:t,y:s},this._downPositionRelative=this._getMousePositionRelative(e),this.dispatchEvent(3,new InputEvent({x:t,y:s},this._downPositionRelative,1)),this._state=1}_onMouseUp(e){e.preventDefault(),this._onUp(this._getMousePosition(e),this._getMousePositionRelative(e),1)}_onMouseMove(e){e.preventDefault(),this._move(this._getMousePosition(e),this._getMousePositionRelative(e),1)}_onMouseLeave(e){this._delta=-1,this._onMouseUp(e)}_onMouseEnter(e){e.preventDefault()}_onMouseWheel(e){e.preventDefault(),e.stopPropagation(),this._lastMouseWheelEvent&&e.timeStamp-this._lastMouseWheelEvent.timeStamp<40||(e.deltaY<0?this.dispatchEvent(7,new InputEvent(this._getMousePosition(e),this._getMousePositionRelative(e))):this.dispatchEvent(8,new InputEvent(this._getMousePosition(e),this._getMousePositionRelative(e))),this._lastMouseWheelEvent=e)}_onTouchMove(e){if(e.preventDefault(),!this._dragTarget)if(1===e.touches.length)this._move(this._getTouchPosition(e),this._getTouchPositionRelative(e),2);else if(2===e.touches.length)if(this._elementHit||4===this._state){let t={x:e.touches[0].pageX,y:e.touches[0].pageY},s={x:e.touches[1].pageX,y:e.touches[1].pageY};const i=to360Degrees(getAngle(t,s));this._rotationAngle<0&&(this._rotationAngle=i);const n=i-this._rotationAngle;this._rotationAngle=i,this.dispatchEvent(9,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e),2,toRadiant(n))),this._state=4}else this._state=3,this._dolly(e)}_onTouchStart(e){if(e.preventDefault(),1===e.touches.length){let{x:t,y:s}=this._getTouchPosition(e);this._downPosition={x:t,y:s},this._downPositionRelative=this._getTouchPositionRelative(e),this.dispatchEvent(3,new InputEvent({x:t,y:s},this._downPositionRelative,2)),this._state=1,this._longClickTimer=window.setTimeout(this._longClick.bind(this),350)}else 2===e.touches.length&&(1!==this._state&&2!==this._state||this._onUp(this._getTouchPosition(e),this._getTouchPositionRelative(e),2),this._state=3)}_onTouchEnd(e){e.preventDefault(),this._onUp(this._getTouchPosition(e),this._getTouchPositionRelative(e),2)}_onContextMenu(e){e.preventDefault()}_canDrag(e){return this._dragEnabled}onElementHit(){this._elementHit=!0}}__decorate([inject],InputManager.prototype,"_domHelper",void 0);class LightSetting{constructor(e,t){this._scene=e,t&&t.removeFromScene()}needsBounds(){return!1}updateBounds(e){}getCameraContainer(){return this._cameraContainer||(this._cameraContainer=new THREE.Object3D),this._cameraContainer}}class DynamicLightSetting extends LightSetting{constructor(e,t){super(e,t),this._lights=[]}needsBounds(){return!0}updateBounds(e){if(this._cameraLight){const t=this._cameraLight,s=new THREE.Vector3;e.getSize(s);const i=1.5*Math.max(Math.max(s.x,s.y),s.z);this._boundingSize=i,t.shadow.camera.top=i/2,t.shadow.camera.bottom=-i/2,t.shadow.camera.left=-i/2,t.shadow.camera.right=i/2,t.shadow.camera.updateProjectionMatrix()}}loadFromJSON(e){return new Promise((t,s)=>{this._lights=this._dynamicLightSettingLoader.parse(e),this.addToScene(),t()})}loadFromObject(e){return new Promise((t,s)=>{e.lights||t(),this._lights=this._dynamicLightSettingLoader.load(e),this._lights.filter((e,t)=>{e.userData.movesWithCamera&&(this._cameraLight=e,this._lights.splice(t,1))}),this.addToScene(),t()})}loadFromURL(e){return new Promise((t,s)=>{fetch(new Request(e,{method:"GET"})).then(handleJsonResponse).then(e=>this.loadFromObject(e).then(t,s))})}addToScene(){this._lights.forEach(e=>{this._scene.add(e)}),this._cameraLight&&this._scene.add(this._cameraLight)}update(e,t){if(!this._cameraLight)return;let s=new THREE.Vector3;e.getWorldDirection(s),s.multiplyScalar(-this._boundingSize);let i=t.clone().add(s);this._cameraLight.position.copy(i)}removeFromScene(){this._lights.forEach(e=>{this._scene.remove(e)}),this._cameraLight&&this._scene.remove(this._cameraLight)}reload(){this.removeFromScene(),this.addToScene()}showGUI(){let e=getGUI();this._cameraLight&&this._addToGUI(e,this._cameraLight),this._lights.forEach(t=>{this._addToGUI(e,t)})}_addToGUI(e,t){t instanceof THREE.SpotLight&&this._addSpotLightToGUI(e,t),t instanceof THREE.AmbientLight&&this._addAmbientLightToGUI(e,t),t instanceof THREE.DirectionalLight&&this._addDirectionalLightToGUI(e,t),t instanceof THREE.RectAreaLight&&this._addRectAreaLightToGUI(e,t)}_addRectAreaLightToGUI(e,t){let s=e.addFolder(t.name),i={name:t.name,color:"#"+t.color.getHexString(),intensity:t.intensity*(t.width*t.height)};s.add(t,"visible"),s.add(i,"intensity").min(10).max(400).step(10).onChange(e=>{t.intensity=e/(t.width*t.height)}),s.add(t,"castShadow"),s.addColor(i,"color").onChange(e=>{t.color=new THREE.Color(e)}),s.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}_addSpotLightToGUI(e,t){let s=e.addFolder(t.name),i={name:t.name,color:"#"+t.color.getHexString(),angle:180*t.angle/Math.PI};s.add(t,"visible"),s.add(t,"intensity").min(0).max(5).step(.1),s.add(t,"penumbra").min(0).max(1).step(.1),s.addColor(i,"color").onChange(e=>{t.color=new THREE.Color(e)}),s.add(i,"angle").min(10).max(180).step(1).onChange(e=>{t.angle=e*Math.PI/180}),s.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}_addAmbientLightToGUI(e,t){let s={name:t.name,color:"#"+t.color.getHexString()},i=e.addFolder(t.name);i.add(t,"visible"),i.add(t,"intensity").min(0).max(5).step(.1),i.addColor(s,"color").onChange(e=>{t.color=new THREE.Color(e)})}_addDirectionalLightToGUI(e,t){let s=e.addFolder(t.name),i={name:t.name,color:"#"+t.color.getHexString()};s.add(t,"visible"),s.add(t,"intensity").min(0).max(5).step(.1),s.addColor(i,"color").onChange(e=>{t.color=new THREE.Color(e)}),s.add(t,"castShadow"),s.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}}__decorate([inject],DynamicLightSetting.prototype,"_dynamicLightSettingLoader",void 0);class Environment{constructor(e,t){this._scene=e,t&&(t.removeFromScene(),t.cleanUp())}updateCamera(e){}reload(){this.removeFromScene(),this.addToScene()}updateBounds(e){this._bounds=e}cleanUp(){this._scene=null}}class GltfEnvironment extends Environment{constructor(e,t){super(e,t),this._gltfLoaderPromise=this._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader-js"}).then(()=>{this._gltfLoader=new THREE.GLTFLoader})}needsBounds(){return!0}needsCamera(){return!0}updateBounds(e){if(super.updateBounds(e),this._backgroundMesh){let t=Math.max(e.x,e.z)/6;t=Math.max(t,1),this._backgroundMesh.scale.copy(new THREE.Vector3(t,t,t))}}updateCamera(e){if(this._backgroundMesh){let t=e.getWorldDirection(new THREE.Vector3);t.y=0,t.lengthSq()<.01&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.multiplyScalar(-1),t.normalize();let s=Math.asin(t.x);t.z<0&&(s=Math.PI-s),this._backgroundMesh.rotation.set(0,s,0)}}addToScene(){this._scene&&this._backgroundMesh&&this._scene.add(this._backgroundMesh)}removeFromScene(){this._scene&&this._backgroundMesh&&this._scene.remove(this._backgroundMesh)}loadBackground(e,t){this._backgroundMaterial=t,this._backgroundMaterial||(this._backgroundMaterial=new THREE.MeshBasicMaterial),this._gltfLoaderPromise.then(()=>{this._gltfLoader.load(e,this._onBackgroundLoaded.bind(this),e=>{},e=>{console.error(e)})})}_onBackgroundLoaded(e){this._scene&&(this._backgroundMaterial.vertexColors=THREE.VertexColors,e&&e.scene&&e.scene.children&&e.scene.children.length>0&&(e.scene.children[0].material=this._backgroundMaterial,e.scene.children[0].layers.set(2),e.scene.position.copy(new THREE.Vector3(0,0,0)),this._backgroundMesh=e.scene,this._backgroundMesh.layers.set(2),this._backgroundMesh.receiveShadow=!0,setShadows(this._backgroundMesh,!0,!1),this.removeFromScene(),this.addToScene()))}showGUI(){console.warn("gui not implemented for gltf environment")}}__decorate([inject],GltfEnvironment.prototype,"_scriptLoader",void 0);class AsyncGuard{constructor(){this._init()}_init(){this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(){this._resolve()}reject(e){this._reject(e)}wait(){return new Promise((e,t)=>Promise.all([this._promise]).then(()=>e(),t))}reset(){this._init()}}const DEFAULT_BAKED_SHADOW_PARAMS={enable:!1,shadowMapResolution:512,smoothTransition:!0,numSamples:500,numSamplesPerFrame:4,bShadowMaterial:!0,falloff:1.5,darkness:.2,size:1.6,lightSolidAngle:40,yPosition:0};class BakedShadowEnvironment extends Environment{constructor(e,t){super(e,t),this._pixotronGuard=new AsyncGuard,this._params=Object.assign(DEFAULT_BAKED_SHADOW_PARAMS,{lightDirection:new THREE.Vector3(0,1,.5),onComplete:this._addGroundShadows.bind(this),onProgress:this._progressCallback.bind(this)})}_progressCallback(e){}needsBounds(){return!0}needsCamera(){return!1}needsRotation(){return!1}setPixotron(e,t,s,i){e&&(this._pixotron=e,this._renderer=t,this._camera=s,this._shadowBaker||(this._shadowBaker=new window.PIXOTRON.PlaneShadowBakePass(Object.assign(this._params,i))),this._shadowBaker.enable?this._shadowBaker.startBake(this._renderer,this._scene,this._camera):this._shadowBaker.enable=!0,this._wasAAEnabled=this._pixotron.enableAA,this._pixotronGuard.resolve())}async _addGroundShadows(){await this._pixotronGuard.wait(),this._pixotron.needsUpdate=!0,this._shadowPlane=this._shadowBaker.getShadowPlane(),this._shadowPlane.name="Shadow plane",this._shadowPlane.receiveShadow=!1,0!==this._params.yPosition&&(this._shadowPlane.position.y=this._params.yPosition),this._shadowPlane.visible=!0,this.addToScene(),this._loadedCallback&&this._loadedCallback()}setLoadedCallback(e){this._loadedCallback=e}updateBounds(e){const t=this._getNumberOfChildren();return!(vectorIsEqual(this._bounds,e,1e-4)&&this._scene&&t===this._sceneChildren||(super.updateBounds(e),this._pixotronGuard.wait().then(()=>{this._shadowPlane&&(this._shadowPlane.visible=!1),this._shadowBaker.startBake(this._renderer,this._scene,this._camera)}),this._sceneChildren=t,0))}_getNumberOfChildren(){let e=0;return this._scene.traverse(()=>e++),e}addToScene(){this._shadowPlane&&(this._shadowPlane.material.needsUpdate=!0,fadeIn(this._shadowPlane),this._scene.add(this._shadowPlane))}removeFromScene(){this._shadowPlane&&(this._scene.remove(this._shadowPlane),this._pixotron&&(this._pixotron.enableAA=this._wasAAEnabled))}showGUI(){}}class BakedShadowPlane{constructor(e){this._innerSize=1,this._outerSize=100,this._plane=new THREE.Object3D,this._plane.rotation.x=-Math.PI/2;const t=new THREE.MeshStandardMaterial;this._innerPlaneMesh=new THREE.Mesh,this._innerPlaneMesh.material=t,this._innerPlaneMesh.receiveShadow=!0,this._outerPlaneMesh=new THREE.Mesh,this._outerPlaneMesh.material=t,this._outerPlaneMesh.receiveShadow=!0,this._plane.add(this._innerPlaneMesh),this._plane.add(this._outerPlaneMesh),this._innerSize=1,this._outerSize=e,this._updatePlane(this._innerSize,this._outerSize)}getRootNode(){return this._plane}getInnerPlane(){return this._innerPlaneMesh}getOuterPlane(){return this._outerPlaneMesh}updateSize(e){this._innerSize=e,this._updatePlane(this._innerSize,this._outerSize)}_updatePlane(e,t){const s=new THREE.Shape;s.moveTo(-e/2,-e/2),s.lineTo(-e/2,e/2),s.lineTo(e/2,e/2),s.lineTo(e/2,-e/2),s.lineTo(-e/2,-e/2);const i=new THREE.Shape;i.moveTo(-t/2,-t/2),i.lineTo(-t/2,t/2),i.lineTo(t/2,t/2),i.lineTo(t/2,-t/2),i.lineTo(-t/2,-t/2);const n=new THREE.Path;n.moveTo(-e/2,-e/2),n.lineTo(-e/2,e/2),n.lineTo(e/2,e/2),n.lineTo(e/2,-e/2),n.lineTo(-e/2,-e/2),i.holes.push(n);const o=new THREE.ShapeBufferGeometry(s);this._innerPlaneMesh.geometry&&this._innerPlaneMesh.geometry.dispose(),this._innerPlaneMesh.geometry=o;const a=new THREE.ShapeBufferGeometry(i);this._outerPlaneMesh.geometry&&this._outerPlaneMesh.geometry.dispose(),this._outerPlaneMesh.geometry=a;const r=o.attributes.uv.clone();o.addAttribute("uv2",r);const h=o.attributes.uv2.array;for(let e=0;e<h.length;++e)h[e]+=.5}}const INITIAL_FLOOR_SIZE=100,FOG_COLOR=16185078;class FloorEnvironment extends BakedShadowEnvironment{constructor(e,t,s){super(e,t),this._longestSide=2,this._bakedShadowPlane=new BakedShadowPlane(INITIAL_FLOOR_SIZE),this._fog=s||!1,this._textureLoader=new THREE.TextureLoader,this.addToScene()}needsBounds(){return!0}needsCamera(){return this._fog}needsRotation(){return!1}updateBounds(e){return super.updateBounds(e),this._longestSide=Math.max(e.x,e.z),this._update(),!0}updateCamera(e){this._cameraDistance=e.position.distanceTo(new THREE.Vector3(0,0,0)),this._update()}_update(){this._fog&&this._updateFog()}_updateFog(){let e=this._longestSide/2;this._scene.fog=new THREE.Fog(FOG_COLOR,this._cameraDistance+e+3,this._cameraDistance+e+3+1),this._scene.background=new THREE.Color(FOG_COLOR)}_updateFloor(){if(this._floorMaterial)this._bakedShadowPlane.getOuterPlane().material=this._floorMaterial,this._bakedShadowPlane.getInnerPlane().material=this._floorMaterial;else{let e=this._width/1e3,t=this._height/1e3;this._repeatable&&(this._floorTexture.wrapS=THREE.RepeatWrapping,this._floorTexture.wrapT=THREE.RepeatWrapping,this._floorTexture.repeat.set(INITIAL_FLOOR_SIZE/e,INITIAL_FLOOR_SIZE/t));let s=new THREE.MeshStandardMaterial({map:this._floorTexture,side:THREE.DoubleSide});this._bakedShadowPlane.getInnerPlane().material=s,this._bakedShadowPlane.getOuterPlane().material=s}}addToScene(){this._scene&&(this._shadowPlane&&(this._bakedShadowPlane.updateSize(this._shadowPlane.scale.x),this._bakedShadowPlane.getRootNode().position.copy(this._shadowPlane.position),this._bakedShadowPlane.getInnerPlane().material.aoMap=this._shadowPlane.material.aoMap),this._scene.add(this._bakedShadowPlane.getRootNode()))}removeFromScene(){this._scene.remove(this._bakedShadowPlane.getRootNode())}setFloorMaterial(e,t,s,i){return this._width=t,this._height=s,this._repeatable=i,this._floorPromise=new Promise((t,s)=>{this._textureLoader.load(e,e=>{this._floorTexture=e,t()},null,s)}),new Promise((e,t)=>{this._floorPromise.then(()=>{this._updateFloor(),this._update(),e()},t)})}changeFloorMaterial(e,t){this._floorPromise=new Promise((s,i)=>{let n=createMaterial(e,this._environmentLoader);this._rapiAccess.getTexturesOf(e).then(o=>{if(o.length>0){let e=[];o.forEach(s=>{e.push(addTexture(this._dataSyncer.requestAsset(s.image,!0),s,n,t,1,1))}),Promise.all(e).then(()=>{this._floorMaterial=n,setTimeout(()=>s(),0)},i)}else i("textures for material "+e.id+" are empty")}),(!e.textures||e.textures&&0===e.textures.length)&&(this._floorMaterial=n,setTimeout(()=>s(),0))});let s=[this._floorPromise];return new Promise((e,t)=>{Promise.all(s).then(()=>{this._updateFloor(),this._update(),e()},t)})}showGUI(){this._floorMaterial?this._addGUI():this._floorPromise&&this._floorPromise.then(()=>this._addGUI())}_addGUI(){let e=getGUI().addFolder("Floor");e.add(this._floorMaterial,"roughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"reflectivity").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoat").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoatRoughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"opacity").min(0).max(1).step(.01),e.add(this._floorMaterial,"metalness").min(0).max(1).step(.01),e.add(this._floorMaterial,"bumpScale").min(0).max(1).step(.01)}}__decorate([inject],FloorEnvironment.prototype,"_rapiAccess",void 0),__decorate([inject],FloorEnvironment.prototype,"_dataSyncer",void 0),__decorate([inject],FloorEnvironment.prototype,"_environmentLoader",void 0);const BACKGROUND_CLASS_NAME="rml-scene-background";class BackgroundEnvironment extends BakedShadowEnvironment{constructor(e,t,s,i,n){if(super(e,t),this._color=s,this._oldBackground=e.background,i&&n){this._canvas=i,this._style=document.createElement("style");let e='background-image: url("'+n+'"); background-size: cover;';this._style.innerText="."+BACKGROUND_CLASS_NAME+" {"+e+"}",this._canvas.appendChild(this._style)}}needsBounds(){return!0}needsCamera(){return!1}needsRotation(){return!1}addToScene(){super.addToScene(),this._color&&(this._scene.background=this._color),this._canvas&&this._canvas.classList&&(this._scene.background=null,this._canvas.classList.add(BACKGROUND_CLASS_NAME),this._pixotron&&(this._pixotron.enableAA=!1))}removeFromScene(){super.removeFromScene(),this._oldBackground&&(this._scene.background=this._oldBackground),this._canvas&&this._canvas.classList.remove(BACKGROUND_CLASS_NAME)}}class DynamicEnvironmentSettingLoader{parse(e,t,s,i){let n=JSON.parse(i);return n.environment?this.load(e,t,s,n):null}load(e,t,s,i){let n,o=i.environment;if(!o)return console.warn("No environment set in scene settings"),Promise.resolve(null);switch(o.type){case"color":n=new Promise(t=>t(new BackgroundEnvironment(e,s,new THREE.Color(o.details.color))));break;case"image":n=new Promise(i=>i(new BackgroundEnvironment(e,s,null,t,o.details.imageUrl)));break;case"gltf":n=new Promise(t=>{let i=new GltfEnvironment(e,s);i.loadBackground(getAssetPath()+"static/geometry/PhotoStudioRoom.glb"),t(i)});break;case"floor":n=new Promise(t=>{this._rapiAccess.getMaterial(o.details.material).then(i=>{let n=void 0===o.details.fog||o.details.fog,a=new FloorEnvironment(e,s,n);a.changeFloorMaterial(i).then(()=>{t(a)})})});break;case"baked_shadow":n=new Promise(i=>{o.details&&o.details.color?i(new BackgroundEnvironment(e,s,new THREE.Color(o.details.color))):o.details&&o.details.imageUrl?i(new BackgroundEnvironment(e,s,null,t,o.details.imageUrl)):i(new BakedShadowEnvironment(e,s))});break;default:console.warn("Could not load environment, return old environment"),n=new Promise(e=>e(s))}return n}}__decorate([inject],DynamicEnvironmentSettingLoader.prototype,"_rapiAccess",void 0);class HighPixelRatioQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(5),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!0,this._settings.useHDREnv=!0,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!0},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class HighestQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(4),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!0,this._settings.useHDREnv=!0,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!0},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class HighQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(3),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!0,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!0},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class MidQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(2),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!1,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!1},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class LowQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(1),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!1,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!1,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!1},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class LowestQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(0),this._settings.enableAA=!1,this._settings.useAreaLight=!1,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!1,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!1,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!1},this._settings.shadowQualitySettings={enabled:!1,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class PixotronUtil{constructor(e){this._sceneBoundingSphere=new THREE.Sphere,this._pixotron=e,this._initializeQualitySettings(),this._initializeQualityAdapters()}getPixotronInstance(e){const t={saoparams:{intensity:.5,occlusionWorldRadius:.6,smoothTransition:!0,bias:.02,accumulative:!1},shadowparams:{shadowQuality:1,smoothTransition:!0,enableAccumulation:!0,shadowBiasMultiplier:.05,nearPlane:.01,farPlane:50,fov:40,numSamples:100,side:THREE.FrontSide}};return e=e||t,new window.PIXOTRON.Pixotron(e)}showGUI(){let e=getGUI().addFolder("Renderer");e.add(this._pixotron.getSAOPass(),"enabled"),this._pixotron.getSAOPass().smoothTransition&&e.add(this._pixotron.getSAOPass(),"smoothTransition"),e.add(this._pixotron.getSAOPass(),"occlusionWorldRadius").min(0).max(1).step(1e-4).onChange(e=>{this._adjustSaoRadius(e)}),e.add(this._pixotron.getSAOPass(),"intensity").min(.1).max(2).step(.05),e.add(this._pixotron.getSAOPass(),"bias").min(0).max(1).step(1e-4).onChange(e=>{this._adjustSaoBias(e)}),this._pixotron.getSAOPass().numSamples&&e.add(this._pixotron.getSAOPass(),"numSamples").min(10).max(3e3).step(10),void 0!==this._pixotron.getShadowPass().enabled&&e.add(this._pixotron.getShadowPass(),"enabled"),e.add(this._pixotron.getShadowPass(),"smoothTransition"),e.add(this._pixotron.getShadowPass(),"enableAccumulation"),e.add(this._pixotron.getShadowPass(),"shadowRadius").min(0).max(5).step(.1),e.add(this._pixotron.getShadowPass(),"shadowBiasMultiplier").min(0).max(3).step(.01),e.add(this._pixotron.getShadowPass(),"numSamples").min(10).max(3e3).step(10)}updateBounds(e){this._sceneBoundingSphere.copy(e);const t=.25*this._getMaxSaoRadius();this._adjustSaoRadius(t);const s=2*this._getMinSaoBias();this._adjustSaoBias(s)}_getSaoRadius(){return this._sceneBoundingSphere.radius}_adjustSaoRadius(e){const t=this._pixotron.getSAOPass(),s=this._getMinSaoRadius(),i=this._getMaxSaoRadius();t.occlusionWorldRadius=Math.min(Math.max(e,s),i)}_adjustSaoBias(e){const t=this._pixotron.getSAOPass(),s=this._getMinSaoBias(),i=this._getMaxSaoBias();t.bias=Math.min(Math.max(e,s),i)}_getMinSaoRadius(){return.001*this._getSaoRadius()}_getMaxSaoRadius(){return.6*this._getSaoRadius()}_getMinSaoBias(){return.001*this._getSaoRadius()}_getMaxSaoBias(){return.01*this._getSaoRadius()}updatePixelRatio(e){const{width:t,height:s}=e.getDrawingBufferSize();this._pixotron.setSize(Math.floor(t),Math.floor(s))}getHighPixelRatioQualitySetting(){return this._highPixelRatioQualitySetting.getSettings()}getLowestQualitySetting(){return this._lowQualitySetting.getSettings()}_initializeQualitySettings(){this._highestQualitySetting=new HighestQualitySettings,this._highPixelRatioQualitySetting=new HighPixelRatioQualitySettings,this._highQualitySetting=new HighQualitySettings,this._midQualitySetting=new MidQualitySettings,this._lowQualitySetting=new LowQualitySettings,this._lowestQualitySetting=new LowestQualitySettings}_initializeQualityAdapters(){this._autoQualityAdapter=new window.PIXOTRON.AutoQualityAdapter(this._pixotron),this._autoQualityAdapter.addQuality(this._highestQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._highQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._midQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._lowQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._lowestQualitySetting.getSettings()),this._autoQualityAdapter.setDesiredFps(30),this._manualQualityAdapter=new window.PIXOTRON.ManualQualityAdapter(this._pixotron)}onAutoQualityChange(e){this._autoQualityAdapter.onQualityChange(e)}onManualQualityChange(e){this._manualQualityAdapter.onQualityChange(e)}getAutoAdapter(){return this._autoQualityAdapter}lockAdapter(){this._autoQualityAdapter.getCurrentQualitySetting().lock()}unLockAdapter(){this._autoQualityAdapter.getCurrentQualitySetting().unLock()}enablePixotronAutoQuality(){this._currentQualityAdapter||(this._currentQualityAdapter=this._autoQualityAdapter,this._pixotron.setQualityAdapter(this._autoQualityAdapter))}movingCameraStarts(){this._currentQualityAdapter&&(this._currentQualityAdapter=this._autoQualityAdapter,this._currentQualitySetting&&(this._manualQualityAdapter.setQualitySetting(this._currentQualitySetting),this._pixotron.setQualityAdapter(this._manualQualityAdapter)),this._pixotron.setQualityAdapter(this._autoQualityAdapter))}movingCameraStops(){this._currentQualityAdapter&&(this._currentQualitySetting=this._currentQualityAdapter.getCurrentQualitySetting(),this._currentQualityAdapter=this._manualQualityAdapter,this._pixotron.setQualityAdapter(this._manualQualityAdapter),this._manualQualityAdapter.setQualitySetting(this._highestQualitySetting.getSettings()))}}export{Benchmark as a,AppContext as b,AsyncHelper as c,DOCKING_CONVERSATION_ID as d,DEFAULT_CONVERSATION_ID as e,convertCObject as f,EventDispatcher as g,InputManager as h,kernelBoxToThreeBox as i,getScreenXY as j,toRadiant as k,CameraControl3D as l,DynamicLightSetting as m,CANVAS_ID as n,RoomleComponentFactoryInitializer as o,BackgroundEnvironment as p,FloorEnvironment as q,DynamicLightSettingLoader as r,PREDEFINED_LIGHTSETTING as s,GltfEnvironment as t,PixotronUtil as u,BakedShadowEnvironment as v,getGUI as w,DynamicEnvironmentSettingLoader as x,kernelDimensioningToThree as y,dispose as z,DependencyInjectionAssignment as A,Logger as B,ScriptLoader as C,CameraControl as D,DomHelper as E,DataSyncer as F,Main as G,RoomleDependencyInjection as H,IMAGE_FORMATS as I,PREVIEW_MATERIAL_COLOR as J,PREVIEW_MATERIAL_ROUGHNESS as K,PREVIEW_MATERIAL_METALNESS as L,createMaterial as M,addTexture as N,vectorIsZero as O,disposeMesh as P,PREVIEW_MATERIAL_OPACITY as Q,LightSetting as R,convertToKernel as S,convertToTHREE as T,fadeIn as U,getMaterialId as V,getBoundingBoxMaterial as W,getColorFromInt as X,getSelectionGeometry as Y,convertToThreeDimensions as Z,checkGLB as _,AsyncGuard as $,setWallTransparencyBasedOnCamera as a0,setWallTransparency as a1,ConfiguratorViewModel as a2,position3VectorsAreEqual as a3,rotationQuaternionsAreEqual as a4,getDelta as a5,MIN_MOVE_DISTANCE as a6,position2VectorsAreEqual as a7,DynamicQualitySettingLoader as a8,getMaterialShading as a9,EnvironmentLoader as aa};
//# sourceMappingURL=chunk-7cea0edd.js.map
