import{a as __decorate,b as inject}from"./chunk-2d0907d4.js";import{f as LightSetting,g as getGUI,d as EventDispatcher,w as CameraControl,K as MIN_MOVE_DISTANCE,L as position2VectorsAreEqual,M as position3VectorsAreEqual,N as rotationQuaternionsAreEqual,O as getDelta,r as Benchmark,P as checkGLB,Q as fadeIn,R as fadeOut,b as kernelBoxToThreeBox,S as setWallTransparency,T as setWallTransparencyBasedOnCamera,l as CameraControl3D,p as CANVAS_ID,q as toRadiant,U as dispose,D as disposeMesh,V as getBoundingBoxMaterial,j as addTexture,k as createMaterial,u as InputManager,v as DomHelper,x as ScriptLoader,A as DependencyInjectionAssignment,y as Logger,B as Main,C as RoomleDependencyInjection}from"./chunk-2031af5a.js";import{a as RaycastHelper,k as convertToTHREE,l as convertToThreeDimensions,h as utilityConvertCObject,b as RoomleComponentFactoryInitializer,m as convertToEuler,n as convertToThreeMatrix,f as CommonKernelAccess,g as MESH_DEFAULT_FORMAT,c as Env,i as MeshGenerator,j as RapiAccess}from"./chunk-6050866d.js";import{a as SceneManager,b as CameraControl2D}from"./chunk-1946cf90.js";class PlannerLightSetting extends LightSetting{constructor(e,t){super(e,t),this._center=new THREE.Vector3(0,0,0),this._params={ambientLight:{color:"#ffffff"},areaLight:{position:{x:-1,y:12,z:-1},intensity:400,width:10,height:10,color:"#ffffff"},mainDirLight:{position:{x:-100,y:100,z:-100},color:"#ffffff"},secondDirLight:{position:{x:100,y:100,z:100},color:"#f0faff"}},this._hemiTOLight=new THREE.HemisphereLight(2250599,16760152,1),this._hemiTOLight.position.set(0,2,0),this._hemiLight=new THREE.HemisphereLight(4473924,2236979,2),this._hemiLight.position.set(0,.2,0),this._ambientLight=new THREE.AmbientLight(new THREE.Color(this._params.ambientLight.color),.6),this._ambientLight.layers.set(1),this._areaLight=new THREE.RectAreaLight(new THREE.Color(this._params.areaLight.color),void 0,this._params.areaLight.width,this._params.areaLight.height),this._areaLight.castShadow=!0,this._areaLight.matrixAutoUpdate=!0,this._areaLight.intensity=this._params.areaLight.intensity/(this._areaLight.width*this._areaLight.height),this._areaLight.position.set(this._params.areaLight.position.x,this._params.areaLight.position.y,this._params.areaLight.position.z),this._areaLight.lookAt(new THREE.Vector3(0,0,0)),this._areaLight.visible=!0,this._areaLight.layers.set(1),this._sunLight=this._createSpotlight(new THREE.Vector3(5,4,5),new THREE.Vector3(0,0,0)),this._mainDirLight=new THREE.DirectionalLight(new THREE.Color(this._params.mainDirLight.color),.5),this._mainDirLight.position.set(this._params.mainDirLight.position.x,this._params.mainDirLight.position.y,this._params.mainDirLight.position.z),this._mainDirLight.castShadow=!1,this._mainDirLight.shadow.camera.near=.5,this._mainDirLight.shadow.camera.far=100,this._mainDirLight.shadow.mapSize=new THREE.Vector2(1024,1024),this._mainDirLight.visible=!1,this._secondDirLight=new THREE.DirectionalLight(new THREE.Color(this._params.secondDirLight.color),.2),this._secondDirLight.position.set(this._params.secondDirLight.position.x,this._params.secondDirLight.position.y,this._params.secondDirLight.position.z),this._secondDirLight.castShadow=!1,this._secondDirLight.shadow.camera.near=.5,this._secondDirLight.shadow.camera.far=100,this._secondDirLight.shadow.mapSize=new THREE.Vector2(1024,1024),this._secondDirLight.visible=!1,this.addToScene()}_createSpotlight(e,t){let n=new THREE.SpotLight(16767899,.5);return n.angle=60*Math.PI/180,n.penumbra=.3,n.position.copy(e),n.target.position.set(t.x,t.y,t.z),n.shadow.camera.near=.1,n.shadow.camera.far=100,n.shadow.mapSize=new THREE.Vector2(1024,1024),n.visible=!0,n.castShadow=!0,n}updateSunPosition(e,t){}addToScene(){this._scene.add(this._areaLight),this._scene.add(this._mainDirLight),this._scene.add(this._secondDirLight),this._scene.add(this._ambientLight)}removeFromScene(){this._scene.remove(this._areaLight),this._scene.remove(this._mainDirLight),this._scene.remove(this._secondDirLight),this._scene.remove(this._ambientLight)}reload(){this.removeFromScene(),this.addToScene()}setBounds(e){this._center.copy(e.getCenter(new THREE.Vector3)),this._areaLight.position.copy(new THREE.Vector3(this._params.areaLight.position.x,this._params.areaLight.position.y,this._params.areaLight.position.z).add(this._center)),this._mainDirLight.position.copy(new THREE.Vector3(this._params.mainDirLight.position.x,this._params.mainDirLight.position.y,this._params.mainDirLight.position.z).add(this._center)),this._secondDirLight.position.copy(new THREE.Vector3(this._params.secondDirLight.position.x,this._params.secondDirLight.position.y,this._params.secondDirLight.position.z).add(this._center)),this._areaLight.lookAt(this._center),this._mainDirLight.lookAt(this._center),this._secondDirLight.lookAt(this._center)}showGUI(){let e=getGUI();if(this._areaLight){let t=e.addFolder("Area Light");t.add(this._areaLight,"visible"),t.add(this._params.areaLight,"intensity").min(100).max(2e3).step(1).onChange(e=>this._areaLight.intensity=e/(this._areaLight.width*this._areaLight.height)),t.add(this._params.areaLight,"width").min(1).max(30).step(1).onChange(e=>{this._areaLight.width=e,this._areaLight.intensity=this._areaLight.intensity/(this._areaLight.width*this._areaLight.height)}),t.add(this._params.areaLight,"height").min(1).max(30).step(1).onChange(e=>{this._areaLight.height=e,this._areaLight.intensity=this._areaLight.intensity/(this._areaLight.width*this._areaLight.height)}),t.add(this._areaLight,"castShadow"),t.addColor(this._params.areaLight,"color").onChange(e=>this._areaLight.color=new THREE.Color(e)),t.add(this._areaLight.position,"x").min(-30).max(50).step(.1).onChange(()=>this._areaLight.lookAt(this._center)),t.add(this._areaLight.position,"y").min(-30).max(50).step(.1).onChange(()=>this._areaLight.lookAt(this._center)),t.add(this._areaLight.position,"z").min(-30).max(50).step(.1).onChange(()=>this._areaLight.lookAt(this._center))}if(this._ambientLight){let t=e.addFolder("Ambient Light");t.add(this._ambientLight,"visible"),t.add(this._ambientLight,"intensity").min(0).max(5).step(.1),t.addColor(this._params.ambientLight,"color").onChange(e=>this._ambientLight.color=new THREE.Color(e))}if(this._mainDirLight){let t=e.addFolder("Main Directional Light");t.add(this._mainDirLight,"visible"),t.add(this._mainDirLight,"intensity").min(0).max(10).step(.1),t.add(this._mainDirLight,"castShadow"),t.addColor(this._params.mainDirLight,"color").onChange(e=>this._mainDirLight.color=new THREE.Color(e)),t.add(this._mainDirLight.position,"x").min(-10).max(10).step(.1).onChange(()=>this._mainDirLight.lookAt(this._center)),t.add(this._mainDirLight.position,"y").min(-10).max(50).step(.1).onChange(()=>this._mainDirLight.lookAt(this._center)),t.add(this._mainDirLight.position,"z").min(-10).max(10).step(.1).onChange(()=>this._mainDirLight.lookAt(this._center))}if(this._secondDirLight){let t=e.addFolder("Second Directional Light");t.add(this._secondDirLight,"visible"),t.add(this._secondDirLight,"intensity").min(0).max(10).step(.1),t.add(this._secondDirLight,"castShadow"),t.addColor(this._params.secondDirLight,"color").onChange(e=>this._secondDirLight.color=new THREE.Color(e)),t.add(this._secondDirLight.position,"x").min(-10).max(10).step(.1).onChange(()=>this._secondDirLight.lookAt(this._center)),t.add(this._secondDirLight.position,"y").min(-10).max(50).step(.1).onChange(()=>this._secondDirLight.lookAt(this._center)),t.add(this._secondDirLight.position,"z").min(-10).max(10).step(.1).onChange(()=>this._secondDirLight.lookAt(this._center))}}}class SceneEventInfo{constructor(e){const{planObject:t,resetCamera:n}=e;this.planObject=t,this.resetCamera=void 0===n||n}}class PlannerSceneEventHandler extends EventDispatcher{constructor(e,t,n){super(),this._debug=!0,this._raycastHelper=new RaycastHelper(e,t,n)}addPlanObjectHandlers(e){this._addPlanObjectHandlers(e,e.getBoundingBox(),{hasListener:!0,priority:1,roomleId:e.getRuntimeId()})}_addPlanObjectHandlers(e,t,n){t.userData.hasListener||(t.userData=n,t.addEventListener("select",()=>this._clickComponent(e)))}_clickComponent(e){this._debug&&e.getRuntimeId(),this.dispatchEvent(0,new SceneEventInfo({planObject:e}))}setCamera(e){this._raycastHelper.setCamera(e)}}const KEYBOARD_ROTATION_ANGLE=Math.PI/4,KEYBOARD_MOVING_DISTANCE=1,ROTATION_SPEED=1,ROTATION_SPEED_TOUCH=.6,RUN_SPEED=1,CONTROLLER_AXIS_THRESHHOLD=.2;class CameraControlFirstPerson extends CameraControl{constructor(e,t){super(e,t),this._state=0,this._rotationSpeed=ROTATION_SPEED,this._keyMap=new Map,this._camera=new THREE.PerspectiveCamera,this._camera.fov=50,this._camera.aspect=this._width/this._height,this._camera.near=.1,this._camera.far=100,this._camera.updateProjectionMatrix(),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4),t?this._camera.position.set(t.x,1.5,t.z):this._camera.position.set(0,1.5,0),this._cameraPosition=new THREE.Vector3,this._cameraPosition.copy(this._camera.position),this._cameraRotation=new THREE.Quaternion,this._pitch=0,this._yaw=0;let n=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX");this._cameraRotation.setFromEuler(n),window.addEventListener("gamepadconnected",this._gamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this._gamepadDisconnected.bind(this))}_gamepadConnected(e){this.startButtonPressListener()}_gamepadDisconnected(e){window.cancelAnimationFrame(this._listenerLoopAnimationFrame)}startButtonPressListener(){this._listenerLoopAnimationFrame=window.requestAnimationFrame(()=>{this.buttonPressListener()})}buttonPressListener(){let e=navigator.getGamepads()[0];this._checkRightStick(e),this._checkLeftStick(e),this._checkButtons(e),this._processKeyMap(this._keyMap,.001),this.startButtonPressListener()}_checkRightStick(e){let t=e.axes[2],n=e.axes[3];Math.abs(t)>CONTROLLER_AXIS_THRESHHOLD&&(this._rotateHorizontal(.01*KEYBOARD_ROTATION_ANGLE*t),this._update(),this.dispatchEvent(1)),Math.abs(n)>CONTROLLER_AXIS_THRESHHOLD&&(this._rotateVertical(.01*KEYBOARD_ROTATION_ANGLE*n),this._update(),this.dispatchEvent(1))}_checkLeftStick(e){let t=e.axes[0],n=e.axes[1];Math.abs(n)>CONTROLLER_AXIS_THRESHHOLD?n<0?this._keyMap.set(87,!0):this._keyMap.set(83,!0):e.buttons&&e.buttons[12]&&e.buttons[12].pressed?this._keyMap.set(87,!0):e.buttons&&e.buttons[13]&&e.buttons[13].pressed?this._keyMap.set(83,!0):(this._keyMap.set(87,!1),this._keyMap.set(83,!1)),Math.abs(t)>CONTROLLER_AXIS_THRESHHOLD?t<0?this._keyMap.set(65,!0):this._keyMap.set(68,!0):(this._keyMap.set(65,!1),this._keyMap.set(68,!1))}_checkButtons(e){e.buttons&&e.buttons[6]&&e.buttons[6].pressed?this._keyMap.set(16,!0):this._keyMap.set(16,!1),e.buttons&&e.buttons[14]&&e.buttons[14].pressed?(this._keyMap.set(37,!0),this.dispatchEvent(1)):this._keyMap.set(37,!1),e.buttons&&e.buttons[15]&&e.buttons[15].pressed?(this._keyMap.set(39,!0),this.dispatchEvent(1)):this._keyMap.set(39,!1)}animateCamera(e){let t=this._cameraPosition,n=this._cameraRotation,i=this.getCamera(),a=position3VectorsAreEqual(t,i.position),s=rotationQuaternionsAreEqual(n,i.quaternion);if(!t||a&&s)return!1;let r=this.getCamera().position.clone(),o=Math.min(10*e,1);r.lerp(t,o),this.getCamera().position.copy(r);let h=this.getCamera().quaternion.clone(),l=Math.min(5*e,1);h.slerp(n,l),this.getCamera().setRotationFromQuaternion(h);let c=!1;return this._keyMap.forEach(e=>{e&&(c=!0)}),c&&this._processKeyMap(this._keyMap,e),!0}_getCamera(){return this._camera}_initInputListener(){window.addEventListener("keyup",this._onKeyChanged.bind(this),!1),window.addEventListener("keydown",this._onKeyChanged.bind(this),!1),this._inputListeners.push({key:3,fun:e=>{this._down(e)}}),this._inputListeners.push({key:6,fun:e=>{this._move(e)}}),this._inputListeners.push({key:4,fun:e=>{this._up(e)}})}_down(e){this._downTime=Date.now(),this._downPosition=e.position,this._position=e.position,this._state=1,2===e.type&&(this._longDownTimer=window.setTimeout(this._onLongDown.bind(this),350)),2===e.type?this._rotationSpeed=ROTATION_SPEED_TOUCH:this._rotationSpeed=ROTATION_SPEED}_move(e){this._position=e.position,1!==this._state||this._locked||this._orbit(new THREE.Vector2(e.position.x,e.position.y)),2!==this._state||this._locked||(this._orbit(new THREE.Vector2(e.position.x,e.position.y)),this._moveForward())}_up(e){1===this._state&&this.dispatchEvent(2),2===this._state&&this._keyMap.set(87,!1),this._state=0,this._orbitPosition=null}_onLongDown(){getDelta(this._downPosition,this._position)<MIN_MOVE_DISTANCE&&1===this._state&&(this._state=2,this._orbit(new THREE.Vector2(this._position.x,this._position.y)),this._moveForward())}_update(e){let t=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX");this._cameraRotation.setFromEuler(t,!0)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();this._camera.aspect=e/t,this._camera.updateProjectionMatrix()}_onKeyChanged(e){this._keyMap.set(e.keyCode,"keydown"===e.type),this.dispatchEvent(6),this._processKeyMap(this._keyMap,.001)&&e.preventDefault()}_processKeyMap(e,t){t=Math.min(t,.1);let n=new THREE.Vector3(0,0,0),i=!1;return this._processUpDown(e,n,t),e.get(65)&&(n.x=-KEYBOARD_MOVING_DISTANCE*RUN_SPEED*t),e.get(68)&&(n.x=KEYBOARD_MOVING_DISTANCE*RUN_SPEED*t),e.get(37)&&(this._rotateHorizontal(-KEYBOARD_ROTATION_ANGLE*this._rotationSpeed*t),i=!0),e.get(39)&&(this._rotateHorizontal(KEYBOARD_ROTATION_ANGLE*this._rotationSpeed*t),i=!0),e.get(16)&&(n.x*=3,n.z*=3),!(0===n.x&&0===n.y&&0===n.z&&!i||(n.applyQuaternion(this.getCamera().quaternion),this._cameraPosition.add(new THREE.Vector3(n.x,0,n.z)),this._update(),0))}_processUpDown(e,t,n){(e.get(87)||e.get(38))&&(t.z=-KEYBOARD_MOVING_DISTANCE*RUN_SPEED*n),(e.get(83)||e.get(40))&&(t.z=KEYBOARD_MOVING_DISTANCE*RUN_SPEED*n)}_orbit(e){this._orbitPosition||(this._orbitPosition=new THREE.Vector2(e.x,e.y),this.dispatchEvent(0));let t=e.clone().sub(this._orbitPosition),n=this._domHelper.element instanceof Document?this._domHelper.element.body:this._domHelper.element;this._rotateHorizontal(2*Math.PI*t.x/n.clientWidth*ROTATION_SPEED),this._rotateVertical(2*Math.PI*t.y/n.clientHeight*ROTATION_SPEED),position2VectorsAreEqual(this._orbitPosition,e)||this.dispatchEvent(1),this._orbitPosition.copy(e),this._update()}_moveForward(){this._keyMap.set(87,!0),this._processKeyMap(this._keyMap,.001)}_rotateVertical(e){let t=this._pitch+e;t>.7||t<-.4||(this._pitch=t,this._pitch<-Math.PI?this._pitch+=2*Math.PI:this._pitch>Math.PI&&(this._pitch-=2*Math.PI))}}class PlannerSceneManager extends SceneManager{constructor(e,t,n){super(e,CANVAS_ID.HSP,n),this._roomlePlannerCallback=t,this._plannerMeshGenerator.maxAnisotrophy=this._renderer.capabilities.getMaxAnisotropy(),this._lightSetting=new PlannerLightSetting(this._scene),this._constructionGroup=new THREE.Group,this._addSky(),this._plannerSceneEventHandler=new PlannerSceneEventHandler(this._scene,this._cameraControl.getCamera(),this._getInputManager()),window.__RML__ENV__.initData.enableHSC&&this._plannerSceneEventHandler.addEventListener(0,({planObject:e})=>this._switchToHSC(e.getRuntimeId()),this),this._plannerKernelAccess.addPlannerListener(this),this._componentFactory=RoomleComponentFactoryInitializer()}zoomToComponent(e){if(this._cameraControl instanceof CameraControl3D){this._cameraControl.saveState(!0);let t=e.getBounds(),n=t.getSize(new THREE.Vector3),i=this._getYRotationOfObject(e.getMesh()),a=new THREE.Euler(0,i,0),s=t.getCenter(new THREE.Vector3);this._cameraControl.zoomTo(n,this._renderer.getSize().width,this._renderer.getSize().height,a.y,toRadiant(15),s).then(()=>this._switchToHSC(e.getRuntimeId()))}else this._switchToHSC(e.getRuntimeId())}onBeforeRender(){this._cameraControl instanceof CameraControl3D&&this._plannerMeshGenerator.wallMeshes.forEach(e=>setWallTransparencyBasedOnCamera(this._cameraControl.getCamera(),e.material))}_getInputManager(){return this._plannerInputManager}createCameraControl(e){this.setMode(e)}resetCamera(){this._cameraControl.hasSavedState()?this.resetCameraToState():this.resetCameraPositionToStart()}resetCameraToState(){this._cameraControl.resetToState()}resetCameraPositionToStart(){this._requestRender()}_getYRotationOfObject(e){let t=e.getWorldDirection(new THREE.Vector3).clone();t.y=0,t.lengthSq()<.01&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.normalize();let n=Math.asin(t.x);return t.z<0&&(n=Math.PI-n),n<0&&(n+=2*Math.PI),n}loadPlanObjects(e){let t=new Map;e.forEach(e=>{e.hasConfiguration()||(t.has(e.getCatalogItemId())?t.get(e.getCatalogItemId()).push(e):t.set(e.getCatalogItemId(),[e]))}),this._rapiAccess.getItems(Array.from(t.keys())).then(e=>{let n=[];e.forEach(e=>{this._plannerKernelAccess.catalogItemLoaded(e),t.get(e.id).forEach(t=>{n.push(this._addStaticItem(t,e))})}),Promise.all(n).then(()=>this._staticItemsLoaded())})}_staticItemsLoaded(){this._requestRender(!0)}preload(e){this._planId=e;let t=localStorage.getItem(this._planId);t&&this._loadGLTF(t).then(e=>{this._preloadScene=e,this._scene.add(this._preloadScene),this._requestRender()})}_addStaticItem(e,t){let n=this._getGLBUrl(t.threeDimensionalAssetWeb),i=new THREE.Vector3(e.size.x/t.width,e.size.z/t.height,e.size.y/t.depth);e.flipX&&(i.x*=-1),e.flipY&&(i.z*=-1);let a=convertToTHREE(e.getCenter()),s=convertToThreeDimensions(e.size),r=this._plannerMeshGenerator.generatePreviewBox(s.clone(),a.clone(),e.rotation,e.customColor);return r.name=t.label,fadeIn(r),this._scene.add(r),new Promise(t=>{this._loadGLB(n,a,e.rotation,i,e.customColor).then(e=>{e.name=r.name,checkGLB(e,n),fadeIn(e),this._scene.add(e),fadeOut(r,this._scene),this._requestRender(),t()})})}_getGLBUrl(e){let t=e.indexOf("/3d/")+4,n=e.indexOf("/",t),i=e.substring(t-1,n+1);return e.replace(i,"/glb/").replace(".flash.u3d",".glb")}planXMLLoaded(e){this._plannerKernelAccess.planModelViewHelper.requestPlanMesh3d(e,!0);let t=e.getBounds();this._bounds=kernelBoxToThreeBox(t);let{x:n,y:i}=this._domHelper.getClientDimensions();this._cameraControl instanceof CameraControl3D&&this._cameraControl.updateAndReset(this._bounds.getSize(new THREE.Vector3),n,i,this._bounds.getCenter(new THREE.Vector3),-15,70,5,!1),this._cameraControl instanceof CameraControl2D&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),this._bounds.getCenter(new THREE.Vector3));let a=utilityConvertCObject(e.getPlanObjects());this.loadPlanObjects(a)}planCompletelyLoaded(e){this._requestRender(),Benchmark.end("loadingTime"),this._planId&&this.exportGLB(this._constructionGroup.children,this._planId)}handlerSwitchedPlans(e){e.setPlannerSceneEventHandler(this._plannerSceneEventHandler),this._plannerMeshGenerator.clear(),this.clearScene(),this._addSky(),this.resetCamera(),this._constructionGroup=new THREE.Group;let t=new THREE.PlaneGeometry(1e3,1e3);t.rotateX(-Math.PI/2);let n=new THREE.MeshPhysicalMaterial({color:"#ffffff",roughness:.5,metalness:.1}),i=new THREE.Mesh(t,n);i.name="Ground",i.position.y=-.01,i.receiveShadow=!0,this._scene.add(i)}beginPlanConstruction(e){}addPlanMesh(e,t,n,i,a,s,r){this._constructionGroup.add(this._plannerMeshGenerator.generateMesh(null,t,n,i,a,s,r))}endPlanConstruction(e){this.updateCamera(),this._renderLoopFunction=(()=>{this._scene.add(this._constructionGroup),this._lightSetting instanceof PlannerLightSetting&&this._lightSetting.setBounds(this._getConstructionBounds()),this._scene.remove(this._preloadScene)})}addPlanObjectToScene(e){fadeIn(e),this._scene.add(e)}exportGLB(e,t){this._scriptLoader.fetch("static/three/lib/exporters/GLTFExporter.js",{id:"gltf-exporter"}).then(()=>{let n=new THREE.GLTFExporter;e||(e=[],this._scene.children.forEach(t=>{this._isPartOfScene(t)&&e.push(t)})),n.parse(e,e=>{let n=t||"test";localStorage.setItem(n,JSON.stringify(e))},{binary:!1,embedImages:!0,forceIndices:!0})})}importGLB(e){this._loadGLB(e).then(e=>this._scene.add(e))}_addSky(){this._sky=new THREE.Sky,this._sky.name="Sky",this._sky.scale.setScalar(45e4),this._scene.add(this._sky),this._sky.material.uniforms.turbidity.value=10,this._sky.material.uniforms.rayleigh.value=2,this._sky.material.uniforms.luminance.value=1,this._sky.material.uniforms.mieCoefficient.value=.005,this._sky.material.uniforms.mieDirectionalG.value=.8;let e=new THREE.Mesh(new THREE.SphereBufferGeometry(2e4,16,8),new THREE.MeshBasicMaterial({color:16777215}));e.name="Sunsphere",e.position.y=-7e5,e.visible=!1,this._scene.add(e);let t=-.2*Math.PI,n=2*Math.PI*-.25;e.position.x=4e5*Math.cos(n),e.position.y=4e5*Math.sin(n)*Math.sin(t),e.position.z=4e5*Math.sin(n)*Math.cos(t),e.visible=!0,this._sky.material.uniforms.sunPosition.value.copy(e.position),this._lightSetting instanceof PlannerLightSetting&&this._lightSetting.updateSunPosition(.3,.25)}switchTo2D(){this._cameraControl instanceof CameraControl2D||(this._requestRender(),this._changeCameraControl(new CameraControl2D(this._getInputManager())),this._bounds&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),this._bounds.getCenter(new THREE.Vector3)),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._roomlePlannerUiCallback.onCameraChanged("2D"))}switchTo3D(){if(this._cameraControl instanceof CameraControl3D)return;this._changeCameraControl(new CameraControl3D(this._getInputManager(),this._domHelper.element,new THREE.Vector3(0,10,0)));let{x:e,y:t}=this._domHelper.getClientDimensions();this._bounds&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),e,t,!1,!0,this._bounds.getCenter(new THREE.Vector3)),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._roomlePlannerUiCallback.onCameraChanged("3D")}cameraControlChanged(){super.cameraControlChanged(),this._plannerSceneEventHandler&&this._plannerSceneEventHandler.setCamera(this._cameraControl.getCamera())}_switchToHSC(e){this._roomlePlannerCallback.switchToHsc(e)}closeHSC(){this._requestRender(),this._cameraControl instanceof CameraControl3D&&this._cameraControl.resetToState(),this._pixotron&&this.enableHD()}switchToFirstPerson(){if(this._cameraControl instanceof CameraControlFirstPerson)return;this._plannerMeshGenerator.wallMeshes.forEach(e=>setWallTransparency(e.material,!1,!1)),this._requestRender();let e=new THREE.Vector3(0,0,0);this._constructionGroup&&(e=this._getConstructionBounds().getCenter(new THREE.Vector3)),this._cameraControl&&this._cameraControl.cleanUp(),this._cameraControl=new CameraControlFirstPerson(this._getInputManager(),e),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._roomlePlannerUiCallback.onCameraChanged("FP")}_getConstructionBounds(){let e=new THREE.Box3;return e.setFromObject(this._constructionGroup),e}_onKeyDown(e){super._onKeyDown(e),(e.key&&"1"===e.key||49===e.keyCode)&&(this.switchTo2D(),e.preventDefault()),(e.key&&"2"===e.key||50===e.keyCode)&&(this.switchTo3D(),e.preventDefault()),(e.key&&"3"===e.key||51===e.keyCode)&&(this.switchToFirstPerson(),e.preventDefault())}setMode(e){switch(e){case"2D":this.switchTo2D();break;case"3D":this.switchTo3D();break;case"FP":this.switchToFirstPerson()}}}__decorate([inject],PlannerSceneManager.prototype,"_plannerKernelAccess",void 0),__decorate([inject],PlannerSceneManager.prototype,"_rapiAccess",void 0),__decorate([inject],PlannerSceneManager.prototype,"_plannerMeshGenerator",void 0),__decorate([inject],PlannerSceneManager.prototype,"_plannerInputManager",void 0),__decorate([inject],PlannerSceneManager.prototype,"_roomlePlannerUiCallback",void 0);class RoomlePlanner{constructor(){this._hscInstance=null,this._glbInstance=null,this._canvasStack=[CANVAS_ID.HSP],this._kernelCallback.addListener(this)}init(e,t,n){return Benchmark.start("loadingTime"),this._domHelper.setDomElement(e),this._preloadPlanId=t,this.setOverrides(n),new Promise(this._initPromiseCallback.bind(this))}loadPlanXml(e,t){return this._hscInstance&&this._hscInstance.getApi().cleanup(),this.setOverrides(t),new Promise(t=>{this._plan=this._planInteractionHandler.loadPlanXML(e),this._plannerSceneManager.planXMLLoaded(this._plan),this._roomlePlannerUiCallback.onTotalFloorAreaChanged(this._planInteractionHandler.getPlan().getTotalFloorArea()),t()})}loadPlan(e,t){return this._hscInstance&&this._hscInstance.getApi().cleanup(),this.setOverrides(t),new Promise((t,n)=>{this._rapiAccess.getPlan(e).then(e=>{this._plan=this._planInteractionHandler.loadPlanXML(e.planObjects),this._plannerSceneManager.planXMLLoaded(this._plan),this._roomlePlannerUiCallback.onTotalFloorAreaChanged(this._planInteractionHandler.getPlan().getTotalFloorArea()),t()},n)})}setOverrides(e){e&&(window.__RML__ENV__.initData=Object.assign(window.__RML__ENV__.initData,e),e.overrideTenant&&this._rapiAccess.overrideTenant(e.overrideTenant),e.overrideCountry&&this._rapiAccess.overrideCountry(e.overrideCountry),e.overrideRapi&&this._rapiAccess.overrideRapi(e.overrideRapi))}switch2D(){this._plannerSceneManager.switchTo2D()}switch3D(){this._plannerSceneManager.switchTo3D()}switchToFirstPerson(){this._plannerSceneManager.switchToFirstPerson()}exportGLB(){this._plannerSceneManager.exportGLB()}importGLB(e){this._plannerSceneManager.importGLB(e)}_initPromiseCallback(e,t){this._kernelReadyCallback=e,this._scriptLoader.fetch("static/three/lib/rthree.js",{id:"three-lib"}).then(()=>{let e=this._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader"}),t=this._scriptLoader.fetch("static/three/Tween.js",{id:"tween-js"}),n=this._scriptLoader.fetch("static/three/lib/objects/Sky.js",{id:"sky-js"});Promise.all([e,t,n]).then(()=>{const{mode:e}=window.__RML__ENV__.initData;this._plannerSceneManager=new PlannerSceneManager({left:0,top:1,right:1,bottom:0},this,e);const{stats:t}=window.__RML__ENV__.initData;this._preloadPlanId&&this._plannerSceneManager.preload(this._preloadPlanId),t?this.showStats():this.enableHD(),this._planInteractionHandler&&this._kernelReadyCallback()})})}enableHD(){return new Promise((e,t)=>{const n=()=>{this._plannerSceneManager.enableHD(),e()};Promise.all([this._scriptLoader.fetch("static/three/lib/postprocessing/EffectComposer.js",{id:"effect-composer-js"}),this._scriptLoader.fetch("static/three/lib/lights/RectAreaLightUniformsLib.js",{id:"rect-area-light-uniforms-lib-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/ShaderPass.js",{id:"shader-pass-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/RenderPass.js",{id:"render-pass-js"}),this._scriptLoader.fetch("static/three/lib/shaders/CopyShader.js",{id:"copy-shader-js"})]).then(()=>{this._scriptLoader.fetch("static/three/pixotron.min.js",{id:"pixotron-js"}).then(n,t)},t)})}isReady(){this._planInteractionHandler=this._plannerKernelAccess.planInteractionHandler,this._kernelReadyCallback&&this._kernelReadyCallback()}showBenchmarks(){Benchmark.showBenchmarks()}_bringIntoForeground(e){const t=document.querySelectorAll("canvas");let n=!1;return t.forEach(t=>{t.classList.contains(e)?(t.classList.contains("foreground")||(this._canvasStack.push(e),n=!0),t.classList.remove("background"),t.classList.add("foreground")):(t.classList.remove("foreground"),t.classList.add("background"))}),n}switchToHsc(e){return this._singlePromiseFactory.create(3,"startHSC",t=>{if(this._hscInstance)return this._hscInstance.getApi().resume(),t();import("./configurator.js").then(n=>{const i=new n.Configurator;i.boot({kernelInstance:this._planInteractionHandler.getConfiguratorKernel(),kernelContainer:this._plannerKernelAccess.kernelContainer,planObjectId:e}),i.getApi().init(this._domHelper.element).then(()=>{this._hscInstance=i,t()})})}).then(()=>{this._hscInstance.getApi().syncPlanObjectToView(-1,e),this._bringIntoForeground(CANVAS_ID.HSC),this._roomlePlannerUiCallback.onSwitchToHSCFinished(),this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)})}switchToGLB(e){return this._singlePromiseFactory.create(4,"startGLB",e=>{if(this._glbInstance)return e();import("./glb-viewer.js").then(t=>{const n=new t.GlbViewer;n.boot(),window.RoomleGLBViewer.init(this._domHelper.element).then(()=>{this._glbInstance=n,e()})})}).then(()=>{this._glbInstance.getApi().loadGLB(e),this._bringIntoForeground(CANVAS_ID.GLB),this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)})}switchToPlanner(e){e&&this.loadPlan(e),this._bringIntoForeground(CANVAS_ID.HSP),this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)}back(){if(1===this._canvasStack.length)return;this._canvasStack.pop();let e=this._canvasStack.pop();this._bringIntoForeground(e),e===CANVAS_ID.HSP&&this._plannerSceneManager.closeHSC(),this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)}backTo(e){if(1===this._canvasStack.length)return;let t=!1;for(let n=this._canvasStack.length-1;n>=0;n--){let n=this._canvasStack.pop();n===e?this._bringIntoForeground(n):(n===CANVAS_ID.HSC&&this._plannerSceneManager.closeHSC(),t=!0)}t&&this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)}updateSize(){this._plannerSceneManager.updateCamera()}update(){this.updateSize(),this._glbInstance&&this._glbInstance.getApi().updateSize(),this._hscInstance&&this._hscInstance.getApi().updateSize()}get callbacks(){return this._roomlePlannerUiCallback}set callbacks(e){this._roomlePlannerUiCallback=e}showStats(){this._plannerSceneManager.showStats()}}__decorate([inject],RoomlePlanner.prototype,"_domHelper",void 0),__decorate([inject],RoomlePlanner.prototype,"_scriptLoader",void 0),__decorate([inject],RoomlePlanner.prototype,"_kernelCallback",void 0),__decorate([inject],RoomlePlanner.prototype,"_plannerKernelAccess",void 0),__decorate([inject],RoomlePlanner.prototype,"_rapiAccess",void 0),__decorate([inject],RoomlePlanner.prototype,"_singlePromiseFactory",void 0),__decorate([inject],RoomlePlanner.prototype,"_roomlePlannerUiCallback",void 0);class KernelViewModel{constructor(e){this._coreReference=e.clone()}clearReference(){this._coreReference.delete(),this._coreReference=null}}class PlanObjectViewModel extends KernelViewModel{constructor(e){super(e);const t=convertToTHREE(e.getCenter());this._object=new THREE.Object3D,this._object.name=e.getObjectType(),this._object.position.copy(t),this._object.rotateY(e.rotation);let n=convertToThreeDimensions(e.size),i=new THREE.BoxBufferGeometry(n.x,n.y,n.z);this._boundingBox=new THREE.Mesh(i,getBoundingBoxMaterial()),this._boundingBox.name=e.getCatalogItemId(),this._boundingBox.position.y+=n.y/2,this._boundingBox.receiveShadow=!1,this._boundingBox.castShadow=!1,this._object.add(this._boundingBox)}getBounds(){let e=new THREE.Box3;return e.setFromObject(this._object),e}getBoundingBox(){return this._boundingBox}gePlanObject(){return this._coreReference}getMesh(){return this._object}getRuntimeId(){return this.gePlanObject().getConfigurationRuntimeId()}clear(){disposeMesh(this._boundingBox),dispose(this._object)}}class ConfiguratorPlanObjectViewModel extends PlanObjectViewModel{constructor(e){super(e),this._object.name="Configurable "+this._object.name}addRootComponent(e){this._object.add(e)}clear(){super.clear()}}class PlanViewModel extends KernelViewModel{constructor(e){super(e),this._components=new Map,this._planObjectViewModels=[],this._plannerKernelAccess.addConfiguratorListener(this),this._componentFactory=RoomleComponentFactoryInitializer()}clearReference(){super.clearReference(),this._plannerKernelAccess.removeConfiguratorListener(this)}getCorePlan(){return this._coreReference}addPlanObjectViewModel(e){this._planObjectViewModels.push(e)}_addComponent(e,t){let n=this._components.get(e.parentObjectId);if(this._components.set(e.roomleId,e),t){let t=this._getPlanObjectViewModelForRuntimeId(e.parentObjectId);t&&t instanceof ConfiguratorPlanObjectViewModel&&(t.addRootComponent(e),this._plannerSceneEventHandler.addPlanObjectHandlers(t))}n&&n.add(e)}_addMeshToComponentId(e,t){let n=this._components.get(t);n&&n.addMesh(e)}_updateComponentInformation(e){let t=this._components.get(e.id);t&&(t.position.copy(convertToTHREE(e.position)),t.rotation.copy(convertToEuler(e.rotation)))}_getPlanObjectViewModelForRuntimeId(e){let t=null;return this._planObjectViewModels.forEach(n=>{e===n.getRuntimeId()&&(t=n)}),t}Editor3dComponentCreated(e,t,n,i,a){if(this._components.has(e))return;let s=this._componentFactory.create(e,t,n,i);s.layers.set(3),this._addComponent(s,a)}Editor3dAddBakedMesh(e,t,n,i,a,s){let r=this._plannerMeshGenerator.generateMesh(null,t,n,i,a,s);this._addMeshToComponentId(r,e)}Editor3dAddNamedMesh(e,t,n,i,a,s,r,o){let h=this._plannerMeshGenerator.generateMesh(t,n,a,s,r,o);i&&h.applyMatrix(convertToThreeMatrix(i)),this._addMeshToComponentId(h,e)}updateComponentMetaInformation(e){this._updateComponentInformation(e)}setPlannerSceneEventHandler(e){this._plannerSceneEventHandler=e}Editor3dComponentDocked(e,t,n,i){let a=this._components.get(t),s=this._components.get(e);s&&(s.roomlePosition=n,s.roomleRotation=i,a.add(s))}Editor3dBeginConstruction(e){let t=this._components.get(e);t&&t.removeAllMeshes()}Editor3dGeometryNotReady(e){this._components.has(e)&&this._components.get(e).loading()}sceneCleared(){this._planObjectViewModels.forEach(e=>{e.clear()}),this._components.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._components.clear()}componentDeleted(e){const t=this._components.get(e);t&&(t.removeFromParent(),t.removeAllMeshes(),this._components.delete(e))}}__decorate([inject],PlanViewModel.prototype,"_plannerKernelAccess",void 0),__decorate([inject],PlanViewModel.prototype,"_plannerMeshGenerator",void 0);class PlannerKernelAccess extends CommonKernelAccess{constructor(){super(0),this._plannerKernelCallbackListener=new Set,this._configuratorKernelCallbackListener=new Set,Benchmark.addMeta("kernel_is_ready",{isWasm:this._useWASM}),this._scriptLoader.fetch(this._kernelPath,{id:"kernel"}).then(this._loadSuccess.bind(this),this._loadError.bind(this))}get kernelContainer(){return this._kernelContainer}_loadSuccess(){window.RoomleCore(this._kernelContainer)}_loadError(){console.error("kernel load error")}addPlannerListener(e){this._plannerKernelCallbackListener.add(e)}removePlannerListener(e){this._plannerKernelCallbackListener.delete(e)}addConfiguratorListener(e){this._configuratorKernelCallbackListener.add(e)}removeConfiguratorListener(e){this._configuratorKernelCallbackListener.delete(e)}isReady(){super.isReady();const e=this._kernelContainer;e.registerPlannerCallback(this),e.registerConfiguratorCallback(this),this._planInteractionHandler=new e.PlanInteractionHandler,this._planInteractionHandler.init(this._planInteractionHandler,1,300,!1,!0,e.DrawingType.CLICK_PER_CLICK),this._kernelInstance=this._planInteractionHandler.getConfiguratorKernel(),Env.isProduction||(window.__RML__DEBUG__.ConfiguratorKernel=this._kernelInstance,window.__RML__DEBUG__.PlannerKernelContainer=this._kernelContainer),this._kernelCallback.isReady()}get planInteractionHandler(){return this._planInteractionHandler}get planModelViewHelper(){return this._kernelContainer.PlanModelViewHelper}catalogItemLoaded(e){let t=new this._kernelContainer.CatalogItem(e.id);t.size={x:e.width,y:e.height,z:e.depth},t.flipable=e.flipable,t.layer=e.layer,t.orderable=e.orderable,t.scaleable=e.scaleable,t.type=e.type,this._kernelContainer.catalogItemLoaded(t)}onLoadComponentError(e){}configurationLoaded(e,t,n,i,a){}componentDefinitionLoaded(e,t){}componentDefinitionLoadingError(e,t){}configurationLoadingError(){}componentConfigurationUpdated(e){}componentMetaUpdated(e){let t=utilityConvertCObject(this._kernelInstance.getComponent(e));this._configuratorKernelCallbackListener.forEach(e=>e.updateComponentMetaInformation(t))}componentParameters(){}componentDeleted(e){this._configuratorKernelCallbackListener.forEach(t=>t.componentDeleted(e))}requestComponentDimensions(){}planObjectCreated(e,t){}planObjectUpdated(e){}planObjectConfigurationUpdated(e,t,n){}planObjectDeleted(){}requestPlanObjectDimensions(){}sceneCleared(){this._configuratorKernelCallbackListener.forEach(e=>e.sceneCleared())}requestExternalMesh(e,t){return new Promise((n,i)=>{this._rapiAccess.getMesh(e,MESH_DEFAULT_FORMAT,t).then(a=>{fetch(new Request(this._dataSyncer.requestAsset(a.url,!0))).then(e=>e.arrayBuffer()).then(i=>{try{this._kernelContainer.addMeshCorto(e,t,new Uint8Array(i)),n()}catch(e){console.error(e),n()}}).catch(e=>{console.error(e),i(e)})},e=>{console.error(e),i(e)})})}Editor3dComponentCreated(e,t,n,i){this._configuratorKernelCallbackListener.forEach(a=>a.Editor3dComponentCreated(e,t,n,i,!1))}Editor3dRootComponentCreated(e,t,n,i){this._configuratorKernelCallbackListener.forEach(a=>a.Editor3dComponentCreated(e,t,n,i,!0))}Editor3dBeginConstruction(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dBeginConstruction(e))}Editor3dEndConstruction(e){}Editor3dGeometryReady(e){this._kernelInstance.requestPlanComponentConstruction(e)}Editor3dGeometryNotReady(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dGeometryNotReady(e))}Editor3dPlanObjectConstructionDone(e){}Editor3dBeginGroup(){}Editor3dEndGroup(){}Editor3dSetMaterial(){}Editor3dLoadMaterial(){}Editor3dAddDockPreview(e,t){}Editor3dSetPreviewPointAssociations(e,t){}Editor3dSetPreviewLineAssociations(e,t){}Editor3dPreviewConstructionDone(e,t){}Editor3dTranslateBy(){}Editor3dRotateBy(){}Editor3dRotateAround(){}Editor3dAddCube(){}Editor3dAddCubeUVMod(){}Editor3dAddSphere(){}Editor3dAddSphereUVMod(){}Editor3dAddRectangle(){}Editor3dAddRectangleUVMod(){}Editor3dAddMesh(){}Editor3dAddMeshUVMod(){}Editor3dAddMeshUVCoord(){}Editor3dAddCylinder(){}Editor3dAddCylinderUVMod(){}Editor3dAddPrism(){}Editor3dAddPrismUVMod(){}Editor3dAddFittingPoint(){}Editor3dAddFittingLine(){}Editor3dSelectObject(){}Editor3dCopy(){}Editor3dComponentDocked(e,t,n,i){this._configuratorKernelCallbackListener.forEach(a=>a.Editor3dComponentDocked(e,t,n,i))}Editor3dUpdatePlanObjectPosition(){}Editor3dUpdatePlanObjectRotation(){}Editor3dUpdatePlanObjectTransform(){}Editor3dUpdatePlanComponentPosition(){}Editor3dUpdatePlanComponentRotation(){}Editor3dUpdatePlanComponentTransform(){}Editor3dAddBakedMesh(e,t,n,i,a,s){this._configuratorKernelCallbackListener.forEach(r=>r.Editor3dAddBakedMesh(e,t,n,i,a,s))}Editor3dAddNamedMesh(e,t,n,i,a,s,r,o){this._configuratorKernelCallbackListener.forEach(h=>h.Editor3dAddNamedMesh(e,t,n,i,a,s,r,o))}elementDeleted(e){this._decoupleReferences(e)}handlerSwitchedPlans(e,t){if(this._decoupleReferences(e),t){let e=new PlanViewModel(t);this._coupleReferences(e,t),this._plannerKernelCallbackListener.forEach(t=>t.handlerSwitchedPlans(e))}}planBoundsChanged(){}planCleared(){}planCompletelyLoaded(e){this._plannerKernelCallbackListener.forEach(t=>t.planCompletelyLoaded(e))}planElement3dMeshChanged(e,t){}planElementAdded(e,t){if(e&&e.extRef&&t.getType()===this._kernelContainer.PlanElementType.OBJECT){let n=t;if(n.hasConfiguration()){let t=new ConfiguratorPlanObjectViewModel(n);this._coupleReferences(t,n),e.extRef.jsObject.addPlanObjectViewModel(t),this._plannerKernelCallbackListener.forEach(e=>e.addPlanObjectToScene(t.getMesh()))}}}planElementChanged(e,t){}planHistoryStateChanged(){}planObjectConfigurationCreated(e,t){}planObjectConfigurationLoaded(e,t,n){if(e&&e.extRef&&t&&t.extRef){let e=t.extRef.jsObject.gePlanObject().getConfigurationRuntimeId();e>0&&this._kernelInstance.requestPlanObjectConstruction(e)}}requestCatalogItem(e){}startedDrawing(){}stoppedDrawing(){}updateMesh2d(){}beginConstruction(){}addMesh(){}endConstruction(){}beginPlanConstruction(e){this._plannerKernelCallbackListener.forEach(t=>t.beginPlanConstruction(e))}addPlanMesh(e,t,n,i,a,s,r){this._plannerKernelCallbackListener.forEach(o=>o.addPlanMesh(e,t,n,i,a,s,r))}endPlanConstruction(e){this._plannerKernelCallbackListener.forEach(t=>t.endPlanConstruction(e))}_coupleReferences(e,t){let n=new this._kernelContainer.EMSReference;n.jsObject=e,t.extRef=n}_decoupleReferences(e){e&&e.extRef&&(e.extRef.jsObject.clearReference(),e.extRef.jsObject=null,e.extRef.delete(),e.extRef=null)}}__decorate([inject],PlannerKernelAccess.prototype,"_kernelCallback",void 0);const INJECTABLES=[new DependencyInjectionAssignment("script-loader",ScriptLoader),new DependencyInjectionAssignment("dom-helper",DomHelper),new DependencyInjectionAssignment("planner-input-manager",class extends InputManager{}),new DependencyInjectionAssignment("planner-kernel-access",PlannerKernelAccess),new DependencyInjectionAssignment("logger",Logger),new DependencyInjectionAssignment("kernel-callback",class{constructor(){this._callbackListener=new Set}addListener(e){this._callbackListener.add(e)}removeListener(e){this._callbackListener.delete(e)}isReady(){this._callbackListener.forEach(e=>e.isReady())}}),new DependencyInjectionAssignment("planner-mesh-generator",class extends MeshGenerator{constructor(){super(),this._wallMeshes=[],this._standardFloorMaterial=new THREE.MeshPhysicalMaterial({color:"#e7d8c5",roughness:.7}),this._standardWallMaterial=new THREE.MeshPhysicalMaterial({color:"#ffffff",roughness:.5,metalness:.1})}generateMesh(e=null,t,n,i,a,s,r){let o=this._generateGeometry(e,n,i,a,s);const h=new THREE.Mesh(o,this._previewMaterial);return h.receiveShadow=!0,h.castShadow=!0,h.layers.set(3),!t&&r&&7!==r.value?(console.warn("material is undefined"),h):(this._setMaterial(h,t,r),this._checkWallMaterial(h,r),h)}_setMaterial(e,t,n){n&&7===n.value?this.changeMaterialOfMesh(e,this._standardWallMaterial):t.materialId&&""!==t.materialId?this._waitingForMaterials.push(this._assignMaterial(e,t.id)):t.catalogItemId&&""!==t.catalogItemId?this._waitingForMaterials.push(this._assignItem(e,t.catalogItemId)):t.rgbValue>0?this._waitingForMaterials.push(this._assignRGB(e,t.rgbValue)):t.length>0?this._waitingForMaterials.push(this._assignMaterial(e,t)):t.uvScale?this.changeMaterialOfMesh(e,this._standardFloorMaterial):n&&1===n.value?this.changeMaterialOfMesh(e,this._standardWallMaterial):console.warn("material not supported",t)}_assignRGB(e,t){return new Promise((n,i)=>{let a,s="rbg"+JSON.stringify(t);this._materialCache.has(s)?a=this._materialCache.get(s):(a=new THREE.MeshStandardMaterial({color:t}),this._materialCache.set(s,a)),this.changeMaterialOfMesh(e,a),setTimeout(()=>n(),0)})}_assignItem(e,t){return new Promise((n,i)=>{if(this._materialCache.has(t))return this.changeMaterialOfMesh(e,this._materialCache.get(t)),void n();this._rapiAccess.getItem(t).then(a=>{a.topImage?this._textureLoader.load(a.topImage,i=>{i.anisotropy=this._maxAnisotrophy,i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping;let s=new THREE.Vector2(1,1);a.width>0&&(s.x=1/a.width),a.depth>0&&(s.y=1/a.depth),i.repeat.set(s.x,s.y);let r=new THREE.MeshPhysicalMaterial({map:i,roughness:.5,metalness:.1});this._materialCache.set(t,r),this.changeMaterialOfMesh(e,r),setTimeout(()=>n(),0)}):(console.warn("can not set material, catalog item top image is not set"),i())},i)})}_assignMaterial(e,t){return new Promise((n,i)=>{if(this._materialCache.has(t))return this.changeMaterialOfMesh(e,this._materialCache.get(t)),void n();this._rapiAccess.getMaterial(t).then(i=>{let a=createMaterial(i,this._environmentLoader.getEnvironmentMap());this._rapiAccess.getTexturesOf(i).then(i=>{let s=[];i.forEach(e=>{s.push(addTexture(this._dataSyncer.requestAsset(e.image,!0),e,a,this._maxAnisotrophy,1/(0===e.mmWidth?1:e.mmWidth),1/(0===e.mmHeight?1:e.mmHeight)))}),Promise.all(s).then(()=>{this._materialCache.set(t,a),this.changeMaterialOfMesh(e,a),setTimeout(()=>n(),0)})}),(!i.textures||i.textures&&0===i.textures.length)&&(this._materialCache.set(t,a),this.changeMaterialOfMesh(e,a),setTimeout(()=>n(),0))},i)})}changeMaterialOfMesh(e,t){e?(e.material=t,e.material.needsUpdate=!0):console.warn("could not find mesh with id "+e.id)}set maxAnisotrophy(e){this._maxAnisotrophy=e}_checkWallMaterial(e,t){t&&1===t.value&&this._wallMeshes.push(e)}clear(){super.clear(),this.clearWallMeshes()}clearWallMeshes(){this._wallMeshes.forEach(e=>{disposeMesh(e)}),this._wallMeshes=[]}get wallMeshes(){return this._wallMeshes}_onBeforeRender(e,t,n,i,a,s){setWallTransparencyBasedOnCamera(n,a)}}),new DependencyInjectionAssignment("rapi-access",RapiAccess),new DependencyInjectionAssignment("roomle-planner-ui-callback",class{constructor(){this.onSwitchToHSCFinished=(()=>{}),this.onBackStackChanged=(e=>{}),this.onCameraChanged=(e=>{}),this.onTotalFloorAreaChanged=(e=>{})}})];class Planner extends Main{setupGlobals(){}setupDependencies(){RoomleDependencyInjection.setup(INJECTABLES),this.lookup("logger"),this.lookup("planner-kernel-access")}cleanUpGlobals(){throw new Error("Method not implemented.")}cleanUpDependencies(){throw new Error("Method not implemented.")}bootFinished(){this._planner=new RoomlePlanner,window.RoomlePlanner||(window.RoomlePlanner=this._planner)}getApi(){return this._planner}pause(){throw new Error("Method not implemented.")}}export{Planner};
//# sourceMappingURL=planner.js.map
