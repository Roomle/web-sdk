import{a as getAssetPath,d as MainThreadToWorker,e as handleJsonResponse,f as getAllParameters,g as ROOMLE_COLORS}from"./chunk-08b9678b.js";import{a as __decorate,b as inject}from"./chunk-bad5270e.js";const getLanguage=()=>{const e=window.navigator,t=["language","browserLanguage","userLanguage","systemLanguage"];if(Array.isArray(e.languages)&&e.languages.length>0)return e.languages[0].substr(0,2);for(let s=0,i=t.length;s<i;s++){const i=e[t[s]];if(i)return i.substr(0,2)}return"en"};class AppContext{static init(e={}){const{locale:t,kernelInstance:s,kernelContainer:i,planObjectId:n}=e;AppContext.kernelInstance=s,AppContext.kernelContainer=i,AppContext.planObjectId=n,AppContext.actualLocale=t||getLanguage()}}AppContext.actualLocale="en",AppContext.useHDGeometry=!1,AppContext.kernelInstance=null,AppContext.kernelContainer=null,AppContext.planObjectId=null;class Container{constructor(){this._context=new Map,this._lookups=new Map,this._singletons=new Map}getContext(e){if(this._context.has(e)){const t=this._context.get(e);return this._context.set(e,t+1),e+t}return this._context.set(e,1),e+0}addDependencyInjectionAssignments(e){e.forEach(e=>{this._lookups.set(e.className,e)})}lookup(e,t){if(!this._lookups.has(e))return null;let s=this._lookups.get(e);if(1===s.type&&void 0===t){const t="Dependency "+e+" has definition context but no context was defined!";return console.trace(t),console.error(t),null}let i=t&&1===s.type?t:"global";if(i+="_"+e,2===s.type)return new s.classDefinition;if(this._singletons.has(i))return this._singletons.get(i);let n=new s.classDefinition(t);return this._singletons.set(i,n),n}cleanUp(e){if(e){let t=[];this._singletons.forEach((s,i)=>{i.startsWith(e)&&t.push(i)}),t.forEach(e=>{this._singletons.delete(e)})}else this._singletons.clear(),this._singletons=new Map}}class DependencyInjectionAssignment{constructor(e,t,s){this.className=e,this.classDefinition=t,this.type=void 0===s?0:s}}const IMAGE_FORMATS={JPG:".jpg",JPEG:".jpeg",PNG:".png",GIF:".gif"};class FormDataUtil{_base64toBlob(e,t){t=t||"";const s=atob(e),i=s.length,n=Math.ceil(i/1024),a=new Array(n);for(let e=0;e<n;++e){let t=1024*e,n=Math.min(t+1024,i);const o=new Array(n-t);for(let e=t,i=0;e<n;++i,++e)o[i]=s[e].charCodeAt(0);a[e]=new Uint8Array(o)}return new Blob(a,{type:t})}_createFormData(e,t,s,i){const n=new FormData;-1!==e.indexOf(",")&&(e=e.substr(e.indexOf(",")+1));const a=-1===Object.keys(IMAGE_FORMATS).map(e=>IMAGE_FORMATS[e]).indexOf(s)?"application":"image",o=this._base64toBlob(e,a+"/"+s.substr(1));return n.append(i,o,t+s),n}create(e,t,s,i){return this._createFormData(e,t,s,i)}}const RECT_AREA_LIGHT_DEFAULT_SIZE=.8,PREDEFINED_LIGHTSETTING={SOFA:"sofa",SHELF:"shelf",SHELF_FRONT:"shelf_front"};class DynamicLightSettingLoader{static createDynamicLightSettingSource(e,t){let s={};if(e)s.url=e;else if(t)switch(t){case PREDEFINED_LIGHTSETTING.SHELF:s.url=getAssetPath()+"static/predefined_lightsettings/shelf.json";break;case PREDEFINED_LIGHTSETTING.SHELF_FRONT:s.url=getAssetPath()+"static/predefined_lightsettings/shelf_front.json";break;case PREDEFINED_LIGHTSETTING.SOFA:s.url=getAssetPath()+"static/predefined_lightsettings/sofa.json";break;default:s=null}else s=null;return s}parse(e){let t=JSON.parse(e);return t.lights?this.load(t):[]}load(e){let t=[];return e.lights?(e.lights.forEach(e=>{let s;switch(e.type){case"ambient":s=this._parseAmbientLight(e);break;case"rectarea":s=this._parseRectAreaLight(e);break;case"spot":s=this._parseSpotLight(e)}s&&t.push(s)}),t):[]}_parseAmbientLight(e){let t=new THREE.AmbientLight;return this._parseCommon(t,e),t}_parseRectAreaLight(e){let t=new THREE.RectAreaLight;this._parseCommon(t,e);let{intensity:s,castShadow:i,target:n,width:a,height:o}=e;return t.width=a||RECT_AREA_LIGHT_DEFAULT_SIZE,t.height=o||RECT_AREA_LIGHT_DEFAULT_SIZE,t.castShadow=i||!1,t.matrixAutoUpdate=!0,t.intensity=(s||240)/((a||RECT_AREA_LIGHT_DEFAULT_SIZE)*(o||RECT_AREA_LIGHT_DEFAULT_SIZE)),t.lookAt(n?new THREE.Vector3(n.x,n.y,n.z):new THREE.Vector3(0,0,0)),t}_parseSpotLight(e){let t=new THREE.SpotLight;this._parseCommon(t,e);let{angle:s,penumbra:i,target:n,castShadow:a}=e;return t.angle=(s||100)*Math.PI/180,t.penumbra=i||.5,t.lookAt(n?new THREE.Vector3(n.x,n.y,n.z):new THREE.Vector3(0,0,0)),t.shadow.camera.near=.1,t.shadow.camera.far=10,t.shadow.mapSize=new THREE.Vector2(1024,1024),t.castShadow=a||!1,t}_parseCommon(e,t){let{name:s,intensity:i,color:n,position:a,movesWithCamera:o}=t;e.name=s||"",e.intensity=i||1,e.color=new THREE.Color(n||"#ffffff"),e.position.copy(a?new THREE.Vector3(a.x,a.y,a.z):new THREE.Vector3(0,0,0)),e.visible=!0,e.layers.set(1),e.userData.movesWithCamera=o}}const MAX_NETWORK_CALLS=40;class NetworkLayer{constructor(){this._queue=[],this._pendingRequests=0}_nextSlot(){if(this._pendingRequests-=1,!this._queue.length)return;const{request:e,resolve:t,reject:s}=this._queue.shift();this._fetch(e).then(t,s)}_fetch(e){return this._pendingRequests+=1,new Promise((t,s)=>{self.fetch(e).then(function(){this._nextSlot(),t(...arguments)}.bind(this),e=>{this._nextSlot(),s(e)})})}fetch(e){return this._pendingRequests>=MAX_NETWORK_CALLS?new Promise((t,s)=>this._queue.push({request:e,resolve:t,reject:s})):this._fetch(e)}}class Logger{info(...e){console}log(...e){console}warn(...e){console.warn.apply(console,e)}error(...e){console.warn.apply(console,e)}}class KernelIo extends Logger{throw(e){this.error("[Kernel Exception]: "+e),this._eventHandler.dispatch(27)}}__decorate([inject],KernelIo.prototype,"_eventHandler",void 0);const ASSET_CACHE=new Map,SYNCED_CATALOGS=new Map,SYNCED_FLOORS_TAGS=new Map,SYNCED_TYPE_CHANGE_TAGS=new Map;class DataSyncer{constructor(e){this._bootCallbacks=[],this._isStarted=!1,this._isStarting=!1,this._alwaysUseCache=!1,this._creator_=e}start(e){return this._eventHandler.dispatch(79),this._startWorker().then(()=>this._handleCatalog(e)).then(()=>{const{typeChangeTag:e,floorMaterialsTag:t}=window.__RML__ENV__.initData;Promise.all([this._syncFloorTag(t),this._syncTypeChangeTag(e)]).then(()=>{SYNCED_TYPE_CHANGE_TAGS.set(e,!0),this._eventHandler.dispatch(80)})})}syncCatalog(e){return this._startWorker().then(()=>this._handleCatalog(e))}syncFloorTag(e){return this._startWorker().then(()=>this._syncFloorTag(e))}syncTypeChangeTag(e){return this._startWorker().then(()=>this._syncTypeChangeTag(e))}_syncFloorTag(e){const t=[];return e&&!SYNCED_FLOORS_TAGS.get(e)?(t.push(this._handleTags([e])),this._rapiAccess.getTag(e).then(e=>{t.push(this._handleMaterialsAndTextures(e))}),this._singlePromiseFactory.create(1,e,s=>{Promise.all(t).then(()=>{SYNCED_FLOORS_TAGS.set(e,!0),s()},e=>this._softReject(s,'_syncFloorTag error: "'+e+'"'))})):Promise.resolve()}_syncTypeChangeTag(e){const t=[];return e&&!SYNCED_TYPE_CHANGE_TAGS.get(e)?(t.push(this._handleTags([e])),this._rapiAccess.getTag(e).then(e=>{this._rapiAccess.getItems(e.items).then(e=>{e.forEach(e=>{this.getIsCatalogSynced(e.catalog)&&t.push(this._handleCatalog(e.catalog))})})}),this._singlePromiseFactory.create(2,e,s=>{Promise.all(t).then(()=>{SYNCED_FLOORS_TAGS.set(e,!0),s()},e=>this._softReject(s,'_syncTypeChangeTag error: "'+e+'"'))})):Promise.resolve()}getIsCatalogSynced(e){return!!SYNCED_CATALOGS.get(e)}_startWorker(){return new Promise((e,t)=>{if(this._isStarted)return e();this._bootCallbacks.push({resolve:e,reject:t}),this._isStarting||(this._worker=new Worker(getAssetPath()+"static/workers/asset-loader.worker.js"),this._mainThreadToWorker=new MainThreadToWorker(this,this._worker),this._isStarting=!0,this._mainThreadToWorker.sendToWorker(1))})}onCommand(e,t,s){switch(e){case 4:this._isStarted=!0,this._bootCallbacks.forEach(({resolve:e})=>e());break;case 3:this._mainThreadToWorker.resolvePromises(t,s)}}_handleCatalog(e){return this._singlePromiseFactory.create(0,e,t=>this.getIsCatalogSynced(e)?t():this._rapiAccess.getCatalog(e).then(e=>Promise.all([this._handleContentWithAssets(this._rapiAccess.getComponentsOf(e),["perspectiveImage"]),this._handleItemsAndAdditionalContents(e),this._handleMaterialsAndTextures(e),this._handleExternalMeshes(e),this._handleTags(e.tags)])).then(()=>{SYNCED_CATALOGS.set(e,!0),t()},e=>this._softReject(t,'Catalog sync error: "'+e+'"')))}_handleTags(e){return this._handleContentWithAssets(this._rapiAccess.getTags(e),["pngIcon","svgIcon"])}_handleExternalMeshes(e){return new Promise(t=>{this._rapiAccess.getMeshesOfCatalog(e.id).then(e=>{const s=[];e.forEach(e=>{s.push(this._handleContentWithAssets(Promise.all([this._rapiAccess.getMesh(e.id)]),["url"]))}),Promise.all(s).then(t,e=>this._softReject(t,'Sync crt files error: "'+e+'"'))},e=>this._softReject(t,'getMeshesOfCatalog error: "'+e+'"'))})}_handleItemsAndAdditionalContents(e){return new Promise((t,s)=>{this._rapiAccess.getItemsOf(e).then(e=>{const s=[];s.push(this._handleContentWithAssets(Promise.resolve(e),["perspectiveImage"])),this._rapiAccess.getAdditionalContentsOfItems(e).then(e=>{const t=e.filter(e=>-1!==[5,6,4].indexOf(e.type));s.push(this._handleContentWithAssets(Promise.resolve(t),["content"]))},e=>this._softReject(t,'getAdditionalContentsOfItems error: "'+e+'"')),Promise.all(s).then(t,e=>this._softReject(t,'AdditionalContent image sync error:"'+e+'"'))})})}_handleMaterialsAndTextures(e){return new Promise((t,s)=>{this._rapiAccess.getMaterialsOf(e).then(e=>{const s=[];s.push(this._handleContentWithAssets(Promise.resolve(e),["thumbnail"])),e.forEach(e=>{s.push(this._handleContentWithAssets(this._rapiAccess.getTexturesOf(e),["image"]))}),Promise.all(s).then(t,e=>this._softReject(t,'getTexturesOf error: "'+e+'"'))},e=>this._softReject(t,'getMaterialsOf error: "'+e+'"'))})}_handleContentWithAssets(e,t){return new Promise(s=>e.then(e=>this._fetchAssets(e,t).then(s,e=>this._softReject(s,'_handleContentWithAssets error: "'+e+'"')),e=>this._softReject(s,'_handleContentWithAssets promise error: "'+e+'"')))}_fetchAssets(e,t){const s=[];e||(e=[]);for(let i=0,n=e.length;i<n;i++){const n=e[i];t.forEach(e=>{const t=n[e];t&&s.push(this._preCacheAsset(t))})}return Promise.all(s)}_preCacheAsset(e){return new Promise(t=>{if(ASSET_CACHE.get(e))return t();this._assetUrlToBase64(e).then(s=>{ASSET_CACHE.set(e,s),t()},e=>this._softReject(t,'_preCacheAsset error: "'+e+'"'))})}_assetUrlToBase64(e){return new Promise(t=>{this._mainThreadToWorker.sendToWorker(5,e,t,e=>this._softReject(t,'_assetUrlToBase64 error: "'+e+'"'))})}_softReject(e,t){this._errorHandler.softReject(e,t,2)}requestAsset(e,t=!1){return navigator.onLine&&!this._alwaysUseCache?e:ASSET_CACHE.get(e)||(t?e:null)}setAlwaysUseCache(e){this._alwaysUseCache=e}}__decorate([inject],DataSyncer.prototype,"_rapiAccess",void 0),__decorate([inject],DataSyncer.prototype,"_eventHandler",void 0),__decorate([inject],DataSyncer.prototype,"_singlePromiseFactory",void 0),__decorate([inject],DataSyncer.prototype,"_errorHandler",void 0);class StaticItemLoader{loadGLB(e,t,s,i,n,a){return this._gltfLoader||(this._gltfLoader=new THREE.GLTFLoader),new Promise((o,r)=>{this._gltfLoader.load(e,e=>{o(this._handleGLTFScene("GLB",e,t,s,i,n,a))},e=>{},e=>{r(e)})})}loadGLTF(e,t,s,i,n,a){return this._gltfLoader||(this._gltfLoader=new THREE.GLTFLoader),new Promise((o,r)=>{this._gltfLoader.parse(e,null,e=>{o(this._handleGLTFScene("GLTF",e,t,s,i,n,a))},e=>{},e=>{r(e)})})}_handleGLTFScene(e,t,s,i,n,a,o){if(!t||!t.scene||!t.scene.children||0===t.scene.children.length)return null;if(s&&t.scene.position.copy(s),i&&(t.scene.rotation.y=i),n){const e=new THREE.Box3;e.setFromObject(t.scene);const{x:s,y:i,z:a}=e.getSize(new THREE.Vector3);let o=new THREE.Vector3(n.x/s,n.y/i,n.z/a);t.scene.scale.copy(o)}return t.scene.type="GLB",t.scene.traverse(e=>{if(e instanceof THREE.Mesh){if(e.material instanceof THREE.MeshStandardMaterial){let t=e.material;if(t.envMap=this._environmentLoader.getEnvironmentMap(),o&&a&&a>0){let e=new THREE.Color(a);t.color=e.copyGammaToLinear(e),t.roughness=.5,t.metalness=.1}t.needsUpdate=!0}e.castShadow=!0}}),t.scene}}__decorate([inject],StaticItemLoader.prototype,"_environmentLoader",void 0);class ThreeLoader{constructor(e){this._jsonLoaded=!1,this._creator_=e}_loadShaders(){return new Promise((e,t)=>{if(this._jsonLoaded)return e();this._networkLayer.fetch(getAssetPath()+"static/three/lib/shaders.json").then(handleJsonResponse,t).then(t=>{window._rsl=t,this._jsonLoaded=!0,e()},t)})}fetch(){return window._rsl||(window._rsl={}),new Promise((e,t)=>this._loadShaders().then(()=>{this._scriptLoader.fetch("static/three/lib/rthree.js",{id:"three-lib"}).then(e,t)},t))}}__decorate([inject],ThreeLoader.prototype,"_scriptLoader",void 0),__decorate([inject],ThreeLoader.prototype,"_networkLayer",void 0);const DEFAULT_STORE="rml_default",DEFAULT_STORE_SIZE=5;class LocalStorageHelper{constructor(e){this._context_=e}getStore(e=DEFAULT_STORE){return this._localStorage.getItem(e)||{entries:[]}}saveStore(e,t){this._localStorage.setItem(e,t)}addItem(e,t,s=DEFAULT_STORE,i=DEFAULT_STORE_SIZE){const n=this.getStore(s),a=n.entries.find(t=>t.id===e);if(a?(a.payload=t,a.date=Date.now()):n.entries.push({id:e,date:Date.now(),payload:t}),n.entries.length>i)for(n.entries.sort((e,t)=>t.date-e.date);n.entries.length>i;)n.entries.pop();this.saveStore(s,n)}getItem(e,t=DEFAULT_STORE){const s=this.getStore(t).entries.find(t=>t.id===e);return s?s.payload:null}}__decorate([inject],LocalStorageHelper.prototype,"_localStorage",void 0);class DynamicQualitySettingLoader{set(e,t){t&&(void 0!==t.enableAA&&(e.enableAA=t.enableAA),this._setSAOPass(e,t),this._setShadowPass(e,t),this._setGroundShadow(e,t))}_setSAOPass(e,t){if(t.SAOPass){const s=t.SAOPass;void 0!==s.enabled&&(e.getSAOPass().enabled=s.enabled),void 0!==s.smoothTransition&&(e.getSAOPass().smoothTransition=s.smoothTransition),s.occlusionWorldRadius&&(e.getSAOPass().occlusionWorldRadius=s.occlusionWorldRadius),s.intensity&&(e.getSAOPass().intensity=s.intensity),s.bias&&(e.getSAOPass().bias=s.bias),s.numSamples&&(e.getSAOPass().numSamples=s.numSamples)}}_setShadowPass(e,t){if(t.shadowPass){const s=t.shadowPass;void 0!==s.enabled&&(e.getShadowPass().enabled=s.enabled),void 0!==s.smoothTransition&&(e.getShadowPass().smoothTransition=s.smoothTransition),void 0!==s.enableAccumulation&&(e.getShadowPass().enableAccumulation=s.enableAccumulation),s.shadowRadius&&(e.getShadowPass().shadowRadius=s.shadowRadius),s.shadowBiasMultiplier&&(e.getShadowPass().shadowBiasMultiplier=s.shadowBiasMultiplier),s.numSamples&&(e.getShadowPass().numSamples=s.numSamples)}}_setGroundShadow(e,t){if(t.groundShadow){const s=t.groundShadow;void 0!==s.enable&&(e.getShadowPlanePass().enable=s.enable),void 0!==s.smoothTransition&&(e.getShadowPlanePass().smoothTransition=s.smoothTransition),s.numSamples&&(e.getShadowPlanePass().numSamples=s.numSamples),s.numSamplesPerFrame&&(e.getShadowPlanePass().numSamplesPerFrame=s.numSamplesPerFrame)}}}const toRadiant=function(e){return e*(Math.PI/180)},getIdealDistance=function(e,t,s,i,n,a){let o=Math.tan(i*(2*Math.PI/360)/2),r=s/2,h=t/2/o+r,_=e/2/(n/a)/o+r;return Math.max(h,_)},round=function(e){return Math.round(1e3*e)/1e3},getDelta=function(e,t){return Math.abs(e.y-t.y)+Math.abs(e.x-t.x)},PREVIEW_MATERIAL_OPACITY=.6,PREVIEW_LINE_MATERIAL_OPACITY=.4,PREVIEW_MATERIAL_COLOR="#DDDDDD",PREVIEW_MATERIAL_ROUGHNESS=1,PREVIEW_MATERIAL_METALNESS=.5,getScreenXY=(e,t,s,i)=>{if(!e||!t||0===s||0===i)return new THREE.Vector3;let n=e.clone(),a=s/2,o=i/2;return n.project(t),n.x=n.x*a+a,n.y=-n.y*o+o,n.z=0,n},kernelBoxToThreeBox=(e,t)=>{t||(t=new THREE.Vector3(0,0,0));let s=new THREE.Vector3(e.size.x/1e3,e.size.z/1e3,e.size.y/1e3),i=new THREE.Vector3(e.origin.x/1e3,e.origin.z/1e3,e.origin.y/-1e3),n=new THREE.Vector3(0,0,-s.z).add(i).sub(t),a=new THREE.Vector3(s.x,s.y,0).add(i).add(t);return new THREE.Box3(n,a)},setShadows=(e,t,s)=>{e.castShadow=s,e.receiveShadow=t,e.children.forEach(e=>{setShadows(e,t,s)})},position3VectorsAreEqual=(e,t)=>{let s=round(e.x),i=round(e.y),n=round(e.z),a=round(t.x),o=round(t.y),r=round(t.z);return s===a&&i===o&&n===r},rotationQuaternionsAreEqual=(e,t)=>{let s=round(e.w),i=round(e.x),n=round(e.y),a=round(e.z),o=round(t.w),r=round(t.x),h=round(t.y),_=round(t.z);return s===o&&i===r&&n===h&&a===_},position2VectorsAreEqual=(e,t)=>{let s=round(e.x),i=round(e.y),n=round(t.x),a=round(t.y);return s===n&&i===a},createMaterial=(e,t)=>{let s=new THREE.MeshPhysicalMaterial({metalness:e.shading.metallic,reflectivity:e.shading.specularity||.5,roughness:e.shading.roughness||.5,transparent:e.shading.alpha<1,opacity:e.shading.alpha,depthWrite:e.shading.alpha>=1});if(e.shading.basecolor){const t=new THREE.Color("rgb("+Math.round(100*e.shading.basecolor.r)+"%, "+Math.round(100*e.shading.basecolor.g)+"%, "+Math.round(100*e.shading.basecolor.b)+"%)");s.color=t.copyGammaToLinear(t)}return t&&(s.envMap=t),e.shading.doubleSided?s.side=THREE.DoubleSide:s.side=THREE.FrontSide,e.shading.alphaCutoff?s.alphaTest=e.shading.alphaCutoff:s.alphaTest=0,s},addTexture=(e,t,s,i,n,a)=>new Promise((o,r)=>{(new THREE.TextureLoader).load(e,e=>{e.anisotropy=i,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e.repeat.set(n,a),"XYZ"===t.mapping?s.normalMap=e:s.map=e,"RGBA"===t.mapping&&(s.transparent=!0),o()},r)}),getGUI=()=>(window.__RML_GUI__||(window.__RML_GUI__=new dat.GUI),window.__RML_GUI__),setWallTransparencyBasedOnCamera=(e,t,s=!0)=>{let i=e.getWorldDirection(new THREE.Vector3),n=Math.abs(i.y);n<.5&&!t.transparent&&setWallTransparency(t,!0,s),n>.5&&t.transparent&&setWallTransparency(t,!1,s)},setWallTransparency=(e,t,s=!0)=>{if(!e.userData.tween)if(t)if(e.transparent=!0,s){let t={opacity:1};e.userData.tween=!0,new TWEEN.Tween(t).to({opacity:.2},400).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{e.opacity=t.opacity}).onComplete(()=>{e.userData.tween=!1}).start()}else e.opacity=.2;else if(s){let t={opacity:.2};e.userData.tween=!0,new TWEEN.Tween(t).to({opacity:1},400).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{e.opacity=t.opacity}).onComplete(()=>{e.transparent=!1,e.userData.tween=!1}).start()}else e.opacity=1,e.transparent=!1},getColorFromInt=e=>{let t=new THREE.Color;return t.setRGB((e>>16)/255,(e>>8&255)/255,(e>>0&255)/255),t.copyGammaToLinear(t),t},fadeIn=e=>{e.traverse(e=>{if(e instanceof THREE.Mesh&&TWEEN){let t=e.material;if(0===t.opacity)return;let s={opacity:0,transparent:!0},i={opacity:t.opacity,transparent:t.transparent};t.transparent=s.transparent,t.opacity=s.opacity,new TWEEN.Tween(s).to(i,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{t.opacity=s.opacity}).onComplete(()=>{t.transparent=i.transparent}).start()}})},checkGLB=(e,t)=>{let s=(new THREE.Box3).setFromObject(e),i=s.getSize(new THREE.Vector3),n=Math.min(i.x,i.y,i.z),a=!0;return n>5&&(console.warn("GLB seems to be too big ("+n+")",t),a=!1),s.min.y<-.01&&(console.warn("GLB seems to be under the floor ("+s.min.y+"): ",t),a=!1),a},dispose=e=>{"Mesh"===e.type?disposeMesh(e):disposeObject(e)},disposeObject=e=>{e&&e.children&&0!==e.children.length&&e.children.forEach(e=>{disposeMesh(e)})},disposeMesh=e=>{e&&(e.material&&disposeMaterial(e.material),e.geometry&&disposeGeometry(e.geometry))},disposeGeometry=e=>{e&&e.dispose()},disposeMaterial=e=>{e&&(e.map&&e.map.dispose(),e.normalMap&&e.normalMap.dispose(),e.dispose())};let boundingBoxMaterial;const getBoundingBoxMaterial=()=>(boundingBoxMaterial||((boundingBoxMaterial=new THREE.MeshBasicMaterial).visible=!1),boundingBoxMaterial),getSelectionGeometry=(e,t)=>{let s=t.x/2,i=t.z/2,n=new THREE.Vector3(-s,.01,i),a=[n,new THREE.Vector3(n.x,n.y,n.z+.2),new THREE.Vector3(n.x-.2,n.y,n.z+.2),new THREE.Vector3(n.x-.2,n.y,n.z)],o=[new THREE.Face3(3,2,0),new THREE.Face3(2,1,0)],r=new THREE.Geometry;return r.vertices.push(...a),r.faces.push(...o),r.computeFaceNormals(),r.computeVertexNormals(),r},vectorIsZero=e=>0===e.x&&0===e.y&&0===e.z,INJECTABLES=[new DependencyInjectionAssignment("event-handler",class{constructor(){this._listeners={},this._providers={}}_subscribe(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}subscribe(e,t){this._subscribe(e,t)}dispatch(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++){const i=s[e];i.apply(i,t)}}request(e,t){return"function"==typeof this._providers[e]?this._providers[e].apply(this._providers[e],t):new Promise((t,s)=>s("No one provides data for: "+e))}provide(e,t){this._providers[e]||(this._providers[e]=t)}unsubscribe(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++)if(s[e]===t)return s.splice(e,1),i--,void e--}}),new DependencyInjectionAssignment("error-handler",class{constructor(){this._listeners={}}_subscribe(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}subscribe(e,t){this._subscribe(e,t)}dispatch(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++){const i=s[e];i.apply(i,t)}}unsubscribe(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++)if(s[e]===t)return s.splice(e,1),i--,void e--}softReject(e,t,s){return this.dispatch(s,[t]),e()}}),new DependencyInjectionAssignment("form-data-util",FormDataUtil),new DependencyInjectionAssignment("environment-loader",class{getEnvironmentMap(){if(!this._environmentMap){let e=new THREE.CubeTextureLoader;e.setPath(getAssetPath()),this._environmentMap=e.load(["static/textures/blurred/px.jpg","static/textures/blurred/nx.jpg","static/textures/blurred/py.jpg","static/textures/blurred/ny.jpg","static/textures/blurred/pz.jpg","static/textures/blurred/nz.jpg"]),this._environmentMap.wrapS=THREE.RepeatWrapping,this._environmentMap.wrapT=THREE.RepeatWrapping,this._environmentMap.generateMipmaps=!0}return this._environmentMap}}),new DependencyInjectionAssignment("static-item-loader",StaticItemLoader,0),new DependencyInjectionAssignment("form-data-util",FormDataUtil),new DependencyInjectionAssignment("single-promise-factory",class{constructor(e){this._promises=new Map,this._creator_=e}create(e,t,s){return new Promise((i,n)=>{let a=this._promises.get(e),o=!0;if(!a){const t=new Map;this._promises.set(e,t),a=this._promises.get(e),o=!1}a.get(t)||(a.set(t,[]),o=!1);const r=a.get(t);r.push({resolve:i,reject:n}),a.set(t,r);const h=()=>{a.delete(t),0===a.size&&this._promises.delete(e)};o||new Promise(s).then(e=>{a.get(t).forEach(({resolve:t})=>t(e)),h()},e=>{a.get(t).forEach(({reject:t})=>t(e)),h()})})}},1),new DependencyInjectionAssignment("dynamic-light-setting-loader",DynamicLightSettingLoader),new DependencyInjectionAssignment("dynamic-quality-setting-loader",DynamicQualitySettingLoader),new DependencyInjectionAssignment("network-layer",NetworkLayer),new DependencyInjectionAssignment("local-storage",class{constructor(e){this._context_=e}get _localStorage(){let e=null;try{e=window.localStorage}catch(e){console.error(e)}return e}getItem(e){if(!this._localStorage)return null;const t=this._localStorage.getItem(e);try{return JSON.parse(t)}catch(e){return t}}setItem(e,t){if(this._localStorage)try{const s=JSON.stringify(t);this._localStorage.setItem(e,s)}catch(e){console.error(e)}}}),new DependencyInjectionAssignment("network-layer",NetworkLayer),new DependencyInjectionAssignment("kernel-io",KernelIo),new DependencyInjectionAssignment("data-syncer",DataSyncer),new DependencyInjectionAssignment("memory-manager",class{constructor(){this._configurationStringSet=new Set,this._singleLoadCounter=0}loadingConfigurationString(){this._singleLoadCounter+=1}loadingConfiguration(e){this._configurationStringSet.add(e),this._singleLoadCounter+=1}shouldHardReset(){return this._configurationStringSet.size>=15||this._singleLoadCounter>=30}executedHardReset(){this._configurationStringSet.clear(),this._singleLoadCounter=0}}),new DependencyInjectionAssignment("life-cycle-manager",class{constructor(){this._listeners=[]}addEventListener(e){this._listeners.push(e)}removeEventListener(e){const t=this._listeners;let s=t.length;if(s)for(let i=0;i<s;i++)t[i]===e&&(t.splice(i,1),i--,s--)}pause(){this._listeners.forEach(e=>e.pause())}resume(){this._listeners.forEach(e=>e.resume())}destroy(){this._listeners.forEach(e=>e.destroy())}},1),new DependencyInjectionAssignment("three-loader",ThreeLoader),new DependencyInjectionAssignment("local-storage-helper",LocalStorageHelper),new DependencyInjectionAssignment("cache-holder",class{constructor(){this._geometryCache=new Map,this._materialCache=new Map}get geometryCache(){return this._geometryCache}get materialCache(){return this._materialCache}clear(){for(const e of this._materialCache.values())disposeMaterial(e);for(const e of this._geometryCache.values())disposeGeometry(e);this._geometryCache.clear(),this._materialCache.clear()}},0)];class RoomleDependencyInjection{static setup(e){RoomleDependencyInjection.addToContainer(e)}static lookup(e,t){return window.__RML__DI__?window.__RML__DI__.lookup(e,t):null}static getContext(e){return window.__RML__DI__?window.__RML__DI__.getContext(e):null}static cleanUp(e){return window.__RML__DI__?window.__RML__DI__.cleanUp(e):null}static addToContainer(e){window.__RML__DI__||(window.__RML__DI__=new Container,window.__RML__DI__.addDependencyInjectionAssignments(INJECTABLES)),window.__RML__DI__.addDependencyInjectionAssignments(e)}}const isInIframe=()=>{try{return window.self!==window.top}catch(e){return!0}};class Main{constructor(e){this._context=e}_setupCommonGlobals(){window.__RML__DEBUG__||(window.__RML__DEBUG__={}),window.__RML__ENV__||(window.__RML__ENV__={},window.__RML__ENV__.assetPath||(window.__RML__ENV__.assetPath=""));const e={retina:!1,overrideCountry:null,locale:AppContext.actualLocale,unit:null,unitStringType:null,dls:null,ls:null,meshSelection:!0,colors:ROOMLE_COLORS,enableHSC:!1,mode:"3D",stats:!1,_measureTraffic:!1,enableHD:!isInIframe()};window.__RML__ENV__.initData?window.__RML__ENV__.initData=Object.assign(e,window.__RML__ENV__.initData):window.__RML__ENV__.initData=e;const t=getAllParameters();window.__RML__ENV__.initData=Object.assign(window.__RML__ENV__.initData,t)}_setupCommonDependencies(){}_cleanUpCommonGlobals(){window.__RML__DEBUG__&&(window.__RML__DEBUG__.Kernel&&window.__RML__DEBUG__.Kernel.clearAll&&window.__RML__DEBUG__.Kernel.clearAll(),delete window.__RML__DEBUG__),delete window.__RML__ENV__;for(const e in window.THREE)if(window.THREE.hasOwnProperty(e))try{delete window.THREE[e]}catch(e){console.error(e)}window.THREE=void 0}_cleanUpCommonDependencies(){}boot(e){this._setupCommonGlobals(),this.setupGlobals(e),this._setupCommonDependencies(),this.setupDependencies(),this.bootFinished()}lookup(e,t){return window.__RML__DI__.lookup(e,t)}teardown(){this.cleanUpDependencies(),this._cleanUpCommonDependencies(),this.cleanUpGlobals(),this._cleanUpCommonGlobals(),window.__RML__DI__&&delete window.__RML__DI__}pause(){this.lookup("life-cycle-manager",this._context).pause(),window.TWEEN&&TWEEN.removeAll()}resume(e){e&&this.lookup("dom-helper",this._context).setDomElement(e),this.lookup("life-cycle-manager",this._context).resume()}destroy(){this.pause(),this.lookup("life-cycle-manager",this._context).destroy(),RoomleDependencyInjection.cleanUp(this._context)}}const CANVAS_ID={HSC:"rml-hsc",HSP:"rml-hsp",GLB:"rml-glb"},CONTAINER_CSS_CLASS="rml-threejs-canvas-container";class DomHelper{constructor(e){this._creator_=e,this._lifeCycleManager.addEventListener(this)}get element(){return this._container}setDomElement(e){if(!this._container){this._container=document.createElement("div"),this._container.classList.add(CONTAINER_CSS_CLASS),this._container.style.position="relative",this._container.style.width="100%",this._container.style.height="100%";const t=document.createElement("style");t.innerText="."+CONTAINER_CSS_CLASS+" canvas{position:absolute;top:0;left:0;right:0;bottom:0;}."+CONTAINER_CSS_CLASS+" .foreground{z-index:100; opacity:1;}."+CONTAINER_CSS_CLASS+" .background{z-index:-1; opacity:0;}",this._container.appendChild(t),e.appendChild(this._container)}this._element=e}getClientDimensions(){return new THREE.Vector2(this._element.clientWidth,this._element.clientHeight)}_removeDomElement(e){if(!e)return;const t=e.parentElement;t&&t.removeChild(e)}reset(){this._element=null,this._removeDomElement(this._container),this._container=null}pause(){this.reset()}resume(){}destroy(){}}__decorate([inject],DomHelper.prototype,"_lifeCycleManager",void 0);class EventDispatcher{constructor(){this._listeners={}}_addEventListener(e,t,s){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push({callback:t,scope:s})}addEventListener(e,t,s){this._addEventListener(e,t,s)}dispatchEvent(e,t){if(!this._listeners[e])return;const s=this._listeners[e];let i=s.length;for(let e=0;e<i;e++){const i=s[e];i.callback.apply(i.scope,[t])}}removeEventListener(e,t){const s=this._listeners[e];if(s)for(let e=0,i=s.length;e<i;e++)if(s[e].callback===t)return void s.splice(e,1)}}const INITIAL_CAMERA_DISTANCE=-1;class CameraControl extends EventDispatcher{constructor(e,t,s){super(),this._tweenEnd=null,this._pitch=toRadiant(10),this._yaw=toRadiant(-15),this._distance=INITIAL_CAMERA_DISTANCE,this._locked=!1,this._inputListeners=[],this._creator_=e,this._inputManager=t,this._initInputListener(),this._addInputListeners(),this._cameraPosition=new THREE.Vector3,this._targetPosition=new THREE.Vector3,s?this._cameraPosition.copy(s):this._cameraPosition=new THREE.Vector3(0,.5,3);let i=this._domHelper.getClientDimensions();this._width=i.x,this._height=i.y}getCamera(){return this._getCamera()}_addInputListeners(){this._inputListeners.forEach(e=>{this._inputManager.addEventListener(e.key,e.fun,this)})}_removeInputListeners(){this._inputListeners.forEach(e=>{this._inputManager.removeEventListener(e.key,e.fun)}),this._inputListeners=[]}cleanUp(){this._removeInputListeners()}animateCamera(e){let t=this._cameraPosition;if(!t||position3VectorsAreEqual(t,this.getCamera().position))return!1;let s=this.getCamera().position.clone(),i=Math.min(10*e,1);return s.lerp(t,i),this.getCamera().position.copy(s),!0}_areEqual(e,t){return e.yaw.toFixed(5)===t.yaw.toFixed(5)&&e.pitch.toFixed(5)===t.pitch.toFixed(5)&&e.distance.toFixed(5)===t.distance.toFixed(5)&&e.targetX===t.targetX&&e.targetY===t.targetY&&e.targetZ===t.targetZ}_tweenCameraParameter(e,t,s){return new Promise(s=>{if(t.yaw-e.yaw<=-Math.PI?e.yaw-=2*Math.PI:t.yaw-e.yaw>=Math.PI&&(e.yaw+=2*Math.PI),window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=t,new TWEEN.Tween(e).to(t,400).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._update(new THREE.Vector3(e.targetX,e.targetY,e.targetZ))}).onComplete(()=>{this._tweenEnd=null,s()}).start()}})}_getCurrentCameraParameters(){let e=this._targetPosition.clone();return{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:e.x,targetY:e.y,targetZ:e.z}}_rotateHorizontal(e){this._yaw-=e,this._yaw<-Math.PI?this._yaw+=2*Math.PI:this._yaw>Math.PI&&(this._yaw-=2*Math.PI)}_rotateVertical(e){this._pitch+=e,this._pitch<-Math.PI?this._pitch+=2*Math.PI:this._pitch>Math.PI&&(this._pitch-=2*Math.PI)}saveState(e){if(e||!this._stateSaved){let e=this._yaw,t=this._pitch,s=this._distance,i=this._targetPosition.clone();if(this._stateSaved={yaw:e,pitch:t,distance:s,targetX:i.x,targetY:i.y,targetZ:i.z,blockOtherTweens:!0},this._getCamera().fov){let e=this._getCamera();this._stateSaved.fov=e.fov,this._stateSaved.near=e.near,this._stateSaved.far=e.far}return this._stateSaved}return null}resetToState(){if(this._stateSaved){this._stateSaved.blockOtherTweens=!1;let e=this._targetPosition.clone();this._tweenCameraParameter({yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:e.x,targetY:e.y,targetZ:e.z},this._stateSaved,!0)}this._stateSaved=null}setToState(e,t){this._tweenCameraParameter(e,t,!0)}hasSavedState(){return null!=this._stateSaved}lock(){this._locked=!0}unlock(){this._locked=!1}getTargetPosition(){return this._targetPosition}_saveYawAndPitch(){this._getCamera().userData.yaw=this._yaw,this._getCamera().userData.pitch=this._pitch}}__decorate([inject],CameraControl.prototype,"_domHelper",void 0);class ZoomChangeEvent{constructor(e,t){this.minZoom=!1,this.maxZoom=!1,this.minZoom=e,this.maxZoom=t}}const ROTATION_SPEED=1,ZOOM_SPEED=4,MAX_DISTANCE_MINIMAL=4,DISTANCE_FACTOR=2.725,MAX_POLAR_ANGLE=85;class CameraControl3D extends CameraControl{constructor(e,t,s,i){super(e,t,s),this._bounds=new THREE.Vector3,this._scale=1,this._state=0,this._zoomSpeed=Math.pow(.95,ZOOM_SPEED),this.minDistance=0,this.maxDistance=5,this.minPolarAngle=toRadiant(0),this.maxPolarAngle=toRadiant(MAX_POLAR_ANGLE),this.minAzimuthAngle=Number.NEGATIVE_INFINITY,this.maxAzimuthAngle=Number.POSITIVE_INFINITY,this._currentZoomHash="",i?this._camera=i:this._initCamera(),this._targetPosition=new THREE.Vector3(0,0,0);let{cameraRestriction:n,minVerticalCameraAngle:a,maxVerticalCameraAngle:o,minHorizontalCameraAngle:r,maxHorizontalCameraAngle:h}=window.__RML__ENV__.initData;if(void 0!==a&&(this.minPolarAngle=toRadiant(a<0?a:-1*a)),void 0!==o&&(this.maxPolarAngle=toRadiant(o)),void 0!==r&&(this.minAzimuthAngle=toRadiant(r<0?r:-1*r)),void 0!==h&&(this.maxAzimuthAngle=toRadiant(h)),void 0!==n){let e=Math.abs(toRadiant(n));this.minAzimuthAngle=-e,this.maxAzimuthAngle=e,this.maxPolarAngle=Math.min(e,toRadiant(MAX_POLAR_ANGLE))}}_getCamera(){return this._camera?this._camera:(this._initCamera(),this._camera)}_initCamera(){this._camera=new THREE.PerspectiveCamera,this._camera.fov=30,this._camera.aspect=this._width/this._height,this._camera.near=.1,this._camera.far=100,this._camera.updateProjectionMatrix(),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();this._camera.aspect=e/t,this._camera.updateProjectionMatrix()}animateCamera(e){if(!super.animateCamera(e))return!1;let t=this._targetPosition;return!!t&&(this.getCamera().lookAt(t),!0)}_initInputListener(){this._inputListeners.push({key:3,fun:e=>{this._state=1}}),this._inputListeners.push({key:6,fun:e=>{1!==this._state||this._locked||this._move(new THREE.Vector2(e.position.x,e.position.y))}}),this._inputListeners.push({key:4,fun:e=>{1===this._state&&this.dispatchEvent(2),this._state=0,this._orbitPosition=null}}),this._inputListeners.push({key:7,fun:e=>this.zoomIn()}),this._inputListeners.push({key:8,fun:e=>this.zoomOut()})}_move(e){this._orbitPosition||(this._orbitPosition=new THREE.Vector2(e.x,e.y),this.dispatchEvent(0));let t=e.clone().sub(this._orbitPosition),s=this._domHelper.element;this._rotateHorizontal(2*Math.PI*t.x/s.clientWidth*ROTATION_SPEED),this._rotateVertical(2*Math.PI*t.y/s.clientHeight*ROTATION_SPEED),position2VectorsAreEqual(this._orbitPosition,e)||this.dispatchEvent(1),this._orbitPosition.copy(e),this._update()}setBounds(e){let t=new THREE.Vector3(-e.x/2,0,-e.z/2),s=new THREE.Vector3(e.x/2,e.y,e.z/2);this._boundingBox=new THREE.Box3(t,s)}updateToBounds(e,t,s,i,n=!0,a){this._boundingBox=e;let o=e.getSize(new THREE.Vector3);const r=e.getCenter(new THREE.Vector3);this._targetPosition=a?a.clone():new THREE.Vector3(r.x,r.y,r.z);const h=this._setDistanceAndRangesBasedOnBounds(o,t,s);this._distance===INITIAL_CAMERA_DISTANCE?(this._distance=Math.max(MAX_DISTANCE_MINIMAL,h),this._update()):n&&this._tweenCameraParameter(this._getCurrentCameraParameters(),{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:this._targetPosition.x,targetY:this._targetPosition.y,targetZ:this._targetPosition.z},i)}_setDistanceAndRangesBasedOnBounds(e,t,s){this._bounds.copy(e),this.minDistance=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);let i=1.1*getIdealDistance(e.x,e.y,e.z,this._camera.fov,t,s);return this._distance<i&&(this._distance=i),this.maxDistance=1.5*i,this.maxDistance=Math.min(this.maxDistance,i+6),this.maxDistance<MAX_DISTANCE_MINIMAL&&(this.maxDistance=MAX_DISTANCE_MINIMAL),this._camera.far=5*this.maxDistance,i}reset(e,t,s,i,n,a,o=!0){if(e){i?this._targetPosition.copy(i):this._targetPosition=new THREE.Vector3(0,e.y/2,0);let r=this._getCurrentCameraParameters();n||(n=-15),a||(a=10),this._pitch=toRadiant(a),this._yaw=toRadiant(n),this._setDistanceAndRangesBasedOnBounds(e,t,s);let h=this._targetPosition.clone();this._areEqual(r,{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:h.x,targetY:h.y,targetZ:h.z})?this._moveCameraForthAndBack():o?this._tweenCameraParameter(r,{yaw:this._yaw,pitch:this._pitch,distance:this.maxDistance,targetX:h.x,targetY:h.y,targetZ:h.z},!0):this._update(this._targetPosition)}else console.warn("you cant reset without bounds!")}updateAndReset(e,t,s,i,n,a,o,r=!0){let h=new THREE.Vector3(-e.x/2,0,-e.z/2),_=new THREE.Vector3(e.x/2,e.y,e.z/2);if(this._boundingBox=new THREE.Box3(h,_),o&&e.addScalar(o),i?this._targetPosition.copy(i):this._targetPosition=new THREE.Vector3(0,e.y/2,0),this._distance===INITIAL_CAMERA_DISTANCE){let i=this._setDistanceAndRangesBasedOnBounds(e,t,s);this._distance=Math.max(MAX_DISTANCE_MINIMAL,i)}let l=this._getCurrentCameraParameters();n||(n=-15),a||(a=10),this._pitch=toRadiant(a),this._yaw=toRadiant(n),this._setDistanceAndRangesBasedOnBounds(e,t,s);let c=this._targetPosition.clone();r?this._tweenCameraParameter(l,{yaw:this._yaw,pitch:this._pitch,distance:this.maxDistance,targetX:c.x,targetY:c.y,targetZ:c.z},!0):this._update(this._targetPosition)}_moveCameraForthAndBack(){if(window.TWEEN){let e={value:.6*this._camera.far},t={value:this._distance};new TWEEN.Tween(e).to(t,300).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{this._distance=e.value,this._update()}).start()}}_restoreFromState(e){this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._targetPosition.copy(new THREE.Vector3(e.targetX,e.targetY,e.targetZ)),this._simulateUpdate()}simulateTo2D(e,t){return new Promise(s=>{let i=Math.max(e.x,e.z),n=getIdealDistance(i,i,i,this._camera.fov,window.innerWidth,window.innerHeight),a=this._getCurrentCameraParameters();this._camera.near=1,this._camera.far=n+50,this._camera.updateProjectionMatrix();let o={yaw:0,pitch:toRadiant(90),distance:n,targetX:t.x,targetY:n,targetZ:t.z};if(window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=o,new TWEEN.Tween(a).to(o,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(()=>{this._yaw=a.yaw,this._pitch=a.pitch,this._distance=a.distance,this._targetPosition.copy(new THREE.Vector3(a.targetX,0,a.targetZ)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,s()}).start()}})}simulateTo3D(e,t){return new Promise(s=>{if(this._restoreFromState(e),window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=t,new TWEEN.Tween(e).to(t,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._targetPosition.copy(new THREE.Vector3(e.targetX,e.targetY,e.targetZ)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,s()}).start()}})}simulateToFirstPerson(e){return new Promise(t=>{if(window.TWEEN){let s=this.getCamera().position,i={x:s.x,y:s.y,z:s.z,yaw:this._yaw,pitch:this._pitch},n={x:e.x,y:e.y,z:e.z,yaw:0,pitch:0};new TWEEN.Tween(i).to(n,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{this._yaw=i.yaw,this._pitch=i.pitch,this._targetPosition.copy(new THREE.Vector3(i.x,i.y,i.z)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,t()}).start()}})}_update(e){this._yaw=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,this._yaw)),this._pitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._pitch)),this._saveYawAndPitch();let t=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX"),s=(new THREE.Quaternion).setFromEuler(t),i=new THREE.Vector3(0,0,-1);i.applyQuaternion(s),this._distance*=this._scale,this._distance=Math.min(this.maxDistance,this._distance),e&&this._targetPosition.copy(e);let n=this._targetPosition.clone().sub(i.multiplyScalar(this._distance)),a=this._getCameraSphere(n);null!=this._boundingBox&&this._boundingBox.intersectsSphere(a)&&this._scale>=1?this._distance+=.1:null==this._boundingBox||this._boundingBox.intersectsSphere(a)?this._zoomChanged(!1,!0):(this._cameraPosition.copy(n),this._distance===this.maxDistance?this._zoomChanged(!0,!1):this._zoomChanged(!1,!1)),this._scale=1}_zoomChanged(e,t){let s=e+""+t;0!==this._currentZoomHash.length&&this._currentZoomHash===s||(this.dispatchEvent(5,new ZoomChangeEvent(e,t)),this._currentZoomHash=s)}_simulateUpdate(){let e=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX"),t=(new THREE.Quaternion).setFromEuler(e),s=new THREE.Vector3(0,0,-1);s.applyQuaternion(t),this._cameraPosition.copy(this._targetPosition.clone().sub(s.multiplyScalar(this._distance)))}zoomTo(e,t,s,i,n,a){return this._tweenCameraParameter(this._getCurrentCameraParameters(),{yaw:i,pitch:n,distance:getIdealDistance(e.x,e.y,e.z,this._camera.fov,t,s)*DISTANCE_FACTOR,targetX:a.x,targetY:a.y,targetZ:a.z,blockOtherTweens:!0},!0)}_getCameraSphere(e){return new THREE.Sphere(e,.1)}zoomIn(e){this._scale*=e?Math.pow(.95,e):this._zoomSpeed,this._update(),this.dispatchEvent(3)}zoomOut(e){this._scale/=e?Math.pow(.95,e):this._zoomSpeed,this._update(),this.dispatchEvent(4)}}class LightSetting{constructor(e,t){this._scene=e,t&&t.removeFromScene()}}class DynamicLightSetting extends LightSetting{constructor(e,t){super(e,t),this._lights=[]}loadFromJSON(e){return new Promise((t,s)=>{this._lights=this._dynamicLightSettingLoader.parse(e),this.addToScene(),t()})}loadFromObject(e){return new Promise((t,s)=>{e.lights||t(),this._lights=this._dynamicLightSettingLoader.load(e),this._lights.filter((e,t)=>{e.userData.movesWithCamera&&(this._cameraLight=e,this._lights.splice(t,1))}),this.addToScene(),t()})}loadFromURL(e){return new Promise((t,s)=>{fetch(new Request(e,{method:"GET"})).then(handleJsonResponse).then(e=>this.loadFromObject(e).then(t,s))})}addToScene(){this._lights.forEach(e=>{this._scene.add(e)}),this._cameraLight&&(this._cameraLight.castShadow=!1,this._scene.add(this._cameraLight))}removeFromScene(){this._lights.forEach(e=>{this._scene.remove(e)}),this._cameraLight&&this._scene.remove(this._cameraLight)}reload(){this.removeFromScene(),this.addToScene()}update(e,t){if(!this._cameraLight)return;let s=e.userData.yaw,i=e.userData.pitch,n=new THREE.Euler(-i,s,0,"ZYX"),a=(new THREE.Quaternion).setFromEuler(n),o=new THREE.Vector3(0,0,-1);o.applyQuaternion(a);let r=this._cameraLight.position.distanceTo(t),h=t.clone().sub(o.multiplyScalar(r));this._cameraLight.position.copy(h),this._cameraLight.lookAt(t)}showGUI(){let e=getGUI();this._cameraLight&&this._addToGUI(e,this._cameraLight),this._lights.forEach(t=>{this._addToGUI(e,t)})}_addToGUI(e,t){t instanceof THREE.SpotLight&&this._addSpotLightToGUI(e,t),t instanceof THREE.AmbientLight&&this._addAmbientLightToGUI(e,t),t instanceof THREE.RectAreaLight&&this._addRectAreaLightToGUI(e,t)}_addRectAreaLightToGUI(e,t){let s=e.addFolder(t.name),i={name:t.name,color:"#"+t.color.getHexString(),intensity:t.intensity*(t.width*t.height)};s.add(t,"visible"),s.add(i,"intensity").min(100).max(400).step(1).onChange(e=>{t.intensity=e/(t.width*t.height)}),s.add(t,"castShadow"),s.addColor(i,"color").onChange(e=>{t.color=new THREE.Color(e)}),s.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}_addSpotLightToGUI(e,t){let s=e.addFolder(t.name),i={name:t.name,color:"#"+t.color.getHexString(),angle:180*t.angle/Math.PI};s.add(t,"visible"),s.add(t,"intensity").min(0).max(5).step(.1),s.add(t,"penumbra").min(0).max(1).step(.1),s.addColor(i,"color").onChange(e=>{t.color=new THREE.Color(e)}),s.add(i,"angle").min(10).max(180).step(1).onChange(e=>{t.angle=e*Math.PI/180}),s.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),s.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}_addAmbientLightToGUI(e,t){let s={name:t.name,color:"#"+t.color.getHexString()},i=e.addFolder(t.name);i.add(t,"visible"),i.add(t,"intensity").min(0).max(5).step(.1),i.addColor(s,"color").onChange(e=>{t.color=new THREE.Color(e)})}}__decorate([inject],DynamicLightSetting.prototype,"_dynamicLightSettingLoader",void 0);class Environment{constructor(e,t){this._scene=e,t&&(t.removeFromScene(),t.cleanUp())}updateCamera(e){}reload(){this.removeFromScene(),this.addToScene()}updateBounds(e){this._bounds=e}cleanUp(){this._scene=null}}class GltfEnvironment extends Environment{constructor(e,t){super(e,t),this._gltfLoaderPromise=this._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader-js"}).then(()=>{this._gltfLoader=new THREE.GLTFLoader})}needsBounds(){return!0}needsCamera(){return!0}updateBounds(e){if(super.updateBounds(e),this._backgroundMesh){let t=Math.max(e.x,e.z)/6;t=Math.max(t,1),this._backgroundMesh.scale.copy(new THREE.Vector3(t,t,t))}}updateCamera(e){if(this._backgroundMesh){let t=e.getWorldDirection(new THREE.Vector3);t.y=0,t.lengthSq()<.01&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.multiplyScalar(-1),t.normalize();let s=Math.asin(t.x);t.z<0&&(s=Math.PI-s),this._backgroundMesh.rotation.set(0,s,0)}}addToScene(){this._scene&&this._backgroundMesh&&this._scene.add(this._backgroundMesh)}removeFromScene(){this._scene&&this._backgroundMesh&&this._scene.remove(this._backgroundMesh)}loadBackground(e,t){this._backgroundMaterial=t,this._backgroundMaterial||(this._backgroundMaterial=new THREE.MeshBasicMaterial),this._gltfLoaderPromise.then(()=>{this._gltfLoader.load(e,this._onBackgroundLoaded.bind(this),e=>{},e=>{console.error(e)})})}_onBackgroundLoaded(e){this._scene&&(this._backgroundMaterial.vertexColors=THREE.VertexColors,e&&e.scene&&e.scene.children&&e.scene.children.length>0&&(e.scene.children[0].material=this._backgroundMaterial,e.scene.children[0].layers.set(2),e.scene.position.copy(new THREE.Vector3(0,0,0)),this._backgroundMesh=e.scene,this._backgroundMesh.layers.set(2),this._backgroundMesh.receiveShadow=!0,setShadows(this._backgroundMesh,!0,!1),this.removeFromScene(),this.addToScene()))}showGUI(){console.warn("gui not implemented for gltf environment")}}__decorate([inject],GltfEnvironment.prototype,"_scriptLoader",void 0);const INITIAL_FLOOR_SIZE=100,INITIAL_ROOM_SIZE=8,INCREASE_SIZE_BY=3,WALL_HEIGHT=20,FOG_COLOR=16185078;class FloorEnvironment extends Environment{constructor(e,t,s){super(e,t),this._wallVertices=[],this._wallMeshes=[],this._size=INITIAL_ROOM_SIZE,this._longestSide=2;let i=new THREE.PlaneGeometry(INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE),n=new THREE.MeshStandardMaterial({color:11184810,side:THREE.DoubleSide});this._floorMesh=new THREE.Mesh(i,n),this._floorMesh.name="floor",this._floorMesh.position.y=-.001,this._floorMesh.rotation.x=-Math.PI/2,this._floorMesh.layers.set(2),this._floorMesh.receiveShadow=!0,this._fog=s||!1;for(let e=0;e<4;e++){let e=new THREE.Mesh;e.layers.set(2),e.receiveShadow=!0,this._wallMeshes.push(e)}this._updateWallVertices(),this._updateWalls(n),this._textureLoader=new THREE.TextureLoader,this.addToScene()}needsBounds(){return!0}needsCamera(){return this._fog}needsRotation(){return!1}updateBounds(e){super.updateBounds(e),this._longestSide=Math.max(e.x,e.z);let t=this._longestSide+5;t<INITIAL_ROOM_SIZE?t=INITIAL_ROOM_SIZE:t+=INCREASE_SIZE_BY-t%INCREASE_SIZE_BY,this._size=t,this._update()}updateCamera(e){this._cameraDistance=e.position.distanceTo(new THREE.Vector3(0,0,0)),this._update()}_update(){this._fog?this._updateFog():(this._updateWallVertices(),this._updateWalls(new THREE.MeshBasicMaterial({color:16777215})))}_updateFog(){let e=this._longestSide/2;this._scene.fog=new THREE.Fog(FOG_COLOR,this._cameraDistance+e+3,this._cameraDistance+e+3+1),this._scene.background=new THREE.Color(FOG_COLOR)}_updateFloor(){if(this._floorMaterial){let e=new THREE.PlaneGeometry(INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE/this._width,INITIAL_FLOOR_SIZE/this._height);this._floorMesh.material=this._floorMaterial,this._floorMesh.geometry=e}else{let e=null,t=this._width/1e3,s=this._height/1e3;this._repeatable?(this._floorTexture.wrapS=THREE.RepeatWrapping,this._floorTexture.wrapT=THREE.RepeatWrapping,this._floorTexture.repeat.set(INITIAL_FLOOR_SIZE/t,INITIAL_FLOOR_SIZE/s),e=new THREE.PlaneGeometry(INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE/t,INITIAL_FLOOR_SIZE/s)):e=new THREE.PlaneGeometry(INITIAL_FLOOR_SIZE,INITIAL_FLOOR_SIZE,1,1);let i=new THREE.MeshStandardMaterial({map:this._floorTexture,side:THREE.DoubleSide});this._floorMesh.material=i,this._floorMesh.geometry=e}}_updateWallVertices(){this._wallVertices=[];let e=this._size/2;this._wallVertices.push(new THREE.Vector3(-e,0,-e)),this._wallVertices.push(new THREE.Vector3(-e,0,e)),this._wallVertices.push(new THREE.Vector3(e,0,e)),this._wallVertices.push(new THREE.Vector3(e,0,-e))}_updateWalls(e){if(this._wallTexture)for(let t=0;t<this._wallMeshes.length;t++){let s=this._wallMeshes[t],i=this._wallVertices[t],n=this._wallVertices[(t+1)%this._wallVertices.length],a=new THREE.Geometry;a.vertices=[i,n,new THREE.Vector3(i.x,WALL_HEIGHT,i.z),new THREE.Vector3(n.x,WALL_HEIGHT,n.z)],a.faceVertexUvs=[[[new THREE.Vector2(i.x+i.z,WALL_HEIGHT),new THREE.Vector2(n.x+n.z,n.y),new THREE.Vector2(i.x+i.z,i.y)],[new THREE.Vector2(n.x+n.z,n.y),new THREE.Vector2(i.x+i.z,WALL_HEIGHT),new THREE.Vector2(n.x+n.z,WALL_HEIGHT)]]],a.uvsNeedUpdate=!0,a.faces=[new THREE.Face3(2,1,0),new THREE.Face3(1,2,3)],a.computeFaceNormals(),a.computeVertexNormals(),s.material=e,s.geometry=a}}addToScene(){this._scene&&(this._scene.add(this._floorMesh),this._wallMeshes.forEach(e=>{this._scene.add(e)}))}removeFromScene(){this._scene.remove(this._floorMesh),this._wallMeshes.forEach(e=>{this._scene.remove(e)})}_getWallPromise(){return new Promise((e,t)=>{this._wallTexture?e():this._textureLoader.load(getAssetPath()+"static/textures/white_wall_texture.jpg",t=>{this._wallTexture=t,this._wallTexture.wrapS=THREE.RepeatWrapping,this._wallTexture.wrapT=THREE.RepeatWrapping,e()},null,t)})}setFloorMaterial(e,t,s,i){return this._width=t,this._height=s,this._repeatable=i,this._floorPromise=new Promise((t,s)=>{this._textureLoader.load(e,e=>{this._floorTexture=e,t()},null,s)}),new Promise((e,t)=>{Promise.all([this._floorPromise,this._getWallPromise()]).then(()=>{this._updateFloor(),this._update(),e()},()=>t())})}changeFloorMaterial(e,t){this._floorPromise=new Promise((s,i)=>{let n=createMaterial(e,this._environmentLoader.getEnvironmentMap());this._rapiAccess.getTexturesOf(e).then(a=>{if(a.length>0){let e=[];a.forEach(s=>{let i=0===s.mmWidth?1:s.mmWidth/1e3,a=0===s.mmHeight?1:s.mmHeight/1e3,o=INITIAL_FLOOR_SIZE/i,r=INITIAL_FLOOR_SIZE/a;e.push(addTexture(this._dataSyncer.requestAsset(s.image,!0),s,n,t,o,r))}),Promise.all(e).then(()=>{this._floorMaterial=n,setTimeout(()=>s(),0)},i)}else i("textures for material "+e.id+" are empty")}),(!e.textures||e.textures&&0===e.textures.length)&&(this._floorMaterial=n,setTimeout(()=>s(),0))});let s=[this._floorPromise];return this._fog||s.push(this._getWallPromise()),new Promise((e,t)=>{Promise.all(s).then(()=>{this._updateFloor(),this._update(),e()},()=>t())})}showGUI(){this._floorMaterial?this._addGUI():this._floorPromise&&this._floorPromise.then(()=>this._addGUI())}_addGUI(){let e=getGUI().addFolder("Floor");e.add(this._floorMaterial,"roughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"reflectivity").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoat").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoatRoughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"opacity").min(0).max(1).step(.01),e.add(this._floorMaterial,"metalness").min(0).max(1).step(.01),e.add(this._floorMaterial,"bumpScale").min(0).max(1).step(.01)}}__decorate([inject],FloorEnvironment.prototype,"_rapiAccess",void 0),__decorate([inject],FloorEnvironment.prototype,"_dataSyncer",void 0),__decorate([inject],FloorEnvironment.prototype,"_environmentLoader",void 0);const INITIAL_PLANE_SIZE=30,BACKGROUND_CLASS_NAME="rml-scene-background";class BasicEnvironment extends Environment{constructor(e,t,s,i,n){super(e,t),this._color=s,this._oldBackground=e.background,this._shadowMaterial=new THREE.ShadowMaterial({color:1118481,opacity:.4}),this._generateShadowPlane(INITIAL_PLANE_SIZE),i&&(this._canvas=i,this.addBackground(i,n)),this.addToScene()}addBackground(e,t){const s=document.createElement("style");let i='background-image: url("'+t+'"); background-size: cover;';s.innerText="."+BACKGROUND_CLASS_NAME+" {"+i+"}",e.appendChild(s)}_generateShadowPlane(e){let t=!1;this._shadowMesh&&(t=!0,this._scene.remove(this._shadowMesh)),this._shadowMesh=new THREE.Mesh(new THREE.PlaneGeometry(e,e),this._shadowMaterial),this._shadowMesh.name="floor",this._shadowMesh.position.y=-.001,this._shadowMesh.rotation.x=-Math.PI/2,this._shadowMesh.layers.set(2),this._shadowMesh.receiveShadow=!0,t&&this._scene.add(this._shadowMesh)}needsBounds(){return!0}needsCamera(){return!0}addToScene(){this._scene&&(this._canvas?this._scene.background=null:this._scene.background=this._color,this._scene.add(this._shadowMesh),this._canvas&&this._canvas.classList.add(BACKGROUND_CLASS_NAME))}removeFromScene(){this._scene.background=this._oldBackground,this._scene.remove(this._shadowMesh),this._canvas&&this._canvas.classList.remove(BACKGROUND_CLASS_NAME)}updateBounds(e){super.updateBounds(e),this._generateShadowPlane(Math.max(e.x,e.z)+INITIAL_PLANE_SIZE)}showGUI(){console.warn("gui not implemented for gltf environment")}}class AsyncGuard{constructor(){this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(){this._resolve()}reject(e){this._reject(e)}wait(){return new Promise((e,t)=>Promise.all([this._promise]).then(()=>e(),t))}}class BakedShadowEnvironment extends Environment{constructor(e,t,s){super(e,t),this._pixotronGuard=new AsyncGuard,this._color=s,this._oldBackground=e.background}needsBounds(){return!1}needsCamera(){return!1}needsRotation(){return!1}setPixotron(e){this._pixotron=e,this._pixotron.getShadowPlanePass().enable=!0,this._pixotronGuard.resolve()}onShadowPlaneReady(){this._pixotronGuard.wait().then(()=>{this._pixotron.needsUpdate=!0,this._shadowPlane=this._pixotron.getShadowPlanePass().getShadowPlane(),this.addToScene()})}updateShadowPlane(){this._pixotronGuard.wait().then(()=>{this._pixotron.updateShadowPlane(this._scene)})}addToScene(){this._scene.add(this._shadowPlane),this._color&&(this._scene.background=this._color)}removeFromScene(){this._scene.remove(this._shadowPlane),this._oldBackground&&(this._scene.background=this._oldBackground)}showGUI(){}}class DynamicEnvironmentSettingLoader{parse(e,t,s,i){let n=JSON.parse(i);return n.environment?this.load(e,t,s,n):null}load(e,t,s,i){let n,a=i.environment;if(!a)return console.warn("No environment set in scene settings"),Promise.resolve(null);switch(a.type){case"color":n=new Promise(t=>t(new BasicEnvironment(e,s,new THREE.Color(a.details.color))));break;case"image":n=new Promise(i=>i(new BasicEnvironment(e,s,null,t,a.details.imageUrl)));break;case"gltf":n=new Promise(t=>{let i=new GltfEnvironment(e,s);i.loadBackground(getAssetPath()+"static/geometry/PhotoStudioRoom.glb"),t(i)});break;case"floor":n=new Promise(t=>{this._rapiAccess.getMaterial(a.details.material).then(i=>{let n=void 0===a.details.fog||a.details.fog,o=new FloorEnvironment(e,s,n);o.changeFloorMaterial(i).then(()=>{t(o)})})});break;case"baked_shadow":n=new Promise(t=>{a.details&&a.details.color?t(new BakedShadowEnvironment(e,s,new THREE.Color(a.details.color))):t(new BakedShadowEnvironment(e,s))});break;default:console.warn("Could not load environment, return old environment"),n=new Promise(e=>e(s))}return n}}__decorate([inject],DynamicEnvironmentSettingLoader.prototype,"_rapiAccess",void 0);const START_SUFFIX="_start",META_INFO=new Map;class Benchmark{static start(e){if(!window.performance||!window.performance.getEntriesByName)return"";let t=window.performance.getEntriesByName(e).length++,s="";t<100&&(s="0"),t<10&&(s="0"+s);const i=t>0?e+"_"+s+t:e,n=i+START_SUFFIX;return window.performance.mark(n),i}static addMeta(e,t){const s=Benchmark.getMeta(e);META_INFO.set(e,Object.assign(s,t))}static getMeta(e){return META_INFO.get(e)||{}}static end(e){}static getMeasure(e){return[]}static showBenchmarks(e){const t=window.performance.getEntriesByType("measure");t.sort(function(e,t){return e.startTime-t.startTime});const s=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e&&-1===n.name.indexOf(e)||s.push({Start:parseFloat(n.startTime.toFixed(2)),Name:n.name,Duration:parseFloat(n.duration.toFixed(2))})}console.table(s)}}let _scriptCache={},_idCache={};class ScriptLoader{constructor(e){this._creator_=e}fetch(e,t){return this._singlePromiseFactory.create(5,e,(s,i)=>{!function(e,t,s,i){if(-1===e.indexOf("http")&&(e=getAssetPath()+e),_scriptCache[e])return s();if(t.id&&_idCache[t.id])return i(new Error('There is already a script with ID "'+t.id+'"'));const n=Benchmark.start("load_"+t.id.replace(/-/g,"_")),a=document.createElement("script");a.async=!1,a.src=e,a.id=t.id,a.onload=(()=>{_scriptCache[e]=!0,_idCache[t.id]=!0,Benchmark.end(n),Object.defineProperty(s,"name",{value:"resolve-"+t.id}),s()}),a.onerror=(e=>{i(e)}),document.body.appendChild(a)}(e,t,s,i)})}cleanUp(){for(let e in _idCache)if(_idCache.hasOwnProperty(e)){const t=document.getElementById(e);t&&t.parentElement.removeChild(t)}_scriptCache={},_idCache={}}}__decorate([inject],ScriptLoader.prototype,"_singlePromiseFactory",void 0);const BROWSER_EVENTS={MOUSE_MOVE:"mousemove",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",MOUSE_LEAVE:"mouseleave",MOUSE_ENTER:"mouseenter",MOUSE_WHEEL:"wheel",TOUCH_MOVE:"touchmove",TOUCH_START:"touchstart",TOUCH_END:"touchend",CONTEXT_MENU:"contextmenu"};class InputEvent{constructor(e,t,s){this.position=e,this.positionRelative=t,this.type=s}}const MIN_MOVE_DISTANCE=5*window.devicePixelRatio,MIN_DOLLY_DISTANCE=2*window.devicePixelRatio;class InputManager extends EventDispatcher{constructor(e){super(),this._debug=!1,this._delta=-1,this._state=0,this._pinchDistance=-1,this._lastMouseWheelEvent=null,this._lastTouchEvent=null,this._events=Object.keys(BROWSER_EVENTS).map(e=>BROWSER_EVENTS[e]),this._creator_=e,this._position={x:0,y:0},this._positionRelative={x:0,y:0},this._downPosition={x:0,y:0},this._downPositionRelative={x:0,y:0}}enableDragIn(e){this._state=1,this._dragEnabled=!0,e&&(this._dragMV=this._dragM.bind(this),this._dragEV=this._dragE.bind(this),this._dragTarget=e.currentTarget||e.target,this._delta=-1,this._dragMVName="drag",this._dragEVName="dragend",window.TouchEvent&&e instanceof TouchEvent?(this._dragMVName="touchmove",this._dragEVName="touchend"):e.dataTransfer&&e.dataTransfer.setData&&e.dataTransfer.setData("text/plain"," "),this._firefoxDragPosition={x:0,y:0},document.ondragover=(e=>{e=e||window.event,this._firefoxDragPosition.x=e.pageX,this._firefoxDragPosition.y=e.pageY}),this._dragTarget.addEventListener(this._dragMVName,this._dragMV,!1),this._dragTarget.addEventListener(this._dragEVName,this._dragEV,!1))}_dragM(e){let t=e,s=null,i=null;window.TouchEvent&&e instanceof TouchEvent?(s=this._getTouchPosition(t),i=this._getTouchPositionRelative(t)):(s=this._getMousePosition(t),i=this._getMousePositionRelative(t)),s.x>0&&s.y>0&&this._move(s,i)}_dragE(e){let t=e;document.ondragover=null,this._firefoxDragPosition=null,this._dragTarget.removeEventListener(this._dragMVName,this._dragMV),this._dragTarget.removeEventListener(this._dragEVName,this._dragEV),window.TouchEvent&&e instanceof TouchEvent?this._onUp(this._getTouchPosition(t),this._getTouchPositionRelative(t)):this._onUp(this._getMousePosition(t),this._getMousePositionRelative(t))}addEvents(e){this._events.forEach(t=>e.addEventListener(t,this,!1))}removeEvents(e){this._events.forEach(t=>e.removeEventListener(t,this,!1))}_dolly(e){if(this._lastTouchEvent&&e.timeStamp-this._lastTouchEvent.timeStamp<40)return;let t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY,i=Math.abs(t)+Math.abs(s);i>this._pinchDistance+MIN_DOLLY_DISTANCE&&this.dispatchEvent(7,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e))),i<this._pinchDistance-MIN_DOLLY_DISTANCE&&this.dispatchEvent(8,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e))),this._pinchDistance=i,this._lastTouchEvent=e}_move(e,t,s){void 0===s&&(s=0),void 0===this._dragEnabled&&(this._dragEnabled=!1),(1===this._state&&this._canDrag(s)||1===this._state&&this._dragEnabled&&2===s)&&(this._delta=this._getDelta(),this._delta>MIN_MOVE_DISTANCE&&(this._state=2,this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(0,new InputEvent(e,t)))),2===this._state&&this.dispatchEvent(1,new InputEvent(e,t)),this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(6,new InputEvent(e,t,s))}_longClick(){this._state=2,this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(0,new InputEvent(this._downPosition,this._downPositionRelative)),this.dispatchEvent(1,new InputEvent(this._downPosition,this._downPositionRelative))}_onUp(e,t){this.dispatchEvent(4,new InputEvent(e)),this._getDelta()<=MIN_MOVE_DISTANCE&&this.dispatchEvent(5,new InputEvent(e,t)),2===this._state&&this.dispatchEvent(2,new InputEvent(e,t)),3===this._state&&(this._pinchDistance=-1),this._lastTouchEvent=null,this._state=0,this._dragTarget=null,this._longClickTimer&&clearTimeout(this._longClickTimer)}_getTouchPosition(e){if(e.changedTouches.length){let{clientX:t,clientY:s}=e.changedTouches[0];this._position.x=t,this._position.y=s}return this._position}_getTouchPositionRelative(e){if(e.changedTouches.length){let t=this._domHelper.element.getBoundingClientRect(),{clientX:s,clientY:i}=e.changedTouches[0];this._positionRelative.x=(s-t.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(i-t.top)/this._domHelper.element.clientHeight*2+1}return this._positionRelative}_getMousePosition(e){return this._position.x=e.clientX,this._position.y=e.clientY,this._position}_getMousePositionRelative(e){if(0!==e.clientX&&0!==e.clientY){let t=this._domHelper.element.getBoundingClientRect();this._positionRelative.x=(e.clientX-t.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(e.clientY-t.top)/this._domHelper.element.clientHeight*2+1}else if(this._firefoxDragPosition&&0!==this._firefoxDragPosition.x&&0!==this._firefoxDragPosition.y){let e=this._domHelper.element.getBoundingClientRect();this._positionRelative.x=(this._firefoxDragPosition.x-e.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(this._firefoxDragPosition.y-e.top)/this._domHelper.element.clientHeight*2+1}return this._positionRelative}_getDelta(){return Math.abs(this._downPosition.y-this._position.y)+Math.abs(this._downPosition.x-this._position.x)}setDragEnabled(e){this._dragEnabled=e}handleEvent(e){switch(this._debug&&e.type,e.type){case BROWSER_EVENTS.MOUSE_MOVE:this._onMouseMove(e);break;case BROWSER_EVENTS.MOUSE_DOWN:this._onMouseDown(e);break;case BROWSER_EVENTS.MOUSE_UP:this._onMouseUp(e);break;case BROWSER_EVENTS.MOUSE_LEAVE:this._onMouseLeave(e);break;case BROWSER_EVENTS.MOUSE_ENTER:this._onMouseEnter(e);break;case BROWSER_EVENTS.MOUSE_WHEEL:this._onMouseWheel(e);break;case BROWSER_EVENTS.TOUCH_MOVE:this._onTouchMove(e);break;case BROWSER_EVENTS.TOUCH_START:this._onTouchStart(e);break;case BROWSER_EVENTS.TOUCH_END:this._onTouchEnd(e);break;case BROWSER_EVENTS.CONTEXT_MENU:this._onContextMenu(e)}}_onMouseDown(e){e.preventDefault();let{x:t,y:s}=this._getMousePosition(e);this._downPosition={x:t,y:s},this._downPositionRelative=this._getMousePositionRelative(e),this.dispatchEvent(3,new InputEvent({x:t,y:s},this._downPositionRelative,1)),this._state=1}_onMouseUp(e){e.preventDefault(),this._onUp(this._getMousePosition(e),this._getMousePositionRelative(e))}_onMouseMove(e){e.preventDefault(),this._move(this._getMousePosition(e),this._getMousePositionRelative(e),1)}_onMouseLeave(e){this._delta=-1,this._onMouseUp(e)}_onMouseEnter(e){e.preventDefault()}_onMouseWheel(e){e.preventDefault(),e.stopPropagation(),this._lastMouseWheelEvent&&e.timeStamp-this._lastMouseWheelEvent.timeStamp<40||(e.deltaY<0?this.dispatchEvent(7,new InputEvent(this._getMousePosition(e),this._getMousePositionRelative(e))):this.dispatchEvent(8,new InputEvent(this._getMousePosition(e),this._getMousePositionRelative(e))),this._lastMouseWheelEvent=e)}_onTouchMove(e){e.preventDefault(),this._dragTarget||(1===e.touches.length&&this._move(this._getTouchPosition(e),this._getTouchPositionRelative(e),2),2===e.touches.length&&(this._state=3,this._dolly(e)))}_onTouchStart(e){if(e.preventDefault(),1===e.touches.length){let{x:t,y:s}=this._getTouchPosition(e);this._downPosition={x:t,y:s},this._downPositionRelative=this._getTouchPositionRelative(e),this.dispatchEvent(3,new InputEvent({x:t,y:s},this._downPositionRelative,2)),this._state=1,this._longClickTimer=window.setTimeout(this._longClick.bind(this),350)}else 2===e.touches.length&&(1!==this._state&&2!==this._state||this._onUp(this._getTouchPosition(e),this._getTouchPositionRelative(e)),this._state=3)}_onTouchEnd(e){e.preventDefault(),this._onUp(this._getTouchPosition(e),this._getTouchPositionRelative(e))}_onContextMenu(e){e.preventDefault()}_canDrag(e){return 2!==e}}__decorate([inject],InputManager.prototype,"_domHelper",void 0);export{kernelBoxToThreeBox as a,EventDispatcher as b,getScreenXY as c,LightSetting as d,getGUI as e,CameraControl3D as f,PREVIEW_MATERIAL_COLOR as g,PREVIEW_MATERIAL_OPACITY as h,CANVAS_ID as i,toRadiant as j,DynamicLightSetting as k,GltfEnvironment as l,FloorEnvironment as m,BasicEnvironment as n,DynamicEnvironmentSettingLoader as o,Benchmark as p,DynamicLightSettingLoader as q,AppContext as r,InputManager as s,DomHelper as t,CameraControl as u,ScriptLoader as v,Logger as w,DataSyncer as x,DependencyInjectionAssignment as y,Main as z,RoomleDependencyInjection as A,disposeMesh as B,PREVIEW_LINE_MATERIAL_OPACITY as C,PREVIEW_MATERIAL_METALNESS as D,PREVIEW_MATERIAL_ROUGHNESS as E,vectorIsZero as F,IMAGE_FORMATS as G,addTexture as H,createMaterial as I,dispose as J,fadeIn as K,getBoundingBoxMaterial as L,getColorFromInt as M,getSelectionGeometry as N,setWallTransparency as O,setWallTransparencyBasedOnCamera as P,checkGLB as Q,MIN_MOVE_DISTANCE as R,position2VectorsAreEqual as S,position3VectorsAreEqual as T,rotationQuaternionsAreEqual as U,getDelta as V,DynamicQualitySettingLoader as W,BakedShadowEnvironment as X};
//# sourceMappingURL=chunk-3cfc8712.js.map
