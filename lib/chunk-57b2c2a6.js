import{b as getAssetPath,e as handleJsonResponse,c as setCursor,f as ROOMLE_COLORS,g as debounce}from"./chunk-8ebdc893.js";import{a as MainThreadToWorker,b as getAllParameters}from"./chunk-9ffef419.js";import{g as PREVIEW_MATERIAL_COLOR,h as createColorCubeTexture,i as PREVIEW_MATERIAL_OPACITY,j as AsyncGuard,k as disposeObject,l as disposeMaterial,m as disposeGeometry,n as disposeMesh,e as kernelBoxToThreeBox,o as DOCK_PREVIEW_MATERIAL_OPACITY,p as DOCK_PREVIEW_MATERIAL_ROUGHNESS,q as DOCK_PREVIEW_MATERIAL_METALNESS,r as DOCK_PREVIEW_MATERIAL_COLOR,s as DOCK_PREVIEW_MATERIAL_OPACITY_HOVERED,t as PREVIEW_LINE_MATERIAL_OPACITY,c as toRadiant,u as position3VectorsAreEqual,v as position2VectorsAreEqual,w as getIdealDistance,x as to360Degrees,y as getAngle,b as getGUI,z as setShadows,A as vectorIsEqual,B as fadeIn,C as createMaterial,D as addTexture}from"./chunk-36924942.js";import{a as __decorate,b as inject}from"./chunk-c1472d96.js";const BROWSER_LANGUAGE_PROPERTY_KEYS_KNOWN=["language","browserLanguage","userLanguage","systemLanguage"],getLanguage=(e=null)=>{const t=window.navigator;if(e)return e.substr(0,2);if(Array.isArray(t.languages)&&t.languages.length>0)return t.languages[0].substr(0,2);for(let e=0,i=BROWSER_LANGUAGE_PROPERTY_KEYS_KNOWN.length;e<i;e++){const i=t[BROWSER_LANGUAGE_PROPERTY_KEYS_KNOWN[e]];if(i)return i.substr(0,2)}return"en"};class AppContext{static init(e={}){const{locale:t,kernelInstance:i,kernelContainer:s,planObjectId:n}=e;AppContext.kernelInstance=i,AppContext.kernelContainer=s,AppContext.planObjectId=n,AppContext.actualLocale=t?getLanguage(t):getLanguage()}static cleanUp(){AppContext.actualLocale=getLanguage(),AppContext.useHDGeometry=!1,AppContext.kernelInstance=null,AppContext.kernelContainer=null,AppContext.planObjectId=null}}AppContext.actualLocale=getLanguage(),AppContext.useHDGeometry=!1,AppContext.kernelInstance=null,AppContext.kernelContainer=null,AppContext.planObjectId=null;class Container{constructor(){this._context=new Map,this._lookups=new Map,this._singletons=new Map}getContext(e){if(this._context.has(e)){const t=this._context.get(e);return this._context.set(e,t+1),e+t}return this._context.set(e,1),e+0}addDependencyInjectionAssignments(e){e.forEach(e=>{this._lookups.set(e.className,e)})}lookup(e,t){if(!this._lookups.has(e))return null;const i=this._lookups.get(e);if(1===i.type&&void 0===t){const t="Dependency "+e+" has definition context but no context was defined!";return console.trace(t),console.error(t),null}let s=t&&1===i.type?t:"global";if(s+="_"+e,2===i.type)return new i.classDefinition;if(this._singletons.has(s))return this._singletons.get(s);const n=new i.classDefinition(t);return this._singletons.set(s,n),n}cleanUp(e){if(e){let t=[];this._singletons.forEach((i,s)=>{s.startsWith(e)&&t.push(s)}),t.forEach(e=>{this._singletons.delete(e)})}else this._singletons.clear(),this._singletons=new Map}}class DependencyInjectionAssignment{constructor(e,t,i){this.className=e,this.classDefinition=t,this.type=void 0===i?0:i}}const IMAGE_FORMATS={JPG:".jpg",JPEG:".jpeg",PNG:".png",GIF:".gif"};class FormDataUtil{_base64toBlob(e,t){t=t||"";const i=atob(e),s=i.length,n=Math.ceil(s/1024),o=new Array(n);for(let e=0;e<n;++e){let t=1024*e,n=Math.min(t+1024,s);const a=new Array(n-t);for(let e=t,s=0;e<n;++s,++e)a[s]=i[e].charCodeAt(0);o[e]=new Uint8Array(a)}return new Blob(o,{type:t})}_createFormData(e,t,i,s){const n=new FormData;-1!==e.indexOf(",")&&(e=e.substr(e.indexOf(",")+1));const o=-1===Object.keys(IMAGE_FORMATS).map(e=>IMAGE_FORMATS[e]).indexOf(i)?"application":"image",a=this._base64toBlob(e,o+"/"+i.substr(1));return n.append(s,a,t+i),n}create(e,t,i,s){return this._createFormData(e,t,i,s)}}const _HEADER_BYTES_=30;class EnvMapReader{constructor(){this._size=256,this._maxLod=0,this._encoding=THREE.LinearEncoding,this._type=THREE.UnsignedByteType,this._format=THREE.RGBAFormat,this._cubeTextures=[],this._lightDirection=new THREE.Vector3,this._path=""}setPath(e){this._path=e}load(e){return new Promise((t,i)=>{(new THREE.FileLoader).setResponseType("arraybuffer").load(this._path+e,e=>{this.parseData_(e),t(this._cubeTexture)})})}parseHeader_(e){let t=new DataView(e,0,_HEADER_BYTES_);this._size=t.getUint16(0),this._maxLod=t.getUint8(2),this._encoding=t.getUint16(3),this._type=t.getUint16(5),this._format=t.getUint16(7),this._lightDirection.x=t.getFloat32(9),this._lightDirection.y=t.getFloat32(13),this._lightDirection.z=t.getFloat32(17)}parseBufferData_(e,t){let i=this._size;const s=Math.log2(this._size)+1;this._cubeTextures=[];for(let n=0;n<s;n++){let s=new THREE.CubeTexture;this._cubeTextures.push(s),s.format=THREE.RGBAFormat,s.encoding=this._encoding,s.type=this._type,s.minFilter=THREE.LinearMipMapLinearFilter,s.magFilter=THREE.LinearFilter,s.generateMipmaps=!1;for(let n=0;n<6;n++){let o=new Uint8Array(e,t,4*i*i),a=new THREE.DataTexture(o,i,i);a.format=s.format,a.encoding=s.encoding,a.type=s.type,a.generateMipmaps=!1,t+=4*i*i,s.images[n]=a,a.needsUpdate=!0}s.needsUpdate=!0,i/=2}this._cubeTexture=new THREE.CubeTexture,this._cubeTexture.format=THREE.RGBAFormat,this._cubeTexture.encoding=this._encoding,this._cubeTexture.type=this._type,this._cubeTexture.minFilter=THREE.LinearMipMapLinearFilter,this._cubeTexture.magFilter=THREE.LinearFilter,this._cubeTexture.generateMipmaps=!1;for(let e=0;e<6;e++){this._cubeTexture.image[e]=this._cubeTextures[0].images[e];for(let e=1;e<s;e++)this._cubeTexture.mipmaps[e-1]=this._cubeTextures[e],this._cubeTextures[e].needsUpdate=!0}this._cubeTexture.needsUpdate=!0,this._cubeTexture.maxLod=this._maxLod-1}convertToRGBABuffer(e){let t=new Uint8Array(e,_HEADER_BYTES_,e.byteLength-_HEADER_BYTES_),i=4;this._format===THREE.RGBFormat&&(i=3);const s=4*t.length/i;let n=new ArrayBuffer(s),o=new DataView(n),a=0,r=t.length/i;if(3===i)for(let e=0;e<r;e++)o.setUint8(a++,t[e]),o.setUint8(a++,t[e+r]),o.setUint8(a++,t[e+2*r]),o.setUint8(a++,255);else for(let e=0;e<r;e++)o.setUint8(a++,t[e]),o.setUint8(a++,t[e+r]),o.setUint8(a++,t[e+2*r]),o.setUint8(a++,t[e+3*r]);return n}parseData_(e){this.parseHeader_(e);let t=_HEADER_BYTES_;t=0;let i=this.convertToRGBABuffer(e);this.parseBufferData_(i,0)}}class CubePacker{constructor(e){this._cubeTexture=e;let t=4*e.images[0].image.width,i=this._cubeTexture,s={format:i.format,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter,type:i.type,generateMipmaps:i.generateMipmaps,anisotropy:i.anisotropy,encoding:i.encoding===THREE.RGBEEncoding?THREE.RGBM16Encoding:i.encoding};s.encoding===THREE.RGBM16Encoding&&(s.magFilter=THREE.LinearFilter,s.minFilter=THREE.LinearFilter),this._cubeUVRenderTarget=new THREE.WebGLRenderTarget(t,t,s),this._cubeUVRenderTarget.texture.maxLod=e.maxLod,this._cubeUVRenderTarget.texture.name="CubeUVPacker.cubeUv",this._cubeUVRenderTarget.texture.mapping=THREE.CubeUVReflectionMapping,this._camera=new THREE.OrthographicCamera(.5*-t,.5*t,.5*-t,.5*t,-.001,1e3),this._scene=new THREE.Scene,this._objects=[];let n=new THREE.PlaneBufferGeometry(1,1),o=[];o.push(new THREE.Vector2(0,0)),o.push(new THREE.Vector2(1,0)),o.push(new THREE.Vector2(2,0)),o.push(new THREE.Vector2(0,1)),o.push(new THREE.Vector2(1,1)),o.push(new THREE.Vector2(2,1));let a=t;t=e.images[0].image.width;let r=0,h=4;this._numLods=Math.log(t)/Math.log(2)-2;for(let e=0;e<this._numLods;e++){let i=.5*(a-a/h);t>16&&(h*=2);let s=t>16?6:1,l=0,c=0,_=t;for(let t=0;t<s;t++){for(let t=0;t<6;t++){let s=this.getShader();s.needsUpdate=!0;const a=0===e?this._cubeTexture:this._cubeTexture.mipmaps[e-1];a.minFilter=THREE.LinearFilter,a.magFilter=THREE.LinearFilter,a.needsUpdate=!0,s.uniforms.envCubeMap.value=a,s.uniforms.faceIndex.value=t,s.uniforms.mapSize.value=_;let h=new THREE.Mesh(n,s);h.position.x=o[t].x*_-i+l,h.position.y=o[t].y*_-i+r+c,h.material.side=THREE.DoubleSide,h.scale.setScalar(_),this._scene.add(h),this._objects.push(h)}c+=1.75*_,l+=1.25*_,_/=2}r+=2*t,t>16&&(t/=2)}this._cubeTexture.mipmaps=[]}getRenderTarget(){return this._cubeUVRenderTarget}update(e){let t=e.gammaInput,i=e.gammaOutput,s=e.toneMapping,n=e.toneMappingExposure,o=e.getRenderTarget();e.gammaInput=!1,e.gammaOutput=!1,e.toneMapping=THREE.LinearToneMapping,e.toneMappingExposure=1,e.setRenderTarget(this._cubeUVRenderTarget),e.render(this._scene,this._camera),e.setRenderTarget(o),e.toneMapping=s,e.toneMappingExposure=n,e.gammaInput=t,e.gammaOutput=i}getShader(){let e=new THREE.ShaderMaterial({uniforms:{faceIndex:{value:0},mapSize:{value:0},envCubeMap:{value:null},testColor:{value:new THREE.Color(16777215)}},vertexShader:"precision highp float;                varying vec2 vUv;                void main() {                    vUv = uv;                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );                }",fragmentShader:"precision highp float;                varying vec2 vUv;                uniform samplerCube envCubeMap;                uniform float mapSize;                uniform vec3 testColor;                uniform int faceIndex;                                void main() {                    vec3 sampleDirection;                    vec2 uv = vUv;                    uv = uv * 2.0 - 1.0;                    uv.y *= -1.0;                    if(faceIndex == 0) {                        sampleDirection = normalize(vec3(-1.0, uv.y, -uv.x));                    } else if(faceIndex == 1) {                        sampleDirection = normalize(vec3(-uv.x, 1.0, uv.y));                    } else if(faceIndex == 2) {                        sampleDirection = normalize(vec3(-uv.x, uv.y, 1.0));                    } else if(faceIndex == 3) {                        sampleDirection = normalize(vec3(1.0, uv.y, uv.x));                    } else if(faceIndex == 4) {                        sampleDirection = normalize(vec3(-uv.x, -1.0, -uv.y));                    } else {                        sampleDirection = normalize(vec3(uv.x, uv.y, -1.0));                    }                    vec4 color = envMapTexelToLinear( textureCube( envCubeMap, sampleDirection ) );                    gl_FragColor = color;                }",blending:THREE.CustomBlending,premultipliedAlpha:!1,blendSrc:THREE.OneFactor,blendDst:THREE.ZeroFactor,blendSrcAlpha:THREE.OneFactor,blendDstAlpha:THREE.ZeroFactor,blendEquation:THREE.AddEquation});return e.type="PMREMCubeUVPacker",e}dispose(){for(let e=0,t=this._objects.length;e<t;e++)this._objects[e].material.dispose();this._objects[0].geometry.dispose()}}class EnvironmentLoader{constructor(e){this._hdrCubeUrl="static/textures/env/roomle.env",this._hdrCubeUrlLowres="static/textures/env/roomle64.env",this._envMapReader=new EnvMapReader,this._creator_=e;const t=new THREE.Color(PREVIEW_MATERIAL_COLOR);this._environmentMap=createColorCubeTexture(t.r,t.g,t.b,PREVIEW_MATERIAL_OPACITY),this._envMapReader.setPath(getAssetPath()),this._loadHDREnvMap(this._hdrCubeUrlLowres)}static setEnvironmentMap(e,t){e&&t&&(e.envMap=t,e.envMapIntensity=1,e.needsUpdate=!0)}getEnvironmentMap(){return this._environmentMap}_packEnvMap(){if(!this._renderer.extensions.get("EXT_shader_texture_lod")){let e=new CubePacker(this._environmentMap);e.update(this._renderer),e.dispose(),this._environmentMap=e.getRenderTarget().texture}}_loadHDREnvMap(e){return new Promise((t,i)=>{this._envMapReader.load(e).then(i=>{this._environmentMap=i,this._packEnvMap(),e!==this._hdrCubeUrl&&window.requestIdleCallback(this._loadHDREnvMap.bind(this,this._hdrCubeUrl)),this._updateEnvironmentMap(),t(),this._envChangedCallback&&this._envChangedCallback()})})}setRendererAndScene(e,t){this._renderer=e,this._scene=t}registerEnvironmentChangedCallback(e){this._envChangedCallback=e}_updateEnvironmentMap(){this._scene.traverse(e=>{e instanceof THREE.Mesh&&e.material instanceof THREE.MeshStandardMaterial&&EnvironmentLoader.setEnvironmentMap(e.material,this._environmentMap)})}setEnvMap(e){EnvironmentLoader.setEnvironmentMap(e,this.getEnvironmentMap())}}const RECT_AREA_LIGHT_DEFAULT_SIZE=.8,PREDEFINED_LIGHTSETTING={SOFA:"sofa",SHELF:"shelf",SHELF_FRONT:"shelf_front",BAKED:"baked",CAMERA:"camera",EQUAL:"equal"};class DynamicLightSettingLoader{static createDynamicLightSettingSource(e,t){let i={};if(e)i.url=e;else if(t)switch(t){case PREDEFINED_LIGHTSETTING.SHELF:i.url=getAssetPath()+"static/predefined_lightsettings/shelf.json";break;case PREDEFINED_LIGHTSETTING.SHELF_FRONT:i.url=getAssetPath()+"static/predefined_lightsettings/shelf_front.json";break;case PREDEFINED_LIGHTSETTING.SOFA:i.url=getAssetPath()+"static/predefined_lightsettings/sofa.json";break;case PREDEFINED_LIGHTSETTING.BAKED:i.url=getAssetPath()+"static/predefined_lightsettings/baked.json";break;case PREDEFINED_LIGHTSETTING.CAMERA:i.url=getAssetPath()+"static/predefined_lightsettings/camera.json";break;case PREDEFINED_LIGHTSETTING.EQUAL:i.url=getAssetPath()+"static/predefined_lightsettings/equal.json";break;default:i=null}else i=null;return i}parse(e){let t=JSON.parse(e);return t.lights?this.load(t):[]}load(e){let t=[];return e.lights?(e.lights.forEach(e=>{let i;switch(e.type){case"ambient":i=this._parseAmbientLight(e);break;case"rectarea":i=this._parseRectAreaLight(e);break;case"spot":i=this._parseSpotLight(e);break;case"directional":i=this._parseDirectionalLight(e)}i&&t.push(i)}),t):[]}_parseAmbientLight(e){let t=new THREE.AmbientLight;return this._parseCommon(t,e),t}_parseRectAreaLight(e){let t=new THREE.RectAreaLight;this._parseCommon(t,e);let{intensity:i,castShadow:s,target:n,width:o,height:a}=e;return t.width=o||RECT_AREA_LIGHT_DEFAULT_SIZE,t.height=a||RECT_AREA_LIGHT_DEFAULT_SIZE,t.castShadow=s||!1,t.matrixAutoUpdate=!0,t.intensity=(i||240)/((o||RECT_AREA_LIGHT_DEFAULT_SIZE)*(a||RECT_AREA_LIGHT_DEFAULT_SIZE)),t.lookAt(n?new THREE.Vector3(n.x,n.y,n.z):new THREE.Vector3(0,0,0)),t}_parseSpotLight(e){let t=new THREE.SpotLight;this._parseCommon(t,e);let{angle:i,penumbra:s,target:n,castShadow:o}=e;return t.angle=(i||100)*Math.PI/180,t.penumbra=s||.5,t.lookAt(n?new THREE.Vector3(n.x,n.y,n.z):new THREE.Vector3(0,0,0)),t.shadow.camera.near=.1,t.shadow.camera.far=10,t.shadow.mapSize=new THREE.Vector2(1024,1024),t.castShadow=o||!1,t}_parseDirectionalLight(e){let t=new THREE.DirectionalLight;this._parseCommon(t,e);let{target:i,castShadow:s}=e;return t.castShadow=s||!1,t.shadow.camera.near=.1,t.shadow.camera.far=100,t.shadow.mapSize=new THREE.Vector2(1024,1024),t.shadow.bias=-5e-5,t.lookAt(i?new THREE.Vector3(i.x,i.y,i.z):new THREE.Vector3(0,0,0)),t}_parseCommon(e,t){let{name:i,intensity:s,color:n,position:o,movesWithCamera:a}=t;e.name=i||"",e.intensity=s||1,e.color=new THREE.Color(n||"#ffffff"),e.position.copy(o?new THREE.Vector3(o.x,o.y,o.z):new THREE.Vector3(0,0,0)),e.visible=!0,e.layers.set(1),e.userData.movesWithCamera=a}}const MAX_NETWORK_CALLS=40;class NetworkLayer{constructor(){this._queue=[],this._pendingRequests=0}_nextSlot(){if(this._pendingRequests-=1,!this._queue.length)return;const{request:e,resolve:t,reject:i}=this._queue.shift();this._fetch(e).then(t,i)}_fetch(e,t={}){return this._pendingRequests+=1,new Promise((i,s)=>{self.fetch(e,t).then(function(){this._nextSlot(),i(...arguments)}.bind(this),e=>{this._nextSlot(),s(e)})})}fetch(e,t={}){return this._pendingRequests>=MAX_NETWORK_CALLS?new Promise((t,i)=>this._queue.push({request:e,resolve:t,reject:i})):this._fetch(e,t)}}class Logger{info(...e){console}log(...e){console}warn(...e){console.warn.apply(console,e)}error(...e){console.warn.apply(console,e)}}const ASSET_CACHE=new Map,SYNCED_CATALOGS=new Map,SYNCED_FLOORS_TAGS=new Map,SYNCED_TYPE_CHANGE_TAGS=new Map;class DataSyncer{constructor(e){this._bootCallbacks=[],this._isStarted=!1,this._isStarting=!1,this._alwaysUseCache=!1,this._creator_=e}start(e){return this._configuratorUiCallbacks.onSyncStarted(),this._startWorker().then(()=>this._handleCatalog(e)).then(()=>{const{typeChangeTag:e,floorMaterialsTag:t}=window.__RML__ENV__.initData;Promise.all([this._syncFloorTag(t),this._syncTypeChangeTag(e)]).then(()=>{SYNCED_TYPE_CHANGE_TAGS.set(e,!0),this._configuratorUiCallbacks.onSyncDone()})})}syncCatalog(e){return this._startWorker().then(()=>this._handleCatalog(e))}syncFloorTag(e){return this._startWorker().then(()=>this._syncFloorTag(e))}syncTypeChangeTag(e){return this._startWorker().then(()=>this._syncTypeChangeTag(e))}_syncFloorTag(e){const t=[];return e&&!SYNCED_FLOORS_TAGS.get(e)?(t.push(this._handleTags([e])),this._rapiAccess.getTag(e).then(e=>{t.push(this._handleMaterialsAndTextures(e))}),this._singlePromiseFactory.create(1,e,i=>{Promise.all(t).then(()=>{SYNCED_FLOORS_TAGS.set(e,!0),i()},e=>this._softReject(i,'_syncFloorTag error: "'+e+'"'))})):Promise.resolve()}_syncTypeChangeTag(e){const t=[];return e&&!SYNCED_TYPE_CHANGE_TAGS.get(e)?(t.push(this._handleTags([e])),this._rapiAccess.getTag(e).then(e=>{this._rapiAccess.getItems(e.items).then(e=>{e.forEach(e=>{this.getIsCatalogSynced(e.catalog)&&t.push(this._handleCatalog(e.catalog))})})}),this._singlePromiseFactory.create(2,e,i=>{Promise.all(t).then(()=>{SYNCED_FLOORS_TAGS.set(e,!0),i()},e=>this._softReject(i,'_syncTypeChangeTag error: "'+e+'"'))})):Promise.resolve()}getIsCatalogSynced(e){return!!SYNCED_CATALOGS.get(e)}_startWorker(){return new Promise((e,t)=>{if(this._isStarted)return e();this._bootCallbacks.push({resolve:e,reject:t}),this._isStarting||(this._worker=new Worker(getAssetPath()+"static/workers/asset-loader.worker.js"),this._mainThreadToWorker=new MainThreadToWorker(this,this._worker),this._isStarting=!0,this._mainThreadToWorker.sendToWorker(1))})}onCommand(e,t,i){switch(e){case 4:this._isStarted=!0,this._bootCallbacks.forEach(({resolve:e})=>e());break;case 3:this._mainThreadToWorker.resolvePromises(t,i)}}_handleCatalog(e){return this._singlePromiseFactory.create(0,e,t=>this.getIsCatalogSynced(e)?t():this._rapiAccess.getCatalog(e).then(e=>Promise.all([this._handleContentWithAssets(this._rapiAccess.getComponentsOf(e),["perspectiveImage"]),this._handleItemsAndAdditionalContents(e),this._handleMaterialsAndTextures(e),this._handleExternalMeshes(e),this._handleTags(e.tags)])).then(()=>{SYNCED_CATALOGS.set(e,!0),t()},e=>this._softReject(t,'Catalog sync error: "'+e+'"')))}_handleTags(e){return this._handleContentWithAssets(this._rapiAccess.getTags(e),["pngIcon","svgIcon"])}_handleExternalMeshes(e){return new Promise(t=>{this._rapiAccess.getMeshesOfCatalog(e.id).then(e=>{const i=[];e.forEach(e=>{i.push(this._handleContentWithAssets(Promise.all([this._rapiAccess.getMesh(e.id)]),["url"]))}),Promise.all(i).then(t,e=>this._softReject(t,'Sync crt files error: "'+e+'"'))},e=>this._softReject(t,'getMeshesOfCatalog error: "'+e+'"'))})}_handleItemsAndAdditionalContents(e){return new Promise((t,i)=>{this._rapiAccess.getItemsOf(e).then(e=>{const i=[];i.push(this._handleContentWithAssets(Promise.resolve(e),["perspectiveImage"])),this._rapiAccess.getAdditionalContentsOfItems(e).then(e=>{const t=e.filter(e=>-1!==[5,6,4].indexOf(e.type));i.push(this._handleContentWithAssets(Promise.resolve(t),["content"]))},e=>this._softReject(t,'getAdditionalContentsOfItems error: "'+e+'"')),Promise.all(i).then(t,e=>this._softReject(t,'AdditionalContent image sync error:"'+e+'"'))})})}_handleMaterialsAndTextures(e){return new Promise((t,i)=>{this._rapiAccess.getMaterialsOf(e).then(e=>{const i=[];i.push(this._handleContentWithAssets(Promise.resolve(e),["thumbnail"])),e.forEach(e=>{i.push(this._handleContentWithAssets(this._rapiAccess.getTexturesOf(e),["image"]))}),Promise.all(i).then(t,e=>this._softReject(t,'getTexturesOf error: "'+e+'"'))},e=>this._softReject(t,'getMaterialsOf error: "'+e+'"'))})}_handleContentWithAssets(e,t){return new Promise(i=>e.then(e=>this._fetchAssets(e,t).then(i,e=>this._softReject(i,'_handleContentWithAssets error: "'+e+'"')),e=>this._softReject(i,'_handleContentWithAssets promise error: "'+e+'"')))}_fetchAssets(e,t){const i=[];e||(e=[]);for(let s=0,n=e.length;s<n;s++){const n=e[s];t.forEach(e=>{const t=n[e];t&&i.push(this._preCacheAsset(t))})}return Promise.all(i)}_preCacheAsset(e){return new Promise(t=>{if(ASSET_CACHE.get(e))return t();this._assetUrlToBase64(e).then(i=>{ASSET_CACHE.set(e,i),t()},e=>this._softReject(t,'_preCacheAsset error: "'+e+'"'))})}_assetUrlToBase64(e){return new Promise(t=>{this._mainThreadToWorker.sendToWorker(5,e,t,e=>this._softReject(t,'_assetUrlToBase64 error: "'+e+'"'))})}_softReject(e,t){this._errorHandler.softReject(e,t,2)}requestAsset(e,t=!1){return navigator.onLine&&!this._alwaysUseCache?e:ASSET_CACHE.get(e)||(t?e:null)}setAlwaysUseCache(e){this._alwaysUseCache=e}preFillAssetCache(e,t){ASSET_CACHE.set(e,t)}}__decorate([inject],DataSyncer.prototype,"_rapiAccess",void 0),__decorate([inject],DataSyncer.prototype,"_singlePromiseFactory",void 0),__decorate([inject],DataSyncer.prototype,"_errorHandler",void 0),__decorate([inject],DataSyncer.prototype,"_configuratorUiCallbacks",void 0);class StaticItemLoader{constructor(e){if(this._gltfLoaderGuard=new AsyncGuard,this._creator_=e,THREE.GLTFLoader&&THREE.DRACOLoader)this._initLoaders();else{let e=this._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader"}),t=this._scriptLoader.fetch("static/three/lib/loaders/draco/DRACOLoader.js",{id:"draco-loader"});Promise.all([e,t]).then(()=>this._initLoaders())}}_initLoaders(){this._gltfLoader=new THREE.GLTFLoader;const e=new THREE.DRACOLoader;e.setDecoderPath(getAssetPath()+"static/three/lib/loaders/draco/"),this._gltfLoader.setDRACOLoader(e),this._gltfLoaderGuard.resolve(this._gltfLoader)}async loadGLB(e,t,i,s,n,o,a){return await this._gltfLoaderGuard.wait(),new Promise((r,h)=>{this._gltfLoader.load(e,e=>{r(this._handleGLTFScene("GLB",e,t,i,s,n,o,a))},e=>{},e=>{h(e)})})}async loadGLTF(e,t,i,s,n,o,a){return await this._gltfLoaderGuard.wait(),new Promise((r,h)=>{this._gltfLoader.parse(e,null,e=>{r(this._handleGLTFScene("GLTF",e,t,i,s,n,o,a))},e=>{},e=>{h(e)})})}_handleGLTFScene(e,t,i,s,n,o,a,r){if(!t||!t.scene||!t.scene.children||0===t.scene.children.length)return null;if(i&&t.scene.position.copy(i),s&&(t.scene.rotation.y=s),n){const e=new THREE.Box3;e.setFromObject(t.scene);const{x:i,y:s,z:o}=e.getSize(new THREE.Vector3);let a=new THREE.Vector3(n.x/i,n.y/s,n.z/o);t.scene.scale.copy(a)}return o&&t.scene.scale.multiply(o),t.scene.type=e,t.scene.traverse(e=>{if(e instanceof THREE.Mesh){if(e.material instanceof THREE.MeshStandardMaterial){const t=e.material;if(this._environmentLoader.setEnvMap(t),r&&a&&a>0){let e=new THREE.Color(a);t.color=e.copyGammaToLinear(e),t.roughness=.5,t.metalness=.1}t.needsUpdate=!0}e.castShadow=!0,e.receiveShadow=!0}}),t.scene}}__decorate([inject],StaticItemLoader.prototype,"_environmentLoader",void 0),__decorate([inject],StaticItemLoader.prototype,"_scriptLoader",void 0);class ThreeLoader{constructor(e){this._jsonLoaded=!1,this._creator_=e}_loadShaders(){return new Promise((e,t)=>{if(this._jsonLoaded)return e();this._networkLayer.fetch(getAssetPath()+"static/three/lib/shaders.json",{credentials:"same-origin"}).then(handleJsonResponse,t).then(t=>{window._rsl=t,this._jsonLoaded=!0,e()},t)})}fetch(){return window._rsl||(window._rsl={}),new Promise((e,t)=>this._loadShaders().then(()=>{this._scriptLoader.fetch("static/three/lib/rthree.js",{id:"three-lib"}).then(e,t)},t))}}__decorate([inject],ThreeLoader.prototype,"_scriptLoader",void 0),__decorate([inject],ThreeLoader.prototype,"_networkLayer",void 0);const DEFAULT_STORE="rml_default",DEFAULT_STORE_SIZE=5;class LocalStorageHelper{constructor(e){this._context_=e}getStore(e=DEFAULT_STORE){return this._localStorage.getItem(e)||{entries:[]}}saveStore(e,t){this._localStorage.setItem(e,t)}addItem(e,t,i=DEFAULT_STORE,s=DEFAULT_STORE_SIZE){const n=this.getStore(i),o=n.entries.find(t=>t.id===e);if(o?(o.payload=t,o.date=Date.now()):n.entries.push({id:e,date:Date.now(),payload:t}),n.entries.length>s)for(n.entries.sort((e,t)=>t.date-e.date);n.entries.length>s;)n.entries.pop();this.saveStore(i,n)}getItem(e,t=DEFAULT_STORE){const i=this.getStore(t).entries.find(t=>t.id===e);return i?i.payload:null}}__decorate([inject],LocalStorageHelper.prototype,"_localStorage",void 0);class DynamicQualitySettingLoader{set(e,t){t&&(void 0!==t.enableAA&&(e.enableAA=t.enableAA),this._setSAOPass(e,t),this._setShadowPass(e,t),this._setGroundShadow(e,t))}_setSAOPass(e,t){if(t.SAOPass){const i=t.SAOPass;void 0!==i.enabled&&(e.getSAOPass().enabled=i.enabled),void 0!==i.smoothTransition&&(e.getSAOPass().smoothTransition=i.smoothTransition),i.occlusionWorldRadius&&(e.getSAOPass().occlusionWorldRadius=i.occlusionWorldRadius),i.intensity&&(e.getSAOPass().intensity=i.intensity),i.bias&&(e.getSAOPass().bias=i.bias),i.numSamples&&(e.getSAOPass().numSamples=i.numSamples)}}_setShadowPass(e,t){if(t.shadowPass){const i=t.shadowPass;void 0!==i.enabled&&(e.getShadowPass().enabled=i.enabled),void 0!==i.smoothTransition&&(e.getShadowPass().smoothTransition=i.smoothTransition),void 0!==i.enableAccumulation&&(e.getShadowPass().enableAccumulation=i.enableAccumulation),i.shadowRadius&&(e.getShadowPass().shadowRadius=i.shadowRadius),i.shadowBiasMultiplier&&(e.getShadowPass().shadowBiasMultiplier=i.shadowBiasMultiplier),i.numSamples&&(e.getShadowPass().numSamples=i.numSamples)}}_setGroundShadow(e,t){if(t.groundShadow){const i=t.groundShadow;void 0!==i.enable&&(e.getShadowPlanePass().enable=i.enable),void 0!==i.smoothTransition&&(e.getShadowPlanePass().smoothTransition=i.smoothTransition),i.numSamples&&(e.getShadowPlanePass().numSamples=i.numSamples),i.numSamplesPerFrame&&(e.getShadowPlanePass().numSamplesPerFrame=i.numSamplesPerFrame)}}}const convertToTHREE=e=>new THREE.Vector3(e.x/1e3,e.z/1e3,e.y/-1e3),convertToEuler=e=>new THREE.Euler(e.x,e.z,-e.y),convertToThreeDimensions=e=>new THREE.Vector3(e.x/1e3,e.z/1e3,e.y/1e3),convertToKernel=e=>({x:1e3*e.x,y:-1e3*e.z,z:1e3*e.y}),utilityStringToUTF16=e=>decodeURIComponent(encodeURIComponent(e)),convertCObject=e=>{if(!e){const t=typeof e;return"number"===t||"boolean"===t?e:null}if(!e.hasOwnProperty("size")&&e.size&&"function"==typeof e.size){let t=utilityToArray(e);for(let e=0;e<t.length;e++)t[e]=convertCObject(t[e]);return"string"==typeof t?utilityStringToUTF16(t):t}if("object"==typeof e)for(let t in e)e.hasOwnProperty(t)&&(e[t]=convertCObject(e[t]));return"string"==typeof e?utilityStringToUTF16(e):e},utilityToArray=e=>{let t=[];if(e){let i=e.size();for(let s=0;s<i;s++)t.push(e.get(s))}return t},convertToThreeMatrix=e=>{let t=new THREE.Matrix4,i=convertCObject(e);return t.fromArray(i),t.transpose(),(e=>{let t=new THREE.Matrix4;t.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),t.scale(new THREE.Vector3(.001,.001,.001));let i=new THREE.Matrix4;return i.set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),i.scale(new THREE.Vector3(1e3,1e3,1e3)),t.multiply(e).multiply(i)})(t)};function RoomleComponentFactoryInitializer(){class e extends THREE.Object3D{constructor(e,t,i,s){super(),this._selected=!1,this.geometryChanged=!0,this.meshes=[],this.castShadow=!0,this.receiveShadow=!0,this._setValues(e,t,i,s)}static _generateOutline(e,t){let i=new THREE.LineSegments(new THREE.EdgesGeometry(e),new THREE.LineDashedMaterial({color:"#000000",dashSize:.03,gapSize:.01,linewidth:1}));return i.translateOnAxis(t,1),i.userData.ignoreComponentRaycast=!0,i}static cloneDockLine(e,t){let i=new THREE.LineSegments(e.geometry,e.material);return i.translateOnAxis(t.getCenter(new THREE.Vector3),1),i.name="dockline",i.layers.set(5),i.userData.ignoreComponentRaycast=!0,i}_setValues(e,t,i,s){e&&(this.roomleId=e),t&&(this.roomlePosition=Object.assign({},t)),i&&(this.roomleRotation=Object.assign({},i)),s&&(this.parentObjectId=s)}get loadingMesh(){return this._loadingMesh}get boundingBoxMesh(){return this._boundingBoxMesh}get boundingBox(){return this._boundingBox}set roomlePosition(e){this._roomlePosition=e,e&&this.position.set(e.x/1e3,e.z/1e3,e.y/-1e3)}get roomlePosition(){return this._roomlePosition}set roomleRotation(e){this._roomleRotation=e,e&&this.rotation.set(e.x,e.z,-e.y)}get roomleRotation(){return this._roomleRotation}replaceMeshes(e){this.removeAllMeshes(),e.forEach(e=>{this.addMesh(new THREE.Mesh(e.geometry,e.material))})}addMesh(e,t){e.renderOrder=2,e.userData.meshType=0,e.castShadow=!0,e.receiveShadow=!0,t&&e.applyMatrix(convertToThreeMatrix(t)),this.add(e),this.meshes.push(e)}removeMesh(e){const t=this.meshes.indexOf(e);this.remove(e),disposeMesh(e),t<0||this.meshes.splice(t,1)}removeAllMeshes(e=!0){this.meshes.forEach(t=>{this.remove(t),e&&disposeMesh(t)}),this.meshes=[],this.remove(this._loadingMesh),disposeMesh(this._loadingMesh),this._loadingMesh=null,this.remove(this._boundingBoxMesh),disposeMesh(this._boundingBoxMesh),this._boundingBoxMesh=null}select(){this._selected=!0}loading(){this._kernelBoundingBox||console.warn("Bounding box (box for measurements) for component "+this.roomleId+" not set, can not show external mesh loading box!")}deselect(){this._selected=!1}hoverOn(){setCursor("pointer")}hoverOff(){setCursor("default")}removeFromParent(){this.parent&&(this.parent.remove(this),this.removeAllMeshes())}clear(t){this.hoverOff(),t&&this.children.forEach(i=>{i instanceof e&&i.clear(t)})}computeBoundingBox(t,i=!1){let s;if(this._boundingBoxMesh&&this.remove(this._boundingBoxMesh),!t||i){this._boundingBox=new THREE.Box3;let e=new THREE.Vector3;this.meshes.forEach(t=>{if(t.geometry instanceof THREE.Geometry){let i=t.geometry.vertices;for(let s=0,n=i.length;s<n;s++)e.copy(i[s]),e.applyMatrix4(t.matrix),this._boundingBox.expandByPoint(e)}else if(t.geometry instanceof THREE.BufferGeometry){let i=t.geometry.attributes.position;if(void 0!==i)for(let s=0,n=i.count;s<n;s++)e.fromBufferAttribute(i,s).applyMatrix4(t.matrixWorld),this._boundingBox.expandByPoint(e)}}),this._kernelBoundingBox=this._boundingBox.clone();let t=this._boundingBox.max.x-this._boundingBox.min.x,i=this._boundingBox.max.y-this._boundingBox.min.y,n=this._boundingBox.max.z-this._boundingBox.min.z;s=new THREE.BoxGeometry(t,i,n)}else{this._kernelBoundingBox=kernelBoxToThreeBox(t),this._boundingBox=this._kernelBoundingBox.clone();let{x:e,y:i,z:n}=this._boundingBox.getSize(new THREE.Vector3);s=new THREE.BoxGeometry(e,i,n)}this._boundingBoxMesh=new THREE.Mesh(s,new THREE.MeshStandardMaterial({color:"#FFFFFF",transparent:!0,opacity:0,polygonOffset:!0,polygonOffsetFactor:-1,visible:!1})),this._boundingBoxMesh.name="bounding box mesh";let n=this._boundingBox.getCenter(new THREE.Vector3);this._boundingBoxMesh.position.add(n),this._boundingBoxMesh.layers.set(5),this._boundingBoxMesh.renderOrder=3,this._boundingBoxMesh.castShadow=!1,this._boundingBoxMesh.receiveShadow=!1,this.add(this._boundingBoxMesh),this._dockline=e._generateOutline(s,n),this._dockline.name="bounding box outline",this._dockline.layers.set(5),this._selected&&this.add(this._dockline)}recursiveMeshes(){let t=this.meshes.slice();return this.children.forEach(i=>{i instanceof e&&t.push(...i.recursiveMeshes())}),t}isChild(t){let i=!1;return this.children.forEach(s=>{s instanceof e&&!i&&(i=s.roomleId===t||s.isChild(t))}),i}getKernelPosition(e){let t=this.parent.localToWorld(this.position);return convertToKernel(e.worldToLocal(t))}}class t extends e{constructor(e,t){super(e,null,null,null),this.glbUrl=t}}class i extends e{constructor(e,t,i,s){super(e,t,i,s),this._stringId=null,this.receivedPointAssociation=!1,this.castShadow=!1,this.receiveShadow=!1}get stringId(){return this._stringId?this._stringId:this.roomleId.toString()}addMesh(e,t){super.addMesh(e,t),e.material instanceof THREE.MeshStandardMaterial&&(e.material.opacity=DOCK_PREVIEW_MATERIAL_OPACITY,e.material.roughness=DOCK_PREVIEW_MATERIAL_ROUGHNESS,e.material.metalness=DOCK_PREVIEW_MATERIAL_METALNESS,e.material.color=new THREE.Color(DOCK_PREVIEW_MATERIAL_COLOR)),e.renderOrder=1,e.castShadow=!1,e.receiveShadow=!1}hoverOn(){this.remove(this._dockline),this.meshes.forEach(({material:e})=>{e.opacity=DOCK_PREVIEW_MATERIAL_OPACITY_HOVERED,e.roughness=DOCK_PREVIEW_MATERIAL_ROUGHNESS,e.metalness=DOCK_PREVIEW_MATERIAL_METALNESS,e.color=new THREE.Color(DOCK_PREVIEW_MATERIAL_COLOR)}),setCursor("pointer")}hoverOff(){this.add(this._dockline),this.meshes.forEach(({material:e})=>{e.opacity=DOCK_PREVIEW_MATERIAL_OPACITY,e.roughness=DOCK_PREVIEW_MATERIAL_ROUGHNESS,e.metalness=DOCK_PREVIEW_MATERIAL_METALNESS,e.color=new THREE.Color(DOCK_PREVIEW_MATERIAL_COLOR)}),setCursor("default")}clonePreview(t){let s=new i(this.roomleId,this.roomlePosition,this.roomleRotation,this.parentObjectId);return s._stringId=this.roomleId+"_"+t,this.children.forEach(e=>{e instanceof THREE.Mesh&&0===e.userData.meshType&&s.meshes.push(e.clone(!0))}),s.meshes.forEach(e=>{e.material=e.material.clone(),e.geometry=e.geometry.clone(),s.add(e)}),this._dockline&&(s._dockline=e.cloneDockLine(this._dockline,this._boundingBox)),this._boundingBoxMesh&&(s._boundingBoxMesh=this._boundingBoxMesh.clone(!0)),this._boundingBox&&(s._boundingBox=this._boundingBox.clone()),s}preparePreview(){this.add(this._dockline),this.add(this._boundingBoxMesh)}}class s extends i{constructor(e,t,i,s,n){super(e,t,i,s),n&&(this._stringId=this.roomleId+"_has_additional_dock_point_copy")}set roomleLineFrom(e){this._roomleLineFrom=e,this.lineFrom=convertToTHREE(e)}get roomleLineFrom(){return this._roomleLineFrom}set roomleLineTo(e){this._roomleLineTo=e;let t=convertToTHREE(e);t.equals(this.lineFrom)&&(console.warn("lineFrom and lineTo are equal!"),t.add(new THREE.Vector3(0,.01,0))),this.lineTo=t}get roomleLineTo(){return this._roomleLineTo}set roomlePositionFrom(e){this._roomlePositionFrom=e,this.positionFrom=convertToTHREE(e)}get roomlePositionFrom(){return this._roomlePositionFrom}set roomlePositionTo(e){this._roomlePositionTo=e;let t=convertToTHREE(e);t.equals(this.positionFrom)&&(console.warn("positionFrom and positionTo are equal!"),t.add(new THREE.Vector3(0,.01,0))),this.positionTo=t}get roomlePositionTo(){return this._roomlePositionTo}addMesh(e,t){super.addMesh(e,t),e.visible=!1,e.renderOrder=3}hoverOn(){this._dockline.visible=!0,setCursor("pointer")}hoverOff(){this._dockline.visible=!1,setCursor("default")}preparePreview(){super.preparePreview(),this._dockline.visible=!1;let e=this.lineTo.clone(),t=this.lineFrom.clone();const i=(new THREE.Vector3).subVectors(e,t);let s=i.length(),n=i.normalize(),o=new THREE.ArrowHelper(n,t),a=new THREE.CylinderGeometry(.01,.01,s,16,1);this.lineMesh=new THREE.Mesh(a,new THREE.MeshStandardMaterial({color:PREVIEW_MATERIAL_COLOR,transparent:!0,opacity:PREVIEW_LINE_MATERIAL_OPACITY})),this.lineMesh.name="line mesh";const r=(new THREE.Quaternion).setFromEuler(o.rotation);this.lineMesh.quaternion.multiply(r),this.lineMesh.renderOrder=1;let h=(new THREE.Vector3).addVectors(e,t).multiplyScalar(.5);this.lineMesh.position.copy((new THREE.Vector3).subVectors(h,this.position.clone())),this.add(this.lineMesh);let l=this._boundingBox.getCenter(new THREE.Vector3),c=null,_=0,d=Math.abs(n.x),u=Math.abs(n.y),g=Math.abs(n.z);d>=u&&d>=g?(c=new THREE.Vector3(l.x,0,0),_=Math.sqrt(l.y*l.y+l.z*l.z)):u>=d&&u>=g?(c=new THREE.Vector3(0,l.y,0),_=Math.sqrt(l.x*l.x+l.z*l.z)):g>=u&&g>=d&&(c=new THREE.Vector3(0,0,l.z),_=Math.sqrt(l.y*l.y+l.x*l.x)),_=_>0?_:.01;let m=(new THREE.Vector3).subVectors(this.positionTo.clone(),this.positionFrom.clone()).length()+c.length(),p=new THREE.CylinderGeometry(1.1*_,1.1*_,m,32,1);this.boundingLineMesh=new THREE.Mesh(p,new THREE.MeshStandardMaterial({color:"#ffffff",transparent:!0,opacity:0})),this.boundingLineMesh.name="bounding line mesh",this.boundingLineMesh.userData.ignoreComponentRaycast=!0;let E=this.positionTo.clone(),w=this.positionFrom.clone(),T=(new THREE.Vector3).subVectors(E,w).normalize(),R=new THREE.ArrowHelper(T,w);const y=(new THREE.Quaternion).setFromEuler(R.rotation);this.boundingLineMesh.quaternion.multiply(y),this.boundingLineMesh.renderOrder=3;let S=(new THREE.Vector3).addVectors(this.positionTo.clone(),this.positionFrom.clone()).multiplyScalar(.5).add(l);this.boundingLineMesh.position.copy((new THREE.Vector3).subVectors(S,this.position.clone())),this.add(this.boundingLineMesh)}clonePreviewLine(t){let i=new s(this.roomleId,this.roomlePosition,this.roomleRotation,this.parentObjectId,this.receivedPointAssociation);return i._stringId=this.roomleId+"_"+t,this.children.forEach(e=>{e instanceof THREE.Mesh&&0===e.userData.meshType&&i.meshes.push(e.clone(!0))}),i.meshes.forEach(e=>{e.material=e.material.clone(),e.geometry=e.geometry.clone(),i.add(e)}),this._dockline&&(i._dockline=e.cloneDockLine(this._dockline,this._boundingBox)),this._boundingBoxMesh&&(i._boundingBoxMesh=this._boundingBoxMesh.clone(!0)),this._boundingBox&&(i._boundingBox=this._boundingBox.clone()),i}getPositionForIntersectionPoint(e){let t=this.positionTo.clone().add(this._boundingBox.getCenter(new THREE.Vector3)),i=this.positionFrom.clone().add(this._boundingBox.getCenter(new THREE.Vector3)),s=new THREE.Line3(i,t).closestPointToPoint(e,!0,new THREE.Vector3);return(isNaN(s.x)||isNaN(s.y)||isNaN(s.z))&&s.copy(e),s.sub(this._boundingBox.getCenter(new THREE.Vector3))}updatePreviewPosition(e){let t=this.getPositionForIntersectionPoint(e),i=this.parent.localToWorld(t);this._newPosition=this.worldToLocal(i),this._dockline.position.copy((new THREE.Vector3).addVectors(this._newPosition,this._boundingBox.getCenter(new THREE.Vector3))),this._dockline.rotation.copy(this.docklineRotation)}hideSelectionLine(){this._dockline.visible=!1}getKernelPosition(e){if(this._newPosition){let t=this.localToWorld(this._newPosition);return convertToKernel(e.worldToLocal(t))}return super.getKernelPosition(e)}}class n extends THREE.PerspectiveCamera{constructor(e,t,i,s,n){super(e,t,i,s),n||(n={left:0,top:1,right:1,bottom:0}),this.offset=n}set offset(e){this._offset=e,this.updateProjectionMatrix()}get offset(){return this._offset}_calculateProjectionMatrix(){let e,t,i,s,n=this.fov*(2*Math.PI/360)/2;s=-(i=Math.tan(n));let o=Math.atan(this.aspect*Math.tan(n));e=-(t=Math.tan(o));let a=this._offset.left,r=this._offset.right,h=this._offset.top,l=this._offset.bottom,c=new THREE.Vector2(r-a,h-l),_=new THREE.Vector2(a+c.x/2,l+c.y/2);if(c.x<c.y){let n=(1-_.x)/(c.x/2),o=_.x/(c.x/2);t*=n,e*=o;let a=(n+o)/2;i*=a,s*=a}else{let n=(1-_.y)/(c.y/2),o=_.y/(c.y/2);i*=n,s*=o;let a=(o+n)/2;e*=a,t*=a}e*=this.near,t*=this.near,i*=this.near,s*=this.near;let d=this.near*Math.tan(Math.PI/180*.5*this.fov)/this.zoom*2,u=this.aspect*d;return this.view&&this.view.enabled&&(e+=this.view.offsetX*u/this.view.fullWidth,i-=this.view.offsetY*d/this.view.fullHeight,t+=this.view.offsetX*u/this.view.fullWidth,s-=this.view.offsetY*d/this.view.fullHeight),(new THREE.Matrix4).makePerspective(e,t,i,s,this.near,this.far)}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){this._offset?(this.projectionMatrix=this._calculateProjectionMatrix(),this.projectionMatrixInverse.getInverse(this.projectionMatrix)):super.updateProjectionMatrix()}}return{create:function(t,i,s,n){return new e(t,i,s,n)},createPreview:function(e,t){return new i(e,{x:0,y:0,z:0},{x:0,y:0,z:0},t)},createStatic:function(e,i){return new t(e,i)},createPreviewLine:function(e){let t=new s(e.id,e.roomlePosition,e.roomleRotation,e.parentObjectId,e.receivedPointAssociation);return e.meshes.forEach(e=>{let i=e.clone();i.material=e.material.clone(),i.geometry=e.geometry.clone(),t.addMesh(i)}),t.computeBoundingBox(),t},isPreview:function(e){return e instanceof i},isPreviewLine:function(e){return e instanceof s},createCamera:function(e,t,i,s,o){return new n(e,t,i,s,o)}}}const WAITERS=new Map,_endOperation=function(e,t,i){let s=WAITERS.get(e);if(s){const n=i?[i]:void 0;s.forEach(({resolve:e,reject:i})=>t?e.apply(e,n):i.apply(i,n)),WAITERS.delete(e)}};class AsyncHelper{static finishOperation(e,t){_endOperation(e,!0,t)}static failOperation(e,t){_endOperation(e,!1,t)}static waitFor(e,t){return new Promise((i,s)=>{let n=WAITERS.get(e);n||(WAITERS.set(e,[]),n=WAITERS.get(e)),n.push({resolve:i,reject:s}),"function"==typeof t&&t.apply(t)})}}const START_SUFFIX="_start",META_INFO=new Map;class Benchmark{static start(e){if(!window.performance||!window.performance.getEntriesByName)return"";let t=window.performance.getEntriesByName(e).length++,i="";t<100&&(i="0"),t<10&&(i="0"+i);const s=t>0?e+"_"+i+t:e,n=s+START_SUFFIX;return window.performance.mark(n),s}static addMeta(e,t){const i=Benchmark.getMeta(e);META_INFO.set(e,Object.assign(i,t))}static getMeta(e){return META_INFO.get(e)||{}}static end(e){}static getMeasure(e){return[]}static showBenchmarks(e){const t=window.performance.getEntriesByType("measure");t.sort(function(e,t){return e.startTime-t.startTime});const i=[];for(let s=0,n=t.length;s<n;s++){const n=t[s];e&&-1===n.name.indexOf(e)||i.push({Start:parseFloat(n.startTime.toFixed(2)),Name:n.name,Duration:parseFloat(n.duration.toFixed(2))})}console.table(i)}}const DOCKING_CONVERSATION_ID=10,DEFAULT_CONVERSATION_ID=9;class ConfiguratorViewModel{constructor(e){this._mergeThreshold=3,this._componentsToMerge=new OccurrenceMap,this._mergeInProgress=!1,this._components=new Map,this._previews=new Map,this._creator_=e,this._getKernelAccess().addConfiguratorListener(this),this._componentFactory=RoomleComponentFactoryInitializer()}get materialQueue(){return this._configuratorMeshGenerator.materialQueue}_getKernelAccess(){return RoomleDependencyInjection.lookup("kernel-access",this._creator_)}clearReference(){this._getKernelAccess().removeConfiguratorListener(this)}_addMeshToSubPart(e,t,i,s,n,o,a,r){let h=this._generateMesh(e,t,i,n,o,a,r);s&&h.applyMatrix(convertToThreeMatrix(s)),this._subPartObject.add(h)}_addMeshToComponent(e,t,i,s,n,o,a,r){if(this._subPartGuard&&this._subPartGuard.info===e)return void this._addMeshToSubPart(e,null,i,null,n,o,a,r);let h=this._components.get(e);if(!h&&!(h=this._previews.get(e.toString())))return void console.warn("component not found!",e);const l=this._componentFactory.isPreview(h);let c=this._generateMesh(e,t,l?null:i,n,o,a,r);i&&(c.userData.material=i),s&&(c.userData.transform=convertToThreeMatrix(s),c.applyMatrix(c.userData.transform)),l&&c.layers.set(4),h&&h.addMesh(c),h.meshes.length>this._mergeThreshold&&this._componentsToMerge.set(e,h.meshes.length)}tryToMergeComponents(){this._mergeInProgress||(this._mergeInProgress=!0,this._componentsToMerge.size,this._requestMergeComponents())}_requestMergeComponents(){window.requestIdleCallback(this._mergeNextComponent.bind(this))}_mergeNextComponent(){if(this._componentsToMerge.size>0){const e=this._componentsToMerge.largestValue();this._componentsToMerge.delete(e),this._mergeComponent(e),this._requestMergeComponents()}else this._mergeInProgress=!1,this._geometriesMerged&&this._geometriesMerged(),this._components.forEach(e=>{e.loadingMesh&&console.warn("component still has loading mesh: ",e.hash)})}_mergeComponent(e){const t=this._components.get(e);if(t&&!(t.meshes.length<=this._mergeThreshold))if(this._cacheHolder.componentCache.has(t.hash)){const e=this._cacheHolder.componentCache.get(t.hash).meshes;t.replaceMeshes(e)}else{const e=new Map,i=[],s=[];t.meshes.forEach(t=>{const n=t.userData.material;if(!n)return void console.warn("mesh has no material id set");if(!e.has(n)){const s=new THREE.Mesh(new THREE.Geometry,t.material);s.userData.material=n,s.receiveShadow=!0,s.castShadow=!0,s.layers.set(3),this._setMaterial(s,n),i.push(s),e.set(n,s)}const o=e.get(n).geometry;t.userData.transform?o.merge(t.geometry,t.userData.transform):o.merge(t.geometry),s.push(t)}),i.forEach(e=>t.addMesh(e)),s.forEach(e=>t.removeMesh(e)),this._cacheHolder.componentCache.set(t.hash,t)}}_addRootComponent(e){this._listener&&this._listener.display(e)}removeDockingComponent(){this._getKernelAccess().requestDeleteComponent(this._configuratorContext.dockingRootComponentId),this._configuratorContext.dockingRootComponentId=null}dockComponent(e,t,i,s){let n=this._components.get(t),o=this._components.get(e);o&&(o.roomlePosition=i,o.roomleRotation=s,n&&n.add(o))}dockComponentWithPosition(e,t){let i,s=this._components.get(e.parentId);i=t?t.getKernelPosition(s):e.getKernelPosition(s);const n=Benchmark.start("dock_component_with_position_"+e.childId);this._getKernelAccess().dockComponentWithPosition(e.parentId,e.parentDockId,e.childId,e.childDockId,i),this._configuratorContext.dockingRootComponentId=null,Benchmark.end(n)}removePreviews(){this._previews.size>0&&(this._previews.forEach(e=>{e.removeFromParent(),e.removeAllMeshes()}),this._previews.clear())}_updatePlanObject(e){const t=this._components.get(e.rootPlanComponentId).geometryChanged;this._listener&&this._listener.planObjectUpdated(e,t)}Editor3dAddBakedMesh(e,t,i,s,n,o){this._addMeshToComponent(e,null,t,null,i,s,n,o)}Editor3dAddDockPreview(e,t){let i=this._componentFactory.createPreview(t,e);this._previews.set(t.toString(),i)}Editor3dAddNamedMesh(e,t,i,s,n,o,a,r){this._addMeshToComponent(e,t,i,s,n,o,a,r)}Editor3dBeginConstruction(e){let t=this._components.get(e);t?t.removeAllMeshes():this._subPartGuard&&e===this._subPartGuard.info&&(this._subPartObject=new THREE.Object3D)}Editor3dComponentCreated(e,t,i,s,n){n&&(this._configuratorContext.rootComponentId=e);let o=null;this._components.has(e)?(o=this._components.get(e)).removeAllMeshes():(o=this._componentFactory.create(e,t,i,s)).layers.set(3),this._components.set(e,o),n&&this._addRootComponent(o)}Editor3dComponentDocked(e,t,i,s){this.dockComponent(e,t,i,s)}Editor3dEndConstruction(e){if(this._subPartGuard&&this._subPartGuard.info===e)return void this._subPartGuard.resolve(this._subPartObject);let t=this._getKernelAccess().kernelInstance.getComponent(e),i=this._components.get(e);i&&(i.computeBoundingBox(t.boxForMeasurement),i.boundingBoxMesh&&this._listener&&this._listener.addComponentHandlers(i));let s=this._previews.get(e.toString());s&&s.computeBoundingBox(t.boxForMeasurement,!0)}Editor3dGeometryReady(e){this._getKernelAccess().kernelInstance.requestPlanComponentConstruction(e)}Editor3dGeometryNotReady(e){let t;this._components.has(e)&&(t=this._components.get(e)).loading()}Editor3dPlanObjectConstructionDone(e){const t=this._getKernelAccess().kernelInstance.getPlanObject(e),i=this._getKernelAccess().kernelInstance.getFullPartList(),s=this._getKernelAccess().kernelInstance.getHashOfConfiguration(e),n=this._getKernelAccess().kernelInstance.getComponentId(t.rootPlanComponentId),o=[t,i.fullList,s,n];AsyncHelper.finishOperation(2,o),this._updatePlanObject(t),this._listener&&this._listener.planObjectConstructionDone(t)}Editor3dPreviewConstructionDone(e,t){let i=!1;this._previews.forEach(e=>{null!==e.parent&&(this._listener&&(this._componentFactory.isPreviewLine(e)?this._listener.addPreviewLineHandlers(e):this._listener.addPreviewHandlers(e)),i=!0)}),this._listener&&this._listener.previewConstructionDone(this._components.get(e),i)}Editor3dSetPreviewLineAssociations(e,t){let i=this._previews.get(t.toString());if(i.clear(),!i)return;let s=this._componentFactory.createPreviewLine(i),n=this._components.get(this._configuratorContext.rootComponentId);for(let t=0;t<e.length;t++){let i;(i=0===t?s:s.clonePreviewLine(t)).name="Preview Line",i.parentDockId=e[t].parentDockId,i.parentId=e[t].parentId,i.childDockId=e[t].childDockId,i.childId=e[t].childId,i.docklineRotation=convertToEuler(e[t].rotation),i.roomlePosition=e[t].position,e[t].lineFrom.x>e[t].lineTo.x||e[t].lineFrom.y>e[t].lineTo.y||e[t].lineFrom.z>e[t].lineTo.z?(i.roomleLineFrom=e[t].lineTo,i.roomleLineTo=e[t].lineFrom):(i.roomleLineFrom=e[t].lineFrom,i.roomleLineTo=e[t].lineTo),e[t].positionFrom.x>e[t].positionTo.x||e[t].positionFrom.y>e[t].positionTo.y||e[t].positionFrom.z>e[t].positionTo.z?(i.roomlePositionFrom=e[t].positionTo,i.roomlePositionTo=e[t].positionFrom):(i.roomlePositionFrom=e[t].positionFrom,i.roomlePositionTo=e[t].positionTo),n.add(i),i.preparePreview(),this._previews.set(i.stringId,i)}}Editor3dSetPreviewPointAssociations(e,t){let i=this._previews.get(t.toString());if(!i)return;let s=this._components.get(this._configuratorContext.rootComponentId);for(let t=0;t<e.length;t++){let n;0===t?n=i:(n=i.clonePreview(t),this._previews.set(n.stringId,n)),n.name="Preview Point",n.parentDockId=e[t].parentDockId,n.parentId=e[t].parentId,n.childDockId=e[t].childDockId,n.childId=e[t].childId,n.preparePreview(),n.receivedPointAssociation=!0,n.userData.ignoreComponentRaycast=!0,s.add(n),n.roomlePosition=e[t].position,n.roomleRotation=e[t].rotation}}componentDeleted(e){const t=this._components.get(e);t&&(this._listener&&this._listener.componentDeleted(t),t.removeFromParent(),t.removeAllMeshes(),this._components.delete(e))}componentMetaUpdated(e){const t=this._getRuntimeComponent(e.id);t&&(t.hash=e.hash,t.roomlePosition=e.position,t.roomleRotation=e.rotation,e.boxForMeasurement&&t.computeBoundingBox(e.boxForMeasurement),this._listener&&this._listener.componentUpdated(t,e))}componentConfigurationUpdated(e,t){const i=this._getRuntimeComponent(e);i&&(i.geometryChanged=t)}_getRuntimeComponent(e){let t=this._components.get(e);return t||(t=this._previews.get(e.toString()))?t:null}configurationLoaded(e,t,i,s,n){e===DOCKING_CONVERSATION_ID&&(this._configuratorContext.dockingRootComponentId=i);let o=0===t;o?this._getKernelAccess().kernelInstance.requestPlanComponentConstructionRecursive(i):this._getKernelAccess().kernelInstance.requestPlanObjectConstruction(t);let a=this._getKernelAccess().kernelInstance.getComponent(i),r=this._components.get(i);r&&(r.computeBoundingBox(a.boxForMeasurement),r.hash=a.hash),this._listener&&this._listener.configurationLoaded(r,o&&void 0!==r.boundingBoxMesh)}finishParameterChange(e,t){this.materialQueue.registerCallback(e)}planObjectConfigurationUpdated(e,t,i){let s=this._getKernelAccess().kernelInstance.getPlanObject(e);this._updatePlanObject(s)}planObjectCreated(e,t){this._configuratorContext.planObjectId=t,this._listener&&this._listener.clearScene()}planObjectUpdated(e){this._updatePlanObject(e)}sceneCleared(){this._components.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._components.clear(),this._previews.forEach(e=>{e.removeFromParent(),e.removeAllMeshes()}),this._previews.clear()}setListener(e){this._listener=e}getBoundingBox(){const e=this._components.get(this._configuratorContext.rootComponentId);return e?(new THREE.Box3).setFromObject(e):null}hasPreviews(){return this._previews.size>0}clearRootComponent(){this._components.get(this._configuratorContext.rootComponentId).clear(!0)}debugSceneGraph(e){e?this._components.has(e)?this._components.get(e):this._previews.has(e.toString())&&this._previews.get(e.toString()):this._configuratorContext}getComponentsForIds(e){let t=[];return e.forEach(e=>{const i=this._components.get(e);i&&t.push(i)}),t}getComponents(){return Array.from(this._components.values())}getPreviews(){return Array.from(this._previews.values())}isPreviewLine(e){return this._componentFactory.isPreviewLine(e)}isPreview(e){return this._componentFactory.isPreview(e)}setGeometriesMergedListener(e){this._geometriesMerged=e}removeGeometriesMergedListener(){this._geometriesMerged=void 0}setMergeThreshold(e){this._mergeThreshold=e}_generateMesh(e=0,t=null,i,s,n,o,a,r,h){return this._configuratorMeshGenerator.generateMesh(e,t,i,s,n,o,a)}_setMaterial(e,t,i){this._configuratorMeshGenerator.setMaterial(e,t)}constructComponents(e){this._getKernelAccess().kernelInstance.requestPlanObjectConstruction(e)}requestSubPartConstruction(e){return this._subPartGuard=new AsyncGuard(e),this._getKernelAccess().kernelInstance.requestPlanComponentConstruction(e),this._subPartGuard.wait()}}__decorate([inject],ConfiguratorViewModel.prototype,"_configuratorMeshGenerator",void 0),__decorate([inject],ConfiguratorViewModel.prototype,"_configuratorContext",void 0),__decorate([inject],ConfiguratorViewModel.prototype,"_cacheHolder",void 0);class OccurrenceMap extends Map{largestValue(){let e=this.entries().next().value[0],t=0;return this.forEach((i,s)=>{i>t&&(e=s,t=i)}),e}}const INJECTABLES=[new DependencyInjectionAssignment("error-handler",class{constructor(){this._listeners={}}_subscribe(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}subscribe(e,t){this._subscribe(e,t)}dispatch(e,t){if(!this._listeners[e])return;const i=this._listeners[e];let s=i.length;for(let e=0;e<s;e++){const s=i[e];s.apply(s,t)}}unsubscribe(e,t){if(!this._listeners[e])return;const i=this._listeners[e];let s=i.length;for(let e=0;e<s;e++)if(i[e]===t)return i.splice(e,1),s--,void e--}softReject(e,t,i){return this.dispatch(i,[t]),e()}}),new DependencyInjectionAssignment("form-data-util",FormDataUtil),new DependencyInjectionAssignment("environment-loader",EnvironmentLoader),new DependencyInjectionAssignment("static-item-loader",StaticItemLoader,0),new DependencyInjectionAssignment("form-data-util",FormDataUtil),new DependencyInjectionAssignment("single-promise-factory",class{constructor(e){this._promises=new Map,this._creator_=e}create(e,t,i){return new Promise((s,n)=>{let o=this._promises.get(e),a=!0;if(!o){const t=new Map;this._promises.set(e,t),o=this._promises.get(e),a=!1}o.get(t)||(o.set(t,[]),a=!1);const r=o.get(t);r.push({resolve:s,reject:n}),o.set(t,r);const h=()=>{o.delete(t),0===o.size&&this._promises.delete(e)};a||new Promise(i).then(e=>{o.get(t).forEach(({resolve:t})=>t(e)),h()},e=>{o.get(t).forEach(({reject:t})=>t(e)),h()})})}},1),new DependencyInjectionAssignment("dynamic-light-setting-loader",DynamicLightSettingLoader),new DependencyInjectionAssignment("dynamic-quality-setting-loader",DynamicQualitySettingLoader),new DependencyInjectionAssignment("network-layer",NetworkLayer),new DependencyInjectionAssignment("local-storage",class{constructor(e){this._context_=e}get _localStorage(){let e=null;try{e=window.localStorage}catch(e){console.error(e)}return e}getItem(e){if(!this._localStorage)return null;const t=this._localStorage.getItem(e);try{return JSON.parse(t)}catch(e){return t}}setItem(e,t){if(this._localStorage)try{const i=JSON.stringify(t);this._localStorage.setItem(e,i)}catch(e){console.error(e)}}}),new DependencyInjectionAssignment("network-layer",NetworkLayer),new DependencyInjectionAssignment("kernel-io",class extends Logger{throw(e){this.error("[Kernel Exception]: "+e)}}),new DependencyInjectionAssignment("data-syncer",DataSyncer),new DependencyInjectionAssignment("memory-manager",class{constructor(){this._configurationStringSet=new Set,this._singleLoadCounter=0}loadingConfigurationString(){this._singleLoadCounter+=1}loadingConfiguration(e){this._configurationStringSet.add(e),this._singleLoadCounter+=1}shouldHardReset(){return this._configurationStringSet.size>=15||this._singleLoadCounter>=30}executedHardReset(){this._configurationStringSet.clear(),this._singleLoadCounter=0}}),new DependencyInjectionAssignment("life-cycle-manager",class{constructor(){this._listeners=[]}addEventListener(e){this._listeners.push(e)}removeEventListener(e){const t=this._listeners;let i=t.length;if(i)for(let s=0;s<i;s++)t[s]===e&&(t.splice(s,1),s--,i--)}pause(){this._listeners.forEach(e=>e.pause())}resume(){this._listeners.forEach(e=>e.resume())}destroy(){this._listeners.forEach(e=>e.destroy())}},1),new DependencyInjectionAssignment("three-loader",ThreeLoader),new DependencyInjectionAssignment("local-storage-helper",LocalStorageHelper),new DependencyInjectionAssignment("cache-holder",class{constructor(){this._componentCache=new Map,this._geometryCache=new Map,this._materialCache=new Map}get componentCache(){return this._componentCache}get geometryCache(){return this._geometryCache}get materialCache(){return this._materialCache}clear(){for(const e of this._componentCache.values())disposeObject(e);for(const e of this._materialCache.values())disposeMaterial(e);for(const e of this._geometryCache.values())disposeGeometry(e);this._componentCache.clear(),this._geometryCache.clear(),this._materialCache.clear()}},0),new DependencyInjectionAssignment("kernel-access-callback",class{constructor(e){this._callbackListener=new Set,this._creator_=e}addListener(e){this._callbackListener.add(e)}removeListener(e){this._callbackListener.delete(e)}isReady(){this._callbackListener.forEach(e=>e.isReady())}loadError(e){this._callbackListener.forEach(t=>t.loadError(e))}},1),new DependencyInjectionAssignment("configurator-kernel-access-callback",class{constructor(e){this._callbackListener=new Set,this._creator_=e}addListener(e){this._callbackListener.add(e)}removeListener(e){this._callbackListener.delete(e)}isReady(){this._callbackListener.forEach(e=>e.isReady())}updatePossibleChildren(e,t,i){this._callbackListener.forEach(s=>s.updatePossibleChildren(e,t,i))}updateParameters(e,t,i,s){this._callbackListener.forEach(n=>n.updateParameters(e,t,i,s))}loadError(e){this._callbackListener.forEach(t=>t.loadError(e))}},1),new DependencyInjectionAssignment("configurator-view-model",ConfiguratorViewModel,1),new DependencyInjectionAssignment("configurator-context",class{constructor(){this.rootComponentParametersAsGlobal=!1,this.lastLoadedRapiId=null,this.selectedRuntimeComponentIds=[],this.selectionMode="standard"}get selectedRuntimeComponentId(){return this.selectedRuntimeComponentIds.length>0?this.selectedRuntimeComponentIds[0]:null}},1)];class RoomleDependencyInjection{static setup(e){RoomleDependencyInjection.addToContainer(e)}static lookup(e,t){return window.__RML__DI__?window.__RML__DI__.lookup(e,t):null}static getContext(e){return window.__RML__DI__?window.__RML__DI__.getContext(e):null}static cleanUp(e){return window.__RML__DI__?window.__RML__DI__.cleanUp(e):null}static addToContainer(e){window.__RML__DI__||(window.__RML__DI__=new Container,window.__RML__DI__.addDependencyInjectionAssignments(INJECTABLES)),window.__RML__DI__.addDependencyInjectionAssignments(e)}}class Main{constructor(e){this._context=e}_setupCommonGlobals(){window.__RML__DEBUG__||(window.__RML__DEBUG__={}),window.__RML__ENV__||(window.__RML__ENV__={},window.__RML__ENV__.assetPath||(window.__RML__ENV__.assetPath=""));const e={retina:!1,overrideCountry:null,locale:AppContext.actualLocale,unit:null,unitStringType:null,dls:null,ls:null,meshSelection:!0,colors:ROOMLE_COLORS,enableHSC:!1,mode:"3D",edit:!1,stats:!1,_measureTraffic:!1,enableHD:!0,debug:!1,gammaOutput:!0,transparentHighlighting:!1};window.__RML__ENV__.initData?window.__RML__ENV__.initData=Object.assign(e,window.__RML__ENV__.initData):window.__RML__ENV__.initData=e;const t=getAllParameters();window.__RML__ENV__.initData=Object.assign(window.__RML__ENV__.initData,t)}_setupCommonDependencies(){}_cleanUpCommonGlobals(){window.__RML__DEBUG__&&(window.__RML__DEBUG__.Kernel&&window.__RML__DEBUG__.Kernel.clearAll&&window.__RML__DEBUG__.Kernel.clearAll(),delete window.__RML__DEBUG__),delete window.__RML__ENV__;for(const e in window.THREE)if(window.THREE.hasOwnProperty(e))try{delete window.THREE[e]}catch(e){console.error(e)}window.THREE=void 0}_cleanUpCommonDependencies(){}boot(e){this._setupCommonGlobals(),this.setupGlobals(e),this._setupCommonDependencies(),this.setupDependencies(),this.bootFinished()}lookup(e,t){return window.__RML__DI__.lookup(e,t)}teardown(){this.cleanUpDependencies(),this._cleanUpCommonDependencies(),this.cleanUpGlobals(),this._cleanUpCommonGlobals(),window.__RML__DI__&&delete window.__RML__DI__}pause(){this.lookup("life-cycle-manager",this._context).pause(),window.TWEEN&&TWEEN.removeAll()}resume(e){e&&this.lookup("dom-helper",this._context).setDomElement(e),this.lookup("life-cycle-manager",this._context).resume()}destroy(){this.pause(),this.lookup("life-cycle-manager",this._context).destroy(),RoomleDependencyInjection.cleanUp(this._context)}getRapiAccess(){return this.lookup("rapi-access",this._context)}}const CANVAS_ID={HSC:"rml-hsc",HSP:"rml-hsp",GLB:"rml-glb",RMV:"rml-mv"},CONTAINER_CSS_CLASS="rml-threejs-canvas-container";class DomHelper{constructor(e){this._creator_=e,this._lifeCycleManager.addEventListener(this)}get element(){return this._container}setDomElement(e){if(!this._container){this._container=document.createElement("div"),this._container.classList.add(CONTAINER_CSS_CLASS),this._container.setAttribute("ondragover","return false"),this._container.style.position="relative",this._container.style.width="100%",this._container.style.height="100%";const t=document.createElement("style");t.innerText="."+CONTAINER_CSS_CLASS+" canvas{position:absolute;top:0;left:0;right:0;bottom:0;}."+CONTAINER_CSS_CLASS+" .foreground{z-index:100; opacity:1;}."+CONTAINER_CSS_CLASS+" .background{z-index:-1; opacity:0;}",this._container.appendChild(t),e.appendChild(this._container)}this._element=e}getClientDimensions(){return new THREE.Vector2(this._element.clientWidth,this._element.clientHeight)}_removeDomElement(e){if(!e)return;const t=e.parentElement;t&&t.removeChild(e)}reset(){this._element=null,this._removeDomElement(this._container),this._container=null}pause(){this.reset()}resume(){}destroy(){}}__decorate([inject],DomHelper.prototype,"_lifeCycleManager",void 0);class EventDispatcher{constructor(){this._listeners={}}_addEventListener(e,t,i){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push({callback:t,scope:i})}addEventListener(e,t,i){this._addEventListener(e,t,i)}dispatchEvent(e,t){if(!this._listeners[e])return;const i=this._listeners[e];let s=i.length;for(let e=0;e<s;e++){const s=i[e];s.callback.apply(s.scope,[t])}}removeEventListener(e,t){const i=this._listeners[e];if(i)for(let e=0,s=i.length;e<s;e++)if(i[e].callback===t)return void i.splice(e,1)}}const INITIAL_YAW=-30,INITIAL_PITCH=10,INITIAL_CAMERA_DISTANCE=-1;class CameraControl extends EventDispatcher{constructor(e,t,i){super(),this._tweenEnd=null,this._cameraStandingStill=!0,this._pitch=toRadiant(INITIAL_PITCH),this._yaw=toRadiant(INITIAL_YAW),this._distance=INITIAL_CAMERA_DISTANCE,this._locked=!1,this._inputListeners=[],this._creator_=e,this._inputManager=t,this._initInputListener(),this._addInputListeners(),this._cameraPosition=new THREE.Vector3,this._targetPosition=new THREE.Vector3,i?this._cameraPosition.copy(i):this._cameraPosition=new THREE.Vector3(0,.5,3);let s=this._domHelper.getClientDimensions();this._width=s.x,this._height=s.y,this._dispatchCameraIdle=debounce(this._dispatchCameraIdle.bind(this),16)}getCamera(){return this._getCamera()}_addInputListeners(){this._inputListeners.forEach(e=>{this._inputManager.addEventListener(e.key,e.fun,this)})}_removeInputListeners(){this._inputListeners.forEach(e=>{this._inputManager.removeEventListener(e.key,e.fun)}),this._inputListeners=[]}cleanUp(){this._removeInputListeners()}animateCamera(e){let t=this._cameraPosition;if(!t||position3VectorsAreEqual(t,this.getCamera().position))return this._cameraStandingStill||(this._cameraStandingStill=!0,this._dispatchCameraIdle()),!1;this._cameraStandingStill&&this.dispatchEvent(7,3),this._cameraStandingStill=!1;let i=this.getCamera().position.clone(),s=Math.min(10*e,1);return i.lerp(t,s),this.getCamera().position.copy(i),!0}_dispatchCameraIdle(){this.dispatchEvent(8,3)}_areEqual(e,t){return e.yaw.toFixed(5)===t.yaw.toFixed(5)&&e.pitch.toFixed(5)===t.pitch.toFixed(5)&&e.distance.toFixed(5)===t.distance.toFixed(5)&&e.targetX===t.targetX&&e.targetY===t.targetY&&e.targetZ===t.targetZ}_tweenCameraParameter(e,t,i){return new Promise(i=>{if(t.yaw-e.yaw<=-Math.PI?e.yaw-=2*Math.PI:t.yaw-e.yaw>=Math.PI&&(e.yaw+=2*Math.PI),window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=t,new TWEEN.Tween(e).to(t,400).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{this.dispatchEvent(1,3),this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._update(new THREE.Vector3(e.targetX,e.targetY,e.targetZ))}).onComplete(()=>{this.dispatchEvent(2,3),this._tweenEnd=null,i()}).start(),this.dispatchEvent(0,3)}})}_getCurrentCameraParameters(){let e=this._targetPosition.clone();return{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:e.x,targetY:e.y,targetZ:e.z}}_rotateHorizontal(e){this._yaw-=e,this._yaw<-Math.PI?this._yaw+=2*Math.PI:this._yaw>Math.PI&&(this._yaw-=2*Math.PI)}_rotateVertical(e){this._pitch+=e,this._pitch<-Math.PI?this._pitch+=2*Math.PI:this._pitch>Math.PI&&(this._pitch-=2*Math.PI)}saveState(e){if(e||!this._stateSaved){let e=this._yaw,t=this._pitch,i=this._distance,s=this._targetPosition.clone();if(this._stateSaved={yaw:e,pitch:t,distance:i,targetX:s.x,targetY:s.y,targetZ:s.z,blockOtherTweens:!0},this._getCamera().fov){let e=this._getCamera();this._stateSaved.fov=e.fov,this._stateSaved.near=e.near,this._stateSaved.far=e.far}return this._stateSaved}return null}resetToState(){if(this._stateSaved){this._stateSaved.blockOtherTweens=!1;let e=this._targetPosition.clone();this._tweenCameraParameter({yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:e.x,targetY:e.y,targetZ:e.z},this._stateSaved,!0)}this._stateSaved=null}setToState(e,t){this._tweenCameraParameter(e,t,!0)}hasSavedState(){return null!=this._stateSaved}lock(){this._locked=!0}unlock(){this._locked=!1}getTargetPosition(){return this._targetPosition}_saveYawAndPitch(){this._getCamera().userData.yaw=this._yaw,this._getCamera().userData.pitch=this._pitch}getInputPosition(e){const{x:t,y:i}=this._domHelper.getClientDimensions();return new THREE.Vector3(e.x/t*2-1,-e.y/i*2+1,.5)}addLightContainer(e){e.name="lights";const t=this._getCamera(),i=t.children.find(e=>"lights"===e.name);i&&t.remove(i),t.add(e)}}__decorate([inject],CameraControl.prototype,"_domHelper",void 0);class ZoomChangeEvent{constructor(e,t){this.minZoom=!1,this.maxZoom=!1,this.minZoom=e,this.maxZoom=t}}const ROTATION_SPEED=1,ZOOM_SPEED=4,MAX_DISTANCE_MINIMAL=2,DISTANCE_FACTOR=2.725,MAX_POLAR_ANGLE=85;class CameraControl3D extends CameraControl{constructor(e,t,i,s){super(e,t,i),this._bounds=new THREE.Vector3,this._scale=1,this._state=0,this._zoomSpeed=Math.pow(.95,ZOOM_SPEED),this.minDistance=0,this.maxDistance=5,this.minPolarAngle=toRadiant(0),this.maxPolarAngle=toRadiant(MAX_POLAR_ANGLE),this.minAzimuthAngle=Number.NEGATIVE_INFINITY,this.maxAzimuthAngle=Number.POSITIVE_INFINITY,this._userInteraction=!1,this._currentZoomHash="",s?this._camera=s:this._initCamera(),this._targetPosition=new THREE.Vector3(0,0,0);let{cameraRestriction:n,minVerticalCameraAngle:o,maxVerticalCameraAngle:a,minHorizontalCameraAngle:r,maxHorizontalCameraAngle:h}=window.__RML__ENV__.initData;if(void 0!==o&&(this.minPolarAngle=toRadiant(o<0?o:-1*o)),void 0!==a&&(this.maxPolarAngle=toRadiant(a)),void 0!==r&&(this.minAzimuthAngle=toRadiant(r<0?r:-1*r)),void 0!==h&&(this.maxAzimuthAngle=toRadiant(h)),void 0!==n){let e=Math.abs(toRadiant(n));this.minAzimuthAngle=-e,this.maxAzimuthAngle=e,this.maxPolarAngle=Math.min(e,toRadiant(MAX_POLAR_ANGLE))}}_getCamera(){return this._camera?this._camera:(this._initCamera(),this._camera)}_initCamera(){this._camera=new THREE.PerspectiveCamera,this._camera.fov=30,this._camera.aspect=this._width/this._height,this._camera.near=.1,this._camera.far=100,this._camera.updateProjectionMatrix(),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();this._camera.aspect=e/t,this._camera.updateProjectionMatrix()}animateCamera(e){if(!super.animateCamera(e))return!1;let t=this._targetPosition;return!!t&&(this.getCamera().lookAt(t),!0)}_initInputListener(){this._inputListeners.push({key:3,fun:e=>{this._state=1}}),this._inputListeners.push({key:6,fun:e=>{1!==this._state||this._locked||(this._userInteraction=!0,this._move(new THREE.Vector2(e.position.x,e.position.y),e.type))}}),this._inputListeners.push({key:4,fun:e=>{1===this._state&&this.dispatchEvent(2,e.type),this._state=0,this._orbitPosition=null}}),this._inputListeners.push({key:7,fun:e=>this.zoomIn()}),this._inputListeners.push({key:8,fun:e=>this.zoomOut()})}_move(e,t){this._orbitPosition||(this._orbitPosition=new THREE.Vector2(e.x,e.y),this.dispatchEvent(0,t));let i=e.clone().sub(this._orbitPosition),s=this._domHelper.element;this._rotateHorizontal(2*Math.PI*i.x/s.clientWidth*ROTATION_SPEED),this._rotateVertical(2*Math.PI*i.y/s.clientHeight*ROTATION_SPEED),position2VectorsAreEqual(this._orbitPosition,e)||this.dispatchEvent(1,t),this._orbitPosition.copy(e),this._update()}setBounds(e){this._boundingBox=e}updateToBounds(e,t,i,s,n=!0,o){this.setBounds(e);let a=e.getSize(new THREE.Vector3);const r=e.getCenter(new THREE.Vector3);this._targetPosition=o?o.clone():new THREE.Vector3(r.x,r.y,r.z);const h=this._setDistanceAndRangesBasedOnBounds(a,t,i);this._distance=h,n&&(this._userInteraction?this._tweenCameraParameter(this._getCurrentCameraParameters(),{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:this._targetPosition.x,targetY:this._targetPosition.y,targetZ:this._targetPosition.z},s):this._update())}_setDistanceAndRangesBasedOnBounds(e,t,i){this._bounds.copy(e),this.minDistance=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);const s=Math.max(e.x,e.y),n=t>1080?.5:0,o=t>1080?0:.3;let a=getIdealDistance(e.x+n,e.y+o,e.z,this._camera.fov,t,i);return this._distance<a&&(this._distance=a),this.maxDistance=a+s,this.maxDistance<MAX_DISTANCE_MINIMAL&&(this.maxDistance=MAX_DISTANCE_MINIMAL),this._camera.far=5*this.maxDistance,a}reset(e,t,i,s,n,o,a=!0){if(e){s?this._targetPosition.copy(s):this._targetPosition=new THREE.Vector3(0,e.y/2,0);let r=this._getCurrentCameraParameters();n||(n=INITIAL_YAW),o||(o=INITIAL_PITCH),this._pitch=toRadiant(o),this._yaw=toRadiant(n),this._setDistanceAndRangesBasedOnBounds(e,t,i);let h=this._targetPosition.clone();this._areEqual(r,{yaw:this._yaw,pitch:this._pitch,distance:this._distance,targetX:h.x,targetY:h.y,targetZ:h.z})?this._moveCameraForthAndBack():a?this._tweenCameraParameter(r,{yaw:this._yaw,pitch:this._pitch,distance:this.maxDistance,targetX:h.x,targetY:h.y,targetZ:h.z},!0):this._update(this._targetPosition)}else console.warn("you cant reset without bounds!")}updateAndReset(e,t,i,s,n,o,a,r=!0){let h=new THREE.Vector3(-e.x/2,0,-e.z/2),l=new THREE.Vector3(e.x/2,e.y,e.z/2);if(this._boundingBox=new THREE.Box3(h,l),a&&e.addScalar(a),s?this._targetPosition.copy(s):this._targetPosition=new THREE.Vector3(0,e.y/2,0),this._distance===INITIAL_CAMERA_DISTANCE){let s=this._setDistanceAndRangesBasedOnBounds(e,t,i);this._distance=Math.max(MAX_DISTANCE_MINIMAL,s)}let c=this._getCurrentCameraParameters();n||(n=INITIAL_YAW),o||(o=INITIAL_PITCH),this._pitch=toRadiant(o),this._yaw=toRadiant(n),this._setDistanceAndRangesBasedOnBounds(e,t,i);let _=this._targetPosition.clone();r?this._tweenCameraParameter(c,{yaw:this._yaw,pitch:this._pitch,distance:this.maxDistance,targetX:_.x,targetY:_.y,targetZ:_.z},!0):this._update(this._targetPosition)}_moveCameraForthAndBack(){if(window.TWEEN){let e={value:.6*this._camera.far},t={value:this._distance};new TWEEN.Tween(e).to(t,300).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(()=>{this._distance=e.value,this._update()}).start()}}_restoreFromState(e){this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._targetPosition.copy(new THREE.Vector3(e.targetX,e.targetY,e.targetZ)),this._simulateUpdate()}simulateTo2D(e,t){return new Promise(i=>{let s=Math.max(e.x,e.z),n=getIdealDistance(s,s,s,this._camera.fov,window.innerWidth,window.innerHeight),o=this._getCurrentCameraParameters();this._camera.near=1,this._camera.far=n+50,this._camera.updateProjectionMatrix();let a={yaw:0,pitch:toRadiant(90),distance:n,targetX:t.x,targetY:n,targetZ:t.z};if(window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=a,new TWEEN.Tween(o).to(a,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(()=>{this._yaw=o.yaw,this._pitch=o.pitch,this._distance=o.distance,this._targetPosition.copy(new THREE.Vector3(o.targetX,0,o.targetZ)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,i()}).start()}})}simulateTo3D(e,t){return new Promise(i=>{if(this._restoreFromState(e),window.TWEEN){if(null!==this._tweenEnd&&this._tweenEnd.blockOtherTweens)return;this._tweenEnd=t,new TWEEN.Tween(e).to(t,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{this._yaw=e.yaw,this._pitch=e.pitch,this._distance=e.distance,this._targetPosition.copy(new THREE.Vector3(e.targetX,e.targetY,e.targetZ)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,i()}).start()}})}simulateToFirstPerson(e){return new Promise(t=>{if(window.TWEEN){let i=this.getCamera().position,s={x:i.x,y:i.y,z:i.z,yaw:this._yaw,pitch:this._pitch},n={x:e.x,y:e.y,z:e.z,yaw:0,pitch:0};new TWEEN.Tween(s).to(n,500).easing(TWEEN.Easing.Linear.None).onUpdate(()=>{this._yaw=s.yaw,this._pitch=s.pitch,this._targetPosition.copy(new THREE.Vector3(s.x,s.y,s.z)),this._simulateUpdate()}).onComplete(()=>{this._tweenEnd=null,t()}).start()}})}_update(e){this._yaw=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,this._yaw)),this._pitch=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._pitch)),this._saveYawAndPitch();let t=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX"),i=(new THREE.Quaternion).setFromEuler(t),s=new THREE.Vector3(0,0,-1);s.applyQuaternion(i),this._distance*=this._scale,this._distance=Math.min(this.maxDistance,this._distance),e&&this._targetPosition.copy(e);let n=this._targetPosition.clone().sub(s.multiplyScalar(this._distance)),o=this._getCameraSphere(n);null!=this._boundingBox&&this._boundingBox.intersectsSphere(o)&&this._scale>=1?this._distance+=.1:null==this._boundingBox||this._boundingBox.intersectsSphere(o)?this._zoomChanged(!1,!0):(this._cameraPosition.copy(n),this._distance===this.maxDistance?this._zoomChanged(!0,!1):this._zoomChanged(!1,!1)),this._scale=1}_zoomChanged(e,t){let i=e+""+t;0!==this._currentZoomHash.length&&this._currentZoomHash===i||(this.dispatchEvent(5,new ZoomChangeEvent(e,t)),this._currentZoomHash=i)}_simulateUpdate(){let e=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX"),t=(new THREE.Quaternion).setFromEuler(e),i=new THREE.Vector3(0,0,-1);i.applyQuaternion(t),this._cameraPosition.copy(this._targetPosition.clone().sub(i.multiplyScalar(this._distance)))}zoomTo(e,t,i,s,n,o){return this._tweenCameraParameter(this._getCurrentCameraParameters(),{yaw:s,pitch:n,distance:getIdealDistance(e.x,e.y,e.z,this._camera.fov,t,i)*DISTANCE_FACTOR,targetX:o.x,targetY:o.y,targetZ:o.z,blockOtherTweens:!0},!0)}_getCameraSphere(e){const t=Math.max(this._bounds.x,this._bounds.y),i=Math.max(t/10,.1);return new THREE.Sphere(e,i)}zoomIn(e){this._scale*=e?Math.pow(.95,e):this._zoomSpeed,this._update(),this.dispatchEvent(3)}zoomOut(e){this._scale/=e?Math.pow(.95,e):this._zoomSpeed,this._update(),this.dispatchEvent(4)}clear(){this._userInteraction=!1,this._distance=INITIAL_CAMERA_DISTANCE,this._targetPosition=new THREE.Vector3(0,0,0)}}let _scriptCache={},_idCache={};class ScriptLoader{constructor(e){this._creator_=e}fetch(e,t){return this._singlePromiseFactory.create(5,e,(i,s)=>{!function(e,t,i,s){if(-1===e.indexOf("http")&&(e=getAssetPath()+e),_scriptCache[e])return i();if(t.id&&_idCache[t.id])return s(new Error('There is already a script with ID "'+t.id+'"'));const n=Benchmark.start("load_"+t.id.replace(/-/g,"_")),o=document.createElement("script");o.async=!1,o.src=e,o.id=t.id,o.onload=(()=>{_scriptCache[e]=!0,_idCache[t.id]=!0,Benchmark.end(n),Object.defineProperty(i,"name",{value:"resolve-"+t.id}),i()}),o.onerror=(e=>{s(e)}),document.body.appendChild(o)}(e,t,i,s)})}loadScripts(e){const t=[];return e.forEach(e=>{let i=this.fetch(e.name,{id:e.id});t.push(i)}),Promise.all(t)}cleanUp(){for(let e in _idCache)if(_idCache.hasOwnProperty(e)){const t=document.getElementById(e);t&&t.parentElement.removeChild(t)}_scriptCache={},_idCache={}}}__decorate([inject],ScriptLoader.prototype,"_singlePromiseFactory",void 0);const BROWSER_EVENTS={MOUSE_MOVE:"mousemove",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",MOUSE_LEAVE:"mouseleave",MOUSE_ENTER:"mouseenter",MOUSE_WHEEL:"wheel",TOUCH_MOVE:"touchmove",TOUCH_START:"touchstart",TOUCH_END:"touchend",CONTEXT_MENU:"contextmenu"};class InputEvent{constructor(e,t,i,s){this.position=e,this.positionRelative=t,this.type=i,this.rotation=s}}const MIN_MOVE_DISTANCE=5*window.devicePixelRatio,MIN_DOLLY_DISTANCE=2*window.devicePixelRatio;class InputManager extends EventDispatcher{constructor(e){super(),this._debug=!1,this._elementHit=!1,this._delta=-1,this._state=0,this._pinchDistance=-1,this._rotationAngle=-1,this._lastMouseWheelEvent=null,this._lastTouchEvent=null,this._events=Object.keys(BROWSER_EVENTS).map(e=>BROWSER_EVENTS[e]),this._creator_=e,this._position={x:0,y:0},this._positionRelative={x:0,y:0},this._downPosition={x:0,y:0},this._downPositionRelative={x:0,y:0}}enableDragIn(e){this._state=1,this._dragEnabled=!0,e&&(this._dragMV=this._dragM.bind(this),this._dragEV=this._dragE.bind(this),this._dragTarget=e.currentTarget||e.target,this._delta=-1,this._dragMVName="drag",this._dragEVName="dragend",window.TouchEvent&&e instanceof TouchEvent?(this._dragMVName="touchmove",this._dragEVName="touchend"):e.dataTransfer&&e.dataTransfer.setData&&e.dataTransfer.setData("text/plain"," "),this._firefoxDragPosition={x:0,y:0},document.ondragover=(e=>{e=e||window.event,this._firefoxDragPosition.x=e.pageX,this._firefoxDragPosition.y=e.pageY}),this._dragTarget.addEventListener(this._dragMVName,this._dragMV,!1),this._dragTarget.addEventListener(this._dragEVName,this._dragEV,!1))}_dragM(e){let t=e,i=null,s=null;window.TouchEvent&&e instanceof TouchEvent?(i=this._getTouchPosition(t),s=this._getTouchPositionRelative(t)):(i=this._getMousePosition(t),s=this._getMousePositionRelative(t)),i.x>0&&i.y>0&&this._move(i,s)}_dragE(e){let t=e;document.ondragover=null,this._firefoxDragPosition=null,this._dragTarget.removeEventListener(this._dragMVName,this._dragMV),this._dragTarget.removeEventListener(this._dragEVName,this._dragEV),window.TouchEvent&&e instanceof TouchEvent?this._onUp(this._getTouchPosition(t),this._getTouchPositionRelative(t),2):this._onUp(this._getMousePosition(t),this._getMousePositionRelative(t),1)}addEvents(e){this._events.forEach(t=>e.addEventListener(t,this,!1))}removeEvents(e){this._events.forEach(t=>e.removeEventListener(t,this,!1))}_dolly(e){if(this._lastTouchEvent&&e.timeStamp-this._lastTouchEvent.timeStamp<40)return;let t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,s=Math.abs(t)+Math.abs(i);this._pinchDistance>-1&&(s>this._pinchDistance+MIN_DOLLY_DISTANCE&&this.dispatchEvent(7,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e))),s<this._pinchDistance-MIN_DOLLY_DISTANCE&&this.dispatchEvent(8,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e)))),this._pinchDistance=s,this._lastTouchEvent=e}_move(e,t,i){void 0===i&&(i=0),void 0===this._dragEnabled&&(this._dragEnabled=!1),1===this._state&&this._canDrag(i)&&(this._delta=this._getDelta(),this._delta>MIN_MOVE_DISTANCE&&(this._state=2,this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(0,new InputEvent(e,t)))),2===this._state&&this.dispatchEvent(1,new InputEvent(e,t)),this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(6,new InputEvent(e,t,i))}_longClick(){this._state=2,this._longClickTimer&&clearTimeout(this._longClickTimer),this.dispatchEvent(0,new InputEvent(this._downPosition,this._downPositionRelative)),this.dispatchEvent(1,new InputEvent(this._downPosition,this._downPositionRelative))}_onUp(e,t,i){this.dispatchEvent(4,new InputEvent(e,t,i)),this._getDelta()<=MIN_MOVE_DISTANCE&&this.dispatchEvent(5,new InputEvent(e,t)),2===this._state&&this.dispatchEvent(2,new InputEvent(e,t)),4===this._state&&(this.dispatchEvent(10,new InputEvent(e,t)),this._rotationAngle=-1),3===this._state&&(this._pinchDistance=-1),this._lastTouchEvent=null,this._state=0,this._dragTarget=null,this._elementHit=!1,this._longClickTimer&&clearTimeout(this._longClickTimer)}_getTouchPosition(e){if(e.changedTouches.length){let{clientX:t,clientY:i}=e.changedTouches[0];if(e.changedTouches.length>1){const s=e.changedTouches[1].clientX,n=e.changedTouches[1].clientY;t=(t+s)/2,i=(i+n)/2}this._position.x=t,this._position.y=i}return this._position}_getTouchPositionRelative(e){if(e.changedTouches.length){let t=this._domHelper.element.getBoundingClientRect(),{clientX:i,clientY:s}=e.changedTouches[0];this._positionRelative.x=(i-t.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(s-t.top)/this._domHelper.element.clientHeight*2+1}return this._positionRelative}_getMousePosition(e){if(0!==e.clientX&&0!==e.clientY)this._position.x=e.clientX,this._position.y=e.clientY;else{let{x:t,y:i}=this._getFireFoxMousePosition(e);this._position.x=t,this._position.y=i}return this._position}_getFireFoxMousePosition(e){let{x:t,y:i}=this._domHelper.getClientDimensions();return{x:t-(t+e.offsetX),y:i-(i+e.offsetY)}}_getMousePositionRelative(e){if(0!==e.clientX&&0!==e.clientY){let t=this._domHelper.element.getBoundingClientRect();this._positionRelative.x=(e.clientX-t.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(e.clientY-t.top)/this._domHelper.element.clientHeight*2+1}else if(this._firefoxDragPosition&&0!==this._firefoxDragPosition.x&&0!==this._firefoxDragPosition.y){let e=this._domHelper.element.getBoundingClientRect();this._positionRelative.x=(this._firefoxDragPosition.x-e.left)/this._domHelper.element.clientWidth*2-1,this._positionRelative.y=-(this._firefoxDragPosition.y-e.top)/this._domHelper.element.clientHeight*2+1}return this._positionRelative}_getDelta(){return Math.abs(this._downPosition.y-this._position.y)+Math.abs(this._downPosition.x-this._position.x)}setDragEnabled(e){this._dragEnabled=e}handleEvent(e){switch(this._debug&&e.type,e.type){case BROWSER_EVENTS.MOUSE_MOVE:this._onMouseMove(e);break;case BROWSER_EVENTS.MOUSE_DOWN:this._onMouseDown(e);break;case BROWSER_EVENTS.MOUSE_UP:this._onMouseUp(e);break;case BROWSER_EVENTS.MOUSE_LEAVE:this._onMouseLeave(e);break;case BROWSER_EVENTS.MOUSE_ENTER:this._onMouseEnter(e);break;case BROWSER_EVENTS.MOUSE_WHEEL:this._onMouseWheel(e);break;case BROWSER_EVENTS.TOUCH_MOVE:this._onTouchMove(e);break;case BROWSER_EVENTS.TOUCH_START:this._onTouchStart(e);break;case BROWSER_EVENTS.TOUCH_END:this._onTouchEnd(e);break;case BROWSER_EVENTS.CONTEXT_MENU:this._onContextMenu(e)}}_onMouseDown(e){e.preventDefault();let{x:t,y:i}=this._getMousePosition(e);this._downPosition={x:t,y:i},this._downPositionRelative=this._getMousePositionRelative(e),this.dispatchEvent(3,new InputEvent({x:t,y:i},this._downPositionRelative,1)),this._state=1}_onMouseUp(e){e.preventDefault(),this._onUp(this._getMousePosition(e),this._getMousePositionRelative(e),1)}_onMouseMove(e){e.preventDefault(),this._move(this._getMousePosition(e),this._getMousePositionRelative(e),1)}_onMouseLeave(e){this._delta=-1,this._onMouseUp(e)}_onMouseEnter(e){e.preventDefault()}_onMouseWheel(e){e.preventDefault(),e.stopPropagation(),this._lastMouseWheelEvent&&e.timeStamp-this._lastMouseWheelEvent.timeStamp<40||(e.deltaY<0?this.dispatchEvent(7,new InputEvent(this._getMousePosition(e),this._getMousePositionRelative(e))):this.dispatchEvent(8,new InputEvent(this._getMousePosition(e),this._getMousePositionRelative(e))),this._lastMouseWheelEvent=e)}_onTouchMove(e){if(e.preventDefault(),!this._dragTarget)if(1===e.touches.length)this._move(this._getTouchPosition(e),this._getTouchPositionRelative(e),2);else if(2===e.touches.length)if(this._elementHit||4===this._state){let t={x:e.touches[0].pageX,y:e.touches[0].pageY},i={x:e.touches[1].pageX,y:e.touches[1].pageY};const s=to360Degrees(getAngle(t,i));this._rotationAngle<0&&(this._rotationAngle=s);const n=s-this._rotationAngle;this._rotationAngle=s,this.dispatchEvent(9,new InputEvent(this._getTouchPosition(e),this._getTouchPositionRelative(e),2,toRadiant(n))),this._state=4}else this._state=3,this._dolly(e)}_onTouchStart(e){if(e.preventDefault(),1===e.touches.length){let{x:t,y:i}=this._getTouchPosition(e);this._downPosition={x:t,y:i},this._downPositionRelative=this._getTouchPositionRelative(e),this.dispatchEvent(3,new InputEvent({x:t,y:i},this._downPositionRelative,2)),this._state=1,this._longClickTimer=window.setTimeout(this._longClick.bind(this),350)}else 2===e.touches.length&&(1!==this._state&&2!==this._state||this._onUp(this._getTouchPosition(e),this._getTouchPositionRelative(e),2),this._state=3)}_onTouchEnd(e){e.preventDefault(),this._onUp(this._getTouchPosition(e),this._getTouchPositionRelative(e),2)}_onContextMenu(e){e.preventDefault()}_canDrag(e){return this._dragEnabled}onElementHit(){this._elementHit=!0}}__decorate([inject],InputManager.prototype,"_domHelper",void 0);class LightSetting{constructor(e,t){this._scene=e,t&&t.removeFromScene()}needsBounds(){return!1}updateBounds(e){}getCameraContainer(){return this._cameraContainer||(this._cameraContainer=new THREE.Object3D),this._cameraContainer}}class DynamicLightSetting extends LightSetting{constructor(e,t){super(e,t),this._lights=[]}needsBounds(){return!0}updateBounds(e){if(this._cameraLight){const t=this._cameraLight,i=new THREE.Vector3;e.getSize(i);const s=1.5*Math.max(Math.max(i.x,i.y),i.z);this._boundingSize=s,t.shadow.camera.top=s/2,t.shadow.camera.bottom=-s/2,t.shadow.camera.left=-s/2,t.shadow.camera.right=s/2,t.shadow.camera.updateProjectionMatrix()}}loadFromJSON(e){return new Promise((t,i)=>{this._lights=this._dynamicLightSettingLoader.parse(e),this.addToScene(),t()})}loadFromObject(e){return new Promise((t,i)=>{e.lights||t(),this._lights=this._dynamicLightSettingLoader.load(e),this._lights.filter((e,t)=>{e.userData.movesWithCamera&&(this._cameraLight=e,this._lights.splice(t,1))}),this.addToScene(),t()})}loadFromURL(e){return new Promise((t,i)=>{fetch(new Request(e,{method:"GET"})).then(handleJsonResponse).then(e=>this.loadFromObject(e).then(t,i))})}addToScene(){this._lights.forEach(e=>{this._scene.add(e)}),this._cameraLight&&this._scene.add(this._cameraLight)}update(e,t){if(!this._cameraLight)return;let i=new THREE.Vector3;e.getWorldDirection(i),i.multiplyScalar(-this._boundingSize);let s=t.clone().add(i);this._cameraLight.position.copy(s)}removeFromScene(){this._lights.forEach(e=>{this._scene.remove(e)}),this._cameraLight&&this._scene.remove(this._cameraLight)}reload(){this.removeFromScene(),this.addToScene()}showGUI(){let e=getGUI();this._cameraLight&&this._addToGUI(e,this._cameraLight),this._lights.forEach(t=>{this._addToGUI(e,t)})}_addToGUI(e,t){t instanceof THREE.SpotLight&&this._addSpotLightToGUI(e,t),t instanceof THREE.AmbientLight&&this._addAmbientLightToGUI(e,t),t instanceof THREE.DirectionalLight&&this._addDirectionalLightToGUI(e,t),t instanceof THREE.RectAreaLight&&this._addRectAreaLightToGUI(e,t)}_addRectAreaLightToGUI(e,t){let i=e.addFolder(t.name),s={name:t.name,color:"#"+t.color.getHexString(),intensity:t.intensity*(t.width*t.height)};i.add(t,"visible"),i.add(s,"intensity").min(10).max(400).step(10).onChange(e=>{t.intensity=e/(t.width*t.height)}),i.add(t,"castShadow"),i.addColor(s,"color").onChange(e=>{t.color=new THREE.Color(e)}),i.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),i.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),i.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}_addSpotLightToGUI(e,t){let i=e.addFolder(t.name),s={name:t.name,color:"#"+t.color.getHexString(),angle:180*t.angle/Math.PI};i.add(t,"visible"),i.add(t,"intensity").min(0).max(5).step(.1),i.add(t,"penumbra").min(0).max(1).step(.1),i.addColor(s,"color").onChange(e=>{t.color=new THREE.Color(e)}),i.add(s,"angle").min(10).max(180).step(1).onChange(e=>{t.angle=e*Math.PI/180}),i.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),i.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),i.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}_addAmbientLightToGUI(e,t){let i={name:t.name,color:"#"+t.color.getHexString()},s=e.addFolder(t.name);s.add(t,"visible"),s.add(t,"intensity").min(0).max(5).step(.1),s.addColor(i,"color").onChange(e=>{t.color=new THREE.Color(e)})}_addDirectionalLightToGUI(e,t){let i=e.addFolder(t.name),s={name:t.name,color:"#"+t.color.getHexString()};i.add(t,"visible"),i.add(t,"intensity").min(0).max(5).step(.1),i.addColor(s,"color").onChange(e=>{t.color=new THREE.Color(e)}),i.add(t,"castShadow"),i.add(t.position,"x").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),i.add(t.position,"y").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))}),i.add(t.position,"z").min(-10).max(10).step(.1).onChange(()=>{t.lookAt(new THREE.Vector3(0,0,0))})}}__decorate([inject],DynamicLightSetting.prototype,"_dynamicLightSettingLoader",void 0);class Environment{constructor(e,t){this._scene=e,t&&(t.removeFromScene(),t.cleanUp())}updateCamera(e){}reload(){this.removeFromScene(),this.addToScene()}updateBounds(e,t){this._bounds=e}cleanUp(){this._scene=null}}class GltfEnvironment extends Environment{constructor(e,t){super(e,t),this._gltfLoaderPromise=this._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader-js"}).then(()=>{this._gltfLoader=new THREE.GLTFLoader})}needsBounds(){return!0}needsCamera(){return!0}updateBounds(e){if(super.updateBounds(e),this._backgroundMesh){let t=Math.max(e.x,e.z)/6;t=Math.max(t,1),this._backgroundMesh.scale.copy(new THREE.Vector3(t,t,t))}}updateCamera(e){if(this._backgroundMesh){let t=e.getWorldDirection(new THREE.Vector3);t.y=0,t.lengthSq()<.01&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.multiplyScalar(-1),t.normalize();let i=Math.asin(t.x);t.z<0&&(i=Math.PI-i),this._backgroundMesh.rotation.set(0,i,0)}}addToScene(){this._scene&&this._backgroundMesh&&this._scene.add(this._backgroundMesh)}removeFromScene(){this._scene&&this._backgroundMesh&&this._scene.remove(this._backgroundMesh)}loadBackground(e,t){this._backgroundMaterial=t,this._backgroundMaterial||(this._backgroundMaterial=new THREE.MeshBasicMaterial),this._gltfLoaderPromise.then(()=>{this._gltfLoader.load(e,this._onBackgroundLoaded.bind(this),e=>{},e=>{console.error(e)})})}_onBackgroundLoaded(e){this._scene&&(this._backgroundMaterial.vertexColors=THREE.VertexColors,e&&e.scene&&e.scene.children&&e.scene.children.length>0&&(e.scene.children[0].material=this._backgroundMaterial,e.scene.children[0].layers.set(2),e.scene.position.copy(new THREE.Vector3(0,0,0)),this._backgroundMesh=e.scene,this._backgroundMesh.layers.set(2),this._backgroundMesh.receiveShadow=!0,setShadows(this._backgroundMesh,!0,!1),this.removeFromScene(),this.addToScene()))}showGUI(){console.warn("gui not implemented for gltf environment")}}__decorate([inject],GltfEnvironment.prototype,"_scriptLoader",void 0);const DEFAULT_BAKED_SHADOW_PARAMS={enable:!0,shadowMapResolution:512,smoothTransition:!0,numSamples:500,numSamplesPerFrame:4,bShadowMaterial:!0,falloff:1.5,darkness:.2,size:1.6,lightSolidAngle:40,yPosition:0},SHADOW_PLANE_MESH_NAME="Shadow plane";class BakedShadowEnvironment extends Environment{constructor(e,t){super(e,t),this._pixotronGuard=new AsyncGuard,this._params=Object.assign(DEFAULT_BAKED_SHADOW_PARAMS,{lightDirection:new THREE.Vector3(0,1,.5),onComplete:this._addGroundShadows.bind(this),onProgress:this._progressCallback.bind(this)})}_progressCallback(e){}needsBounds(){return!0}needsCamera(){return!1}needsRotation(){return!1}async setPixotron(e,t,i,s){e&&(this._pixotron=e,this._renderer=t,this._camera=i,this._shadowBaker||(this._shadowBaker=new window.PIXOTRON.PlaneShadowBakePass(Object.assign(this._params,s))),this._shadowBaker.enable?this._shadowBaker.startBake(this._renderer,this._scene,this._camera):this._shadowBaker.enable=!0,this._wasAAEnabled=this._pixotron.enableAA,await this._pixotronGuard.resolve())}async _addGroundShadows(){await this._pixotronGuard.wait(),this._pixotron.needsUpdate=!0,this._shadowPlane=this._shadowBaker.getShadowPlane(),this._shadowPlane.name=SHADOW_PLANE_MESH_NAME,this._shadowPlane.receiveShadow=!1,0!==this._params.yPosition&&(this._shadowPlane.position.y=this._params.yPosition),this._shadowPlane.visible=!0,this.addToScene(),this._loadedCallback&&this._loadedCallback()}setLoadedCallback(e){this._loadedCallback=e}updateBounds(e,t){const i=this._getNumberOfChildren();return!(vectorIsEqual(this._bounds,e,1e-4)&&this._scene&&i===this._sceneChildren&&!t||(super.updateBounds(e),this._pixotronGuard.wait().then(()=>{this._shadowPlane&&(this._shadowPlane.visible=!1),this._shadowBaker.startBake(this._renderer,this._scene,this._camera)}),this._sceneChildren=i,0))}_getNumberOfChildren(){let e=0;return this._scene.traverse(t=>{t.name!==SHADOW_PLANE_MESH_NAME&&e++}),e}addToScene(){this._shadowPlane&&(this._shadowPlane.material.needsUpdate=!0,fadeIn(this._shadowPlane),this._scene.add(this._shadowPlane))}removeFromScene(){this._shadowPlane&&(this._scene.remove(this._shadowPlane),this._pixotron&&(this._pixotron.enableAA=this._wasAAEnabled))}showGUI(){}}class BakedShadowPlane{constructor(e){this._innerSize=1,this._outerSize=100,this._plane=new THREE.Object3D,this._plane.rotation.x=-Math.PI/2;const t=new THREE.MeshStandardMaterial;this._innerPlaneMesh=new THREE.Mesh,this._innerPlaneMesh.material=t,this._innerPlaneMesh.receiveShadow=!0,this._outerPlaneMesh=new THREE.Mesh,this._outerPlaneMesh.material=t,this._outerPlaneMesh.receiveShadow=!0,this._plane.add(this._innerPlaneMesh),this._plane.add(this._outerPlaneMesh),this._innerSize=1,this._outerSize=e,this._updatePlane(this._innerSize,this._outerSize)}getRootNode(){return this._plane}getInnerPlane(){return this._innerPlaneMesh}getOuterPlane(){return this._outerPlaneMesh}updateSize(e){this._innerSize=e,this._updatePlane(this._innerSize,this._outerSize)}_updatePlane(e,t){const i=new THREE.Shape;i.moveTo(-e/2,-e/2),i.lineTo(-e/2,e/2),i.lineTo(e/2,e/2),i.lineTo(e/2,-e/2),i.lineTo(-e/2,-e/2);const s=new THREE.Shape;s.moveTo(-t/2,-t/2),s.lineTo(-t/2,t/2),s.lineTo(t/2,t/2),s.lineTo(t/2,-t/2),s.lineTo(-t/2,-t/2);const n=new THREE.Path;n.moveTo(-e/2,-e/2),n.lineTo(-e/2,e/2),n.lineTo(e/2,e/2),n.lineTo(e/2,-e/2),n.lineTo(-e/2,-e/2),s.holes.push(n);const o=new THREE.ShapeBufferGeometry(i);this._innerPlaneMesh.geometry&&this._innerPlaneMesh.geometry.dispose(),this._innerPlaneMesh.geometry=o;const a=new THREE.ShapeBufferGeometry(s);this._outerPlaneMesh.geometry&&this._outerPlaneMesh.geometry.dispose(),this._outerPlaneMesh.geometry=a;const r=o.attributes.uv.clone();o.addAttribute("uv2",r);const h=o.attributes.uv2.array;for(let e=0;e<h.length;++e)h[e]+=.5}}const INITIAL_FLOOR_SIZE=100,FOG_COLOR=16185078;class FloorEnvironment extends BakedShadowEnvironment{constructor(e,t,i){super(e,t),this._longestSide=2,this._bakedShadowPlane=new BakedShadowPlane(INITIAL_FLOOR_SIZE),this._fog=i||!1,this._textureLoader=new THREE.TextureLoader,this.addToScene()}needsBounds(){return!0}needsCamera(){return this._fog}needsRotation(){return!1}updateBounds(e){return super.updateBounds(e),this._longestSide=Math.max(e.x,e.z),this._update(),!0}updateCamera(e){this._cameraDistance=e.position.distanceTo(new THREE.Vector3(0,0,0)),this._update()}_update(){this._fog&&this._updateFog()}_updateFog(){let e=this._longestSide/2;this._scene.fog=new THREE.Fog(FOG_COLOR,this._cameraDistance+e+3,this._cameraDistance+e+3+1),this._scene.background=new THREE.Color(FOG_COLOR)}_updateFloor(){if(this._floorMaterial)this._bakedShadowPlane.getOuterPlane().material=this._floorMaterial,this._bakedShadowPlane.getInnerPlane().material=this._floorMaterial;else{let e=this._width/1e3,t=this._height/1e3;this._repeatable&&(this._floorTexture.wrapS=THREE.RepeatWrapping,this._floorTexture.wrapT=THREE.RepeatWrapping,this._floorTexture.repeat.set(INITIAL_FLOOR_SIZE/e,INITIAL_FLOOR_SIZE/t));let i=new THREE.MeshStandardMaterial({map:this._floorTexture,side:THREE.DoubleSide});this._bakedShadowPlane.getInnerPlane().material=i,this._bakedShadowPlane.getOuterPlane().material=i}}addToScene(){this._scene&&(this._shadowPlane&&(this._bakedShadowPlane.updateSize(this._shadowPlane.scale.x),this._bakedShadowPlane.getRootNode().position.copy(this._shadowPlane.position),this._bakedShadowPlane.getInnerPlane().material.aoMap=this._shadowPlane.material.aoMap),this._scene.add(this._bakedShadowPlane.getRootNode()))}removeFromScene(){this._scene.remove(this._bakedShadowPlane.getRootNode())}setFloorMaterial(e,t,i,s){return this._width=t,this._height=i,this._repeatable=s,this._floorPromise=new Promise((t,i)=>{this._textureLoader.load(e,e=>{this._floorTexture=e,t()},null,i)}),new Promise((e,t)=>{this._floorPromise.then(()=>{this._updateFloor(),this._update(),e()},t)})}changeFloorMaterial(e,t){this._floorPromise=new Promise((i,s)=>{let n=createMaterial(e,this._environmentLoader);this._rapiAccess.getTexturesOf(e).then(o=>{if(o.length>0){let e=[];o.forEach(i=>{e.push(addTexture(this._dataSyncer.requestAsset(i.image,!0),i,n,t,1,1))}),Promise.all(e).then(()=>{this._floorMaterial=n,setTimeout(()=>i(),0)},s)}else s("textures for material "+e.id+" are empty")}),(!e.textures||e.textures&&0===e.textures.length)&&(this._floorMaterial=n,setTimeout(()=>i(),0))});let i=[this._floorPromise];return new Promise((e,t)=>{Promise.all(i).then(()=>{this._updateFloor(),this._update(),e()},t)})}showGUI(){this._floorMaterial?this._addGUI():this._floorPromise&&this._floorPromise.then(()=>this._addGUI())}_addGUI(){let e=getGUI().addFolder("Floor");e.add(this._floorMaterial,"roughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"reflectivity").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoat").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoatRoughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"opacity").min(0).max(1).step(.01),e.add(this._floorMaterial,"metalness").min(0).max(1).step(.01),e.add(this._floorMaterial,"bumpScale").min(0).max(1).step(.01)}}__decorate([inject],FloorEnvironment.prototype,"_rapiAccess",void 0),__decorate([inject],FloorEnvironment.prototype,"_dataSyncer",void 0),__decorate([inject],FloorEnvironment.prototype,"_environmentLoader",void 0);const BACKGROUND_CLASS_NAME="rml-scene-background";class BackgroundEnvironment extends BakedShadowEnvironment{constructor(e,t,i,s,n){if(super(e,t),this._color=i,this._oldBackground=e.background,s&&n){this._canvas=s,this._style=document.createElement("style");let e='background-image: url("'+n+'"); background-size: cover;';this._style.innerText="."+BACKGROUND_CLASS_NAME+" {"+e+"}",this._canvas.appendChild(this._style)}}needsBounds(){return!0}needsCamera(){return!1}needsRotation(){return!1}addToScene(){super.addToScene(),this._color&&(this._scene.background=this._color),this._canvas&&this._canvas.classList&&(this._scene.background=null,this._canvas.classList.add(BACKGROUND_CLASS_NAME),this._pixotron&&(this._pixotron.enableAA=!1))}removeFromScene(){super.removeFromScene(),this._oldBackground&&(this._scene.background=this._oldBackground),this._canvas&&this._canvas.classList.remove(BACKGROUND_CLASS_NAME)}}class DynamicEnvironmentSettingLoader{parse(e,t,i,s){let n=JSON.parse(s);return n.environment?this.load(e,t,i,n):null}load(e,t,i,s){let n,o=s.environment;if(!o)return console.warn("No environment set in scene settings"),Promise.resolve(null);switch(o.type){case"color":n=new Promise(t=>t(new BackgroundEnvironment(e,i,new THREE.Color(o.details.color))));break;case"image":n=new Promise(s=>s(new BackgroundEnvironment(e,i,null,t,o.details.imageUrl)));break;case"gltf":n=new Promise(t=>{let s=new GltfEnvironment(e,i);s.loadBackground(getAssetPath()+"static/geometry/PhotoStudioRoom.glb"),t(s)});break;case"floor":n=new Promise(t=>{this._rapiAccess.getMaterial(o.details.material).then(s=>{let n=void 0===o.details.fog||o.details.fog,a=new FloorEnvironment(e,i,n);a.changeFloorMaterial(s).then(()=>{t(a)})})});break;case"baked_shadow":n=new Promise(s=>{o.details&&o.details.color?s(new BackgroundEnvironment(e,i,new THREE.Color(o.details.color))):o.details&&o.details.imageUrl?s(new BackgroundEnvironment(e,i,null,t,o.details.imageUrl)):s(new BakedShadowEnvironment(e,i))});break;default:console.warn("Could not load environment, return old environment"),n=new Promise(e=>e(i))}return n}}__decorate([inject],DynamicEnvironmentSettingLoader.prototype,"_rapiAccess",void 0);class HighPixelRatioQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(5),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!0,this._settings.useHDREnv=!0,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!0},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class HighestQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(4),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!0,this._settings.useHDREnv=!0,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!0},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class HighQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(3),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!0,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!0},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class MidQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(2),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!1,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!1},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class LowQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(1),this._settings.enableAA=!0,this._settings.useAreaLight=!0,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!1,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!1,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!1},this._settings.shadowQualitySettings={enabled:!0,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class LowestQualitySettings{constructor(){this._settings=new window.PIXOTRON.QualitySettings(0),this._settings.enableAA=!1,this._settings.useAreaLight=!1,this._settings.useDevicePixelRatio=!1,this._settings.useHDREnv=!1,this._settings.useGBuffer=!0,this._settings.saoQualitySettings={enabled:!1,downscale:1,enabledOnMove:!0,useNormalWeights:!0,useAccumulative:!1,enableBlur:!1},this._settings.shadowQualitySettings={enabled:!1,downscale:1,enabledOnMove:!0}}getSettings(){return this._settings}}class PixotronUtil{constructor(e){this._sceneBoundingSphere=new THREE.Sphere,this._pixotron=e,this._initializeQualitySettings(),this._initializeQualityAdapters()}getPixotronInstance(e){const t={saoparams:{intensity:.5,occlusionWorldRadius:.6,smoothTransition:!0,bias:.02,accumulative:!1},shadowparams:{shadowQuality:1,smoothTransition:!0,enableAccumulation:!0,shadowBiasMultiplier:.05,nearPlane:.01,farPlane:50,fov:40,numSamples:100,side:THREE.FrontSide}};return e=e||t,new window.PIXOTRON.Pixotron(e)}showGUI(){let e=getGUI().addFolder("Renderer");e.add(this._pixotron.getSAOPass(),"enabled"),this._pixotron.getSAOPass().smoothTransition&&e.add(this._pixotron.getSAOPass(),"smoothTransition"),e.add(this._pixotron.getSAOPass(),"occlusionWorldRadius").min(0).max(1).step(1e-4).onChange(e=>{this._adjustSaoRadius(e)}),e.add(this._pixotron.getSAOPass(),"intensity").min(.1).max(2).step(.05),e.add(this._pixotron.getSAOPass(),"bias").min(0).max(1).step(1e-4).onChange(e=>{this._adjustSaoBias(e)}),this._pixotron.getSAOPass().numSamples&&e.add(this._pixotron.getSAOPass(),"numSamples").min(10).max(3e3).step(10),void 0!==this._pixotron.getShadowPass().enabled&&e.add(this._pixotron.getShadowPass(),"enabled"),e.add(this._pixotron.getShadowPass(),"smoothTransition"),e.add(this._pixotron.getShadowPass(),"enableAccumulation"),e.add(this._pixotron.getShadowPass(),"shadowRadius").min(0).max(5).step(.1),e.add(this._pixotron.getShadowPass(),"shadowBiasMultiplier").min(0).max(3).step(.01),e.add(this._pixotron.getShadowPass(),"numSamples").min(10).max(3e3).step(10)}updateBounds(e){this._sceneBoundingSphere.copy(e);const t=.25*this._getMaxSaoRadius();this._adjustSaoRadius(t);const i=2*this._getMinSaoBias();this._adjustSaoBias(i)}_getSaoRadius(){return this._sceneBoundingSphere.radius}_adjustSaoRadius(e){const t=this._pixotron.getSAOPass(),i=this._getMinSaoRadius(),s=this._getMaxSaoRadius();t.occlusionWorldRadius=Math.min(Math.max(e,i),s)}_adjustSaoBias(e){const t=this._pixotron.getSAOPass(),i=this._getMinSaoBias(),s=this._getMaxSaoBias();t.bias=Math.min(Math.max(e,i),s)}_getMinSaoRadius(){return.001*this._getSaoRadius()}_getMaxSaoRadius(){return.6*this._getSaoRadius()}_getMinSaoBias(){return.001*this._getSaoRadius()}_getMaxSaoBias(){return.01*this._getSaoRadius()}updatePixelRatio(e){const t=new THREE.Vector2;e.getDrawingBufferSize(t),this._pixotron.setSize(Math.floor(t.width),Math.floor(t.height))}getHighPixelRatioQualitySetting(){return this._highPixelRatioQualitySetting.getSettings()}getLowestQualitySetting(){return this._lowQualitySetting.getSettings()}_initializeQualitySettings(){this._highestQualitySetting=new HighestQualitySettings,this._highPixelRatioQualitySetting=new HighPixelRatioQualitySettings,this._highQualitySetting=new HighQualitySettings,this._midQualitySetting=new MidQualitySettings,this._lowQualitySetting=new LowQualitySettings,this._lowestQualitySetting=new LowestQualitySettings}_initializeQualityAdapters(){this._autoQualityAdapter=new window.PIXOTRON.AutoQualityAdapter(this._pixotron),this._autoQualityAdapter.addQuality(this._highestQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._highQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._midQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._lowQualitySetting.getSettings()),this._autoQualityAdapter.addQuality(this._lowestQualitySetting.getSettings()),this._autoQualityAdapter.setDesiredFps(30),this._manualQualityAdapter=new window.PIXOTRON.ManualQualityAdapter(this._pixotron)}onAutoQualityChange(e){this._autoQualityAdapter.onQualityChange(e)}onManualQualityChange(e){this._manualQualityAdapter.onQualityChange(e)}getAutoAdapter(){return this._autoQualityAdapter}lockAdapter(){this._autoQualityAdapter.getCurrentQualitySetting().lock()}unLockAdapter(){this._autoQualityAdapter.getCurrentQualitySetting().unLock()}enablePixotronAutoQuality(){this._currentQualityAdapter||(this._currentQualityAdapter=this._autoQualityAdapter,this._pixotron.setQualityAdapter(this._autoQualityAdapter))}movingCameraStarts(){this._currentQualityAdapter&&(this._currentQualityAdapter=this._autoQualityAdapter,this._currentQualitySetting&&(this._manualQualityAdapter.setQualitySetting(this._currentQualitySetting),this._pixotron.setQualityAdapter(this._manualQualityAdapter)),this._pixotron.setQualityAdapter(this._autoQualityAdapter))}movingCameraStops(){this._currentQualityAdapter&&(this._currentQualitySetting=this._currentQualityAdapter.getCurrentQualitySetting(),this._currentQualityAdapter=this._manualQualityAdapter,this._pixotron.setQualityAdapter(this._manualQualityAdapter),this._manualQualityAdapter.setQualitySetting(this._highestQualitySetting.getSettings()))}}export{Benchmark as a,AppContext as b,AsyncHelper as c,DOCKING_CONVERSATION_ID as d,DEFAULT_CONVERSATION_ID as e,convertCObject as f,EventDispatcher as g,InputManager as h,LightSetting as i,CameraControl3D as j,DynamicLightSetting as k,CANVAS_ID as l,RoomleComponentFactoryInitializer as m,BackgroundEnvironment as n,FloorEnvironment as o,DynamicLightSettingLoader as p,PREDEFINED_LIGHTSETTING as q,GltfEnvironment as r,PixotronUtil as s,BakedShadowEnvironment as t,DynamicEnvironmentSettingLoader as u,DependencyInjectionAssignment as v,Logger as w,ScriptLoader as x,CameraControl as y,DomHelper as z,DataSyncer as A,Main as B,RoomleDependencyInjection as C,IMAGE_FORMATS as D,convertToKernel as E,convertToTHREE as F,convertToThreeDimensions as G,ConfiguratorViewModel as H,MIN_MOVE_DISTANCE as I,DynamicQualitySettingLoader as J,EnvironmentLoader as K};
//# sourceMappingURL=chunk-57b2c2a6.js.map
