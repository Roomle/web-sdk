import{d as getColors}from"./chunk-ed11cf69.js";import{D as CameraControl,k as toRadiant,a3 as position3VectorsAreEqual,a4 as rotationQuaternionsAreEqual,a5 as getDelta,a6 as MIN_MOVE_DISTANCE,a7 as position2VectorsAreEqual,l as CameraControl3D,q as dispose,v as PixotronUtil,w as BakedShadowEnvironment,x as getGUI,m as DynamicLightSetting,y as DynamicEnvironmentSettingLoader,a8 as DynamicQualitySettingLoader}from"./chunk-bf94f510.js";import{a as __decorate,b as inject}from"./chunk-c1472d96.js";const ZOOM_SPEED=2,MAX_ZOOM=5,MIN_ZOOM=.8,TOUCH_PANNING_SPEED=1.1;class CameraControl2D extends CameraControl{constructor(e,t,i){super(e,t,i),this._scale=1,this._state=0,this._size=20,this._center=new THREE.Vector3,this._raycaster=new THREE.Raycaster,this._lastPosition=new THREE.Vector2,this._zoomPosition=new THREE.Vector3,this._lastZoom=0,this._zoomSpeed=Math.pow(.95,ZOOM_SPEED),this._cameraZoom=1,this._initCamera(i||new THREE.Vector3(0,10,0));let s=new THREE.PlaneGeometry(1e3,1e3);s.rotateX(-Math.PI/2),this._plane=new THREE.Mesh(s,new THREE.MeshStandardMaterial)}_getCamera(){return this._camera?this._camera:(this._initCamera(new THREE.Vector3(0,10,0)),this._camera)}_initCamera(e){let{x:t,y:i}=this._domHelper.getClientDimensions(),s=t/i*this._size,n=this._size;this._camera=new THREE.OrthographicCamera(s/-2,s/2,n/2,n/-2,1,1e3),this._camera.position.copy(e),this._cameraPosition=e,this._camera.lookAt(new THREE.Vector3(0,0,0))}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions(),i=e/t*this._size,s=this._size;this._camera.left=i/-2,this._camera.right=i/2,this._camera.top=s/2,this._camera.bottom=s/-2,this._camera.updateProjectionMatrix()}_initInputListener(){this._inputListeners.push({key:3,fun:e=>{this._locked||(this._state=1,this._lastPosition.set(e.position.x,e.position.y),this.dispatchEvent(0))}}),this._inputListeners.push({key:6,fun:e=>{1!==this._state||this._locked||(this._move(new THREE.Vector2(e.position.x,e.position.y),e.type),this.dispatchEvent(1))}}),this._inputListeners.push({key:4,fun:e=>{1===this._state&&this.dispatchEvent(2),this._state=0}}),this._inputListeners.push({key:7,fun:e=>{this._scale/=this._zoomSpeed,this._zoomTo(e.position,1),this._update()}}),this._inputListeners.push({key:8,fun:e=>{this._scale*=this._zoomSpeed,this._zoomTo(e.position,-1),this._update()}})}_zoomTo(e,t){if(Date.now()-this._lastZoom>200){if(t>0||this._cameraZoom>=1){const t=this.getInputPosition(e);this._raycaster.setFromCamera(t,this._camera);const i=this._raycaster.intersectObject(this._plane);if(i.length<=0)return;const s=i.pop().point;this._zoomPosition.copy(s)}else this._zoomPosition.copy(this._center);this._cameraPosition.x=this._zoomPosition.x,this._cameraPosition.z=this._zoomPosition.z}this._lastZoom=Date.now()}_move(e,t){let i=new THREE.Vector2;i.subVectors(this._lastPosition,e),i.divideScalar(100),this._cameraPosition.x+=i.x*(2===t?TOUCH_PANNING_SPEED:1),this._cameraPosition.z+=i.y*(2===t?TOUCH_PANNING_SPEED:1),this._lastPosition.copy(e)}updateToBounds(e,t){let{x:i,y:s}=this._domHelper.getClientDimensions(),n=i/s;this._size=Math.max(e.x,e.z);let a=this._size,o=this._size;n>1?a=this._size*n:o=this._size*(s/i),this._center.copy(t),this._camera.left=a/-2,this._camera.right=a/2,this._camera.top=o/2,this._camera.bottom=o/-2,this._camera.zoom=1,this._camera.position.set(this._center.x,10,this._center.z),this._cameraPosition.copy(this._camera.position)}_update(e){this._scale=Math.min(this._scale,MAX_ZOOM),this._scale=Math.max(this._scale,MIN_ZOOM),this._cameraZoom=this._scale,this._camera.updateProjectionMatrix()}animateCamera(e){return!(!super.animateCamera(e)&&Math.abs(this._cameraZoom-this._camera.zoom)<=.01||(this._camera.zoom=THREE.Math.lerp(this._camera.zoom,this._cameraZoom,10*e),0))}}const KEYBOARD_ROTATION_ANGLE=Math.PI/4,KEYBOARD_MOVING_DISTANCE=1,ROTATION_SPEED=1,ROTATION_SPEED_TOUCH=.6,RUN_SPEED=1,CONTROLLER_AXIS_THRESHHOLD=.2,MIN_POLAR_ANGLE=-60,MAX_POLAR_ANGLE=60;class CameraControlFirstPerson extends CameraControl{constructor(e,t,i){super(e,t,i),this._state=0,this._rotationSpeed=ROTATION_SPEED,this._keyMap=new Map,this.minPolarAngle=toRadiant(MIN_POLAR_ANGLE),this.maxPolarAngle=toRadiant(MAX_POLAR_ANGLE),this._camera=new THREE.PerspectiveCamera,this._camera.fov=70,this._camera.aspect=this._width/this._height,this._camera.near=.1,this._camera.far=100,this._camera.updateProjectionMatrix(),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4),i?this._camera.position.set(i.x,1.5,i.z):this._camera.position.set(0,1.5,0),this._cameraPosition=new THREE.Vector3,this._cameraPosition.copy(this._camera.position),this._cameraRotation=new THREE.Quaternion,this._pitch=0,this._yaw=0;let s=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX");this._cameraRotation.setFromEuler(s),window.addEventListener("gamepadconnected",this._gamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this._gamepadDisconnected.bind(this))}_gamepadConnected(e){this.startButtonPressListener()}_gamepadDisconnected(e){window.cancelAnimationFrame(this._listenerLoopAnimationFrame)}startButtonPressListener(){this._listenerLoopAnimationFrame=window.requestAnimationFrame(()=>{this.buttonPressListener()})}buttonPressListener(){let e=navigator.getGamepads()[0];this._checkRightStick(e),this._checkLeftStick(e),this._checkButtons(e),this._processKeyMap(this._keyMap,.001),this.startButtonPressListener()}_checkRightStick(e){let t=e.axes[2],i=e.axes[3];Math.abs(t)>CONTROLLER_AXIS_THRESHHOLD&&(this._rotateHorizontal(.01*KEYBOARD_ROTATION_ANGLE*t),this._update(),this.dispatchEvent(1)),Math.abs(i)>CONTROLLER_AXIS_THRESHHOLD&&(this._rotateVertical(.01*KEYBOARD_ROTATION_ANGLE*i),this._update(),this.dispatchEvent(1))}_checkLeftStick(e){let t=e.axes[0],i=e.axes[1];Math.abs(i)>CONTROLLER_AXIS_THRESHHOLD?i<0?this._keyMap.set(87,!0):this._keyMap.set(83,!0):e.buttons&&e.buttons[12]&&e.buttons[12].pressed?this._keyMap.set(87,!0):e.buttons&&e.buttons[13]&&e.buttons[13].pressed?this._keyMap.set(83,!0):(this._keyMap.set(87,!1),this._keyMap.set(83,!1)),Math.abs(t)>CONTROLLER_AXIS_THRESHHOLD?t<0?this._keyMap.set(65,!0):this._keyMap.set(68,!0):(this._keyMap.set(65,!1),this._keyMap.set(68,!1))}_checkButtons(e){e.buttons&&e.buttons[6]&&e.buttons[6].pressed?this._keyMap.set(16,!0):this._keyMap.set(16,!1),e.buttons&&e.buttons[14]&&e.buttons[14].pressed?(this._keyMap.set(37,!0),this.dispatchEvent(1)):this._keyMap.set(37,!1),e.buttons&&e.buttons[15]&&e.buttons[15].pressed?(this._keyMap.set(39,!0),this.dispatchEvent(1)):this._keyMap.set(39,!1)}animateCamera(e){let t=this._cameraPosition,i=this._cameraRotation,s=this.getCamera(),n=position3VectorsAreEqual(t,s.position),a=rotationQuaternionsAreEqual(i,s.quaternion);if(!t||n&&a)return!1;let o=this.getCamera().position.clone(),r=Math.min(10*e,1);o.lerp(t,r),this.getCamera().position.copy(o);let h=this.getCamera().quaternion.clone(),_=Math.min(5*e,1);h.slerp(i,_),this.getCamera().setRotationFromQuaternion(h);let d=!1;return this._keyMap.forEach(e=>{e&&(d=!0)}),d&&this._processKeyMap(this._keyMap,e),!0}_getCamera(){return this._camera}_initInputListener(){window.addEventListener("keyup",this._onKeyChanged.bind(this),!1),window.addEventListener("keydown",this._onKeyChanged.bind(this),!1),this._inputListeners.push({key:3,fun:e=>{this._down(e)}}),this._inputListeners.push({key:6,fun:e=>{this._move(e)}}),this._inputListeners.push({key:4,fun:e=>{this._up(e)}})}_down(e){this._downPosition=e.position,this._position=e.position,this._state=1,2===e.type&&window.setTimeout(this._onLongDown.bind(this),350),2===e.type?this._rotationSpeed=ROTATION_SPEED_TOUCH:this._rotationSpeed=ROTATION_SPEED}_move(e){this._position=e.position,1!==this._state||this._locked||this._orbit(new THREE.Vector2(e.position.x,e.position.y)),2!==this._state||this._locked||(this._orbit(new THREE.Vector2(e.position.x,e.position.y)),this._moveForward())}_up(e){1===this._state&&this.dispatchEvent(2),2===this._state&&this._keyMap.set(87,!1),this._state=0,this._orbitPosition=null}_onLongDown(){getDelta(this._downPosition,this._position)<MIN_MOVE_DISTANCE&&1===this._state&&(this._state=2,this._orbit(new THREE.Vector2(this._position.x,this._position.y)),this._moveForward())}_update(e){let t=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX");this._cameraRotation.setFromEuler(t)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();this._camera.aspect=e/t,this._camera.updateProjectionMatrix()}_onKeyChanged(e){this._keyMap.set(e.keyCode,"keydown"===e.type),this.dispatchEvent(6),this._processKeyMap(this._keyMap,.001)&&e.preventDefault()}_processKeyMap(e,t){t=Math.min(t,.1);let i=new THREE.Vector3(0,0,0),s=!1;return this._processUpDown(e,i,t),e.get(65)&&(i.x=-KEYBOARD_MOVING_DISTANCE*RUN_SPEED*t),e.get(68)&&(i.x=KEYBOARD_MOVING_DISTANCE*RUN_SPEED*t),e.get(37)&&(this._rotateHorizontal(-KEYBOARD_ROTATION_ANGLE*this._rotationSpeed*t),s=!0),e.get(39)&&(this._rotateHorizontal(KEYBOARD_ROTATION_ANGLE*this._rotationSpeed*t),s=!0),e.get(16)&&(i.x*=3,i.z*=3),!(0===i.x&&0===i.y&&0===i.z&&!s||(i.applyQuaternion(this.getCamera().quaternion),this._cameraPosition.add(new THREE.Vector3(i.x,0,i.z)),this._update(),0))}_processUpDown(e,t,i){(e.get(87)||e.get(38))&&(t.z=-KEYBOARD_MOVING_DISTANCE*RUN_SPEED*i),(e.get(83)||e.get(40))&&(t.z=KEYBOARD_MOVING_DISTANCE*RUN_SPEED*i)}_orbit(e){this._orbitPosition||(this._orbitPosition=new THREE.Vector2(e.x,e.y),this.dispatchEvent(0));let t=e.clone().sub(this._orbitPosition),i=this._domHelper.element instanceof Document?this._domHelper.element.body:this._domHelper.element;t.multiplyScalar(-1),this._rotateHorizontal(2*Math.PI*t.x/i.clientWidth*ROTATION_SPEED),this._rotateVertical(2*Math.PI*t.y/i.clientHeight*ROTATION_SPEED),position2VectorsAreEqual(this._orbitPosition,e)||this.dispatchEvent(1),this._orbitPosition.copy(e),this._update()}_moveForward(){this._keyMap.set(87,!0),this._processKeyMap(this._keyMap,.001)}_rotateVertical(e){let t=this._pitch+e;t>this.maxPolarAngle||t<this.minPolarAngle||(this._pitch=t,this._pitch<-Math.PI?this._pitch+=2*Math.PI:this._pitch>Math.PI&&(this._pitch-=2*Math.PI),this._saveYawAndPitch())}}const STANDBY_AFTER=3e3;class SceneManager{constructor(e,t,i,s,n){this._clock=new THREE.Clock,this._delta=0,this._devicePixelRatio=1,this._renderListener=null,this._stopRendering=!1,this._forceRender=!1,this._lastChange=Date.now(),this._running=!1,this._onAfterRender=(()=>{}),this._creator_=e,this._canvasID=i,this._devicePixelRatio=window.devicePixelRatio&&window.__RML__ENV__.initData.retina?window.devicePixelRatio:1,this.createCameraControl(s),this._addCameraControlListener(),this._setupScene(t,n),document.addEventListener("visibilitychange",this._tabVisible.bind(this)),this._renderListener=(()=>{this._requestRender(!0)}),this._getInputManager().addEventListener(7,this._renderListener,this),this._getInputManager().addEventListener(8,this._renderListener,this),this._lifeCycleManager.addEventListener(this)}onBeforeRender(){}_changeCameraControl(e){this._cameraControl&&this._cameraControl.cleanUp(),e instanceof CameraControlFirstPerson&&(this._getInputManager().removeEventListener(7,this._renderListener),this._getInputManager().removeEventListener(8,this._renderListener)),this._cameraControl instanceof CameraControlFirstPerson&&(this._getInputManager().addEventListener(7,this._renderListener,this),this._getInputManager().addEventListener(8,this._renderListener,this)),this._cameraControl=e,this.cameraControlChanged()}cameraControlChanged(){}_addCameraControlListener(){this._cameraControl.addEventListener(0,this._requestRender,this),this._cameraControl.addEventListener(1,this._requestRender,this),this._cameraControl.addEventListener(2,this._requestRender,this),this._cameraControl.addEventListener(6,this._requestRender,this)}_requestRender(e){if(!this._renderer)return;this._pixotron&&(this._pixotron.needsUpdate=!0,e&&(this._forceRender=!0));const t=()=>{this._delta=this._clock.getDelta(),this._animateCamera(),this._cameraControl.getCamera().layers.mask=65535,this._renderLoopFunction&&(this._renderLoopFunction(),this._renderLoopFunction=null),this.onBeforeRender(),this._statsHelper&&this._statsHelper.updateRenderInfo(this._renderer.info),this._pixotron?(this._forceRender&&(this._pixotron.autoShadowsClear=!0,this._pixotron.autoSAOClear=!0),this._pixotron.render(this._renderer,this._scene,this._cameraControl.getCamera()),this._forceRender=!1):(this._renderer.clear(),this._renderer.render(this._scene,this._cameraControl.getCamera()),this._renderer.clearDepth()),this._onAfterRender(),window.TWEEN&&TWEEN.update(),this._lastChange+STANDBY_AFTER<Date.now()||this._stopRendering?this._running=!1:(this._running=!0,requestAnimationFrame(t))};this._lastChange=Date.now(),this._running||this._stopRendering||(this._running=!0,requestAnimationFrame(t))}_animateCamera(){this._cameraControl&&(this._cameraControl.animateCamera(this._delta)||!this._pixotron||this._forceRender?this._pixotron&&(this._pixotron.needsUpdate=!0):(this._pixotron.autoShadowsClear=!1,this._pixotron.autoSAOClear=!1)),this._environment&&this._environment.needsCamera()&&this._cameraControl instanceof CameraControl3D&&this._environment.updateCamera(this._cameraControl.getCamera())}_setupScene(e,t){let i=this._domHelper.getClientDimensions();this._width=i.x,this._height=i.y,this._scene=new THREE.Scene,(t=t||!1)||(this._scene.background=new THREE.Color(getColors().DEFAULT_BACKGROUND)),this._renderer=new THREE.WebGLRenderer({antialias:!0,alpha:t}),this._renderer.setPixelRatio(this._devicePixelRatio),this._renderer.setSize(this._width,this._height),this._renderer.gammaOutput=window.__RML__ENV__.initData.gammaOutput,this._renderer.gammaInput=!0,this._renderer.gammaFactor=2.2,this._renderer.autoClear=!1,this._renderer.shadowMap.enabled=!0,this._renderer.shadowMap.type=THREE.PCFSoftShadowMap,this._renderer.domElement.classList.add(this._canvasID),this._domHelper.element.appendChild(this._renderer.domElement),this._getInputManager().addEvents(this._renderer.domElement),this._environmentLoader.setRendererAndScene(this._renderer,this._scene),this._environmentLoader.registerEnvironmentChangedCallback(()=>this._requestRender(!0)),this._requestRender(),window.addEventListener("resize",this,!1),window.addEventListener("keydown",this,!1),window.addEventListener("keyup",this,!1),this.sceneChanged()}_tabVisible(e){this._requestRender(!0)}setupScene(e,t){this._setupScene(e,t)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();if(this._renderer.setSize(e,t),this._pixotron){this._pixotron.autoShadowsClear=!0,this._pixotron.autoSAOClear=!0,this._forceRender=!0;try{this._pixotron.setSize(e,t)}catch(e){console.warn(e)}}this._cameraControl.updateCamera(),this._requestRender(!0)}_onWindowResize(){this.updateCamera(),this._requestRender(!0)}_isPartOfScene(e){return"Object3D"===e.type||"Mesh"===e.type||"GLB"===e.type||"GLTF"===e.type||"Group"===e.type}cleanUp(){this._getInputManager().removeEventListener(7,this._renderListener),this._getInputManager().removeEventListener(8,this._renderListener),this._cameraControl&&this._cameraControl.cleanUp()}clearScene(){let e=[];this._scene.children.forEach(t=>{this._isPartOfScene(t)&&e.push(t)}),e.forEach(e=>{dispose(e),this._scene.remove(e)}),this._renderer.renderLists.dispose()}enableHD(){this._pixotron=new window.PIXOTRON.Pixotron(this.getPixotronParams()),this._pixotronUtil=new PixotronUtil(this._pixotron),this._environment instanceof BakedShadowEnvironment&&(this._environment.setPixotron(this._pixotron,this._renderer,this._cameraControl.getCamera(),this.getBakedShadowParams()),this._environment.setLoadedCallback(()=>setTimeout(()=>this._requestRender(!0),500))),this._requestRender()}_loadGLTF(e,t,i,s,n,a){return new Promise((o,r)=>{this._staticItemLoader.loadGLTF(e,t,i,s,n,a).then(e=>{this._setCamera("GLTF",e),o(e)},r)})}_loadGLB(e,t,i,s,n,a,o){return new Promise((r,h)=>{this._staticItemLoader.loadGLB(e,t,i,s,n,a,o).then(e=>{this._setCamera("GLB",e),r(e)},h)})}_setCamera(e,t){if(!t)return void console.warn("could not set camera for gltf",t);const i=new THREE.Box3;if(i.setFromObject(t),"GLB"===e)this._cameraControl instanceof CameraControl3D&&this._cameraControl.updateToBounds(i,window.innerWidth,window.innerHeight,!1);else if("GLTF"===e){if(this._cameraControl instanceof CameraControl3D){let{x:e,y:t}=this._domHelper.getClientDimensions();this._cameraControl.updateAndReset(i.getSize(new THREE.Vector3),e,t,i.getCenter(new THREE.Vector3),-15,70,5,!1)}this._cameraControl instanceof CameraControl2D&&this._cameraControl.updateToBounds(i.getSize(new THREE.Vector3),i.getCenter(new THREE.Vector3))}this.updateCamera()}showGUI(){const e=document.createElement("style");e.innerText=".dg.main{position:absolute;z-index:100;top:0;left:0;}",document.head.appendChild(e),this._scriptLoader.fetch("static/three/dat.gui.min.js",{id:"dat-gui-js"}).then(()=>{let e=getGUI(!1);this._domHelper.element.appendChild(e.domElement),this._guiLoaded()},e=>console.error(e))}_guiLoaded(){this._lightSetting&&this._lightSetting.showGUI();let e=getGUI();this._pixotron&&this._pixotronUtil.showGUI(),this._environment&&this._environment.showGUI(),this._addGUIListener(e)}_addGUIListener(e){let t=e.__folders;Object.keys(t).forEach((e,i)=>{let s=t[e];s.__folders&&Object.keys(s.__folders).forEach((e,i)=>{let s=t[e];this._addGUIListener(s)}),s.__controllers&&s.__controllers.forEach(e=>{e.onFinishChange(()=>{this._guiParamChanged()})})})}_guiParamChanged(){this._requestRender()}showStats(){import("./chunk-dbfa6fc4.js").then(e=>this._statsHelper=new e.default)}_onKeyDown(e){}_onKeyUp(e){}pause(){this._getInputManager().removeEvents(this._renderer.domElement),window.removeEventListener("resize",this,!1),window.removeEventListener("keydown",this,!1),window.removeEventListener("keyup",this,!1)}resume(){this._renderer.domElement.classList.add(this._canvasID),this._domHelper.element.appendChild(this._renderer.domElement),this._getInputManager().addEvents(this._renderer.domElement),window.addEventListener("resize",this,!1),window.addEventListener("keydown",this,!1),window.addEventListener("keyup",this,!1),this._requestRender(!0)}destroy(){this.pause(),this.cleanUp()}handleEvent(e){switch(e.type){case"resize":this._onWindowResize();break;case"keydown":this._onKeyDown(e);break;case"keyup":this._onKeyUp(e)}}loadSceneSettings(e){let t,i;return t=e.environment?new Promise(t=>{(new DynamicEnvironmentSettingLoader).load(this._scene,this._renderer.domElement,this._environment,e).then(e=>{this._setEnvironment(e),t()})}):Promise.resolve(),e.lights?(this._lightSetting=new DynamicLightSetting(this._scene,this._lightSetting),i=this._lightSetting.loadFromObject(e)):i=Promise.resolve(),new Promise((e,s)=>{Promise.all([t,i]).then(()=>{this._requestRender(!0),e()},s)})}_setEnvironment(e){this._environment=e,this._pixotron&&this._environment instanceof BakedShadowEnvironment&&(this._environment.setPixotron(this._pixotron,this._renderer,this._cameraControl.getCamera(),this.getBakedShadowParams()),this._environment.setLoadedCallback(()=>setTimeout(()=>this._requestRender(!0),500)))}loadQualitySetting(e){this._pixotron&&(new DynamicQualitySettingLoader).set(this._pixotron,e)}loadDynamicLightSetting(e){return this._lightSetting=new DynamicLightSetting(this._scene,this._lightSetting),e.url?this._lightSetting.loadFromURL(e.url):e.json?this._lightSetting.loadFromJSON(e.json):e.object?this._lightSetting.loadFromObject(e.object):new Promise((e,t)=>{t("No dynamic light setting source set")})}}__decorate([inject],SceneManager.prototype,"_domHelper",void 0),__decorate([inject],SceneManager.prototype,"_scriptLoader",void 0),__decorate([inject],SceneManager.prototype,"_lifeCycleManager",void 0),__decorate([inject],SceneManager.prototype,"_staticItemLoader",void 0),__decorate([inject],SceneManager.prototype,"_environmentLoader",void 0);export{SceneManager as a,CameraControl2D as b,CameraControlFirstPerson as c};
//# sourceMappingURL=chunk-f5a7314c.js.map
