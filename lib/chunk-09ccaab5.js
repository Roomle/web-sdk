import{a as getAssetPath}from"./chunk-9cf49ec4.js";import{a as Benchmark,f as convertCObject,p as toRadiant,g as EventDispatcher,M as vectorIsZero,N as disposeMesh}from"./chunk-70ef6cff.js";import{a as __decorate,b as inject}from"./chunk-0434d6fb.js";import{b as Env}from"./chunk-21f95e1a.js";const loadWebAssemblyFromFile=(e,t,n)=>{const r="function"==typeof WebAssembly.instantiateStreaming;Benchmark.addMeta("kernel_is_ready",{cachedInIndexedDB:!1});let o=null;r?(Benchmark.start("kernel_stream_compile"),o=WebAssembly.instantiateStreaming(fetch(getAssetPath()+e),t),Benchmark.end("kernel_stream_compile")):(Benchmark.start("kernel_legacy_compile"),o=fetch(getAssetPath()+e).then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,t))),Benchmark.addMeta("kernel_is_ready",{instantiateStreaming:r}),o.then(e=>{Benchmark.end(r?"kernel_stream_compile":"kernel_legacy_compile"),n(e.instance)},e=>console.error(e))};let MEM_URL,WASM_URL,WASM_LOADER,ASM_LOADER,CACHE_COMPILATION;const USE_WASM=!(null!=navigator.userAgent.match(/iPad|iPhone|iPod/i)||!window.WebAssembly);class CommonKernelAccess{constructor(e,t){this._configuratorKernelCallbackListener=new Set,this._subComponentsWaiters=new Map,this._shouldWait=!0,this._creator_=e,this._setupKernelPaths(t),this._setupEmsModule(t),this._useWASM=USE_WASM,this._kernelPath=USE_WASM?WASM_LOADER:ASM_LOADER,window.KernelCallback={isReady:this.isReady.bind(this)},this._lifeCycleManager.addEventListener(this)}_utilityToLongArray(e){const t=new this._kernelContainer.LongArray;return e.forEach(e=>t.push_back(e)),t}get kernelContainer(){return this._kernelContainer}get kernelInstance(){return this._kernelInstance}_setupKernelPaths(e){const t=0===e?"PLANNER":"CONFIGURATOR";MEM_URL=Env.APP.ASM[t].MEM_URL,WASM_URL=Env.APP.WASM[t].URL,WASM_LOADER=Env.APP.WASM[t].LOADER,ASM_LOADER=Env.APP.ASM[t].LOADER,CACHE_COMPILATION=Env.APP.WASM[t].CACHE_COMPILATION}_setupEmsModule(e){this._kernelContainer={locateFile(t){const n=0===e?/RoomleCoreJs[\-a-z0-9]*\.js\.mem/:/ConfiguratorKernelJs[\-a-z0-9]*\.js\.mem/;return t.match(n)?getAssetPath()+MEM_URL:t},wasmBinaryFile:getAssetPath()+WASM_URL,preRun:[],postRun:[],setStatus:null,print(e){},printErr(e){console.error(e)},quit(e){console.error(e)}},CACHE_COMPILATION&&USE_WASM&&(this._kernelContainer.instantiateWasm=function(e,t){return loadWebAssemblyFromFile(WASM_URL,e,t),{}})}_passSubComponentsToKernel(e,t){const n=e.id,r=t.get(n);if(r)for(let t=0,o=r.length;t<o;t++){const{parentId:o,partId:s}=r[t];this._kernelInstance.loadedSubComponent(o,s,n,e.configuration)}}_fetchSubComponents(e){let t=[...e.keys()];t.length&&this._rapiAccess.getComponents(t).then(t=>{for(let n=0,r=t.length;n<r;n++)this._passSubComponentsToKernel(t[n],e);this._flushSubComponentsWaiters()})}_flushSubComponentsWaiters(){this._fetchSubComponents(this._subComponentsWaiters),this._subComponentsWaiters=new Map,this._shouldWait=!1}isReady(){this._kernelContainer.setExternalHelpers(this._kernelIo,{convertCObject}),Env.isProduction||Env.isUnitTesting||this.addDebugInfo(),window.KernelCallback&&(window.KernelCallback=null,delete window.KernelCallback)}addDebugInfo(){const e=function(t,n=[]){const r=Object.getPrototypeOf(t),o=r?Object.getOwnPropertyNames(r):[],s=t?Object.getOwnPropertyNames(t):[];return r?e(r,[...n,...s,...o]):[...s,...o,...n]},t=e(this),n=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toString","valueOf"];[...new Set(t)].forEach(e=>{if("_"!==e[0]&&"function"==typeof this[e]&&-1===n.indexOf(e))try{const t=this[e].bind(this);this[e]=function(...n){return this._kernelIo.log("[ KernelCommunication ]: "+e),t(...n)}}catch(e){}})}loadComponent(e,t,n){this._rapiAccess.getComponent(t.componentId).then(r=>{this._kernelInstance.loadComponent(e,r.configuration,t,n),this._flushSubComponentsWaiters()},r=>{this._kernelInstance.loadComponent(e,"error",t,n),this.onLoadComponentError(r),this._flushSubComponentsWaiters()})}loadSubComponent(e,t,n){if(this._shouldWait){let r=this._subComponentsWaiters.get(n);r||this._subComponentsWaiters.set(n,[]),(r=this._subComponentsWaiters.get(n)).push({parentId:e,partId:t}),this._subComponentsWaiters.set(n,r)}else this._rapiAccess.getComponent(n).then(r=>{this._kernelInstance.loadedSubComponent(e,t,n,r.configuration)})}requestDeleteComponent(e){e&&this._kernelInstance.deleteComponent(e)}dockComponentWithPosition(e,t,n,r,o){this._kernelInstance.dockComponentWithPosition(n,r,e,t,o),this._configuratorUiCallbacks.onUserInitiatedDockDone()}Editor3dAddBakedMesh(e,t,n,r,o,s){this._configuratorKernelCallbackListener.forEach(i=>i.Editor3dAddBakedMesh(e,t,n,r,o,s))}Editor3dAddNamedMesh(e,t,n,r,o,s,i,a){this._configuratorKernelCallbackListener.forEach(c=>c.Editor3dAddNamedMesh(e,t,n,r,o,s,i,a))}Editor3dBeginConstruction(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dBeginConstruction(e))}Editor3dEndConstruction(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dEndConstruction(e))}Editor3dComponentCreated(e,t,n,r){this._configuratorKernelCallbackListener.forEach(o=>o.Editor3dComponentCreated(e,t,n,r,!1))}Editor3dComponentDocked(e,t,n,r){this._configuratorKernelCallbackListener.forEach(o=>o.Editor3dComponentDocked(e,t,n,r))}Editor3dGeometryReady(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dGeometryReady(e))}Editor3dGeometryNotReady(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dGeometryNotReady(e))}componentDeleted(e){this._configuratorKernelCallbackListener.forEach(t=>t.componentDeleted(e))}componentMetaUpdated(e){let t=this._kernelInstance.getComponent(e);this._configuratorKernelCallbackListener.forEach(e=>e.componentMetaUpdated(t))}sceneCleared(){this._configuratorKernelCallbackListener.forEach(e=>e.sceneCleared())}addConfiguratorListener(e){this._configuratorKernelCallbackListener.add(e)}removeConfiguratorListener(e){this._configuratorKernelCallbackListener.delete(e)}cleanUpCallbacks(){this._kernelContainer.unregisterConfiguratorCallback(this)}registerCallbacks(){this._kernelContainer.registerConfiguratorCallback(this)}pause(){this.cleanUpCallbacks()}resume(){this.cleanUpCallbacks(),this.registerCallbacks()}destroy(){}}__decorate([inject],CommonKernelAccess.prototype,"_rapiAccess",void 0),__decorate([inject],CommonKernelAccess.prototype,"_scriptLoader",void 0),__decorate([inject],CommonKernelAccess.prototype,"_kernelIo",void 0),__decorate([inject],CommonKernelAccess.prototype,"_dataSyncer",void 0),__decorate([inject],CommonKernelAccess.prototype,"_lifeCycleManager",void 0),__decorate([inject],CommonKernelAccess.prototype,"_configuratorUiCallbacks",void 0);const ROTATION_TO_DETECT_SIDE=toRadiant(30);class RaycastHelper extends EventDispatcher{constructor(e,t,n,r){super(),this._offset=new THREE.Vector3(0,0,0),this._mode=void 0===r?1:r,this._scene=e,this._camera=t,this._raycaster=new THREE.Raycaster,this._addInputListeners(n),this._planeBottom=new THREE.Plane(new THREE.Vector3(0,1,0)),this._planeFront=new THREE.Plane(new THREE.Vector3(0,0,1)),this._planeSide=new THREE.Plane(new THREE.Vector3(1,0,0))}_addInputListeners(e){e.addEventListener(5,e=>{this._findSelection(e.positionRelative)},this),e.addEventListener(6,e=>{this._findHover(e.positionRelative,e.type)},this),e.addEventListener(0,e=>{this._onDragStart(e.positionRelative)},this),e.addEventListener(1,e=>{this._onDrag(e.positionRelative)},this),e.addEventListener(2,e=>{this._onDragEnd(e.positionRelative)},this)}_findSelection(e){let t=this._intersection(e);t?t&&t.object.dispatchEvent({type:"select"}):this.dispatchEvent(3)}_findHover(e,t){let n=this._intersection(e);!n&&this._currentHover?(this._currentHover.dispatchEvent({type:"hover_off",attachment:{type:t}}),this._currentHover=null):n&&(this._currentHover&&this._currentHover.id!==n.object.id&&(this._currentHover.dispatchEvent({type:"hover_off",attachment:{type:t}}),this._currentHover=null),this._currentHover?this._currentHover.dispatchEvent({type:"hover_move",attachment:{intersection:n,type:t}}):(this._currentHover=n.object,this._currentHover.dispatchEvent({type:"hover_on",attachment:{intersection:n,type:t}})))}_intersection(e){let t=this._intersect(e);if(t.length<=0)return null;let n=t[0];return t.length>1&&this._currentHover&&this._currentDrag&&this._currentDrag.id!==this._currentHover.id&&t.forEach(e=>{e.object.id===this._currentHover.id&&e.object.userData.priority===this._currentHover.userData.priority&&n.object.userData.priority<=e.object.userData.priority&&(n=e)}),n}_intersect(e){this._raycaster.setFromCamera(e,this._camera);let t=[];return this._raycaster.intersectObjects(this._scene.children,!0).forEach(e=>{e.object.userData.hasListener&&t.push(e)}),t.length>=0?t.sort((e,t)=>e.object.userData.priority!==t.object.userData.priority?t.object.userData.priority-e.object.userData.priority:e.distance-t.distance):[]}_onDragStart(e){let t=this._intersection(e);if(!t&&!this._currentDrag)return;if(t&&t.object.userData.roomleId===this._rootComponentId)return;!this._currentDrag&&t&&(this._currentDrag=t.object,this._currentDrag.dispatchEvent({type:"drag_start"}));let n=this._currentDrag.parent;n&&n.computeBoundingBox&&(n.computeBoundingBox(),this._calculateOffset(n)),this._positionPlanes(n)}_onDrag(e){if(!this._currentDrag)return;this._raycaster.setFromCamera(e,this._camera);let t,n=new THREE.Vector3(0,0,-5);this._raycaster.ray.intersectPlane(this._planeBottom,n);let r=this._getDistanceToCamera(n),o=this._camera.userData.yaw;if(0===this._mode)this._currentDragOffset||(this._currentDragOffset=n.clone().sub(this._currentDrag.parent.position.clone())),(t=n.clone().sub(this._currentDragOffset)).y=this._currentDrag.parent.position.y;else{let e=new THREE.Vector3(0,0,0),s=new THREE.Vector3(0,0,0);this._raycaster.ray.intersectPlane(this._planeFront,e),this._raycaster.ray.intersectPlane(this._planeSide,s);let i=this._getDistanceToCamera(s),a=this._getDistanceToCamera(e);o>=-ROTATION_TO_DETECT_SIDE&&o<=ROTATION_TO_DETECT_SIDE?t=r<a?n.clone():e.clone():r<a&&r<i?t=n.clone():a<r&&a<i?t=e.clone():i<r&&i<a&&(t=s.clone()),t.sub(this._offset)}this._currentDrag.dispatchEvent({type:"drag",attachment:{position:t}})}_getDistanceToCamera(e){let t=e.clone().sub(this._camera.position).length();return vectorIsZero(e)&&(t=Number.POSITIVE_INFINITY),t}_onDragEnd(e){this._currentDrag&&(this._currentDrag.dispatchEvent({type:"drag_end",attachment:{position:e}}),this._currentDrag=null,this._currentDragOffset=null)}_positionPlanes(e){0===this._mode?(this._planeBottom.constant=0,this._camera.userData&&this._camera.userData.pitch&&this._camera.userData.pitch<0&&(this._planeBottom.constant=-3)):e&&e.boundingBox&&this._rootComponentPosition&&(this._planeBottom.constant=-e.boundingBox.getCenter(new THREE.Vector3).y-this._rootComponentPosition.y,this._planeSide.constant=2*-e.boundingBox.getSize(new THREE.Vector3).x+e.boundingBox.getCenter(new THREE.Vector3).x,this._camera.userData.yaw>0&&(this._planeSide.constant*=-1),this._bounds&&(this._planeFront.constant=this._bounds.z/2+e.boundingBox.getCenter(new THREE.Vector3).z))}_calculateOffset(e){e&&e.boundingBox&&(this._offset.copy(e.boundingBox.getCenter(new THREE.Vector3)),this._offset.applyQuaternion(e.getWorldQuaternion(new THREE.Quaternion)))}update(e,t,n){if(e&&(this._bounds=e),t&&(this._rootComponentPosition=t),n){this._backgroundScene=n;let e=this._backgroundScene.children[0];e instanceof THREE.Mesh&&e.geometry.computeBoundingBox()}}clear(){this._currentDrag&&disposeMesh(this._currentDrag),this._currentHover&&disposeMesh(this._currentHover)}enableDragIn(e){this._currentDrag=e}setRootComponentId(e){this._rootComponentId=e}setCamera(e){this._camera=e}setScene(e){this._scene=e}}export{CommonKernelAccess as a,RaycastHelper as b};
//# sourceMappingURL=chunk-09ccaab5.js.map
