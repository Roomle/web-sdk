var WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,FLOAT:5126,UNSIGNED_INT:5125,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987},THREE_TO_WEBGL={1003:WEBGL_CONSTANTS.NEAREST,1004:WEBGL_CONSTANTS.NEAREST_MIPMAP_NEAREST,1005:WEBGL_CONSTANTS.NEAREST_MIPMAP_LINEAR,1006:WEBGL_CONSTANTS.LINEAR,1007:WEBGL_CONSTANTS.LINEAR_MIPMAP_NEAREST,1008:WEBGL_CONSTANTS.LINEAR_MIPMAP_LINEAR},PATH_PROPERTIES={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};THREE.GLTFExporter=function(){},THREE.GLTFExporter.prototype={constructor:THREE.GLTFExporter,parse:function(e,r,t){(t=Object.assign({},{trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,animations:[],forceIndices:!1,forcePowerOfTwoTextures:!1},t)).animations.length>0&&(t.trs=!0);var a,n={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},i=0,s=[],o=[],l=new Map,u=[],f={},c={attributes:new Map,materials:new Map,textures:new Map};function E(e,r){return e.length===r.length&&e.every(function(e,t){return e===r[t]})}function T(e){return 4*Math.ceil(e/4)}function m(e,r){r=r||0;var t=T(e.byteLength);if(t!==e.byteLength){var a=new Uint8Array(t);if(a.set(new Uint8Array(e)),0!==r)for(var n=e.byteLength;t>n;n++)a[n]=r;return a.buffer}return e}function h(e){return n.buffers||(n.buffers=[{byteLength:0}]),s.push(e),0}function p(e,r,a,s){var o;if(e.array.constructor===Float32Array)o=WEBGL_CONSTANTS.FLOAT;else if(e.array.constructor===Uint32Array)o=WEBGL_CONSTANTS.UNSIGNED_INT;else if(e.array.constructor===Uint16Array)o=WEBGL_CONSTANTS.UNSIGNED_SHORT;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");o=WEBGL_CONSTANTS.UNSIGNED_BYTE}if(void 0===a&&(a=0),void 0===s&&(s=e.count),t.truncateDrawRange&&void 0!==r&&null===r.index){var l=a+s,u=r.drawRange.count===1/0?e.count:r.drawRange.start+r.drawRange.count;a=Math.max(a,r.drawRange.start),0>(s=Math.min(l,u)-a)&&(s=0)}if(0===s)return null;var f,c=function(e,r,t){for(var a={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},n=r;r+t>n;n++)for(var i=0;i<e.itemSize;i++){var s=e.array[n*e.itemSize+i];a.min[i]=Math.min(a.min[i],s),a.max[i]=Math.max(a.max[i],s)}return a}(e,a,s);void 0!==r&&(f=e===r.index?WEBGL_CONSTANTS.ELEMENT_ARRAY_BUFFER:WEBGL_CONSTANTS.ARRAY_BUFFER);var E=function(e,r,t,a,s){var o;n.bufferViews||(n.bufferViews=[]),o=r===WEBGL_CONSTANTS.UNSIGNED_BYTE?1:r===WEBGL_CONSTANTS.UNSIGNED_SHORT?2:4;for(var l=T(a*e.itemSize*o),u=new DataView(new ArrayBuffer(l)),f=0,c=t;t+a>c;c++)for(var E=0;E<e.itemSize;E++){var m=e.array[c*e.itemSize+E];r===WEBGL_CONSTANTS.FLOAT?u.setFloat32(f,m,!0):r===WEBGL_CONSTANTS.UNSIGNED_INT?u.setUint32(f,m,!0):r===WEBGL_CONSTANTS.UNSIGNED_SHORT?u.setUint16(f,m,!0):r===WEBGL_CONSTANTS.UNSIGNED_BYTE&&u.setUint8(f,m),f+=o}var p={buffer:h(u.buffer),byteOffset:i,byteLength:l};return void 0!==s&&(p.target=s),s===WEBGL_CONSTANTS.ARRAY_BUFFER&&(p.byteStride=e.itemSize*o),i+=l,n.bufferViews.push(p),{id:n.bufferViews.length-1,byteLength:0}}(e,o,a,s,f),m={bufferView:E.id,byteOffset:E.byteOffset,componentType:o,count:s,max:c.max,min:c.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return n.accessors||(n.accessors=[]),n.accessors.push(m),n.accessors.length-1}function g(e){if(c.textures.has(e))return c.textures.get(e);n.textures||(n.textures=[]);var r={sampler:function(e){n.samplers||(n.samplers=[]);var r={magFilter:THREE_TO_WEBGL[e.magFilter],minFilter:THREE_TO_WEBGL[e.minFilter],wrapS:THREE_TO_WEBGL[e.wrapS],wrapT:THREE_TO_WEBGL[e.wrapT]};return n.samplers.push(r),n.samplers.length-1}(e),source:function(e){n.images||(n.images=[]);var r,s=e.format===THREE.RGBAFormat?"image/png":"image/jpeg",l={mimeType:s};if(t.embedImages){var u=a=a||document.createElement("canvas");u.width=e.image.width,u.height=e.image.height,!t.forcePowerOfTwoTextures||(r=e.image,THREE.Math.isPowerOfTwo(r.width)&&THREE.Math.isPowerOfTwo(r.height))||(console.warn("GLTFExporter: Resized non-power-of-two image.",e.image),u.width=THREE.Math.floorPowerOfTwo(u.width),u.height=THREE.Math.floorPowerOfTwo(u.height));var f=u.getContext("2d");!0===e.flipY&&(f.translate(0,u.height),f.scale(1,-1)),f.drawImage(e.image,0,0,u.width,u.height),!0===t.binary?o.push(new Promise(function(e){u.toBlob(function(r){(function(e){return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){var t=new window.FileReader;t.readAsArrayBuffer(e),t.onloadend=function(){var e=m(t.result),a={buffer:h(e),byteOffset:i,byteLength:e.byteLength};i+=e.byteLength,n.bufferViews.push(a),r(n.bufferViews.length-1)}})})(r).then(function(r){l.bufferView=r,e()})},s)})):l.uri=u.toDataURL(s)}else l.uri=e.image.src;return n.images.push(l),n.images.length-1}(e)};n.textures.push(r);var s=n.textures.length-1;return c.textures.set(e,s),s}function d(e){if(c.materials.has(e))return c.materials.get(e);if(n.materials||(n.materials=[]),e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;var r={pbrMetallicRoughness:{}};e.isMeshBasicMaterial?(r.extensions={KHR_materials_unlit:{}},f.KHR_materials_unlit=!0):e.isMeshStandardMaterial||console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var t=e.color.toArray().concat([e.opacity]);if(E(t,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=t),e.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):e.isMeshBasicMaterial?(r.pbrMetallicRoughness.metallicFactor=0,r.pbrMetallicRoughness.roughnessFactor=.9):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),(e.metalnessMap||e.roughnessMap)&&(e.metalnessMap===e.roughnessMap?r.pbrMetallicRoughness.metallicRoughnessTexture={index:g(e.metalnessMap)}:console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.")),e.map&&(r.pbrMetallicRoughness.baseColorTexture={index:g(e.map)}),e.isMeshBasicMaterial||e.isLineBasicMaterial||e.isPointsMaterial);else{var a=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();E(a,[0,0,0])||(r.emissiveFactor=a),e.emissiveMap&&(r.emissiveTexture={index:g(e.emissiveMap)})}e.normalMap&&(r.normalTexture={index:g(e.normalMap)},-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),r.normalTexture.scale=e.normalScale.x)),e.aoMap&&(r.occlusionTexture={index:g(e.aoMap)},1!==e.aoMapIntensity&&(r.occlusionTexture.strength=e.aoMapIntensity)),(e.transparent||e.alphaTest>0)&&(r.alphaMode=1>e.opacity?"BLEND":"MASK",e.alphaTest>0&&.5!==e.alphaTest&&(r.alphaCutoff=e.alphaTest)),e.side===THREE.DoubleSide&&(r.doubleSided=!0),""!==e.name&&(r.name=e.name),n.materials.push(r);var i=n.materials.length-1;return c.materials.set(e,i),i}function N(e,r){n.animations||(n.animations=[]);for(var t=[],a=[],i=0;i<e.tracks.length;++i){var s=e.tracks[i],o=THREE.PropertyBinding.parseTrackName(s.name),u=THREE.PropertyBinding.findNode(r,o.nodeName),f=PATH_PROPERTIES[o.propertyName];if("bones"===o.objectName&&(u=!0===u.isSkinnedMesh?u.skeleton.getBoneByName(o.objectIndex):void 0),!u||!f)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',s.name),null;var c,E=s.values.length/s.times.length;f===PATH_PROPERTIES.morphTargetInfluences&&(E/=u.morphTargetInfluences.length),!0===s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(c="CUBICSPLINE",E/=3):c=s.getInterpolation()===THREE.InterpolateDiscrete?"STEP":"LINEAR",a.push({input:p(new THREE.BufferAttribute(s.times,1)),output:p(new THREE.BufferAttribute(s.values,E)),interpolation:c}),t.push({sampler:a.length-1,target:{node:l.get(u),path:f}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:a,channels:t}),n.animations.length-1}function S(e){var r=n.nodes[l.get(e)],t=e.skeleton,a=e.skeleton.bones[0];if(void 0===a)return null;for(var i=[],s=new Float32Array(16*t.bones.length),o=0;o<t.bones.length;++o)i.push(l.get(t.bones[o])),t.boneInverses[o].toArray(s,16*o);return void 0===n.skins&&(n.skins=[]),n.skins.push({inverseBindMatrices:p(new THREE.BufferAttribute(s,16)),joints:i,skeleton:l.get(a)}),r.skin=n.skins.length-1}function A(e){if(e.isLight)return console.warn("GLTFExporter: Unsupported node type:",e.constructor.name),null;n.nodes||(n.nodes=[]);var r={};if(t.trs){var a=e.quaternion.toArray(),i=e.position.toArray(),s=e.scale.toArray();E(a,[0,0,0,1])||(r.rotation=a),E(i,[0,0,0])||(r.translation=i),E(s,[1,1,1])||(r.scale=s)}else e.updateMatrix(),E(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])||(r.matrix=e.matrix.elements);if(""!==e.name&&(r.name=String(e.name)),e.userData&&Object.keys(e.userData).length>0)try{r.extras=JSON.parse(JSON.stringify(e.userData))}catch(e){throw new Error("THREE.GLTFExporter: userData can't be serialized")}if(e.isMesh||e.isLine||e.isPoints){var o=function(e){var r,a=e.geometry;if(e.isLineSegments)r=WEBGL_CONSTANTS.LINES;else if(e.isLineLoop)r=WEBGL_CONSTANTS.LINE_LOOP;else if(e.isLine)r=WEBGL_CONSTANTS.LINE_STRIP;else if(e.isPoints)r=WEBGL_CONSTANTS.POINTS;else{if(!a.isBufferGeometry){var i=new THREE.BufferGeometry;i.fromGeometry(a),a=i}e.drawMode===THREE.TriangleFanDrawMode?(console.warn("GLTFExporter: TriangleFanDrawMode and wireframe incompatible."),r=WEBGL_CONSTANTS.TRIANGLE_FAN):r=e.drawMode===THREE.TriangleStripDrawMode?e.material.wireframe?WEBGL_CONSTANTS.LINE_STRIP:WEBGL_CONSTANTS.TRIANGLE_STRIP:e.material.wireframe?WEBGL_CONSTANTS.LINES:WEBGL_CONSTANTS.TRIANGLES}var s={},o={},l=[],u=[],f={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},E=a.getAttribute("normal");for(var T in void 0===E||function(e){if(c.attributes.has(e))return!1;for(var r=new THREE.Vector3,t=0,a=e.count;a>t;t++)if(Math.abs(r.fromArray(e.array,3*t).length()-1)>5e-4)return!1;return!0}(E)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),a.addAttribute("normal",function(e){if(c.attributes.has(e))return c.textures.get(e);for(var r=e.clone(),t=new THREE.Vector3,a=0,n=r.count;n>a;a++)t.fromArray(r.array,3*a),0===t.x&&0===t.y&&0===t.z?t.setX(1):t.normalize(),t.toArray(r.array,3*a);return c.attributes.set(e,r),r}(E))),a.attributes){var m=a.attributes[T];T=f[T]||T.toUpperCase();var h=m.array;if("JOINTS_0"!==T||h instanceof Uint16Array||h instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),m=new THREE.BufferAttribute(new Uint16Array(h),m.itemSize,m.normalized)),"MORPH"!==T.substr(0,5)){var g=p(m,a);null!==g&&(o[T]=g)}}if(void 0!==E&&a.addAttribute("normal",E),0===Object.keys(o).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){var N=[],S=[],A={};if(void 0!==e.morphTargetDictionary)for(var R in e.morphTargetDictionary)A[e.morphTargetDictionary[R]]=R;for(var v=0;v<e.morphTargetInfluences.length;++v){var w={},L=!1;for(var T in a.morphAttributes)if("position"===T||"normal"===T){m=a.morphAttributes[T][v];for(var y=a.attributes[T],b=m.clone(),I=0,_=m.count;_>I;I++)b.setXYZ(I,m.getX(I)-y.getX(I),m.getY(I)-y.getY(I),m.getZ(I)-y.getZ(I));w[T.toUpperCase()]=p(b,a)}else L||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),L=!0);u.push(w),N.push(e.morphTargetInfluences[v]),void 0!==e.morphTargetDictionary&&S.push(A[v])}s.weights=N,S.length>0&&(s.extras={},s.extras.targetNames=S)}var M=t.forceIndices,x=Array.isArray(e.material);if(x&&0===e.geometry.groups.length)return null;!M&&null===a.index&&x&&(console.warn("THREE.GLTFExporter: Creating index for non-indexed multi-material mesh."),M=!0);var O=!1;if(null===a.index&&M){for(var G=[],B=(v=0,a.attributes.position.count);B>v;v++)G[v]=v;a.setIndex(G),O=!0}var F=x?e.material:[e.material],P=x?e.geometry.groups:[{materialIndex:0,start:void 0,count:void 0}];for(v=0,B=P.length;B>v;v++){var C={mode:r,attributes:o};u.length>0&&(C.targets=u),null!==a.index&&(C.indices=p(a.index,a,P[v].start,P[v].count));var H=d(F[P[v].materialIndex]);null!==H&&(C.material=H),l.push(C)}return O&&a.setIndex(null),s.primitives=l,n.meshes||(n.meshes=[]),n.meshes.push(s),n.meshes.length-1}(e);null!==o&&(r.mesh=o)}else e.isCamera&&(r.camera=function(e){n.cameras||(n.cameras=[]);var r=e.isOrthographicCamera,t={type:r?"orthographic":"perspective"};return r?t.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far>0?e.far:.001,znear:0>e.near?0:e.near}:t.perspective={aspectRatio:e.aspect,yfov:THREE.Math.degToRad(e.fov)/e.aspect,zfar:e.far>0?e.far:.001,znear:0>e.near?0:e.near},""!==e.name&&(t.name=e.type),n.cameras.push(t),n.cameras.length-1}(e));if(e.isSkinnedMesh&&u.push(e),e.children.length>0){for(var f=[],T=0,m=e.children.length;m>T;T++){var h=e.children[T];if(h.visible||!1===t.onlyVisible){var g=A(h);null!==g&&f.push(g)}}f.length>0&&(r.children=f)}n.nodes.push(r);var N=n.nodes.length-1;return l.set(e,N),N}function R(e){n.scenes||(n.scenes=[],n.scene=0);var r={nodes:[]};""!==e.name&&(r.name=e.name),n.scenes.push(r);for(var a=[],i=0,s=e.children.length;s>i;i++){var o=e.children[i];if(o.visible||!1===t.onlyVisible){var l=A(o);null!==l&&a.push(l)}}a.length>0&&(r.nodes=a)}!function(e){e=e instanceof Array?e:[e];for(var r=[],a=0;a<e.length;a++)e[a]instanceof THREE.Scene?R(e[a]):r.push(e[a]);for(r.length>0&&function(e){var r=new THREE.Scene;r.name="AuxScene";for(var t=0;t<e.length;t++)r.children.push(e[t]);R(r)}(r),a=0;a<u.length;++a)S(u[a]);for(a=0;a<t.animations.length;++a)N(t.animations[a],e[0])}(e),Promise.all(o).then(function(){var e=new Blob(s,{type:"application/octet-stream"}),a=Object.keys(f);if(a.length>0&&(n.extensionsUsed=a),n.buffers&&n.buffers.length>0){n.buffers[0].byteLength=e.size;var i=new window.FileReader;!0===t.binary?(i.readAsArrayBuffer(e),i.onloadend=function(){var e=m(i.result),t=new DataView(new ArrayBuffer(8));t.setUint32(0,e.byteLength,!0),t.setUint32(4,5130562,!0);var a=m(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var r=new Uint8Array(new ArrayBuffer(e.length)),t=0,a=e.length;a>t;t++){var n=e.charCodeAt(t);r[t]=n>255?32:n}return r.buffer}(JSON.stringify(n)),32),s=new DataView(new ArrayBuffer(8));s.setUint32(0,a.byteLength,!0),s.setUint32(4,1313821514,!0);var o=new ArrayBuffer(12),l=new DataView(o);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);var u=12+s.byteLength+a.byteLength+t.byteLength+e.byteLength;l.setUint32(8,u,!0);var f=new Blob([o,s,a,t,e],{type:"application/octet-stream"}),c=new window.FileReader;c.readAsArrayBuffer(f),c.onloadend=function(){r(c.result)}}):(i.readAsDataURL(e),i.onloadend=function(){var e=i.result;n.buffers[0].uri=e,r(n)})}else r(n)})}};