System.register(["./chunk-eb2e1ffb.legacy.js","./chunk-4c9a4d80.legacy.js","./chunk-a2a0b386.legacy.js","./chunk-146a76dc.legacy.js","./chunk-433d97dd.legacy.js"],function(e,t){var n,i,o,a,r,s,l,c,h,d,u,_,p,m,v,f,g,y,b,w,k,E,C,H,P,T,S,x,R,I,L,M,O,G,D,F,A,U,V,B,j,z,q,N,W,K,Z,Y,Q,X,J;return{setters:[function(e){n=e.a,i=e.b},function(e){o=e.a,a=e.b,r=e.c,s=e.d,l=e.e,c=e.f,h=e.g,d=e.h,u=e.i},function(e){_=e.a,p=e.b,m=e.c,v=e.d,f=e.e,g=e.f,y=e.g,b=e.h,w=e.i,k=e.j,E=e.k,C=e.l,H=e.m,P=e.n,T=e.o,S=e.p,x=e.q,R=e.r,I=e.s,L=e.t,M=e.u,O=e.v,G=e.w,D=e.x,F=e.y,A=e.z,U=e.A,V=e.B,B=e.C},function(e){j=e.a,z=e.b,q=e.c,N=e.d,W=e.e,K=e.f,Z=e.g,Y=e.h,Q=e.i,X=e.j},function(e){J=e.a}],execute:function(){var e=function(){function e(){o(this,e),this.rootComponentParametersAsGlobal=!1,this.lastLoadedRapiId=null,this.selectedRuntimeComponentIds=[],this.selectionMode="standard"}return a(e,[{key:"selectedRuntimeComponentId",get:function(){return this.selectedRuntimeComponentIds.length>0?this.selectedRuntimeComponentIds[0]:null}}]),e}(),$="There is no material ID provided. Check the configuration script maybe it is malformed",ee=new Map,te=new Map,ne=function(){function e(){o(this,e)}return a(e,null,[{key:"loadFont",value:function(t){if(te.has(t))return new Promise(function(e,n){e(te.get(t))});if(ee.has(t))return new Promise(function(e,n){ee.get(t).push({resolve:e,reject:n})});var n=new THREE.FontLoader;return new Promise(function(i,o){ee.set(t,[{resolve:i,reject:o}]),n.load(_()+t,function(n){te.set(t,n),e._resolveAll(t,n)})})}},{key:"_resolveAll",value:function(e,t){ee.has(e)&&ee.get(e).forEach(function(e){return e.resolve(t)}),ee.delete(e)}}]),e}(),ie=3618615,oe=16777215,ae=function(){function e(t,n){var i=this;o(this,e),this._textUpdated=!1,this.forceDimensions=!1,this._hoverOnTime=0,this._delayDuration=500,this._dimensionsVisible=!1,this._camera=t,this._formatter=n,this._lineMaterial=new THREE.LineBasicMaterial({color:ie}),this._textMaterial=new THREE.MeshPhongMaterial({color:ie});var a=new THREE.Geometry;this._widthLine=new THREE.Line(a,this._lineMaterial),this._widthLine.name="dimension width line",this._widthLine.layers.set(6),this._heightLine=new THREE.Line(a,this._lineMaterial),this._heightLine.name="dimension height line",this._heightLine.layers.set(6),this._depthLine=new THREE.Line(a,this._lineMaterial),this._depthLine.name="dimension depth line",this._depthLine.layers.set(6),this._widthText=new THREE.Mesh(a,this._textMaterial),this._widthText.name="dimension width text",this._widthText.layers.set(6),this._heightText=new THREE.Mesh(a,this._textMaterial),this._heightText.name="dimension height text",this._heightText.layers.set(6),this._depthText=new THREE.Mesh(a,this._textMaterial),this._depthText.name="dimension depth text",this._depthText.layers.set(6),this._planeMaterial=new THREE.MeshBasicMaterial({color:oe,side:THREE.DoubleSide,opacity:.8,transparent:!0}),this._widthPlane=new THREE.Mesh(a,this._planeMaterial),this._widthPlane.layers.set(6),this._heightPlane=new THREE.Mesh(a,this._planeMaterial),this._heightPlane.layers.set(6),this._depthPlane=new THREE.Mesh(a,this._planeMaterial),this._depthPlane.layers.set(6),ne.loadFont("static/fonts/rubik_regular.json").then(function(e){i._font=e,i._loaded()})}return a(e,[{key:"_loaded",value:function(){this._textUpdated&&this._font&&this._onLoaded&&(this._onLoaded(),this._onLoaded=null)}},{key:"_performUpdate",value:function(e){if(this._lineBounds||e){if(!this._textUpdated&&this._font&&this._dimensions){var t=this._getWidthEdge().distance(),n=this._getHeightEdge().distance(),i=this._getDepthEdge().distance(),o=Math.round(Math.max(t,Math.max(n,i))),a=.025+(4>o?0:.005*o),r={font:this._font,size:a,height:.001,curveSegments:2,bevelEnabled:!0,bevelThickness:.001,bevelSize:.001},s=this._formatter,l=this._dimensions,c=l.x,h=l.y,d=l.z;this._widthTextGeometry&&this._widthTextGeometry.dispose(),this._widthTextGeometry=new THREE.TextGeometry(s.formatMMValueToUnitString(1e3*c),r),this._widthTextGeometry.computeBoundingBox(),this._widthText.geometry=this._widthTextGeometry,this._heightTextGeometry&&this._heightTextGeometry.dispose(),this._heightTextGeometry=new THREE.TextGeometry(s.formatMMValueToUnitString(1e3*h),r),this._heightTextGeometry.computeBoundingBox(),this._heightText.geometry=this._heightTextGeometry,this._depthTextGeometry&&this._depthTextGeometry.dispose(),this._depthTextGeometry=new THREE.TextGeometry(s.formatMMValueToUnitString(1e3*d),r),this._depthTextGeometry.computeBoundingBox(),this._depthText.geometry=this._depthTextGeometry,this._textUpdated=!0,this._loaded()}this._widthTextGeometry&&this._heightTextGeometry&&this._depthTextGeometry&&(this._updateWidth(),this._updateHeight(),this._updateDepth())}}},{key:"_updateWidth",value:function(){var e=new THREE.Geometry,t=this._getWidthEdge();e.vertices.push(t.start,t.end),this._widthLine.geometry.dispose(),this._widthLine.geometry=e;var n=this._widthTextGeometry.boundingBox.getSize(new THREE.Vector3),i=t.getCenter(new THREE.Vector3);if(i.x-=n.x/2*this._getZSign(),i.y+=.02,this._widthText.position.copy(i),0>this._getZSign()){var o=new THREE.Quaternion;o.setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),this._widthText.quaternion.copy(o)}else{var a=new THREE.Quaternion;a.setFromAxisAngle(new THREE.Vector3(0,0,0),Math.PI),this._widthText.quaternion.copy(a)}var r=new THREE.PlaneGeometry(n.x+.02,n.y+.02,32);this._widthPlane.geometry.dispose(),this._widthPlane.geometry=r,this._widthPlane.position.copy(t.getCenter(new THREE.Vector3)).add(new THREE.Vector3(0,.02+n.y/2,0))}},{key:"_updateHeight",value:function(){var e=new THREE.Geometry,t=this._getHeightEdge();e.vertices.push(t.start,t.end),this._heightLine.geometry.dispose(),this._heightLine.geometry=e;var n=this._heightTextGeometry.boundingBox.getSize(new THREE.Vector3),i=t.getCenter(new THREE.Vector3);0>this._getXSign()&&this._getZSign()>0?i.x-=n.x+.02:this._getXSign()>0&&0>this._getZSign()?i.x+=n.x+.02:i.x+=.02*this._getXSign(),this._heightText.position.copy(i);var o=new THREE.Quaternion;0>this._getZSign()?(o.setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),this._heightText.quaternion.copy(o)):(o.setFromAxisAngle(new THREE.Vector3(0,0,0),Math.PI),this._heightText.quaternion.copy(o));var a=new THREE.PlaneGeometry(n.x+.02,n.y+.02,32);this._heightPlane.geometry.dispose(),this._heightPlane.geometry=a,this._heightPlane.position.copy(i),this._heightPlane.position.add(new THREE.Vector3(this._heightText.geometry.boundingBox.getCenter(new THREE.Vector3).x*this._getZSign(),this._heightText.geometry.boundingBox.getCenter(new THREE.Vector3).y,0))}},{key:"_updateDepth",value:function(){var e=new THREE.Geometry,t=this._getDepthEdge();e.vertices.push(t.start,t.end),this._depthLine.geometry.dispose(),this._depthLine.geometry=e;var n=this._depthTextGeometry.boundingBox.getSize(new THREE.Vector3),i=t.getCenter(new THREE.Vector3);i.y+=.02;var o=new THREE.Quaternion;o.setFromAxisAngle(new THREE.Vector3(0,-1,0),Math.PI/2);var a=o.clone();this._getXSign()>0?(a.setFromAxisAngle(new THREE.Vector3(0,-1,0),Math.PI),a.multiply(o),i.z+=n.x/2):i.z-=n.x/2,this._depthText.position.copy(i),this._depthText.quaternion.copy(a);var r=new THREE.PlaneGeometry(n.x+.02,n.y+.02,32);this._depthPlane.geometry.dispose(),this._depthPlane.geometry=r,this._depthPlane.position.copy(t.getCenter(new THREE.Vector3)).add(new THREE.Vector3(0,.02+n.y/2,0)),this._depthPlane.quaternion.copy(a)}},{key:"updateBounds",value:function(e){this._dimensions=new THREE.Vector3(e.size.x/1e3,e.size.z/1e3,e.size.y/1e3),this._lineBounds=p(e,new THREE.Vector3(.05,e.origin.z/1e3,.05)),this._textUpdated=!1}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._performUpdate(e)}},{key:"addToScene",value:function(e,t){e.add(this._widthLine),t.add(this._widthPlane),t.add(this._widthText),e.add(this._heightLine),t.add(this._heightPlane),t.add(this._heightText),e.add(this._depthLine),t.add(this._depthPlane),t.add(this._depthText)}},{key:"_getWidthEdge",value:function(){return 0>this._camera.position.z?new THREE.Line3(new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.min.y,this._lineBounds.min.z),new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.min.y,this._lineBounds.min.z)):new THREE.Line3(new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.min.y,this._lineBounds.max.z),new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.min.y,this._lineBounds.max.z))}},{key:"_getDepthEdge",value:function(){return 0>this._camera.position.x?new THREE.Line3(new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.min.y,this._lineBounds.min.z),new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.min.y,this._lineBounds.max.z)):new THREE.Line3(new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.min.y,this._lineBounds.min.z),new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.min.y,this._lineBounds.max.z))}},{key:"_getHeightEdge",value:function(){return 0>this._camera.position.x||0>this._camera.position.z?0>this._camera.position.x&&this._camera.position.z>=0?new THREE.Line3(new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.min.y,this._lineBounds.max.z),new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.max.y,this._lineBounds.max.z)):this._camera.position.x>=0&&0>this._camera.position.z?new THREE.Line3(new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.min.y,this._lineBounds.min.z),new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.max.y,this._lineBounds.min.z)):new THREE.Line3(new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.min.y,this._lineBounds.min.z),new THREE.Vector3(this._lineBounds.min.x,this._lineBounds.max.y,this._lineBounds.min.z)):new THREE.Line3(new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.min.y,this._lineBounds.max.z),new THREE.Vector3(this._lineBounds.max.x,this._lineBounds.max.y,this._lineBounds.max.z))}},{key:"_getZSign",value:function(){return 0>this._camera.position.z?-1:1}},{key:"_getXSign",value:function(){return 0>this._camera.position.x?-1:1}},{key:"onLoaded",value:function(e){this._onLoaded=e,this._loaded()}},{key:"onDimensionsVisibilityChanged",value:function(e){this._onChange=e}},{key:"onHover",value:function(e){e||(this._hoverOnTime=Date.now())}},{key:"disableDimensions",value:function(){this._hoverOnTime=0,this.forceDimensions=!1,this._dimensionsVisible&&(this._dimensionsVisible=!1,this._visibilityChangedCallback())}},{key:"areDimensionsEnabled",value:function(){var e=this._hoverOnTime>0&&Date.now()-this._hoverOnTime>=this._delayDuration;return e&&!this._dimensionsVisible&&(this._dimensionsVisible=!0,this._visibilityChangedCallback()),e}},{key:"_visibilityChangedCallback",value:function(){this._onChange&&this._onChange(this._dimensionsVisible)}},{key:"clear",value:function(){this._lineMaterial.dispose(),this._planeMaterial.dispose(),this._widthLine.geometry.dispose(),this._heightLine.geometry.dispose(),this._depthLine.geometry.dispose(),this._widthPlane.geometry.dispose(),this._heightPlane.geometry.dispose(),this._depthPlane.geometry.dispose(),this._textMaterial.dispose(),this._widthTextGeometry&&this._widthTextGeometry.dispose(),this._heightTextGeometry&&this._heightTextGeometry.dispose(),this._depthTextGeometry&&this._depthTextGeometry.dispose()}}]),e}(),re=.05,se=8947848,le=0,ce=function(){function e(t,n){var i=this;o(this,e),this._addOnSpotIcons=new Map,this.previewGhostEnabled=!1,this.addOnSpotsEnabled=!1,this._state=3,this._camera=t,this._textMaterial=new THREE.MeshStandardMaterial({color:se}),this._textMaterialSelected=new THREE.MeshStandardMaterial({color:le});var a=new THREE.Geometry;this._plusText=new THREE.Mesh(a,this._textMaterial),this._plusText.layers.set(4),ne.loadFont("static/fonts/rubik_regular.json").then(function(e){i._font=e;var t={font:i._font,size:re,height:.001,curveSegments:2,bevelEnabled:!0,bevelThickness:.001,bevelSize:.001};i._plusTextGeometry=new THREE.TextGeometry("+",t),i._plusTextGeometry.computeBoundingBox(),i._plusText.geometry=i._plusTextGeometry}),this._plusButtonPromise=new Promise(function(e,t){n.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader-js"}).then(function(){(new THREE.GLTFLoader).load(_()+"static/geometry/AddButtonRound.glb",function(n){n&&n.scene&&n.scene.children&&n.scene.children.length>0?(i._onPlusButtonLoaded(n.scene.children[0]),e()):t("loaded scene has no childrens")},function(e){},function(e){console.error(e),t(e)})})})}return a(e,[{key:"_onPlusButtonLoaded",value:function(e){e&&(this._plusButton=e,this._plusButton.material=this._textMaterial,this._plusButton.layers.set(4),this._plusButton.scale.copy(new THREE.Vector3(.08,.08,.08)))}},{key:"_performUpdate",value:function(e){var t=this;if(this.addOnSpotsEnabled){var n=!0,i=!1,o=void 0;try{for(var a,r=this._addOnSpotIcons.values()[Symbol.iterator]();!(n=(a=r.next()).done);n=!0)a.value.forEach(function(e){e.geometry.center();var n=new THREE.Vector3(0,1,0);n.applyQuaternion(t._camera.quaternion),e.up.copy(n),e.lookAt(t._camera.position)})}catch(e){i=!0,o=e}finally{try{n||null==r.return||r.return()}finally{if(i)throw o}}}}},{key:"addAddOnSpots",value:function(e,t,n){var i=this;Promise.all([this._plusButtonPromise]).then(function(){i.addOnSpotsEnabled&&i._plusButton&&(i.deleteAddonPointsForComponent(t.roomleId),n.forEach(function(n){var o=i._plusButton.clone();o.name="addOnSpot "+t.roomleId,o.layers.set(7),o.position.copy(i.getPositionForAddOnPosition(e,t.position,new THREE.Vector3(n.position.x,n.position.y,n.position.z))),i._addOnSpotIcons.has(t.roomleId)?i._addOnSpotIcons.get(t.roomleId).push(o):i._addOnSpotIcons.set(t.roomleId,[o]),o.geometry.computeBoundingBox();var a=o.geometry.boundingBox,r=a.getSize(new THREE.Vector3),s=new THREE.BoxGeometry(r.x,r.y,r.z),l=new THREE.Mesh(s,new THREE.MeshStandardMaterial({color:"#FFFFFF",transparent:!0,opacity:0,polygonOffset:!0,polygonOffsetFactor:-1}));l.layers.set(4),l.translateOnAxis(a.getCenter(new THREE.Vector3),1),l.renderOrder=3,l.visible=!0,o.add(l),l.userData={hasListener:!0,priority:3,roomleId:t.roomleId},l.addEventListener("select",function(){i._onAddonClick&&i._onAddonClick()}),l.addEventListener("hover_on",function(){m("pointer"),i._eventHandler.dispatch(74)}),l.addEventListener("hover_off",function(){m("default"),i._eventHandler.dispatch(75)}),t.add(o)}))})}},{key:"deleteAddonPointsForComponent",value:function(e){this.addOnSpotsEnabled&&this._addOnSpotIcons.has(e)&&(this._addOnSpotIcons.get(e).forEach(function(e){e.parent.remove(e)}),this._addOnSpotIcons.delete(e))}},{key:"getPositionForAddOnPosition",value:function(e,t,n){var i=new THREE.Vector3;return i.set(n.x/1e3,n.z/1e3,n.y/-1e3),i}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._performUpdate(e)}},{key:"changePreviewGhostVisibility",value:function(e,t){this.previewGhostEnabled&&(t?(e.add(this._plusText),this._plusText.position.copy((new THREE.Vector3).add(e.boundingBox.getCenter(new THREE.Vector3))),this._plusText.geometry.center()):e.remove(this._plusText))}},{key:"_changeAddOnSpotVisibility",value:function(e){this.addOnSpotsEnabled&&this._addOnSpotsVisible!==e&&(this._addOnSpotsVisible=e)}},{key:"isAddOnSpotVisible",value:function(){return this._addOnSpotsVisible&&this.addOnSpotsEnabled}},{key:"onAddonClick",value:function(e){this._onAddonClick=e}},{key:"setState",value:function(e){1===this._state&&2!==e||1===e&&5===this._state||3!==e&&5===this._state||(4!==e&&1!==e&&5!==e||this._changeAddOnSpotVisibility(!1),3!==e&&2!==e&&0!==e||this._changeAddOnSpotVisibility(!0),this._state=e)}}]),e}();n([i],ce.prototype,"_eventHandler",void 0);var he=function e(t){o(this,e);var n=t.component,i=t.preview,a=t.resetCamera,r=t.type;this.component=n,this.preview=i,this.resetCamera=void 0===a||a,this.type=r||0},de=function(e){function t(e,n,i,a){var l;return o(this,t),(l=r(this,s(t).call(this)))._debug=!1,l._dragIn=!1,l._raycastHelper=new j(e,n,i),l._addonHelper=a,l._raycastHelper.addEventListener(3,function(){l._clickOutside()},c(c(l))),l._selectionHandler.addEventListener(0,function(e){var t=e.component;l.dispatchEvent(7,new he({component:t})),l._inputManager.setDragEnabled(!0)},c(c(l))),l._selectionHandler.addEventListener(1,function(e){var t=e.component,n=e.resetCamera;l._selectionHandler.hasSelection()||l._inputManager.setDragEnabled(!1),l.dispatchEvent(8,new he({component:t,resetCamera:n}))},c(c(l))),l._inputManager=i,l._addInputListeners(i),l}return l(t,v),a(t,[{key:"_addInputListeners",value:function(e){var t=this;e.addEventListener(7,function(e){return t._interaction()},this),e.addEventListener(8,function(e){return t._interaction()},this)}},{key:"addComponentHandlers",value:function(e){var t=this;this._addComponentHandlers(e,e.boundingBoxMesh,{hasListener:!0,priority:1,roomleId:e.roomleId}),e.meshes.forEach(function(n){t._addComponentHandlers(e,n,{hasListener:!0,priority:2,roomleId:e.roomleId})})}},{key:"addComponentDragInHandler",value:function(e){this._dragIn&&(this._addComponentHandlers(e,e.boundingBoxMesh,{hasListener:!0,priority:1,roomleId:e.roomleId}),this._raycastHelper.enableDragIn(e.boundingBoxMesh))}},{key:"_addComponentHandlers",value:function(e,t,n){var i=this;t.userData.hasListener||(t.userData=n,t.addEventListener("select",function(){return i._clickComponent(e)}),t.addEventListener("hover_on",function(t){return i._hoverOn(e,t.attachment.type)}),t.addEventListener("hover_off",function(t){return i._hoverOff(e,t.attachment.type)}),t.addEventListener("drag_start",function(){return i._dragStart(e)}),t.addEventListener("drag",function(t){return i._drag(e,t.attachment.position)}),t.addEventListener("drag_end",function(t){return i._dragEnd(e,t.attachment.position)}))}},{key:"addPreviewHandlers",value:function(e){var t=this,n=e.boundingBoxMesh;n.userData.hasListener||(n.userData={hasListener:!0,priority:3,roomleId:e.roomleId},n.addEventListener("select",function(){return t._clickPreview(e)}),n.addEventListener("hover_on",function(){return t._hoverOnPreview(e)}),n.addEventListener("hover_off",function(){return t._hoverOffPreview(e)}))}},{key:"addPreviewLineHandlers",value:function(e){var t=this,n=e.boundingLineMesh;n.userData.hasListener||(n.userData={hasListener:!0,priority:4,roomleId:e.roomleId},n.addEventListener("select",function(){return t._clickPreviewLine(e)}),n.addEventListener("hover_on",function(n){return t._hoverOnPreviewLine(e,n.attachment.intersection)}),n.addEventListener("hover_move",function(n){return t._hoverMovePreviewLine(e,n.attachment.intersection)}),n.addEventListener("hover_off",function(){return t._hoverOffPreviewLine(e)}))}},{key:"_clickPreview",value:function(e){this._dragStartPosition&&(e.position.copy(this._dragStartPosition),this._dragStartPosition=null),this.dispatchEvent(6,new he({preview:e}))}},{key:"_clickPreviewLine",value:function(e){this._dragStartPosition&&(e.position.copy(this._dragStartPosition),this._dragStartPosition=null),this.dispatchEvent(6,new he({preview:e}))}},{key:"_clickComponent",value:function(e){this._debug&&e.roomleId,this._selectionHandler.check(e)}},{key:"_clickOutside",value:function(){this._selectionHandler.cancelSelection(),this.dispatchEvent(3),this._interaction()}},{key:"_hoverOn",value:function(e,t){this._debug&&e.roomleId,2!==t&&e.hoverOn(),this._interaction(),this.dispatchEvent(1,new he({component:e,type:t}))}},{key:"_hoverOff",value:function(e,t){this._debug&&e.roomleId,2!==t&&e.hoverOff(),this._interaction(),this.dispatchEvent(2,new he({component:e,type:t}))}},{key:"_hoverOnPreview",value:function(e){e.hoverOn(),this._interaction(),this._hoveredPreview=e,this._addonHelper&&this._addonHelper.changePreviewGhostVisibility(e,!0)}},{key:"_hoverOffPreview",value:function(e){e.hoverOff(),this._interaction(),this._hoveredPreview=null,this._addonHelper&&this._addonHelper.changePreviewGhostVisibility(e,!1)}},{key:"_hoverOnPreviewLine",value:function(e,t){this._updatePositionForPreviewLine(e,t),this._draggedComponent||e.hoverOn(),this._interaction(),this._hoveredPreview=e}},{key:"_hoverMovePreviewLine",value:function(e,t){this._updatePositionForPreviewLine(e,t),this._hoveredPreview=e,this._interaction()}},{key:"_updatePositionForPreviewLine",value:function(e,t){var n=t.object.parent.parent.worldToLocal(t.point);this._previewLineIntersection=n,e&&(this._draggedComponent?this._draggedComponent.visible=!0:e.updatePreviewPosition(n))}},{key:"_hoverOffPreviewLine",value:function(e){this._draggedComponent||e.hoverOff(),this._interaction(),this._hoveredPreview=null,this._previewLineIntersection=null}},{key:"_dragStart",value:function(e){this._dragStartPosition=e.position.clone(),this._dragStartRotation=e.rotation.clone(),this._draggedComponent=e,this.dispatchEvent(4,new he({component:e})),this._interaction()}},{key:"_drag",value:function(e,t){if(e&&!this._draggedComponent&&(this._draggedComponent=e),this._previewLineIntersection){var n=this._hoveredPreview,i=n.getPositionForIntersectionPoint(this._previewLineIntersection),o=n.parent.localToWorld(i);this._draggedComponent.position.copy(this._draggedComponent.parent.worldToLocal(o)),this._draggedComponent.rotation.copy(n.rotation),n.hideSelectionLine()}else e.parent?e.position.copy(e.parent.worldToLocal(t)):e.position.copy(t);this._hoveredPreview?e.visible=!1:e.visible=!0,this._interaction()}},{key:"_dragEnd",value:function(e,t){if(this._hoveredPreview)if(this._previewLineIntersection){var n=this._hoveredPreview,i=n.getPositionForIntersectionPoint(this._previewLineIntersection),o=n.parent.localToWorld(i);e.position.copy(e.parent.worldToLocal(o)),e.rotation.copy(n.rotation)}else e.position.copy(t);else this._dragStartPosition&&this._dragStartRotation&&(e.position.copy(this._dragStartPosition),e.rotation.copy(this._dragStartRotation),this._dragStartPosition=null,this._dragStartRotation=null,this.addComponentHandlers(e));e.visible=!0,this._draggedComponent=null,this._previewLineIntersection=null,this.dispatchEvent(5,new he({component:e,preview:this._hoveredPreview})),this._interaction()}},{key:"_interaction",value:function(){this.dispatchEvent(0)}},{key:"hasSelection",value:function(){return this._selectionHandler.hasSelection()}},{key:"update",value:function(e,t,n){this._raycastHelper.update(e,t,n)}},{key:"setDragIn",value:function(e,t){this._dragIn=e,e?this._inputManager.enableDragIn(t):this._raycastHelper.clear(),this._interaction()}},{key:"isDragIn",value:function(){return this._dragIn}},{key:"isDragging",value:function(){return null!=this._draggedComponent}},{key:"setRootComponentId",value:function(e){this._raycastHelper.setRootComponentId(e)}},{key:"cancelSelection",value:function(){this._selectionHandler.setSelectionMode("standard"),this._selectionHandler.cancelSelection()}},{key:"setSelectionMode",value:function(e){this._selectionHandler.setSelectionMode(e)}},{key:"getSelectionMode",value:function(){return this._selectionHandler.getSelectionMode()}},{key:"getSelectedRuntimeComponentIds",value:function(){return this._selectionHandler.getSelectedRuntimeComponentIds()}}]),t}();n([i],de.prototype,"_selectionHandler",void 0);var ue=function(e){function t(e){var n;return o(this,t),(n=r(this,s(t).call(this)))._uiIntersectionMask=0,n.floorEnvironment=!1,n._camera=e,n}return l(t,v),a(t,[{key:"updateToBounds",value:function(e,t,n){var i=new THREE.Vector3(-e.x/2,0,-e.z/2),o=new THREE.Vector3(e.x/2,e.y,e.z/2);this._boundingBox=new THREE.Box3(i,o),this._clientWidth=t,this._clientHeight=n;var a=this._boundingBox.getSize(new THREE.Vector3);this._boxVertices=[],this._boxVertices.push(this._boundingBox.min),this._boxVertices.push(this._boundingBox.min.clone().add(new THREE.Vector3(a.x,0,0))),this._boxVertices.push(this._boundingBox.max),this._boxVertices.push(this._boundingBox.max.clone().sub(new THREE.Vector3(a.x,0,0)))}},{key:"calculateUIIntersection",value:function(){var e=[];if(null!=this._boundingBox&&null!=this._offset){var t=this._checkPaddings();t.bottom=this._clientHeight-t.bottom,t.right=this._clientWidth-t.right;var n=0;this.floorEnvironment?(e=["left","right","bottom"],n=11):(this._offset.left>0&&t.left<this._offset.left*this._clientWidth&&(e.push("left"),n|=8),1>this._offset.right&&t.right<(1-this._offset.right)*this._clientWidth&&(e.push("right"),n|=2),this._offset.bottom>0&&t.bottom<this._offset.bottom*this._clientHeight&&(e.push("bottom"),n|=1)),1>this._offset.top&&t.top<(1-this._offset.top)*this._clientHeight&&(e.push("top"),n|=4),n!==this._uiIntersectionMask&&(this.dispatchEvent(0,e),this._uiIntersectionMask=n)}}},{key:"_checkPaddings",value:function(){var e=this,t={left:this._clientWidth/2,top:this._clientHeight/2,right:this._clientWidth/2,bottom:this._clientHeight/2};return this._boxVertices.forEach(function(n){var i=f(n,e._camera,e._clientWidth,e._clientHeight);i.x<t.left&&(t.left=i.x),i.x>t.right&&(t.right=i.x),i.y<t.top&&(t.top=i.y),i.y>t.bottom&&(t.bottom=i.y)}),t}},{key:"canvasOffset",set:function(e){this._offset=e}}]),t}(),_e=function(e){function t(e,n){var i;return o(this,t),(i=r(this,s(t).call(this,e,n)))._lights=[],i}return l(t,g),a(t,[{key:"loadFromJSON",value:function(e){var t=this;return new Promise(function(n,i){t._lights=t._dynamicLightSettingLoader.parse(e),t.addToScene(),n()})}},{key:"loadFromObject",value:function(e){var t=this;return new Promise(function(n,i){t._lights=t._dynamicLightSettingLoader.load(e),t._lights.filter(function(e,n){e.userData.movesWithCamera&&(t._cameraLight=e,t._lights.splice(n,1))}),t.addToScene(),n()})}},{key:"loadFromURL",value:function(e){var t=this;return new Promise(function(n,i){fetch(new Request(e,{method:"GET"})).then(b).then(function(e){return t.loadFromObject(e).then(n,i)})})}},{key:"addToScene",value:function(){var e=this;this._lights.forEach(function(t){e._scene.add(t)}),this._cameraLight&&(this._cameraLight.castShadow=!1,this._scene.add(this._cameraLight))}},{key:"removeFromScene",value:function(){var e=this;this._lights.forEach(function(t){e._scene.remove(t)}),this._cameraLight&&this._scene.remove(this._cameraLight)}},{key:"reload",value:function(){this.removeFromScene(),this.addToScene()}},{key:"update",value:function(e,t){if(this._cameraLight){var n=e.userData.yaw,i=e.userData.pitch,o=new THREE.Euler(-i,n,0,"ZYX"),a=(new THREE.Quaternion).setFromEuler(o),r=new THREE.Vector3(0,0,-1);r.applyQuaternion(a);var s=this._cameraLight.position.distanceTo(t),l=t.clone().sub(r.multiplyScalar(s));this._cameraLight.position.copy(l),this._cameraLight.lookAt(t)}}},{key:"showGUI",value:function(){var e=this,t=y();this._cameraLight&&this._addToGUI(t,this._cameraLight),this._lights.forEach(function(n){e._addToGUI(t,n)})}},{key:"_addToGUI",value:function(e,t){t instanceof THREE.SpotLight&&this._addSpotLightToGUI(e,t),t instanceof THREE.AmbientLight&&this._addAmbientLightToGUI(e,t),t instanceof THREE.RectAreaLight&&this._addRectAreaLightToGUI(e,t)}},{key:"_addRectAreaLightToGUI",value:function(e,t){var n=e.addFolder(t.name),i={name:t.name,color:"#"+t.color.getHexString(),intensity:t.intensity*t.width*t.height};n.add(t,"visible"),n.add(i,"intensity").min(100).max(400).step(1).onChange(function(e){t.intensity=e/(t.width*t.height)}),n.add(t,"castShadow"),n.addColor(i,"color").onChange(function(e){t.color=new THREE.Color(e)}),n.add(t.position,"x").min(-10).max(10).step(.1).onChange(function(){t.lookAt(new THREE.Vector3(0,0,0))}),n.add(t.position,"y").min(-10).max(10).step(.1).onChange(function(){t.lookAt(new THREE.Vector3(0,0,0))}),n.add(t.position,"z").min(-10).max(10).step(.1).onChange(function(){t.lookAt(new THREE.Vector3(0,0,0))})}},{key:"_addSpotLightToGUI",value:function(e,t){var n=e.addFolder(t.name),i={name:t.name,color:"#"+t.color.getHexString(),angle:180*t.angle/Math.PI};n.add(t,"visible"),n.add(t,"intensity").min(0).max(5).step(.1),n.add(t,"penumbra").min(0).max(1).step(.1),n.addColor(i,"color").onChange(function(e){t.color=new THREE.Color(e)}),n.add(i,"angle").min(10).max(180).step(1).onChange(function(e){t.angle=e*Math.PI/180}),n.add(t.position,"x").min(-10).max(10).step(.1).onChange(function(){t.lookAt(new THREE.Vector3(0,0,0))}),n.add(t.position,"y").min(-10).max(10).step(.1).onChange(function(){t.lookAt(new THREE.Vector3(0,0,0))}),n.add(t.position,"z").min(-10).max(10).step(.1).onChange(function(){t.lookAt(new THREE.Vector3(0,0,0))})}},{key:"_addAmbientLightToGUI",value:function(e,t){var n={name:t.name,color:"#"+t.color.getHexString()},i=e.addFolder(t.name);i.add(t,"visible"),i.add(t,"intensity").min(0).max(5).step(.1),i.addColor(n,"color").onChange(function(e){t.color=new THREE.Color(e)})}}]),t}();n([i],_e.prototype,"_dynamicLightSettingLoader",void 0);var pe=function(e){function t(e,n){var i;return o(this,t),(i=r(this,s(t).call(this,e,n)))._params={ambientLight:{color:"#ffffff"},areaLight:{intensity:240,color:"#ffffff"},sideSpot:{color:"#ffffff",angle:50},backSpot:{color:"#ffffff",angle:50}},i._ambientLight=new THREE.AmbientLight(new THREE.Color(i._params.ambientLight.color),.3),i._ambientLight.layers.set(1),i._sideSpot=i._createSpotlight(new THREE.Vector3(2,3,1.5),new THREE.Vector3(0,.1,0),new THREE.Color(i._params.sideSpot.color),i._params.sideSpot.angle,.5,.3),i._backspot=i._createSpotlight(new THREE.Vector3(1,3,-3),new THREE.Vector3(0,.1,0),new THREE.Color(i._params.backSpot.color),i._params.backSpot.angle,1,.3),i._areaLight=new THREE.RectAreaLight(new THREE.Color(i._params.areaLight.color),void 0,.8,.8),i._areaLight.castShadow=!0,i._areaLight.matrixAutoUpdate=!0,i._areaLight.intensity=i._params.areaLight.intensity/(i._areaLight.width*i._areaLight.height),i._areaLight.position.set(-3,4,4),i._areaLight.lookAt(new THREE.Vector3(0,0,0)),i._areaLight.visible=!0,i._areaLight.layers.set(1),i.addToScene(),i}return l(t,g),a(t,[{key:"_createSpotlight",value:function(e,t,n,i,o,a){var r=new THREE.SpotLight(n,a);return r.angle=i*Math.PI/180,r.penumbra=o,r.position.copy(e),r.target.position.set(t.x,t.y,t.z),r.shadow.camera.near=.1,r.shadow.camera.far=10,r.shadow.mapSize=new THREE.Vector2(1024,1024),r.visible=!0,r.castShadow=!1,r}},{key:"addToScene",value:function(){this._scene.add(this._ambientLight),this._scene.add(this._areaLight),this._scene.add(this._sideSpot),this._scene.add(this._backspot)}},{key:"removeFromScene",value:function(){this._scene.remove(this._ambientLight),this._scene.remove(this._areaLight),this._scene.remove(this._sideSpot),this._scene.remove(this._backspot)}},{key:"reload",value:function(){this.removeFromScene(),this.addToScene()}},{key:"showGUI",value:function(){var e=this,t=y();if(this._areaLight){var n=t.addFolder("Area Light");n.add(this._areaLight,"visible"),n.add(this._params.areaLight,"intensity").min(100).max(400).step(1).onChange(function(t){e._areaLight.intensity=t/(e._areaLight.width*e._areaLight.height)}),n.add(this._areaLight,"castShadow"),n.addColor(this._params.areaLight,"color").onChange(function(t){e._areaLight.color=new THREE.Color(t)}),n.add(this._areaLight.position,"x").min(-10).max(10).step(.1).onChange(function(){e._areaLight.lookAt(new THREE.Vector3(0,0,0))}),n.add(this._areaLight.position,"y").min(-10).max(10).step(.1).onChange(function(){e._areaLight.lookAt(new THREE.Vector3(0,0,0))}),n.add(this._areaLight.position,"z").min(-10).max(10).step(.1).onChange(function(){e._areaLight.lookAt(new THREE.Vector3(0,0,0))})}if(this._ambientLight){var i=t.addFolder("Ambient Light");i.add(this._ambientLight,"visible"),i.add(this._ambientLight,"intensity").min(0).max(5).step(.1),i.addColor(this._params.ambientLight,"color").onChange(function(t){e._ambientLight.color=new THREE.Color(t)})}if(this._sideSpot){var o=t.addFolder("Side Spot");o.add(this._sideSpot,"visible"),o.add(this._sideSpot,"intensity").min(0).max(5).step(.1),o.add(this._sideSpot,"penumbra").min(0).max(1).step(.1),o.addColor(this._params.sideSpot,"color").onChange(function(t){e._sideSpot.color=new THREE.Color(t)}),o.add(this._params.sideSpot,"angle").min(10).max(180).step(1).onChange(function(t){e._sideSpot.angle=t*Math.PI/180}),o.add(this._sideSpot.position,"x").min(-10).max(10).step(.1).onChange(function(){e._sideSpot.lookAt(new THREE.Vector3(0,0,0))}),o.add(this._sideSpot.position,"y").min(-10).max(10).step(.1).onChange(function(){e._sideSpot.lookAt(new THREE.Vector3(0,0,0))}),o.add(this._sideSpot.position,"z").min(-10).max(10).step(.1).onChange(function(){e._sideSpot.lookAt(new THREE.Vector3(0,0,0))})}if(this._backspot){var a=t.addFolder("Back Spot");a.add(this._backspot,"visible"),a.add(this._backspot,"intensity").min(0).max(5).step(.1),a.add(this._backspot,"penumbra").min(0).max(1).step(.1),a.addColor(this._params.backSpot,"color").onChange(function(t){e._backspot.color=new THREE.Color(t)}),a.add(this._params.backSpot,"angle").min(10).max(180).step(1).onChange(function(t){e._backspot.angle=t*Math.PI/180}),a.add(this._backspot.position,"x").min(-10).max(10).step(.1).onChange(function(){e._backspot.lookAt(new THREE.Vector3(0,0,0))}),a.add(this._backspot.position,"y").min(-10).max(10).step(.1).onChange(function(){e._backspot.lookAt(new THREE.Vector3(0,0,0))}),a.add(this._backspot.position,"z").min(-10).max(10).step(.1).onChange(function(){e._backspot.lookAt(new THREE.Vector3(0,0,0))})}}}]),t}(),me=function(){function e(t,n){o(this,e),this._scene=t,n&&(n.removeFromScene(),n.cleanUp())}return a(e,[{key:"updateCamera",value:function(e){}},{key:"reload",value:function(){this.removeFromScene(),this.addToScene()}},{key:"updateBounds",value:function(e){this._bounds=e}},{key:"cleanUp",value:function(){this._scene=null}}]),e}(),ve=function(e){function t(e,n){var i;return o(this,t),(i=r(this,s(t).call(this,e,n)))._gltfLoaderPromise=i._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader-js"}).then(function(){i._gltfLoader=new THREE.GLTFLoader}),i}return l(t,me),a(t,[{key:"needsBounds",value:function(){return!0}},{key:"needsCamera",value:function(){return!0}},{key:"updateBounds",value:function(e){if(h(s(t.prototype),"updateBounds",this).call(this,e),this._backgroundMesh){var n=Math.max(e.x,e.z)/6;n=Math.max(n,1),this._backgroundMesh.scale.copy(new THREE.Vector3(n,n,n))}}},{key:"updateCamera",value:function(e){if(this._backgroundMesh){var t=e.getWorldDirection(new THREE.Vector3);t.y=0,.01>t.lengthSq()&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.multiplyScalar(-1),t.normalize();var n=Math.asin(t.x);0>t.z&&(n=Math.PI-n),this._backgroundMesh.rotation.set(0,n,0)}}},{key:"addToScene",value:function(){this._scene&&this._backgroundMesh&&this._scene.add(this._backgroundMesh)}},{key:"removeFromScene",value:function(){this._scene&&this._backgroundMesh&&this._scene.remove(this._backgroundMesh)}},{key:"loadBackground",value:function(e,t){var n=this;this._backgroundMaterial=t,this._backgroundMaterial||(this._backgroundMaterial=new THREE.MeshBasicMaterial),this._gltfLoaderPromise.then(function(){n._gltfLoader.load(e,n._onBackgroundLoaded.bind(n),function(e){},function(e){console.error(e)})})}},{key:"_onBackgroundLoaded",value:function(e){this._scene&&(this._backgroundMaterial.vertexColors=THREE.VertexColors,e&&e.scene&&e.scene.children&&e.scene.children.length>0&&(e.scene.children[0].material=this._backgroundMaterial,e.scene.children[0].layers.set(2),e.scene.position.copy(new THREE.Vector3(0,0,0)),this._backgroundMesh=e.scene,this._backgroundMesh.layers.set(2),this._backgroundMesh.receiveShadow=!0,w(this._backgroundMesh,!0,!1),this.removeFromScene(),this.addToScene()))}},{key:"showGUI",value:function(){console.warn("gui not implemented for gltf environment")}}]),t}();n([i],ve.prototype,"_scriptLoader",void 0);var fe=100,ge=8,ye=function(e){function t(e,n,i){var a;o(this,t),(a=r(this,s(t).call(this,e,n)))._wallVertices=[],a._wallMeshes=[],a._size=ge,a._longestSide=2;var l=new THREE.PlaneGeometry(fe,fe,fe,fe),c=new THREE.MeshStandardMaterial({color:11184810,side:THREE.DoubleSide});a._floorMesh=new THREE.Mesh(l,c),a._floorMesh.name="floor",a._floorMesh.position.y=-.001,a._floorMesh.rotation.x=-Math.PI/2,a._floorMesh.layers.set(2),a._floorMesh.receiveShadow=!0,a._fog=i||!1;for(var h=0;4>h;h++){var d=new THREE.Mesh;d.layers.set(2),d.receiveShadow=!0,a._wallMeshes.push(d)}return a._updateWallVertices(),a._updateWalls(c),a._textureLoader=new THREE.TextureLoader,a.addToScene(),a}return l(t,me),a(t,[{key:"needsBounds",value:function(){return!0}},{key:"needsCamera",value:function(){return this._fog}},{key:"needsRotation",value:function(){return!1}},{key:"updateBounds",value:function(e){h(s(t.prototype),"updateBounds",this).call(this,e),this._longestSide=Math.max(e.x,e.z);var n=this._longestSide+5;ge>n?n=ge:n+=3-n%3,this._size=n,this._update()}},{key:"updateCamera",value:function(e){this._cameraDistance=e.position.distanceTo(new THREE.Vector3(0,0,0)),this._update()}},{key:"_update",value:function(){this._fog?this._updateFog():(this._updateWallVertices(),this._updateWalls(new THREE.MeshBasicMaterial({color:16777215})))}},{key:"_updateFog",value:function(){var e=this._longestSide/2;this._scene.fog=new THREE.Fog(16185078,this._cameraDistance+e+3,this._cameraDistance+e+3+1),this._scene.background=new THREE.Color(16185078)}},{key:"_updateFloor",value:function(){if(this._floorMaterial){var e=new THREE.PlaneGeometry(fe,fe,fe/this._width,fe/this._height);this._floorMesh.material=this._floorMaterial,this._floorMesh.geometry=e}else{var t=null,n=this._width/1e3,i=this._height/1e3;this._repeatable?(this._floorTexture.wrapS=THREE.RepeatWrapping,this._floorTexture.wrapT=THREE.RepeatWrapping,this._floorTexture.repeat.set(fe/n,fe/i),t=new THREE.PlaneGeometry(fe,fe,fe/n,fe/i)):t=new THREE.PlaneGeometry(fe,fe,1,1);var o=new THREE.MeshStandardMaterial({map:this._floorTexture,side:THREE.DoubleSide});this._floorMesh.material=o,this._floorMesh.geometry=t}}},{key:"_updateWallVertices",value:function(){this._wallVertices=[];var e=this._size/2;this._wallVertices.push(new THREE.Vector3(-e,0,-e)),this._wallVertices.push(new THREE.Vector3(-e,0,e)),this._wallVertices.push(new THREE.Vector3(e,0,e)),this._wallVertices.push(new THREE.Vector3(e,0,-e))}},{key:"_updateWalls",value:function(e){if(this._wallTexture)for(var t=0;t<this._wallMeshes.length;t++){var n=this._wallMeshes[t],i=this._wallVertices[t],o=this._wallVertices[(t+1)%this._wallVertices.length],a=new THREE.Geometry;a.vertices=[i,o,new THREE.Vector3(i.x,20,i.z),new THREE.Vector3(o.x,20,o.z)],a.faceVertexUvs=[[[new THREE.Vector2(i.x+i.z,20),new THREE.Vector2(o.x+o.z,o.y),new THREE.Vector2(i.x+i.z,i.y)],[new THREE.Vector2(o.x+o.z,o.y),new THREE.Vector2(i.x+i.z,20),new THREE.Vector2(o.x+o.z,20)]]],a.uvsNeedUpdate=!0,a.faces=[new THREE.Face3(2,1,0),new THREE.Face3(1,2,3)],a.computeFaceNormals(),a.computeVertexNormals(),n.material=e,n.geometry=a}}},{key:"addToScene",value:function(){var e=this;this._scene&&(this._scene.add(this._floorMesh),this._wallMeshes.forEach(function(t){e._scene.add(t)}))}},{key:"removeFromScene",value:function(){var e=this;this._scene.remove(this._floorMesh),this._wallMeshes.forEach(function(t){e._scene.remove(t)})}},{key:"_getWallPromise",value:function(){var e=this;return new Promise(function(t,n){e._wallTexture?t():e._textureLoader.load(_()+"static/textures/white_wall_texture.jpg",function(n){e._wallTexture=n,e._wallTexture.wrapS=THREE.RepeatWrapping,e._wallTexture.wrapT=THREE.RepeatWrapping,t()},null,n)})}},{key:"setFloorMaterial",value:function(e,t,n,i){var o=this;return this._width=t,this._height=n,this._repeatable=i,this._floorPromise=new Promise(function(t,n){o._textureLoader.load(e,function(e){o._floorTexture=e,t()},null,n)}),new Promise(function(e,t){Promise.all([o._floorPromise,o._getWallPromise()]).then(function(){o._updateFloor(),o._update(),e()},function(){return t()})})}},{key:"changeFloorMaterial",value:function(e,t){var n=this;this._floorPromise=new Promise(function(i,o){var a=E(e,n._environmentLoader.getEnvironmentMap());n._rapiAccess.getTexturesOf(e).then(function(e){if(e.length>0){var o=[];e.forEach(function(e){var i=0===e.mmWidth?1:e.mmWidth/1e3,r=0===e.mmHeight?1:e.mmHeight/1e3,s=fe/i,l=fe/r;o.push(k(n._dataSyncer.requestAsset(e.image,!0),e,a,t,s,l))}),Promise.all(o).then(function(){n._floorMaterial=a,setTimeout(function(){return i()},0)})}}),(!e.textures||e.textures&&0===e.textures.length)&&(n._floorMaterial=a,setTimeout(function(){return i()},0))});var i=[this._floorPromise];return this._fog||i.push(this._getWallPromise()),new Promise(function(e,t){Promise.all(i).then(function(){n._updateFloor(),n._update(),e()},function(){return t()})})}},{key:"showGUI",value:function(){var e=this;this._floorMaterial?this._addGUI():this._floorPromise&&this._floorPromise.then(function(){return e._addGUI()})}},{key:"_addGUI",value:function(){var e=y().addFolder("Floor");e.add(this._floorMaterial,"roughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"reflectivity").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoat").min(0).max(1).step(.01),e.add(this._floorMaterial,"clearCoatRoughness").min(0).max(1).step(.01),e.add(this._floorMaterial,"opacity").min(0).max(1).step(.01),e.add(this._floorMaterial,"metalness").min(0).max(1).step(.01),e.add(this._floorMaterial,"bumpScale").min(0).max(1).step(.01)}}]),t}();n([i],ye.prototype,"_rapiAccess",void 0),n([i],ye.prototype,"_dataSyncer",void 0),n([i],ye.prototype,"_environmentLoader",void 0);var be=20,we=function(e){function t(e,n,i,a,l){var c;return o(this,t),(c=r(this,s(t).call(this,e,n)))._color=i,c._oldBackground=e.background,c._shadowMaterial=new THREE.ShadowMaterial({color:1118481,opacity:.4}),c._generateShadowPlane(be),a&&(c._canvas=a,c.addBackground(a,l)),c.addToScene(),c}return l(t,me),a(t,[{key:"addBackground",value:function(e,t){var n=document.createElement("style"),i='background-image: url("'+t+'"); background-size: cover;';n.innerText=".rml-scene-background {"+i+"}",e.appendChild(n)}},{key:"_generateShadowPlane",value:function(e){var t=!1;this._shadowMesh&&(t=!0,this._scene.remove(this._shadowMesh)),this._shadowMesh=new THREE.Mesh(new THREE.PlaneGeometry(e,e),this._shadowMaterial),this._shadowMesh.name="floor",this._shadowMesh.position.y=-.001,this._shadowMesh.rotation.x=-Math.PI/2,this._shadowMesh.layers.set(2),this._shadowMesh.receiveShadow=!0,t&&this._scene.add(this._shadowMesh)}},{key:"needsBounds",value:function(){return!0}},{key:"needsCamera",value:function(){return!0}},{key:"addToScene",value:function(){this._scene&&(this._canvas?this._scene.background=null:this._scene.background=this._color,this._scene.add(this._shadowMesh),this._canvas&&this._canvas.classList.add("rml-scene-background"))}},{key:"removeFromScene",value:function(){this._scene.background=this._oldBackground,this._scene.remove(this._shadowMesh),this._canvas&&this._canvas.classList.remove("rml-scene-background")}},{key:"updateBounds",value:function(e){h(s(t.prototype),"updateBounds",this).call(this,e),this._generateShadowPlane(Math.max(e.x,e.z)+be)}},{key:"showGUI",value:function(){console.warn("gui not implemented for gltf environment")}}]),t}(),ke=function(){function e(){o(this,e)}return a(e,[{key:"parse",value:function(e,t,n,i){var o=JSON.parse(i);return o.environment?this.load(e,t,n,o):null}},{key:"load",value:function(e,t,n,i){var o,a=this,r=i.environment;switch(r.type){case"color":o=new Promise(function(t){return t(new we(e,n,new THREE.Color(r.details.color)))});break;case"image":o=new Promise(function(i){return i(new we(e,n,null,t,r.details.imageUrl))});break;case"gltf":o=new Promise(function(t){var i=new ve(e,n);i.loadBackground(_()+"static/geometry/PhotoStudioRoom.glb"),t(i)});break;case"floor":o=new Promise(function(t){a._rapiAccess.getMaterial(r.details.material).then(function(i){var o=void 0===r.details.fog||r.details.fog,a=new ye(e,n,o);a.changeFloorMaterial(i).then(function(){t(a)})})});break;default:console.warn("Could not load environment, return old environment"),o=new Promise(function(e){return e(n)})}return o}}]),e}();n([i],ke.prototype,"_rapiAccess",void 0);var Ee=null,Ce=null,He=function(){function e(t){var n=this;o(this,e),this._forceRender=!1,this.waitingForMaterials=[],this._maxAnisotrophy=1,this._devicePixelRatio=1,this._clock=new THREE.Clock,this._delta=0,this._shadowDirty=!1,this._components=new Map,this._previews=new Map,this._materialCache=new Map,this._previewMaterial=new THREE.MeshStandardMaterial({color:P,transparent:!0,opacity:T}),this._lastChange=Date.now(),this._running=!1,this._devicePixelRatio=window.devicePixelRatio&&window.__RML__ENV__.initData.retina?window.devicePixelRatio:window.__RML__ENV__.initData.enableHD?1:window.devicePixelRatio,this._setupScene(t);var i=window.__RML__ENV__.initData,a=i.plusInPreview,r=i.addOnSpots;(a||r)&&(this._addonHelper=new ce(this._camera,this._scriptLoader),r&&(this._addonHelper.onAddonClick(function(){n._webGl.openAddOns()}),this._addonHelper.addOnSpotsEnabled=r),this._addonHelper.previewGhostEnabled=a),this._cameraControl=new C(this._configuratorInputManager,this._domHelper.element,null,this._camera),this._sceneEventHandler=new de(this._scene,this._camera,this._configuratorInputManager,this._addonHelper),this._sceneEventHandler.addEventListener(0,function(){n._uiIntersectionHelper.calculateUIIntersection(),n._addonHelper&&n._addonHelper.setState(0),n._requestRender()},this),this._sceneEventHandler.addEventListener(1,function(e){var t=e.component,i=e.type;return n._onHoverOn(t,i)},this),this._sceneEventHandler.addEventListener(2,function(e){var t=e.type;return n._onHoverOff(t)},this),this._sceneEventHandler.addEventListener(3,function(){n._webGl.clickOutside(),n._dimensionHelper.disableDimensions(),n._cameraControl.unlock(),n._cancelDockings(!1,null,n._previews.size>0,!0),n.cancelSelection(!0),n._requestRender()},this),this._sceneEventHandler.addEventListener(7,function(e){var t=e.component;n._previews.size>0&&n._cancelDockings(!1,null,n._previews.size>0,!0),n._selectComponent(t),n._webGl.context.selectedRuntimeComponentIds=n._sceneEventHandler.getSelectedRuntimeComponentIds(),"standard"===n._sceneEventHandler.getSelectionMode()?n._webGl.onSelectedRuntimeComponentChange(t):n._webGl.onSelectedRuntimeComponentsChange(n._sceneEventHandler.getSelectedRuntimeComponentIds()),n._requestRender()},this),this._sceneEventHandler.addEventListener(8,function(e){var t=e.resetCamera;n._deselectComponent(t),n._requestRender()},this),this._sceneEventHandler.addEventListener(4,function(e){var t=e.component;"multiselect"===n._sceneEventHandler.getSelectionMode()&&n.cancelSelection(),n._webGl.requestDockingsPreviewWithDrag(t.roomleId),n._cameraControl.lock(),n._requestRender()},this),this._sceneEventHandler.addEventListener(5,function(e){var t=e.component,i=e.preview;if(i){var o=i;if(n._componentFactory.isPreviewLine(o)){var a=n._components.get(o.parentId);n._webGl.dockComponentWithPosition(o,t.getKernelPosition(a))}else n._componentFactory.isPreview(o)&&n._webGl.dockComponent(o);n._cancelDockings(!i,t,!0,!0)}else{var r=n._sceneEventHandler.isDragIn()?t:null;n._cancelDockings(n._sceneEventHandler.isDragIn(),r,!1,!0)}n._cameraControl.unlock(),n._requestRender(!0)},this),this._sceneEventHandler.addEventListener(6,function(e){var t=e.preview;if(n._componentFactory.isPreview(t)){if(n._componentFactory.isPreviewLine(t)){var i=n._components.get(t.parentId);n._webGl.dockComponentWithPosition(t,t.getKernelPosition(i))}else n._webGl.dockComponent(t);n._cancelDockings(!1,null,0===n._previews.size,!1),n._webGl.requestDockingsPreview(!1),n._requestRender()}},this),this._cameraControl.addEventListener(0,function(){n._addonHelper&&n._addonHelper.setState(1),n._requestRender()},this),this._cameraControl.addEventListener(1,function(){n._requestRender()},this),this._cameraControl.addEventListener(2,function(){n._addonHelper&&n._addonHelper.setState(2),n._requestRender()},this),this._cameraControl.addEventListener(5,function(e){var t=e.minZoom,i=e.maxZoom;n._webGl.onZoomChanged(t,i)},this),q.isProduction||(window.__RML__DEBUG__.SceneHelper=this)}return a(e,[{key:"stopRenderLoop",value:function(){this._running=!1}},{key:"_onHoverOn",value:function(e,t){2!==t&&this._highlight(e),this._dimensionHelper.onHover(2===t)}},{key:"_onHoverOff",value:function(e){2!==e&&this._highlight(null),this._dimensionHelper.disableDimensions()}},{key:"_highlight",value:function(e){var t=this,n=window.__RML__ENV__.initData.meshSelection,i=[];this._outlinePass.selectedObjects.forEach(function(e){e.visible=!0}),e&&(n?i.push.apply(i,d(e.meshes)):e.boundingBoxMesh&&i.push(e.boundingBoxMesh)),this._sceneEventHandler.getSelectedRuntimeComponentIds().forEach(function(e){var o=t._components.get(e);o&&(n?i.push.apply(i,d(o.meshes)):o.boundingBoxMesh&&i.push(o.boundingBoxMesh))}),this._pixotron?(this._pixotron.getHighLightPass()&&!this._pixotron.getHighLightPass().set&&(this._outlinePass=this._pixotron.getHighLightPass(),this._pixotron.getHighLightPass().visibleEdgeColor=new THREE.Color(H().SELECTION),this._pixotron.getHighLightPass().hiddenEdgeColor=new THREE.Color(H().SELECTION),this._pixotron.getHighLightPass().edgeStrength=3,this._pixotron.getHighLightPass().edgeThickness=1,this._pixotron.getHighLightPass().edgeGlow=0,this._pixotron.getHighLightPass().set=!0),this._pixotron.highlightObjects(i)):this._outlinePass.selectedObjects=i}},{key:"_requestRender",value:function(e){var t=this;if(this._pixotron&&(this._pixotron.needsUpdate=!0,e&&(this._forceRender=!0)),this._lastChange=Date.now(),!this._running){if(this._running=!0,this._addonHelper&&!this._addonHelper.isAddOnSpotVisible()){var n=this._previews.size>0?5:3;this._addonHelper.setState(n)}requestAnimationFrame(function e(){if(t._delta=t._clock.getDelta(),t._animateCamera(),t._camera.layers.mask=65535,t._statsHelper&&t._statsHelper.update(t._renderer.info),t._pixotron){t._forceRender&&(t._pixotron.autoShadowsClear=!0,t._pixotron.autoSAOClear=!0),t._checkLayers(),t._pixotron.render(t._renderer,t._scene,t._camera,t._renderTarget),t._forceRender=!1,t._pixotron.blit(),t._renderer.clearDepth();var n=t._renderer.autoClear;t._renderer.autoClear=!1,t._renderer.render(t._uiScene,t._camera),t._renderer.autoClear=n}else t._renderer.clear(),t._checkLayers(),t._composer.render(),t._renderer.clearDepth(),t._renderer.render(t._uiScene,t._camera),t._renderer.clearDepth();t._addonHelper&&t._addonHelper.update(),window.TWEEN&&TWEEN.update(),t._addonHelper&&t._lastChange+1500<Date.now()&&t._addonHelper.isAddOnSpotVisible()&&t._addonHelper.setState(4),t._lastChange+3e3<Date.now()?t._running=!1:(t._running=!0,requestAnimationFrame(e)),t._shadowDirty&&!t._pixotron&&t._updateShadow()})}}},{key:"_checkLayers",value:function(){this._dimensionHelper.areDimensionsEnabled()&&!this._sceneEventHandler.hasSelection()&&0===this._previews.size&&"multiselect"!==this._sceneEventHandler.getSelectionMode()||this._dimensionHelper.forceDimensions?(this._dimensionHelper.update(),this._camera.layers.enable(6),this._camera.layers.disable(5)):(this._camera.layers.disable(6),this._camera.layers.enable(5)),this._addonHelper&&this._addonHelper.isAddOnSpotVisible()?(this._camera.layers.enable(7),this._eventHandler.dispatch(76)):(this._camera.layers.disable(7),this._eventHandler.dispatch(77))}},{key:"_animateCamera",value:function(){this._cameraControl&&(this._cameraControl.animateCamera(this._delta)?(this._lightSetting instanceof _e&&this._lightSetting.update(this._camera,this._cameraControl.getTargetPosition()),this._pixotron&&(this._pixotron.needsUpdate=!0),this._dimensionHelper.forceDimensions=!1):!this._pixotron||this._sceneEventHandler.isDragging()||this._forceRender||(this._pixotron.autoShadowsClear=!1,this._pixotron.autoSAOClear=!1)),this._environment.needsCamera()&&this._environment.updateCamera(this._camera)}},{key:"_cancelDockings",value:function(e,t,n,i){e&&(this._sceneEventHandler.setDragIn(!1),this._removeComponent(t)),this._removePreviews(n),i&&this._webGl.onRemovePreviews(n),this._addonHelper&&this._addonHelper.setState(3)}},{key:"_removePreviews",value:function(e){this._previews.size>0&&(this._previews.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._previews.clear(),e&&this._cameraControl.updateToBounds(this._webGl.context.planObjectBounds,this._renderer.getSize().width,this._renderer.getSize().height,!0))}},{key:"_setupScene",value:function(e){var t=this,n=this._domHelper.getClientDimensions(),i=n.x,o=n.y;this._scene=new THREE.Scene,this._scene.background=new THREE.Color(H().DEFAULT_BACKGROUND),this._uiScene=new THREE.Scene,this._componentFactory=z(),this._camera=this._componentFactory.createCamera(30,i/o,.1,20,this._domHelper.element,e),this._camera.position.copy(new THREE.Vector3(0,.5,5)),this._dimensionHelper=new ae(this._camera,this._unitFormatter),this._uiIntersectionHelper=new ue(this._camera),this._uiIntersectionHelper.canvasOffset=e,this._uiIntersectionHelper.addEventListener(0,function(e){t._webGl.onUiIntersectionChange(e)},this),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4),this._shadowRenderer=new THREE.WebGLRenderer;var a={format:THREE.RGBAFormat,minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter};this._renderTarget=new THREE.WebGLRenderTarget(i*this._devicePixelRatio,o*this._devicePixelRatio,a),this._renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this._renderer.setPixelRatio(this._devicePixelRatio),this._renderer.setSize(i,o),this._renderer.gammaOutput=!0,this._renderer.gammaInput=!0,this._renderer.autoClear=!1,this._renderer.shadowMap.enabled=!0,this._renderer.shadowMap.type=THREE.BasicShadowMap,this._maxAnisotrophy=this._renderer.capabilities.getMaxAnisotropy(),this._renderer.domElement.classList.add(S.HSC),this._domHelper.element.appendChild(this._renderer.domElement),this._configuratorInputManager.addEvents(this._renderer.domElement),this._lightSetting=new J(this._scene),(new THREE.TextureLoader).setPath(_());var r=new THREE.CubeTextureLoader;r.setPath(_()),this._texture=r.load(["static/textures/blurred/px.png","static/textures/blurred/nx.png","static/textures/blurred/py.png","static/textures/blurred/ny.png","static/textures/blurred/pz.png","static/textures/blurred/nz.png"]),this._texture.wrapS=THREE.RepeatWrapping,this._texture.wrapT=THREE.RepeatWrapping,this._texture.generateMipmaps=!0,this._composer=new THREE.EffectComposer(this._renderer);var s=new THREE.RenderPass(this._scene,this._camera,null,new THREE.Color(H().DEFAULT_BACKGROUND),0);this._composer.addPass(s),this._outlinePass=new THREE.OutlinePass(new THREE.Vector2(window.innerWidth,window.innerHeight),this._scene,this._camera),this._outlinePass.renderToScreen=!0,this._outlinePass.visibleEdgeColor=new THREE.Color(H().SELECTION),this._outlinePass.hiddenEdgeColor=new THREE.Color(H().SELECTION),this._outlinePass.edgeStrength=3,this._outlinePass.edgeThickness=1,this._outlinePass.edgeGlow=0,this._composer.addPass(this._outlinePass),this._composer.setSize(i,o),this._requestRender(),Ee=this._onWindowResize.bind(this),Ce=this._onKeyDown.bind(this),window.addEventListener("resize",Ee,!1),window.addEventListener("keydown",Ce,!1),document.addEventListener("visibilitychange",this._tabVisible.bind(this)),this._environment=new ve(this._scene),window.__RML__ENV__.initData.enableHD||this._environment.loadBackground(_()+"static/geometry/PhotoStudioRoom.glb")}},{key:"_tabVisible",value:function(){this._requestRender(!0)}},{key:"addMesh",value:function(e,t,n,i,o,a,r,s){var l=this._components.get(e);if(l||(l=this._previews.get(e.toString()))){var c=this._configuratorMeshGenerator.generateMesh(t,o,a,r,s);l.addMesh(c,i),this._componentFactory.isPreview(l)?(c.layers.set(4),l.changeMaterialOfMesh(c.id,this._previewMaterial.clone())):(c.layers.set(3),this.waitingForMaterials.push(this._assignMaterial(l,c.id,n)))}}},{key:"addComponent",value:function(e,t,n,i,o){var a=null;this._components.has(e)?(a=this._components.get(e)).removeAllMeshes():(o&&this._components.size>0&&console.error("something is wrong, try creating new root component while "+this._components.size+" currently exists"),(a=this._componentFactory.create(e,t,n,i)).layers.set(3)),this._components.set(e,a),o&&(a.roomlePosition=t,this._sceneEventHandler.setRootComponentId(e),this._display(a))}},{key:"addPreview",value:function(e,t){var n=this._componentFactory.createPreview(t,e);this._previews.set(t.toString(),n)}},{key:"setPreviewAssociations",value:function(e,t){var n=this._previews.get(e.toString());if(n)for(var i=this._components.get(this._webGl.context.rootComponentId),o=0;o<t.length;o++){var a=void 0;0===o?a=n:(a=n.clonePreview(o),this._previews.set(a.stringId,a)),a.parentDockId=t[o].parentDockId,a.parentId=t[o].parentId,a.childDockId=t[o].childDockId,a.childId=t[o].childId,a.preparePreview(),a.receivedPointAssociation=!0,i.add(a),a.roomlePosition=t[o].position,a.roomleRotation=t[o].rotation}}},{key:"setPreviewLineAssociations",value:function(e,t){var n=this._previews.get(e.toString());if(n)for(var i=this._componentFactory.createPreviewLine(n),o=this._components.get(this._webGl.context.rootComponentId),a=0;a<t.length;a++){var r=void 0;(r=0===a?i:i.clonePreviewLine(a)).parentDockId=t[a].parentDockId,r.parentId=t[a].parentId,r.childDockId=t[a].childDockId,r.childId=t[a].childId,r.roomleRotation=t[a].rotation,r.roomlePosition=t[a].position,t[a].lineFrom.x>t[a].lineTo.x||t[a].lineFrom.y>t[a].lineTo.y||t[a].lineFrom.z>t[a].lineTo.z?(r.roomleLineFrom=t[a].lineTo,r.roomleLineTo=t[a].lineFrom):(r.roomleLineFrom=t[a].lineFrom,r.roomleLineTo=t[a].lineTo),t[a].positionFrom.x>t[a].positionTo.x||t[a].positionFrom.y>t[a].positionTo.y||t[a].positionFrom.z>t[a].positionTo.z?(r.roomlePositionFrom=t[a].positionTo,r.roomlePositionTo=t[a].positionFrom):(r.roomlePositionFrom=t[a].positionFrom,r.roomlePositionTo=t[a].positionTo),o.add(r),r.preparePreview(),this._previews.set(r.stringId,r)}}},{key:"updateComponent",value:function(e,t){var n=this._components.get(e);if(n||(n=this._previews.get(e.toString()))){if(e===this._webGl.context.rootComponentId){var i=new THREE.Vector3(t.position.x/1e3,t.position.z/1e3,t.position.y/-1e3);this._sceneEventHandler.update(null,i,null)}if(n.roomlePosition=t.position,n.roomleRotation=t.rotation,t.boxForMeasurement&&n.computeBoundingBox(t.boxForMeasurement),this._addonHelper&&n&&t.addOnSpots){var o=this._components.get(this._webGl.context.rootComponentId);this._addonHelper.addAddOnSpots(o,n,t.addOnSpots)}this._requestRender(!0)}}},{key:"deleteComponent",value:function(e){var t=this._components.get(e);t&&(this._addonHelper&&this._addonHelper.deleteAddonPointsForComponent(t.roomleId),t.removeFromParent(),t.removeAllMeshes(),this._components.delete(e),-1===this._sceneEventHandler.getSelectedRuntimeComponentIds().indexOf(e)&&"multiselect"!==this._sceneEventHandler.getSelectionMode()||this.cancelSelection())}},{key:"sceneCleared",value:function(){this._internalClearScene()}},{key:"componentConstructionBegin",value:function(e){var t=this._components.get(e);t&&t.removeAllMeshes()}},{key:"componentConstructionDone",value:function(e,t){var n=this._components.get(e);n&&(n.computeBoundingBox(t.boxForMeasurement),n.boundingBoxMesh&&this._sceneEventHandler.addComponentHandlers(n));var i=this._previews.get(e.toString());i&&i.computeBoundingBox(t.boxForMeasurement,!0)}},{key:"configurationLoaded",value:function(e,t,n){this._environment&&this._environment.reload();var i=this._components.get(t);i&&(i.computeBoundingBox(n.boxForMeasurement),i.boundingBoxMesh&&t!==this._webGl.context.rootComponentId&&this._components.get(this._webGl.context.rootComponentId)&&!this._components.get(this._webGl.context.rootComponentId).isChild(t)&&(this._scene.add(i),this._requestRender(),i.position.copy(new THREE.Vector3(0,0,-100)),this._sceneEventHandler.addComponentDragInHandler(i)))}},{key:"componentGeometryNotReady",value:function(e){this._components.has(e)&&this._components.get(e).loading()}},{key:"_display",value:function(e){this._scene.add(e),this._requestRender()}},{key:"_removeComponent",value:function(e){this._webGl.context.lastConfigurationLoadedComponentId!==this._webGl.context.rootComponentId&&this._webGl.requestDeleteComponent(),e&&(this._scene.remove(e),this._components.delete(e.roomleId),e.removeAllMeshes())}},{key:"debugSceneGraph",value:function(e){e?this._components.has(e)?this._components.get(e):this._previews.has(e.toString())&&this._previews.get(e.toString()):(this._webGl.context,this._printObjectGraph(this._scene,""))}},{key:"debugScene",value:function(){return this._scene}},{key:"_printObjectGraph",value:function(e,t){var n=this;e.type,e.id,e.roomleId,e.children.length>0&&e.children.forEach(function(e){var i=t+"    ";n._printObjectGraph(e,i)})}},{key:"dockComponent",value:function(e,t,n,i){var o=this._components.get(t),a=this._components.get(e);a&&(a.roomlePosition=n,a.roomleRotation=i,o&&o.add(a))}},{key:"_assignMaterial",value:function(e,t,n){var i=this;return new Promise(function(o,a){return""===n?(console.error($),void i._errorHandler.softReject(function(){return o()},$,2)):i._materialCache.has(n)?(e.changeMaterialOfMesh(t,i._materialCache.get(n)),i._requestRender(),void o()):void i._webGl.requestMaterial(n).then(function(a){var r=E(a,i._texture);i._webGl.requestTextures(a).then(function(a){if(a.length>0){var s=[];a.forEach(function(e){s.push(k(i._dataSyncer.requestAsset(e.image,!0),e,r,i._maxAnisotrophy,1/(0===e.mmWidth?1:e.mmWidth),1/(0===e.mmHeight?1:e.mmHeight)))}),Promise.all(s).then(function(){i._materialCache.set(n,r),e.changeMaterialOfMesh(t,r),i._requestRender(),setTimeout(function(){return o()},0)})}}),(!a.textures||a.textures&&0===a.textures.length)&&(i._materialCache.set(n,r),e.changeMaterialOfMesh(t,r),setTimeout(function(){return o()},0)),i._requestRender()},a)})}},{key:"clearScene",value:function(){this._internalClearScene()}},{key:"planObjectUpdate",value:function(e,t){if(this._webGl.context.planObjectId===e.id){var n=new THREE.Vector3(e.bounds.x/1e3,e.bounds.z/1e3,e.bounds.y/1e3);this._planObjectBounds=n,this._shadowDirty=!0,t&&(this._webGl.context.planObjectBounds=n,0!==this._previews.size||this._sceneEventHandler.hasSelection()||this._cameraControl.updateToBounds(this._webGl.context.planObjectBounds,this._renderer.getSize().width,this._renderer.getSize().height,!1,!1),this._dimensionHelper.updateBounds(e.boxForMeasurement),this._sceneEventHandler.update(n,null,null),this._uiIntersectionHelper.updateToBounds(n,this._domHelper.element.clientWidth,this._domHelper.element.clientHeight),this._environment.needsBounds()&&this._environment.updateBounds(n),this._camera.updateProjectionMatrix())}this._requestRender()}},{key:"planObjectConstructionDone",value:function(e){var t=this;this._dimensionHelper.onLoaded(function(){t._dimensionHelper.addToScene(t._scene,t._uiScene)}),this._dimensionHelper.onDimensionsVisibilityChanged(function(e){e&&t._requestRender(!0),t._webGl.onDimensionsVisibilityChange(e)})}},{key:"_internalClearScene",value:function(){var e=this;this._scene.children.forEach(function(t){"Object3D"!==t.type&&"Mesh"!==t.type&&"Line"!==t.type||e._scene.remove(t)}),this._uiScene.children.forEach(function(t){e._uiScene.remove(t)}),this._components.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._components.clear(),this._previews.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._previews.clear(),this._shadow&&(this._scene.remove(this._shadow),this._shadow=null),this._memoryManager.shouldHardReset()&&(this._dimensionHelper.clear(),this._dimensionHelper=new ae(this._camera,this._unitFormatter),this._configuratorMeshGenerator.clear(),this._materialCache.forEach(function(e){return e.dispose()}),this._materialCache.clear(),this._renderer.renderLists.dispose(),this._memoryManager.executedHardReset()),this._dimensionHelper.disableDimensions(),this._requestRender(!0)}},{key:"_updateShadow",value:function(){THREE.DepthShadowGenerator&&(this._shadow&&this._scene.remove(this._shadow),this._shadow=THREE.DepthShadowGenerator.createShadowPlane(this._shadowRenderer,this._scene,this._planObjectBounds,3),this._shadow.layers.set(2),this._scene.add(this._shadow),this._shadowDirty=!1,this._requestRender())}},{key:"previewConstructionDone",value:function(e,t){var n=this,i=!1;this._previews.forEach(function(e){null!==e.parent&&(n._componentFactory.isPreviewLine(e)?n._sceneEventHandler.addPreviewLineHandlers(e):n._sceneEventHandler.addPreviewHandlers(e),i=!0)}),i||(this._cancelDockings(!0,null,!1,!1),this._webGl.context.requestPreviewsIsUserInitiated&&this._webGl.notifyNoPreviews());var o=this._calculateBoundingBoxOfAllMeshes(this._components.get(this._webGl.context.rootComponentId));this._cameraControl.updateToBounds(o.bounds,this._renderer.getSize().width,this._renderer.getSize().height,!0),this._environment&&this._environment.needsBounds()&&this._environment.updateBounds(o.bounds)}},{key:"preparePerspectiveImage",value:function(){var e=this;return new Promise(function(t,n){var i=new THREE.WebGLRenderer({antialias:!0,alpha:!0});i.setPixelRatio(e._devicePixelRatio),i.setSize(1024,1024),i.gammaInput=!0,i.gammaOutput=!0,Promise.all(e.waitingForMaterials).then(function(){e._cancelDockings(!0,null,!0,!1),e._clearSelectionAndHovers();var n=e._camera.clone(),o=e._scene.fog?e._scene.fog.clone():null,a=e._scene.background?e._scene.background.clone():null;e._scene.background=null,e._scene.fog=null,e._lightSetting.removeFromScene();var r=new J(e._scene);n.layers.disable(2),n.layers.disable(5),e._placeCameraForPerspectiveImage(n,-20,-30),i.render(e._scene,n);var s=i.domElement.toDataURL();n.layers.enable(2),e._scene.background=a,e._scene.fog=o,r.removeFromScene(),e._lightSetting.addToScene(),e._requestRender(),e.waitingForMaterials=[],t({image:s,width:1024,height:1024,blob:null})},n)})}},{key:"_placeCameraForPerspectiveImage",value:function(e,t,n){var i=this._calculateBoundingBoxOfAllMeshes(this._components.get(this._webGl.context.rootComponentId));e.far=1e3,e.fov=15,e.aspect=1,e.position.copy(i.center),e.rotation.set(0,0,0),e.rotateY(x(n)),e.rotateX(x(t)),e.translateZ(3.8*i.diagonal),e.updateProjectionMatrix()}},{key:"_calculateBoundingBoxOfAllMeshes",value:function(e){var t=e.recursiveMeshes(),n=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY;t.forEach(function(e){e.parent.getWorldPosition(new THREE.Vector3),e.geometry.computeBoundingBox();var t=e.geometry.boundingBox.clone();t.translate(e.getWorldPosition(new THREE.Vector3)),n=Math.min(n,t.min.x),i=Math.min(i,t.min.y),o=Math.min(o,t.min.z),a=Math.max(a,t.max.x),r=Math.max(r,t.max.y),s=Math.max(s,t.max.z)});var l=new THREE.Box3(new THREE.Vector3(n,i,o),new THREE.Vector3(a,r,s)),c=l.getSize(new THREE.Vector3);return{center:l.getCenter(new THREE.Vector3),bounds:c,diagonal:Math.sqrt(Math.pow(c.x,2)+Math.pow(c.y,2)+Math.pow(c.z,2))}}},{key:"prepareTopImage",value:function(){var e=this;return new Promise(function(t,n){var i=new THREE.WebGLRenderer({antialias:!0,alpha:!0});i.gammaInput=!0,i.gammaOutput=!0,Promise.all(e.waitingForMaterials).then(function(){e._cancelDockings(!0,null,!0,!1),e._clearSelectionAndHovers();var n=e._calculateBoundingBoxOfAllMeshes(e._components.get(e._webGl.context.rootComponentId)),o=new THREE.OrthographicCamera(-n.bounds.x/2,n.bounds.x/2,n.bounds.z/2,-n.bounds.z/2,.5);o.position.copy(n.center),o.rotateX(x(-90)),o.translateZ(n.bounds.y+1),o.far=o.position.y+.5,o.layers.mask=65535;var a=200*n.bounds.x,r=200*n.bounds.z;if(a>4096||r>4096){var s=0;a>4096?s=a/4096:r>4096&&(s=r/4096),a/=s,r/=s}i.setPixelRatio(e._devicePixelRatio),i.setSize(a,r);var l=e._scene.fog?e._scene.fog.clone():null,c=e._scene.background?e._scene.background.clone():null;e._scene.background=null,e._scene.fog=null,e._lightSetting.removeFromScene();var h=new J(e._scene);o.layers.disable(2),o.layers.disable(5),i.render(e._scene,o);var d=i.domElement.toDataURL();o.layers.enable(2),o.layers.enable(5),e._scene.background=c,e._scene.fog=l,h.removeFromScene(),e._lightSetting.addToScene(),e._requestRender(),t({image:d,width:a,height:r,blob:null})})})}},{key:"enableDragIn",value:function(e){this._sceneEventHandler.setDragIn(!0,e),this._requestRender()}},{key:"_getYRotationOfObject",value:function(e){var t=e.getWorldDirection(new THREE.Vector3).clone();t.y=0,.01>t.lengthSq()&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.normalize();var n=Math.asin(t.x);return 0>t.z&&(n=Math.PI-n),0>n&&(n+=2*Math.PI),n}},{key:"zoomToComponent",value:function(e){this._cameraControl.saveState(!1);var t=e.boundingBox.getSize(new THREE.Vector3),n=this._getYRotationOfObject(e),i=new THREE.Euler(0,n,0),o=e.getWorldPosition(new THREE.Vector3).clone().add(e.boundingBox.getCenter(new THREE.Vector3).applyEuler(i));this._cameraControl.zoomTo(t,this._renderer.getSize().width,this._renderer.getSize().height,i.y,x(15),o)}},{key:"resetCamera",value:function(){this._cameraControl.hasSavedState()?this.resetCameraToState():this.resetCameraPositionToStart()}},{key:"resetCameraToState",value:function(){this._cameraControl.resetToState()}},{key:"resetCameraPositionToStart",value:function(){this._requestRender(),this._cameraControl.reset(this._webGl.context.planObjectBounds,this._renderer.getSize().width,this._renderer.getSize().height)}},{key:"_clearSelectionAndHovers",value:function(){this.cancelSelection(),this._components.get(this._webGl.context.rootComponentId).clear(!0)}},{key:"resetPreviews",value:function(){this._previews.forEach(function(e){return e.removeFromParent()}),this._previews.clear(),this._addonHelper&&this._addonHelper.setState(5),this._requestRender()}},{key:"changeOffset",value:function(e){this._camera.offset=e}},{key:"_onWindowResize",value:function(){this.updateSize()}},{key:"updateSize",value:function(){var e=this._domHelper.getClientDimensions(),t=e.x,n=e.y;this._renderer.setSize(t,n),this._camera.aspect=t/n,this._camera.updateProjectionMatrix(),this._webGl.context.planObjectBounds&&this._cameraControl.updateToBounds(this._webGl.context.planObjectBounds,t,n,!1),this._pixotron&&(this._pixotron.autoShadowsClear=!0,this._pixotron.autoSAOClear=!0,this._forceRender=!0,this._pixotron.setSize(t,n)),this._requestRender(!0)}},{key:"_onKeyDown",value:function(e){(e.key&&("Escape"===e.key||"Esc"===e.key)||27===e.keyCode)&&(this.cancelSelection(),e.preventDefault()),this._sceneEventHandler&&this._sceneEventHandler.hasSelection()&&(e.key&&("Backspace"===e.key||"Delete"===e.key)||8===e.keyCode||46===e.keyCode)&&(this._webGl.requestDeleteSelectedComponent(),e.preventDefault())}},{key:"cancelPreviousDockings",value:function(){this._cancelDockings(!0,null,!1,!1)}},{key:"cancelSelection",value:function(e){(this._sceneEventHandler.hasSelection()||"standard"!==this._sceneEventHandler.getSelectionMode())&&this._cancelSelection(e)}},{key:"_cancelSelection",value:function(e){this._sceneEventHandler.cancelSelection(),this._webGl.context.selectionMode="standard",this._webGl.context.selectedRuntimeComponentIds=[],this._removePreviews(!1),e&&this.resetCamera(),this._webGl.sendCancelSelectionEvent()}},{key:"_selectComponent",value:function(e){this._highlight(e)}},{key:"_deselectComponent",value:function(e){"standard"===this._sceneEventHandler.getSelectionMode()&&(this._cancelSelection(e),this._highlight(null)),"multiselect"===this._sceneEventHandler.getSelectionMode()&&(this._sceneEventHandler.hasSelection()?this._webGl.context.selectedRuntimeComponentIds=this._sceneEventHandler.getSelectedRuntimeComponentIds():(this._cancelSelection(e),this._highlight(null)))}},{key:"getScreenXY",value:function(e){return f(e,this._camera,this._domHelper.element.clientWidth,this._domHelper.element.clientHeight)}},{key:"cleanUp",value:function(){window.removeEventListener("resize",Ee,!1),window.removeEventListener("keydown",Ce,!1),this.stopRenderLoop()}},{key:"setSelectionMode",value:function(e){this._sceneEventHandler.setSelectionMode(e)}},{key:"setFloorMaterial",value:function(e,t,n,i){var o=this;return this._environment&&this._environment instanceof ye||(this._environment=new ye(this._scene,this._environment,!0),this._uiIntersectionHelper.floorEnvironment=!0),new Promise(function(a,r){o._environment.setFloorMaterial(e,t,n,i).then(function(){o._requestRender(),a()},r)})}},{key:"changeFloorMaterial",value:function(e){var t=this;return this._environment&&this._environment instanceof ye||(this._environment=new ye(this._scene,this._environment,!0),this._uiIntersectionHelper.floorEnvironment=!0),new Promise(function(n,i){t._environment.changeFloorMaterial(e,t._maxAnisotrophy).then(function(){t._requestRender(),n()},i)})}},{key:"enableHD",value:function(e){e?this.loadDynamicLightSetting(e):this._lightSetting=new pe(this._scene,this._lightSetting),this._environment instanceof ve&&(this._environment.removeFromScene(),this._environment.loadBackground(_()+"static/geometry/PhotoStudioRoom.glb",new THREE.MeshStandardMaterial)),this._renderer.toneMapping=THREE.Uncharted2ToneMapping,this._renderer.toneMappingWhitePoint=6,this._renderer.toneMappingExposure=3;var t={saoparams:{intensity:.25,occlusionWorldRadius:1,smoothTransition:!0,samplesPerFrame:4,bias:.005,numSamples:200,accumulative:!0},shadowparams:{shadowMapResolution:1024,shadowRadius:1,shadowQuality:1,smoothTransition:!0,enableAccumulation:!0,shadowBiasMultiplier:.6,nearPlane:.1,farPlane:20,fov:110,numSamples:50,side:THREE.FrontSide}};this._pixotron=new window.PIXOTRON.Pixotron(t),this._requestRender()}},{key:"disableHD",value:function(){this._pixotron=null,this._lightSetting=new J(this._scene,this._lightSetting)}},{key:"loadDynamicLightSetting",value:function(e){return this._lightSetting=new _e(this._scene,this._lightSetting),e.url?this._lightSetting.loadFromURL(e.url):e.json?this._lightSetting.loadFromJSON(e.json):e.object?this._lightSetting.loadFromObject(e.object):new Promise(function(e,t){t("No dynamic light setting source set")})}},{key:"exportGLB",value:function(){var e=this;this._scriptLoader.fetch("static/three/lib/exporters/GLTFExporter.js",{id:"gltf-exporter"}).then(function(){var t=new THREE.GLTFExporter,n=[];e._scene.children.forEach(function(e){"Object3D"!==e.type&&"Mesh"!==e.type||n.push(e)}),t.parse(n,function(e){var t=document.createElement("a"),n=new Blob([e],{type:"model/gltf-binary"});t.href=URL.createObjectURL(n),t.download="scene.glb",t.style.display="none",document.body.appendChild(t),t.click()},{binary:!0,embedImages:!0,forceIndices:!0})})}},{key:"showGUI",value:function(){this._lightSetting&&this._lightSetting.showGUI();var e=y();if(this._pixotron){var t=e.addFolder("Renderer");t.add(this._pixotron.getSAOPass(),"enabled"),t.add(this._pixotron.getSAOPass(),"smoothTransition"),t.add(this._pixotron.getSAOPass(),"occlusionWorldRadius").min(0).max(2).step(.01),t.add(this._pixotron.getSAOPass(),"intensity").min(.1).max(2).step(.05),t.add(this._pixotron.getSAOPass(),"bias").min(-.1).max(.1).step(.001),t.add(this._pixotron.getSAOPass(),"numSamples").min(10).max(3e3).step(10),t.add(this._pixotron.getShadowPass(),"smoothTransition"),t.add(this._pixotron.getShadowPass(),"enableAccumulation"),t.add(this._pixotron.getShadowPass(),"shadowRadius").min(0).max(5).step(.1),t.add(this._pixotron.getShadowPass(),"shadowBiasMultiplier").min(0).max(3).step(.1),t.add(this._pixotron.getShadowPass(),"numSamples").min(10).max(3e3).step(10)}this._environment&&this._environment.showGUI(),this._addGUIListener(e)}},{key:"_addGUIListener",value:function(e){var t=this,n=e.__folders;Object.keys(n).forEach(function(e,i){var o=n[e];o.__folders&&Object.keys(o.__folders).forEach(function(e,i){var o=n[e];t._addGUIListener(o)}),o.__controllers&&o.__controllers.forEach(function(e){e.onFinishChange(function(){t._requestRender()})})})}},{key:"zoomIn",value:function(e){this._cameraControl.zoomIn(e),this._requestRender(!0)}},{key:"zoomOut",value:function(e){this._cameraControl.zoomOut(e),this._requestRender(!0)}},{key:"showStats",value:function(){var e=this;t.import("./stats-helper.legacy.js").then(function(t){return e._statsHelper=new t.default})}},{key:"showDimensions",value:function(){this._dimensionHelper.forceDimensions=!0,this._requestRender()}},{key:"hideDimensions",value:function(){this._dimensionHelper.disableDimensions(),this._requestRender()}},{key:"loadSceneSettings",value:function(e){var t=this,n=new Promise(function(n){(new ke).load(t._scene,t._renderer.domElement,t._environment,e).then(function(e){t._environment=e,n()})});this._lightSetting=new _e(this._scene,this._lightSetting);var i=this._lightSetting.loadFromObject(e);return new Promise(function(e,o){Promise.all([n,i]).then(function(){t._requestRender(!0),t._uiIntersectionHelper.floorEnvironment=t._environment instanceof ye,e()},o)})}},{key:"setBackgroundColor",value:function(e){this._environment=new we(this._scene,this._environment,new THREE.Color(e)),this._requestRender()}},{key:"setBackgroundImage",value:function(e){this._environment=new we(this._scene,this._environment,null,this._renderer.domElement,e),this._requestRender()}}]),e}();n([i],He.prototype,"_unitFormatter",void 0),n([i],He.prototype,"_domHelper",void 0),n([i],He.prototype,"_webGl",void 0),n([i],He.prototype,"_scriptLoader",void 0),n([i],He.prototype,"_configuratorInputManager",void 0),n([i],He.prototype,"_eventHandler",void 0),n([i],He.prototype,"_dataSyncer",void 0),n([i],He.prototype,"_errorHandler",void 0),n([i],He.prototype,"_configuratorMeshGenerator",void 0),n([i],He.prototype,"_memoryManager",void 0);var Pe=new Map,Te=function(e,t,n){var i=Pe.get(e);if(i){var o=n?[n]:void 0;i.forEach(function(e){var n=e.resolve,i=e.reject;return t?n.apply(n,o):i.apply(i,o)}),Pe.delete(e)}},Se=function(){function e(){o(this,e)}return a(e,null,[{key:"finishOperation",value:function(e,t){Te(e,!0,t)}},{key:"failOperation",value:function(e,t){Te(e,!1,t)}},{key:"waitFor",value:function(e,t){return new Promise(function(n,i){var o=Pe.get(e);o||(Pe.set(e,[]),o=Pe.get(e)),o.push({resolve:n,reject:i}),"function"==typeof t&&t.apply(t)})}}]),e}(),xe=function(){function t(){var n=this;o(this,t),this._needsSync=!1,this._eventHandler.subscribe(0,this._loadWebGlLib.bind(this)),this._eventHandler.subscribe(41,this._planObjectCreate.bind(this)),this._subscribeToKernelEvent(28,this._componentConstructionBegin.bind(this)),this._subscribeToKernelEvent(29,this._createComponent.bind(this)),this._subscribeToKernelEvent(31,this._bakedMeshLoaded.bind(this)),this._subscribeToKernelEvent(32,this._namedMeshLoaded.bind(this)),this._subscribeToKernelEvent(33,this._componentConstructionDone.bind(this)),this._subscribeToKernelEvent(35,this._dockComponent.bind(this)),this._subscribeToKernelEvent(36,this._deleteComponent.bind(this)),this._subscribeToKernelEvent(26,this._sceneCleared.bind(this)),this._subscribeToKernelEvent(30,this._updateComponent.bind(this)),this._subscribeToKernelEvent(40,this._configurationLoaded.bind(this)),this._subscribeToKernelEvent(42,this._planObjectUpdate.bind(this)),this._subscribeToKernelEvent(43,this._planObjectConstructionDone.bind(this)),this._subscribeToKernelEvent(45,this._enableRootComponentParametersAsGlobal.bind(this)),this._subscribeToKernelEvent(46,this._disableRootComponentParametersAsGlobal.bind(this)),this._subscribeToKernelEvent(50,this._createPreview.bind(this)),this._subscribeToKernelEvent(51,this._setPreviewAssociations.bind(this)),this._subscribeToKernelEvent(52,this._setPreviewLineAssociations.bind(this)),this._subscribeToKernelEvent(53,this._previewConstructionDone.bind(this)),this._subscribeToKernelEvent(58,this._notifyOnMaterialFinished.bind(this)),this._subscribeToKernelEvent(34,this._componentGeometryNotReady.bind(this)),this._eventHandler.subscribe(67,this._requestDeleteComponent.bind(this)),this._eventHandler.subscribe(68,this._requestDeleteComponents.bind(this)),this.context=new e,q.isProduction||(window.__RML__DEBUG__.getConfiguration=function(){return{hash:window.__RML__DEBUG__.Kernel.getHashOfPlanComponent(n.context.planObjectId),configuration:window.__RML__DEBUG__.Kernel.getSerializedConfiguration(n.context.planObjectId)}})}return a(t,[{key:"_subscribeToKernelEvent",value:function(e,t){this._eventHandler.subscribe(e,function(){this._sceneHelper?t.apply(t,arguments):this._needsSync=!0}.bind(this))}},{key:"_loadWebGlLib",value:function(e,t,n){var i=[this._scriptLoader.fetch("static/three/lib/rthree.js",{id:"three-lib"}),this._scriptLoader.fetch("static/three/lib/shaders/CopyShader.js",{id:"copy-shader-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/EffectComposer.js",{id:"effect-composer-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/RenderPass.js",{id:"render-pass-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/ShaderPass.js",{id:"shader-pass-js"}),this._scriptLoader.fetch("static/three/lib/shaders/LuminosityHighPassShader.js",{id:"luminosity-high-pass-shader-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/UnrealBloomPass.js",{id:"unreal-bloom-pass-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/OutlinePass.js",{id:"outline-pass-js"})];Promise.all(i).then(this._loadingSuccess(e,t,n).bind(this),this._loadingError.bind(this))}},{key:"_loadingError",value:function(){this._eventHandler.dispatch(2)}},{key:"_loadingSuccess",value:function(e,t,n){var i=this;return function(){i._eventHandler.dispatch(1),i._sceneHelper=n||new He(i._updatedOffset?i._updatedOffset:t);var o=window.__RML__ENV__.initData,a=o.initialFloorMaterial,r=o.enableHD,s=o.dls,l=o.ls,c=o.stats,h=void 0===r?q.features.hdEnabledByDefault:r,d=I.createDynamicLightSettingSource(s,l);h?i.enableHD(d):window.__RML__ENV__.initData.retina=!0,c&&i.showStats(),i._needsSync&&(i._needsSync=!1,i._eventHandler.dispatch(60,[i.context.lastConversationId,i.context.planObjectId]));var u=[i._scriptLoader.fetch("static/three/Tween.js",{id:"tween-js"})];a&&u.push(i._rapiAccess.getMaterial(a).then(function(e){return i._sceneHelper.changeFloorMaterial(e)})),Promise.all(u).then(i._loadingControlsSuccess(e).bind(i),i._loadingControlsError.bind(i))}}},{key:"_loadingControlsSuccess",value:function(e){var t=this;return function(){t._eventHandler.dispatch(3)}}},{key:"_loadingControlsError",value:function(){this._eventHandler.dispatch(4)}},{key:"_createComponent",value:function(e,t,n,i,o){o&&(this.context.rootComponentId=e),this._sceneHelper.addComponent(e,t,n,i,o)}},{key:"_bakedMeshLoaded",value:function(e,t,n,i,o,a){this._sceneHelper.addMesh(e,null,t,null,n,i,o,a)}},{key:"_namedMeshLoaded",value:function(e,t,n,i,o,a,r,s){this._sceneHelper.addMesh(e,t,n,i,o,a,r,s)}},{key:"_componentConstructionBegin",value:function(e){this._sceneHelper.componentConstructionBegin(e)}},{key:"_componentConstructionDone",value:function(e,t){this._sceneHelper.componentConstructionDone(e,t)}},{key:"_componentGeometryNotReady",value:function(e){this._sceneHelper.componentGeometryNotReady(e)}},{key:"_dockComponent",value:function(e,t,n,i){this._sceneHelper.dockComponent(e,t,n,i)}},{key:"_updateComponent",value:function(e,t){this._sceneHelper.updateComponent(e,t)}},{key:"_deleteComponent",value:function(e){this._sceneHelper.deleteComponent(e)}},{key:"_sceneCleared",value:function(){this.context.selectedRuntimeComponentIds=[],this._sceneHelper.sceneCleared()}},{key:"_createPreview",value:function(e,t){this._sceneHelper.addPreview(e,t)}},{key:"_setPreviewAssociations",value:function(e,t){this._sceneHelper.setPreviewAssociations(e,t)}},{key:"_setPreviewLineAssociations",value:function(e,t){this._sceneHelper.setPreviewLineAssociations(e,t)}},{key:"_previewConstructionDone",value:function(e,t){this._sceneHelper.previewConstructionDone(e,t)}},{key:"clearScene",value:function(){this._sceneHelper&&this._sceneHelper.clearScene()}},{key:"_planObjectCreate",value:function(e,t){this.context.planObjectId=t,this.context.lastConversationId=e,this._sceneHelper?(this._sceneHelper.clearScene(),this._sceneHelper.waitingForMaterials.push(Se.waitFor(2))):this._needsSync=!0}},{key:"_planObjectUpdate",value:function(e,t){this._sceneHelper.planObjectUpdate(e,t)}},{key:"_planObjectConstructionDone",value:function(e){this._sceneHelper.planObjectUpdate(e,!0),this._sceneHelper.planObjectConstructionDone(e),this._sceneHelper.resetCameraPositionToStart()}},{key:"_enableRootComponentParametersAsGlobal",value:function(){this.context.selectedRuntimeComponentId||(this.context.rootComponentParametersAsGlobal=!0)}},{key:"_disableRootComponentParametersAsGlobal",value:function(){this.context.rootComponentParametersAsGlobal=!1}},{key:"_requestDeleteComponent",value:function(e){this._sceneHelper.resetCamera()}},{key:"_requestDeleteComponents",value:function(e){this._sceneHelper.resetCamera()}},{key:"_configurationLoaded",value:function(e,t,n){this.context.lastConfigurationLoadedComponentId=t,this._sceneHelper.configurationLoaded(e,t,n)}},{key:"_notifyOnMaterialFinished",value:function(e,t){Promise.all(this._sceneHelper.waitingForMaterials).then(e,t)}},{key:"onSelectedRuntimeComponentChange",value:function(e){var t=!1,n=null;e&&(t=e.roomleId===this.context.rootComponentId,n=e.roomleId),this._eventHandler.dispatch(11,[n,t,this.context.selectionMode]),e&&(this._eventHandler.dispatch(9,[e.roomleId]),this._sceneHelper.zoomToComponent(e))}},{key:"onSelectedRuntimeComponentsChange",value:function(e){this._eventHandler.dispatch(12,[e,this.context.rootComponentId])}},{key:"debugSceneGraph",value:function(e){this._sceneHelper.debugSceneGraph(e)}},{key:"requestMaterial",value:function(e){return this._rapiAccess.getMaterial(e)}},{key:"requestTextures",value:function(e){return this._rapiAccess.getTexturesOf(e)}},{key:"requestDockingsPreview",value:function(e,t,n,i){e&&this._sceneHelper.cancelPreviousDockings(),this.cancelSelection(),i&&this._sceneHelper.enableDragIn(n),t&&(this.context.lastPossibleChild=t),this.context.requestPreviewsIsUserInitiated=e,this._sceneHelper.resetPreviews(),this._eventHandler.dispatch(13,[this.context,i])}},{key:"dockComponent",value:function(e){var t=R.start("dock_component_"+e.childId);this._eventHandler.dispatch(6,[e.parentId,e.parentDockId,e.childId,e.childDockId]),this.context.lastConfigurationLoadedComponentId=null,R.end(t)}},{key:"dockComponentWithPosition",value:function(e,t){var n=R.start("dock_component_with_position_"+e.childId);this._eventHandler.dispatch(7,[e.parentId,e.parentDockId,e.childId,e.childDockId,t]),this.context.lastConfigurationLoadedComponentId=null,R.end(n)}},{key:"requestDockingsPreviewWithDrag",value:function(e){this._sceneHelper.cancelPreviousDockings(),this.context.rootComponentId!==e&&(this._sceneHelper.resetPreviews(),this._eventHandler.dispatch(14,[e,this.context]))}},{key:"preparePerspectiveImage",value:function(){return this._sceneHelper.preparePerspectiveImage()}},{key:"prepareTopImage",value:function(){return this._sceneHelper.prepareTopImage()}},{key:"resetCameraPosition",value:function(){this._sceneHelper.resetCameraPositionToStart()}},{key:"changeOffset",value:function(e){this._sceneHelper?this._sceneHelper.changeOffset(e):this._updatedOffset=e}},{key:"cancelSelection",value:function(){this._sceneHelper.cancelSelection()}},{key:"sendCancelSelectionEvent",value:function(){this._eventHandler.dispatch(10,[this.context.planObjectId])}},{key:"notifyNoPreviews",value:function(){this._eventHandler.dispatch(15)}},{key:"enableHD",value:function(e){var t=this;return new Promise(function(n,i){var o=t._scriptLoader,a=function(){t._sceneHelper.enableHD(e),n()};Promise.all([o.fetch("static/three/lib/lights/RectAreaLightUniformsLib.js",{id:"rect-area-light-uniforms-lib-js"})]).then(function(){o.fetch("static/three/pixotron.min.js",{id:"pixotron-js"}).then(a,i)},i)})}},{key:"disableHD",value:function(){var e=this;return new Promise(function(t){e._sceneHelper.disableHD(),t()})}},{key:"enableMultiselect",value:function(){this._sceneHelper.setSelectionMode("multiselect"),this.context.selectionMode="multiselect"}},{key:"disableMultiselect",value:function(){this._sceneHelper.setSelectionMode("standard"),this.context.selectionMode="standard"}},{key:"requestDeleteComponent",value:function(){this.context.lastConfigurationLoadedComponentId&&this._eventHandler.dispatch(8,[this.context.lastConfigurationLoadedComponentId]),this.context.lastConfigurationLoadedComponentId=null}},{key:"requestDeleteSelectedComponent",value:function(){switch(this.context.selectionMode){case"standard":this._eventHandler.dispatch(67,[this.context.selectedRuntimeComponentId]);break;case"multiselect":this._eventHandler.dispatch(68,[this.context.selectedRuntimeComponentIds])}}},{key:"onUiIntersectionChange",value:function(e){this._eventHandler.dispatch(17,[e])}},{key:"onDimensionsVisibilityChange",value:function(e){this._eventHandler.dispatch(19,[e])}},{key:"onRemovePreviews",value:function(e){this._eventHandler.dispatch(20,[e])}},{key:"cleanUp",value:function(){this._sceneHelper.cleanUp()}},{key:"openAddOns",value:function(){this._eventHandler.dispatch(21)}},{key:"clickOutside",value:function(){this._eventHandler.dispatch(22)}},{key:"setFloorMaterial",value:function(e,t,n,i){return this._sceneHelper.setFloorMaterial(e,t,n,i)}},{key:"changeFloorMaterial",value:function(e){return this._sceneHelper.changeFloorMaterial(e)}},{key:"showGUI",value:function(){var e=this,t=document.createElement("style");t.innerText=".dg.ac {right:auto!important}",document.head.appendChild(t),this._scriptLoader.fetch("three/dat.gui.min.js",{id:"dat-gui-js"}).then(function(){return e._sceneHelper.showGUI()},function(e){return console.error(e)})}},{key:"showStats",value:function(){this._sceneHelper.showStats()}},{key:"stopRenderLoop",value:function(){this._sceneHelper.stopRenderLoop()}},{key:"showDimensions",value:function(){this._sceneHelper.showDimensions()}},{key:"hideDimensions",value:function(){this._sceneHelper.hideDimensions()}},{key:"loadDynamicLightSetting",value:function(e){return this._sceneHelper.loadDynamicLightSetting(e)}},{key:"loadSceneSettings",value:function(e){return this._sceneHelper.loadSceneSettings(e)}},{key:"setBackgroundColor",value:function(e){this._sceneHelper.setBackgroundColor(e)}},{key:"setBackgroundImage",value:function(e){this._sceneHelper.setBackgroundImage(e)}},{key:"updateSize",value:function(){this._sceneHelper.updateSize()}},{key:"zoomIn",value:function(e){this._sceneHelper.zoomIn(e)}},{key:"zoomOut",value:function(e){this._sceneHelper.zoomOut(e)}},{key:"onZoomChanged",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._eventHandler.dispatch(18,[e,t])}}]),t}();n([i],xe.prototype,"_scriptLoader",void 0),n([i],xe.prototype,"_eventHandler",void 0),n([i],xe.prototype,"_rapiAccess",void 0),n([i],xe.prototype,"_memoryManager",void 0);var Re=function(e){return e.validRange&&"string"==typeof e.validRange.type},Ie=function(e){return e.validValues&&e.validValues.length>0},Le=function(e){return"length"===e.unitType||"area"===e.unitType},Me=function(e){return"Material"===e.type},Oe={InchFeet:null,MM:null,CM:null},Ge={NoUnitString:null,LongUnitString:null,ShortUnitString:null},De=function(){function e(){o(this,e),this._formatter=null}return a(e,[{key:"init",value:function(e,t){var n=new e.UnitMeasureFormatter;Oe=e.Unit,Ge=e.UnitStringType,this._initActualUnit(),this._initActualUnitStringType();var i=window.__RML__ENV__.initData,o=i.precisionCm,a=i.precisionInch,r=0;this._actualUnit===Oe.InchFeet?r=a?parseInt(a,10):2:this._actualUnit===Oe.CM&&(r=o?parseInt(o,10):1),n.init("mm","cm","'","ft",'"',"inch","m²","sqft",!0,r),this._formatter=n}},{key:"_initActualUnit",value:function(){switch(window.__RML__ENV__.initData.unit){case"cm":this._actualUnit=Oe.CM;break;case"mm":this._actualUnit=Oe.MM;break;case"inchfeet":this._actualUnit=Oe.InchFeet;break;default:this._actualUnit=Oe.CM}}},{key:"_initActualUnitStringType",value:function(){switch(window.__RML__ENV__.initData.unitStringType){case"none":this._actualUnitStringType=Ge.NoUnitString;break;case"long":this._actualUnitStringType=Ge.LongUnitString;break;case"short":this._actualUnitStringType=Ge.ShortUnitString;break;default:this._actualUnitStringType=Ge.ShortUnitString}}},{key:"_isFormatterReady",value:function(){return!!this._formatter||(console.warn("Formatter is not ready..."),!1)}},{key:"isParseableNumber",value:function(e){return this._isFormatterReady()?this._formatter.isParseableNumber(e):null}},{key:"isParseableUnitString",value:function(e){return this._isFormatterReady()?this._formatter.isParseableUnitString(e,this._actualUnit):null}},{key:"parseMMValueFromUnitString",value:function(e,t){return this._isFormatterReady()?"count"===t?parseFloat(e):this._formatter.parseMMValueFromUnitString(e,this._actualUnit):null}},{key:"parseNumber",value:function(e){return this._isFormatterReady()?this._formatter.parseNumber(e):null}},{key:"formatNumber",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this._isFormatterReady()?this._formatter.formatNumber(e,t):null}},{key:"formatSquareMMValueToUnitString",value:function(e){return this._isFormatterReady()?this._formatter.formatSquareMMValueToUnitString(e,this._actualUnit):null}},{key:"formatMMValueToUnitString",value:function(e,t){return this._isFormatterReady()?"count"===t?e.toString():this._formatter.formatMMValueToUnitString(e,this._actualUnit,this._actualUnitStringType):null}},{key:"formatMMValueWithReqMaxLength",value:function(e,t){return this._isFormatterReady()?this._formatter.formatMMValueWithReqMaxLength(e,this._actualUnit,t):null}},{key:"_formatParameterValue",value:function(e,t){return"length"===t?this.formatMMValueToUnitString(parseFloat(e)):"area"===t?this.formatSquareMMValueToUnitString(parseFloat(e)):e}},{key:"formatPartListParameter",value:function(e){Le(e)&&(e.valueLabel=this._formatParameterValue(e.value,e.unitType))}},{key:"formatParameter",value:function(e){var t=this;Le(e)&&Array.isArray(e.validValues)&&e.validValues.forEach(function(n,i){var o=n.value;e.validValues[i].label=t._formatParameterValue(o,e.unitType)}),e.valueLabel=e.value,Me(e)?e.uiType="Material":function(e){return"Boolean"===e.type}(e)?e.uiType="Boolean":Re(e)?(e.uiType="Range",e.valueLabel=this._formatParameterValue(e.value,e.unitType),e.validRangeLabels={valueFrom:this.formatMMValueToUnitString(e.validRange.valueFrom,e.unitType),valueTo:this.formatMMValueToUnitString(e.validRange.valueTo,e.unitType),type:e.validRange.type}):Ie(e)?(e.uiType="Options",function(e){return!!Ie(e)&&Array.isArray(e.validValues)&&e.validValues.length>0&&"string"==typeof e.validValues[0].thumbnail}(e)&&(e.uiType="Thumbnails")):(console.error("Could not detect uiType of param"),e.uiType=null)}}]),e}(),Fe=function(){function e(){o(this,e)}return a(e,null,[{key:"sort",value:function(e,t){return e.sort||t.sort?e.sort?t.sort?e.sort-t.sort:-1:1:0}}]),e}(),Ae=function(){function e(){var t=this;o(this,e),this._isKernelReady=!1,this._isLoadError=!1,this._waitingForPreload=!1,this._waitingForWebGlLib=!0,this._isReloading=!1;var n=this._eventHandler;n.subscribe(25,this._kernelIsReady.bind(this)),n.subscribe(2,this._loadError.bind(this)),n.subscribe(24,this._loadError.bind(this)),n.subscribe(39,this._updateCommonComponentParameters.bind(this)),n.subscribe(37,this._updateComponentParameters.bind(this)),n.subscribe(44,this._updatePlanObjectParameters.bind(this)),n.subscribe(47,this._updatePlanComponentPossibleChildren.bind(this)),n.subscribe(48,this._updatePlanObjectPossibleChildren.bind(this)),n.subscribe(49,function(e,n){return t._configuratorUiCallbacks.onUpdatePrice(e,n)}),n.subscribe(42,this._updatePlanObject.bind(this)),n.subscribe(54,function(e,n,i,o){return t._configuratorUiCallbacks.onSelectionChange(e,n,i,o)}),n.subscribe(55,this._partListUpdate.bind(this)),n.subscribe(15,function(){return t._configuratorUiCallbacks.onNoDockingsAvailable()}),n.subscribe(10,function(){return t._configuratorUiCallbacks.onSelectionCancel()}),n.subscribe(17,function(e){return t._configuratorUiCallbacks.onUiIntersectionChange(e)}),n.subscribe(19,function(e){return t._configuratorUiCallbacks.onDimensionsVisibilityChange(e)}),n.subscribe(20,this._onRemovedPreviews.bind(this)),n.subscribe(56,function(e){return t._configuratorUiCallbacks.onConfigurationHasChildren(e)}),n.subscribe(1,this._webglLibLoaded.bind(this)),n.subscribe(59,function(){return t._configuratorUiCallbacks.onUserInitiatedDockDone()}),n.subscribe(21,function(){return t._configuratorUiCallbacks.onOpenAddOns()}),n.subscribe(22,function(){return t._configuratorUiCallbacks.onClickOutside()}),n.subscribe(74,function(){return t._configuratorUiCallbacks.onAddonPlusHover()}),n.subscribe(76,function(){return t._configuratorUiCallbacks.onAddonPlusShown()}),n.subscribe(38,function(e){return t._configuratorUiCallbacks.onComponentLoadError(e)}),n.subscribe(62,function(){return t._configuratorUiCallbacks.onMemoryCorruption()}),n.subscribe(18,function(e,n){return t._configuratorUiCallbacks.onZoomChange(e,n)}),n.subscribe(79,function(){return t._configuratorUiCallbacks.onSyncStarted()}),n.subscribe(80,function(){return t._configuratorUiCallbacks.onSyncDone()});var i=this._errorHandler;i.subscribe(0,function(e){return t._configuratorUiCallbacks.onErrorDueToOffline(e)}),i.subscribe(1,function(e){return t._configuratorUiCallbacks.onError(e)}),i.subscribe(2,function(e,n){return t._configuratorUiCallbacks.onContentProblem({rapiPath:e,ids:n})}),window.RoomleConfigurator=this}return a(e,[{key:"_loadError",value:function(){this._isLoadError=!0,this._rejectOnLoadError&&this._rejectOnLoadError()}},{key:"_webglLibLoaded",value:function(){this._waitingForWebGlLib=!1,this._notifyDependenciesWaiter()}},{key:"_initPromiseCallback",value:function(e,t){this._isKernelReady?e():this._isLoadError?t():(this._resolveOnInitDone=e,this._rejectOnLoadError=t)}},{key:"_notifyOnConfigurationReady",value:function(e){var t=this;return function(n){e(n.partList),t._configuratorUiCallbacks.onConfigurationReady(n.partList,n.hash,n.rootComponentLabel)}}},{key:"_notifyOnConfigurationLoadingError",value:function(e){var t=this;return function(){t._configuratorUiCallbacks.onConfigurationLoadError()}}},{key:"_loadItemOrConfigById",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(this._webGl.context.lastLoadedRapiId=e,this._onLoadConfiguration(),this.setOverrides(i),i?i.id=e:i={id:e},this._preloadPackage(e),this._webGl.clearScene(),window.__RML__ENV__.initData.offlineSync){var o=N(e);o&&this._dataSyncer.start(o)}return new Promise(function(o,a){(t?n._rapiAccess.getConfiguration(e):n._rapiAccess.getItem(e)).then(function(t){t&&t.configuration?n._loadConfiguration(t.configuration,i).then(function(e){var i=n._notifyOnConfigurationReady(o);t.label?n._notifyUiAboutNewItem(t,e.rootComponentLabel):n._notifyUiAboutNewConfiguration(t),i(e)},n._notifyOnConfigurationLoadingError(a).bind(n)):a(new Error("Could not load item or config with id "+e))},a)})}},{key:"_updateCommonComponentParameters",value:function(e,t,n){this._updateParameters(e,n,t,2)}},{key:"_updatePlanObjectParameters",value:function(e,t,n){this._updateParameters(t,n,e,0)}},{key:"_updateComponentParameters",value:function(e,t,n){this._updateParameters(t,n,e,1)}},{key:"_updatePlanComponentPossibleChildren",value:function(e,t){this._updatePossibleChildren(e,t,1)}},{key:"_updatePlanObjectPossibleChildren",value:function(e,t){this._updatePossibleChildren(e,t,0)}},{key:"_shouldBroadcastToUi",value:function(e){return!(0===e&&this._webGl.context.selectedRuntimeComponentId||1===e&&!this._webGl.context.selectedRuntimeComponentId||2===e&&!this._webGl.context.selectedRuntimeComponentIds.length)}},{key:"_isCorrectResponse",value:function(e,t){if(0===e)return t===this._webGl.context.planObjectId;if(1===e)return t===this._webGl.context.selectedRuntimeComponentId;var n=t.length;if(n!==this._webGl.context.selectedRuntimeComponentIds.length)return!1;for(var i=0;n>i;i++)if(t[i]!==this._webGl.context.selectedRuntimeComponentIds[i])return!1;return!0}},{key:"_addUiDataToPartList",value:function(e,t){var n=this,i=[];return e.forEach(function(e){var t=n._rapiAccess.peekComponent(e.componentId);t&&(e.label=t.label),e.parameters.forEach(function(e){if(n._unitFormatter.formatPartListParameter(e),Me(e)){var t=n._rapiAccess.peekMaterial(e.value);t?e.valueLabel=t.label||t.name||e.value:-1===i.indexOf(e.value)&&i.push(e.value)}})}),i.length&&this._rapiAccess.getMaterials(i).then(function(e){var i=n._lastPartListHash!==t;Array.isArray(e)&&e.length&&i&&(n._lastPartListHash=t,n._eventHandler.dispatch(73,[n._webGl.context]))}),e}},{key:"_updatePlanObject",value:function(e){if(e.bounds){var t={width:this._unitFormatter.formatMMValueToUnitString(e.bounds.x),height:this._unitFormatter.formatMMValueToUnitString(e.bounds.z),depth:this._unitFormatter.formatMMValueToUnitString(e.bounds.y)};this._configuratorUiCallbacks.onBoundsUpdate(t)}}},{key:"_partListUpdate",value:function(e,t){var n=e.fullList;this._addUiDataToPartList(n,t),this._configuratorUiCallbacks.onPartListUpdate(n,t)}},{key:"_onLoadConfiguration",value:function(){this._webGl.clearScene(),this._configuratorUiCallbacks.onLoadConfiguration()}},{key:"_onRemovedPreviews",value:function(e){e&&this._configuratorUiCallbacks.onDockingsPreviewRemoved()}},{key:"_updatePossibleChildren",value:function(e,t,n){for(var i,o=this,a=[],r=[],s=0,l=t.length;l>s;s++){var c=t[s];if(c.possible){var h=c.itemId;c.itemId?r.push(c.itemId):(a.push(c.componentId),h=c.componentId),c.isDefault&&!i&&(i=h)}}Promise.all([this._rapiAccess.getComponents(a),this._rapiAccess.getItems(r)]).then(function(e){for(var t,n=[],o=e[0],a=e[1],r=0,s=o.length;s>r;r++){var l=o[r];l.isItem=!1,l.isComponent=!0,l.id===i&&(l.isDefault=!0,t=l),n.push(l)}for(var c=0,h=a.length;h>c;c++){var d=a[c];d.isItem=!0,d.isComponent=!1,d.id===i&&(d.isDefault=!0,t=d),n.push(d)}return n.sort(Fe.sort),{possibleChildren:n,defaultChild:t||null}}).then(function(e){for(var t=e.possibleChildren,n=e.defaultChild,i=[],o=new Map,a=[],r=0,s=t.length;s>r;r++){var l=t[r],c=l.tags;if(l.tags&&Array.isArray(l.tags)&&l.tags.length)for(var h=0,d=l.tags.length;d>h;h++){var u=c[h];-1===i.indexOf(u)&&i.push(u);var _=o.get(u);_||(o.set(u,[]),_=o.get(u)),_.push(l)}else a.push(l)}return{tagIds:i,associations:o,defaultChild:n,noTagChilds:a}}).then(function(t){var i=t.tagIds,a=t.associations,r=t.defaultChild,s=t.noTagChilds;o._rapiAccess.getTags(i).then(function(t){if(o._isCorrectResponse(n,e)&&o._shouldBroadcastToUi(n)){for(var i=0,l=t.length;l>i;i++){var c=t[i];c.possibleChildren=a.get(c.id)}t.sort(Fe.sort),s.length&&t.unshift({id:"",externalIdentifier:"",global:!1,created:(new Date).toISOString(),updated:(new Date).toISOString(),language:L.actualLocale,catalog:null,tags:[],parents:[],materials:[],items:[],possibleChildren:s}),o._configuratorUiCallbacks.onUpdatePossibleChildren(t,r)}},function(e){console.error("Couldnt load tags of possible children"),console.error(e)})},function(e){return console.error(e)})}},{key:"_updateParameters",value:function(e,t,n,i){var o=this,a={};t||(t=[],console.warn("Kernel returned no parameter groups! Check why!")),t.forEach(function(e){a[e.key]=e}),e.sort(Fe.sort),e.forEach(function(e){e.group?e.grouping=a[e.group]:e.grouping=null,o._unitFormatter.formatParameter(e),Me(e)&&Object.defineProperty(e,"groups",{get:function(){return new Promise(function(t,a){o._getMaterialGroups(e).then(function(e){o._isCorrectResponse(i,n)&&o._shouldBroadcastToUi(i)?t(e):a("Response does not match to ids")},a)})}})}),this._shouldBroadcastToUi(i)&&this._configuratorUiCallbacks.onUpdateParameters(e)}},{key:"_notifyUiAboutNewItem",value:function(e,t){var n=this;this._rapiAccess.getCatalog(e.catalog).then(function(i){return n._configuratorUiCallbacks.onConfigurationLabelChange(i.name,e.label,t)})}},{key:"_notifyUiAboutNewConfiguration",value:function(e){var t=this;Promise.all([this._rapiAccess.getCatalog(e.catalog),this._rapiAccess.getComponent(e.rootComponentId)]).then(function(e){var n=u(e,2),i=n[0],o=n[1];return t._configuratorUiCallbacks.onConfigurationLabelChange(i.name,null,o.label)})}},{key:"_getMaterialGroups",value:function(e){var t=this,n=function(e,t){var n=e.label,i=t.label;if(n&&!i)return 1;if(!n&&i)return-1;if(n&&i)return n.localeCompare(i);var o=e.id,a=t.id;return o&&!a?1:!o&&a?-1:o||a?o.localeCompare(a):0},i=function(e){return e.sort(n),e.forEach(function(e){return e.materials.sort(n)}),e};if(e.validGroups.length>0)return new Promise(function(n,o){return t._rapiAccess.getMaterialsByGroup(e.validGroups).then(function(e){return n(i(e))},o)});var o=[];return e.validValues.forEach(function(e){return o.push(e.value)}),new Promise(function(e,n){return t._rapiAccess.getMaterials(o).then(function(n){return e(i(t._rapiAccess.combineMaterialsToGroups(n)))},n)})}},{key:"_kernelIsReady",value:function(){this._isKernelReady=!0;var e=R.getMeasure("kernel_is_ready");if(Array.isArray(e)&&1===e.length){var t=e[0],n=R.getMeta("kernel_is_ready");this._configuratorUiCallbacks.onTrackTiming("Timing","KernelIsReady",Math.round(t.duration),Object.assign(n,{startTime:t.startTime}))}this._resolveOnInitDone&&this._resolveOnInitDone(),this._configuratorUiCallbacks.onKernelIsReady()}},{key:"_loadConfiguration",value:function(e,t){var n=this;return new Promise(function(i,o){var a=function(){R.start("ui_load_configuration");var a=[];if(t.applyCurrentGlobalParameters){var r=n._webGl.context.planObjectId,s=n._webGl.context.rootComponentParametersAsGlobal;a.push(n._eventHandler.request(1,[r,s]))}Promise.all(a).then(function(a){var r=u(a,1)[0];Se.waitFor(2).then(function(e){var o=u(e,4),a=(o[0],o[1]),s=o[2],l=o[3],c=[];r&&t.applyCurrentGlobalParameters&&r.forEach(function(e){return c.push(n.setParameter(e,e.value,!0))});var h=n._rapiAccess.peekComponent(l);Promise.all(c).then(function(){var e=[];c.length&&(e.push(n._eventHandler.request(2)),e.push(n._eventHandler.request(3,[n._webGl.context]))),Promise.all(e).then(function(e){var t=e&&e[0]?e[0]:a,o=e&&e[1]?e[1]:s;i({partList:n._addUiDataToPartList(t,o),hash:o,rootComponentLabel:h?h.label:""})})})},o),n._eventHandler.dispatch(63,[e,t])})};n._waitingForDependencies?n._waiterForPreload=a:a()})}},{key:"_notifyDependenciesWaiter",value:function(){this._waitingForDependencies||"function"!=typeof this._waiterForPreload||(this._waiterForPreload(),this._waiterForPreload=null)}},{key:"_preLoadItemOrConfig",value:function(e,t){var n=this;return new Promise(function(i,o){(t?n._rapiAccess.getConfiguration(e):n._rapiAccess.getItem(e)).then(i,o)})}},{key:"_preloadPackage",value:function(e){var t=this;this._waitingForPreload=!0;var n=null;n=W(e)?this._rapiAccess.getPreloadForItem.bind(this._rapiAccess):this._rapiAccess.getPreloadForConfiguration.bind(this._rapiAccess),R.start("rapi_preloads");var i=function(){R.end("rapi_preloads");var n=R.getMeasure("rapi_preloads");if(Array.isArray(n)&&1===n.length){var i=n[0];t._configuratorUiCallbacks.onTrackTiming("Timing","RapiPreloads",Math.round(i.duration),{id:e})}};n(e).then(function(){t._waitingForPreload=!1,t._notifyDependenciesWaiter(),i()},function(e){t._waitingForPreload=!1,t._notifyDependenciesWaiter(),console.error(e),i()})}},{key:"_reloadConfiguration",value:function(e,t,n,i){var o=this;return this._performLoadConfiguration(e,{preloadHint:t}).then(function(){o._isReloading=!1,n()},function(e){o._isReloading=!1,i(e)})}},{key:"_performLoadConfiguration",value:function(e,t){var n=this;return this._onLoadConfiguration(),new Promise(function(i,o){t&&t.preloadHint?n._preloadPackage(t.preloadHint):console.warn("When loading a configuration string you have to supply a preloadHint to use fast loading!"),n.setOverrides(t),setTimeout(function(){n._loadConfiguration(e,t).then(n._notifyOnConfigurationReady(i).bind(n),n._notifyOnConfigurationLoadingError(o).bind(n))},0)})}},{key:"_changeHDGeometry",value:function(e){var t=this;return new Promise(function(n,i){return e===L.useHDGeometry?n():t._isReloading?i("Change of HD Geometry in progress"):(t._isReloading=!0,Se.waitFor(3).then(function(e){var o=u(e,2),a=o[0],r=o[1];t._reloadConfiguration(a,r,n,i)},i),L.useHDGeometry=e,void t._eventHandler.dispatch(69,[t._webGl.context,L.useHDGeometry]))})}},{key:"setOverrides",value:function(e){e&&(window.__RML__ENV__.initData=Object.assign(window.__RML__ENV__.initData,e),e.colors&&window.__RML__ENV__.initData.colors&&(window.__RML__ENV__.initData.colors=Object.assign(window.__RML__ENV__.initData.colors,e.colors)),e.overrideTenant&&this._rapiAccess.overrideTenant(e.overrideTenant),e.overrideCountry&&this._rapiAccess.overrideCountry(e.overrideCountry),e.overrideRapi&&this._rapiAccess.overrideRapi(e.overrideRapi))}},{key:"init",value:function(e,t){var n=this,i=t=t||{},o=i.preloadHint,a=i.offset,r=(i.locale,i.startTag),s=window.__RML__ENV__.initData.configuratorId;if(!s){var l=document.referrer;s=-1!==l.indexOf("design-bestseller")?"desing-bestseller":-1!==l.indexOf("signature-safes")?"hartmann_tresore":-1!==l.indexOf("sitzfeldt")?"sitzfeldt":""===l?null:"demoConfigurator"}return this._rapiAccess.setConfiguratorId(s),this._domHelper.setDomElement(e),this.setOverrides(t),o?this._preloadPackage(o):console.warn("No preload hint! Therefore no preload during init!!"),r&&this.getTagById(r,{include:["items"]}).then(function(e){return n._configuratorUiCallbacks.onOpenTag(e)},function(e){return console.error(e)}),this._eventHandler.dispatch(0,[e,a]),new Promise(this._initPromiseCallback.bind(this))}},{key:"cancelSelection",value:function(){this._webGl.cancelSelection()}},{key:"enableHDGeometry",value:function(){return this._changeHDGeometry(!0)}},{key:"disableHDGeometry",value:function(){return this._changeHDGeometry(!1)}},{key:"changeOffset",value:function(e){this._webGl.changeOffset(e)}},{key:"previewDockings",value:function(e,t,n){n||(n=!1),this._webGl.requestDockingsPreview(!0,e,t,n)}},{key:"requestDeleteComponent",value:function(){this._webGl.requestDeleteSelectedComponent()}},{key:"preparePerspectiveImage",value:function(){return this._webGl.preparePerspectiveImage()}},{key:"saveCurrentConfiguration",value:function(){var e=this;return new Promise(function(t,n){e._eventHandler.request(0,[e._webGl.context.planObjectId]).then(function(i){e._rapiAccess.saveConfiguration(i).then(function(i){e._rapiAccess.getComponent(i.rootComponentId).then(function(o){var a=!0,r=!0,s=i.perspectiveImage,l=i.topImage;i.perspectiveImage||(a=!1,e._webGl.preparePerspectiveImage().then(function(c){e._rapiAccess.savePerspectiveImage(i,c).then(function(e){a=!0,s=e.perspectiveImage,r&&(e.label=o.label,e.topImage=l,t(e))},n)})),i.topImage||(r=!1,e._webGl.prepareTopImage().then(function(c){e._rapiAccess.saveTopImage(i,c).then(function(e){r=!0,l=e.topImage,a&&(e.label=o.label,e.perspectiveImage=s,t(e))},n)})),a&&r&&(i.label=o.label,t(i))},function(e){throw new Error(e)})},n)}).catch(n)})}},{key:"generateImagesOfCurrentConfiguration",value:function(){var e=this;return new Promise(function(t,n){return e.saveCurrentConfiguration().then(function(e){return t({topImage:e.topImage,perspectiveImage:e.perspectiveImage,isLocally:e.isLocally})},n)})}},{key:"prepareTopImage",value:function(){return this._webGl.prepareTopImage()}},{key:"resetCameraPosition",value:function(){this._webGl.resetCameraPosition()}},{key:"showBenchmarks",value:function(e){R.showBenchmarks(e)}},{key:"debugSceneGraph",value:function(e){this._webGl.debugSceneGraph(e)}},{key:"loadConfiguration",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._webGl.context.lastLoadedRapiId=null,this._webGl.clearScene(),this._performLoadConfiguration(e,t)}},{key:"loadConfigurationById",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._loadItemOrConfigById(e,!0,t)}},{key:"syncPlanObjectToView",value:function(e,t){this._webGl.clearScene(),this._eventHandler.dispatch(60,[e,t]),this._eventHandler.dispatch(61,[t])}},{key:"loadConfigurableItemById",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._loadItemOrConfigById(e,!1,t)}},{key:"preLoadConfigurationById",value:function(e){return this._preLoadItemOrConfig(e,!0)}},{key:"preLoadConfigurableItemById",value:function(e){return this._preLoadItemOrConfig(e,!1)}},{key:"_getTag",value:function(e){return this._rapiAccess.getTag(e)}},{key:"_dispatchSetParameter",value:function(e,t,n,i,o){var a=this._webGl.context.selectedRuntimeComponentId?"local":"global",r=R.start("kernel_change_param_"+a+"_"+e);switch(this._webGl.context.selectionMode){case"standard":if(this._webGl.context.selectedRuntimeComponentId||this._webGl.context.rootComponentParametersAsGlobal){var s=this._webGl.context.selectedRuntimeComponentId?this._webGl.context.selectedRuntimeComponentId:this._webGl.context.rootComponentId;this._eventHandler.dispatch(65,[s,e,t,n,i,o])}else this._eventHandler.dispatch(66,[this._webGl.context.planObjectId,e,t,n,i,o]);break;case"multiselect":this._eventHandler.dispatch(64,[this._webGl.context.selectedRuntimeComponentIds,e,t,n,i,o])}R.end(r)}},{key:"setParameter",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new Promise(function(o,a){var r=e.key,s=e.type;if(Re(e)){if(!i&&!n._unitFormatter.isParseableUnitString(t))return a(new SyntaxError('Value "'+t+'" is not parseable'));var l=i?t:n._unitFormatter.parseMMValueFromUnitString(t,e.unitType),c=e.validRange,h=c.valueFrom,d=c.valueTo;if(!Number.isNaN(h)&&h>l)return a(new RangeError('Value "'+t+'" is too small, min-val "'+h+'"'));if(!Number.isNaN(d)&&l>d)return a(new RangeError('Value "'+t+'" is too big, max-val "'+d+'"'));t="Integer"===s&&"number"==typeof l?l.toFixed():l.toString()}n._dispatchSetParameter(r,s,t,o,a)})}},{key:"enableHD",value:function(){return this._webGl.enableHD()}},{key:"disableHD",value:function(){return this._webGl.disableHD()}},{key:"enableMultiselect",value:function(){return this._webGl.enableMultiselect()}},{key:"disableMultiselect",value:function(){return this._webGl.disableMultiselect()}},{key:"getCurrentConfiguration",value:function(){var e=this;return Se.waitFor(1,function(){return e._eventHandler.dispatch(71,[e._webGl.context.planObjectId])})}},{key:"loadComponentIntoKernel",value:function(e){var t=this;return Se.waitFor(0,function(){return t._eventHandler.dispatch(72,[e])})}},{key:"getShortUrlOfCurrentConfiguration",value:function(){var e=this;return new Promise(function(t,n){e.saveCurrentConfiguration().then(function(i){return navigator.onLine?e._rapiAccess.getShortUrl(i.id,3).then(function(e){var n=q.detailEnvironment===q.environments.PRODUCTION||q.detailEnvironment===q.environments.ALPHA?e.shortId:e.referencedId,i=q.APP.SHORTENER_URL+n;t(i)},n):n("Can not generate short url when offline")},n)})}},{key:"formatMMValueToUnitString",value:function(e,t){return this._unitFormatter.formatMMValueToUnitString(e,t)}},{key:"setFloorMaterial",value:function(e,t,n,i){return this._webGl.setFloorMaterial(e,t,n,i)}},{key:"getTagById",value:function(e,t){var n=this;return new Promise(function(i,o){n._getTag(e).then(function(e){var a=Promise.resolve([]),r=Promise.resolve([]);t&&t.include&&t.include.forEach(function(t){"materials"===t&&(a=n._rapiAccess.getMaterialsOf(e)),"items"===t&&(r=n._rapiAccess.getItems(e.items))}),Promise.all([a,r]).then(function(t){var n=u(t,2),o=n[0],a=n[1];return i(Object.assign({},e,{items:a,materials:o}))},o)},o)})}},{key:"requestAsset",value:function(e){return this._dataSyncer.requestAsset(e)}},{key:"changeFloorMaterial",value:function(e){return this._webGl.changeFloorMaterial(e)}},{key:"openFloorMaterials",value:function(){this._configuratorUiCallbacks.onOpenFloorMaterials()}},{key:"openPartList",value:function(){this._configuratorUiCallbacks.onOpenPartList()}},{key:"getAdditionalContentsOf",value:function(e){return this._rapiAccess.getAdditionalContentsOfItems(e)}},{key:"changeTypeChangeTag",value:function(e){navigator.onLine&&window.__RML__ENV__.initData.offlineSync&&this._dataSyncer.syncTypeChangeTag(e),this._configuratorUiCallbacks.onChangeTypeChangeTag(e)}},{key:"removeTypeChangeTag",value:function(e){this._configuratorUiCallbacks.onRemoveTypeChangeTag(e)}},{key:"showGUI",value:function(){this._webGl.showGUI()}},{key:"showStats",value:function(){this._webGl.showStats()}},{key:"showDimensions",value:function(){this._webGl.showDimensions()}},{key:"hideDimensions",value:function(){this._webGl.hideDimensions()}},{key:"syncCatalog",value:function(e){return this._dataSyncer.syncCatalog(e)}},{key:"syncFloorTag",value:function(e){return this._dataSyncer.syncFloorTag(e)}},{key:"syncTypeChangeTag",value:function(e){return this._dataSyncer.syncTypeChangeTag(e)}},{key:"loadDynamicLightSetting",value:function(e){return this._webGl.loadDynamicLightSetting(e)}},{key:"setBackgroundColor",value:function(e){this._webGl.setBackgroundColor(e)}},{key:"setBackgroundImage",value:function(e){this._webGl.setBackgroundImage(e)}},{key:"loadSceneSetting",value:function(e){return this._webGl.loadSceneSettings(e)}},{key:"enableMeshSelection",value:function(e){window.__RML__ENV__.initData&&(window.__RML__ENV__.initData.meshSelection=e)}},{key:"updateSize",value:function(){this._webGl.updateSize()}},{key:"cleanup",value:function(){this._eventHandler.dispatch(26),this._eventHandler.dispatch(81)}},{key:"resume",value:function(){this._eventHandler.dispatch(82)}},{key:"zoomIn",value:function(e){this._webGl.zoomIn(e)}},{key:"zoomOut",value:function(e){this._webGl.zoomOut(e)}},{key:"_waitingForDependencies",get:function(){return this._waitingForPreload||this._waitingForWebGlLib}},{key:"callbacks",get:function(){return this._configuratorUiCallbacks}}]),e}();n([i],Ae.prototype,"_eventHandler",void 0),n([i],Ae.prototype,"_webGl",void 0),n([i],Ae.prototype,"_rapiAccess",void 0),n([i],Ae.prototype,"_dataSyncer",void 0),n([i],Ae.prototype,"_errorHandler",void 0),n([i],Ae.prototype,"_unitFormatter",void 0),n([i],Ae.prototype,"_domHelper",void 0),n([i],Ae.prototype,"_configuratorUiCallbacks",void 0);var Ue=["material"],Ve=function(e){function t(){var e;return o(this,t),e=r(this,s(t).call(this,1)),R.addMeta("kernel_is_ready",{isWasm:e._useWASM}),L.kernelInstance?(e._kernelContainer=L.kernelContainer,setTimeout(function(){return e._loadSuccess()},0)):e._scriptLoader.fetch(e._kernelPath,{id:"kernel"}).then(e._loadSuccess.bind(c(c(e))),e._loadError.bind(c(c(e)))),e._eventHandler.subscribe(9,e._webGlSelectedComponent.bind(c(c(e)))),e._eventHandler.subscribe(10,e._webGlSelectionCancel.bind(c(c(e)))),e._eventHandler.subscribe(11,e._webGlSelectionChange.bind(c(c(e)))),e._eventHandler.subscribe(12,e._webGlMultiSelectionChange.bind(c(c(e)))),e._eventHandler.subscribe(6,e._webGlDockComponent.bind(c(c(e)))),e._eventHandler.subscribe(7,e._webGlDockComponentWithPosition.bind(c(c(e)))),e._eventHandler.subscribe(8,e._requestDeleteComponent.bind(c(c(e)))),e._eventHandler.subscribe(13,e._webGlPreviewDockings.bind(c(c(e)))),e._eventHandler.subscribe(14,e._webGlPreviewDockingsWithDrag.bind(c(c(e)))),e._eventHandler.subscribe(63,e._loadConfiguration.bind(c(c(e)))),e._eventHandler.subscribe(71,e._uiRequestConfiguration.bind(c(c(e)))),e._eventHandler.subscribe(64,e._changeCommonComponentParameter.bind(c(c(e)))),e._eventHandler.subscribe(65,e._changeComponentParameter.bind(c(c(e)))),e._eventHandler.subscribe(66,e._changePlanObjectParameter.bind(c(c(e)))),e._eventHandler.subscribe(67,e._requestDeleteComponent.bind(c(c(e)))),e._eventHandler.subscribe(68,e._requestDeleteComponents.bind(c(c(e)))),e._eventHandler.subscribe(69,e._changeUseOfHDGeometry.bind(c(c(e)))),e._eventHandler.subscribe(72,e._loadComponentIntoKernel.bind(c(c(e)))),e._eventHandler.subscribe(73,e._requestPartList.bind(c(c(e)))),e._eventHandler.subscribe(60,e._requestSync.bind(c(c(e)))),e._eventHandler.subscribe(61,e._requestPlanObjectConstruction.bind(c(c(e)))),e._eventHandler.subscribe(81,e._cleanup.bind(c(c(e)))),e._eventHandler.subscribe(82,e._resume.bind(c(c(e)))),e._eventHandler.provide(0,e._getConfigurationData.bind(c(c(e)))),e._eventHandler.provide(1,e._getGlobalParameters.bind(c(c(e)))),e._eventHandler.provide(2,e._getPartList.bind(c(c(e)))),e._eventHandler.provide(3,e._getConfigurationHash.bind(c(c(e)))),e}return l(t,K),a(t,[{key:"_cleanup",value:function(){this._kernelContainer.unregisterConfiguratorCallback(this)}},{key:"_resume",value:function(){this._kernelContainer.registerConfiguratorCallback(this)}},{key:"_loadSuccess",value:function(){var e=this;R.start("kernel_is_ready"),L.kernelInstance?setTimeout(function(){return e.isReady()},0):(window.ConfiguratorKernel(this._kernelContainer),window.ConfiguratorKernel=null),this._eventHandler.dispatch(23)}},{key:"_loadError",value:function(){this._eventHandler.dispatch(24)}},{key:"_webGlSelectedComponent",value:function(e){this._updateComponentDependencies(e)}},{key:"_webGlSelectionCancel",value:function(e){this._updatePlanObjectDependencies(e)}},{key:"_uiRequestConfiguration",value:function(e){var t=this._kernelInstance.getSerializedConfiguration(e);Se.finishOperation(1,t)}},{key:"_updateComponentParameters",value:function(e){var t=Y(this._kernelInstance.getComponentParameters(e)),n=Y(this._kernelInstance.getComponent(e));this._eventHandler.dispatch(37,[e,t,n.parameterGroups])}},{key:"_webGlSelectionChange",value:function(e,t){var n=!1,i=[];if(e){var o=Y(this._kernelInstance.getComponent(e));o.componentId=this._kernelInstance.getComponentId(e),o&&o.childIds&&o.childIds.length>0&&(n=!0),i.push(o)}this._eventHandler.dispatch(54,["standard",t,n,i])}},{key:"_webGlMultiSelectionChange",value:function(e,t){var n=this;this._updateCommonComponentDependencies(e);var i=!1,o=!1,a=[];e&&e.forEach(function(e){var r=Y(n._kernelInstance.getComponent(e));r.componentId=n._kernelInstance.getComponentId(e),r&&r.childIds&&r.childIds.length>0&&(i=!0),r.id===t&&(o=!0),a.push(r)}),this._eventHandler.dispatch(54,["multiselect",o,i,a])}},{key:"_updateCommonComponentDependencies",value:function(e){var t=Y(this._kernelInstance.getCommonPlanComponentParameters(this._utilityToLongArray(e))),n=t.parameters,i=t.parameterGroups;this._eventHandler.dispatch(39,[n,e,i])}},{key:"_updateComponentChildren",value:function(e){var t=Y(this._kernelInstance.getPlanComponentPossibleChildren(e));this._eventHandler.dispatch(47,[e,t])}},{key:"_updateComponentDependencies",value:function(e){this._updateComponentParameters(e),this._updateComponentChildren(e)}},{key:"_updatePlanObjectParameters",value:function(e){var t,n=Y(this._kernelInstance.getPlanObjectParameters(e));if(0===n.length){var i=this._kernelInstance.getRootPlanComponentIdFromObjectId(e);n=Y(this._kernelInstance.getComponentParameters(i)),this._eventHandler.dispatch(45),t=Y(this._kernelInstance.getComponent(i))}else this._eventHandler.dispatch(46),t=Y(this._kernelInstance.getPlanObject(e));this._eventHandler.dispatch(44,[e,n,t.parameterGroups])}},{key:"_updatePlanObjectChildren",value:function(e){var t=Y(this._kernelInstance.getPlanObjectPossibleChildren(e));this._eventHandler.dispatch(48,[e,t])}},{key:"_updatePlanObjectDependencies",value:function(e){this._updatePlanObjectParameters(e),this._updatePlanObjectChildren(e)}},{key:"_updateConfigurationHasChildren",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t||(t=Y(this._kernelInstance.getComponent(this._kernelInstance.getRootPlanComponentIdFromObjectId(e))));var n=t.childIds.size?t.childIds.size():t.childIds.length;this._eventHandler.dispatch(56,[n>0])}},{key:"_webGlDockComponent",value:function(e,t,n,i){this._kernelInstance.dockComponent(n,i,e,t),this._eventHandler.dispatch(59)}},{key:"_changeUseOfHDGeometry",value:function(e,t){this._rapiAccess.changeUseOfHDGeometry();var n=e.planObjectId,i=e.lastLoadedRapiId?e.lastLoadedRapiId:this._kernelInstance.getComponentId(n),o=this._kernelInstance.getSerializedConfiguration(n);this._kernelInstance.clearAll(),this._kernelInstance.useHDGeometry(t),Se.finishOperation(3,[o,i])}},{key:"_webGlDockComponentWithPosition",value:function(e,t,n,i,o){this._kernelInstance.dockComponentWithPosition(n,i,e,t,o),this._eventHandler.dispatch(59)}},{key:"_webGlPreviewDockings",value:function(e,t){var n=this;Se.waitFor(4).then(function(i){t&&n._kernelInstance.requestPlanComponentConstruction(i),n._kernelInstance.requestPreviewGeometry(i,e.planObjectId)}),e.lastPossibleChild&&e.lastPossibleChild.isComponent&&this._kernelInstance.loadPlainComponent(10,e.lastPossibleChild.id,e.lastPossibleChild.configuration),e.lastPossibleChild&&e.lastPossibleChild.isItem&&this._kernelInstance.loadFreeFlyingConfiguration(10,e.lastPossibleChild.configuration)}},{key:"_webGlPreviewDockingsWithDrag",value:function(e,t){this._kernelInstance.requestPreviewGeometry(e,t.planObjectId)}},{key:"_loadConfiguration",value:function(e,t){t&&t.id?this._memoryManager.loadingConfiguration(t.id):this._memoryManager.loadingConfigurationString(),this._memoryManager.shouldHardReset()?this._kernelInstance.clearAll():this._kernelInstance.clearScene(),this._kernelInstance.loadConfiguration(9,e,{x:0,y:0,z:0})}},{key:"_getConfigurationData",value:function(e){var t=this;return new Promise(function(n){var i=Y(t._kernelInstance.getPlanObject(e)),o=(new Date).toISOString(),a=t._kernelInstance.getComponentId(e),r=N(a);n({created:o,lastAccess:o,configuration:t._kernelInstance.getSerializedConfiguration(e),configurationHash:t._kernelInstance.getHashOfPlanComponent(e),parts:JSON.stringify(Y(t._kernelInstance.getPartList(e))),rootComponentId:a,width:parseInt(i.bounds.x,10),height:parseInt(i.bounds.z,10),depth:parseInt(i.bounds.y,10),catalog:r,orderable:!1,requestable:!1})})}},{key:"_changeCommonComponentParameter",value:function(e,t,n,i,o,a){"string"==typeof i?this._kernelInstance.setPlanComponentParameters(this._utilityToLongArray(e),t,i):console.warn("tried to set a parameter to a none string value!",i,t,n),this._finishParameterChange(n,o,a),this._updateCommonComponentDependencies(e)}},{key:"_changeComponentParameter",value:function(e,t,n,i,o,a){"string"==typeof i?this._kernelInstance.setComponentParameter(e,t,i):console.warn("tried to set a parameter to a none string value!",i,t,n),this._finishParameterChange(n,o,a),this._updateComponentDependencies(e)}},{key:"_changePlanObjectParameter",value:function(e,t,n,i,o,a){"string"==typeof i?this._kernelInstance.setPlanObjectParameter(e,t,i):console.warn("tried to set a parameter to a none string value!",i,t,n),this._finishParameterChange(n,o,a)}},{key:"_finishParameterChange",value:function(e,t,n){-1===Ue.indexOf(e)?setTimeout(function(){return t()},0):this._eventHandler.dispatch(58,[t,n])}},{key:"_requestDeleteComponent",value:function(e){e&&this._kernelInstance.deleteComponent(e)}},{key:"_requestDeleteComponents",value:function(e){e&&this._kernelInstance.deletePlanComponents(this._utilityToLongArray(e))}},{key:"_calcPrice",value:function(){if(window.__RML__ENV__.initData.useRoomlePrice){var e=Y(this._kernelInstance.getFullPartList());if(e&&e.fullList&&e.fullList.length){var t=e.fullList[0].currencySymbol,n=e.fullList.reduce(function(e,t){return e+(t.count?t.count:0)*(t.price?t.price:0)},0);this._eventHandler.dispatch(49,[t,n])}}}},{key:"_loadComponentIntoKernel",value:function(e){this._kernelInstance.loadComponentDefinition(10,e)}},{key:"_requestPartList",value:function(e){var t=Y(this._kernelInstance.getFullPartList());this._eventHandler.dispatch(55,[t,this._kernelInstance.getHashOfPlanComponent(e.planObjectId)])}},{key:"_requestSync",value:function(e,t){this._eventHandler.dispatch(41,[e,t]),this._kernelInstance.syncPlanObjectToView(e,t)}},{key:"_getGlobalParameters",value:function(e,t){var n=this;return new Promise(function(i){var o=n._kernelInstance.getPlanObjectParameters,a=e;t&&(o=n._kernelInstance.getComponentParameters,a=n._kernelInstance.getRootPlanComponentIdFromObjectId(e)),i(Y(o.apply(n._kernelInstance,[a])))})}},{key:"_getPartList",value:function(){var e=this;return new Promise(function(t){t(Y(e._kernelInstance.getFullPartList()).fullList)})}},{key:"_getConfigurationHash",value:function(e){var t=this;return new Promise(function(n){return n(t._kernelInstance.getHashOfPlanComponent(e.planObjectId))})}},{key:"_requestPlanObjectConstruction",value:function(e){this._kernelInstance.requestPlanObjectConstruction(e)}},{key:"isReady",value:function(){h(s(t.prototype),"isReady",this).call(this),R.end("kernel_is_ready"),R.start("kernel_create_instance"),L.kernelInstance?this._kernelInstance=L.kernelInstance:this._kernelInstance=new this._kernelContainer.Kernel,this._kernelContainer.registerConfiguratorCallback(this),R.end("kernel_create_instance");var e=window.__RML__ENV__.initData,n=e.overrideCountry,i=e.locale;n&&(this._kernelInstance.resetPriceListIds(),this._kernelInstance.addPriceList(n)),q.isProduction||(window.__RML__DEBUG__.Kernel=this._kernelInstance,window.__RML__DEBUG__.KernelContainer=this._kernelContainer,window.__RML__DEBUG__.Helper={convertCObject:Y}),this._kernelInstance.setEnvironmentVariable("language",i),this._unitFormatter.init(this._kernelContainer,this._kernelInstance),this._eventHandler.dispatch(25,[this._kernelContainer,this._kernelInstance]),L.planObjectId&&this.planObjectCreated(-1,L.planObjectId)}},{key:"onLoadComponentError",value:function(e){this._eventHandler.dispatch(38,[e])}},{key:"configurationLoaded",value:function(e,t,n,i,o){Se.finishOperation(4,n),this._kernelInstance.requestPlanObjectConstruction(t);var a=Y(this._kernelInstance.getComponent(n));this._eventHandler.dispatch(40,[t,n,a])}},{key:"componentDefinitionLoaded",value:function(e,t){Se.finishOperation(0,t)}},{key:"componentDefinitionLoadingError",value:function(e,t){Se.failOperation(0,new Error(t))}},{key:"configurationLoadingError",value:function(){var e="Configuration loading error";Se.failOperation(4,new Error(e)),Se.failOperation(2,new Error(e))}},{key:"componentConfigurationUpdated",value:function(e){this._kernelInstance.requestPlanComponentConstruction(e)}},{key:"componentMetaUpdated",value:function(e){var t=Y(this._kernelInstance.getComponent(e));this._eventHandler.dispatch(30,[e,t])}},{key:"componentParameters",value:function(){}},{key:"componentDeleted",value:function(e){this._eventHandler.dispatch(36,[e])}},{key:"requestComponentDimensions",value:function(){}},{key:"planObjectCreated",value:function(e,t){this._eventHandler.dispatch(41,[e,t])}},{key:"planObjectUpdated",value:function(e){var t=Y(this._kernelInstance.getPlanObject(e));this._eventHandler.dispatch(42,[t,!0])}},{key:"planObjectConfigurationUpdated",value:function(e,t,n){var i=Y(this._kernelInstance.getPlanObject(e));this._eventHandler.dispatch(42,[i,!0]),this._updatePlanObjectDependencies(e);var o=Y(this._kernelInstance.getComponent(this._kernelInstance.getRootPlanComponentIdFromObjectId(e)));this._eventHandler.dispatch(30,[o.id,o]);var a=Y(this._kernelInstance.getFullPartList());this._eventHandler.dispatch(55,[a,n]),this._updateConfigurationHasChildren(e,o),this._calcPrice()}},{key:"planObjectDeleted",value:function(){}},{key:"requestPlanObjectDimensions",value:function(){}},{key:"sceneCleared",value:function(){this._eventHandler.dispatch(26)}},{key:"requestExternalMesh",value:function(e,t){var n=this;return new Promise(function(i,o){n._rapiAccess.getMesh(e,Z,t).then(function(a){fetch(new Request(n._dataSyncer.requestAsset(a.url,!0))).then(function(e){return e.arrayBuffer()}).then(function(o){try{n._kernelContainer.addMeshCorto(e,t,new Uint8Array(o)),i()}catch(e){console.error(e),n._eventHandler.dispatch(62),i()}}).catch(function(e){console.error(e),o(e)})},function(e){console.error(e),o(e)})})}},{key:"Editor3dComponentCreated",value:function(e,t,n,i){this._eventHandler.dispatch(29,[e,t,n,i,!1]),i&&i>0&&this._eventHandler.dispatch(35,[e,i,t,n])}},{key:"Editor3dRootComponentCreated",value:function(e,t,n,i){this._eventHandler.dispatch(29,[e,t,n,i,!0])}},{key:"Editor3dBeginConstruction",value:function(e){this._eventHandler.dispatch(28,[e])}},{key:"Editor3dEndConstruction",value:function(e){var t=Y(this._kernelInstance.getComponent(e));this._eventHandler.dispatch(33,[e,t])}},{key:"Editor3dGeometryReady",value:function(e){this._kernelInstance.requestPlanComponentConstruction(e)}},{key:"Editor3dGeometryNotReady",value:function(e){this._eventHandler.dispatch(34,[e])}},{key:"Editor3dPlanObjectConstructionDone",value:function(e){var t=Y(this._kernelInstance.getPlanObject(e)),n=Y(this._kernelInstance.getFullPartList()),i=this._kernelInstance.getHashOfPlanComponent(e),o=this._kernelInstance.getComponentId(t.rootPlanComponentId),a=[t,n.fullList,i,o];Se.finishOperation(2,a),this._eventHandler.dispatch(43,a),this._updatePlanObjectDependencies(e),this._updateConfigurationHasChildren(e),this._calcPrice(),R.end("ui_load_configuration")}},{key:"Editor3dBeginGroup",value:function(){}},{key:"Editor3dEndGroup",value:function(){}},{key:"Editor3dSetMaterial",value:function(){}},{key:"Editor3dLoadMaterial",value:function(){}},{key:"Editor3dAddDockPreview",value:function(e,t){this._eventHandler.dispatch(50,[e,t])}},{key:"Editor3dSetPreviewPointAssociations",value:function(e,t){this._eventHandler.dispatch(51,[t,Y(e)])}},{key:"Editor3dSetPreviewLineAssociations",value:function(e,t){this._eventHandler.dispatch(52,[t,Y(e)])}},{key:"Editor3dPreviewConstructionDone",value:function(e,t){this._eventHandler.dispatch(53,[e,t])}},{key:"Editor3dTranslateBy",value:function(){}},{key:"Editor3dRotateBy",value:function(){}},{key:"Editor3dRotateAround",value:function(){}},{key:"Editor3dAddCube",value:function(){}},{key:"Editor3dAddCubeUVMod",value:function(){}},{key:"Editor3dAddSphere",value:function(){}},{key:"Editor3dAddSphereUVMod",value:function(){}},{key:"Editor3dAddRectangle",value:function(){}},{key:"Editor3dAddRectangleUVMod",value:function(){}},{key:"Editor3dAddMesh",value:function(){}},{key:"Editor3dAddMeshUVMod",value:function(){}},{key:"Editor3dAddMeshUVCoord",value:function(){}},{key:"Editor3dAddCylinder",value:function(){}},{key:"Editor3dAddCylinderUVMod",value:function(){}},{key:"Editor3dAddPrism",value:function(){}},{key:"Editor3dAddPrismUVMod",value:function(){}},{key:"Editor3dAddFittingPoint",value:function(){}},{key:"Editor3dAddFittingLine",value:function(){}},{key:"Editor3dSelectObject",value:function(){}},{key:"Editor3dCopy",value:function(){}},{key:"Editor3dComponentDocked",value:function(e,t,n,i){this._eventHandler.dispatch(35,[e,t,n,i])}},{key:"Editor3dUpdatePlanObjectPosition",value:function(){}},{key:"Editor3dUpdatePlanObjectRotation",value:function(){}},{key:"Editor3dUpdatePlanObjectTransform",value:function(){}},{key:"Editor3dUpdatePlanComponentPosition",value:function(){}},{key:"Editor3dUpdatePlanComponentRotation",value:function(){}},{key:"Editor3dUpdatePlanComponentTransform",value:function(){}},{key:"Editor3dAddBakedMesh",value:function(e,t,n,i,o,a){this._eventHandler.dispatch(31,[e,t,n,i,o,a])}},{key:"Editor3dAddNamedMesh",value:function(e,t,n,i,o,a,r,s){this._eventHandler.dispatch(32,[e,t,n,i,o,a,r,s])}}]),t}();n([i],Ve.prototype,"_eventHandler",void 0),n([i],Ve.prototype,"_unitFormatter",void 0),n([i],Ve.prototype,"_memoryManager",void 0);var Be=function(){function e(){o(this,e),this._listeners={},this._providers={}}return a(e,[{key:"_subscribe",value:function(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}},{key:"subscribe",value:function(e,t){this._subscribe(e,t)}},{key:"dispatch",value:function(e,t){if(this._listeners[e])for(var n=this._listeners[e],i=n.length,o=0;i>o;o++){var a=n[o];a.apply(a,t)}}},{key:"request",value:function(e,t){return"function"==typeof this._providers[e]?this._providers[e].apply(this._providers[e],t):new Promise(function(t,n){return n("No one provides data for: "+e)})}},{key:"provide",value:function(e,t){this._providers[e]||(this._providers[e]=t)}},{key:"unsubscribe",value:function(e,t){if(this._listeners[e])for(var n=this._listeners[e],i=n.length,o=0;i>o;o++)if(n[o]===t)return n.splice(o,1),i--,void o--}}]),e}(),je=function e(t){o(this,e);var n=t.component,i=t.resetCamera;this.component=n,this.resetCamera=void 0===i||i},ze=function(e){function t(){var e;return o(this,t),(e=r(this,s(t).apply(this,arguments)))._selectionMode="standard",e._selectedComponents=new Map,e}return l(t,v),a(t,[{key:"check",value:function(e){"standard"===this._selectionMode&&this._checkStandard(e),"multiselect"===this._selectionMode&&this._checkMulti(e)}},{key:"cancelSelection",value:function(){var e=this;0!==this._selectedComponents.size&&this._selectedComponents.forEach(function(t,n){t.deselect(),e._selectedComponents.delete(n),e.dispatchEvent(1,new je({component:t}))})}},{key:"_checkStandard",value:function(e){var t=this;if(this._selectedComponents.has(e.roomleId))return this._selectedComponents.delete(e.roomleId),void this.dispatchEvent(1,new je({component:e}));this._selectedComponents.size>0&&this._selectedComponents.forEach(function(e,n){t._selectedComponents.delete(n),t.dispatchEvent(1,new je({component:e,resetCamera:!1}))}),this._selectedComponents.set(e.roomleId,e),this.dispatchEvent(0,new je({component:e}))}},{key:"_checkMulti",value:function(e){if(this._selectedComponents.has(e.roomleId))return this._selectedComponents.delete(e.roomleId),void this.dispatchEvent(1,new je({component:e,resetCamera:0===this._selectedComponents.size}));this._selectedComponents.set(e.roomleId,e),this.dispatchEvent(0,new je({component:e}))}},{key:"setSelectionMode",value:function(e){this._selectionMode=e}},{key:"getSelectionMode",value:function(){return this._selectionMode}},{key:"hasSelection",value:function(){return this._selectedComponents.size>0}},{key:"getSelectedRuntimeComponentIds",value:function(){var e=[];return this._selectedComponents.forEach(function(t){return e.push(t.roomleId)}),e}}]),t}(),qe=function(e){function t(){return o(this,t),r(this,s(t).apply(this,arguments))}return l(t,M),t}(),Ne=function(e){function t(){return o(this,t),r(this,s(t).apply(this,arguments))}return l(t,Q),a(t,[{key:"generateMesh",value:function(e,t,n,i,o){var a=this._generateGeometry(e,t,n,i,o);return new THREE.Mesh(a,this._previewMaterial)}},{key:"clear",value:function(){this._waitingForMaterials=[]}}]),t}(),We=[new U("event-handler",Be),new U("kernel-access",Ve),new U("logger",F),new U("ui-api",Ae),new U("rapi-access",X),new U("script-loader",D),new U("unit-formatter",De),new U("web-gl",xe),new U("camera-control-3d",C),new U("camera-control",G),new U("configurator-context",e),new U("configurator-input-manager",qe),new U("dom-helper",O),new U("selection-handler",ze),new U("data-syncer",A),new U("selection-handler",ze),new U("configurator-mesh-generator",Ne),new U("configurator-ui-callbacks",function e(){o(this,e),this.onKernelIsReady=function(){},this.onUpdateParameters=function(e){},this.onUpdatePossibleChildren=function(e,t){},this.onUpdatePrice=function(e,t){},this.onSelectionChange=function(e,t,n,i){},this.onSelectionCancel=function(){},this.onPartListUpdate=function(e,t){},this.onBoundsUpdate=function(e){},this.onLoadConfiguration=function(){},this.onConfigurationReady=function(e,t,n){},this.onOpenTag=function(e){},this.onOpenAddOns=function(){},this.onClickOutside=function(){},this.onNoDockingsAvailable=function(){},this.onUiIntersectionChange=function(e){},this.onZoomChange=function(e,t){},this.onDimensionsVisibilityChange=function(e){},this.onErrorDueToOffline=function(e){},this.onError=function(e){},this.onDockingsPreviewRemoved=function(){},this.onConfigurationHasChildren=function(e){},this.onTrackTiming=function(e,t,n,i){},this.onUserInitiatedDockDone=function(){},this.onAddonPlusHover=function(){},this.onAddonPlusShown=function(){},this.onContentProblem=function(e){},this.onSyncStarted=function(){},this.onSyncDone=function(){},this.onOpenFloorMaterials=function(){},this.onOpenPartList=function(){},this.onComponentLoadError=function(e){},this.onConfigurationLoadError=function(){},this.onChangeTypeChangeTag=function(e){},this.onRemoveTypeChangeTag=function(e){},this.onConfigurationLabelChange=function(e,t,n){},this.onMemoryCorruption=function(){}})];!function(e){function t(){return o(this,t),r(this,s(t).apply(this,arguments))}l(t,V),a(t,[{key:"setupDependencies",value:function(){B.setup(We),this.lookup("ui-api"),this.lookup("kernel-access"),this.lookup("rapi-access"),this.lookup("script-loader"),this.lookup("web-gl"),this.lookup("logger")}},{key:"pause",value:function(){this.lookup("web-gl").stopRenderLoop()}},{key:"cleanUpGlobals",value:function(){delete window.RoomleConfigurator}},{key:"cleanUpDependencies",value:function(){var e=this.lookup("script-loader"),t=this.lookup("rapi-access"),n=this.lookup("web-gl"),i=this.lookup("dom-helper"),o=this.lookup("scene-helper");e&&e.cleanUp(),t&&t.cleanUp(),n&&n.cleanUp(),i&&i.cleanUp(),o&&o.cleanUp()}},{key:"setupGlobals",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=window.__RML__ENV__.initData.locale,n=e.kernelInstance,i=e.kernelContainer,o=e.planObjectId;L.init({locale:t,kernelInstance:n,kernelContainer:i,planObjectId:o})}},{key:"getApi",value:function(){return this.lookup("ui-api")}},{key:"bootFinished",value:function(){}}])}()}}});
//# sourceMappingURL=configurator.legacy.js.map
