System.register(["./chunk-eb2e1ffb.legacy.js","./chunk-4c9a4d80.legacy.js","./chunk-c559da42.legacy.js","./chunk-4fdbef5b.legacy.js","./chunk-8fb04a5d.legacy.js"],function(e,t){var n,i,r,a,o,s,c,h,u,l,d,p,_,f,m,g,v,y,w,E,b;return{setters:[function(e){n=e.a,i=e.b},function(e){r=e.a,a=e.c,o=e.d,s=e.e,c=e.b,h=e.g},function(e){u=e.u,l=e.y,d=e.v,p=e.x,_=e.A,f=e.l,m=e.f,g=e.p,v=e.B,y=e.r,w=e.C},function(e){E=e.a},function(e){b=e.a}],execute:function(){var e=function(e){function t(){return r(this,t),a(this,o(t).apply(this,arguments))}return s(t,u),t}(),t=[new _("script-loader",p),new _("dom-helper",d),new _("glb-input-manager",e),new _("logger",l)],k=function(e){function t(){var e;return r(this,t),(e=a(this,o(t).apply(this,arguments))).shouldIgnoreStandardBehavior=!1,e}return s(t,f),c(t,[{key:"adjust",value:function(e,t,n,i,r){var a=new THREE.Vector3(-e.x/2,0,-e.z/2),o=new THREE.Vector3(e.x/2,e.y,e.z/2);this._boundingBox=new THREE.Box3(a,o);var s=new THREE.Euler(-Math.PI/2+i,n,0,"ZYX"),c=(new THREE.Quaternion).setFromEuler(s);this._camera.updateProjectionMatrix(),this._camera.quaternion.copy(c),this._camera.position.copy(t)}},{key:"_setDistanceAndRangesBasedOnBounds",value:function(e,n,i){var r=h(o(t.prototype),"_setDistanceAndRangesBasedOnBounds",this).call(this,e,n,i);return this.maxDistance=1.1*r,r}},{key:"_update",value:function(e){this.shouldIgnoreStandardBehavior?this._saveYawAndPitch():h(o(t.prototype),"_update",this).call(this,e)}},{key:"animateCamera",value:function(e){return!!this.shouldIgnoreStandardBehavior||h(o(t.prototype),"animateCamera",this).call(this,e)}}]),t}(),L=function(e){function t(e,n){var i;return r(this,t),(i=a(this,o(t).call(this,e,n)))._ambientLight=new THREE.AmbientLight(16777215,1.1),i._areaLight=new THREE.RectAreaLight(16767899,void 0,10,10),i._areaLight.castShadow=!0,i._areaLight.matrixAutoUpdate=!0,i._areaLight.intensity=1e3/(i._areaLight.width*i._areaLight.height),i._areaLight.position.set(5,4,5),i._areaLight.lookAt(new THREE.Vector3(0,0,0)),i._areaLight.visible=!0,i.addToScene(),i}return s(t,m),c(t,[{key:"addToScene",value:function(){this._scene.add(this._ambientLight)}},{key:"removeFromScene",value:function(){this._scene.remove(this._ambientLight)}},{key:"reload",value:function(){this.removeFromScene(),this.addToScene()}},{key:"showGUI",value:function(){}}]),t}(),C=function(e){function t(e){var n;return r(this,t),(n=a(this,o(t).call(this,e,g.GLB,"3D",!0)))._itemsCount=0,n._standardSceneBackgroundColor=n._scene.background,n._lightSetting=new L(n._scene),n}return s(t,E),c(t,[{key:"createCameraControl",value:function(e){this._cameraControl=new k(this._getInputManager(),this._domHelper.element,new THREE.Vector3(-1,1,1))}},{key:"_getInputManager",value:function(){return this._glbInputManager}},{key:"loadGLB",value:function(e){var t=this,n=1>=arguments.length||void 0===arguments[1]||arguments[1];return this.clearScene(),new Promise(function(i,r){t._loadGLB(e,new THREE.Vector3(0,0,0),0,new THREE.Vector3(1,1,1)).then(function(e){if(t._scene.add(e),n){var r=t._domHelper.getClientDimensions(),a=r.x,o=r.y,s=(new THREE.Box3).setFromObject(e),c=s.getSize(new THREE.Vector3),h=s.getCenter(new THREE.Vector3);t._cameraControl instanceof k&&(t._cameraControl.updateToBounds(c,a,o,!1,!0,h),t._cameraControl.reset(c,a,o,h,-15,0)),t._requestRender()}i()})})}},{key:"preparePerspectiveImage",value:function(e,t,n){var i=this;return new Promise(function(r,a){t||(t=1e3),n||(n=1e3),e||((e=new THREE.WebGLRenderer({antialias:!0})).setSize(t,n),e.gammaInput=!0,e.gammaOutput=!0,e.autoClear=!1,e.shadowMap.enabled=!0,e.shadowMap.type=THREE.BasicShadowMap,e.toneMapping=THREE.Uncharted2ToneMapping,e.toneMappingWhitePoint=6,e.toneMappingExposure=3);var o=i._cameraControl.getCamera().clone();o instanceof THREE.PerspectiveCamera&&(o.aspect=t/n,o.updateProjectionMatrix()),i._lightSetting.removeFromScene();var s=new b(i._scene);e.render(i._scene,o);var c=e.domElement.toDataURL();e.domElement.toBlob(function(e){r({image:c,width:t,height:n,blob:e})},"image/png"),s.removeFromScene(),i._lightSetting.addToScene()})}},{key:"adjustCamera",value:function(e,t,n,i){if(this._cameraControl instanceof k){var r=(new THREE.Box3).setFromObject(this._scene).getSize(new THREE.Vector3);this._cameraControl.adjust(r,e,t,n,i),this._requestRender()}}},{key:"onStart",value:function(e){this._itemsCount=e,this._scene.background=null,this._cameraControl instanceof k&&(this._cameraControl.shouldIgnoreStandardBehavior=!0)}},{key:"onElementFinished",value:function(e){this._itemsCount,Math.round(100/this._itemsCount*e)}},{key:"onFinished",value:function(e){this._scene.background=this._standardSceneBackgroundColor,this._cameraControl instanceof k&&(this._cameraControl.shouldIgnoreStandardBehavior=!1)}}]),t}();n([i],C.prototype,"_glbInputManager",void 0);var R=function(){function e(t,n,i){r(this,e),this._prefix="https://furniture.roomle.com/3d/glb/",this._listeners=new Set,this._finishedItems=0,this._sceneManager=t,this._renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this._width=n,this._height=i,this._renderer.setSize(n,i),this._renderer.setClearColor(16777215,0),this._renderer.gammaInput=!0,this._renderer.gammaOutput=!0}return c(e,[{key:"addListener",value:function(e){this._listeners.add(e)}},{key:"removeListener",value:function(e){this._listeners.delete(e)}},{key:"start",value:function(e){var t=this;return this._entries=[],e.forEach(function(e){t._entries.push(t._transform(e))}),this._finishedItems=0,this._listeners.forEach(function(e){return e.onStart(t._entries.length)}),this._zip=new window.JSZip,this._doNextEntry(),new Promise(function(e,n){t._resolve=e,t._reject=n})}},{key:"_transform",value:function(e){return{name:e.path.replace(".glb",".png"),url:this._prefix+e.path,position:new THREE.Vector3(e.camera.position.x,e.camera.position.z,-e.camera.position.y),fov:2*e.camera.fieldOfView,yaw:e.camera.rotation.z,pitch:e.camera.rotation.x}}},{key:"_doNextEntry",value:function(){var e=this;0===this._entries.length?(this._listeners.forEach(function(t){return t.onFinished(e._zip)}),this._resolve(this._zip)):this._processEntry(this._entries[0])}},{key:"_processEntry",value:function(e){var t=this;this._sceneManager.loadGLB(e.url,!1).then(function(){t._sceneManager.adjustCamera(e.position,e.yaw,e.pitch,e.fov),t._sceneManager.preparePerspectiveImage(t._renderer,t._width,t._height).then(function(n){t._entryFinished(e,n)})})}},{key:"_entryFinished",value:function(e,t){var n=this,i=this._entries.indexOf(e);i>-1&&this._entries.splice(i,1),this._finishedItems++,this._listeners.forEach(function(e){return e.onElementFinished(n._finishedItems)}),this._zip.file(e.name,t.blob),this._doNextEntry()}}]),e}(),j=function(){function e(){r(this,e)}return c(e,[{key:"init",value:function(e){return this._domHelper.setDomElement(e),new Promise(this._initPromiseCallback.bind(this))}},{key:"_initPromiseCallback",value:function(e,t){var n=this;this._scriptLoader.fetch("static/three/lib/rthree.js",{id:"three-lib"}).then(function(){var t=n._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader"}),i=n._scriptLoader.fetch("static/three/Tween.js",{id:"tween-js"});Promise.all([t,i]).then(function(){n._sceneManager=new C({left:0,top:1,right:1,bottom:0}),n.enableHD(),e()})})}},{key:"enableHD",value:function(){var e=this;return new Promise(function(t,n){var i=function(){e._sceneManager.enableHD(),t()};Promise.all([e._scriptLoader.fetch("static/three/lib/postprocessing/EffectComposer.js",{id:"effect-composer-js"}),e._scriptLoader.fetch("static/three/lib/lights/RectAreaLightUniformsLib.js",{id:"rect-area-light-uniforms-lib-js"}),e._scriptLoader.fetch("static/three/lib/postprocessing/ShaderPass.js",{id:"shader-pass-js"}),e._scriptLoader.fetch("static/three/lib/postprocessing/RenderPass.js",{id:"render-pass-js"}),e._scriptLoader.fetch("static/three/lib/shaders/CopyShader.js",{id:"copy-shader-js"})]).then(function(){e._scriptLoader.fetch("static/three/pixotron.min.js",{id:"pixotron-js"}).then(i,n)},n)})}},{key:"loadGLB",value:function(e){return this._sceneManager.loadGLB(e)}},{key:"preparePerspectiveImage",value:function(){return this._sceneManager.preparePerspectiveImage()}},{key:"processRenderList",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:320,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:320,r=JSON.parse(e);this._scriptLoader.fetch("static/jszip/lib/jszip.js",{id:"jszip-js"}).then(function(){var e=new R(t._sceneManager,n,i);e.addListener(t._sceneManager),e.start(r.items).then(function(n){n.generateAsync({type:"blob"}).then(function(n){var i=document.createElement("a");i.href=URL.createObjectURL(n),i.download="content.zip",i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),e.removeListener(t._sceneManager)})})})}},{key:"updateSize",value:function(){this._sceneManager.updateCamera()}}]),e}();n([i],j.prototype,"_domHelper",void 0),n([i],j.prototype,"_scriptLoader",void 0),function(e){function n(){var e;return r(this,n),e=a(this,o(n).call(this)),y.start("loadingTime"),e}s(n,v),c(n,[{key:"setupGlobals",value:function(){}},{key:"setupDependencies",value:function(){w.setup(t),this.lookup("logger")}},{key:"cleanUpGlobals",value:function(){throw new Error("Method not implemented.")}},{key:"cleanUpDependencies",value:function(){throw new Error("Method not implemented.")}}]),c(n,[{key:"bootFinished",value:function(){this._viewer=new j,window.RoomleGLBViewer||(window.RoomleGLBViewer=this._viewer)}},{key:"pause",value:function(){throw new Error("Method not implemented.")}},{key:"getApi",value:function(){return this._viewer}}])}()}}});
//# sourceMappingURL=glb-viewer.legacy.js.map
