System.register(["./chunk-f6f7cfde.legacy.js","./chunk-0442fe9b.legacy.js","./chunk-26f4dd78.legacy.js","./chunk-e5bfbe75.legacy.js","./chunk-c97bfe47.legacy.js","./chunk-5093c644.legacy.js","./chunk-301242e6.legacy.js","./chunk-1180694c.legacy.js","./chunk-213d6596.legacy.js","./chunk-0017aacc.legacy.js","./chunk-58ecf2c1.legacy.js","./chunk-c23256c6.legacy.js"],function(e,t){var n,i,o,s,r,a,l,h,c,d,_,u,p,m,g,f,C,v,b,w,y,E,I,P,S,k,H,R,L,M,T,O,x,A,D,U,V,F,j,B,G,q,z,N,K,W,Q,X,Y,Z,J,$,ee,te,ne;return{setters:[function(e){n=e.a,i=e.b,o=e.c,s=e.d},function(){},function(e){r=e.a,a=e.b,l=e.c,h=e.d,c=e.e,d=e.f,_=e.g,u=e.h,p=e.i,m=e.j,g=e.k,f=e.l,C=e.m,v=e.n,b=e.o,w=e.p,y=e.q,E=e.r,I=e.s,P=e.t,S=e.u,k=e.v,H=e.w,R=e.x,L=e.y,M=e.z,T=e.A,O=e.B,x=e.C},function(e){A=e.a,D=e.b,U=e.c,V=e.d,F=e.e,j=e.f},function(e){B=e.a,G=e.b},function(e){q=e.a,z=e.b,N=e.c,K=e.d,W=e.e,Q=e.f,X=e.g},function(e){Y=e.a,Z=e.b},function(e){J=e.a},function(e){$=e.a},function(e){ee=e.a},function(e){te=e.a},function(e){ne=e.default}],execute:function(){const ie=function(e){return e.validRange&&"string"==typeof e.validRange.type},oe=function(e){return e.validValues&&e.validValues.length>0},se=function(e){return"length"===e.unitType||"area"===e.unitType},re=function(e){return"Material"===e.type};let ae={InchFeet:null,MM:null,CM:null},le={NoUnitString:null,LongUnitString:null,ShortUnitString:null};const he=["material"],ce="tried to set a parameter to a none string value!";class de extends Y{constructor(e){super(e,1),this.muteKernelCallbacks=!1,this.listOfVariants=((e,t)=>void 0),this.listOfVariantsError=(()=>void 0),r.addMeta("kernel_is_ready",{isWasm:this._useWASM}),a.kernelInstance?(this._kernelContainer=a.kernelContainer,setTimeout(()=>this._loadSuccess(),0)):this._scriptLoader.fetch(this._kernelPath,{id:"kernel"}).then(this._loadSuccess.bind(this),this._loadError.bind(this))}_loadSuccess(){r.start("kernel_is_ready"),a.kernelInstance?setTimeout(()=>this.isReady(),0):(window.ConfiguratorKernel(this._kernelContainer),window.ConfiguratorKernel=null)}_loadError(){this._configuratorKernelAccessCallback.loadError()}selectedComponent(e){this._updateComponentDependencies(e)}uiRequestConfiguration(e){const t=this._kernelInstance.getSerializedConfiguration(e);l.finishOperation(1,t)}_updateComponentParameters(e){let t=this._kernelInstance.getComponentParameters(e);const n=this._kernelInstance.getComponent(e);this._configuratorKernelAccessCallback.updateParameters(t,n.parameterGroups,e,1)}selectionChange(e,t){let n=!1,i=[];if(e){let t=this._kernelInstance.getComponent(e);t.componentId=this._kernelInstance.getComponentId(e),t&&t.childIds&&t.childIds.length>0&&(n=!0),i.push(t)}this._configuratorUiCallbacks.onSelectionChange("standard",t,n,i)}multiSelectionChange(e,t){this._updateCommonComponentDependencies(e);let n=!1,i=!1,o=[];e&&e.forEach(e=>{let s=this._kernelInstance.getComponent(e);s.componentId=this._kernelInstance.getComponentId(e),s&&s.childIds&&s.childIds.length>0&&(n=!0),s.id===t&&(i=!0),o.push(s)}),this._configuratorUiCallbacks.onSelectionChange("multiselect",i,n,o)}_updateCommonComponentDependencies(e){const{parameters:t,parameterGroups:n}=this._kernelInstance.getCommonPlanComponentParameters(this._utilityToLongArray(e));this._configuratorKernelAccessCallback.updateParameters(t,n,e,2)}_updateComponentChildren(e){const t=this._kernelInstance.getPlanComponentPossibleChildren(e);this._configuratorKernelAccessCallback.updatePossibleChildren(e,t,1)}_updateComponentDependencies(e){this._updateComponentParameters(e),this._updateComponentChildren(e)}_updatePlanObjectParameters(e){let t,n=this._kernelInstance.getPlanObjectParameters(e);if(0===n.length){let i=this._kernelInstance.getRootPlanComponentIdFromObjectId(e);n=this._kernelInstance.getComponentParameters(i),this._enableRootComponentParametersAsGlobal(),t=this._kernelInstance.getComponent(i)}else this._configuratorContext.rootComponentParametersAsGlobal=!1,t=this._kernelInstance.getPlanObject(e);this._configuratorKernelAccessCallback.updateParameters(n,t.parameterGroups,e,0)}_enableRootComponentParametersAsGlobal(){this._configuratorContext.selectedRuntimeComponentId||(this._configuratorContext.rootComponentParametersAsGlobal=!0)}_updatePlanObjectChildren(e){const t=this._kernelInstance.getPlanObjectPossibleChildren(e);this._configuratorKernelAccessCallback.updatePossibleChildren(e,t,0)}updatePlanObjectDependencies(e){this._updatePlanObjectParameters(e),this._updatePlanObjectChildren(e)}_updateConfigurationHasChildren(e,t=null){t||(t=this._kernelInstance.getComponent(this._kernelInstance.getRootPlanComponentIdFromObjectId(e)));const n=t.childIds.size?t.childIds.size():t.childIds.length;this._configuratorUiCallbacks.onConfigurationHasChildren(n>0)}dockComponent(e,t,n,i){const o=this._kernelInstance.getComponentId(n),s=this._kernelInstance.getComponentId(e);this._kernelInstance.dockComponent(n,i,e,t),this._configuratorUiCallbacks.onUserInitiatedDockDone(o,i,s,t,null)}changeUseOfHDGeometry(e,t){this._rapiAccess.changeUseOfHDGeometry();const n=e.planObjectId,i=e.lastLoadedRapiId?e.lastLoadedRapiId:this._kernelInstance.getComponentId(n),o=this._kernelInstance.getSerializedConfiguration(n);this._kernelInstance.clearAll(),this._kernelInstance.useHDGeometry(t),l.finishOperation(3,[o,i])}webGlPreviewDockings(e,t){l.waitFor(4).then(n=>{t&&this._kernelInstance.requestPlanComponentConstruction(n),this._kernelInstance.requestPreviewGeometry(n,e.planObjectId)}),e.lastPossibleChild&&e.lastPossibleChild.isComponent&&this._kernelInstance.loadPlainComponent(h,e.lastPossibleChild.id,e.lastPossibleChild.configuration),e.lastPossibleChild&&e.lastPossibleChild.isItem&&this._kernelInstance.loadFreeFlyingConfiguration(h,e.lastPossibleChild.configuration)}previewDockingsWithDrag(e,t){this._kernelInstance.requestPreviewGeometry(e,t)}loadConfiguration(e,t){t&&t.id?this._memoryManager.loadingConfiguration(t.id):this._memoryManager.loadingConfigurationString(),this._memoryManager.shouldHardReset()?this._kernelInstance.clearAll():this._kernelInstance.clearScene(),this._kernelInstance.loadConfiguration(c,e,{x:0,y:0,z:0})}getConfigurationData(e){return new Promise(t=>{const n=this._kernelInstance.getPlanObject(e),i=(new Date).toISOString(),o=this._kernelInstance.getComponentId(e),s=q(o);t({created:i,lastAccess:i,configuration:this._kernelInstance.getSerializedConfiguration(e),configurationHash:this._kernelInstance.getHashOfConfiguration(e),parts:JSON.stringify(this._kernelInstance.getPartList(e)),rootComponentId:o,width:n.bounds.x,height:n.bounds.z,depth:n.bounds.y,catalog:s,orderable:!1,requestable:!1})})}changeCommonComponentParameter(e,t,n,i,o,s){"string"==typeof i?this._kernelInstance.setPlanComponentParameters(this._utilityToLongArray(e),t,i):console.warn(ce,i,t,n),this._finishParameterChange(n,o,s),this._updateCommonComponentDependencies(e)}changeComponentParameter(e,t,n,i,o,s){"string"==typeof i?this._kernelInstance.setComponentParameter(e,t,i):console.warn(ce,i,t,n),this._finishParameterChange(n,o,s),this._updateComponentDependencies(e)}changePlanObjectParameter(e,t,n,i,o,s){"string"==typeof i?this._kernelInstance.setPlanObjectParameter(e,t,i):console.warn(ce,i,t,n),this._finishParameterChange(n,o,s)}_finishParameterChange(e,t,n){-1===he.indexOf(e)?setTimeout(()=>t(),0):this._configuratorKernelCallbackListener.forEach(e=>e.finishParameterChange(t,n))}requestDeleteComponents(e){e&&this._kernelInstance.deletePlanComponents(this._utilityToLongArray(e))}_calcPrice(){const e=new Map;if(window.__RML__ENV__.initData.useRoomlePrice){let e=this._kernelInstance.getFullPartList();if(e&&e.fullList&&e.fullList.length){const t=e.fullList[0].currencySymbol,n=e.fullList.reduce((e,t)=>e+(t.count?t.count:0)*(t.price?t.price:0),0);this._configuratorUiCallbacks.onUpdatePrice(t,n)}}else if(window.__RML__ENV__.initData.usePriceService){let t=this._kernelInstance.getFullPartList();if(t&&t.fullList&&t.fullList.length){const i=t.fullList.reduce((t,n)=>{const i=z(n);return i&&(e.set(i,n),t.push(i)),t},[]);return new Promise((o,s)=>{this._rapiAccess.getPrices(i).then(i=>{if(!i.length)return s(new Error("prices are empty"));const r=n(i,"priceId");let a=0;return t.fullList.forEach(e=>{const t=z(e);if(!r.has(t))return void console.warn("PriceId: "+t+" has no corresponding kernel-part");const{price:n,currencySymbol:i}=r.get(t);e.price=n,e.currencySymbol=i,a+=n*e.count}),this._configuratorUiCallbacks.onUpdatePrice(i[0].currencySymbol,a),o({totalSum:a,partMap:e})},e=>{console.error(e),s(e)})})}}return Promise.resolve({totalSum:0,partMap:e})}loadComponentIntoKernel(e){this._kernelInstance.loadComponentDefinition(10,e)}requestPartListAndUpdatePricesOfParts(e,t){return new Promise((t,n)=>{let i=this._kernelInstance.getFullPartList();e||(e=this._kernelInstance.getHashOfConfiguration(this._configuratorContext.planObjectId));const o=i.fullList;this.addUiDataToPartList(o,e),this._calcPrice().then(({partMap:n})=>{o.forEach(e=>{const t=z(e);if(!t)return;if(!n.has(t))return;const{price:i,currencySymbol:o}=n.get(t);i&&(e.price=i,e.currencySymbol=o)}),this._configuratorUiCallbacks.onPartListUpdate(o,e),t()},n)})}addUiDataToPartList(e,t){const n=[];return e.forEach(e=>{const t=this._rapiAccess.peekComponent(e.componentId);!t||e.labelIsCalculated&&e.label||(e.label=t.label),e.parameters.forEach(e=>{if(this._unitFormatter.formatPartListParameter(e),re(e)){const t=this._rapiAccess.peekMaterial(e.value);t?e.valueLabel=t.label||t.name||e.value:-1===n.indexOf(e.value)&&n.push(e.value)}})}),n.length&&this._rapiAccess.getMaterials(n).then(e=>{const n=this._lastPartListHash!==t;Array.isArray(e)&&e.length&&n&&(this._lastPartListHash=t,this.requestPartListAndUpdatePricesOfParts())}),e}requestSync(e,t){this.planObjectCreated(e,t),this._kernelInstance.syncPlanObjectToView(e,t)}getGlobalParameters(e,t){return new Promise(n=>{let i=this._kernelInstance.getPlanObjectParameters,o=e;t&&(i=this._kernelInstance.getComponentParameters,o=this._kernelInstance.getRootPlanComponentIdFromObjectId(e)),n(i.apply(this._kernelInstance,[o]))})}getPartList(){return new Promise(e=>{e(this._kernelInstance.getFullPartList().fullList)})}getConfigurationHash(e){return new Promise(t=>t(this._kernelInstance.getHashOfConfiguration(e.planObjectId)))}requestPlanObjectConstruction(e){this._kernelInstance.requestPlanObjectConstruction(e)}isReady(){super.isReady(),r.end("kernel_is_ready"),r.start("kernel_create_instance"),a.kernelInstance?this._kernelInstance=a.kernelInstance:this._kernelInstance=new this._kernelContainer.Kernel,this._kernelContainer.registerConfiguratorCallback(this),r.end("kernel_create_instance");const{overrideCountry:e,locale:t}=window.__RML__ENV__.initData;e&&(this._kernelInstance.resetPriceListIds(),this._kernelInstance.addPriceList(e)),N.isProduction||(window.__RML__DEBUG__.Kernel=this._kernelInstance,window.__RML__DEBUG__.KernelContainer=this._kernelContainer,window.__RML__DEBUG__.Helper={convertCObject:d}),this._kernelInstance.setEnvironmentVariable("language",t),this._unitFormatter.init(this._kernelContainer),this._configuratorKernelAccessCallback.isReady(),this._configuratorUiCallbacks.onConfiguratorKernelIsReady(this._kernelContainer,this._kernelInstance),a.planObjectId&&this.planObjectCreated(-1,a.planObjectId)}onLoadComponentError(e){this._configuratorUiCallbacks.onComponentLoadError(e)}configurationLoaded(e,t,n,i,o){l.finishOperation(4,n),this._configuratorKernelCallbackListener.forEach(s=>s.configurationLoaded(e,t,n,i,o))}componentDefinitionLoaded(e,t){l.finishOperation(0,t)}componentDefinitionLoadingError(e,t){l.failOperation(0,new Error(t))}configurationLoadingError(){const e="Configuration loading error";l.failOperation(4,new Error(e)),l.failOperation(2,new Error(e))}componentConfigurationUpdated(e,t){this._configuratorKernelCallbackListener.forEach(n=>n.componentConfigurationUpdated(e,t)),this._kernelInstance.requestPlanComponentConstruction(e)}setActiveGroupInView(e){this._kernelInstance.setActiveGroupInView(e)}componentParameters(){}requestComponentDimensions(){}planObjectCreated(e,t){this._configuratorKernelCallbackListener.forEach(n=>n.planObjectCreated(e,t))}planObjectUpdated(e){const t=this._kernelInstance.getPlanObject(e);this._onBoundsUpdate(t),this._configuratorKernelCallbackListener.forEach(e=>e.planObjectUpdated(t))}planObjectConfigurationUpdated(e,t,n){this.updatePlanObjectDependencies(e);let i=this._kernelInstance.getComponent(this._kernelInstance.getRootPlanComponentIdFromObjectId(e));this._configuratorKernelCallbackListener.forEach(i=>i.planObjectConfigurationUpdated(e,t,n));const o=this._kernelInstance.getPlanObject(e);return this._onBoundsUpdate(o),this._updateConfigurationHasChildren(e,i),this.requestPartListAndUpdatePricesOfParts(n)}_onBoundsUpdate(e){if(!e.boxForMeasurement)return;let t={width:this._unitFormatter.formatMMValueToUnitString(e.boxForMeasurement.size.x),height:this._unitFormatter.formatMMValueToUnitString(e.boxForMeasurement.size.z),depth:this._unitFormatter.formatMMValueToUnitString(e.boxForMeasurement.size.y)};this._configuratorUiCallbacks.onBoundsUpdate(t)}planObjectDeleted(){}requestPlanObjectDimensions(){}requestExternalMesh(e,t){return new Promise((n,i)=>{this._rapiAccess.getMesh(e,K,t).then(o=>{fetch(new Request(this._dataSyncer.requestAsset(o.url,!0))).then(e=>e.arrayBuffer()).then(i=>{try{this._kernelInstance.addMeshCorto(e,t,new Uint8Array(i)),n()}catch(e){console.error(e),this._configuratorUiCallbacks.onMemoryCorruption(),n()}}).catch(e=>{console.error(e),i(e)})},e=>{console.error(e),i(e)})})}Editor3dComponentCreated(e,t,n,i){this._configuratorKernelCallbackListener.forEach(o=>o.Editor3dComponentCreated(e,t,n,i,!1)),i&&i>0&&this._configuratorKernelCallbackListener.forEach(o=>o.Editor3dComponentDocked(e,i,t,n))}Editor3dRootComponentCreated(e,t,n,i){this._configuratorKernelCallbackListener.forEach(o=>o.Editor3dComponentCreated(e,t,n,i,!0))}Editor3dGeometryReady(e){this._kernelInstance.requestPlanComponentConstruction(e)}Editor3dGeometryNotReady(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dGeometryNotReady(e))}Editor3dPlanObjectConstructionDone(e){return this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dPlanObjectConstructionDone(e)),this.updatePlanObjectDependencies(e),this._updateConfigurationHasChildren(e),r.end("ui_load_configuration"),this._calcPrice()}Editor3dBeginGroup(){}Editor3dEndGroup(){}Editor3dSetMaterial(){}Editor3dLoadMaterial(){}Editor3dAddDockPreview(e,t){this._configuratorKernelCallbackListener.forEach(n=>n.Editor3dAddDockPreview(e,t))}Editor3dSetPreviewPointAssociations(e,t){this._configuratorKernelCallbackListener.forEach(n=>n.Editor3dSetPreviewPointAssociations(e,t))}Editor3dSetPreviewLineAssociations(e,t){this._configuratorKernelCallbackListener.forEach(n=>n.Editor3dSetPreviewLineAssociations(e,t))}Editor3dPreviewConstructionDone(e,t){this._configuratorKernelCallbackListener.forEach(n=>n.Editor3dPreviewConstructionDone(e,t))}Editor3dTranslateBy(){}Editor3dRotateBy(){}Editor3dRotateAround(){}Editor3dAddCube(){}Editor3dAddCubeUVMod(){}Editor3dAddSphere(){}Editor3dAddSphereUVMod(){}Editor3dAddRectangle(){}Editor3dAddRectangleUVMod(){}Editor3dAddMesh(){}Editor3dAddMeshUVMod(){}Editor3dAddMeshUVCoord(){}Editor3dAddCylinder(){}Editor3dAddCylinderUVMod(){}Editor3dAddPrism(){}Editor3dAddPrismUVMod(){}Editor3dAddFittingPoint(){}Editor3dAddFittingLine(){}Editor3dSelectObject(){}Editor3dCopy(){}Editor3dUpdatePlanObjectPosition(){}Editor3dUpdatePlanObjectRotation(){}Editor3dUpdatePlanObjectTransform(){}Editor3dUpdatePlanComponentPosition(){}Editor3dUpdatePlanComponentRotation(){}Editor3dUpdatePlanComponentTransform(){}getRuntimeComponentIdOfRootComponent(e){return this._kernelInstance?this._kernelInstance.getRootPlanComponentIdFromObjectId(e):(console.warn("this._kernelInstance not ready now"),0)}getRuntimeComponentId(e){return this._kernelInstance.getComponentId(e)}resume(){this.muteKernelCallbacks||super.resume()}}B([G],de.prototype,"_unitFormatter",void 0),B([G],de.prototype,"_memoryManager",void 0),B([G],de.prototype,"_configuratorKernelAccessCallback",void 0),B([G],de.prototype,"_configuratorContext",void 0);class _e{constructor(e){const{component:t,resetCamera:n}=e;this.component=t,this.resetCamera=void 0===n||n}}const ue=.05,pe=8947848,me=.08;class ge{constructor(e,t){this._addOnSpotIcons=new Map,this.previewGhostEnabled=!1,this.addOnSpotsEnabled=!1,this._state=3,this._camera=e,this._textMaterial=new THREE.MeshStandardMaterial({color:pe});let n=new THREE.Geometry;this._plusText=new THREE.Mesh(n,this._textMaterial),this._plusText.layers.set(4),$.loadFont("static/fonts/rubik_regular_sub.json").then(e=>{this._font=e;let t={font:this._font,size:ue,height:.001,curveSegments:2,bevelEnabled:!0,bevelThickness:.001,bevelSize:.001};this._plusTextGeometry=new THREE.TextGeometry("+",t),this._plusTextGeometry.computeBoundingBox(),this._plusText.geometry=this._plusTextGeometry}),this._plusButtonPromise=new Promise((e,n)=>{t.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader-js"}).then(()=>{(new THREE.GLTFLoader).load(i()+"static/geometry/AddButtonRound.glb",t=>{t&&t.scene&&t.scene.children&&t.scene.children.length>0?(this._onPlusButtonLoaded(t.scene.children[0]),e()):n("loaded scene has no childrens")},e=>{},e=>{console.error(e),n(e)})})})}_onPlusButtonLoaded(e){e&&(this._plusButton=e,this._plusButton.material=this._textMaterial,this._plusButton.layers.set(4),this._plusButton.scale.copy(new THREE.Vector3(me,me,me)))}_performUpdate(e){if(this.addOnSpotsEnabled)for(let e of this._addOnSpotIcons.values())e.forEach(e=>{e.geometry.center();let t=new THREE.Vector3(0,1,0);t.applyQuaternion(this._camera.quaternion),e.up.copy(t),e.lookAt(this._camera.position)})}addAddOnSpots(e,t){Promise.all([this._plusButtonPromise]).then(()=>{this.addOnSpotsEnabled&&this._plusButton&&(this.deleteAddonPointsForComponent(e.roomleId),t.forEach(t=>{let n=this._plusButton.clone();n.name="addOnSpot "+e.roomleId,n.layers.set(7),n.position.copy(this.getPositionForAddOnPosition(new THREE.Vector3(t.position.x,t.position.y,t.position.z))),this._addOnSpotIcons.has(e.roomleId)?this._addOnSpotIcons.get(e.roomleId).push(n):this._addOnSpotIcons.set(e.roomleId,[n]),n.geometry.computeBoundingBox();let i=n.geometry.boundingBox,s=i.getSize(new THREE.Vector3),r=new THREE.BoxGeometry(s.x,s.y,s.z),a=new THREE.Mesh(r,new THREE.MeshStandardMaterial({color:"#FFFFFF",transparent:!0,opacity:0,polygonOffset:!0,polygonOffsetFactor:-1}));a.layers.set(4),a.translateOnAxis(i.getCenter(new THREE.Vector3),1),a.renderOrder=3,a.visible=!0,n.add(a),a.userData={hasListener:!0,priority:3,roomleId:e.roomleId},a.addEventListener("select",()=>{this._onAddonClick&&this._onAddonClick()}),a.addEventListener("hover_on",()=>{o("pointer"),this._configuratorUiCallbacks.onAddonPlusHover()}),a.addEventListener("hover_off",()=>{o("default"),this._configuratorUiCallbacks.onAddonPlusHoverOff()}),e.add(n)}))})}deleteAddonPointsForComponent(e){this.addOnSpotsEnabled&&this._addOnSpotIcons.has(e)&&(this._addOnSpotIcons.get(e).forEach(e=>{e.parent.remove(e)}),this._addOnSpotIcons.delete(e))}getPositionForAddOnPosition(e){let t=new THREE.Vector3;return t.set(e.x/1e3,e.z/1e3,e.y/-1e3),t}update(e=!1){this._performUpdate(e)}changePreviewGhostVisibility(e,t){this.previewGhostEnabled&&(t?(e.add(this._plusText),this._plusText.position.copy((new THREE.Vector3).add(e.boundingBox.getCenter(new THREE.Vector3))),this._plusText.geometry.center()):e.remove(this._plusText))}_changeAddOnSpotVisibility(e){this.addOnSpotsEnabled&&this._addOnSpotsVisible!==e&&(this._addOnSpotsVisible=e)}isAddOnSpotVisible(){return this._addOnSpotsVisible&&this.addOnSpotsEnabled}onAddonClick(e){this._onAddonClick=e}setState(e){1===this._state&&2!==e||1===e&&5===this._state||3!==e&&5===this._state||(4!==e&&1!==e&&5!==e||this._changeAddOnSpotVisibility(!1),3!==e&&2!==e&&0!==e||this._changeAddOnSpotVisibility(!0),this._state=e)}}B([G],ge.prototype,"_configuratorUiCallbacks",void 0);class fe{constructor(e){const{component:t,preview:n,resetCamera:i,type:o,forceRender:s}=e;this.component=t,this.preview=n,this.resetCamera=void 0===i||i,this.type=o||0,this.forceRender=void 0!==s&&s}}class Ce extends _{constructor(e,t,n,i,o){super(),this._debug=!1,this._cameraMoving=!1,this._dragIn=!1,this._creator_=e,this._raycastHelper=new Z(t,n,i),this._addonHelper=o,this._raycastHelper.addEventListener(3,()=>{this._clickOutside()},this),this._selectionHandler.addEventListener(0,({component:e})=>{this.dispatchEvent(8,new fe({component:e})),this._inputManager.setDragEnabled(!0)},this),this._selectionHandler.addEventListener(1,({component:e,resetCamera:t})=>{this._selectionHandler.hasSelection()||this._inputManager.setDragEnabled(!1),this.dispatchEvent(9,new fe({component:e,resetCamera:t}))},this),this._inputManager=i,this._addInputListeners(i)}_addInputListeners(e){e.addEventListener(7,e=>this._interaction(),this),e.addEventListener(8,e=>this._interaction(),this)}addComponentHandlers(e){this._addComponentHandlers(e,e.boundingBoxMesh,{hasListener:!0,priority:1,roomleId:e.roomleId}),e.meshes.forEach(t=>{this._addComponentHandlers(e,t,{hasListener:!0,priority:2,roomleId:e.roomleId})})}addComponentDragInHandler(e){this._dragIn&&(this._addComponentHandlers(e,e.boundingBoxMesh,{hasListener:!0,priority:1,roomleId:e.roomleId}),this._raycastHelper.enableDragIn(e.boundingBoxMesh))}_addComponentHandlers(e,t,n){t.userData.hasListener||(t.userData=n,t.addEventListener("select",()=>this._clickComponent(e)),t.addEventListener("hover_on",t=>this._hoverOn(e,t.attachment.type)),t.addEventListener("hover_off",t=>this._hoverOff(e,t.attachment.type)),t.addEventListener("drag_start",()=>this._dragStart(e)),t.addEventListener("drag",t=>this._drag(e,t.attachment.position)),t.addEventListener("drag_end",t=>this._dragEnd(e,t.attachment.position)))}addPreviewHandlers(e){let t=e.boundingBoxMesh;t.userData.hasListener||(t.userData={hasListener:!0,priority:3,roomleId:e.roomleId},t.addEventListener("select",()=>this._clickPreview(e)),t.addEventListener("hover_on",()=>this._hoverOnPreview(e)),t.addEventListener("hover_off",()=>this._hoverOffPreview(e)))}addPreviewLineHandlers(e){let t=e.boundingLineMesh;t.userData.hasListener||(t.userData={hasListener:!0,priority:4,roomleId:e.roomleId},t.addEventListener("select",()=>this._clickPreviewLine(e)),t.addEventListener("hover_on",t=>this._hoverOnPreviewLine(e,t.attachment.intersection)),t.addEventListener("hover_move",t=>this._hoverMovePreviewLine(e,t.attachment.intersection)),t.addEventListener("hover_off",()=>this._hoverOffPreviewLine(e)))}_clickPreview(e){this._dragStartPosition&&(e.position.copy(this._dragStartPosition),this._dragStartPosition=null),this.dispatchEvent(7,new fe({preview:e}))}_clickPreviewLine(e){this._dragStartPosition&&(e.position.copy(this._dragStartPosition),this._dragStartPosition=null),this.dispatchEvent(7,new fe({preview:e}))}_clickComponent(e){this._debug&&e.roomleId,this._selectionHandler.check(e)}_clickOutside(){this._selectionHandler.cancelSelection(),this.dispatchEvent(3),this._interaction()}_hoverOn(e,t){this._cameraMoving||(this._debug&&e.roomleId,e.hoverOn(),this._interaction(),this.dispatchEvent(1,new fe({component:e,type:t})),this._hoveredComponent=e)}_hoverOff(e,t){this._cameraMoving||(this._debug&&e.roomleId,e.hoverOff(),this._interaction(),this.dispatchEvent(2,new fe({component:e,type:t})),this._hoveredComponent=null)}_hoverOnPreview(e){e.hoverOn(),this._interaction(!0),this._hoveredPreview=e,this._addonHelper&&this._addonHelper.changePreviewGhostVisibility(e,!0)}_hoverOffPreview(e){e.hoverOff(),this._interaction(!0),this._hoveredPreview=null,this._addonHelper&&this._addonHelper.changePreviewGhostVisibility(e,!1)}_hoverOnPreviewLine(e,t){this._updatePositionForPreviewLine(e,t),this._draggedComponent||e.hoverOn(),this._interaction(),this._hoveredPreview=e}_hoverMovePreviewLine(e,t){this._updatePositionForPreviewLine(e,t),this._hoveredPreview=e,this._interaction(!0)}_updatePositionForPreviewLine(e,t){let n=t.object.parent.parent.worldToLocal(t.point);this._previewLineIntersection=n,e&&(this._draggedComponent?this._draggedComponent.visible=!0:e.updatePreviewPosition(n))}_hoverOffPreviewLine(e){this._draggedComponent||e.hoverOff(),this._interaction(),this._hoveredPreview=null,this._previewLineIntersection=null}_setDragComponentShadow(e){this._draggedComponent.traverse(t=>{if(t instanceof THREE.Mesh){const n=t;e&&void 0!==n.castShadowOld?(n.receiveShadow=n.receiveShadowOld,n.castShadow=n.castShadowOld):(n.receiveShadowOld=t.receiveShadow,n.castShadowOld=t.castShadow,n.receiveShadow=!1,n.castShadow=!1)}})}_dragStart(e){e&&(this._selectionHandler.isSelected(e)||this.isDragIn())&&(this._dragStartPosition=e.position.clone(),this._dragStartRotation=e.rotation.clone(),this._draggedComponent=e,this._setDragComponentShadow(!1),this.dispatchEvent(4,new fe({component:e})),this._interaction())}_drag(e,t){if(e&&(this._selectionHandler.isSelected(e)||this.isDragIn())){if(e&&!this._draggedComponent&&(this._draggedComponent=e),this._previewLineIntersection){let e=this._hoveredPreview,t=e.getPositionForIntersectionPoint(this._previewLineIntersection),n=e.parent.localToWorld(t);this._draggedComponent.position.copy(this._draggedComponent.parent.worldToLocal(n)),this._draggedComponent.rotation.copy(e.docklineRotation),e.hideSelectionLine()}else e.parent?e.position.copy(e.parent.worldToLocal(t)):e.position.copy(t);this._hoveredPreview?e.visible=!1:e.visible=!0,this.dispatchEvent(5,new fe({component:e})),this._interaction()}}_dragEnd(e,t){if(e&&(this._selectionHandler.isSelected(e)||this.isDragIn())){if(this._hoveredPreview)if(this._previewLineIntersection){let t=this._hoveredPreview,n=t.getPositionForIntersectionPoint(this._previewLineIntersection),i=t.parent.localToWorld(n);e.position.copy(e.parent.worldToLocal(i)),e.rotation.copy(t.docklineRotation)}else e.position.copy(t);else this._dragStartPosition&&this._dragStartRotation&&(e.position.copy(this._dragStartPosition),e.rotation.copy(this._dragStartRotation),this._dragStartPosition=null,this._dragStartRotation=null,this.addComponentHandlers(e));e.visible=!0,this._setDragComponentShadow(!0),this._draggedComponent=null,this._previewLineIntersection=null,this.dispatchEvent(6,new fe({component:e,preview:this._hoveredPreview})),this._interaction()}}_interaction(e){this.dispatchEvent(0,new fe({forceRender:e}))}hasSelection(){return this._selectionHandler.hasSelection()}update(e,t,n){this._raycastHelper.update(e,t,n)}setDragIn(e,t){this._dragIn=e,e?this._inputManager.enableDragIn(t):this._raycastHelper.clear(),this._interaction()}isDragIn(){return this._dragIn}isDragging(){return null!=this._draggedComponent}setRootComponentId(e){this._raycastHelper.setRootComponentId(e)}cancelSelection(){this._selectionHandler.setSelectionMode("standard"),this._selectionHandler.cancelSelection()}setSelectionMode(e){this._selectionHandler.setSelectionMode(e)}getSelectionMode(){return this._selectionHandler.getSelectionMode()}getSelectedRuntimeComponentIds(){return this._selectionHandler.getSelectedRuntimeComponentIds()}setCameraMoving(e){e&&this._hoveredComponent&&this._hoverOff(this._hoveredComponent,0),this._cameraMoving=e}}B([G],Ce.prototype,"_selectionHandler",void 0);class ve extends _{constructor(e){super(),this._uiIntersectionMask=0,this.floorEnvironment=!1,this._camera=e}updateToBounds(e,t,n){let i=new THREE.Vector3(-e.x/2,0,-e.z/2),o=new THREE.Vector3(e.x/2,e.y,e.z/2);this._boundingBox=new THREE.Box3(i,o),this._clientWidth=t,this._clientHeight=n;let s=this._boundingBox.getSize(new THREE.Vector3);this._boxVertices=[],this._boxVertices.push(this._boundingBox.min),this._boxVertices.push(this._boundingBox.min.clone().add(new THREE.Vector3(s.x,0,0))),this._boxVertices.push(this._boundingBox.max),this._boxVertices.push(this._boundingBox.max.clone().sub(new THREE.Vector3(s.x,0,0)))}set canvasOffset(e){this._offset=e,this.calculateUIIntersection()}calculateUIIntersection(){let e=[];if(null==this._boundingBox||null==this._offset)return;let t=this._checkPaddings();t.bottom=this._clientHeight-t.bottom,t.right=this._clientWidth-t.right;let n=0;this.floorEnvironment?(e=["left","right","bottom"],n=11):(this._offset.left>0&&t.left<this._offset.left*this._clientWidth&&(e.push("left"),n|=8),this._offset.right<1&&t.right<(1-this._offset.right)*this._clientWidth&&(e.push("right"),n|=2),this._offset.bottom>0&&t.bottom<this._offset.bottom*this._clientHeight&&(e.push("bottom"),n|=1)),this._offset.top<1&&t.top<(1-this._offset.top)*this._clientHeight&&(e.push("top"),n|=4),n!==this._uiIntersectionMask&&(this.dispatchEvent(0,e),this._uiIntersectionMask=n)}_checkPaddings(){let e={left:this._clientWidth/2,top:this._clientHeight/2,right:this._clientWidth/2,bottom:this._clientHeight/2};return this._boxVertices.forEach(t=>{let n=A(t,this._camera,this._clientWidth,this._clientHeight);n.x<e.left&&(e.left=n.x),n.x>e.right&&(e.right=n.x),n.y<e.top&&(e.top=n.y),n.y>e.bottom&&(e.bottom=n.y)}),e}}class be extends p{constructor(e,t){super(e,t),this._params={ambientLight:{color:"#ffffff"}},this._ambientLight=new THREE.AmbientLight(new THREE.Color(this._params.ambientLight.color),1.2),this._ambientLight.layers.set(1),this.addToScene()}needsBounds(){return!1}addToScene(){this._scene.add(this._ambientLight)}removeFromScene(){this._scene.remove(this._ambientLight)}reload(){this.removeFromScene(),this.addToScene()}showGUI(){let e=D();if(this._ambientLight){let t=e.addFolder("Ambient Light");t.add(this._ambientLight,"visible"),t.add(this._ambientLight,"intensity").min(0).max(5).step(.1),t.addColor(this._params.ambientLight,"color").onChange(e=>this._ambientLight.color=new THREE.Color(e))}}}class we{static preparePerspectiveImage(e,t,n,i){return new Promise((o,s)=>{let r=new THREE.WebGLRenderer({antialias:!0,alpha:!0});i||(i=1024),r.setSize(i,i),r.gammaInput=!0,r.gammaOutput=!0,r.gammaFactor=2.2;let a=e.fog?e.fog.clone():null,l=e.background?e.background.clone():null;e.background=null,e.fog=null;let h=new ee(e);t.layers.disable(2),t.layers.disable(5),this._placeCameraForPerspectiveImage(t,n,-20,-30),r.render(e,t);let c=r.domElement.toDataURL();t.layers.enable(2),e.background=l,e.fog=a,h.removeFromScene(),o({image:c,width:i,height:i,blob:null})})}static _placeCameraForPerspectiveImage(e,t,n,i){e.far=1e3,e.fov=15,e.aspect=1,e.position.copy(t.center),e.rotation.set(0,0,0),e.rotateY(U(i)),e.rotateX(U(n)),e.translateZ(3.8*t.diagonal),e.updateProjectionMatrix()}static prepareTopImage(e,t,n,i=!1){return new Promise((o,s)=>{let r=new THREE.WebGLRenderer({antialias:!0,alpha:!0});r.autoClear=!1,r.gammaInput=!0,r.gammaOutput=!0,r.gammaFactor=2.2;let a=new THREE.OrthographicCamera(-n.bounds.x/2,n.bounds.x/2,n.bounds.z/2,-n.bounds.z/2,.5);a.position.copy(n.center),a.rotateX(U(-90)),a.translateZ(n.bounds.y+1),a.far=a.position.y+.5,a.layers.mask=65535;let l=200*n.bounds.x,h=200*n.bounds.z;if(l>4096||h>4096){let e=0;l>4096?e=l/4096:h>4096&&(e=h/4096),l/=e,h/=e}r.setSize(l,h);let c=e.fog?e.fog.clone():null,d=e.background?e.background.clone():null;e.background=null,e.fog=null;let _=i?new be(e):new ee(e);a.layers.disable(2),a.layers.disable(5),i?a.layers.enable(6):a.layers.disable(6),r.render(e,a),r.clearDepth(),r.render(t,a);let u=r.domElement.toDataURL();a.layers.enable(2),a.layers.enable(5),e.background=d,e.fog=c,_.removeFromScene(),o({image:u,width:l,height:h,blob:null})})}}const ye=3e3;class Ee{constructor(e,t){this._forceRender=!1,this._maxAnisotropy=1,this._clock=new THREE.Clock,this._delta=0,this._depthWriteMaterial=new THREE.MeshBasicMaterial({colorWrite:!1}),this._lastChange=Date.now(),this._running=!1,this._onAfterRender=(()=>{}),this._creator_=e,this._setupScene(t),this._configuratorViewModel.setListener(this),this._lifeCycleManager.addEventListener(this);const{plusInPreview:n,addOnSpots:i}=window.__RML__ENV__.initData;(n||i)&&(this._addonHelper=new ge(this._camera,this._scriptLoader),i&&(this._addonHelper.onAddonClick(()=>{this._configuratorUiCallbacks.onOpenAddOns()}),this._addonHelper.addOnSpotsEnabled=i),this._addonHelper.previewGhostEnabled=n),this._cameraControl=new m(this._creator_,this._configuratorInputManager,null,this._camera),this._sceneEventHandler=new Ce(this._creator_,this._scene,this._camera,this._configuratorInputManager,this._addonHelper),this._sceneEventHandler.addEventListener(0,({forceRender:e})=>{this._uiIntersectionHelper.calculateUIIntersection(),this._addonHelper&&this._addonHelper.setState(0),this._requestRender(e)},this),this._sceneEventHandler.addEventListener(1,({component:e,type:t})=>this._onHoverOn(e,t),this),this._sceneEventHandler.addEventListener(2,({component:e,type:t})=>this._onHoverOff(e,t),this),this._sceneEventHandler.addEventListener(3,()=>{this._configuratorUiCallbacks.onClickOutside(),this._cameraControl.unlock(),this._cancelDockings(!1,null,this._configuratorViewModel.hasPreviews(),!0),this.cancelSelection(!0),this._componentRaycastHelper&&this._componentRaycastHelper.checkComponentVisibility(this._sceneEventHandler,this._configuratorViewModel),this._requestRender()},this),this._sceneEventHandler.addEventListener(8,({component:e})=>{this._configuratorViewModel.hasPreviews()&&this._cancelDockings(!1,null,this._configuratorViewModel.hasPreviews(),!0),this._selectComponent(e),this._configuratorContext.selectedRuntimeComponentIds=this._sceneEventHandler.getSelectedRuntimeComponentIds(),"standard"===this._sceneEventHandler.getSelectionMode()?this._onSelectedRuntimeComponentChange(e):this._onSelectedRuntimeComponentsChange(this._sceneEventHandler.getSelectedRuntimeComponentIds()),this._requestRender()},this),this._sceneEventHandler.addEventListener(9,({component:e,resetCamera:t})=>{this._deselectComponent(e,t),this._requestRender()},this),this._sceneEventHandler.addEventListener(4,({component:e})=>{"multiselect"===this._sceneEventHandler.getSelectionMode()&&this.cancelSelection(),this._requestDockingsPreviewWithDrag(e.roomleId),this._cameraControl.lock(),this._requestRender()},this),this._sceneEventHandler.addEventListener(5,()=>{this._requestRender(!0)},this),this._sceneEventHandler.addEventListener(6,({component:e,preview:t})=>{if(t){let n=t;this._configuratorViewModel.isPreviewLine(n)?this._configuratorViewModel.dockComponentWithPosition(n,e):this._configuratorViewModel.isPreview(n)&&this._dockComponent(n),this._cancelDockings(!t,e,!0,!0)}else{let t=this._sceneEventHandler.isDragIn()?e:null;this._cancelDockings(this._sceneEventHandler.isDragIn(),t,!1,!0);const n=this._configuratorViewModel.getBoundingBox();this._environment&&this._environment.needsBounds()&&this._environment.updateBounds(n.getSize(new THREE.Vector3))}this._cameraControl.unlock(),this._requestRender(!0)},this),this._sceneEventHandler.addEventListener(7,({preview:e})=>{this._configuratorViewModel.isPreview(e)&&(this._configuratorViewModel.isPreviewLine(e)?this._configuratorViewModel.dockComponentWithPosition(e):this._dockComponent(e),this._cancelDockings(!1,null,!this._configuratorViewModel.hasPreviews(),!1),this.requestDockingsPreview(!1),this._requestRender())},this),this._cameraControl.addEventListener(0,()=>{this._configuratorUiCallbacks.onCameraPositionChanges(),this._sceneEventHandler.setCameraMoving(!0),this._addonHelper&&this._addonHelper.setState(1),this._pixotronUtil.movingCameraStarts(),this._requestRender()},this),this._cameraControl.addEventListener(1,()=>{this._componentRaycastHelper&&this._componentRaycastHelper.checkComponentVisibility(this._sceneEventHandler,this._configuratorViewModel),this._requestRender()},this),this._cameraControl.addEventListener(2,()=>{this._sceneEventHandler.setCameraMoving(!1),this._addonHelper&&this._addonHelper.setState(2),this._pixotronUtil.movingCameraStops(),this._updateComponentPosition(),this._requestRender()},this),this._cameraControl.addEventListener(5,({minZoom:e,maxZoom:t})=>{this._configuratorUiCallbacks.onZoomChange(e,t)},this),this._cameraControl.addEventListener(3,()=>{this._configuratorUiCallbacks.onCameraPositionChanges(),this._updateComponentPosition()},this),this._cameraControl.addEventListener(4,()=>{this._configuratorUiCallbacks.onCameraPositionChanges(),this._updateComponentPosition()},this),this._cameraControl.addEventListener(7,()=>{this._pluginSystem.moveCameraStart(this._camera.position)},this),this._cameraControl.addEventListener(8,()=>{this._pluginSystem.moveCameraEnd(this._camera.position)},this),N.isProduction||(window.__RML__DEBUG__.SceneHelper=this),this._initOptionalModules()}async _initOptionalModules(){const{transparentHighlighting:e}=window.__RML__ENV__.initData;e&&(await t.import("./chunk-c23256c6.legacy.js").then(({default:e})=>this._componentRaycastHelper=new e),this._componentRaycastHelper.init(this._scene,this._camera))}_showDockings(){}cancelDockings(){this._cancelDockings(!0,null,!0,!0),this._requestRender(!0)}_cancelDockings(e,t,n,i){e&&(this._sceneEventHandler.setDragIn(!1),this._configuratorViewModel.removeDockingComponent(),t&&this._scene.remove(t)),this._configuratorViewModel.removePreviews(),n&&this._updateCameraToBounds(),i&&n&&this._configuratorUiCallbacks.onDockingsPreviewRemoved(),this._addonHelper&&this._addonHelper.setState(3),this._componentRaycastHelper&&this._componentRaycastHelper.changeMaterialsOnSelect(this._scene,null)}stopRenderLoop(){this._running=!1}_onHoverOn(e,t){2!==t&&this._highlight(e),this._componentDimensioningHelper&&this._componentDimensioningHelper.add(e)&&this._requestRender(!0)}_onHoverOff(e,t){2!==t&&this._highlight(),this._componentDimensioningHelper&&this._componentDimensioningHelper.hasComponentDimensions()&&(this._componentDimensioningHelper.remove(e),this._requestRender(!0)),this._requestRender()}_highlight(e=null){if(1===this._configuratorViewModel.getComponents().length)return;let t=window.__RML__ENV__.initData.meshSelection,n=[];e&&(t?n.push(...e.meshes):e.boundingBoxMesh&&n.push(e.boundingBoxMesh)),this._configuratorViewModel.getComponentsForIds(this._sceneEventHandler.getSelectedRuntimeComponentIds()).forEach(e=>{e&&(t?n.push(...e.meshes):e.boundingBoxMesh&&n.push(e.boundingBoxMesh))}),this._pixotron?this._pixotron.highlightObjects(n):this._outlinePass.selectedObjects=n}_shouldRenderUi(){return this._pluginSystem&&this._pluginSystem.needsUiScene()}_renderUi(){let e=this._scene.background?this._scene.background.clone():null;this._scene.overrideMaterial=this._depthWriteMaterial,this._scene.background=null,this._renderer.render(this._scene,this._camera),this._scene.overrideMaterial=null;let t=this._renderer.autoClear;this._renderer.autoClear=!1,this._renderer.clearDepth(),this._renderer.render(this._uiScene,this._camera),this._renderer.autoClear=t,this._scene.background=e}_requestRender(e){this._pixotron&&e&&(this._pixotron.needsUpdate=!0,e&&(this._forceRender=!0));const t=()=>{this._delta=this._clock.getDelta(),this._animateCamera(),this._camera.layers.mask=65535,this._statsHelper&&this._statsHelper.updateRenderInfo(this._renderer.info),this._pixotron?(this._forceRender&&(this._pixotron.autoShadowsClear=!0,this._pixotron.autoSAOClear=!0),this._checkLayers(),this._pixotron.render(this._renderer,this._scene,this._camera,this._renderTarget),this._forceRender=!1,this._pixotron.blit(),this._shouldRenderUi()&&this._renderUi()):(this._renderer.clear(),this._checkLayers(),this._composer.render(),this._renderer.clearDepth(),this._renderer.render(this._uiScene,this._camera),this._renderer.clearDepth()),this._onAfterRender(),this._addonHelper&&this._addonHelper.update(),window.TWEEN&&TWEEN.update(),this._addonHelper&&this._lastChange+1500<Date.now()&&this._addonHelper.isAddOnSpotVisible()&&this._addonHelper.setState(4),this._lastChange+ye<Date.now()?this._running=!1:(this._running=!0,requestAnimationFrame(t))};if(this._lastChange=Date.now(),!this._running){if(this._running=!0,this._addonHelper&&!this._addonHelper.isAddOnSpotVisible()){let e=this._configuratorViewModel.hasPreviews()?5:3;this._addonHelper.setState(e)}requestAnimationFrame(t)}}_checkLayers(){this._addonHelper&&this._addonHelper.isAddOnSpotVisible()?(this._camera.layers.enable(7),this._configuratorUiCallbacks.onAddonPlusShown()):(this._camera.layers.disable(7),this._configuratorUiCallbacks.onAddonPlusHidden())}_animateCamera(){this._cameraControl&&(this._cameraControl.animateCamera(this._delta)?(this._lightSetting instanceof g&&this._lightSetting.update(this._camera,this._cameraControl.getTargetPosition()),this._pixotron&&(this._pixotron.needsUpdate=!0)):!this._pixotron||this._sceneEventHandler.isDragging()||this._forceRender||(this._pixotron.autoShadowsClear=!1,this._pixotron.autoSAOClear=!1)),this._environment.needsCamera()&&this._environment.updateCamera(this._camera)}resume(){let e=this._domHelper.getClientDimensions(),t=e.x,n=e.y;if(this._renderTarget){const e=Math.ceil(t*window.devicePixelRatio),i=Math.ceil(n*window.devicePixelRatio);this._renderTarget.setSize(e,i)}this._renderer.domElement.classList.add(f.HSC),this._domHelper.element.appendChild(this._renderer.domElement),this._configuratorInputManager.addEvents(this._renderer.domElement),window.addEventListener("resize",this,!1),window.addEventListener("keydown",this,!1),document.addEventListener("visibilitychange",this),this._requestRender(!0),this._configuratorViewModel.materialQueue.registerCallback(()=>this._requestRender(!0))}pause(){this._configuratorInputManager.removeEvents(this._renderer.domElement),window.removeEventListener("resize",this,!1),window.removeEventListener("keydown",this,!1),document.removeEventListener("visibilitychange",this),this._configuratorViewModel.materialQueue.unregisterCallback()}destroy(){this.pause(),this.cleanUp()}_setupScene(e){let t=this._domHelper.getClientDimensions(),n=t.x,i=t.y;this._scene=new THREE.Scene,this._scene.background=new THREE.Color(s().DEFAULT_BACKGROUND),this._uiScene=new THREE.Scene,this._componentFactory=C(),this._camera=this._componentFactory.createCamera(30,n/i,.1,20,e),this._camera.position.copy(new THREE.Vector3(0,.5,5)),this._uiIntersectionHelper=new ve(this._camera),this._uiIntersectionHelper.canvasOffset=e,this._uiIntersectionHelper.addEventListener(0,e=>{this._configuratorUiCallbacks.onUiIntersectionChange(e)},this),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4);let o={format:THREE.RGBAFormat,minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter};const r=Math.floor(n*window.devicePixelRatio),a=Math.floor(i*window.devicePixelRatio);this._renderTarget=new THREE.WebGLRenderTarget(r,a,o),this._renderer=new THREE.WebGLRenderer({antialias:!1,alpha:!0}),this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(n,i),this._renderer.gammaOutput=!0,this._renderer.gammaInput=!0,this._renderer.gammaFactor=2.2,this._renderer.autoClear=!1,this._renderer.shadowMap.enabled=!0,this._renderer.shadowMap.type=THREE.PCFSoftShadowMap,this._environmentLoader.setRendererAndScene(this._renderer,this._scene),this._environmentLoader.registerEnvironmentChangedCallback(()=>this._requestRender(!0)),this._maxAnisotropy=this._renderer.capabilities.getMaxAnisotropy(),this._configuratorMeshGenerator.maxAnisotropy=this._maxAnisotropy,this._renderer.domElement.classList.add(f.HSC),this._domHelper.element.appendChild(this._renderer.domElement),this._configuratorInputManager.addEvents(this._renderer.domElement),this._lightSetting=new ee(this._scene),this._composer=new THREE.EffectComposer(this._renderer);let l=new THREE.RenderPass(this._scene,this._camera,null,new THREE.Color(s().DEFAULT_BACKGROUND),0);this._composer.addPass(l),this._outlinePass=new THREE.OutlinePass(new THREE.Vector2(n,i),this._scene,this._camera),this._outlinePass.renderToScreen=!0,this._outlinePass.visibleEdgeColor=new THREE.Color(s().SELECTION),this._outlinePass.hiddenEdgeColor=new THREE.Color(s().SELECTION),this._outlinePass.edgeStrength=3,this._outlinePass.edgeThickness=1,this._outlinePass.edgeGlow=0,this._composer.addPass(this._outlinePass),this._composer.setSize(n,i),this._requestRender(),window.addEventListener("resize",this,!1),window.addEventListener("keydown",this,!1),document.addEventListener("visibilitychange",this),this._setEnvironment(new v(this._scene,this._environment,new THREE.Color(s().DEFAULT_BACKGROUND))),this._pluginSystem.init(this._scene,this._uiScene,this._camera.position),this._configuratorViewModel.materialQueue.registerCallback(()=>this._requestRender(!0))}_tabVisible(){this.updateSize()}sceneCleared(){this._internalClearScene()}display(e){this._scene.add(e),this._sceneEventHandler.setRootComponentId(e.roomleId),this._requestRender()}debugSceneGraph(e){this._configuratorViewModel.debugSceneGraph(e),this._printObjectGraph(this._scene,"")}debugScene(){return this._scene}_printObjectGraph(e,t){e.material&&e.material.opacity,e.type,e.id,e.roomleId,e.children.length>0&&e.children.forEach(e=>{let n=t+"    ";this._printObjectGraph(e,n)})}clearScene(){this._cameraControl.clear(),this._internalClearScene(),this._pixotronUtil&&this._pixotronUtil.lockAdapter(),this._pluginSystem.clearScene(this._scene,this._uiScene)}planObjectConstructionDone(e){this._componentDimensioningHelper.reset(),this._componentDimensioningHelper.setCamera(this._camera)}_internalClearScene(){this._scene.children.forEach(e=>{"Object3D"!==e.type&&"Mesh"!==e.type&&"Line"!==e.type||this._scene.remove(e)}),this._uiScene.children.forEach(e=>{this._uiScene.remove(e)}),this._configuratorViewModel.sceneCleared(),this._memoryManager.shouldHardReset()&&(this._configuratorMeshGenerator.clear(),this._renderer.renderLists.dispose(),this._memoryManager.executedHardReset()),this._requestRender(!0)}preparePerspectiveImage(){return new Promise((e,t)=>{this._configuratorViewModel.materialQueue.finished().then(async()=>{this._cancelDockings(!0,null,!0,!1),this._clearSelectionAndHovers();let t=this._camera.clone(),n=this._calculateBoundingBoxOfAllMeshes();this._lightSetting.removeFromScene();const i=await we.preparePerspectiveImage(this._scene,t,n);this._lightSetting.addToScene(),this._requestRender(),e(i)},t)})}async preparePartImage(e,t){return new Promise((n,i)=>{this._configuratorViewModel.requestSubPartConstruction(e).then(async e=>{let i=this._camera.clone(),o=this._getCameraTargetForBBox((new THREE.Box3).setFromObject(e));const s=new THREE.Scene;s.add(e);const r=await we.preparePerspectiveImage(s,i,o,t);V(s),n(r)},i)})}_calculateBoundingBoxOfAllMeshes(e=0,t){let n=null;return n=t&&this._dimensionHelper?this._dimensionHelper.getBoundingBox():this._configuratorViewModel.getBoundingBox(),this._getCameraTargetForBBox(n,e)}_getCameraTargetForBBox(e,t=0){let n=e.getSize(new THREE.Vector3);return n.addScalar(t),{center:e.getCenter(new THREE.Vector3),bounds:n,diagonal:Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2)+Math.pow(n.z,2))}}prepareTopImage(e=!1){return new Promise((t,n)=>{this._configuratorViewModel.materialQueue.finished().then(async()=>{this._cancelDockings(!0,null,!0,!1),this._clearSelectionAndHovers(),e&&(await this._initDimensions(),await this._dimensionHelper.isInitialized(),this._dimensionHelper.enableTopDimensions());let n=this._calculateBoundingBoxOfAllMeshes(.1,e);this._lightSetting.removeFromScene();let i=await we.prepareTopImage(this._scene,this._uiScene,n,e);e&&this._dimensionHelper.disableTopDimensions(),this._lightSetting.addToScene(),this._requestRender(),t(i)})})}enableDragIn(e){this._sceneEventHandler.setDragIn(!0,e),this._requestRender()}_getYRotationOfObject(e){let t=e.getWorldDirection(new THREE.Vector3).clone();t.y=0,t.lengthSq()<.01&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.normalize();let n=Math.asin(t.x);return t.z<0&&(n=Math.PI-n),n<0&&(n+=2*Math.PI),n}zoomToComponent(e){this._cameraControl.saveState(!1);let t=e.boundingBox.getSize(new THREE.Vector3),n=this._getYRotationOfObject(e),i=new THREE.Euler(0,n,0),o=e.getWorldPosition(new THREE.Vector3).clone().add(e.boundingBox.getCenter(new THREE.Vector3).applyEuler(i));const s=new THREE.Vector2;this._renderer.getSize(s),this._cameraControl.zoomTo(t,s.width,s.height,i.y,U(15),o)}resetCamera(){this._cameraControl.hasSavedState()?this.resetCameraToState():this.resetCameraPositionToStart()}resetCameraToState(){this._cameraControl.resetToState()}resetCameraPositionToStart(){this._requestRender();const e=this._configuratorViewModel.getBoundingBox(),t=new THREE.Vector2;this._renderer.getSize(t),this._cameraControl.reset(e.getSize(new THREE.Vector3),t.width,t.height)}_clearSelectionAndHovers(){this.cancelSelection(),this._configuratorViewModel.clearRootComponent()}resetPreviews(){this._configuratorViewModel.removePreviews(),this._addonHelper&&this._addonHelper.setState(5),this._requestRender()}changeOffset(e){this._camera.offset=e,this._uiIntersectionHelper&&(this._uiIntersectionHelper.canvasOffset=e)}_onWindowResize(){this.updateSize()}updateSize(){let{x:e,y:t}=this._domHelper.getClientDimensions();this._renderer.setSize(e,t),this._camera.aspect=e/t,this._camera.updateProjectionMatrix(),this._updateCameraToBounds(),this._pixotron&&(this._pixotron.autoShadowsClear=!0,this._pixotron.autoSAOClear=!0,this._forceRender=!0,this._pixotron.setSize(e,t)),this._requestRender(!0)}setCameraOffset(e){this._camera.offset&&(this._camera.offset=e,this._requestRender(!0))}getCameraOffset(){return this._camera.offset}_onKeyDown(e){!e.key||"Escape"!==e.key&&"Esc"!==e.key||(this.cancelSelection(),e.preventDefault()),this._sceneEventHandler&&this._sceneEventHandler.hasSelection()&&e.key&&("Backspace"===e.key||"Delete"===e.key)&&(this.requestDeleteSelectedComponent(),e.preventDefault())}cancelPreviousDockings(){this._cancelDockings(!0,null,!1,!1)}cancelSelection(e){(this._sceneEventHandler.hasSelection()||"standard"!==this._sceneEventHandler.getSelectionMode())&&this._cancelSelection(e)}_cancelSelection(e){this._sceneEventHandler.cancelSelection(),this._configuratorContext.selectionMode="standard",this._configuratorContext.selectedRuntimeComponentIds=[],this._configuratorViewModel.removePreviews(),e&&this.resetCamera(),this._kernelAccess.updatePlanObjectDependencies(this._configuratorContext.planObjectId),this._configuratorUiCallbacks.onSelectionCancel()}_selectComponent(e){this._highlight(e)}_deselectComponent(e,t){"standard"===this._sceneEventHandler.getSelectionMode()&&(this._cancelSelection(t),this._highlight()),"multiselect"===this._sceneEventHandler.getSelectionMode()&&(this._sceneEventHandler.hasSelection()?this._configuratorContext.selectedRuntimeComponentIds=this._sceneEventHandler.getSelectedRuntimeComponentIds():(this._cancelSelection(t),this._highlight())),this._componentRaycastHelper&&this._componentRaycastHelper.changeMaterialsOnSelect(this._scene,null)}getScreenXY(e){return A(e,this._camera,this._domHelper.element.clientWidth,this._domHelper.element.clientHeight)}cleanUp(){this.stopRenderLoop()}setSelectionMode(e){this._sceneEventHandler.setSelectionMode(e)}changeFloorMaterial(e){return this._environment&&this._environment instanceof b||(this._environment=new b(this._scene,this._environment,!0),this._uiIntersectionHelper.floorEnvironment=!0),this._pixotron&&this._environment.setPixotron(this._pixotron,this._renderer,this._cameraControl.getCamera()),new Promise((t,n)=>{this._environment.changeFloorMaterial(e,this._maxAnisotropy).then(()=>{this._requestRender(),t()},n)})}enableHD(e){this._renderer.capabilities.maxTextures>8&&(e?e&&this.loadDynamicLightSetting(e):this.loadDynamicLightSetting(w.createDynamicLightSettingSource(null,y.CAMERA))),this._environment instanceof E&&(this._environment.removeFromScene(),this._environment.loadBackground(i()+"static/geometry/PhotoStudioRoom.glb",new THREE.MeshStandardMaterial)),this.reEnableHD()}reEnableHD(){let e={saoparams:{intensity:.5,occlusionWorldRadius:.6,smoothTransition:!0,samplesPerFrame:4,bias:.02,numSamples:100,accumulative:!1,falloff:1.5},shadowparams:{shadowMapResolution:1024,shadowRadius:1,shadowQuality:1,smoothTransition:!0,enableAccumulation:!0,shadowBiasMultiplier:.05,nearPlane:.01,farPlane:50,fov:40,numSamples:50,side:THREE.FrontSide},outlineparams:{highlightColor:new THREE.Color(s().SELECTION),edgeStrength:1,transparency:.9,edgeThickness:2}};this._pixotron=new window.PIXOTRON.Pixotron(e),this._pixotron.enableAA=!1,this._pixotronUtil=new I(this._pixotron),this._enableAutoQuality(),this._environment instanceof P&&this._environment.setPixotron(this._pixotron,this._renderer,this._cameraControl.getCamera()),this._requestRender()}_enableAutoQuality(){this._pixotronUtil.enablePixotronAutoQuality();const e=this._pixotronUtil.getAutoAdapter();let t=this._renderer.getPixelRatio();if(t>1){let n=this._pixotronUtil.getHighPixelRatioQualitySetting();e.addQuality(n),n.onExit(()=>{if(1!==(t=this._renderer.getPixelRatio())&&e.getAverageFps()<20&&t>1){this._renderer.setPixelRatio(1);let{x:e,y:n}=this._domHelper.getClientDimensions();this._pixotron.setSize(e,n),this._renderTarget&&this._renderTarget.setSize(e,n),t=1}})}this._pixotronUtil.onAutoQualityChange((t,n)=>{this._statsHelper&&this._statsHelper.updateQualityInfo(t);const i=this._pixotronUtil.getLowestQualitySetting();n&&t.getQuality()<n.getQuality()&&e.getAverageFps()<5&&e.setQualitySetting(i)}),this._pixotronUtil.onManualQualityChange((e,t)=>{this._statsHelper&&this._statsHelper.updateQualityInfo(e)}),this._configuratorViewModel.materialQueue.finished().then(()=>this._pixotronUtil.unLockAdapter())}disableHD(){this._pixotron=null,this._lightSetting=new ee(this._scene,this._lightSetting)}loadDynamicLightSetting(e){return this._lightSetting=new g(this._scene,this._lightSetting),e.url?this._lightSetting.loadFromURL(e.url):e.json?this._lightSetting.loadFromJSON(e.json):e.object?this._lightSetting.loadFromObject(e.object):new Promise((e,t)=>{t("No dynamic light setting source set")})}exportGLB(){this._scriptLoader.fetch("static/three/lib/exporters/GLTFExporter.js",{id:"gltf-exporter"}).then(()=>{let e=new THREE.GLTFExporter,t=[];this._scene.children.forEach(e=>{"Object3D"!==e.type&&"Mesh"!==e.type||t.push(e)}),e.parse(t,e=>{let t=document.createElement("a");const n=new Blob([e],{type:"model/gltf-binary"});t.href=URL.createObjectURL(n),t.download="scene.glb",t.style.display="none",document.body.appendChild(t),t.click()},{binary:!0,embedImages:!0,forceIndices:!0})})}showGUI(){this._lightSetting&&this._lightSetting.showGUI();let e=D();this._pixotron&&this._pixotronUtil.showGUI(),this._environment&&this._environment.showGUI(),this._addGUIListener(e)}_addGUIListener(e){let t=e.__folders;Object.keys(t).forEach((e,n)=>{let i=t[e];i.__folders&&Object.keys(i.__folders).forEach((e,n)=>{let i=t[e];this._addGUIListener(i)}),i.__controllers&&i.__controllers.forEach(e=>{e.onFinishChange(()=>{this._requestRender()})})})}zoomIn(e){this._cameraControl.zoomIn(e),this._requestRender(!0)}zoomOut(e){this._cameraControl.zoomOut(e),this._requestRender(!0)}showStats(){t.import("./chunk-1b99c17d.legacy.js").then(({default:e})=>this._statsHelper=new e)}async showDimensions(){await this._initDimensions(),this._dimensionHelper.enableDimensions(),this._dimensionHelper.onDimensionsVisibilityChanged(e=>{e&&this._requestRender(!0),this._configuratorUiCallbacks.onDimensionsVisibilityChange(e)}),this._requestRender(!0)}async _initDimensions(){this._dimensionHelper||await t.import("./chunk-1b80604a.legacy.js").then(({default:e})=>{this._dimensionHelper=new e(this._creator_),this._pluginSystem.addPlugin(this._dimensionHelper)})}hideDimensions(){this._dimensionHelper.disableDimensions(),this._requestRender(!0)}loadSceneSettings(e){let t=new Promise(t=>{(new S).load(this._scene,this._renderer.domElement,this._environment,e).then(e=>{e&&this._setEnvironment(e),t()})});this._lightSetting=new g(this._scene,this._lightSetting);let n=this._lightSetting.loadFromObject(e);return new Promise((e,i)=>{Promise.all([t,n]).then(()=>{this._requestRender(!0),this._uiIntersectionHelper.floorEnvironment=this._environment instanceof b,e()},i)})}setBackgroundColor(e){this._setEnvironment(new v(this._scene,this._environment,new THREE.Color(e)))}setBackgroundImage(e){this._setEnvironment(new v(this._scene,this._environment,null,this._renderer.domElement,e))}setBakedShadow(e,t){this._setEnvironment(new v(this._scene,this._environment,new THREE.Color(e),this._renderer.domElement,t))}_setEnvironment(e){this._environment=e,this._environment instanceof P&&(this._pixotron&&this._environment.setPixotron(this._pixotron,this._renderer,this._cameraControl.getCamera()),this._environment.setLoadedCallback(()=>setTimeout(()=>this._requestRender(!0),500))),this._requestRender(!0)}handleEvent(e){switch(e.type){case"resize":this._onWindowResize();break;case"keydown":if(e.target&&(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement))break;this._onKeyDown(e);break;case"visibilitychange":this._tabVisible()}}_updateCameraToBounds(e){let t;if(e?(t=new THREE.Box3).setFromObject(e):t=this._configuratorViewModel.getBoundingBox(),!t)return;let{x:n,y:i}=this._domHelper.getClientDimensions();this._cameraControl.updateToBounds(t,n,i,!1,!0),this._configuratorUiCallbacks.onCameraPositionChanges(),this._updateComponentPosition()}requestDockingsPreview(e,t,n,i){i||(i=!1),e&&this.cancelPreviousDockings(),this.cancelSelection(),i&&this.enableDragIn(n),t&&(this._configuratorContext.lastPossibleChild=t),this._configuratorContext.requestPreviewsIsUserInitiated=e,this.resetPreviews(),this._kernelAccess.webGlPreviewDockings(this._configuratorContext,i),this._showDockings()}_requestDockingsPreviewWithDrag(e){this.cancelPreviousDockings(),this._configuratorContext.rootComponentId!==e&&(this.resetPreviews(),this._kernelAccess.previewDockingsWithDrag(e,this._configuratorContext.planObjectId),this._showDockings())}_dockComponent(e){const t=r.start("dock_component_"+e.childId);this._kernelAccess.dockComponent(e.parentId,e.parentDockId,e.childId,e.childDockId),this._configuratorContext.dockingRootComponentId=null,r.end(t)}_onSelectedRuntimeComponentsChange(e){this._kernelAccess.multiSelectionChange(e,this._configuratorContext.rootComponentId)}_onSelectedRuntimeComponentChange(e){let t=!1,n=null;e&&(t=e.roomleId===this._configuratorContext.rootComponentId,n=e.roomleId),this._kernelAccess.selectionChange(n,t),e&&(this._kernelAccess.selectedComponent(e.roomleId),this.zoomToComponent(e))}requestDeleteSelectedComponent(){const e=this._configuratorContext.selectedRuntimeComponentIds,t=this._configuratorContext.rootComponentId;if(Array.isArray(e)&&0!==e.length&&t&&-1===e.indexOf(t)){switch(this._configuratorContext.selectionMode){case"standard":this.resetCamera(),this._kernelAccess.requestDeleteComponent(this._configuratorContext.selectedRuntimeComponentId);break;case"multiselect":this.resetCamera(),this._kernelAccess.requestDeleteComponents(this._configuratorContext.selectedRuntimeComponentIds)}this._configuratorContext.selectedRuntimeComponentIds=[]}}componentUpdated(e,t){if(e.roomleId===this._configuratorContext.rootComponentId){let t=new THREE.Vector3(e.position.x/1e3,e.position.z/1e3,e.position.y/-1e3);this._sceneEventHandler.update(null,t,null)}this._addonHelper&&e&&t.addOnSpots&&this._addonHelper.addAddOnSpots(e,t.addOnSpots),this._requestRender(!0)}planObjectUpdated(e,t){if(e.bounds){if(this._configuratorContext.planObjectId===e.id){const n=F(e.boxForMeasurement);let i=n.getSize(new THREE.Vector3);if(this._configuratorViewModel.hasPreviews()||this._sceneEventHandler.hasSelection()||this._updateCameraToBounds(),this._sceneEventHandler.update(i,null,null),this._uiIntersectionHelper.updateToBounds(i,this._domHelper.element.clientWidth,this._domHelper.element.clientHeight),this._environment.needsBounds()&&this._environment.updateBounds(i,t),this._lightSetting&&this._lightSetting.needsBounds()&&this._lightSetting.updateBounds(n),this._pixotron&&this._pixotron.getShadowPass().setShadowRecieverBBox(n),this._pixotronUtil){const e=new THREE.Sphere;n.getBoundingSphere(e),this._pixotronUtil.updateBounds(e)}this._camera.updateProjectionMatrix(),this._pluginSystem.updateBounds(n)}this._highlight(),this._requestRender()}}componentDeleted(e){this._addonHelper&&this._addonHelper.deleteAddonPointsForComponent(e.roomleId),-1===this._sceneEventHandler.getSelectedRuntimeComponentIds().indexOf(e.roomleId)&&"multiselect"!==this._sceneEventHandler.getSelectionMode()||this.cancelSelection()}previewConstructionDone(e,t){t||(this._cancelDockings(!0,null,!1,!1),this._configuratorContext.requestPreviewsIsUserInitiated&&this._configuratorUiCallbacks.onNoDockingsAvailable());const n=this._configuratorViewModel.getBoundingBox();this._updateCameraToBounds(),this._lightSetting&&this._lightSetting.needsBounds()&&this._lightSetting.updateBounds(n),this._environment&&this._environment.needsBounds()&&this._environment.updateBounds(n.getSize(new THREE.Vector3)),this._componentRaycastHelper&&this._componentRaycastHelper.checkPreviewVisibility(this._configuratorViewModel)}configurationLoaded(e,t){e&&t&&this._sceneEventHandler.isDragIn()&&(e.position.copy(new THREE.Vector3(0,100,0)),this._scene.add(e),this._sceneEventHandler.addComponentDragInHandler(e),this._requestRender()),this._pixotronUtil&&this._pixotronUtil.unLockAdapter(),this._environment&&this._environment.reload()}addComponentHandlers(e){this._sceneEventHandler.addComponentHandlers(e)}addPreviewHandlers(e){this._sceneEventHandler.addPreviewHandlers(e)}addPreviewLineHandlers(e){this._sceneEventHandler.addPreviewLineHandlers(e)}_updateComponentPosition(){if(!this._configuratorUiCallbacks.onComponentPositionsUpdated)return;const e=[];this._configuratorViewModel.getComponents().forEach(t=>{if(!t.boundingBoxMesh)return;const n=(new THREE.Box3).setFromObject(t.boundingBoxMesh);let i=this._kernelAccess.kernelInstance.getComponent(t.roomleId);const o=i.parameters||i.possibleChildren?["edit"]:[];e.push({id:t.roomleId,position:this.getScreenXY(n.getCenter(new THREE.Vector3)),type:"component",actions:o})}),this._configuratorViewModel.getPreviews().forEach(t=>{const n=(new THREE.Box3).setFromObject(t);e.push({id:t.roomleId,position:this.getScreenXY(n.getCenter(new THREE.Vector3)),type:"preview",actions:["add"]})}),this._configuratorUiCallbacks.onComponentPositionsUpdated(e)}}B([G],Ee.prototype,"_domHelper",void 0),B([G],Ee.prototype,"_scriptLoader",void 0),B([G],Ee.prototype,"_configuratorInputManager",void 0),B([G],Ee.prototype,"_configuratorUiCallbacks",void 0),B([G],Ee.prototype,"_configuratorMeshGenerator",void 0),B([G],Ee.prototype,"_memoryManager",void 0),B([G],Ee.prototype,"_lifeCycleManager",void 0),B([G],Ee.prototype,"_configuratorContext",void 0),B([G],Ee.prototype,"_kernelAccess",void 0),B([G],Ee.prototype,"_componentDimensioningHelper",void 0),B([G],Ee.prototype,"_configuratorViewModel",void 0),B([G],Ee.prototype,"_environmentLoader",void 0),B([G],Ee.prototype,"_pluginSystem",void 0);class Ie{constructor(e){this._hasComponentDimensions=!1,this._creator_=e}setCamera(e){this._camera=e}add(e){const n=this._kernelAccess.kernelInstance.getComponent(e.roomleId);if(!n)return!1;const i=n.dimensionings;if(!i||0===i.length||this._camera.position.z<0)return!1;const o=F(n.boxForMeasurement),s={x:this._camera.position.x,y:this._camera.position.z};return t.import("./chunk-04a4aedb.legacy.js").then(t=>{$.loadFont("static/fonts/rubik_regular.json").then(n=>{i.forEach(i=>{e.add(new t.default(j(i),o,n,s))})})}),this._hasComponentDimensions=!0,!0}remove(e){t.import("./chunk-04a4aedb.legacy.js").then(t=>{let n=[];e.children.forEach(e=>{e instanceof t.default&&n.push(e)}),n.forEach(t=>{e.remove(t),V(t)})})}hasComponentDimensions(){return this._hasComponentDimensions}reset(){this._hasComponentDimensions=!1}clear(){}}B([G],Ie.prototype,"_kernelAccess",void 0);const Pe=[new k("kernel-access",de),new k("logger",H),new k("rapi-access",Q),new k("script-loader",R),new k("unit-formatter",class{constructor(){this._formatter=null,this._precision=0}init(e){const t=new e.UnitMeasureFormatter;ae=e.Unit,le=e.UnitStringType,this._initActualUnit(),this._initActualUnitStringType();const{precisionCm:n,precisionInch:i}=window.__RML__ENV__.initData;this._actualUnit===ae.InchFeet?this._precision=void 0!==i?parseInt(i,10):2:this._actualUnit===ae.CM&&(this._precision=void 0!==n?parseInt(n,10):1),t.init("mm","cm","'","ft",'"',"inch","m","sqft",!0,this._precision),this._formatter=t}_initActualUnit(){const{unit:e}=window.__RML__ENV__.initData;switch(e){case"cm":this._actualUnit=ae.CM;break;case"mm":this._actualUnit=ae.MM;break;case"inchfeet":this._actualUnit=ae.InchFeet;break;default:this._actualUnit=ae.CM}}_initActualUnitStringType(){const{unitStringType:e}=window.__RML__ENV__.initData;switch(e){case"none":this._actualUnitStringType=le.NoUnitString;break;case"long":this._actualUnitStringType=le.LongUnitString;break;case"short":this._actualUnitStringType=le.ShortUnitString;break;default:this._actualUnitStringType=le.ShortUnitString}}_isFormatterReady(){return!!this._formatter||(console.warn("Formatter is not ready..."),!1)}formatAngleValueToUnitString(e,t){const n="Integer"===t.type?0:2;return e.toFixed(n)+""}parseAngleValueFromUnitString(e){return e.replace("","").replace(/\s/g,"")}parseValue(e,t){return null===t.unitType||"unknown"===t.unitType||"count"===t.unitType?e:"length"===t.unitType?this.parseMMValueFromUnitString(e,t.unitType):"angle"===t.unitType?this.parseAngleValueFromUnitString(e):"area"===t.unitType?this.parseAngleValueFromUnitString(e):e}formatValueToUnitString(e,t){return null===t.unitType||"unknown"===t.unitType||"count"===t.unitType?"Integer"===t.type?e.toString():parseFloat(e.toString()).toFixed(2):"length"===t.unitType?this.formatMMValueToUnitString(e,t.unitType):"angle"===t.unitType?this.formatAngleValueToUnitString(e,t):"area"===t.unitType?this.formatSquareMMValueToUnitString(e):e}isParseableNumber(e){return this._isFormatterReady()?this._formatter.isParseableNumber(e):null}isParseableUnitString(e,t){return this._isFormatterReady()?"angle"===t.unitType?this._formatter.isParseableUnitString(this.parseAngleValueFromUnitString(e),this._actualUnit):this._formatter.isParseableUnitString(e,this._actualUnit):null}parseMMValueFromUnitString(e,t){return this._isFormatterReady()?"count"===t?parseFloat(e):this._formatter.parseMMValueFromUnitString(e,this._actualUnit):null}parseNumber(e){return this._isFormatterReady()?this._formatter.parseNumber(e):null}formatNumber(e,t=0){return this._isFormatterReady()?this._formatter.formatNumber(e,t):null}formatSquareMMValueToUnitString(e){return this._isFormatterReady()?this._formatter.formatSquareMMValueToUnitString(e,this._actualUnit):null}formatMMValueToUnitString(e,t){return this._isFormatterReady()?"count"===t?e.toString():this._formatter.formatMMValueToUnitString(e,this._actualUnit,this._actualUnitStringType):null}formatMMValueWithReqMaxLength(e,t){return this._isFormatterReady()?this._formatter.formatMMValueWithReqMaxLength(e,this._actualUnit,t):null}_formatParameterValue(e,t){return"length"===t?this.formatMMValueToUnitString(parseFloat(e)):"area"===t?this.formatSquareMMValueToUnitString(parseFloat(e)):e}formatPartListParameter(e){se(e)&&(e.valueLabel=this._formatParameterValue(e.value,e.unitType))}formatParameter(e){if(se(e)&&Array.isArray(e.validValues)&&e.validValues.forEach(({value:t},n)=>{e.validValues[n].label=this._formatParameterValue(t,e.unitType)}),e.valueLabel=e.value,re(e))e.uiType="Material";else if(function(e){return"Boolean"===e.type}(e))e.uiType="Boolean";else if(ie(e)){e.uiType="Range",e.valueLabel=this._formatParameterValue(e.value,e.unitType);const t=null!==e.validRange.valueFrom?e.validRange.valueFrom:Number.MIN_SAFE_INTEGER,n=null!==e.validRange.valueTo?e.validRange.valueTo:Number.MAX_SAFE_INTEGER;e.validRangeLabels={valueFrom:this._formatParameterValue(t.toString(),e.unitType),valueTo:this._formatParameterValue(n.toString(),e.unitType),type:e.validRange.type}}else oe(e)?(e.uiType="Options",function(e){return!!oe(e)&&Array.isArray(e.validValues)&&e.validValues.length>0&&"string"==typeof e.validValues[0].thumbnail}(e)&&(e.uiType="Thumbnails")):(console.error("Could not detect uiType of param"),e.uiType=null)}isInch(){return this._actualUnit===ae.InchFeet}getPrecision(){return this._precision}getAllowedDelta(){const e=1/Math.pow(10,this._precision);return this.isInch()?25.4*e:e}}),new k("camera-control-3d",m),new k("camera-control",L),new k("configurator-input-manager",class extends u{},1),new k("dom-helper",M,1),new k("data-syncer",T),new k("selection-handler",class extends _{constructor(){super(...arguments),this._selectionMode="standard",this._selectedComponents=new Map}check(e){"standard"===this._selectionMode&&this._checkStandard(e),"multiselect"===this._selectionMode&&this._checkMulti(e)}cancelSelection(){0!==this._selectedComponents.size&&this._selectedComponents.forEach((e,t)=>{e.deselect(),this._selectedComponents.delete(t),this.dispatchEvent(1,new _e({component:e}))})}_checkStandard(e){if(this._selectedComponents.has(e.roomleId))return this._selectedComponents.delete(e.roomleId),void this.dispatchEvent(1,new _e({component:e}));this._selectedComponents.size>0&&this._selectedComponents.forEach((e,t)=>{this._selectedComponents.delete(t),this.dispatchEvent(1,new _e({component:e,resetCamera:!1}))}),this._selectedComponents.set(e.roomleId,e),this.dispatchEvent(0,new _e({component:e}))}_checkMulti(e){if(this._selectedComponents.has(e.roomleId))return this._selectedComponents.delete(e.roomleId),void this.dispatchEvent(1,new _e({component:e,resetCamera:0===this._selectedComponents.size}));this._selectedComponents.set(e.roomleId,e),this.dispatchEvent(0,new _e({component:e}))}setSelectionMode(e){this._selectionMode=e}getSelectionMode(){return this._selectionMode}hasSelection(){return this._selectedComponents.size>0}getSelectedRuntimeComponentIds(){let e=[];return this._selectedComponents.forEach(t=>e.push(t.roomleId)),e}isSelected(e){return this._selectedComponents.has(e.roomleId)}},1),new k("configurator-mesh-generator",J),new k("configurator-ui-callbacks",class extends W{constructor(e){super(e),this.onKernelIsReady=null,this.onComponentPositionsUpdated=null,this.onUpdateParameters=(e=>void 0),this.onUpdatePossibleChildren=((e,t)=>void 0),this.onUpdatePrice=((e,t)=>void 0),this.onSelectionChange=((e,t,n,i)=>void 0),this.onSelectionCancel=(()=>void 0),this.onPartListUpdate=((e,t)=>void 0),this.onBoundsUpdate=(e=>void 0),this.onLoadConfiguration=(()=>void 0),this.onConfigurationReady=((e,t,n)=>void 0),this.onOpenTag=(e=>void 0),this.onOpenAddOns=(()=>void 0),this.onClickOutside=(()=>void 0),this.onNoDockingsAvailable=(()=>void 0),this.onUiIntersectionChange=(e=>void 0),this.onZoomChange=((e,t)=>void 0),this.onDimensionsVisibilityChange=(e=>void 0),this.onErrorDueToOffline=(e=>void 0),this.onError=(e=>void 0),this.onDockingsPreviewRemoved=(()=>void 0),this.onConfigurationHasChildren=(e=>void 0),this.onTrackTiming=((e,t,n,i)=>void 0),this.onUserInitiatedDockDone=((e,t,n,i,o)=>void 0),this.onAddonPlusHover=(()=>void 0),this.onAddonPlusHoverOff=(()=>void 0),this.onAddonPlusShown=(()=>void 0),this.onAddonPlusHidden=(()=>void 0),this.onContentProblem=(e=>void 0),this.onSyncStarted=(()=>void 0),this.onSyncDone=(()=>void 0),this.onOpenFloorMaterials=(()=>void 0),this.onOpenPartList=(()=>void 0),this.onComponentLoadError=(e=>void 0),this.onConfigurationLoadError=(()=>void 0),this.onChangeTypeChangeTag=(e=>void 0),this.onRemoveTypeChangeTag=(e=>void 0),this.onConfigurationLabelChange=((e,t,n)=>void 0),this.onMemoryCorruption=(()=>void 0),this.onConfiguratorKernelIsReady=((e,t)=>void 0),this.onConfigurationSaved=(e=>void 0),this.onCameraPositionChanges=(()=>void 0)}},1),new k("scene-helper",Ee,1),new k("component-dimensioning-helper",Ie,1),new k("plugin-system",te,1),new k("component-raycast-helper",ne,0)];class Se{static sort(e,t){return e.sort||t.sort?e.sort?t.sort?e.sort-t.sort:-1:1:0}}class ke{constructor(e){this._onInitDoneCollection=[],this._isKernelReady=!1,this._isWebGlReady=!1,this._isPreloadReady=!0,this._isLoadError=!1,this._isReloading=!1,this._needsSync=!1,this._creator_=e,this._configuratorKernelAccessCallback.addListener(this);const t=this._errorHandler;t.subscribe(0,e=>this._configuratorUiCallbacks.onErrorDueToOffline(e)),t.subscribe(1,e=>this._configuratorUiCallbacks.onError(e)),t.subscribe(2,(e,t)=>this._configuratorUiCallbacks.onContentProblem({rapiPath:e,ids:t}))}_isInitDone(){return this._isKernelReady&&this._isWebGlReady&&this._isPreloadReady}_checkInitDone(){this._isInitDone()&&(this._onInitDoneCollection.forEach(e=>e()),this._onInitDoneCollection=[])}_onInitDone(e){this._isInitDone()?e():this._onInitDoneCollection.push(e)}_loadWebGlLib(e,t){this._threeLoader.fetch().then(()=>Promise.all([this._scriptLoader.fetch("static/three/lib/shaders/CopyShader.js",{id:"copy-shader-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/EffectComposer.js",{id:"effect-composer-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/RenderPass.js",{id:"render-pass-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/ShaderPass.js",{id:"shader-pass-js"}),this._scriptLoader.fetch("static/three/lib/shaders/LuminosityHighPassShader.js",{id:"luminosity-high-pass-shader-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/OutlinePass.js",{id:"outline-pass-js"}),this._scriptLoader.fetch("static/three/lib/lights/RectAreaLightUniformsLib.js",{id:"rect-area-light-uniforms-lib-js"})]).then(this._loadingWebGlSuccess(e,t).bind(this),this.loadError.bind(this)),this.loadError.bind(this))}_loadingWebGlSuccess(e,t){return()=>{t&&this._sceneHelper.changeOffset(t);const{initialFloorMaterial:e,enableHD:n,dls:i,ls:o,stats:s}=window.__RML__ENV__.initData;let r=w.createDynamicLightSettingSource(i,o);n?this.enableHD(r):window.__RML__ENV__.initData.retina=!0,s&&this.showStats(),this._needsSync&&(this._needsSync=!1,this._kernelAccess.requestSync(c,this._configuratorContext.planObjectId));const a=[this._scriptLoader.fetch("static/three/Tween.js",{id:"tween-js"})];e&&a.push(this._rapiAccess.getMaterial(e).then(e=>this._sceneHelper.changeFloorMaterial(e))),Promise.all(a).then(this._webGlIsReady.bind(this),this.loadError.bind(this))}}_webGlIsReady(){this._isWebGlReady=!0,this._checkInitDone()}_initPromiseCallback(e,t){this._isInitDone()?e():this._isLoadError?t("_initPromiseCallback failed"):(this._onInitDone(()=>e()),this._rejectOnLoadError=t)}_notifyOnConfigurationReady(e){return t=>{e(t.partList),this._configuratorUiCallbacks.onConfigurationReady(t.partList,t.hash,t.rootComponentLabel)}}_notifyOnConfigurationLoadingError(e){return()=>{this._configuratorUiCallbacks.onConfigurationLoadError()}}_loadItemOrConfigById(e,t,n=null){this._configuratorContext.lastLoadedRapiId=e,this._onLoadConfiguration(),this.setOverrides(n),n?n.id=e:n={id:e},this._preloadPackage(e),this._clearScene();const{offlineSync:i}=window.__RML__ENV__.initData;if(i){const t=q(e);t&&this._dataSyncer.start(t)}return new Promise((i,o)=>{(t?this._rapiAccess.getConfiguration(e):this._rapiAccess.getItem(e)).then(t=>{t&&t.configuration?this._loadConfiguration(t.configuration,n).then(e=>{const n=this._notifyOnConfigurationReady(i);t.label?this._notifyUiAboutNewItem(t,e.rootComponentLabel):this._notifyUiAboutNewConfiguration(t),n(e)},this._notifyOnConfigurationLoadingError(o).bind(this)):o(new Error("Could not load item or config with id "+e))},o)})}_shouldBroadcastToUi(e){return!(0===e&&this._configuratorContext.selectedRuntimeComponentId||1===e&&!this._configuratorContext.selectedRuntimeComponentId||2===e&&!this._configuratorContext.selectedRuntimeComponentIds.length)}_isCorrectResponse(e,t){if(0===e)return t===this._configuratorContext.planObjectId;if(1===e)return t===this._configuratorContext.selectedRuntimeComponentId;const n=t.length;if(n!==this._configuratorContext.selectedRuntimeComponentIds.length)return!1;for(let e=0;e<n;e++)if(t[e]!==this._configuratorContext.selectedRuntimeComponentIds[e])return!1;return!0}_onLoadConfiguration(){this._clearScene(),this._configuratorUiCallbacks.onLoadConfiguration()}_clearScene(){this._sceneHelper&&this._sceneHelper.clearScene()}_notifyUiAboutNewItem(e,t){this._rapiAccess.getCatalog(e.catalog).then(n=>this._configuratorUiCallbacks.onConfigurationLabelChange(n.name,e.label,t))}_notifyUiAboutNewConfiguration(e){Promise.all([this._rapiAccess.getCatalog(e.catalog),this._rapiAccess.getComponent(e.rootComponentId)]).then(([e,t])=>this._configuratorUiCallbacks.onConfigurationLabelChange(e.name,null,t.label))}_getMaterialGroups(e){const t=(e,t)=>{const n=e.label,i=t.label;if(n&&!i)return 1;if(!n&&i)return-1;if(n&&i)return n.localeCompare(i);const o=e.id,s=t.id;return o&&!s?1:!o&&s?-1:o||s?o.localeCompare(s):0},n=e=>(e.sort(t),e.forEach(e=>e.materials.sort(t)),e);if(e.validGroups.length>0)return new Promise((t,i)=>this._rapiAccess.getMaterialsByGroup(e.validGroups).then(e=>t(n(e)),i));const i=[];return e.validValues.forEach(e=>i.push(e.value)),new Promise((e,t)=>{this._rapiAccess.getMaterials(i).then(t=>{this._rapiAccess.combineMaterialsToGroups(t).then(t=>{e(n(t))})},t)})}_loadConfiguration(e,t){return new Promise((n,i)=>{const o=()=>{const{x:o,y:s}=this._domHelper.getClientDimensions();if(o<=0&&s<=0){let e="Size of canvas is 0/0! When using embedding set correct size or remove id to load in idle mode!";return console.error(e),i(e)}this.updateSize(),this.resumeKernelCallbacks(),r.start("ui_load_configuration");const a=[];if(t.applyCurrentGlobalParameters){const e=this._configuratorContext.planObjectId,t=this._configuratorContext.rootComponentParametersAsGlobal;a.push(this._kernelAccess.getGlobalParameters(e,t))}Promise.all(a).then(([o])=>{l.waitFor(2).then(([e,i,s,r])=>{const a=[];o&&t.applyCurrentGlobalParameters&&o.forEach(e=>a.push(this.setParameter(e,e.value,!0)));const l=this._rapiAccess.peekComponent(r);Promise.all(a).then(()=>{const e=[];a.length&&(e.push(this._kernelAccess.getPartList()),e.push(this._kernelAccess.getConfigurationHash(this._configuratorContext))),Promise.all(e).then(e=>{const t=e&&e[0]?e[0]:i,o=e&&e[1]?e[1]:s;n({partList:this._kernelAccess.addUiDataToPartList(t,o),hash:o,rootComponentLabel:l?l.label:""})})})},i),this._kernelAccess.loadConfiguration(e,t)},i)};this._onInitDone(()=>o())})}_preLoadItemOrConfig(e,t){return new Promise((n,i)=>{(t?this._rapiAccess.getConfiguration(e):this._rapiAccess.getItem(e)).then(n,i)})}_preloadPackage(e){this._isPreloadReady=!1;let t=null;t=X(e)?this._rapiAccess.getPreloadForItem.bind(this._rapiAccess):this._rapiAccess.getPreloadForConfiguration.bind(this._rapiAccess),r.start("rapi_preloads");const n=()=>{r.end("rapi_preloads");const t=r.getMeasure("rapi_preloads");if(Array.isArray(t)&&1===t.length){const n=t[0];this._configuratorUiCallbacks.onTrackTiming("Timing","RapiPreloads",Math.round(n.duration),{id:e})}};t(e).then(()=>{this._isPreloadReady=!0,this._checkInitDone(),n()},e=>{this._isPreloadReady=!0,this._checkInitDone(),console.error(e),n()})}_reloadConfiguration(e,t,n,i){return this._performLoadConfiguration(e,{preloadHint:t}).then(()=>{this._isReloading=!1,n()},e=>{this._isReloading=!1,i(e)})}_performLoadConfiguration(e,t){return this._onLoadConfiguration(),new Promise((n,i)=>{t&&t.preloadHint?this._preloadPackage(t.preloadHint):console.warn("When loading a configuration string you have to supply a preloadHint to use fast loading!"),this.setOverrides(t),setTimeout(()=>{this._loadConfiguration(e,t).then(this._notifyOnConfigurationReady(n).bind(this),this._notifyOnConfigurationLoadingError(i).bind(this))},0)})}_changeHDGeometry(e){return new Promise((t,n)=>e===a.useHDGeometry?t():this._isReloading?n("Change of HD Geometry in progress"):(this._isReloading=!0,l.waitFor(3).then(([e,i])=>{this._reloadConfiguration(e,i,t,n)},n),a.useHDGeometry=e,void this._kernelAccess.changeUseOfHDGeometry(this._configuratorContext,a.useHDGeometry)))}setOverrides(e){e&&(window.__RML__ENV__.initData=Object.assign(window.__RML__ENV__.initData,e),e.colors&&window.__RML__ENV__.initData.colors&&(window.__RML__ENV__.initData.colors=Object.assign(window.__RML__ENV__.initData.colors,e.colors)),e.overrideTenant&&this._rapiAccess.overrideTenant(e.overrideTenant),e.overrideCountry&&this._rapiAccess.overrideCountry(e.overrideCountry),e.overrideRapi&&this._rapiAccess.overrideRapi(e.overrideRapi),e.customApiUrl&&this._rapiAccess.setCustomApiUrl(e.customApiUrl),e.alwaysUseCache&&this._dataSyncer.setAlwaysUseCache(e.alwaysUseCache))}init(e,t){t=t||{};const{preloadHint:n,offset:i,startTag:o}=t;let{configuratorId:s}=window.__RML__ENV__.initData;if(!s){const e=document.referrer;s=-1!==e.indexOf("design-bestseller")?"desing-bestseller":-1!==e.indexOf("signature-safes")?"hartmann_tresore":-1!==e.indexOf("sitzfeldt")?"sitzfeldt":""===e?null:"demoConfigurator"}return this._rapiAccess.setConfiguratorId(s),this._domHelper.setDomElement(e),this.setOverrides(t),n?this._preloadPackage(n):console.warn("No preload hint! Therefore no preload during init!!"),o&&this.getTagById(o,{include:["items"]}).then(e=>this._configuratorUiCallbacks.onOpenTag(e),e=>console.error(e)),this._loadWebGlLib(e,i),new Promise(this._initPromiseCallback.bind(this))}cancelSelection(){this._sceneHelper.cancelSelection()}enableHDGeometry(){return this._changeHDGeometry(!0)}disableHDGeometry(){return this._changeHDGeometry(!1)}changeOffset(e){this._sceneHelper.changeOffset(e)}previewDockings(e,t,n){this._sceneHelper.requestDockingsPreview(!0,e,t,n)}cancelDockings(){this._sceneHelper.cancelDockings()}requestDeleteComponent(){this._sceneHelper.requestDeleteSelectedComponent()}preparePerspectiveImage(){return this._sceneHelper.preparePerspectiveImage()}preparePartImage(e,t){return t||(t=256),this._sceneHelper.preparePartImage(e,t)}saveCurrentConfiguration(){return new Promise((e,t)=>{this._kernelAccess.getConfigurationData(this._configuratorContext.planObjectId).then(n=>{this._rapiAccess.saveConfiguration(n).then(n=>{this._rapiAccess.getComponent(n.rootComponentId).then(i=>{let o=!0,s=!0,r=n.perspectiveImage,a=n.topImage;n.perspectiveImage||(o=!1,this._sceneHelper.preparePerspectiveImage().then(l=>{this._rapiAccess.savePerspectiveImage(n,l).then(t=>{o=!0,r=t.perspectiveImage,s&&(t.label=i.label,t.topImage=a,e(t))},t)})),n.topImage||(s=!1,this._sceneHelper.prepareTopImage().then(l=>{this._rapiAccess.saveTopImage(n,l).then(t=>{s=!0,a=t.topImage,o&&(t.label=i.label,t.perspectiveImage=r,e(t))},t)})),o&&s&&(n.label=i.label,e(n))},e=>{throw new Error(e)})},t)}).catch(t)})}generateImagesOfCurrentConfiguration(){return new Promise((e,t)=>this.saveCurrentConfiguration().then(t=>e({topImage:t.topImage,perspectiveImage:t.perspectiveImage,isLocally:t.isLocally}),t))}prepareTopImage(e=!1){return this._sceneHelper.prepareTopImage(e)}resetCameraPosition(){this._sceneHelper.resetCameraPositionToStart()}showBenchmarks(e){r.showBenchmarks(e)}debugSceneGraph(e){this._sceneHelper.debugSceneGraph(e)}loadConfiguration(e,t={}){return this._configuratorContext.lastLoadedRapiId=null,this._sceneHelper&&this._sceneHelper.clearScene(),this._performLoadConfiguration(e,t)}loadConfigurationById(e,t={}){return this._loadItemOrConfigById(e,!0,t)}syncPlanObjectToView(e,t){this.resumeKernelCallbacks(),this._kernelAccess.requestSync(e,t),this._kernelAccess.requestPlanObjectConstruction(t)}loadConfigurableItemById(e,t={}){return this._loadItemOrConfigById(e,!1,t)}preLoadConfigurationById(e){return this._preLoadItemOrConfig(e,!0)}preLoadConfigurableItemById(e){return this._preLoadItemOrConfig(e,!1)}_getTag(e){return this._rapiAccess.getTag(e)}_dispatchSetParameter(e,t,n,i,o){const s=this._configuratorContext.selectedRuntimeComponentId?"local":"global",a=r.start("kernel_change_param_"+s+"_"+e);switch(this._configuratorContext.selectionMode){case"standard":if(this._configuratorContext.selectedRuntimeComponentId||this._configuratorContext.rootComponentParametersAsGlobal){let s=this._configuratorContext.selectedRuntimeComponentId?this._configuratorContext.selectedRuntimeComponentId:this._configuratorContext.rootComponentId;this._kernelAccess.changeComponentParameter(s,e,t,n,i,o)}else this._kernelAccess.changePlanObjectParameter(this._configuratorContext.planObjectId,e,t,n,i,o);break;case"multiselect":this._kernelAccess.changeCommonComponentParameter(this._configuratorContext.selectedRuntimeComponentIds,e,t,n,i,o)}r.end(a)}setParameter(e,t,n=!1){return new Promise((i,o)=>{const{key:s,type:r}=e;if(ie(e)){if(!n&&!this._unitFormatter.isParseableUnitString(t,e))return o(new SyntaxError('Value "'+t+'" is not parseable'));const i=n?t:this._unitFormatter.parseValue(t,e),{valueFrom:s,valueTo:a}=e.validRange,l=this._unitFormatter.getAllowedDelta();if(!Number.isNaN(s)&&i<s-l)return o(new RangeError('Value "'+t+'" is too small, min-val "'+s+'"'));if(!Number.isNaN(a)&&i>a+l)return o(new RangeError('Value "'+t+'" is too big, max-val "'+a+'"'));t="Integer"===r&&"number"==typeof i?i.toFixed():i.toString()}this._dispatchSetParameter(s,r,t,i,o)})}setParameterOfPlanObject(e,t){return new Promise((n,i)=>{const{planObjectId:o,rootComponentId:s,rootComponentParametersAsGlobal:r}=this._configuratorContext,{type:a,key:l}=e;r?this._kernelAccess.changeComponentParameter(s,l,a,t,n,i):this._kernelAccess.changePlanObjectParameter(o,l,a,t,n,i)})}getParametersOfPlanObject(){const{planObjectId:e,rootComponentParametersAsGlobal:t}=this._configuratorContext;return this._kernelAccess.getGlobalParameters(e,t)}setParameterOfRootComponent(e,t){return new Promise((n,i)=>{const{rootComponentId:o}=this._configuratorContext,{type:s,key:r}=e;this._kernelAccess.changeComponentParameter(o,r,s,t,n,i)})}getParametersOfRootComponent(){const{planObjectId:e}=this._configuratorContext;return this._kernelAccess.getGlobalParameters(e,!0)}enableMultiselect(){this._sceneHelper.setSelectionMode("multiselect"),this._configuratorContext.selectionMode="multiselect"}disableMultiselect(){this._sceneHelper.setSelectionMode("standard"),this._configuratorContext.selectionMode="standard"}getCurrentConfiguration(){return l.waitFor(1,()=>this._kernelAccess.uiRequestConfiguration(this._configuratorContext.planObjectId))}loadComponentIntoKernel(e){return l.waitFor(0,()=>this._kernelAccess.loadComponentIntoKernel(e))}getShortUrlOfCurrentConfiguration(){return new Promise((e,t)=>{this.saveCurrentConfiguration().then(n=>navigator.onLine?this._rapiAccess.getShortUrl(n.id,3).then(t=>{const n=N.detailEnvironment===N.environments.PRODUCTION||N.detailEnvironment===N.environments.ALPHA?t.shortId:t.referencedId,i=N.APP.SHORTENER_URL+n;e(i)},t):t("Can not generate short url when offline"),t)})}formatValueToUnitString(e,t){return this._unitFormatter.formatValueToUnitString(e,t)}getTagById(e,t){return new Promise((n,i)=>{this._getTag(e).then(e=>{let o=Promise.resolve([]),s=Promise.resolve([]);t&&t.include&&t.include.forEach(t=>{"materials"===t&&(o=this._rapiAccess.getMaterialsOf(e)),"items"===t&&(s=this._rapiAccess.getItems(e.items))}),Promise.all([o,s]).then(([t,i])=>n(Object.assign({},e,{items:i,materials:t})),i)},i)})}requestAsset(e){return this._dataSyncer.requestAsset(e)}changeFloorMaterial(e){return this._sceneHelper.changeFloorMaterial(e)}openFloorMaterials(){this._configuratorUiCallbacks.onOpenFloorMaterials()}openPartList(){this._configuratorUiCallbacks.onOpenPartList()}getAdditionalContentsOf(e){return this._rapiAccess.getAdditionalContentsOfItems(e)}changeTypeChangeTag(e){navigator.onLine&&window.__RML__ENV__.initData.offlineSync&&this._dataSyncer.syncTypeChangeTag(e),this._configuratorUiCallbacks.onChangeTypeChangeTag(e)}removeTypeChangeTag(e){this._configuratorUiCallbacks.onRemoveTypeChangeTag(e)}showGUI(){const e=document.createElement("style");e.innerText=".dg.ac {right:auto!important}",document.head.appendChild(e),this._scriptLoader.fetch("static/three/dat.gui.min.js",{id:"dat-gui-js"}).then(()=>this._sceneHelper.showGUI(),e=>console.error(e))}showStats(){this._sceneHelper.showStats()}showDimensions(){this._sceneHelper.showDimensions()}hideDimensions(){this._sceneHelper.hideDimensions()}syncCatalog(e){return this._dataSyncer.syncCatalog(e)}syncFloorTag(e){return this._dataSyncer.syncFloorTag(e)}syncTypeChangeTag(e){return this._dataSyncer.syncTypeChangeTag(e)}loadDynamicLightSetting(e){return this._sceneHelper.loadDynamicLightSetting(e)}setBackgroundColor(e){this._sceneHelper.setBackgroundColor(e)}setBackgroundImage(e){this._sceneHelper.setBackgroundImage(e)}setBakedShadow(e,t){this._sceneHelper.setBakedShadow(e,t)}loadSceneSetting(e){return this._sceneHelper.loadSceneSettings(e)}enableMeshSelection(e){window.__RML__ENV__.initData&&(window.__RML__ENV__.initData.meshSelection=e)}updateSize(){this._sceneHelper.updateSize()}setCameraOffset(e){this._sceneHelper.setCameraOffset(e)}getCameraOffset(){return JSON.parse(JSON.stringify(this._sceneHelper.getCameraOffset()))}getMain(){}cleanup(){this._configuratorContext.selectedRuntimeComponentIds=[],this._sceneHelper.sceneCleared(),this._kernelAccess.cleanUpCallbacks()}resumeTest(e){e&&this._domHelper.setDomElement(e),this._lifeCycleManager.resume()}pauseTest(){this._lifeCycleManager.pause()}zoomIn(e){this._sceneHelper.zoomIn(e)}zoomOut(e){this._sceneHelper.zoomOut(e)}get callbacks(){return this._configuratorUiCallbacks}getRuntimeComponentIdOfRootComponent(){const e=this._configuratorContext.planObjectId;return e?this._kernelAccess.getRuntimeComponentIdOfRootComponent(e):(console.warn("planObjectId not set"),0)}getCurrentConfigurationHash(){return this._kernelAccess.getConfigurationHash(this._configuratorContext)}getCurrentSelection(){let e=this._configuratorContext.selectedRuntimeComponentIds;return e&&e.length||(e=[this._configuratorContext.rootComponentId]),e.map(e=>this._kernelAccess.getRuntimeComponentId(e))}enableHD(e){return new Promise((t,n)=>{this._scriptLoader.fetch("static/three/pi.min.js",{id:"pi-js"}).then(()=>{this._sceneHelper.enableHD(e),t()},n)})}disableHD(){return new Promise(e=>{this._sceneHelper.disableHD(),e()})}isReady(){const e=r.getMeasure("kernel_is_ready");if(Array.isArray(e)&&1===e.length){const t=e[0],n=r.getMeta("kernel_is_ready");this._configuratorUiCallbacks.onTrackTiming("Timing","KernelIsReady",Math.round(t.duration),Object.assign(n,{startTime:t.startTime}))}this._isKernelReady=!0,this._checkInitDone(),"function"==typeof this._configuratorUiCallbacks.onKernelIsReady&&this._configuratorUiCallbacks.onKernelIsReady()}updatePossibleChildren(e,t,n){const i=[],o=[];let s;const r=new Map,l=new Map;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(!n.possible)continue;let a=n.itemId;n.itemId?(o.push(n.itemId),l.set(n.itemId,n)):(i.push(n.componentId),r.set(n.componentId,n),a=n.componentId),n.isDefault&&!s&&(s=a)}Promise.all([this._rapiAccess.getComponents(i),this._rapiAccess.getItems(o)]).then(e=>{const t=[],n=e[0],i=e[1];let o;for(let e=0,i=n.length;e<i;e++){const i=n[e];i.isItem=!1,i.isComponent=!0;const a=r.get(i.id);a&&(i.group=a.group),i.id===s&&(i.isDefault=!0,o=i),t.push(i)}for(let e=0,n=i.length;e<n;e++){const n=i[e];n.isItem=!0,n.isComponent=!1;const r=l.get(n.id);r&&(n.group=r.group),n.id===s&&(n.isDefault=!0,o=n),t.push(n)}return t.sort(Se.sort),{possibleChildren:t,defaultChild:o||null}}).then(({possibleChildren:e,defaultChild:t})=>{const n=[],i=new Map,o=[];for(let t=0,s=e.length;t<s;t++){const s=e[t],r=s.tags;if(s.tags&&Array.isArray(s.tags)&&s.tags.length)for(let e=0,t=s.tags.length;e<t;e++){const t=r[e];-1===n.indexOf(t)&&n.push(t);let o=i.get(t);if(!o){const e=[];i.set(t,e),o=i.get(t)}o.push(s)}else o.push(s)}return{tagIds:n,associations:i,defaultChild:t,noTagChilds:o}}).then(({tagIds:t,associations:i,defaultChild:o,noTagChilds:s})=>{this._rapiAccess.getTags(t).then(t=>{if(this._isCorrectResponse(n,e)&&this._shouldBroadcastToUi(n)){for(let e=0,n=t.length;e<n;e++){const n=t[e];n.possibleChildren=i.get(n.id)}t.sort(Se.sort),s.length&&t.unshift({id:"",externalIdentifier:"",global:!1,created:(new Date).toISOString(),updated:(new Date).toISOString(),language:a.actualLocale,catalog:null,tags:[],parents:[],materials:[],items:[],possibleChildren:s}),this._configuratorUiCallbacks.onUpdatePossibleChildren(t,o)}},e=>{console.error("Couldnt load tags of possible children"),console.error(e)})},e=>console.error(e))}updateParameters(e,t,n,i){const o={};t||(t=[],console.warn("Kernel returned no parameter groups! Check why!")),t.forEach(e=>{o[e.key]=e}),e.sort(Se.sort),e.forEach(e=>{e.group?e.grouping=o[e.group]:e.grouping=null,this._unitFormatter.formatParameter(e),re(e)&&Object.defineProperty(e,"groups",{get:()=>new Promise((t,o)=>{this._getMaterialGroups(e).then(e=>{this._isCorrectResponse(i,n)&&this._shouldBroadcastToUi(i)?t(e):o("Response does not match to ids")},o)})})}),this._shouldBroadcastToUi(i)&&this._configuratorUiCallbacks.onUpdateParameters(e)}loadError(e){this._isLoadError=!0,this._rejectOnLoadError&&this._rejectOnLoadError(e)}resumeKernelCallbacks(){this._kernelAccess.muteKernelCallbacks=!1,this._kernelAccess.resume()}pauseKernelCallbacks(){this._kernelAccess.muteKernelCallbacks=!0,this._kernelAccess.pause()}setActiveGroupInView(e){this._kernelAccess.setActiveGroupInView(e)}}B([G],ke.prototype,"_rapiAccess",void 0),B([G],ke.prototype,"_dataSyncer",void 0),B([G],ke.prototype,"_errorHandler",void 0),B([G],ke.prototype,"_unitFormatter",void 0),B([G],ke.prototype,"_domHelper",void 0),B([G],ke.prototype,"_configuratorUiCallbacks",void 0),B([G],ke.prototype,"_configuratorKernelAccessCallback",void 0),B([G],ke.prototype,"_lifeCycleManager",void 0),B([G],ke.prototype,"_kernelAccess",void 0),B([G],ke.prototype,"_threeLoader",void 0),B([G],ke.prototype,"_scriptLoader",void 0),B([G],ke.prototype,"_configuratorContext",void 0),B([G],ke.prototype,"_sceneHelper",void 0),e("Configurator",class extends O{setupDependencies(){x.setup(Pe),this._context||(this._context=x.getContext("configurator")),this.lookup("kernel-access",this._context),this.lookup("rapi-access",this._context),this.lookup("script-loader",this._context),this.lookup("logger",this._context)}cleanUpGlobals(){delete window.RoomleConfigurator}cleanUpDependencies(){const e=this.lookup("script-loader"),t=this.lookup("rapi-access"),n=(this.lookup("dom-helper"),this.lookup("scene-helper"));e&&e.cleanUp(),t&&t.cleanUp(),n&&n.cleanUp()}setupGlobals(e={}){const{locale:t}=window.__RML__ENV__.initData,{kernelInstance:n,kernelContainer:i,planObjectId:o}=e;a.init({locale:t,kernelInstance:n,kernelContainer:i,planObjectId:o})}getApi(){return this._configurator}bootFinished(){this._configurator=new ke(this._context),this._configurator.getMain=(()=>this),window.RoomleConfigurator||(window.RoomleConfigurator=this._configurator)}})}}});
//# sourceMappingURL=chunk-66c76e76.legacy.js.map
