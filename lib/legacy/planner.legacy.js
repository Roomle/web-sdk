System.register(["./chunk-eb2e1ffb.legacy.js","./chunk-4c9a4d80.legacy.js","./chunk-850740d7.legacy.js","./chunk-e1adca67.legacy.js","./chunk-e25086fb.legacy.js"],function(e,t){var n,i,a,o,r,s,c,l,h,u,d,_,p,f,g,m,y,v,k,C,E,w,b,L,M,R,P,S,H,T,D,I,x,A,j,O,B,V,F,G,z,K,U,q,W,N,X,Y,Q,J,Z,$,ee,te;return{setters:[function(e){n=e.a,i=e.b},function(e){a=e.a,o=e.b,r=e.c,s=e.d,c=e.e,l=e.f,h=e.g},function(e){u=e.f,d=e.g,_=e.d,p=e.w,f=e.K,g=e.L,m=e.M,y=e.N,v=e.O,k=e.r,C=e.P,E=e.Q,w=e.R,b=e.b,L=e.S,M=e.T,R=e.l,P=e.p,S=e.q,H=e.U,T=e.D,D=e.V,I=e.j,x=e.k,A=e.u,j=e.v,O=e.x,B=e.A,V=e.y,F=e.B,G=e.C},function(e){z=e.a,K=e.k,U=e.l,q=e.h,W=e.b,N=e.m,X=e.n,Y=e.f,Q=e.g,J=e.c,Z=e.i,$=e.j},function(e){ee=e.a,te=e.b}],execute:function(){var e=function(e){function t(e,n){var i;return a(this,t),(i=r(this,s(t).call(this,e,n)))._center=new THREE.Vector3(0,0,0),i._params={ambientLight:{color:"#ffffff"},areaLight:{position:{x:-1,y:12,z:-1},intensity:400,width:10,height:10,color:"#ffffff"},mainDirLight:{position:{x:-100,y:100,z:-100},color:"#ffffff"},secondDirLight:{position:{x:100,y:100,z:100},color:"#f0faff"}},i._hemiTOLight=new THREE.HemisphereLight(2250599,16760152,1),i._hemiTOLight.position.set(0,2,0),i._hemiLight=new THREE.HemisphereLight(4473924,2236979,2),i._hemiLight.position.set(0,.2,0),i._ambientLight=new THREE.AmbientLight(new THREE.Color(i._params.ambientLight.color),.6),i._ambientLight.layers.set(1),i._areaLight=new THREE.RectAreaLight(new THREE.Color(i._params.areaLight.color),void 0,i._params.areaLight.width,i._params.areaLight.height),i._areaLight.castShadow=!0,i._areaLight.matrixAutoUpdate=!0,i._areaLight.intensity=i._params.areaLight.intensity/(i._areaLight.width*i._areaLight.height),i._areaLight.position.set(i._params.areaLight.position.x,i._params.areaLight.position.y,i._params.areaLight.position.z),i._areaLight.lookAt(new THREE.Vector3(0,0,0)),i._areaLight.visible=!0,i._areaLight.layers.set(1),i._sunLight=i._createSpotlight(new THREE.Vector3(5,4,5),new THREE.Vector3(0,0,0)),i._mainDirLight=new THREE.DirectionalLight(new THREE.Color(i._params.mainDirLight.color),.5),i._mainDirLight.position.set(i._params.mainDirLight.position.x,i._params.mainDirLight.position.y,i._params.mainDirLight.position.z),i._mainDirLight.castShadow=!1,i._mainDirLight.shadow.camera.near=.5,i._mainDirLight.shadow.camera.far=100,i._mainDirLight.shadow.mapSize=new THREE.Vector2(1024,1024),i._mainDirLight.visible=!1,i._secondDirLight=new THREE.DirectionalLight(new THREE.Color(i._params.secondDirLight.color),.2),i._secondDirLight.position.set(i._params.secondDirLight.position.x,i._params.secondDirLight.position.y,i._params.secondDirLight.position.z),i._secondDirLight.castShadow=!1,i._secondDirLight.shadow.camera.near=.5,i._secondDirLight.shadow.camera.far=100,i._secondDirLight.shadow.mapSize=new THREE.Vector2(1024,1024),i._secondDirLight.visible=!1,i.addToScene(),i}return c(t,u),o(t,[{key:"_createSpotlight",value:function(e,t){var n=new THREE.SpotLight(16767899,.5);return n.angle=60*Math.PI/180,n.penumbra=.3,n.position.copy(e),n.target.position.set(t.x,t.y,t.z),n.shadow.camera.near=.1,n.shadow.camera.far=100,n.shadow.mapSize=new THREE.Vector2(1024,1024),n.visible=!0,n.castShadow=!0,n}},{key:"updateSunPosition",value:function(e,t){}},{key:"addToScene",value:function(){this._scene.add(this._areaLight),this._scene.add(this._mainDirLight),this._scene.add(this._secondDirLight),this._scene.add(this._ambientLight)}},{key:"removeFromScene",value:function(){this._scene.remove(this._areaLight),this._scene.remove(this._mainDirLight),this._scene.remove(this._secondDirLight),this._scene.remove(this._ambientLight)}},{key:"reload",value:function(){this.removeFromScene(),this.addToScene()}},{key:"setBounds",value:function(e){this._center.copy(e.getCenter(new THREE.Vector3)),this._areaLight.position.copy(new THREE.Vector3(this._params.areaLight.position.x,this._params.areaLight.position.y,this._params.areaLight.position.z).add(this._center)),this._mainDirLight.position.copy(new THREE.Vector3(this._params.mainDirLight.position.x,this._params.mainDirLight.position.y,this._params.mainDirLight.position.z).add(this._center)),this._secondDirLight.position.copy(new THREE.Vector3(this._params.secondDirLight.position.x,this._params.secondDirLight.position.y,this._params.secondDirLight.position.z).add(this._center)),this._areaLight.lookAt(this._center),this._mainDirLight.lookAt(this._center),this._secondDirLight.lookAt(this._center)}},{key:"showGUI",value:function(){var e=this,t=d();if(this._areaLight){var n=t.addFolder("Area Light");n.add(this._areaLight,"visible"),n.add(this._params.areaLight,"intensity").min(100).max(2e3).step(1).onChange(function(t){return e._areaLight.intensity=t/(e._areaLight.width*e._areaLight.height)}),n.add(this._params.areaLight,"width").min(1).max(30).step(1).onChange(function(t){e._areaLight.width=t,e._areaLight.intensity=e._areaLight.intensity/(e._areaLight.width*e._areaLight.height)}),n.add(this._params.areaLight,"height").min(1).max(30).step(1).onChange(function(t){e._areaLight.height=t,e._areaLight.intensity=e._areaLight.intensity/(e._areaLight.width*e._areaLight.height)}),n.add(this._areaLight,"castShadow"),n.addColor(this._params.areaLight,"color").onChange(function(t){return e._areaLight.color=new THREE.Color(t)}),n.add(this._areaLight.position,"x").min(-30).max(50).step(.1).onChange(function(){return e._areaLight.lookAt(e._center)}),n.add(this._areaLight.position,"y").min(-30).max(50).step(.1).onChange(function(){return e._areaLight.lookAt(e._center)}),n.add(this._areaLight.position,"z").min(-30).max(50).step(.1).onChange(function(){return e._areaLight.lookAt(e._center)})}if(this._ambientLight){var i=t.addFolder("Ambient Light");i.add(this._ambientLight,"visible"),i.add(this._ambientLight,"intensity").min(0).max(5).step(.1),i.addColor(this._params.ambientLight,"color").onChange(function(t){return e._ambientLight.color=new THREE.Color(t)})}if(this._mainDirLight){var a=t.addFolder("Main Directional Light");a.add(this._mainDirLight,"visible"),a.add(this._mainDirLight,"intensity").min(0).max(10).step(.1),a.add(this._mainDirLight,"castShadow"),a.addColor(this._params.mainDirLight,"color").onChange(function(t){return e._mainDirLight.color=new THREE.Color(t)}),a.add(this._mainDirLight.position,"x").min(-10).max(10).step(.1).onChange(function(){return e._mainDirLight.lookAt(e._center)}),a.add(this._mainDirLight.position,"y").min(-10).max(50).step(.1).onChange(function(){return e._mainDirLight.lookAt(e._center)}),a.add(this._mainDirLight.position,"z").min(-10).max(10).step(.1).onChange(function(){return e._mainDirLight.lookAt(e._center)})}if(this._secondDirLight){var o=t.addFolder("Second Directional Light");o.add(this._secondDirLight,"visible"),o.add(this._secondDirLight,"intensity").min(0).max(10).step(.1),o.add(this._secondDirLight,"castShadow"),o.addColor(this._params.secondDirLight,"color").onChange(function(t){return e._secondDirLight.color=new THREE.Color(t)}),o.add(this._secondDirLight.position,"x").min(-10).max(10).step(.1).onChange(function(){return e._secondDirLight.lookAt(e._center)}),o.add(this._secondDirLight.position,"y").min(-10).max(50).step(.1).onChange(function(){return e._secondDirLight.lookAt(e._center)}),o.add(this._secondDirLight.position,"z").min(-10).max(10).step(.1).onChange(function(){return e._secondDirLight.lookAt(e._center)})}}}]),t}(),ne=function e(t){a(this,e);var n=t.planObject,i=t.resetCamera;this.planObject=n,this.resetCamera=void 0===i||i},ie=function(e){function t(e,n,i){var o;return a(this,t),(o=r(this,s(t).call(this)))._debug=!0,o._raycastHelper=new z(e,n,i),o}return c(t,_),o(t,[{key:"addPlanObjectHandlers",value:function(e){this._addPlanObjectHandlers(e,e.getBoundingBox(),{hasListener:!0,priority:1,roomleId:e.getRuntimeId()})}},{key:"_addPlanObjectHandlers",value:function(e,t,n){var i=this;t.userData.hasListener||(t.userData=n,t.addEventListener("select",function(){return i._clickComponent(e)}))}},{key:"_clickComponent",value:function(e){this._debug&&e.getRuntimeId(),this.dispatchEvent(0,new ne({planObject:e}))}},{key:"setCamera",value:function(e){this._raycastHelper.setCamera(e)}}]),t}(),ae=Math.PI/4,oe=1,re=function(e){function t(e,n){var i;a(this,t),(i=r(this,s(t).call(this,e,n)))._state=0,i._rotationSpeed=oe,i._keyMap=new Map,i._camera=new THREE.PerspectiveCamera,i._camera.fov=50,i._camera.aspect=i._width/i._height,i._camera.near=.1,i._camera.far=100,i._camera.updateProjectionMatrix(),i._camera.layers.set(3),i._camera.layers.enable(1),i._camera.layers.enable(2),i._camera.layers.enable(5),i._camera.layers.enable(4),n?i._camera.position.set(n.x,1.5,n.z):i._camera.position.set(0,1.5,0),i._cameraPosition=new THREE.Vector3,i._cameraPosition.copy(i._camera.position),i._cameraRotation=new THREE.Quaternion,i._pitch=0,i._yaw=0;var o=new THREE.Euler(-i._pitch,i._yaw,0,"ZYX");return i._cameraRotation.setFromEuler(o),window.addEventListener("gamepadconnected",i._gamepadConnected.bind(l(l(i)))),window.addEventListener("gamepaddisconnected",i._gamepadDisconnected.bind(l(l(i)))),i}return c(t,p),o(t,[{key:"_gamepadConnected",value:function(e){this.startButtonPressListener()}},{key:"_gamepadDisconnected",value:function(e){window.cancelAnimationFrame(this._listenerLoopAnimationFrame)}},{key:"startButtonPressListener",value:function(){var e=this;this._listenerLoopAnimationFrame=window.requestAnimationFrame(function(){e.buttonPressListener()})}},{key:"buttonPressListener",value:function(){var e=navigator.getGamepads()[0];this._checkRightStick(e),this._checkLeftStick(e),this._checkButtons(e),this._processKeyMap(this._keyMap,.001),this.startButtonPressListener()}},{key:"_checkRightStick",value:function(e){var t=e.axes[2],n=e.axes[3];Math.abs(t)>.2&&(this._rotateHorizontal(.01*ae*t),this._update(),this.dispatchEvent(1)),Math.abs(n)>.2&&(this._rotateVertical(.01*ae*n),this._update(),this.dispatchEvent(1))}},{key:"_checkLeftStick",value:function(e){var t=e.axes[0],n=e.axes[1];Math.abs(n)>.2?0>n?this._keyMap.set(87,!0):this._keyMap.set(83,!0):e.buttons&&e.buttons[12]&&e.buttons[12].pressed?this._keyMap.set(87,!0):e.buttons&&e.buttons[13]&&e.buttons[13].pressed?this._keyMap.set(83,!0):(this._keyMap.set(87,!1),this._keyMap.set(83,!1)),Math.abs(t)>.2?0>t?this._keyMap.set(65,!0):this._keyMap.set(68,!0):(this._keyMap.set(65,!1),this._keyMap.set(68,!1))}},{key:"_checkButtons",value:function(e){e.buttons&&e.buttons[6]&&e.buttons[6].pressed?this._keyMap.set(16,!0):this._keyMap.set(16,!1),e.buttons&&e.buttons[14]&&e.buttons[14].pressed?(this._keyMap.set(37,!0),this.dispatchEvent(1)):this._keyMap.set(37,!1),e.buttons&&e.buttons[15]&&e.buttons[15].pressed?(this._keyMap.set(39,!0),this.dispatchEvent(1)):this._keyMap.set(39,!1)}},{key:"animateCamera",value:function(e){var t=this._cameraPosition,n=this._cameraRotation,i=this.getCamera(),a=m(t,i.position),o=y(n,i.quaternion);if(!t||a&&o)return!1;var r=this.getCamera().position.clone(),s=Math.min(10*e,1);r.lerp(t,s),this.getCamera().position.copy(r);var c=this.getCamera().quaternion.clone(),l=Math.min(5*e,1);c.slerp(n,l),this.getCamera().setRotationFromQuaternion(c);var h=!1;return this._keyMap.forEach(function(e){e&&(h=!0)}),h&&this._processKeyMap(this._keyMap,e),!0}},{key:"_getCamera",value:function(){return this._camera}},{key:"_initInputListener",value:function(){var e=this;window.addEventListener("keyup",this._onKeyChanged.bind(this),!1),window.addEventListener("keydown",this._onKeyChanged.bind(this),!1),this._inputListeners.push({key:3,fun:function(t){e._down(t)}}),this._inputListeners.push({key:6,fun:function(t){e._move(t)}}),this._inputListeners.push({key:4,fun:function(t){e._up(t)}})}},{key:"_down",value:function(e){this._downTime=Date.now(),this._downPosition=e.position,this._position=e.position,this._state=1,2===e.type&&(this._longDownTimer=window.setTimeout(this._onLongDown.bind(this),350)),2===e.type?this._rotationSpeed=.6:this._rotationSpeed=oe}},{key:"_move",value:function(e){this._position=e.position,1!==this._state||this._locked||this._orbit(new THREE.Vector2(e.position.x,e.position.y)),2!==this._state||this._locked||(this._orbit(new THREE.Vector2(e.position.x,e.position.y)),this._moveForward())}},{key:"_up",value:function(e){1===this._state&&this.dispatchEvent(2),2===this._state&&this._keyMap.set(87,!1),this._state=0,this._orbitPosition=null}},{key:"_onLongDown",value:function(){var e=v(this._downPosition,this._position);f>e&&1===this._state&&(this._state=2,this._orbit(new THREE.Vector2(this._position.x,this._position.y)),this._moveForward())}},{key:"_update",value:function(e){var t=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX");this._cameraRotation.setFromEuler(t,!0)}},{key:"updateCamera",value:function(){var e=this._domHelper.getClientDimensions(),t=e.x,n=e.y;this._camera.aspect=t/n,this._camera.updateProjectionMatrix()}},{key:"_onKeyChanged",value:function(e){this._keyMap.set(e.keyCode,"keydown"===e.type),this.dispatchEvent(6),this._processKeyMap(this._keyMap,.001)&&e.preventDefault()}},{key:"_processKeyMap",value:function(e,t){t=Math.min(t,.1);var n=new THREE.Vector3(0,0,0),i=!1;return this._processUpDown(e,n,t),e.get(65)&&(n.x=-1*t),e.get(68)&&(n.x=1*t),e.get(37)&&(this._rotateHorizontal(-ae*this._rotationSpeed*t),i=!0),e.get(39)&&(this._rotateHorizontal(ae*this._rotationSpeed*t),i=!0),e.get(16)&&(n.x*=3,n.z*=3),!(0===n.x&&0===n.y&&0===n.z&&!i||(n.applyQuaternion(this.getCamera().quaternion),this._cameraPosition.add(new THREE.Vector3(n.x,0,n.z)),this._update(),0))}},{key:"_processUpDown",value:function(e,t,n){(e.get(87)||e.get(38))&&(t.z=-1*n),(e.get(83)||e.get(40))&&(t.z=1*n)}},{key:"_orbit",value:function(e){this._orbitPosition||(this._orbitPosition=new THREE.Vector2(e.x,e.y),this.dispatchEvent(0));var t=e.clone().sub(this._orbitPosition),n=this._domHelper.element instanceof Document?this._domHelper.element.body:this._domHelper.element;this._rotateHorizontal(2*Math.PI*t.x/n.clientWidth*oe),this._rotateVertical(2*Math.PI*t.y/n.clientHeight*oe),g(this._orbitPosition,e)||this.dispatchEvent(1),this._orbitPosition.copy(e),this._update()}},{key:"_moveForward",value:function(){this._keyMap.set(87,!0),this._processKeyMap(this._keyMap,.001)}},{key:"_rotateVertical",value:function(e){var t=this._pitch+e;t>.7||-.4>t||(this._pitch=t,this._pitch<-Math.PI?this._pitch+=2*Math.PI:this._pitch>Math.PI&&(this._pitch-=2*Math.PI))}}]),t}(),se=function(t){function n(t,i,o){var c;return a(this,n),(c=r(this,s(n).call(this,t,P.HSP,o)))._roomlePlannerCallback=i,c._plannerMeshGenerator.maxAnisotrophy=c._renderer.capabilities.getMaxAnisotropy(),c._lightSetting=new e(c._scene),c._constructionGroup=new THREE.Group,c._addSky(),c._plannerSceneEventHandler=new ie(c._scene,c._cameraControl.getCamera(),c._getInputManager()),window.__RML__ENV__.initData.enableHSC&&c._plannerSceneEventHandler.addEventListener(0,function(e){var t=e.planObject;return c._switchToHSC(t.getRuntimeId())},l(l(c))),c._plannerKernelAccess.addPlannerListener(l(l(c))),c._componentFactory=W(),c}return c(n,ee),o(n,[{key:"zoomToComponent",value:function(e){var t=this;if(this._cameraControl instanceof R){this._cameraControl.saveState(!0);var n=e.getBounds(),i=n.getSize(new THREE.Vector3),a=this._getYRotationOfObject(e.getMesh()),o=new THREE.Euler(0,a,0),r=n.getCenter(new THREE.Vector3);this._cameraControl.zoomTo(i,this._renderer.getSize().width,this._renderer.getSize().height,o.y,S(15),r).then(function(){return t._switchToHSC(e.getRuntimeId())})}else this._switchToHSC(e.getRuntimeId())}},{key:"onBeforeRender",value:function(){var e=this;this._cameraControl instanceof R&&this._plannerMeshGenerator.wallMeshes.forEach(function(t){return M(e._cameraControl.getCamera(),t.material)})}},{key:"_getInputManager",value:function(){return this._plannerInputManager}},{key:"createCameraControl",value:function(e){this.setMode(e)}},{key:"resetCamera",value:function(){this._cameraControl.hasSavedState()?this.resetCameraToState():this.resetCameraPositionToStart()}},{key:"resetCameraToState",value:function(){this._cameraControl.resetToState()}},{key:"resetCameraPositionToStart",value:function(){this._requestRender()}},{key:"_getYRotationOfObject",value:function(e){var t=e.getWorldDirection(new THREE.Vector3).clone();t.y=0,.01>t.lengthSq()&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.normalize();var n=Math.asin(t.x);return 0>t.z&&(n=Math.PI-n),0>n&&(n+=2*Math.PI),n}},{key:"loadPlanObjects",value:function(e){var t=this,n=new Map;e.forEach(function(e){e.hasConfiguration()||(n.has(e.getCatalogItemId())?n.get(e.getCatalogItemId()).push(e):n.set(e.getCatalogItemId(),[e]))}),this._rapiAccess.getItems(Array.from(n.keys())).then(function(e){var i=[];e.forEach(function(e){t._plannerKernelAccess.catalogItemLoaded(e),n.get(e.id).forEach(function(n){i.push(t._addStaticItem(n,e))})}),Promise.all(i).then(function(){return t._staticItemsLoaded()})})}},{key:"_staticItemsLoaded",value:function(){this._requestRender(!0)}},{key:"preload",value:function(e){var t=this;this._planId=e;var n=localStorage.getItem(this._planId);n&&this._loadGLTF(n).then(function(e){t._preloadScene=e,t._scene.add(t._preloadScene),t._requestRender()})}},{key:"_addStaticItem",value:function(e,t){var n=this,i=this._getGLBUrl(t.threeDimensionalAssetWeb),a=new THREE.Vector3(e.size.x/t.width,e.size.z/t.height,e.size.y/t.depth);e.flipX&&(a.x*=-1),e.flipY&&(a.z*=-1);var o=K(e.getCenter()),r=U(e.size),s=this._plannerMeshGenerator.generatePreviewBox(r.clone(),o.clone(),e.rotation,e.customColor);return s.name=t.label,E(s),this._scene.add(s),new Promise(function(t){n._loadGLB(i,o,e.rotation,a,e.customColor).then(function(e){e.name=s.name,C(e,i),E(e),n._scene.add(e),w(s,n._scene),n._requestRender(),t()})})}},{key:"_getGLBUrl",value:function(e){var t=e.indexOf("/3d/")+4,n=e.indexOf("/",t),i=e.substring(t-1,n+1),a=e.replace(i,"/glb/");return a.replace(".flash.u3d",".glb")}},{key:"planXMLLoaded",value:function(e){this._plannerKernelAccess.planModelViewHelper.requestPlanMesh3d(e,!0);var t=e.getBounds();this._bounds=b(t);var n=this._domHelper.getClientDimensions(),i=n.x,a=n.y;this._cameraControl instanceof R&&this._cameraControl.updateAndReset(this._bounds.getSize(new THREE.Vector3),i,a,this._bounds.getCenter(new THREE.Vector3),-15,70,5,!1),this._cameraControl instanceof te&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),this._bounds.getCenter(new THREE.Vector3));var o=q(e.getPlanObjects());this.loadPlanObjects(o)}},{key:"planCompletelyLoaded",value:function(e){this._requestRender(),k.end("loadingTime"),this._planId&&this.exportGLB(this._constructionGroup.children,this._planId)}},{key:"handlerSwitchedPlans",value:function(e){e.setPlannerSceneEventHandler(this._plannerSceneEventHandler),this._plannerMeshGenerator.clear(),this.clearScene(),this._addSky(),this.resetCamera(),this._constructionGroup=new THREE.Group;var t=new THREE.PlaneGeometry(1e3,1e3);t.rotateX(-Math.PI/2);var n=new THREE.MeshPhysicalMaterial({color:"#ffffff",roughness:.5,metalness:.1}),i=new THREE.Mesh(t,n);i.name="Ground",i.position.y=-.01,i.receiveShadow=!0,this._scene.add(i)}},{key:"beginPlanConstruction",value:function(e){}},{key:"addPlanMesh",value:function(e,t,n,i,a,o,r){this._constructionGroup.add(this._plannerMeshGenerator.generateMesh(null,t,n,i,a,o,r))}},{key:"endPlanConstruction",value:function(t){var n=this;this.updateCamera(),this._renderLoopFunction=function(){n._scene.add(n._constructionGroup),n._lightSetting instanceof e&&n._lightSetting.setBounds(n._getConstructionBounds()),n._scene.remove(n._preloadScene)}}},{key:"addPlanObjectToScene",value:function(e){E(e),this._scene.add(e)}},{key:"exportGLB",value:function(e,t){var n=this;this._scriptLoader.fetch("static/three/lib/exporters/GLTFExporter.js",{id:"gltf-exporter"}).then(function(){var i=new THREE.GLTFExporter;e||(e=[],n._scene.children.forEach(function(t){n._isPartOfScene(t)&&e.push(t)})),i.parse(e,function(e){var n=t||"test";localStorage.setItem(n,JSON.stringify(e))},{binary:!1,embedImages:!0,forceIndices:!0})})}},{key:"importGLB",value:function(e){var t=this;this._loadGLB(e).then(function(e){return t._scene.add(e)})}},{key:"_addSky",value:function(){this._sky=new THREE.Sky,this._sky.name="Sky",this._sky.scale.setScalar(45e4),this._scene.add(this._sky);this._sky.material.uniforms.turbidity.value=10,this._sky.material.uniforms.rayleigh.value=2,this._sky.material.uniforms.luminance.value=1,this._sky.material.uniforms.mieCoefficient.value=.005,this._sky.material.uniforms.mieDirectionalG.value=.8;var t=new THREE.Mesh(new THREE.SphereBufferGeometry(2e4,16,8),new THREE.MeshBasicMaterial({color:16777215}));t.name="Sunsphere",t.position.y=-7e5,t.visible=!1,this._scene.add(t);var n=-.2*Math.PI,i=2*Math.PI*-.25;t.position.x=4e5*Math.cos(i),t.position.y=4e5*Math.sin(i)*Math.sin(n),t.position.z=4e5*Math.sin(i)*Math.cos(n),t.visible=!0,this._sky.material.uniforms.sunPosition.value.copy(t.position),this._lightSetting instanceof e&&this._lightSetting.updateSunPosition(.3,.25)}},{key:"switchTo2D",value:function(){this._cameraControl instanceof te||(this._requestRender(),this._changeCameraControl(new te(this._getInputManager())),this._bounds&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),this._bounds.getCenter(new THREE.Vector3)),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._roomlePlannerUiCallback.onCameraChanged("2D"))}},{key:"switchTo3D",value:function(){if(!(this._cameraControl instanceof R)){this._changeCameraControl(new R(this._getInputManager(),this._domHelper.element,new THREE.Vector3(0,10,0)));var e=this._domHelper.getClientDimensions(),t=e.x,n=e.y;this._bounds&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),t,n,!1,!0,this._bounds.getCenter(new THREE.Vector3)),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._roomlePlannerUiCallback.onCameraChanged("3D")}}},{key:"cameraControlChanged",value:function(){h(s(n.prototype),"cameraControlChanged",this).call(this),this._plannerSceneEventHandler&&this._plannerSceneEventHandler.setCamera(this._cameraControl.getCamera())}},{key:"_switchToHSC",value:function(e){this._roomlePlannerCallback.switchToHsc(e)}},{key:"closeHSC",value:function(){this._requestRender(),this._cameraControl instanceof R&&this._cameraControl.resetToState(),this._pixotron&&this.enableHD()}},{key:"switchToFirstPerson",value:function(){if(!(this._cameraControl instanceof re)){this._plannerMeshGenerator.wallMeshes.forEach(function(e){return L(e.material,!1,!1)}),this._requestRender();var e=new THREE.Vector3(0,0,0);this._constructionGroup&&(e=this._getConstructionBounds().getCenter(new THREE.Vector3)),this._cameraControl&&this._cameraControl.cleanUp(),this._cameraControl=new re(this._getInputManager(),e),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._roomlePlannerUiCallback.onCameraChanged("FP")}}},{key:"_getConstructionBounds",value:function(){var e=new THREE.Box3;return e.setFromObject(this._constructionGroup),e}},{key:"_onKeyDown",value:function(e){h(s(n.prototype),"_onKeyDown",this).call(this,e),(e.key&&"1"===e.key||49===e.keyCode)&&(this.switchTo2D(),e.preventDefault()),(e.key&&"2"===e.key||50===e.keyCode)&&(this.switchTo3D(),e.preventDefault()),(e.key&&"3"===e.key||51===e.keyCode)&&(this.switchToFirstPerson(),e.preventDefault())}},{key:"setMode",value:function(e){switch(e){case"2D":this.switchTo2D();break;case"3D":this.switchTo3D();break;case"FP":this.switchToFirstPerson()}}}]),n}();n([i],se.prototype,"_plannerKernelAccess",void 0),n([i],se.prototype,"_rapiAccess",void 0),n([i],se.prototype,"_plannerMeshGenerator",void 0),n([i],se.prototype,"_plannerInputManager",void 0),n([i],se.prototype,"_roomlePlannerUiCallback",void 0);var ce=function(){function e(){a(this,e),this._hscInstance=null,this._glbInstance=null,this._canvasStack=[P.HSP],this._kernelCallback.addListener(this)}return o(e,[{key:"init",value:function(e,t,n){return k.start("loadingTime"),this._domHelper.setDomElement(e),this._preloadPlanId=t,this.setOverrides(n),new Promise(this._initPromiseCallback.bind(this))}},{key:"loadPlanXml",value:function(e,t){var n=this;return this._hscInstance&&this._hscInstance.getApi().cleanup(),this.setOverrides(t),new Promise(function(t){n._plan=n._planInteractionHandler.loadPlanXML(e),n._plannerSceneManager.planXMLLoaded(n._plan),n._roomlePlannerUiCallback.onTotalFloorAreaChanged(n._planInteractionHandler.getPlan().getTotalFloorArea()),t()})}},{key:"loadPlan",value:function(e,t){var n=this;return this._hscInstance&&this._hscInstance.getApi().cleanup(),this.setOverrides(t),new Promise(function(t,i){n._rapiAccess.getPlan(e).then(function(e){n._plan=n._planInteractionHandler.loadPlanXML(e.planObjects),n._plannerSceneManager.planXMLLoaded(n._plan),n._roomlePlannerUiCallback.onTotalFloorAreaChanged(n._planInteractionHandler.getPlan().getTotalFloorArea()),t()},i)})}},{key:"setOverrides",value:function(e){e&&(window.__RML__ENV__.initData=Object.assign(window.__RML__ENV__.initData,e),e.overrideTenant&&this._rapiAccess.overrideTenant(e.overrideTenant),e.overrideCountry&&this._rapiAccess.overrideCountry(e.overrideCountry),e.overrideRapi&&this._rapiAccess.overrideRapi(e.overrideRapi))}},{key:"switch2D",value:function(){this._plannerSceneManager.switchTo2D()}},{key:"switch3D",value:function(){this._plannerSceneManager.switchTo3D()}},{key:"switchToFirstPerson",value:function(){this._plannerSceneManager.switchToFirstPerson()}},{key:"exportGLB",value:function(){this._plannerSceneManager.exportGLB()}},{key:"importGLB",value:function(e){this._plannerSceneManager.importGLB(e)}},{key:"_initPromiseCallback",value:function(e,t){var n=this;this._kernelReadyCallback=e,this._scriptLoader.fetch("static/three/lib/rthree.js",{id:"three-lib"}).then(function(){var e=n._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader"}),t=n._scriptLoader.fetch("static/three/Tween.js",{id:"tween-js"}),i=n._scriptLoader.fetch("static/three/lib/objects/Sky.js",{id:"sky-js"});Promise.all([e,t,i]).then(function(){var e=window.__RML__ENV__.initData.mode;n._plannerSceneManager=new se({left:0,top:1,right:1,bottom:0},n,e);var t=window.__RML__ENV__.initData.stats;n._preloadPlanId&&n._plannerSceneManager.preload(n._preloadPlanId),t?n.showStats():n.enableHD(),n._planInteractionHandler&&n._kernelReadyCallback()})})}},{key:"enableHD",value:function(){var e=this;return new Promise(function(t,n){var i=function(){e._plannerSceneManager.enableHD(),t()};Promise.all([e._scriptLoader.fetch("static/three/lib/postprocessing/EffectComposer.js",{id:"effect-composer-js"}),e._scriptLoader.fetch("static/three/lib/lights/RectAreaLightUniformsLib.js",{id:"rect-area-light-uniforms-lib-js"}),e._scriptLoader.fetch("static/three/lib/postprocessing/ShaderPass.js",{id:"shader-pass-js"}),e._scriptLoader.fetch("static/three/lib/postprocessing/RenderPass.js",{id:"render-pass-js"}),e._scriptLoader.fetch("static/three/lib/shaders/CopyShader.js",{id:"copy-shader-js"})]).then(function(){e._scriptLoader.fetch("static/three/pixotron.min.js",{id:"pixotron-js"}).then(i,n)},n)})}},{key:"isReady",value:function(){this._planInteractionHandler=this._plannerKernelAccess.planInteractionHandler,this._kernelReadyCallback&&this._kernelReadyCallback()}},{key:"showBenchmarks",value:function(){k.showBenchmarks()}},{key:"_bringIntoForeground",value:function(e){var t=this,n=document.querySelectorAll("canvas"),i=!1;return n.forEach(function(n){n.classList.contains(e)?(n.classList.contains("foreground")||(t._canvasStack.push(e),i=!0),n.classList.remove("background"),n.classList.add("foreground")):(n.classList.remove("foreground"),n.classList.add("background"))}),i}},{key:"switchToHsc",value:function(e){var n=this;return this._singlePromiseFactory.create(3,"startHSC",function(i){if(n._hscInstance)return n._hscInstance.getApi().resume(),i();t.import("./configurator.legacy.js").then(function(t){var a=new t.Configurator;a.boot({kernelInstance:n._planInteractionHandler.getConfiguratorKernel(),kernelContainer:n._plannerKernelAccess.kernelContainer,planObjectId:e}),a.getApi().init(n._domHelper.element).then(function(){n._hscInstance=a,i()})})}).then(function(){n._hscInstance.getApi().syncPlanObjectToView(-1,e),n._bringIntoForeground(P.HSC),n._roomlePlannerUiCallback.onSwitchToHSCFinished(),n._roomlePlannerUiCallback.onBackStackChanged(n._canvasStack)})}},{key:"switchToGLB",value:function(e){var n=this;return this._singlePromiseFactory.create(4,"startGLB",function(e){if(n._glbInstance)return e();t.import("./glb-viewer.legacy.js").then(function(t){var i=new t.GlbViewer;i.boot(),window.RoomleGLBViewer.init(n._domHelper.element).then(function(){n._glbInstance=i,e()})})}).then(function(){n._glbInstance.getApi().loadGLB(e),n._bringIntoForeground(P.GLB),n._roomlePlannerUiCallback.onBackStackChanged(n._canvasStack)})}},{key:"switchToPlanner",value:function(e){e&&this.loadPlan(e),this._bringIntoForeground(P.HSP),this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)}},{key:"back",value:function(){if(1!==this._canvasStack.length){this._canvasStack.pop();var e=this._canvasStack.pop();this._bringIntoForeground(e),e===P.HSP&&this._plannerSceneManager.closeHSC(),this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)}}},{key:"backTo",value:function(e){if(1!==this._canvasStack.length){for(var t=!1,n=this._canvasStack.length-1;n>=0;n--){var i=this._canvasStack.pop();i===e?this._bringIntoForeground(i):(i===P.HSC&&this._plannerSceneManager.closeHSC(),t=!0)}t&&this._roomlePlannerUiCallback.onBackStackChanged(this._canvasStack)}}},{key:"updateSize",value:function(){this._plannerSceneManager.updateCamera()}},{key:"update",value:function(){this.updateSize(),this._glbInstance&&this._glbInstance.getApi().updateSize(),this._hscInstance&&this._hscInstance.getApi().updateSize()}},{key:"showStats",value:function(){this._plannerSceneManager.showStats()}},{key:"callbacks",get:function(){return this._roomlePlannerUiCallback},set:function(e){this._roomlePlannerUiCallback=e}}]),e}();n([i],ce.prototype,"_domHelper",void 0),n([i],ce.prototype,"_scriptLoader",void 0),n([i],ce.prototype,"_kernelCallback",void 0),n([i],ce.prototype,"_plannerKernelAccess",void 0),n([i],ce.prototype,"_rapiAccess",void 0),n([i],ce.prototype,"_singlePromiseFactory",void 0),n([i],ce.prototype,"_roomlePlannerUiCallback",void 0);var le=function(){function e(t){a(this,e),this._coreReference=t.clone()}return o(e,[{key:"clearReference",value:function(){this._coreReference.delete(),this._coreReference=null}}]),e}(),he=function(e){function t(e){var n;a(this,t),n=r(this,s(t).call(this,e));var i=K(e.getCenter());n._object=new THREE.Object3D,n._object.name=e.getObjectType(),n._object.position.copy(i),n._object.rotateY(e.rotation);var o=U(e.size),c=new THREE.BoxBufferGeometry(o.x,o.y,o.z);return n._boundingBox=new THREE.Mesh(c,D()),n._boundingBox.name=e.getCatalogItemId(),n._boundingBox.position.y+=o.y/2,n._boundingBox.receiveShadow=!1,n._boundingBox.castShadow=!1,n._object.add(n._boundingBox),n}return c(t,le),o(t,[{key:"getBounds",value:function(){var e=new THREE.Box3;return e.setFromObject(this._object),e}},{key:"getBoundingBox",value:function(){return this._boundingBox}},{key:"gePlanObject",value:function(){return this._coreReference}},{key:"getMesh",value:function(){return this._object}},{key:"getRuntimeId",value:function(){return this.gePlanObject().getConfigurationRuntimeId()}},{key:"clear",value:function(){T(this._boundingBox),H(this._object)}}]),t}(),ue=function(e){function t(e){var n;return a(this,t),(n=r(this,s(t).call(this,e)))._object.name="Configurable "+n._object.name,n}return c(t,he),o(t,[{key:"addRootComponent",value:function(e){this._object.add(e)}},{key:"clear",value:function(){h(s(t.prototype),"clear",this).call(this)}}]),t}(),de=function(e){function t(e){var n;return a(this,t),(n=r(this,s(t).call(this,e)))._components=new Map,n._planObjectViewModels=[],n._plannerKernelAccess.addConfiguratorListener(l(l(n))),n._componentFactory=W(),n}return c(t,le),o(t,[{key:"clearReference",value:function(){h(s(t.prototype),"clearReference",this).call(this),this._plannerKernelAccess.removeConfiguratorListener(this)}},{key:"getCorePlan",value:function(){return this._coreReference}},{key:"addPlanObjectViewModel",value:function(e){this._planObjectViewModels.push(e)}},{key:"_addComponent",value:function(e,t){var n=this._components.get(e.parentObjectId);if(this._components.set(e.roomleId,e),t){var i=this._getPlanObjectViewModelForRuntimeId(e.parentObjectId);i&&i instanceof ue&&(i.addRootComponent(e),this._plannerSceneEventHandler.addPlanObjectHandlers(i))}n&&n.add(e)}},{key:"_addMeshToComponentId",value:function(e,t){var n=this._components.get(t);n&&n.addMesh(e)}},{key:"_updateComponentInformation",value:function(e){var t=this._components.get(e.id);t&&(t.position.copy(K(e.position)),t.rotation.copy(N(e.rotation)))}},{key:"_getPlanObjectViewModelForRuntimeId",value:function(e){var t=null;return this._planObjectViewModels.forEach(function(n){e===n.getRuntimeId()&&(t=n)}),t}},{key:"Editor3dComponentCreated",value:function(e,t,n,i,a){if(!this._components.has(e)){var o=this._componentFactory.create(e,t,n,i);o.layers.set(3),this._addComponent(o,a)}}},{key:"Editor3dAddBakedMesh",value:function(e,t,n,i,a,o){var r=this._plannerMeshGenerator.generateMesh(null,t,n,i,a,o);this._addMeshToComponentId(r,e)}},{key:"Editor3dAddNamedMesh",value:function(e,t,n,i,a,o,r,s){var c=this._plannerMeshGenerator.generateMesh(t,n,a,o,r,s);i&&c.applyMatrix(X(i)),this._addMeshToComponentId(c,e)}},{key:"updateComponentMetaInformation",value:function(e){this._updateComponentInformation(e)}},{key:"setPlannerSceneEventHandler",value:function(e){this._plannerSceneEventHandler=e}},{key:"Editor3dComponentDocked",value:function(e,t,n,i){var a=this._components.get(t),o=this._components.get(e);o&&(o.roomlePosition=n,o.roomleRotation=i,a.add(o))}},{key:"Editor3dBeginConstruction",value:function(e){var t=this._components.get(e);t&&t.removeAllMeshes()}},{key:"Editor3dGeometryNotReady",value:function(e){this._components.has(e)&&this._components.get(e).loading()}},{key:"sceneCleared",value:function(){this._planObjectViewModels.forEach(function(e){e.clear()}),this._components.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._components.clear()}},{key:"componentDeleted",value:function(e){var t=this._components.get(e);t&&(t.removeFromParent(),t.removeAllMeshes(),this._components.delete(e))}}]),t}();n([i],de.prototype,"_plannerKernelAccess",void 0),n([i],de.prototype,"_plannerMeshGenerator",void 0);var _e=function(e){function t(){var e;return a(this,t),(e=r(this,s(t).call(this,0)))._plannerKernelCallbackListener=new Set,e._configuratorKernelCallbackListener=new Set,k.addMeta("kernel_is_ready",{isWasm:e._useWASM}),e._scriptLoader.fetch(e._kernelPath,{id:"kernel"}).then(e._loadSuccess.bind(l(l(e))),e._loadError.bind(l(l(e)))),e}return c(t,Y),o(t,[{key:"_loadSuccess",value:function(){window.RoomleCore(this._kernelContainer)}},{key:"_loadError",value:function(){console.error("kernel load error")}},{key:"addPlannerListener",value:function(e){this._plannerKernelCallbackListener.add(e)}},{key:"removePlannerListener",value:function(e){this._plannerKernelCallbackListener.delete(e)}},{key:"addConfiguratorListener",value:function(e){this._configuratorKernelCallbackListener.add(e)}},{key:"removeConfiguratorListener",value:function(e){this._configuratorKernelCallbackListener.delete(e)}},{key:"isReady",value:function(){h(s(t.prototype),"isReady",this).call(this);var e=this._kernelContainer;e.registerPlannerCallback(this),e.registerConfiguratorCallback(this),this._planInteractionHandler=new e.PlanInteractionHandler,this._planInteractionHandler.init(this._planInteractionHandler,1,300,!1,!0,e.DrawingType.CLICK_PER_CLICK),this._kernelInstance=this._planInteractionHandler.getConfiguratorKernel(),J.isProduction||(window.__RML__DEBUG__.ConfiguratorKernel=this._kernelInstance,window.__RML__DEBUG__.PlannerKernelContainer=this._kernelContainer),this._kernelCallback.isReady()}},{key:"catalogItemLoaded",value:function(e){var t=new this._kernelContainer.CatalogItem(e.id);t.size={x:e.width,y:e.height,z:e.depth},t.flipable=e.flipable,t.layer=e.layer,t.orderable=e.orderable,t.scaleable=e.scaleable,t.type=e.type,this._kernelContainer.catalogItemLoaded(t)}},{key:"onLoadComponentError",value:function(e){}},{key:"configurationLoaded",value:function(e,t,n,i,a){}},{key:"componentDefinitionLoaded",value:function(e,t){}},{key:"componentDefinitionLoadingError",value:function(e,t){}},{key:"configurationLoadingError",value:function(){}},{key:"componentConfigurationUpdated",value:function(e){}},{key:"componentMetaUpdated",value:function(e){var t=q(this._kernelInstance.getComponent(e));this._configuratorKernelCallbackListener.forEach(function(e){return e.updateComponentMetaInformation(t)})}},{key:"componentParameters",value:function(){}},{key:"componentDeleted",value:function(e){this._configuratorKernelCallbackListener.forEach(function(t){return t.componentDeleted(e)})}},{key:"requestComponentDimensions",value:function(){}},{key:"planObjectCreated",value:function(e,t){}},{key:"planObjectUpdated",value:function(e){}},{key:"planObjectConfigurationUpdated",value:function(e,t,n){}},{key:"planObjectDeleted",value:function(){}},{key:"requestPlanObjectDimensions",value:function(){}},{key:"sceneCleared",value:function(){this._configuratorKernelCallbackListener.forEach(function(e){return e.sceneCleared()})}},{key:"requestExternalMesh",value:function(e,t){var n=this;return new Promise(function(i,a){n._rapiAccess.getMesh(e,Q,t).then(function(o){fetch(new Request(n._dataSyncer.requestAsset(o.url,!0))).then(function(e){return e.arrayBuffer()}).then(function(a){try{n._kernelContainer.addMeshCorto(e,t,new Uint8Array(a)),i()}catch(e){console.error(e),i()}}).catch(function(e){console.error(e),a(e)})},function(e){console.error(e),a(e)})})}},{key:"Editor3dComponentCreated",value:function(e,t,n,i){this._configuratorKernelCallbackListener.forEach(function(a){return a.Editor3dComponentCreated(e,t,n,i,!1)})}},{key:"Editor3dRootComponentCreated",value:function(e,t,n,i){this._configuratorKernelCallbackListener.forEach(function(a){return a.Editor3dComponentCreated(e,t,n,i,!0)})}},{key:"Editor3dBeginConstruction",value:function(e){this._configuratorKernelCallbackListener.forEach(function(t){return t.Editor3dBeginConstruction(e)})}},{key:"Editor3dEndConstruction",value:function(e){}},{key:"Editor3dGeometryReady",value:function(e){this._kernelInstance.requestPlanComponentConstruction(e)}},{key:"Editor3dGeometryNotReady",value:function(e){this._configuratorKernelCallbackListener.forEach(function(t){return t.Editor3dGeometryNotReady(e)})}},{key:"Editor3dPlanObjectConstructionDone",value:function(e){}},{key:"Editor3dBeginGroup",value:function(){}},{key:"Editor3dEndGroup",value:function(){}},{key:"Editor3dSetMaterial",value:function(){}},{key:"Editor3dLoadMaterial",value:function(){}},{key:"Editor3dAddDockPreview",value:function(e,t){}},{key:"Editor3dSetPreviewPointAssociations",value:function(e,t){}},{key:"Editor3dSetPreviewLineAssociations",value:function(e,t){}},{key:"Editor3dPreviewConstructionDone",value:function(e,t){}},{key:"Editor3dTranslateBy",value:function(){}},{key:"Editor3dRotateBy",value:function(){}},{key:"Editor3dRotateAround",value:function(){}},{key:"Editor3dAddCube",value:function(){}},{key:"Editor3dAddCubeUVMod",value:function(){}},{key:"Editor3dAddSphere",value:function(){}},{key:"Editor3dAddSphereUVMod",value:function(){}},{key:"Editor3dAddRectangle",value:function(){}},{key:"Editor3dAddRectangleUVMod",value:function(){}},{key:"Editor3dAddMesh",value:function(){}},{key:"Editor3dAddMeshUVMod",value:function(){}},{key:"Editor3dAddMeshUVCoord",value:function(){}},{key:"Editor3dAddCylinder",value:function(){}},{key:"Editor3dAddCylinderUVMod",value:function(){}},{key:"Editor3dAddPrism",value:function(){}},{key:"Editor3dAddPrismUVMod",value:function(){}},{key:"Editor3dAddFittingPoint",value:function(){}},{key:"Editor3dAddFittingLine",value:function(){}},{key:"Editor3dSelectObject",value:function(){}},{key:"Editor3dCopy",value:function(){}},{key:"Editor3dComponentDocked",value:function(e,t,n,i){this._configuratorKernelCallbackListener.forEach(function(a){return a.Editor3dComponentDocked(e,t,n,i)})}},{key:"Editor3dUpdatePlanObjectPosition",value:function(){}},{key:"Editor3dUpdatePlanObjectRotation",value:function(){}},{key:"Editor3dUpdatePlanObjectTransform",value:function(){}},{key:"Editor3dUpdatePlanComponentPosition",value:function(){}},{key:"Editor3dUpdatePlanComponentRotation",value:function(){}},{key:"Editor3dUpdatePlanComponentTransform",value:function(){}},{key:"Editor3dAddBakedMesh",value:function(e,t,n,i,a,o){this._configuratorKernelCallbackListener.forEach(function(r){return r.Editor3dAddBakedMesh(e,t,n,i,a,o)})}},{key:"Editor3dAddNamedMesh",value:function(e,t,n,i,a,o,r,s){this._configuratorKernelCallbackListener.forEach(function(c){return c.Editor3dAddNamedMesh(e,t,n,i,a,o,r,s)})}},{key:"elementDeleted",value:function(e){this._decoupleReferences(e)}},{key:"handlerSwitchedPlans",value:function(e,t){if(this._decoupleReferences(e),t){var n=new de(t);this._coupleReferences(n,t),this._plannerKernelCallbackListener.forEach(function(e){return e.handlerSwitchedPlans(n)})}}},{key:"planBoundsChanged",value:function(){}},{key:"planCleared",value:function(){}},{key:"planCompletelyLoaded",value:function(e){this._plannerKernelCallbackListener.forEach(function(t){return t.planCompletelyLoaded(e)})}},{key:"planElement3dMeshChanged",value:function(e,t){}},{key:"planElementAdded",value:function(e,t){if(e&&e.extRef&&t.getType()===this._kernelContainer.PlanElementType.OBJECT){var n=t;if(n.hasConfiguration()){var i=new ue(n);this._coupleReferences(i,n),e.extRef.jsObject.addPlanObjectViewModel(i),this._plannerKernelCallbackListener.forEach(function(e){return e.addPlanObjectToScene(i.getMesh())})}}}},{key:"planElementChanged",value:function(e,t){}},{key:"planHistoryStateChanged",value:function(){}},{key:"planObjectConfigurationCreated",value:function(e,t){}},{key:"planObjectConfigurationLoaded",value:function(e,t,n){if(e&&e.extRef&&t&&t.extRef){var i=t.extRef.jsObject.gePlanObject().getConfigurationRuntimeId();i>0&&this._kernelInstance.requestPlanObjectConstruction(i)}}},{key:"requestCatalogItem",value:function(e){}},{key:"startedDrawing",value:function(){}},{key:"stoppedDrawing",value:function(){}},{key:"updateMesh2d",value:function(){}},{key:"beginConstruction",value:function(){}},{key:"addMesh",value:function(){}},{key:"endConstruction",value:function(){}},{key:"beginPlanConstruction",value:function(e){this._plannerKernelCallbackListener.forEach(function(t){return t.beginPlanConstruction(e)})}},{key:"addPlanMesh",value:function(e,t,n,i,a,o,r){this._plannerKernelCallbackListener.forEach(function(s){return s.addPlanMesh(e,t,n,i,a,o,r)})}},{key:"endPlanConstruction",value:function(e){this._plannerKernelCallbackListener.forEach(function(t){return t.endPlanConstruction(e)})}},{key:"_coupleReferences",value:function(e,t){var n=new this._kernelContainer.EMSReference;n.jsObject=e,t.extRef=n}},{key:"_decoupleReferences",value:function(e){e&&e.extRef&&(e.extRef.jsObject.clearReference(),e.extRef.jsObject=null,e.extRef.delete(),e.extRef=null)}},{key:"kernelContainer",get:function(){return this._kernelContainer}},{key:"planInteractionHandler",get:function(){return this._planInteractionHandler}},{key:"planModelViewHelper",get:function(){return this._kernelContainer.PlanModelViewHelper}}]),t}();n([i],_e.prototype,"_kernelCallback",void 0);var pe=function(){function e(){a(this,e),this._callbackListener=new Set}return o(e,[{key:"addListener",value:function(e){this._callbackListener.add(e)}},{key:"removeListener",value:function(e){this._callbackListener.delete(e)}},{key:"isReady",value:function(){this._callbackListener.forEach(function(e){return e.isReady()})}}]),e}(),fe=function(e){function t(){var e;return a(this,t),(e=r(this,s(t).call(this)))._wallMeshes=[],e._standardFloorMaterial=new THREE.MeshPhysicalMaterial({color:"#e7d8c5",roughness:.7}),e._standardWallMaterial=new THREE.MeshPhysicalMaterial({color:"#ffffff",roughness:.5,metalness:.1}),e}return c(t,Z),o(t,[{key:"generateMesh",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,r=arguments.length>6?arguments[6]:void 0,s=this._generateGeometry(e,n,i,a,o),c=new THREE.Mesh(s,this._previewMaterial);return c.receiveShadow=!0,c.castShadow=!0,c.layers.set(3),!t&&r&&7!==r.value?(console.warn("material is undefined"),c):(this._setMaterial(c,t,r),this._checkWallMaterial(c,r),c)}},{key:"_setMaterial",value:function(e,t,n){n&&7===n.value?this.changeMaterialOfMesh(e,this._standardWallMaterial):t.materialId&&""!==t.materialId?this._waitingForMaterials.push(this._assignMaterial(e,t.id)):t.catalogItemId&&""!==t.catalogItemId?this._waitingForMaterials.push(this._assignItem(e,t.catalogItemId)):t.rgbValue>0?this._waitingForMaterials.push(this._assignRGB(e,t.rgbValue)):t.length>0?this._waitingForMaterials.push(this._assignMaterial(e,t)):t.uvScale?this.changeMaterialOfMesh(e,this._standardFloorMaterial):n&&1===n.value?this.changeMaterialOfMesh(e,this._standardWallMaterial):console.warn("material not supported",t)}},{key:"_assignRGB",value:function(e,t){var n=this;return new Promise(function(i,a){var o,r="rbg"+JSON.stringify(t);n._materialCache.has(r)?o=n._materialCache.get(r):(o=new THREE.MeshStandardMaterial({color:t}),n._materialCache.set(r,o)),n.changeMaterialOfMesh(e,o),setTimeout(function(){return i()},0)})}},{key:"_assignItem",value:function(e,t){var n=this;return new Promise(function(i,a){if(n._materialCache.has(t))return n.changeMaterialOfMesh(e,n._materialCache.get(t)),void i();n._rapiAccess.getItem(t).then(function(o){o.topImage?n._textureLoader.load(o.topImage,function(a){a.anisotropy=n._maxAnisotrophy,a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping;var r=new THREE.Vector2(1,1);o.width>0&&(r.x=1/o.width),o.depth>0&&(r.y=1/o.depth),a.repeat.set(r.x,r.y);var s=new THREE.MeshPhysicalMaterial({map:a,roughness:.5,metalness:.1});n._materialCache.set(t,s),n.changeMaterialOfMesh(e,s),setTimeout(function(){return i()},0)}):(console.warn("can not set material, catalog item top image is not set"),a())},a)})}},{key:"_assignMaterial",value:function(e,t){var n=this;return new Promise(function(i,a){if(n._materialCache.has(t))return n.changeMaterialOfMesh(e,n._materialCache.get(t)),void i();n._rapiAccess.getMaterial(t).then(function(a){var o=x(a,n._environmentLoader.getEnvironmentMap());n._rapiAccess.getTexturesOf(a).then(function(a){var r=[];a.forEach(function(e){r.push(I(n._dataSyncer.requestAsset(e.image,!0),e,o,n._maxAnisotrophy,1/(0===e.mmWidth?1:e.mmWidth),1/(0===e.mmHeight?1:e.mmHeight)))}),Promise.all(r).then(function(){n._materialCache.set(t,o),n.changeMaterialOfMesh(e,o),setTimeout(function(){return i()},0)})}),(!a.textures||a.textures&&0===a.textures.length)&&(n._materialCache.set(t,o),n.changeMaterialOfMesh(e,o),setTimeout(function(){return i()},0))},a)})}},{key:"changeMaterialOfMesh",value:function(e,t){e?(e.material=t,e.material.needsUpdate=!0):console.warn("could not find mesh with id "+e.id)}},{key:"_checkWallMaterial",value:function(e,t){t&&1===t.value&&this._wallMeshes.push(e)}},{key:"clear",value:function(){h(s(t.prototype),"clear",this).call(this),this.clearWallMeshes()}},{key:"clearWallMeshes",value:function(){this._wallMeshes.forEach(function(e){T(e)}),this._wallMeshes=[]}},{key:"_onBeforeRender",value:function(e,t,n,i,a,o){M(n,a)}},{key:"maxAnisotrophy",set:function(e){this._maxAnisotrophy=e}},{key:"wallMeshes",get:function(){return this._wallMeshes}}]),t}(),ge=function(e){function t(){return a(this,t),r(this,s(t).apply(this,arguments))}return c(t,A),t}(),me=[new B("script-loader",O),new B("dom-helper",j),new B("planner-input-manager",ge),new B("planner-kernel-access",_e),new B("logger",V),new B("kernel-callback",pe),new B("planner-mesh-generator",fe),new B("rapi-access",$),new B("roomle-planner-ui-callback",function e(){a(this,e),this.onSwitchToHSCFinished=function(){},this.onBackStackChanged=function(e){},this.onCameraChanged=function(e){},this.onTotalFloorAreaChanged=function(e){}})];!function(e){function t(){return a(this,t),r(this,s(t).apply(this,arguments))}c(t,F),o(t,[{key:"setupGlobals",value:function(){}},{key:"setupDependencies",value:function(){G.setup(me),this.lookup("logger"),this.lookup("planner-kernel-access")}},{key:"cleanUpGlobals",value:function(){throw new Error("Method not implemented.")}},{key:"cleanUpDependencies",value:function(){throw new Error("Method not implemented.")}},{key:"bootFinished",value:function(){this._planner=new ce,window.RoomlePlanner||(window.RoomlePlanner=this._planner)}},{key:"getApi",value:function(){return this._planner}},{key:"pause",value:function(){throw new Error("Method not implemented.")}}])}()}}});
//# sourceMappingURL=planner.legacy.js.map
