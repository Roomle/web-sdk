System.register(["./chunk-5c02f558.legacy.js","./chunk-bdfc64db.legacy.js","./chunk-4be69068.legacy.js","./chunk-fd9e660e.legacy.js","./chunk-38ed5840.legacy.js"],function(e,t){var i,n,a,s,r,o,h,l,c,d,_,p,g,m,u,C,b,w,E,L,f,M,k,S,y,P,v,R,H,T,I,j,D,O,x,V,A,B,G,F,U,K,z,q,N;return{setters:[function(e){i=e.b,n=e.c},function(e){a=e.d,s=e.e,r=e.b,o=e.J,h=e.K,l=e.L,c=e.M,d=e.N,_=e.g,p=e.h,g=e.p,m=e.a,u=e.O,C=e.P,b=e.f,w=e.i,E=e.j,L=e.Q,f=e.B,M=e.s,k=e.t,S=e.v,y=e.y,P=e.w,v=e.z,R=e.A},function(e){H=e.a,T=e.b},function(e){I=e.a,j=e.m,D=e.n,O=e.b,x=e.d,V=e.o,A=e.g,B=e.h,G=e.c,F=e.j,U=e.k,K=e.l},function(e){z=e.a,q=e.b,N=e.c}],execute:function(){class W extends a{constructor(e,t){super(e,t),this._center=new THREE.Vector3(0,0,0),this._params={ambientLight:{color:"#ffffff"},mainDirLight:{position:{x:-1,y:12,z:1},color:"#ffffff"},secondDirLight:{position:{x:3,y:12,z:-3},color:"#f0faff"}},this._ambientLight=new THREE.AmbientLight(new THREE.Color(this._params.ambientLight.color),.8),this._ambientLight.layers.set(1),this._mainDirLight=new THREE.DirectionalLight(new THREE.Color(this._params.mainDirLight.color),.2),this._mainDirLight.position.set(this._params.mainDirLight.position.x,this._params.mainDirLight.position.y,this._params.mainDirLight.position.z),this._mainDirLight.castShadow=!0,this._mainDirLight.shadow.camera.near=.5,this._mainDirLight.shadow.camera.far=100,this._mainDirLight.shadow.mapSize=new THREE.Vector2(1024,1024),this._mainDirLight.visible=!0,this._secondDirLight=new THREE.DirectionalLight(new THREE.Color(this._params.secondDirLight.color),.4),this._secondDirLight.position.set(this._params.secondDirLight.position.x,this._params.secondDirLight.position.y,this._params.secondDirLight.position.z),this._secondDirLight.castShadow=!1,this._secondDirLight.shadow.camera.near=.5,this._secondDirLight.shadow.camera.far=100,this._secondDirLight.shadow.mapSize=new THREE.Vector2(1024,1024),this._secondDirLight.visible=!1,this.addToScene()}updateSunPosition(e,t){}addToScene(){this._scene.add(this._mainDirLight),this._scene.add(this._secondDirLight),this._scene.add(this._ambientLight)}removeFromScene(){this._scene.remove(this._mainDirLight),this._scene.remove(this._secondDirLight),this._scene.remove(this._ambientLight)}reload(){this.removeFromScene(),this.addToScene()}setBounds(e){this._center.copy(e.getCenter(new THREE.Vector3)),this._mainDirLight.position.copy(new THREE.Vector3(this._params.mainDirLight.position.x,this._params.mainDirLight.position.y,this._params.mainDirLight.position.z).add(this._center)),this._secondDirLight.position.copy(new THREE.Vector3(this._params.secondDirLight.position.x,this._params.secondDirLight.position.y,this._params.secondDirLight.position.z).add(this._center)),this._mainDirLight.lookAt(this._center),this._secondDirLight.lookAt(this._center);const t=e.getSize(new THREE.Vector3),i=(Math.max(Math.max(t.x,t.y),t.z)+10)/2;this._mainDirLight.shadow.camera.top=this._center.z+i,this._mainDirLight.shadow.camera.bottom=this._center.z-i,this._mainDirLight.shadow.camera.left=this._center.x-i,this._mainDirLight.shadow.camera.right=this._center.x+i,this._mainDirLight.shadow.camera.updateProjectionMatrix(),this._secondDirLight.shadow.camera.top=this._center.z+i,this._secondDirLight.shadow.camera.bottom=this._center.z-i,this._secondDirLight.shadow.camera.left=this._center.x-i,this._secondDirLight.shadow.camera.right=this._center.x+i,this._secondDirLight.shadow.camera.updateProjectionMatrix()}showGUI(){let e=s();if(this._ambientLight){let t=e.addFolder("Ambient Light");t.add(this._ambientLight,"visible"),t.add(this._ambientLight,"intensity").min(0).max(5).step(.1),t.addColor(this._params.ambientLight,"color").onChange(e=>this._ambientLight.color=new THREE.Color(e))}if(this._mainDirLight){let t=e.addFolder("Main Directional Light");t.add(this._mainDirLight,"visible"),t.add(this._mainDirLight,"intensity").min(0).max(10).step(.1),t.add(this._mainDirLight,"castShadow"),t.addColor(this._params.mainDirLight,"color").onChange(e=>this._mainDirLight.color=new THREE.Color(e)),t.add(this._mainDirLight.position,"x").min(-10).max(10).step(.1).onChange(()=>this._mainDirLight.lookAt(this._center)),t.add(this._mainDirLight.position,"y").min(-10).max(50).step(.1).onChange(()=>this._mainDirLight.lookAt(this._center)),t.add(this._mainDirLight.position,"z").min(-10).max(10).step(.1).onChange(()=>this._mainDirLight.lookAt(this._center))}if(this._secondDirLight){let t=e.addFolder("Second Directional Light");t.add(this._secondDirLight,"visible"),t.add(this._secondDirLight,"intensity").min(0).max(10).step(.1),t.add(this._secondDirLight,"castShadow"),t.addColor(this._params.secondDirLight,"color").onChange(e=>this._secondDirLight.color=new THREE.Color(e)),t.add(this._secondDirLight.position,"x").min(-10).max(10).step(.1).onChange(()=>this._secondDirLight.lookAt(this._center)),t.add(this._secondDirLight.position,"y").min(-10).max(50).step(.1).onChange(()=>this._secondDirLight.lookAt(this._center)),t.add(this._secondDirLight.position,"z").min(-10).max(10).step(.1).onChange(()=>this._secondDirLight.lookAt(this._center))}}}class X{constructor(e){const{planObjectViewModel:t,resetCamera:i}=e;this.planObjectViewModel=t,this.resetCamera=void 0===i||i}}class Y extends r{constructor(e,t,i){super(),this._debug=!1,this._raycastHelper=new I(e,t,i,0),this._raycastHelper.addEventListener(3,()=>{this._plannerSelectionHandler.cancelSelection()},this),this._plannerSelectionHandler.addEventListener(0,({planObjectViewModel:e})=>{this.dispatchEvent(0,new X({planObjectViewModel:e}))},this),this._plannerSelectionHandler.addEventListener(1,({planObjectViewModel:e})=>{this.dispatchEvent(1,new X({planObjectViewModel:e}))},this)}addPlanObjectHandlers(e){this._addPlanObjectHandlers(e,e.getBoundingBox(),{hasListener:!0,priority:1,roomleId:e.getId()})}_addPlanObjectHandlers(e,t,i){t.userData.hasListener||(t.userData=i,t.addEventListener("select",()=>this._clickComponent(e)),t.addEventListener("hover_on",()=>this._hoverOn(e)),t.addEventListener("hover_off",()=>this._hoverOff(e)))}_clickComponent(e){this._debug&&e.getId(),this._plannerSelectionHandler.check(e),this._setCursor()}_hoverOn(e){this._hoveredObject=e,this._setCursor()}_hoverOff(e){this._hoveredObject=null,this._setCursor()}_setCursor(){this._draggedObject?i("grabbing"):this._hoveredObject?i("pointer"):this._draggedObject||this._hoveredObject||i("default")}setCamera(e){this._raycastHelper.setCamera(e)}setScene(e){this._raycastHelper.setScene(e)}getSelectedIds(){return this._plannerSelectionHandler.getSelectedIds()}setSelectionMode(e){this._plannerSelectionHandler.setSelectionMode(e)}setPlanViewModel(e){}}H([T],Y.prototype,"_plannerSelectionHandler",void 0);class J{constructor(e){this._coreReference=e.clone()}clearReference(){this._coreReference.delete(),this._coreReference=null}}class Q extends J{constructor(e){super(e);const t=j(e.getCenter());let i=D(e.size);this._container=new THREE.Object3D,this._container.name=e.getObjectType(),this._container.position.copy(t),this._container.rotateY(e.rotation),this._boundingBox=this._generateBoundingBox(i,e.customColor),h(this._boundingBox),this._container.add(this._boundingBox)}update(){this._container.position.copy(j(this.getPlanObject().getCenter()))}getPosition(){return this._container.position}getRotation(){return this._container.rotation.y}getBounds(){let e=new THREE.Box3;return e.setFromObject(this._container),e}getBoundingBox(){return this._boundingBox}getPlanObject(){return this._coreReference}getObject(){return this._object}getContainer(){return this._container}getId(){return this.getPlanObject().getId()}clear(){o(this._container),this._selectionMesh&&o(this._selectionMesh)}hidePreviewBox(){this._container&&this._boundingBox&&(this._boundingBox.material=l())}_generateBoundingBox(e,t){e.addScalar(.01);let i=new THREE.BoxGeometry(e.x,e.y,e.z),n=new THREE.Color(_);t>0&&(n=c(t));let a=new THREE.MeshStandardMaterial({color:n,opacity:p,transparent:!0}),s=new THREE.Mesh(i,a);return s.name="bounding box",s.position.y=e.y/2,s.castShadow=!1,s.receiveShadow=!1,s}select(){if(!this._selectionMesh){let e=new THREE.MeshStandardMaterial({color:n().PRIMARY,opacity:p,transparent:!0});const t=j(this.getPlanObject().getCenter());let i=D(this.getPlanObject().size);this._selectionMesh=new THREE.Mesh(d(t,i),e)}this._container.add(this._selectionMesh)}deselect(){this._selectionMesh&&this._container.remove(this._selectionMesh)}}class Z extends Q{constructor(e){super(e),this._container.name="Configurable "+this._container.name}addRootComponent(e){this._object=e,this._container.add(this._object)}getConfigurationRuntimeId(){return this.getPlanObject().getConfigurationRuntimeId()}}class $ extends a{constructor(e,t){super(e,t),this._center=new THREE.Vector3(0,0,0),this._params={ambientLight:{color:"#ffffff"},areaLight:{position:{x:-1,y:12,z:-1},intensity:400,width:10,height:10,color:"#ffffff"}},this._ambientLight=new THREE.AmbientLight(new THREE.Color(this._params.ambientLight.color),.8),this._ambientLight.layers.set(1),this._areaLight=new THREE.RectAreaLight(11189230,void 0,.8,.8),this._areaLight=new THREE.RectAreaLight(new THREE.Color(this._params.areaLight.color),void 0,this._params.areaLight.width,this._params.areaLight.height),this._areaLight.castShadow=!0,this._areaLight.matrixAutoUpdate=!0,this._areaLight.intensity=this._params.areaLight.intensity/(this._areaLight.width*this._areaLight.height),this._areaLight.position.set(this._params.areaLight.position.x,this._params.areaLight.position.y,this._params.areaLight.position.z),this._areaLight.lookAt(new THREE.Vector3(0,0,0)),this._areaLight.visible=!0,this._areaLight.layers.set(1),this.addToScene()}updateSunPosition(e,t){}addToScene(){this._scene.add(this._areaLight),this._scene.add(this._ambientLight)}removeFromScene(){this._scene.remove(this._areaLight),this._scene.remove(this._ambientLight)}reload(){this.removeFromScene(),this.addToScene()}setBounds(e){this._center.copy(e.getCenter(new THREE.Vector3)),this._areaLight.position.copy(new THREE.Vector3(this._params.areaLight.position.x,this._params.areaLight.position.y,this._params.areaLight.position.z).add(this._center)),this._areaLight.lookAt(this._center)}showGUI(){let e=s();if(this._areaLight){let t=e.addFolder("Area Light");t.add(this._areaLight,"visible"),t.add(this._params.areaLight,"intensity").min(100).max(2e3).step(1).onChange(e=>this._areaLight.intensity=e/(this._areaLight.width*this._areaLight.height)),t.add(this._params.areaLight,"width").min(1).max(30).step(1).onChange(e=>{this._areaLight.width=e,this._areaLight.intensity=this._areaLight.intensity/(this._areaLight.width*this._areaLight.height)}),t.add(this._params.areaLight,"height").min(1).max(30).step(1).onChange(e=>{this._areaLight.height=e,this._areaLight.intensity=this._areaLight.intensity/(this._areaLight.width*this._areaLight.height)}),t.add(this._areaLight,"castShadow"),t.addColor(this._params.areaLight,"color").onChange(e=>this._areaLight.color=new THREE.Color(e)),t.add(this._areaLight.position,"x").min(-30).max(50).step(.1).onChange(()=>this._areaLight.lookAt(this._center)),t.add(this._areaLight.position,"y").min(-30).max(50).step(.1).onChange(()=>this._areaLight.lookAt(this._center)),t.add(this._areaLight.position,"z").min(-30).max(50).step(.1).onChange(()=>this._areaLight.lookAt(this._center))}if(this._ambientLight){let t=e.addFolder("Ambient Light");t.add(this._ambientLight,"visible"),t.add(this._ambientLight,"intensity").min(0).max(5).step(.1),t.addColor(this._params.ambientLight,"color").onChange(e=>this._ambientLight.color=new THREE.Color(e))}}}const ee="rml_plans";class te extends z{constructor(e,t,i,n){super(e,t,w.HSP,n),this._roomlePlannerCallback=i,this._plannerMeshGenerator.maxAnisotrophy=this._renderer.capabilities.getMaxAnisotropy(),this._wallGroup=new THREE.Group,this._ceilingGroup=new THREE.Group,this._plannerSceneEventHandler=new Y(this._scene,this._cameraControl.getCamera(),this._getInputManager()),this._plannerSceneEventHandler.addEventListener(0,({planObjectViewModel:e})=>{e instanceof Z&&window.__RML__ENV__.initData.enableHSC&&this._switchToHSC(e.getConfigurationRuntimeId()),this._highlight(e)},this),this._plannerSceneEventHandler.addEventListener(1,({planObjectViewModel:e})=>{this._highlight(null)},this),this._plannerSceneEventHandler.addEventListener(4,({planObjectViewModel:e})=>{this._cameraControl.lock(),this._requestRender()},this),this._plannerSceneEventHandler.addEventListener(5,({planObjectViewModel:e})=>{this._cameraControl.unlock(),this._requestRender(!0)},this),this._plannerKernelAccess.addPlannerListener(this),O(),this._plannerMeshGenerator.setMaterialLoadedListener(()=>{this._planViewModel.tryToMergeComponents(),this._requestRender()})}_setupScene(e,t){super._setupScene(e,t),window.__RML__ENV__.initData.enableHSC?this._lightSetting=new W(this._scene):this._lightSetting=new $(this._scene),this._addSky()}zoomToPlanObject(e){if(e instanceof Z)if(this._cameraControl instanceof b){this._cameraControl.saveState(!0);let t=e.getBounds(),i=t.getSize(new THREE.Vector3),n=this._getYRotationOfObject(e.getContainer()),a=new THREE.Euler(0,n,0),s=t.getCenter(new THREE.Vector3);this._cameraControl.zoomTo(i,this._renderer.getSize().width,this._renderer.getSize().height,a.y,E(15),s).then(()=>this._switchToHSC(e.getConfigurationRuntimeId()))}else this._switchToHSC(e.getConfigurationRuntimeId())}onBeforeRender(){this._cameraControl instanceof b&&this._plannerMeshGenerator.wallMeshes.forEach(e=>C(this._cameraControl.getCamera(),e.material))}_getInputManager(){return this._plannerInputManager}createCameraControl(e){this.setMode(e)}resetCamera(){this._cameraControl.hasSavedState()?this.resetCameraToState():this.resetCameraPositionToStart()}resetCameraToState(){this._cameraControl.resetToState()}resetCameraPositionToStart(){this._requestRender()}_getYRotationOfObject(e){let t=e.getWorldDirection(new THREE.Vector3).clone();t.y=0,t.lengthSq()<.01&&((t=new THREE.Vector3(0,1,0)).applyQuaternion(e.quaternion),t.y=0),t.normalize();let i=Math.asin(t.x);return t.z<0&&(i=Math.PI-i),i<0&&(i+=2*Math.PI),i}loadStaticPlanObjects(){let e=new Map;this._planViewModel.getStaticPlanObjectViewModels().forEach(t=>{let i=t.getPlanObject();e.has(i.getCatalogItemId())?e.get(i.getCatalogItemId()).push(t):e.set(i.getCatalogItemId(),[t])}),this._rapiAccess.getItems(Array.from(e.keys())).then(t=>{let i=[];t.forEach(t=>{this._plannerKernelAccess.catalogItemLoaded(t),e.get(t.id).forEach(e=>{i.push(new Promise((i,n)=>{e.setRapiItem(t).then(()=>{this._requestRender(),i()},n)}))})}),Promise.all(i).then(()=>this._staticItemsLoaded())})}_staticItemsLoaded(){this._requestRender(!0),this._roomlePlannerUiCallback.onItemsLoaded()}preload(e){this._planId=e;let t=this._localStorageHelper.getItem(this._planId,ee);t&&this._loadGLTF(t).then(e=>{this._preloadScene=e,this._preloadScene&&this._scene.add(this._preloadScene),this._requestRender()})}planXMLLoaded(e){this._plannerKernelAccess.planModelViewHelper.requestPlanMesh3d(e,!0);let t=e.getBounds();this._bounds=m(t);let{x:i,y:n}=this._domHelper.getClientDimensions();this._cameraControl instanceof b&&this._cameraControl.updateAndReset(this._bounds.getSize(new THREE.Vector3),i,n,this._bounds.getCenter(new THREE.Vector3),-15,70,5,!1),this._cameraControl instanceof q&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),this._bounds.getCenter(new THREE.Vector3)),this._environment&&this._environment.needsBounds()&&this._environment.updateBounds(this._bounds.getSize(new THREE.Vector3)),this.loadStaticPlanObjects()}planCompletelyLoaded(e){if(this._pixotron){const t=m(e.getBounds());this._pixotron.getShadowPass().setShadowRecieverBBox(t)}this._requestRender(),g.end("loadingTime"),this._planId&&this.exportGLB([...this._wallGroup.children,...this._ceilingGroup.children],this._planId),this._roomlePlannerUiCallback.onCompletelyLoaded()}handlerSwitchedPlans(e){this._planViewModel=e,this._planViewModel.setPlannerSceneEventHandler(this._plannerSceneEventHandler),this._planViewModel.setGeometriesMergedListener(()=>{this._requestRender()}),this._plannerSceneEventHandler.setPlanViewModel(this._planViewModel),this.clearScene(),this._addSky(),this.resetCamera(),this._wallGroup=new THREE.Group,this._ceilingGroup=new THREE.Group,this._setCeiling();let t=new THREE.PlaneGeometry(1e3,1e3);t.rotateX(-Math.PI/2);let i=new THREE.MeshPhysicalMaterial({color:"#f0f0f0",roughness:.8,metalness:.1}),n=new THREE.Mesh(t,i);n.name="Ground",n.position.y=-.01,n.receiveShadow=!0,this._scene.add(n)}beginPlanConstruction(e){}addPlanMesh(e,t,i,n,a,s,r){const o=this._plannerMeshGenerator.generateMesh(null,t,i,n,a,s,r);7===r.value?this._ceilingGroup.add(o):this._wallGroup.add(o)}endPlanConstruction(e){this._renderLoopFunction=(()=>{this._scene.add(this._wallGroup),this._scene.add(this._ceilingGroup),this._lightSetting instanceof W&&this._lightSetting.setBounds(this._getConstructionBounds()),this._scene.remove(this._preloadScene)})}addPlanObjectToScene(e){h(e),this._scene.add(e)}planElementChanged(e,t){this._requestRender(!0)}exportGLB(e,t){this._scriptLoader.fetch("static/three/lib/exporters/GLTFExporter.js",{id:"gltf-exporter"}).then(()=>{let i=new THREE.GLTFExporter;e||(e=[],this._scene.children.forEach(t=>{this._isPartOfScene(t)&&e.push(t)})),i.parse(e,e=>{let i=t||"test";this._localStorageHelper.addItem(i,JSON.stringify(e),ee)},{binary:!1,embedImages:!0,forceIndices:!0})})}importGLB(e){this._loadGLB(e).then(e=>this._scene.add(e))}clearScene(){this._plannerMeshGenerator.clear(),super.clearScene()}_addSky(){this._sky=new THREE.Sky,this._sky.name="Sky",this._sky.scale.setScalar(45e4),this._scene.add(this._sky),this._sky.material.uniforms.turbidity.value=10,this._sky.material.uniforms.rayleigh.value=2,this._sky.material.uniforms.luminance.value=1,this._sky.material.uniforms.mieCoefficient.value=.005,this._sky.material.uniforms.mieDirectionalG.value=.8;let e=new THREE.Mesh(new THREE.SphereBufferGeometry(2e4,16,8),new THREE.MeshBasicMaterial({color:16777215}));e.name="Sunsphere",e.position.y=-7e5,e.visible=!1,this._scene.add(e);let t=-.2*Math.PI,i=2*Math.PI*-.25;e.position.x=4e5*Math.cos(i),e.position.y=4e5*Math.sin(i)*Math.sin(t),e.position.z=4e5*Math.sin(i)*Math.cos(t),e.visible=!0,this._sky.material.uniforms.sunPosition.value.copy(e.position),this._lightSetting instanceof W&&this._lightSetting.updateSunPosition(.3,.25)}switchTo2D(){this._cameraControl instanceof q||(this._requestRender(),this._changeCameraControl(new q(this._creator_,this._getInputManager())),this._bounds&&this._cameraControl.updateToBounds(this._bounds.getSize(new THREE.Vector3),this._bounds.getCenter(new THREE.Vector3)),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._setCeiling(),this._roomlePlannerUiCallback.onCameraChanged("2D"))}switchTo3D(){if(this._cameraControl instanceof b)return;this._changeCameraControl(new b(this._creator_,this._getInputManager(),new THREE.Vector3(0,10,0)));let{x:e,y:t}=this._domHelper.getClientDimensions();this._bounds&&this._cameraControl.updateAndReset(this._bounds.getSize(new THREE.Vector3),e,t,this._bounds.getCenter(new THREE.Vector3),-15,70,5,!1),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._setCeiling(),this._roomlePlannerUiCallback.onCameraChanged("3D")}_setCeiling(){this._ceilingGroup||(this._ceilingGroup=new THREE.Group),this._cameraControl instanceof N?this._ceilingGroup.visible=!0:this._ceilingGroup.visible=!1}cameraControlChanged(){super.cameraControlChanged(),this._plannerSceneEventHandler&&this._plannerSceneEventHandler.setCamera(this._cameraControl.getCamera())}sceneChanged(){this._plannerSceneEventHandler&&this._plannerSceneEventHandler.setScene(this._scene)}_switchToHSC(e){this._roomlePlannerCallback.switchToHsc(e)}closeHSC(){this._requestRender(),this._cameraControl instanceof b&&this._cameraControl.resetToState()}switchToFirstPerson(){if(this._cameraControl instanceof N)return;this._plannerMeshGenerator.wallMeshes.forEach(e=>u(e.material,!1,!1)),this._requestRender();let e=new THREE.Vector3(0,0,0);this._wallGroup&&(e=this._getConstructionBounds().getCenter(new THREE.Vector3)),this._cameraControl&&this._cameraControl.cleanUp(),this._changeCameraControl(new N(this._creator_,this._getInputManager(),e)),this._addCameraControlListener(),this._pixotron&&this.enableHD(),this._setCeiling(),this._roomlePlannerUiCallback.onCameraChanged("FP")}_getConstructionBounds(){let e=new THREE.Box3;return e.setFromObject(this._wallGroup),e}_onKeyDown(e){super._onKeyDown(e),e.key&&"1"===e.key&&(this.switchTo2D(),e.preventDefault()),e.key&&"2"===e.key&&(this.switchTo3D(),e.preventDefault()),e.key&&"3"===e.key&&(this.switchToFirstPerson(),e.preventDefault()),!e.key||"Meta"!==e.key&&"Control"!==e.key||(this._plannerSceneEventHandler.setSelectionMode("multiselect"),e.preventDefault())}_onKeyUp(e){super._onKeyDown(e),!e.key||"Meta"!==e.key&&"Control"!==e.key||(this._plannerSceneEventHandler.setSelectionMode("standard"),e.preventDefault())}setMode(e){switch(e){case"2D":this.switchTo2D();break;case"3D":this.switchTo3D();break;case"FP":this.switchToFirstPerson()}}_highlight(e){let t=[];this._outlinePass&&this._outlinePass.selectedObjects.forEach(e=>{e.traverse(e=>{e.visible=!0})}),e&&t.push(...e.getObject().children),this._plannerSceneEventHandler.getSelectedIds().forEach(e=>{const i=this._planViewModel.getPlanObjectForId(e);i&&t.push(...i.getObject().children)}),this._pixotron.getHighLightPass()&&!this._pixotron.getHighLightPass().set&&(this._outlinePass=this._pixotron.getHighLightPass(),this._pixotron.getHighLightPass().visibleEdgeColor=new THREE.Color(n().SELECTION),this._pixotron.getHighLightPass().hiddenEdgeColor=new THREE.Color(n().SELECTION),this._pixotron.getHighLightPass().edgeStrength=3,this._pixotron.getHighLightPass().edgeThickness=1,this._pixotron.getHighLightPass().edgeGlow=0,this._pixotron.getHighLightPass().set=!0),this._pixotron.highlightObjects(t)}destroy(){super.destroy(),this._plannerMeshGenerator.removeMaterialLodedListener(),this._planViewModel.removeGeometriesMergedListener()}getPixotronParams(){return{saoparams:{intensity:.25,occlusionWorldRadius:.4,smoothTransition:!0,samplesPerFrame:4,bias:.016,numSamples:200,accumulative:!0},shadowparams:{shadowMapResolution:1024,shadowRadius:3,shadowQuality:1,smoothTransition:!0,enableAccumulation:!0,shadowBiasMultiplier:.6,nearPlane:.01,farPlane:50,fov:110,side:THREE.FrontSide,numSamples:100},groundShadow:{enable:!1,smoothTransition:!0,numSamples:1e3,numSamplesPerFrame:2,onComplete:this._addGroundShadows.bind(this)}}}}H([T],te.prototype,"_plannerKernelAccess",void 0),H([T],te.prototype,"_rapiAccess",void 0),H([T],te.prototype,"_plannerMeshGenerator",void 0),H([T],te.prototype,"_plannerInputManager",void 0),H([T],te.prototype,"_roomlePlannerUiCallback",void 0),H([T],te.prototype,"_localStorageHelper",void 0);const ie={left:0,top:1,right:1,bottom:0};class ne{constructor(e){this._hscInstance=null,this._glbInstance=null,this._creator_=e,this._kernelCallback.addListener(this),this._backstack.init([w.HSP],this)}init(e,t,i){return g.start("loadingTime"),this._domHelper.setDomElement(e),this._plannerSceneManager?(this._lifeCycleManager.resume(),Promise.resolve()):(this._preloadPlanId=t,this.setOverrides(i),new Promise(this._initPromiseCallback.bind(this)))}loadPlanXml(e,t){return this.setOverrides(t),new Promise(t=>{this._plan=this._planInteractionHandler.loadPlanXML(e),this._plannerSceneManager.planXMLLoaded(this._plan),this._roomlePlannerUiCallback.onTotalFloorAreaChanged(this._planInteractionHandler.getPlan().getTotalFloorArea()),this._backstack.bringIntoForeground(w.HSP),t()})}loadPlan(e,t){return this.setOverrides(t),new Promise((t,i)=>{this._rapiAccess.getPlan(e).then(e=>{this._plan=this._planInteractionHandler.loadPlanXML(e.planObjects),this._plannerSceneManager.planXMLLoaded(this._plan),this._roomlePlannerUiCallback.onTotalFloorAreaChanged(this._planInteractionHandler.getPlan().getTotalFloorArea()),this._backstack.bringIntoForeground(w.HSP),t()},i)})}setOverrides(e){if(!e)return;const t=Object.assign(window.__RML__ENV__.initData,e);window.__RML__ENV__.initData=t,t.overrideTenant&&this._rapiAccess.overrideTenant(t.overrideTenant),t.overrideCountry&&this._rapiAccess.overrideCountry(t.overrideCountry),t.overrideRapi&&this._rapiAccess.overrideRapi(t.overrideRapi),e.alwaysUseCache&&this._dataSyncer.setAlwaysUseCache(e.alwaysUseCache),this._overrides=t}switch2D(){this._plannerSceneManager.switchTo2D()}switch3D(){this._plannerSceneManager.switchTo3D()}switchToFirstPerson(){this._plannerSceneManager.switchToFirstPerson()}exportGLB(){this._plannerSceneManager.exportGLB()}importGLB(e){this._plannerSceneManager.importGLB(e)}_initPromiseCallback(e,t){this._threeLoader.fetch().then(()=>{let t=this._scriptLoader.fetch("static/three/lib/loaders/GLTFLoader.js",{id:"gltf-loader"}),i=this._scriptLoader.fetch("static/three/Tween.js",{id:"tween-js"}),n=this._scriptLoader.fetch("static/three/lib/objects/Sky.js",{id:"sky-js"});Promise.all([t,i,n]).then(()=>{this._kernelReadyCallback=e;const{mode:t}=window.__RML__ENV__.initData;this._plannerSceneManager||(this._plannerSceneManager=new te(this._creator_,ie,this,t));const{stats:i}=window.__RML__ENV__.initData;this._preloadPlanId&&this._plannerSceneManager.preload(this._preloadPlanId),i?this.showStats():this.enableHD(),this._planInteractionHandler&&this._kernelReadyCallback()})})}enableHD(){return new Promise((e,t)=>{const i=()=>{this._plannerSceneManager.enableHD(),e()};Promise.all([this._threeLoader.fetch(),this._scriptLoader.fetch("static/three/lib/shaders/CopyShader.js",{id:"copy-shader-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/EffectComposer.js",{id:"effect-composer-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/RenderPass.js",{id:"render-pass-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/ShaderPass.js",{id:"shader-pass-js"}),this._scriptLoader.fetch("static/three/lib/shaders/LuminosityHighPassShader.js",{id:"luminosity-high-pass-shader-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/UnrealBloomPass.js",{id:"unreal-bloom-pass-js"}),this._scriptLoader.fetch("static/three/lib/postprocessing/OutlinePass.js",{id:"outline-pass-js"})]).then(()=>{this._scriptLoader.fetch("static/three/pixotron.min.js",{id:"pixotron-js"}).then(i,t)},t)})}isReady(){this._planInteractionHandler=this._plannerKernelAccess.planInteractionHandler,this._kernelReadyCallback&&this._kernelReadyCallback()}showBenchmarks(){g.showBenchmarks()}switchToHsc(e){return window.__RML__ENV__.initData.__patch_shadows__=!0,this._singlePromiseFactory.create(3,"startHSC",i=>{if(this._hscInstance)return this._hscInstance.resume(),i();t.import("./configurator.legacy.js").then(({Configurator:t})=>{const n=new t(this._creator_);n.boot({kernelInstance:this._planInteractionHandler.getConfiguratorKernel(),kernelContainer:this._plannerKernelAccess.kernelContainer,planObjectId:e}),n.getApi().setOverrides(this._overrides),n.getApi().init(this._domHelper.element).then(()=>{this._hscInstance=n,i()})})}).then(()=>{this._hscInstance.getApi().syncPlanObjectToView(-1,e),this._backstack.bringIntoForeground(w.HSC),this._roomlePlannerUiCallback.onSwitchToHSCFinished(this._hscInstance)})}switchToGLB(e){return this._singlePromiseFactory.create(4,"startGLB",e=>{if(this._glbInstance)return e();t.import("./glb-viewer.legacy.js").then(t=>{const i=new t.GlbViewer;i.boot(),window.RoomleGLBViewer.init(this._domHelper.element).then(()=>{this._glbInstance=i,e()})})}).then(()=>{this._glbInstance.getApi().loadGLB(e),this._backstack.bringIntoForeground(w.GLB)})}switchToPlanner(e){e&&this.loadPlan(e),this._backstack.bringIntoForeground(w.HSP)}updateSize(){this._plannerSceneManager.updateCamera()}update(){this.updateSize(),this._glbInstance&&this._glbInstance.getApi().updateSize(),this._hscInstance&&this._hscInstance.getApi().updateSize()}get callbacks(){return this._roomlePlannerUiCallback}set callbacks(e){this._roomlePlannerUiCallback=e}showStats(){this._plannerSceneManager.showStats()}onBackStackChanged(e){this._roomlePlannerUiCallback.onBackStackChanged(e)}onCloseHSC(){this._plannerSceneManager.closeHSC(),this._hscInstance&&this._hscInstance.getApi().pauseKernelCallbacks()}back(){this._backstack.back()}backTo(e){this._backstack.backTo(e)}getConfigurator(){return this._hscInstance}getCurrentSkin(){return this._rapiAccess.getCurrentSkin()}getRuntimeComponentIdOfRootComponent(e){return e?this._plannerKernelAccess.planInteractionHandler?this._plannerKernelAccess.planInteractionHandler.getConfiguratorKernel().getRootPlanComponentIdFromObjectId(e):(console.warn("Can not retrieve runtime id without planInteractionHandler"),0):(console.warn("Can not retrieve runtime id without planObjectId"),0)}resumeTest(e){this._domHelper.setDomElement(e),this._lifeCycleManager.resume()}pauseTest(){this._lifeCycleManager.pause()}syncCatalog(e){return this._dataSyncer.syncCatalog(e)}}H([T],ne.prototype,"_domHelper",void 0),H([T],ne.prototype,"_scriptLoader",void 0),H([T],ne.prototype,"_kernelCallback",void 0),H([T],ne.prototype,"_plannerKernelAccess",void 0),H([T],ne.prototype,"_rapiAccess",void 0),H([T],ne.prototype,"_singlePromiseFactory",void 0),H([T],ne.prototype,"_roomlePlannerUiCallback",void 0),H([T],ne.prototype,"_lifeCycleManager",void 0),H([T],ne.prototype,"_backstack",void 0),H([T],ne.prototype,"_threeLoader",void 0),H([T],ne.prototype,"_dataSyncer",void 0);class ae extends J{constructor(e){super(e),this._configurablePlanObjectViewModels=[],this._staticPlanObjectViewModels=[],this._components=new Map,this._componentsToMerge=new Set,this._mergeInProgress=!1,this._mergeThreshold=3,this._plannerKernelAccess.addConfiguratorListener(this),this._componentFactory=O()}clearReference(){super.clearReference(),this._plannerKernelAccess.removeConfiguratorListener(this)}getCorePlan(){return this._coreReference}addPlanObjectViewModel(e){e.getPlanObject().hasConfiguration()?this._configurablePlanObjectViewModels.push(e):(this._staticPlanObjectViewModels.push(e),"door"!==e.getPlanObject().getObjectType()&&"window"!==e.getPlanObject().getObjectType()&&this._plannerSceneEventHandler.addPlanObjectHandlers(e))}_addComponent(e,t){let i=this._components.get(e.parentObjectId);if(this._components.set(e.roomleId,e),t){let t=this._getPlanObjectViewModelForRuntimeId(e.parentObjectId);t&&t instanceof Z&&(t.addRootComponent(e),this._plannerSceneEventHandler.addPlanObjectHandlers(t),t.hidePreviewBox())}i&&i.add(e)}_addMeshToComponentId(e,t){let i=this._components.get(t);i&&i.addMesh(e)}_updateComponentInformation(e){let t=this._components.get(e.id);t&&(t.position.copy(j(e.position)),t.rotation.copy(x(e.rotation)),t.computeBoundingBox(e.boxForMeasurement))}_getPlanObjectViewModelForRuntimeId(e){let t=null;return this._configurablePlanObjectViewModels.forEach(i=>{e===i.getConfigurationRuntimeId()&&(t=i)}),t}getPlanObjectForId(e){let t=null;return this._configurablePlanObjectViewModels.forEach(i=>{e===i.getId()&&(t=i)}),this._staticPlanObjectViewModels.forEach(i=>{e===i.getId()&&(t=i)}),t}Editor3dComponentCreated(e,t,i,n,a){if(this._components.has(e))return;let s=this._componentFactory.create(e,t,i,n);s.layers.set(3),this._addComponent(s,a)}Editor3dAddBakedMesh(e,t,i,n,a,s){this._addMeshToComponent(e,null,t,null,i,n,a,s)}Editor3dAddNamedMesh(e,t,i,n,a,s,r,o){this._addMeshToComponent(e,t,i,n,a,s,r,o)}_addMeshToComponent(e,t,i,n,a,s,r,o){let h=this._plannerMeshGenerator.generateMesh(t,i,a,s,r,o);i&&(h.userData.material=i),n&&(h.userData.transform=V(n),h.applyMatrix(h.userData.transform)),this._addMeshToComponentId(h,e),this._componentsToMerge.add(e)}tryToMergeComponents(){this._mergeInProgress||(this._mergeInProgress=!0,this._componentsToMerge.size,window.requestIdleCallback(this._mergeComponent.bind(this)))}_mergeComponent(){if(this._componentsToMerge.size>0){const e=this._componentsToMerge.values().next().value;this._componentsToMerge.delete(e);const t=this._components.get(e);if(!t||t.meshes.length<=this._mergeThreshold)return void window.requestIdleCallback(this._mergeComponent.bind(this));const i=new Map,n=[],a=[];t.meshes.forEach(e=>{const t=e.userData.material;if(!t)return void console.warn("mesh has no material id set");if(!i.has(t)){const a=new THREE.Mesh(new THREE.Geometry,e.material);a.userData.material=t,a.receiveShadow=!0,a.castShadow=!0,a.layers.set(3),this._plannerMeshGenerator.setMaterial(a,t),n.push(a),i.set(t,a)}const s=i.get(t).geometry;e.userData.transform?s.merge(e.geometry,e.userData.transform):s.merge(e.geometry),a.push(e)}),n.forEach(e=>t.addMesh(e)),a.forEach(e=>t.removeMesh(e)),window.requestIdleCallback(this._mergeComponent.bind(this))}else this._mergeInProgress=!1,this._geometriesMerged&&this._geometriesMerged()}updateComponentMetaInformation(e){this._updateComponentInformation(e)}setPlannerSceneEventHandler(e){this._plannerSceneEventHandler=e}Editor3dComponentDocked(e,t,i,n){let a=this._components.get(t),s=this._components.get(e);s&&(s.roomlePosition=i,s.roomleRotation=n,a.add(s))}Editor3dBeginConstruction(e){let t=this._components.get(e);t&&t.removeAllMeshes()}Editor3dGeometryNotReady(e){this._components.has(e)&&this._components.get(e).loading()}sceneCleared(){this._configurablePlanObjectViewModels.forEach(e=>{e.clear()}),this._staticPlanObjectViewModels.forEach(e=>{e.clear()}),this._components.forEach(function(e){e.removeFromParent(),e.removeAllMeshes()}),this._components.clear()}componentDeleted(e){const t=this._components.get(e);t&&(t.removeFromParent(),t.removeAllMeshes(),this._components.delete(e))}getStaticPlanObjectViewModels(){return this._staticPlanObjectViewModels}getComponent(e){return this._components.get(e)}setGeometriesMergedListener(e){this._geometriesMerged=e}removeGeometriesMergedListener(){this._geometriesMerged=void 0}setMergeThreshold(e){this._mergeThreshold=e}}H([T],ae.prototype,"_plannerKernelAccess",void 0),H([T],ae.prototype,"_plannerMeshGenerator",void 0);const se=new RegExp(/\/3d\/[0-9]+\//);class re extends Q{constructor(e){super(e),this._container.name="Static "+this._container.name}setRapiItem(e){return this._addStaticItem(e)}_addStaticItem(e){let t=this.getPlanObject(),i=e.threeDimensionalAsset||this._getGLBUrl(e.threeDimensionalAssetWeb),n=D(t.size);return t.flipX&&(n.x*=-1),t.flipY&&(n.z*=-1),new Promise(a=>{this._staticItemLoader.loadGLB(i,void 0,void 0,n,t.customColor,e.colorable).then(t=>{this._object=t,this._object.name=e.label,L(t,i),h(t),this._container.add(this._object),this.hidePreviewBox(),a()})})}_getGLBUrl(e){return e.match(se)?e.replace(se,"/3d/glb/").replace(".flash.u3d",".glb"):e}}H([T],re.prototype,"_staticItemLoader",void 0);class oe extends A{constructor(e){super(e,0),this._plannerKernelCallbackListener=new Set,this._configuratorKernelCallbackListener=new Set,g.addMeta("kernel_is_ready",{isWasm:this._useWASM}),this._scriptLoader.fetch(this._kernelPath,{id:"kernel"}).then(this._loadSuccess.bind(this),this._loadError.bind(this))}get kernelContainer(){return this._kernelContainer}_loadSuccess(){window.RoomleCore(this._kernelContainer)}_loadError(){console.error("kernel load error")}_createPlanInteractionHandler(){const e=this._kernelContainer;this._planInteractionHandler=new e.PlanInteractionHandler,this._planInteractionHandler.init(this._planInteractionHandler,1,300,!1,!0,e.DrawingType.CLICK_PER_CLICK),this._roomlePlannerUiCallback.onPlanInteractionHandlerCreated(this._planInteractionHandler)}addPlannerListener(e){this._plannerKernelCallbackListener.add(e)}removePlannerListener(e){this._plannerKernelCallbackListener.delete(e)}addConfiguratorListener(e){this._configuratorKernelCallbackListener.add(e)}removeConfiguratorListener(e){this._configuratorKernelCallbackListener.delete(e)}isReady(){super.isReady(),this.registerCallbacks(),this._roomlePlannerUiCallback.onPlannerKernelIsReady(this._kernelContainer),this._createPlanInteractionHandler();const e=this._planInteractionHandler.getConfiguratorKernel();this._kernelInstance=e,this._roomlePlannerUiCallback.onConfiguratorKernelIsReady(this._kernelContainer,e),G.isProduction||(window.__RML__DEBUG__.ConfiguratorKernel=this._kernelInstance,window.__RML__DEBUG__.PlannerKernelContainer=this._kernelContainer),this._kernelCallback.isReady()}get callbacks(){return this._roomlePlannerUiCallback}get planInteractionHandler(){return this._planInteractionHandler}get planModelViewHelper(){return this._kernelContainer.PlanModelViewHelper}catalogItemLoaded(e){let t=new this._kernelContainer.CatalogItem(e.id);t.size={x:e.width,y:e.depth,z:e.height},t.flipable=e.flipable,t.layer=e.layer,t.orderable=e.orderable,t.scaleable=e.scaleable,t.type=e.type?e.type:"",t.detailType=e.detailType?e.type:"",this._kernelContainer.catalogItemLoaded(t)}onLoadComponentError(e){}configurationLoaded(e,t,i,n,a){}componentDefinitionLoaded(e,t){}componentDefinitionLoadingError(e,t){}configurationLoadingError(){}componentConfigurationUpdated(e){}componentMetaUpdated(e){let t=this._kernelInstance.getComponent(e);this._configuratorKernelCallbackListener.forEach(e=>e.updateComponentMetaInformation(t))}componentParameters(){}componentDeleted(e){this._configuratorKernelCallbackListener.forEach(t=>t.componentDeleted(e))}requestComponentDimensions(){}planObjectCreated(e,t){}planObjectUpdated(e){}planObjectConfigurationUpdated(e,t,i){}planObjectDeleted(){}requestPlanObjectDimensions(){}sceneCleared(){this._configuratorKernelCallbackListener.forEach(e=>e.sceneCleared())}cleanUpCallbacks(){super.cleanUpCallbacks(),this._kernelContainer.unregisterPlannerCallback(this)}registerCallbacks(){super.registerCallbacks(),this._kernelContainer.registerPlannerCallback(this)}requestExternalMesh(e,t){return new Promise((i,n)=>{this._rapiAccess.getMesh(e,B,t).then(a=>{fetch(new Request(this._dataSyncer.requestAsset(a.url,!0))).then(e=>e.arrayBuffer()).then(n=>{try{this._kernelInstance.addMeshCorto(e,t,new Uint8Array(n)),i()}catch(e){console.error(e),i()}}).catch(e=>{console.error(e),n(e)})},e=>{console.error(e),n(e)})})}Editor3dComponentCreated(e,t,i,n){this._configuratorKernelCallbackListener.forEach(a=>a.Editor3dComponentCreated(e,t,i,n,!1))}Editor3dRootComponentCreated(e,t,i,n){this._configuratorKernelCallbackListener.forEach(a=>a.Editor3dComponentCreated(e,t,i,n,!0))}Editor3dBeginConstruction(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dBeginConstruction(e))}Editor3dEndConstruction(e){}Editor3dGeometryReady(e){this._kernelInstance.requestPlanComponentConstruction(e)}Editor3dGeometryNotReady(e){this._configuratorKernelCallbackListener.forEach(t=>t.Editor3dGeometryNotReady(e))}Editor3dPlanObjectConstructionDone(e){}Editor3dBeginGroup(){}Editor3dEndGroup(){}Editor3dSetMaterial(){}Editor3dLoadMaterial(){}Editor3dAddDockPreview(e,t){}Editor3dSetPreviewPointAssociations(e,t){}Editor3dSetPreviewLineAssociations(e,t){}Editor3dPreviewConstructionDone(e,t){}Editor3dTranslateBy(){}Editor3dRotateBy(){}Editor3dRotateAround(){}Editor3dAddCube(){}Editor3dAddCubeUVMod(){}Editor3dAddSphere(){}Editor3dAddSphereUVMod(){}Editor3dAddRectangle(){}Editor3dAddRectangleUVMod(){}Editor3dAddMesh(){}Editor3dAddMeshUVMod(){}Editor3dAddMeshUVCoord(){}Editor3dAddCylinder(){}Editor3dAddCylinderUVMod(){}Editor3dAddPrism(){}Editor3dAddPrismUVMod(){}Editor3dAddFittingPoint(){}Editor3dAddFittingLine(){}Editor3dSelectObject(){}Editor3dCopy(){}Editor3dComponentDocked(e,t,i,n){this._configuratorKernelCallbackListener.forEach(a=>a.Editor3dComponentDocked(e,t,i,n))}Editor3dUpdatePlanObjectPosition(){}Editor3dUpdatePlanObjectRotation(){}Editor3dUpdatePlanObjectTransform(){}Editor3dUpdatePlanComponentPosition(){}Editor3dUpdatePlanComponentRotation(){}Editor3dUpdatePlanComponentTransform(){}Editor3dAddBakedMesh(e,t,i,n,a,s){this._configuratorKernelCallbackListener.forEach(r=>r.Editor3dAddBakedMesh(e,t,i,n,a,s))}Editor3dAddNamedMesh(e,t,i,n,a,s,r,o){this._configuratorKernelCallbackListener.forEach(h=>h.Editor3dAddNamedMesh(e,t,i,n,a,s,r,o))}planElementRemoved(e){this._decoupleReferences(e)}handlerSwitchedPlans(e,t){if(this._decoupleReferences(e),t){let e=new ae(t);this._coupleReferences(e,t),this._plannerKernelCallbackListener.forEach(t=>t.handlerSwitchedPlans(e))}}planBoundsChanged(){}planCleared(){}planCompletelyLoaded(e){this._plannerKernelCallbackListener.forEach(t=>t.planCompletelyLoaded(e))}planElement3dMeshChanged(e,t){}planElementAdded(e,t){if(e&&e.extRef&&t.getType()===this._kernelContainer.PlanElementType.OBJECT){let i,n=t;n.hasConfiguration()?(i=new Z(n),this._coupleReferences(i,n),e.extRef.jsObject.addPlanObjectViewModel(i)):(i=new re(n),this._coupleReferences(i,n),e.extRef.jsObject.addPlanObjectViewModel(i)),this._plannerKernelCallbackListener.forEach(e=>e.addPlanObjectToScene(i.getContainer()))}}planElementChanged(e,t){if(t.extRef){let i=t.extRef.jsObject;i.update(),this._plannerKernelCallbackListener.forEach(t=>t.planElementChanged(e,i))}}planHistoryStateChanged(){}planObjectConfigurationCreated(e,t){}planObjectConfigurationLoaded(e,t,i){if(e&&e.extRef&&t&&t.extRef){let e=t.extRef.jsObject.getPlanObject().getConfigurationRuntimeId();e>0&&this._kernelInstance.requestPlanObjectConstruction(e)}}requestCatalogItem(e){}startedDrawing(){}stoppedDrawing(){}updateMesh2d(){}beginConstruction(){}addMesh(){}endConstruction(){}beginPlanConstruction(e){this._plannerKernelCallbackListener.forEach(t=>t.beginPlanConstruction(e))}addPlanMesh(e,t,i,n,a,s,r){this._plannerKernelCallbackListener.forEach(o=>o.addPlanMesh(e,t,i,n,a,s,r))}endPlanConstruction(e){this._plannerKernelCallbackListener.forEach(t=>t.endPlanConstruction(e))}_coupleReferences(e,t){let i=new this._kernelContainer.EMSReference;i.jsObject=e,t.extRef=i}_decoupleReferences(e){e&&e.extRef&&(e.extRef.jsObject.clearReference(),e.extRef.jsObject=null,e.extRef.delete(),e.extRef=null)}}H([T],oe.prototype,"_kernelCallback",void 0),H([T],oe.prototype,"_roomlePlannerUiCallback",void 0);class he{constructor(e){this._initialStack=[],this._creator_=e,this._lifeCycleManager.addEventListener(this)}_setInitialStack(e){this._initialStack=[...e]}_setCallbacks(e){this._callbacks=e}_resetCanvasStack(){this._canvasStack=[...this._initialStack]}init(e,t){this._setInitialStack(e),this._resetCanvasStack(),this._setCallbacks(t)}bringIntoForeground(e){const t=this._domHelper.element.querySelectorAll("canvas");let i=!1;t.forEach(t=>{if(t.classList.contains(e)){if(!t.classList.contains("foreground")){const t=this.current();t&&e!==t&&(this._canvasStack.push(e),i=!0),t||(i=!0)}t.classList.remove("background"),t.classList.add("foreground")}else t.classList.remove("foreground"),t.classList.add("background")}),i&&this._callbacks.onBackStackChanged(this._canvasStack)}current(){return this._canvasStack[this._canvasStack.length-1]}back(){if(1===this._canvasStack.length)return;let e=this._canvasStack.pop();this.bringIntoForeground(this.current()),e===w.HSC&&this._callbacks.onCloseHSC(),this._callbacks.onBackStackChanged(this._canvasStack)}backTo(e){if(1!==this._canvasStack.length&&this.current()!==e)for(;this._canvasStack.length>0;){let t=this.current();if(t===e){this.bringIntoForeground(t);break}t===w.HSC&&this._callbacks.onCloseHSC(),this._canvasStack.pop(),this._callbacks.onBackStackChanged(this._canvasStack)}}pause(){this._resetCanvasStack()}resume(){}destroy(){}}H([T],he.prototype,"_domHelper",void 0),H([T],he.prototype,"_lifeCycleManager",void 0);class le{constructor(e){const{planObjectViewModel:t}=e;this.planObjectViewModel=t}}const ce=[new y("script-loader",S),new y("dom-helper",k,1),new y("planner-input-manager",class extends M{_canDrag(e){return!0}},1),new y("planner-kernel-access",oe),new y("logger",P),new y("kernel-callback",class{constructor(){this._callbackListener=new Set}addListener(e){this._callbackListener.add(e)}removeListener(e){this._callbackListener.delete(e)}isReady(){this._callbackListener.forEach(e=>e.isReady())}}),new y("planner-mesh-generator",class extends F{constructor(e){super(e),this._wallMeshes=[],this._standardFloorMaterial=new THREE.MeshPhysicalMaterial({color:"#e7d8c5",roughness:.8,metalness:.1}),this._standardWallMaterial=new THREE.MeshPhysicalMaterial({color:"#ffffff",roughness:.8,metalness:.1})}generateGeometry(e=null,t,i,n,a){return this._generateGeometry(e,t,i,n,a)}generateMesh(e=null,t,i,n,a,s,r,o=!1){let h;h=o?this._generateGeometry(e,i,n,a,s).clone():this._generateGeometry(e,i,n,a,s);const l=new THREE.Mesh(h,this._previewMaterial);return l.receiveShadow=!0,l.castShadow=!0,l.layers.set(3),!t&&r&&7!==r.value?(console.warn("material is undefined"),l):(this.setMaterial(l,t,r),this._checkWallMaterial(l,r),l)}setMaterial(e,t,i){i&&7===i.value?this.changeMaterialOfMesh(e,this._standardWallMaterial):t.materialId&&""!==t.materialId?this._assignMaterial(e,t.materialId).then(()=>{this._materialLoaded&&this._materialLoaded()}):t.catalogItemId&&""!==t.catalogItemId?this._assignItem(e,t.catalogItemId):t.rgbValue>0?this._assignRGB(e,t.rgbValue):t.length>0?this._assignMaterial(e,t).then(()=>{this._materialLoaded&&this._materialLoaded()}):t.uvScale?this.changeMaterialOfMesh(e,this._standardFloorMaterial):i&&1===i.value?this.changeMaterialOfMesh(e,this._standardWallMaterial):console.warn("material not supported",t)}_assignRGB(e,t){return new Promise((i,n)=>{let a,s="rbg"+JSON.stringify(t);this._cacheHolder.materialCache.has(s)?a=this._cacheHolder.materialCache.get(s):(a=new THREE.MeshStandardMaterial({color:t}),this._cacheHolder.materialCache.set(s,a)),this.changeMaterialOfMesh(e,a),setTimeout(()=>i(),0)})}_assignItem(e,t){return new Promise((i,n)=>{if(this._cacheHolder.materialCache.has(t))return this.changeMaterialOfMesh(e,this._cacheHolder.materialCache.get(t)),void i();this._rapiAccess.getItem(t).then(a=>{a.topImage?this._textureLoader.load(a.topImage,n=>{n.anisotropy=this._maxAnisotrophy,n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping;let s=new THREE.Vector2(1,1);a.width>0&&(s.x=1/a.width),a.depth>0&&(s.y=1/a.depth),n.repeat.set(s.x,s.y);let r=new THREE.MeshPhysicalMaterial({map:n,roughness:.5,metalness:.1});this._cacheHolder.materialCache.set(t,r),this.changeMaterialOfMesh(e,r),setTimeout(()=>i(),0)}):(console.warn("can not set material, catalog item top image is not set"),n())},n)})}set maxAnisotrophy(e){this._maxAnisotrophy=e}_checkWallMaterial(e,t){t&&1===t.value&&(e.renderOrder=5,this._wallMeshes.push(e))}clear(){super.clear(),this.clearWallMeshes()}clearWallMeshes(){this._wallMeshes.forEach(e=>{f(e)}),this._wallMeshes=[]}get wallMeshes(){return this._wallMeshes}setMaterialLoadedListener(e){this._materialLoaded=e}removeMaterialLodedListener(){this._materialLoaded=void 0}}),new y("rapi-access",K),new y("roomle-planner-ui-callback",class extends U{constructor(){super(...arguments),this.onCompletelyLoaded=(()=>{}),this.onItemsLoaded=(()=>{}),this.onSwitchToHSCFinished=(e=>{}),this.onBackStackChanged=(e=>{}),this.onCameraChanged=(e=>{}),this.onTotalFloorAreaChanged=(e=>{}),this.onPlanInteractionHandlerCreated=(e=>{}),this.onPlannerKernelIsReady=(e=>void 0),this.onConfiguratorKernelIsReady=((e,t)=>void 0)}}),new y("backstack",he),new y("planner-selection-handler",class extends r{constructor(){super(...arguments),this._selectionMode="standard",this._selectedPlanObjectViewModels=new Map}check(e){"standard"===this._selectionMode&&this._checkStandard(e),"multiselect"===this._selectionMode&&this._checkMulti(e)}cancelSelection(){0!==this._selectedPlanObjectViewModels.size&&this._selectedPlanObjectViewModels.forEach((e,t)=>{this._selectedPlanObjectViewModels.delete(t),this.dispatchEvent(1,new le({planObjectViewModel:e}))})}_checkStandard(e){if(this._selectedPlanObjectViewModels.has(e.getId()))return this._selectedPlanObjectViewModels.delete(e.getId()),void this.dispatchEvent(1,new le({planObjectViewModel:e}));this._selectedPlanObjectViewModels.size>0&&this._selectedPlanObjectViewModels.forEach((e,t)=>{this._selectedPlanObjectViewModels.delete(t),this.dispatchEvent(1,new le({planObjectViewModel:e}))}),this._selectedPlanObjectViewModels.set(e.getId(),e),this.dispatchEvent(0,new le({planObjectViewModel:e}))}_checkMulti(e){if(this._selectedPlanObjectViewModels.has(e.getId()))return this._selectedPlanObjectViewModels.delete(e.getId()),void this.dispatchEvent(1,new le({planObjectViewModel:e}));this._selectedPlanObjectViewModels.set(e.getId(),e),this.dispatchEvent(0,new le({planObjectViewModel:e}))}setSelectionMode(e){this._selectionMode=e}getSelectionMode(){return this._selectionMode}hasSelection(){return this._selectedPlanObjectViewModels.size>0}getSelectedIds(){let e=[];return this._selectedPlanObjectViewModels.forEach(t=>e.push(t.getId())),e}isSelected(e){return!!this._selectedPlanObjectViewModels.get(e)}})];e("Planner",class extends v{setupGlobals(){}setupDependencies(){R.setup(ce),this._context=R.getContext("planner"),this.lookup("logger",this._context),this.lookup("planner-kernel-access",this._context)}cleanUpGlobals(){throw new Error("Method not implemented.")}cleanUpDependencies(){throw new Error("Method not implemented.")}bootFinished(){this._planner=new ne(this._context),window.RoomlePlanner||(window.RoomlePlanner=this._planner)}getApi(){return this._planner}})}}});
//# sourceMappingURL=planner.legacy.js.map
