import{d as getColors}from"./chunk-fc1d7396.js";import{s as CameraControl,O as MIN_MOVE_DISTANCE,P as position2VectorsAreEqual,Q as position3VectorsAreEqual,R as rotationQuaternionsAreEqual,S as getDelta,l as CANVAS_ID,i as CameraControl3D,G as dispose,e as getGUI}from"./chunk-221581f9.js";import{a as __decorate,b as inject}from"./chunk-bad5270e.js";const ZOOM_SPEED=2;class CameraControl2D extends CameraControl{constructor(e,t,i){super(e,t,i),this._scale=1,this._state=0,this._lastPosition=new THREE.Vector2,this._zoomSpeed=Math.pow(.95,ZOOM_SPEED),this._cameraZoom=1,this._initCamera(i||new THREE.Vector3(0,10,0))}_getCamera(){return this._camera?this._camera:(this._initCamera(new THREE.Vector3(0,10,0)),this._camera)}_initCamera(e){let{x:t,y:i}=this._domHelper.getClientDimensions(),s=t/i*20;this._camera=new THREE.OrthographicCamera(s/-2,s/2,10,-10,1,1e3),this._camera.position.copy(e),this._cameraPosition=e,this._camera.lookAt(new THREE.Vector3(0,0,0))}updateCamera(){this._camera.updateProjectionMatrix()}_initInputListener(){this._inputListeners.push({key:3,fun:e=>{this._locked||(this._state=1,this._lastPosition.set(e.position.x,e.position.y),this.dispatchEvent(0))}}),this._inputListeners.push({key:6,fun:e=>{1!==this._state||this._locked||(this._move(new THREE.Vector2(e.position.x,e.position.y)),this.dispatchEvent(1))}}),this._inputListeners.push({key:4,fun:e=>{1===this._state&&this.dispatchEvent(2),this._state=0,this._orbitPosition=null}}),this._inputListeners.push({key:7,fun:e=>{this._scale/=this._zoomSpeed,this._update()}}),this._inputListeners.push({key:8,fun:e=>{this._scale*=this._zoomSpeed,this._update()}})}_move(e){let t=new THREE.Vector2;t.subVectors(this._lastPosition,e),t.divideScalar(100),this._cameraPosition.x+=t.x,this._cameraPosition.z+=t.y,this._lastPosition.copy(e)}updateToBounds(e,t){let{x:i,y:s}=this._domHelper.getClientDimensions(),a=i/s,n=Math.max(e.x,e.z),r=n*a;this._camera.left=r/-2,this._camera.right=r/2,this._camera.top=n/2,this._camera.bottom=n/-2,this._camera.zoom=1,this._camera.position.set(t.x,10,t.z),this._cameraPosition.copy(this._camera.position)}_update(e){this._scale=Math.min(this._scale,5),this._scale=Math.max(this._scale,.5),this._cameraZoom=this._scale,this._camera.updateProjectionMatrix()}animateCamera(e){return!(!super.animateCamera(e)&&this._cameraZoom===this._camera.zoom||(this._camera.zoom=this._cameraZoom,0))}}const KEYBOARD_ROTATION_ANGLE=Math.PI/4,KEYBOARD_MOVING_DISTANCE=1,ROTATION_SPEED=1,ROTATION_SPEED_TOUCH=.6,RUN_SPEED=1,CONTROLLER_AXIS_THRESHHOLD=.2;class CameraControlFirstPerson extends CameraControl{constructor(e,t,i){super(e,t,i),this._state=0,this._rotationSpeed=ROTATION_SPEED,this._keyMap=new Map,this._camera=new THREE.PerspectiveCamera,this._camera.fov=50,this._camera.aspect=this._width/this._height,this._camera.near=.1,this._camera.far=100,this._camera.updateProjectionMatrix(),this._camera.layers.set(3),this._camera.layers.enable(1),this._camera.layers.enable(2),this._camera.layers.enable(5),this._camera.layers.enable(4),i?this._camera.position.set(i.x,1.5,i.z):this._camera.position.set(0,1.5,0),this._cameraPosition=new THREE.Vector3,this._cameraPosition.copy(this._camera.position),this._cameraRotation=new THREE.Quaternion,this._pitch=0,this._yaw=0;let s=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX");this._cameraRotation.setFromEuler(s),window.addEventListener("gamepadconnected",this._gamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this._gamepadDisconnected.bind(this))}_gamepadConnected(e){this.startButtonPressListener()}_gamepadDisconnected(e){window.cancelAnimationFrame(this._listenerLoopAnimationFrame)}startButtonPressListener(){this._listenerLoopAnimationFrame=window.requestAnimationFrame(()=>{this.buttonPressListener()})}buttonPressListener(){let e=navigator.getGamepads()[0];this._checkRightStick(e),this._checkLeftStick(e),this._checkButtons(e),this._processKeyMap(this._keyMap,.001),this.startButtonPressListener()}_checkRightStick(e){let t=e.axes[2],i=e.axes[3];Math.abs(t)>CONTROLLER_AXIS_THRESHHOLD&&(this._rotateHorizontal(.01*KEYBOARD_ROTATION_ANGLE*t),this._update(),this.dispatchEvent(1)),Math.abs(i)>CONTROLLER_AXIS_THRESHHOLD&&(this._rotateVertical(.01*KEYBOARD_ROTATION_ANGLE*i),this._update(),this.dispatchEvent(1))}_checkLeftStick(e){let t=e.axes[0],i=e.axes[1];Math.abs(i)>CONTROLLER_AXIS_THRESHHOLD?i<0?this._keyMap.set(87,!0):this._keyMap.set(83,!0):e.buttons&&e.buttons[12]&&e.buttons[12].pressed?this._keyMap.set(87,!0):e.buttons&&e.buttons[13]&&e.buttons[13].pressed?this._keyMap.set(83,!0):(this._keyMap.set(87,!1),this._keyMap.set(83,!1)),Math.abs(t)>CONTROLLER_AXIS_THRESHHOLD?t<0?this._keyMap.set(65,!0):this._keyMap.set(68,!0):(this._keyMap.set(65,!1),this._keyMap.set(68,!1))}_checkButtons(e){e.buttons&&e.buttons[6]&&e.buttons[6].pressed?this._keyMap.set(16,!0):this._keyMap.set(16,!1),e.buttons&&e.buttons[14]&&e.buttons[14].pressed?(this._keyMap.set(37,!0),this.dispatchEvent(1)):this._keyMap.set(37,!1),e.buttons&&e.buttons[15]&&e.buttons[15].pressed?(this._keyMap.set(39,!0),this.dispatchEvent(1)):this._keyMap.set(39,!1)}animateCamera(e){let t=this._cameraPosition,i=this._cameraRotation,s=this.getCamera(),a=position3VectorsAreEqual(t,s.position),n=rotationQuaternionsAreEqual(i,s.quaternion);if(!t||a&&n)return!1;let r=this.getCamera().position.clone(),o=Math.min(10*e,1);r.lerp(t,o),this.getCamera().position.copy(r);let h=this.getCamera().quaternion.clone(),_=Math.min(5*e,1);h.slerp(i,_),this.getCamera().setRotationFromQuaternion(h);let d=!1;return this._keyMap.forEach(e=>{e&&(d=!0)}),d&&this._processKeyMap(this._keyMap,e),!0}_getCamera(){return this._camera}_initInputListener(){window.addEventListener("keyup",this._onKeyChanged.bind(this),!1),window.addEventListener("keydown",this._onKeyChanged.bind(this),!1),this._inputListeners.push({key:3,fun:e=>{this._down(e)}}),this._inputListeners.push({key:6,fun:e=>{this._move(e)}}),this._inputListeners.push({key:4,fun:e=>{this._up(e)}})}_down(e){this._downTime=Date.now(),this._downPosition=e.position,this._position=e.position,this._state=1,2===e.type&&(this._longDownTimer=window.setTimeout(this._onLongDown.bind(this),350)),2===e.type?this._rotationSpeed=ROTATION_SPEED_TOUCH:this._rotationSpeed=ROTATION_SPEED}_move(e){this._position=e.position,1!==this._state||this._locked||this._orbit(new THREE.Vector2(e.position.x,e.position.y)),2!==this._state||this._locked||(this._orbit(new THREE.Vector2(e.position.x,e.position.y)),this._moveForward())}_up(e){1===this._state&&this.dispatchEvent(2),2===this._state&&this._keyMap.set(87,!1),this._state=0,this._orbitPosition=null}_onLongDown(){getDelta(this._downPosition,this._position)<MIN_MOVE_DISTANCE&&1===this._state&&(this._state=2,this._orbit(new THREE.Vector2(this._position.x,this._position.y)),this._moveForward())}_update(e){let t=new THREE.Euler(-this._pitch,this._yaw,0,"ZYX");this._cameraRotation.setFromEuler(t,!0)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();this._camera.aspect=e/t,this._camera.updateProjectionMatrix()}_onKeyChanged(e){this._keyMap.set(e.keyCode,"keydown"===e.type),this.dispatchEvent(6),this._processKeyMap(this._keyMap,.001)&&e.preventDefault()}_processKeyMap(e,t){t=Math.min(t,.1);let i=new THREE.Vector3(0,0,0),s=!1;return this._processUpDown(e,i,t),e.get(65)&&(i.x=-KEYBOARD_MOVING_DISTANCE*RUN_SPEED*t),e.get(68)&&(i.x=KEYBOARD_MOVING_DISTANCE*RUN_SPEED*t),e.get(37)&&(this._rotateHorizontal(-KEYBOARD_ROTATION_ANGLE*this._rotationSpeed*t),s=!0),e.get(39)&&(this._rotateHorizontal(KEYBOARD_ROTATION_ANGLE*this._rotationSpeed*t),s=!0),e.get(16)&&(i.x*=3,i.z*=3),!(0===i.x&&0===i.y&&0===i.z&&!s||(i.applyQuaternion(this.getCamera().quaternion),this._cameraPosition.add(new THREE.Vector3(i.x,0,i.z)),this._update(),0))}_processUpDown(e,t,i){(e.get(87)||e.get(38))&&(t.z=-KEYBOARD_MOVING_DISTANCE*RUN_SPEED*i),(e.get(83)||e.get(40))&&(t.z=KEYBOARD_MOVING_DISTANCE*RUN_SPEED*i)}_orbit(e){this._orbitPosition||(this._orbitPosition=new THREE.Vector2(e.x,e.y),this.dispatchEvent(0));let t=e.clone().sub(this._orbitPosition),i=this._domHelper.element instanceof Document?this._domHelper.element.body:this._domHelper.element;this._rotateHorizontal(2*Math.PI*t.x/i.clientWidth*ROTATION_SPEED),this._rotateVertical(2*Math.PI*t.y/i.clientHeight*ROTATION_SPEED),position2VectorsAreEqual(this._orbitPosition,e)||this.dispatchEvent(1),this._orbitPosition.copy(e),this._update()}_moveForward(){this._keyMap.set(87,!0),this._processKeyMap(this._keyMap,.001)}_rotateVertical(e){let t=this._pitch+e;t>.7||t<-.4||(this._pitch=t,this._pitch<-Math.PI?this._pitch+=2*Math.PI:this._pitch>Math.PI&&(this._pitch-=2*Math.PI),this._saveYawAndPitch())}}const STANDBY_AFTER=3e3;class SceneManager{constructor(e,t,i,s,a){this._clock=new THREE.Clock,this._delta=0,this._devicePixelRatio=1,this._renderListener=null,this._stopRendering=!1,this._forceRender=!1,this._lastChange=Date.now(),this._running=!1,this._onAfterRender=(()=>{}),this._creator_=e,this._canvasID=i,this._devicePixelRatio=window.devicePixelRatio&&window.__RML__ENV__.initData.retina?window.devicePixelRatio:1,this.createCameraControl(s),this._addCameraControlListener(),this._setupScene(t,a),document.addEventListener("visibilitychange",this._tabVisible.bind(this)),this._renderListener=(()=>{this._requestRender(!0)}),this._getInputManager().addEventListener(7,this._renderListener,this),this._getInputManager().addEventListener(8,this._renderListener,this),this._lifeCycleManager.addEventListener(this)}onBeforeRender(){}_changeCameraControl(e){this._cameraControl&&this._cameraControl.cleanUp(),e instanceof CameraControlFirstPerson&&(this._getInputManager().removeEventListener(7,this._renderListener),this._getInputManager().removeEventListener(8,this._renderListener)),this._cameraControl instanceof CameraControlFirstPerson&&(this._getInputManager().addEventListener(7,this._renderListener,this),this._getInputManager().addEventListener(8,this._renderListener,this)),this._cameraControl=e,this.cameraControlChanged()}cameraControlChanged(){}_addCameraControlListener(){this._cameraControl.addEventListener(0,this._requestRender,this),this._cameraControl.addEventListener(1,this._requestRender,this),this._cameraControl.addEventListener(2,this._requestRender,this),this._cameraControl.addEventListener(6,this._requestRender,this)}_requestRender(e){if(!this._renderer)return;this._pixotron&&(this._pixotron.needsUpdate=!0,e&&(this._forceRender=!0));const t=()=>{this._delta=this._clock.getDelta(),this._animateCamera(),this._cameraControl.getCamera().layers.mask=65535,this._renderLoopFunction&&(this._renderLoopFunction(),this._renderLoopFunction=null),this.onBeforeRender(),this._statsHelper&&this._statsHelper.update(this._renderer.info),this._pixotron?(this._forceRender&&(this._pixotron.autoShadowsClear=!0,this._pixotron.autoSAOClear=!0),this._pixotron.render(this._renderer,this._scene,this._cameraControl.getCamera()),this._forceRender=!1):(this._renderer.clear(),this._renderer.render(this._scene,this._cameraControl.getCamera()),this._renderer.clearDepth()),this._onAfterRender(),window.TWEEN&&TWEEN.update(),this._lastChange+STANDBY_AFTER<Date.now()||this._stopRendering?this._running=!1:(this._running=!0,requestAnimationFrame(t))};this._lastChange=Date.now(),this._running||this._stopRendering||(this._running=!0,requestAnimationFrame(t))}_animateCamera(){this._cameraControl&&(this._cameraControl.animateCamera(this._delta)||!this._pixotron||this._forceRender?this._pixotron&&(this._pixotron.needsUpdate=!0):(this._pixotron.autoShadowsClear=!1,this._pixotron.autoSAOClear=!1))}_setupScene(e,t){let i=this._domHelper.getClientDimensions();this._width=i.x,this._height=i.y,this._scene=new THREE.Scene,(t=t||!1)||(this._scene.background=new THREE.Color(getColors().DEFAULT_BACKGROUND)),this._renderer=new THREE.WebGLRenderer({antialias:!0,alpha:t}),this._renderer.setPixelRatio(this._devicePixelRatio),this._renderer.setSize(this._width,this._height),this._renderer.gammaOutput=!0,this._renderer.gammaInput=!0,this._renderer.autoClear=!1,this._renderer.shadowMap.enabled=!0,this._renderer.shadowMap.type=THREE.BasicShadowMap,this._renderer.domElement.classList.add(this._canvasID),this._domHelper.element.appendChild(this._renderer.domElement),this._getInputManager().addEvents(this._renderer.domElement),this._requestRender(),window.addEventListener("resize",this,!1),window.addEventListener("keydown",this,!1),window.addEventListener("keyup",this,!1),this.sceneChanged()}_tabVisible(e){this._requestRender(!0)}setupScene(e,t){this._setupScene(e,t)}updateCamera(){let{x:e,y:t}=this._domHelper.getClientDimensions();if(this._renderer.setSize(e,t),this._pixotron){this._pixotron.autoShadowsClear=!0,this._pixotron.autoSAOClear=!0,this._forceRender=!0;try{this._pixotron.setSize(e,t)}catch(e){console.warn(e)}}this._cameraControl.updateCamera(),this._requestRender(!0)}_onWindowResize(){this.updateCamera(),this._requestRender(!0)}_isPartOfScene(e){return"Object3D"===e.type||"Mesh"===e.type||"GLB"===e.type||"GLTF"===e.type||"Group"===e.type}cleanUp(){this._getInputManager().removeEventListener(7,this._renderListener),this._getInputManager().removeEventListener(8,this._renderListener),this._cameraControl&&this._cameraControl.cleanUp()}clearScene(){let e=[];this._scene.children.forEach(t=>{this._isPartOfScene(t)&&e.push(t)}),e.forEach(e=>{dispose(e),this._scene.remove(e)}),this._renderer.renderLists.dispose()}enableHD(){let e={saoparams:{intensity:.25,occlusionWorldRadius:.4,smoothTransition:!0,samplesPerFrame:4,bias:.016,numSamples:200},shadowparams:{shadowMapResolution:1024,shadowRadius:3,shadowQuality:1,smoothTransition:!0,enableAccumulation:!0,shadowBiasMultiplier:.6,nearPlane:.01,farPlane:50,fov:110,side:THREE.FrontSide,numSamples:100}};this._pixotron=new window.PIXOTRON.Pixotron(e),this._requestRender()}_loadGLTF(e,t,i,s,a){return new Promise((n,r)=>{this._staticItemLoader.loadGLTF(e,t,i,s,a).then(e=>{this._setCamera("GLTF",e),n(e)},r)})}_calculateBoundingBoxOfAllMeshes(e){let t=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY;return e.forEach(e=>{e.geometry.computeBoundingBox();let o=e.geometry.boundingBox.clone();o.translate(e.getWorldPosition(new THREE.Vector3)),t=Math.min(t,o.min.x),i=Math.min(i,o.min.y),s=Math.min(s,o.min.z),a=Math.max(a,o.max.x),n=Math.max(n,o.max.y),r=Math.max(r,o.max.z)}),new THREE.Box3(new THREE.Vector3(t,i,s),new THREE.Vector3(a,n,r))}_loadGLB(e,t,i,s,a){return new Promise((n,r)=>{this._staticItemLoader.loadGLB(e,t,i,s,a).then(e=>{this._setCamera("GLB",e),n(e)},r)})}_setCamera(e,t){if(!t)return void console.warn("could not set camera for gltf",t);const i=new THREE.Box3;if(i.setFromObject(t),"GLB"===e)this._cameraControl instanceof CameraControl3D&&this._cameraControl.updateToBounds(i,window.innerWidth,window.innerHeight,!1);else if("GLTF"===e){if(this._cameraControl instanceof CameraControl3D){let{x:e,y:t}=this._domHelper.getClientDimensions();this._cameraControl.updateAndReset(i.getSize(new THREE.Vector3),e,t,i.getCenter(new THREE.Vector3),-15,70,5,!1)}this._cameraControl instanceof CameraControl2D&&this._cameraControl.updateToBounds(i.getSize(new THREE.Vector3),i.getCenter(new THREE.Vector3))}this.updateCamera()}showGUI(){const e=document.createElement("style");e.innerText=".dg.ac {right:auto!important}",document.head.appendChild(e),this._scriptLoader.fetch("static/three/dat.gui.min.js",{id:"dat-gui-js"}).then(()=>this._guiLoaded(),e=>console.error(e))}_guiLoaded(){this._lightSetting&&this._lightSetting.showGUI();let e=getGUI();if(this._pixotron){let t=e.addFolder("Renderer");t.add(this._pixotron.getSAOPass(),"enabled"),t.add(this._pixotron.getSAOPass(),"smoothTransition"),t.add(this._pixotron.getSAOPass(),"occlusionWorldRadius").min(0).max(2).step(.01),t.add(this._pixotron.getSAOPass(),"intensity").min(.1).max(2).step(.05),t.add(this._pixotron.getSAOPass(),"bias").min(-.1).max(.1).step(.001),t.add(this._pixotron.getSAOPass(),"numSamples").min(10).max(3e3).step(10),t.add(this._pixotron.getShadowPass(),"enabled"),t.add(this._pixotron.getShadowPass(),"smoothTransition"),t.add(this._pixotron.getShadowPass(),"enableAccumulation"),t.add(this._pixotron.getShadowPass(),"shadowRadius").min(0).max(5).step(.1),t.add(this._pixotron.getShadowPass(),"shadowBiasMultiplier").min(0).max(3).step(.1),t.add(this._pixotron.getShadowPass(),"numSamples").min(10).max(3e3).step(10)}this._addGUIListener(e)}_addGUIListener(e){let t=e.__folders;Object.keys(t).forEach((e,i)=>{let s=t[e];s.__folders&&Object.keys(s.__folders).forEach((e,i)=>{let s=t[e];this._addGUIListener(s)}),s.__controllers&&s.__controllers.forEach(e=>{e.onFinishChange(()=>{this._requestRender()})})})}showStats(){import("./stats-helper.js").then(e=>this._statsHelper=new e.default)}_onKeyDown(e){}_onKeyUp(e){}pause(){this._getInputManager().removeEvents(this._renderer.domElement),window.removeEventListener("resize",this,!1),window.removeEventListener("keydown",this,!1),window.removeEventListener("keyup",this,!1)}resume(){this._renderer.domElement.classList.add(this._canvasID),this._domHelper.element.appendChild(this._renderer.domElement),this._getInputManager().addEvents(this._renderer.domElement),window.addEventListener("resize",this,!1),window.addEventListener("keydown",this,!1),window.addEventListener("keyup",this,!1),this._requestRender(!0),this._pixotron&&this._backstack.current()===CANVAS_ID.HSP&&this.enableHD(),this._onAfterRender=(()=>{this.updateCamera(),this._onAfterRender=(()=>{})})}destroy(){this.pause(),this.cleanUp()}handleEvent(e){switch(e.type){case"resize":this._onWindowResize();break;case"keydown":this._onKeyDown(e);break;case"keyup":this._onKeyUp(e)}}}__decorate([inject],SceneManager.prototype,"_domHelper",void 0),__decorate([inject],SceneManager.prototype,"_environmentLoader",void 0),__decorate([inject],SceneManager.prototype,"_scriptLoader",void 0),__decorate([inject],SceneManager.prototype,"_lifeCycleManager",void 0),__decorate([inject],SceneManager.prototype,"_staticItemLoader",void 0),__decorate([inject],SceneManager.prototype,"_backstack",void 0);export{SceneManager as a,CameraControl2D as b,CameraControlFirstPerson as c};
//# sourceMappingURL=chunk-24ed403b.js.map
